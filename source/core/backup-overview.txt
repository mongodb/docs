============
Backup Flows
============


Introduction
------------

|mms| Backup's process for keeping a backup in sync with your
deployment is analogous to the process used by a secondary to replicate
data in a :term:`replica set`. Backup first performs an initial sync to catch up
with your deployment and then tails the oplog to stay caught up. Backup
takes scheduled snapshots to keep a history of the data.

.. include:: /images/v1_6-backup_flow.rst

.. _backup-initial-sync:

Initial Sync
------------

Transfer of Data and Oplog Entries
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When you start a backup, the Backup Agent streams your deployment's
existing data to the |http-service| in batches of documents
totaling roughly 10MB. The batches are called "slices." The service
stores the slices in the Sync Store Database for later processing. The sync
store contains only the data as it existed when you started the backup.

While transferring the data, the Backup Agent also tails the oplog and
also streams the oplog updates to the |http-service|. The service places
the entries in the Oplog Store Database for later processing offline.

By default, both the Sync Store Database and Oplog Store Database reside on
the backing MongoDB replica set that hosts the Backup Blockstore Database.

Building the Backup
~~~~~~~~~~~~~~~~~~~

When the |http-service| has received all of the slices, a Backup
Daemon creates a local database on its server and inserts the documents
that were captured as slices during the initial sync. The daemon then
applies the oplog entries from the oplog store.

The Backup Daemon then validates the data. If there are missing documents,
|mms| queries the deployment for the documents and the Backup Daemon
inserts them. A missing document could occur because of an update that
caused a document to move during the initial sync.

Once the Backup Daemon validates the accuracy of the data directory, it
removes the data slices from the sync store. At this point, Backup has
completed the initial sync process and proceeds to routine operation.

Routine Operation
-----------------

The Backup Agent tails the deployment's oplog and routinely batches and
transfers new oplog entries to the |http-service|, which stores them
in the oplog store. The Backup Daemon applies all newly received oplog
entries in batches to its local replica of the backed-up deployment.

Snapshots
---------

During a preset interval, the Backup Daemon takes a snapshot of the data
directory for the backed-up deployment, breaks it into blocks, and transfers
the blocks to the Backup Blockstore Database. For a sharded cluster, the
daemon takes a snapshot of each shard and of the config servers. The
daemon can also use :ref:`checkpoints <checkpoint>` to synchronize the shards and
config servers for custom snapshots. You must first :ref:`enable checkpoints
<enable-cluster-checkpoints>`.

When a user requests a snapshot, a Backup Daemon retrieves the data from
the Backup Blockstore Database and delivers it to the requested destination.
For an overview of the restore process, see :doc:`/core/restore-overview`.

Grooms
------

Groom jobs perform periodic "garbage collection" on the Backup Blockstore
Database to remove unused blocks and reclaim space. Unused blocks are
those that are no longer referenced by a live snapshot. A scheduling
process determines when grooms are necessary.
