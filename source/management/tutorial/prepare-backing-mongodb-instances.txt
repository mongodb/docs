===================================
Preparing Backing MongoDB Instances
===================================

.. default-domain:: mms

Overview
--------

Backing MongoDB databases store the |mms| application data needed for operations. All
backing MongoDB databases must be running MongoDB 2.4.9 or later.

MMS Application Database
~~~~~~~~~~~~~~~~~~~~~~~~

To install and run MMS Monitoring we recommend a single three-node MongoDB replica set
(2 data nodes and one arbiter) in which to store:

- Monitoring data collected from monitoring agents.

- Meta data for MMS users, groups, hosts, monitoring data, and backup state.

For up to 400 monitored hosts, the MMS Application Database requires 200 GB of storage space.
For up to 2000 monitored hosts, the MMS Application Database requires 500 GB of storage space.
If you have more than 2000 monitored hosts, please contact your MongoDB Account Manager.

This database is referenced in the ``<install_dir>/conf/conf-mms.properties`` file as follows:

.. code-block:: ini

   mongo.mongoUri=mongodb://host1:40000,host2:40000,host3:40000/?maxPoolSize=100
   mongo.replicaSet=mmsreplset

See :manual:`Connection String URI Format
</reference/connection-string/>` for more information.

You may run the MMS Application Server on the same physical server as
one node of the MMS Application Database replica set.

For reference: an AWS EC2 Standard Extra Large (i.e. m1.xlarge) with a
provisioned 500 IOP/s EBS volume may support the 400-host configuration
above. An AWS EC2 High I/O Quadruple Extra Large (hi1.4xlarge)
may support the 2000 host configuration above.

For the best results use SSD-backed storage. A MongoDB standalone may also be used in
please of a replica set, but this is not recommended for production deployments.

Optional: MMS Backup Blockstore Database
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To install and run MMS Backup you will additionally need a second MongoDB replica set
in which to store the backup snapshot data.

Prior to installing MMS Backup we strongly recommend that you contact your MongoDB
Account Manager to arrange a sizing consultation for the MMS Backup database.

The amount of storage needed for the MMS Backup database is calculated by looking at the file size
of all data being backed up, gigabytes of oplog per hour generated by the backed-up replica set,
compression ratio of the data, and the configured snapshot retention schedule.

To calculate the amount of storage needed to store a replica set backup in the
Blockstore database, look at the file size of the replica set to back up,
gigabytes of oplog per hour generated by the replica set, compression ratio of
the data, and the configured snapshot retention schedule.

Using the four shard, 200GB per shard cluster example from above, also
add 2GB/day of oplogs generated per shard or 8GB/day total across the
cluster.

If the longest stored snapshot has a one year retention
period, the approximate amount of data in the blockstore will be
800GB + (8GB * 365 days) or 3720GB. If the data gets a 4:1 compression
ratio, which is an average seen in the hosted MMS, the blockstore
space required will actually be 930GB.

930GB is a conservative estimate because it assumes 8GB of
oplog in one day changes 8GB of data on disk. The other extreme is
that 8GB of oplog could all be ``$inc`` operations on the same
document. In that case, 8GB of oplog could only change 4 bytes on
disk.

In practice the number will be somewhere in between depending on
the replica sets insert/update/delete patterns.

Based on looking at the MMS hosted service, a good rule of thumb is a replica
set will take up 2x - 3x its size in the Blockstore.

Medium grade HDDs will have enough I/O throughput to handle the load
of the Blockstore. Each replica set member should have 4 x 2ghz+ CPU
cores. We recommend 8GB of RAM for every 1TB disk of Blockstore to
provide good snapshot and restore speed.

This database is referenced in the ``<install_dir>/conf/conf-mms.properties`` file as follows:

.. code-block:: ini

   mongo.backupdb.mongoUri==mongodb://host1:50000,host2:50000,host3:50000/?maxPoolSize=100
   mongo.backupdb.replicaSet==mmsbackupreplset

See :manual:`Connection String URI Format
</reference/connection-string/>` for more information.

A MongoDB standalone may also be used in  place of a replica set, but this is not
recommended for production deployments.

Prerequisites
-------------

Read the :manual:`MongoDB Production Notes
</administration/production-notes>` before installing
MongoDB and other software on your servers. If you are deploying MMS
on Amazon AWS, please see ::doc:`/management/tutorial/configure-aws-hosts`.

Setup and Install Replica Sets
------------------------------

To create replica sets, start the :program:`mongod` instances for each
member of a new replica set, configure the replica set, then add the
:program:`mongod` instances to the replica set.

The :manual:`Deploy a Replica Set </tutorial/deploy-replica-set>` guide
has step by step details how to setup and deploy replica sets for use as
backing MongoDBs for MMS.

We recommend that both MMS Application Database and the MMS Backup Database
be configured as 3-node replica sets: two data nodes, and one arbiter.
