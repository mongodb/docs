.. _arch-center-network-security:

================
Network Security 
================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: onecol

{+service+} provides secure defaults for your database deployments
such as:

- Mandatory |tls-ssl| connection encryption
- {+vpc+}\s for all projects with one-or-more {+Dedicated-clusters+}
- Access-list-based authentication which only accepts connections from
  sources you explicitly declare

You can further configure these protections to meet your unique
security needs and preferences.

Use the basic guidance on this page to plan the network security
configuration for your {+clusters+}.

{+service+} Features for Network Security
-----------------------------------------

{+service+} enforces |tls-ssl| encryption for all connections to your
databases.

All {+service+} projects with one or more M10+ dedicated {+clusters+}
receive their own dedicated |vpc| on {+aws+} or {+gcp+} (or {+vnet+} if you use
|azure|). {+service+} deploys all dedicated clusters inside this |vpc|
or {+vnet+}.

By default, this |vpc| or {+vnet+} allows no inbound access to
{+service+}. You must explicitly enable access by one of the
following methods:

- Add public IP addresses to your {+ip-access-list+}
- Use |vpc| / {+vnet+} peering to add private IP addresses
- Add private endpoints

|tls|
~~~~~~~~~

{+service+} enforces mandatory |tls| encryption of connections to your
databases. |tls| 1.2 is the default protocol; you can select |tls| 1.1
or |tls| 1.0 if necessary. For more information, see the
:guilabel:`Set Minimum TLS Protocol Version` section of
:ref:`Configure Additional Setting
<create-cluster-additional-settings>`.

{+ip-access-list+}s
~~~~~~~~~~~~~~~~~~~~

As a |service| administrator, you can:

You can configure {+ip-access-list+}s to limit which IP addresses can
attempt authentication to your database. Your {+service+} {+clusters+} 

Your {+service+} {+clusters+} allow access only from the IP addresses
and |cidr| block IP ranges that you add to your
{+ip-access-list+}. Application servers and other clients cannot
access your {+service+} {+clusters+} if their IP addresses aren't
included in your {+ip-access-list+}.

You can configure :atlas:`temporary access list entries
</security/ip-access-list/#add-ip-access-list-entries>`
that expire automatically after a user-defined period.

You can create one access list per project.

We recommend the following as best practices:

- Use temporary access list entries in situations where team members
  require access to your environment from temporary work locations.
- Define {+ip-access-list+} entries covering the smallest network segments
  possible. To do this, favor individual IP addresses where possible,
  and avoid large |cidr| blocks.

Firewall Configuration
~~~~~~~~~~~~~~~~~~~~~~

If you use a firewall that blocks outbound network connections, you
must also configure your firewall to allow your applications to make
outbound connections to TCP traffic on {+service+} hosts. This grants
your applications access to your {+clusters+}.

{+service+} {+cluster+} public IPs remain the same in the majority of
cases of {+cluster+} changes such as :ref:`vertical scaling
<sizing-auto-scaling>`,
:atlas:`topology </reference/glossary/#std-term-topology>` changes, or
:ref:`maintenance events <configure-maintenance-window>`. However,
certain topology changes – such as a :ref:`conversion from replica set
to sharded cluster <scale-cluster-sharding>`, the
:ref:`addition of shards <scale-cluster-shardNum>`, or a :ref:`region
change <scale-cluster-region>` – require that you use new IP
addresses.

VPC/{+vnet+} Peering
~~~~~~~~~~~~~~~~~~~~~~~~~~

Network peering allows you to connect your own |vpc|\s with an Atlas
|vpc| to route traffic privately and isolate your data flow from the
public Internet.

Most operations performed over a |vpc| connection originate from your
application environment, minimizing the need for {+service+} to make
outbound access requests to peer |vpc|\s. However, if you have
configured a peer |vpc| to use |ldap| authentication, you must enbale
{+service+} to connect to the authentication endpoint of your peer
|vpc| over the |ldap| protocol.

You can choose your {+service+} |cidr| block with the |vpc| peering wizard
before you deploy your first {+cluster+}. The {+service+} |vpc| |cidr|
block must not overlap with the |cidr| block of any |vpc| you intend to
peer to. {+service+} limits the number of MongoDB instances per |vpc|
based on the |cidr| block; for example, a project with a |cidr| block of
``/24`` is limited to the equivalent of 273-node replica sets.

We recommend the following as best practices:

- To maintain tight network trust boundaries, configure mitigations
  such as security groups and :aws:`network ACLs
  <vpc/latest/userguide/vpc-network-acls.html>` to prevent inbound
  access to systems inside your application |vpc|\s from the {+service+}-side
  |vpc|.
  
- Create new |vpc|\s to act as intermediaries between sensitive
  application infrastructure and your {+service+} |vpc|\s. |vpc|\s are
  intransitive, allowing you to only expose those components of your
  application that need access to {+service+}.

Private Endpoints
~~~~~~~~~~~~~~~~~~~~~

A private endpoint facilitates a one-way connection from your own |vpc|
to your {+service+} |vpc|, without permitting {+service+} to initiate a
reciprocal connection. This allows you to make use of secure
connections to {+service+} without extending your network trust
boundary. The following private endpoints are available:

- {+aws+} :aws:`PrivateLink <vpc/latest/userguide/endpoint-services-overview.html>`,
  for connections from {+aws+} VPCs
- {+azure+} :azure:`Private Link <private-link/private-link/overview>`,
  for connections from {+azure+} {+vnet+}s
- :gcp:`Private Service Connect <vpc/docs/private-service-connect>`, for
  connections from Google Cloud

Examples
--------

The following examples configure connections between your application
environment and your {+service+} {+clusters+} using {+ip-access-list+}s,
|vpc| Peering, and Private Endpoints.

These examples also apply other recommended configurations, including:

.. tabs::

   .. tab:: Dev and Test Environments
      :tabid: devtest

      .. include:: /includes/shared-settings-clusters-devtest.rst

   .. tab:: Staging and Prod Environments
      :tabid: stagingprod

      .. include:: /includes/shared-settings-clusters-stagingprod.rst

.. tabs::

   .. tab:: CLI
      :tabid: cli

      .. note::

	 Before you can configure connections with the {+atlas-cli+},
	 you must:

	 - :atlas:`Create your paying organization 
	   </billing/#configure-a-paying-organization>` and :atlas:`create an API key </configure-api-access/>` for the
	   paying organization.
	 - :atlascli:`Install the {+atlas-cli+} </install-atlas-cli/>` 
	 - :atlascli:`Connect from the {+atlas-cli+} 
	   </connect-atlas-cli/>` using the steps for :guilabel:`Programmatic Use`.

      Create an {+ip-access-list+} Entry
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      Run the following command for each connection you want to
      allow. Change the entries to use the appropriate options and
      your actual values:

      .. code-block::
         :copyable: true

         atlas accessList create 192.0.2.15 --type ipAddress --projectId 5e2211c17a3e5a48f5497de3 --comment "IP address for app server 2" --output json

      For more configuration options and information about this
      example, see :ref:`atlas-accessLists-create`.

      Create a VPC Peering Connection
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      Run the following command for each |vpc| you want to peer to your
      {+service+} |vpc|. Replace ``aws`` with ``azure`` or ``gcp`` as
      appropriate, and change the options and values to the
      appropriate ones for your |vpc| or {+vnet+}:

      .. code-block::
         :copyable: true

	 atlas networking peering create aws --accountId 854333054055 --atlasCidrBlock 192.168.0.0/24 --region us-east-1 --routeTableCidrBlock 10.0.0.0/24 --vpcId vpc-078ac381aa90e1e63

      For more configuration options and information about this example, see:

      - :ref:`atlas-networking-peering-create-aws`, for {+aws+} |vpc|\s
      - :ref:`atlas-networking-peering-create-azure`, for {+azure+} {+vnet+}s
      - :ref:`atlas-networking-peering-create-gcp`, for {+gcp+} |vpc|\s

      Create a Private Endpoint
      ~~~~~~~~~~~~~~~~~~~~~~~~~

      Run the following command for each private endpoint you want to
      create. Replace ``aws`` with ``azure`` or ``gcp`` as
      appropriate, and change the options and values to the
      appropriate ones for your |vpc| or {+vnet+}:

      .. code-block::
         :copyable: true

         atlas privateEndpoints aws create --region us-east-1 --projectId 5e2211c17a3e5a48f5497de3 --output json

      For more configuration options and information about this example, see:

      - :ref:`atlas-privateEndpoints-aws-create`, for connections from {+aws+} |vpc|\s
      - :ref:`atlas-privateEndpoints-azure-create`, for connections from {+azure+} {+vnet+}s
      - :ref:`atlas-privateEndpoints-gcp-create`, for connections from {+gcp-psc+}


   .. tab:: Terraform
      :tabid: Terraform

      .. note::

         Before you
         can create resources with Terraform, you must:

         - :atlas:`Create your paying organization 
           </billing/#configure-a-paying-organization>` and :atlas:`create an API key </configure-api-access/>` for the
           paying organization. Store your API key as environment
           variables by running the following command in the terminal:

           .. code-block::

              export MONGODB_ATLAS_PUBLIC_KEY="<insert your public key here>"
              export MONGODB_ATLAS_PRIVATE_KEY="<insert your private key here>"

         - `Install Terraform 
           <https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli>`__

      Create an {+ip-access-list+} Entry
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      To add an entry to your {+ip-access-list+}, create the following
      file and place it in the directory of the project you want to
      grant access to. Change the IDs and names to use your values:

      accessEntryForAddress1.tf
      `````````````````````````

      .. include:: /includes/examples/tf-example-access-entry-for-add-1.rst

      After you create the files, navigate to your project directory
      and run the following command to initialize Terraform:

      .. code-block::

	 terraform init

      Run the following command to view the Terraform plan:

      .. code-block::

	 terraform plan

      Run the following command to add one entry to the {+ip-access-list+}
      for your project. The command uses the file and the
      |service-terraform| to add the entry.

      .. code-block::

	 terraform apply

      When prompted, type ``yes`` and press :kbd:`Enter` to apply
      the configuration.

      Create a VPC Peering Connection
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      To create a peering connection between your application |vpc| and
      your {+service+} |vpc|, create the following file and place it in
      the directory of the project you want to grant access to. Change
      the IDs and names to use your values:

      vpcConnection.tf
      ````````````````

      .. include:: /includes/examples/tf-example-vpc-connection.rst

      After you create the files, navigate to your project directory
      and run the following command to initialize Terraform:

      .. code-block::

	 terraform init

      Run the following command to view the Terraform plan:

      .. code-block::

	 terraform plan

      Run the following command to add a |vpc| peering connection from
      your application to your project. The command uses the file and
      the |service-terraform| to add the entry.

      .. code-block::

	 terraform apply

      When prompted, type ``yes`` and press :kbd:`Enter` to apply
      the configuration.

      Create a Private Link
      ~~~~~~~~~~~~~~~~~~~~~

      To create a private link from your application |vpc| to
      your {+service+} |vpc|, create the following file and place it in
      the directory of the project you want to connect to. Change
      the IDs and names to use your values:

      privateLink.tf
      ``````````````

      .. include:: /includes/examples/tf-example-private-link.rst

      After you create the files, navigate to your project directory
      and run the following command to initialize Terraform:

      .. code-block::

	 terraform init

      Run the following command to view the Terraform plan:

      .. code-block::

	 terraform plan

      Run the following command to add a privatelink endpoint from
      your application to your project. The command uses the file and
      the |service-terraform| to add the entry.

      .. code-block::

	 terraform apply

      When prompted, type ``yes`` and press :kbd:`Enter` to apply
      the configuration.

