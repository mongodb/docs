.. _backup-cloud-provider:

========================
Cloud Provider Snapshots
========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

|service| Cloud Provider Snapshots provide 
localized backup storage using the native snapshot functionality of the 
cluster's cloud service provider.

|service| only supports cloud provider snapshots for 
:ref:`Microsoft Azure <microsoft-azure>` or 
:ref:`Amazon Web Services (AWS) <amazon-aws>` backed replica sets. 

A project using the |service| Cloud Provider Snapshots
*cannot* create backups of sharded clusters *or* any cluster hosted
on :ref:`Google Cloud Provider (GCP) <google-gcp>`.

You can enable cloud provider snapshots during the 
:doc:`cluster creation </create-new-cluster>` or during the 
:doc:`modification of an existing cluster </scale-cluster>`. 
From the cluster configuration modal, toggle 
``Do you want to enable backup?`` to ``Yes`` and select the
:guilabel:`Cloud Provider Snapshots` card.

.. include:: /includes/extracts/backup-selection-cloud-provider.rst

.. _encrypted-cloud-provider-snapshot:

Cloud Provider Snapshots with Encryption at Rest
------------------------------------------------

For clusters using :doc:`Encryption at Rest </security-aws-kms>`, 
|service| uses the project's customer master key (CMK) and 
AWS Identity and Access Management (IAM) user credentials at the time of 
the snapshot to automatically encrypt the snapshot data files.
This is an additional layer of encryption on the existing
encryption applied to all |service| storage and snapshot volumes.

|service| stores the unique ID of the :abbr:`CMK (customer master key)` 
and the AWS :abbr:`IAM (Identity and Access Management)` user 
credentials used to access the :abbr:`CMK (customer master key)`. 
|service| uses this information when restoring the snapshot. For 
complete documentation on restoring an encrypted snapshot, see 
:ref:`restore-encrypted-snapshot`.

To view the ID of the :abbr:`CMK (Cluster Master Key)` used to encrypt 
a snapshot:

#. From the :guilabel:`Clusters` view of the |service| UI, click on the
   cluster name.

#. Click the :guilabel:`Backup` tab, then click :guilabel:`Snapshots`.

#. Note the :guilabel:`CMK ID` for each snapshot in the cluster. 
   Snapshots without Encryption at Rest enabled display 
   :guilabel:`Not enabled`.

.. important::

   |service| requires access to the enabled 
   :abbr:`CMK (customer master key)` used to encrypt a snapshot to 
   successfully 
   :ref:`restore that snapshot <restore-encrypted-snapshot>`.

   Before deleting a :abbr:`CMK (customer master key)` 
   used with |service| Encryption at Rest, check **every** 
   backup-enabled cluster in the project for any snapshots still
   using that :abbr:`CMK (customer master key)`. |service|
   automatically deletes backups in accordance to the 
   :ref:`cloud-provider-retention-policy`. Once |service| deletes
   all snapshots depending on a given :abbr:`CMK (customer master key)`,
   you can delete it safely.

   If disabling a :abbr:`CMK (customer master key)`, you must
   re-enable the key before restoring a snapshot encrypted with
   that key.

For complete documentation on configuring Encryption at Rest,
see :doc:`/security-aws-kms`. You can either
:ref:`deploy <create-cluster-enable-encryption>` a cluster with
Encryption at Rest, or 
:ref:`enable Encryption at Rest <scale-cluster-enable-encryption>`
in an existing cluster.

Single Region Cluster Backups
-----------------------------

.. tabs::

     tabs:
  
     - id: azure
       name: Azure
       content: |
  
         |service| always selects the :term:`primary` member of the
         replica set for backup snapshots. |service| stores the 
         snapshots in the same cloud region as the cluster. |service| 
         retains snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-single-region-primary.rst

         If that member steps down
         to a :term:`secondary`, |service| changes the snapshot
         target to the current :term:`primary`.

         .. include:: /images/cloud-provider-snapshot-single-region-moved-primary.rst
  
     - id: aws
       name: AWS
       content: |
  
         |service| selects the :term:`primary` member of the replica 
         set *at the time you enable backups for the cluster* for backup 
         snapshots. |service| stores the snapshots in the same
         cloud region as the cluster. |service| retains snapshots based 
         on the :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-single-region-primary.rst

         |service| continues to use that member and its 
         corresponding region for snapshots and snapshot storage, even 
         if that member is no longer the primary.

         .. include:: /images/cloud-provider-snapshot-single-region-secondary.rst

         |service| automatically creates a new snapshot storage volume 
         if the existing snapshot storage volume becomes invalid. 
         |service| creates the new volume in the same region as the 
         cluster's current primary. |service| then takes a full-copy 
         snapshot to maintain backup availability and continues using 
         that member and its corresponding region for further 
         incremental snapshots.

         Events that can trigger storage invalidation include:

         - Changing the |service| cluster instance size,
         - Modifying the |service| cluster's storage volume or speed,
         - Changing the |service| cluster's :abbr:`AWS (Amazon Web Services)` region, and
         - Maintenance performed by |service| or :abbr:`AWS (Amazon Web Services)`.
  
         To manually reset the snapshot target and storage, disable and 
         re-enable backups for the cluster. Disabling |service| backups 
         removes all snapshots for the cluster. 
         For more information on snapshot retention, see
         :ref:`cloud-provider-retention-policy`.

Multi-Region Cluster Backups
----------------------------

.. tabs::

     tabs:
  
     - id: azure
       name: Azure
       content: |
  
         |service| always selects the :term:`primary` member of the
         replica set for backup snapshots. |service| stores snapshots
         in the same region as the primary member. |service| retains 
         snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-multi-region-primary.rst

         If that member steps down
         to a :term:`secondary`, |service| changes the snapshot
         target to the current :term:`primary`.

         .. include:: /images/cloud-provider-snapshot-multi-region-moved-primary.rst

         |service| stores subsequent snapshots in the region of the
         new primary member.
  
     - id: aws
       name: AWS
       content: |
  
         |service| selects the :term:`primary` member of the replica 
         set *at the time you enable backups for the cluster* for backup 
         snapshots. |service| stores snapshots in the same region as
         the primary member. |service| retains snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-multi-region-primary.rst

         If the member steps down to a :term:`secondary`, |service|
         continues to use that member for snapshots. |service|
         continues storing snapshots in the same region as that member,
         even if the primary is in a different region.

         .. include:: /images/cloud-provider-snapshot-multi-region-secondary.rst

         |service| automatically creates a new snapshot storage volume 
         if the existing snapshot storage volume becomes invalid. 
         |service| creates the new volume in the same region as the 
         cluster's current primary. |service| then takes a full-copy 
         snapshot to maintain backup availability and continues using 
         that member and its corresponding region for further 
         incremental snapshots.

         Events that can trigger storage invalidation include:

         - Changing the |service| cluster instance size,
         - Modifying the |service| cluster's storage volume or speed,
         - Changing the |service| cluster's :abbr:`AWS (Amazon Web Services)` region, and
         - Maintenance performed by |service| or :abbr:`AWS (Amazon Web Services)`.
  
         To manually reset the snapshot target and storage, disable and 
         re-enable backups for the cluster. Disabling |service| backups 
         removes all snapshots for the cluster. 
         For more information on snapshot retention, see
         :ref:`cloud-provider-retention-policy`.

.. _cloud-provider-backup-schedule:
.. _cloud-provider-retention-policy:

Snapshot Scheduling and Retention Policy
----------------------------------------

|service| takes the first snapshot when you enable cloud provider
snapshots for a cluster and takes subsequent snapshots of the cluster 
every 24 hours from that point in time. By default, |service| retains
the last 3 snapshots for each cluster.

You can view and customize the snapshot schedule and retention settings:

#. From the :guilabel:`Clusters` view, click on the cluster name.
#. Click on the :guilabel:`Backup` tab.
#. Click :guilabel:`Backup Policy`.

|service| displays the UTC snapshot time using the 24-hour clock format.
To modify the snapshot time, click the dropdown for the :guilabel:`hr` 
or :guilabel:`min` and select your preferred hour or minute for
|service| to take snapshots. The first snapshot taken after updating
the snapshot schedule occurs within 24 hours, breaking the default
behavior of one snapshot every 24 hours. All subsequent 
snapshots occur once every 24 hours at the configured point in time.

|service| displays the number of snapshots to retain in a text
input field. Type in your preferred number of snapshots for retention.
Changing the number of retained snapshots effects the total cost
of backups for the cluster. For complete documentation on cloud provider
snapshot billing, see :ref:`billing-backup-cloud-provider-snapshots`.
If you decrease the number of retained snapshots, |service| 
immediately deletes the extra snapshots. 

Click :guilabel:`Save Changes` to save any changes you've made to either
the snapshot schedule or retention settings.

.. important::

   If you disable cloud provider snapshots for a cluster or terminate a 
   cluster that had snapshots enabled, |service| immediately 
   deletes the backup snapshots for that cluster. For clusters not
   using :ref:`Encryption at Rest via Customer KMS <security-aws-kms>`
   you can :ref:`download the latest snapshot 
   <restore-cloud-provider-snapshot-download>` to preserve any data
   stored in the cluster.
