.. _use-auth-with-backup-agent:

==================================================
Use MongoDB Authentication with the |backup| Agent
==================================================

If you are using |backup| with a MongoDB instance with authentication
enabled, there are additional steps you will need to take before you
can start using |backup|.

The |backup| agent supports MongoDB deployments that require authentication.
The agent receives configurations from replica sets and hosts, as well as
credentials from the MMS :guilabel:`Backup` tab.

Create a New User for the |backup| Agent
----------------------------------------

Connect to the :program:`mongod` or :program:`mongos` instance you
will be backing up using the :program:`mongo` shell.

Create a new user for the |backup| Agent using a command that
resembles the following:

.. code-block:: javascript

   use admin
   db.addUser(
   {
       user: 'USERNAME',
       pwd: 'PASSWORD',
       roles: ['readAnyDatabase', 'clusterAdmin', 'userAdminAnyDatabase'],
       otherDBRoles: {local: ['readWrite'], admin: ['readWrite']}
   } )

.. TODO: following note is true until BRS-837 gets resolved

You can now install the Backup agent. See:
:doc:`/backup/tutorial/install-and-start-backup-agent` for more
information. You will need to provide the username and password during
the |backup| setup process.

Enable Authentication for Replica Sets
--------------------------------------

To configure a replica set with authentication enabled:

#. Create a backup user with proper entitlements.

#. Restart your replica set with authentication enabled.

#. Add or update the replica set credentials in the |MMS|, as described below.

Update MMS with Replica Set Username and Password
-------------------------------------------------

Credentials used by Backup agents to manage replica sets with authentication
are independent of Monitoring agents and, therefore, can be managed separately.
Replica set username and password credentials can be reset on the local
machines then updated in the |MMS| for each replica set.

To add or update replica set credentials:

#. Go to :guilabel:`Backup` tab.

#. Click :guilabel:`Replica Set Status`.

#. Click the gear icon to the far right of the replica set name and select Edit
   Credentials.

#. Enter Username and Password for the replica set. Click the Use SSL checkbox
   if SSL is utilized.

