.. _voyage-rate-limits:

==================
Manage Rate Limits
==================

.. default-domain:: mongodb

.. meta::
   :description: Use the Atlas UI to set and manage rate limits for API access.
   :keywords: Atlas, Atlas UI, Voyage AI, Voyage AI rate limits 

.. facet::
   :name: genre
   :values: tutorial

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Rate limits are restrictions on the frequency and number of tokens
you can request from {+voyageai+} within a specified period of time. 
To learn more about rate limits, see :ref:`voyage-mdb-rate-limits-purpose`.

{+service+} enforces rate limits based on the 
{+model-api-key+} :ref:`usage <voyage-monitor-usage>` (requests per
minute (RPM) and tokens per minute (TPM)). 
If you exceed the number of
requests or tokens in the most recent minute, the |api| denies any
subsequent additional request and returns a ``429`` (Rate Limit
Exceeded) HTTP status code.

Manage Rate Limits 
------------------

The following sections describe how to manage rate limits
in the {+atlas-ui+}.

Required Permissions
~~~~~~~~~~~~~~~~~~~~

To set and reset rate limits at the project level, you must have
:authrole:`Project Owner` access or higher to {+service+}. 

To view rate limits:

- At the organization and project levels, you must have
  :authrole:`Organization Read Only` or higher access to {+service+}.
- At only the project level, you must have :authrole:`Project Read Only` 
  or higher access to {+service+}. 

.. _voyage-mdb-rate-limits-set:

Set Rate Limits 
~~~~~~~~~~~~~~~

You can set different limits for each project at the project level.
Project level rate limits can't exceed the rate limits for the
organization. Rate limits set at the project level apply to all
{+model-api-keys+} for the project.  

.. include:: /includes/rate-limits/steps-set-for-project.rst

.. _voyage-mdb-permissions-required:

.. _voyage-mdb-rate-limits-view:

View Rate Limits
~~~~~~~~~~~~~~~~

You can view the rate limits at the organization and project levels. 

.. tabs:: 

   .. tab:: Organization Level 
      :tabid: org-level 

      .. |navoption| replace:: :guilabel:`Rate Limits`

      .. procedure:: 
         :style: normal 

         .. include:: /includes/nav/steps-org-level.rst

      The page displays the following information: 

      .. include:: /includes/rate-limits/list-table-org-level.rst

   .. tab:: Project Level 
      :tabid: project-level 

      .. include:: /includes/rate-limits/steps-view-project-level.rst

.. _voyage-mdb-rate-limits-reset:

Reset All Rate Limits 
~~~~~~~~~~~~~~~~~~~~~

You can reset all the custom limits that you set for a project at any
time. When you reset the limits, the rate limits for the project revert
to the default rate limits for the organization. 

.. include:: /includes/rate-limits/steps-reset-for-project.rst


.. _voyage-mdb-usage-tiers:

Usage Tiers 
-----------

Rate limits follow a tiered system, with higher tiers offering
increased limits. Qualification for a tier is based on billed usage
(excluding free tokens). {+service+} offers 200 million free tokens for
each model. The multimodal models also include 150 billion free
pixels. Once you qualify for a tier, you are never downgraded. As your
usage and spending increase, {+service+} automatically promotes you to
the next usage tier, raising rate limits across all models.

To learn more, see :ref:`voyage-api-rate-limits`. 

.. _voyage-mdb-rate-limits:

Default Rate Limits 
-------------------

This section describes the default rate limits for each usage tier that
are applied at the organization level. It also describes the rate limits
that you can configure for each project.

Organization Rate Limits 
~~~~~~~~~~~~~~~~~~~~~~~~

The following tables show the default rate limits (:abbr:`TPM
(Tokens Per Minute)` and :abbr:`RPM (Requests Per Minute)`) based on usage tier
for each {+voyageai+} embedding model.

.. tabs::

   .. tab:: Usage Tier 1
      :tabid: usage-tier-1

      .. include:: /includes/rate-limits/list-table-tier1.rst

   .. tab:: Usage Tier 2
      :tabid: usage-tier-2

      The rate limits for Usage Tier 2 are twice those of Usage Tier 1.

      .. include:: /includes/rate-limits/list-table-tier2.rst

   .. tab:: Usage Tier 3
      :tabid: usage-tier-3

      The rate limits for Usage Tier 3 are three times those of Usage Tier 1.

      .. include:: /includes/rate-limits/list-table-tier3.rst

Project Rate Limits 
~~~~~~~~~~~~~~~~~~~

By default, projects inherit the rate limits based on the rate limits
for the organization. However, you can set different limits for each
project at the project level. Project level rate limits can't exceed the
rate limits for the organization. Rate limits set at the project level
apply to all {+model-api-keys+} for the project. However, if the
organization rate limit is reached first, projects might be rate-limited
to a lower rate. This can occur when the sum of all project rate limits
exceeds the organization limit. 

.. example:: 

   Consider an organization rate limit *O* with three projects with rate
   limits *P1*, *P2*, and *P3*. The table below illustrates three
   scenarios where the sum of the project rate limits is less than,
   equal to, or greater than the organization rate limit. For each
   scenario, the table indicates whether the organization limit can be
   reached and whether one project's usage can impact another. 

   .. list-table:: 
      :header-rows: 1
      :stub-columns: 1
      :widths: 20 25 25 30

      * - 
        - | Scenario 1
          | P1 + P2 + P3 < O
        - | Scenario 2
          | P1 + P2 + P3 = O
        - | Scenario 3
          | P1 + P2 + P3 > O

      * - Scenario Description
        - Sum of all project rate limits is *less than* the organization
          limit.
        - Sum of all project rate limits is *equal to* the organization
          limit.
        - Sum of all project rate limits is *greater than* the
          organization limit.

      * - Can the organization limit be reached?
        - *No*, even if all projects reach their rate limits, the
          organization rate limit will not be exceeded. 
        - *Yes*, if all projects reach their rate limits, the
          organization limit will also be reached. 
        - *Yes*, as the sum of all project rate limits exceeds the
          organization limit, the organization limit can be reached
          before individual projects hit their own limits. 

      * - Can one project's usage impact another?
        - *No*.
        - *No*.
        - *Yes*. If projects collectively consume enough usage to reach
          the organization limit before any or all projects reach their
          individual limits, projects can be rate-limited to a lower
          rate than their individual limits.

.. _voyage-mdb-prevent-errors:
.. _voyage-mdb-rate-limits-purpose:

Best Practices 
--------------

Rate limits ensure a balanced and efficient utilization of the |api|'s
resources, preventing excessive traffic that could impact the overall
performance and accessibility of the service. Specifically, rate limits 
serve the following vital purposes:

- *Rate limits promote equitable access to the API for all users*. If
  one individual or organization generates an excessive volume of
  requests, it could potentially impede the |api|'s performance for
  others. Through rate limiting, we ensure that a larger number of users
  can utilize the |api| without encountering performance issues. 
- *Rate limits enable Voyage AI to effectively manage the workload on
  its infrastructure*. Sudden and substantial spikes in |api| requests
  could strain server resources and lead to performance degradation. By
  establishing rate limits, {+voyageai+} can effectively maintain a
  consistent and reliable experience for all users. 
- *They act as a safeguard against potential abuse or misuse of the
  API*. For instance, malicious actors might attempt to inundate the
  |api| with excessive requests to overload it or disrupt its services.
  By instituting rate limits, {+voyageai+} can thwart such nefarious
  activities. 

To avoid and manage rate limit errors, we recommend the following
best practices.

Use Large Batches
~~~~~~~~~~~~~~~~~

If you have many documents to embed, you can increase the number of
documents you embed per request and increase your overall throughput by
sending larger batches. A "batch" is the collection of documents you are
embedding in one request, and the "batch size" is the number of
documents in the batch, meaning the length of the list of documents. 

.. example:: 
  
   Suppose you want to vectorize 512 documents. If you used a batch size 
   of 1, then this would require 512 requests and you could hit your 
   :abbr:`RPM (Requests Per Minute)` limit. However, if you used a batch 
   size of 128, then this would require only 4 requests and you would 
   not hit your :abbr:`RPM (Requests Per Minute)` limit. You can control 
   the batch size by changing the number of documents you provide in the 
   request, and using larger batch sizes will reduce your overall 
   :abbr:`RPM (Requests Per Minute)` for a given number of documents.  

You must consider the |api| maximum batch size and tokens when selecting
your batch size. You cannot exceed the |api| max batch size. If you have
longer documents, the token limit per request might constrain you to a
smaller batch size. 

Set a Wait Period
~~~~~~~~~~~~~~~~~

Make requests less frequently. You can do this by pacing your requests,
and the most straightforward approach is inserting a wait period between
each request. 

Perform Exponential Backoff
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Backoff once you've hit your rate limit (that is, receive a ``429``
error). You could wait for an exponentially increased time after
receiving a rate limit error before trying again. Wait until the request
is successful or until a maximum number of retries is reached. 

.. example::
 
   If your initial wait time was one second and you got three
   consecutive rate limit errors before success, you would wait one, two,
   and four seconds after each rate limit error, respectively, before
   resending the request.
