=====================================================
Convert a Replica Set to a Replicated Sharded Cluster
=====================================================

.. default-domain:: mongodb

Overview
--------

This tutorial converts a single three-member replica set to a sharded
cluster with two shards. Each shard is an independent three-member replica
set.

The procedure is as follows:

#. Create any three-member replica sets needed and insert data into a collection.

#. Start the config databases and a :program:`mongos`.

#. Create a sharded cluster then add the replica sets shards in the cluster.

#. Enable sharding on the desired collection or collections.

Prerequisites
-------------

Three servers each for the first :term:`replica set`, second replica set,
and config servers, for a total of nine servers. The :program:`mongos`
will be installed on one of the config servers.

Install a :program:`mongod` on each server, according to the instructions in the
:ref:`MongoDB Installation Tutorial <tutorials-installation>`. Each server
must have a resolvable domain, hostname, or IP address within your
system.

This tutorial assumes you will create ``/data/db`` folders for the default
location for database files. See :doc:`/reference/configuration-options` for
information about configuring alternate database directory paths.

Considerations
--------------

In production deployments, you must deploy exactly three server instances
for each replica set and config servers to assure good uptime and data
safety. In test environments, you can run all three instances on a single
server for a total of three servers, one each for the first replica set,
second replica set, and a single config server.

.. note::

   For development and testing environments, a single config database is
   sufficient. In production environments, use three config
   databases. Because config instances store only the *metadata* for the
   sharded cluster, they have minimal resource requirements.

Procedures
----------

Deploy Replica Sets
~~~~~~~~~~~~~~~~~~~

You will need at least two replica sets for this tutorial. Use this
procedure to create any replica sets needed.

.. include:: /includes/steps/convert-replica-set-shard-deploy-test-data.rst

.. _convert-replica-set-to-shard-cluster-deploy-sharding-infrastructure:

Deploy Config Databases and ``mongos``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This procedure creates the three config databases that store the cluster's
metadata, then configures a :program:`mongos` with the locations of these
config servers.

This tutorial runs the :program:`mongos` on one of the config servers.

.. include:: /includes/steps/convert-replica-set-shard-deploy-infrastructure.rst

Add Shards
~~~~~~~~~~~~~~~

Use :program:`mongos` to add replica sets as shards. Use a terminal
window on the server where the :program:`mongos` runs.

.. include:: /includes/steps/convert-replica-set-add-shards.rst

Enable Sharding
~~~~~~~~~~~~~~~

MongoDB must have :term:`sharding` enabled on *both* the database and
collection levels. Use a terminal window on the server where the
:program:`mongos` runs.

.. include:: /includes/steps/convert-replica-set-enable-sharding.rst

When this procedure is complete, you will have converted a replica set
into a cluster where each shard is itself a replica set.
