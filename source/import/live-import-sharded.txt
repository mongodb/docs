.. _live-import-sharded:

================================================
Live Migrate (Pull) a Sharded Cluster into Atlas
================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

|service| can pull a source sharded cluster into an |service| sharded
cluster using the live migration process. |service| keeps the target
cluster in sync with the remote source until you cut your applications
over to the |service| target cluster. Once you reach the cutover step in
the following procedure, stop writes to the source cluster by stopping
your application instances, pointing them to the |service| cluster, and
restarting them.

Restrictions
------------

- You cannot use a :doc:`Global Cluster </global-clusters>` as the
  target for live migration.

- Live migration does not support :ref:`VPC peering <vpc-peering>` or
  :ref:`private endpoints <private-endpoint>` for either the source or
  target cluster.

To live migrate a replica set, see
:doc:`Live Migrate (Pull) a Replica Set into Atlas </import/live-import>`.

Prerequisites
-------------

If the source cluster runs with authentication, specify a user to
|service| that exists on every shard *and* the config server
replica set. The user must have permissions to:

- Stop or start the sharded cluster balancer.
- Read all databases and collections on the host.
- Read the oplog on the host.

To learn more, see :ref:`live-import-sharded-security`.

.. include:: /includes/note-source-cluster-readiness.rst

.. _live-import-sharded-upgrade-path:

Migration Path
~~~~~~~~~~~~~~

|service| live migration (pull) supports the following migration paths:

.. include:: /includes/list-tables/mongomirror-upgrade-path-sharded.rst

.. note::

   For sharded clusters, the major MongoDB versions on the source and target
   clusters must be exactly the same.

.. _live-import-sharded-ip-access-list:

.. include:: /includes/import/network-access.rst

.. _live-import-sharded-migration-validation:

Pre-Migration Validation
~~~~~~~~~~~~~~~~~~~~~~~~

|service| performs a number of validation checks on the source
and target clusters before starting the live migration procedure.

- The source cluster must be a sharded cluster.

  If the source is replica set cluster, use
  :doc:`pull-type live migration </import/live-import>` to
  migrate the cluster to a |service| replica set first, then
  :doc:`scale your cluster </scale-cluster>` to a sharded cluster.

  If the source is a standalone,
  :manual:`convert the standalone to a replica set first </tutorial/convert-standalone-to-replica-set>`
  before using :doc:`pull-type live migration </import/live-import>`. Then
  :doc:`scale your cluster </scale-cluster>` to a sharded cluster.

- The source cluster must use CSRS (Config Server Replica Sets).
  See :ref:`replset-config-servers`.

- |service| must have connectivity to the hostname and port of each node
  in the source cluster.

- |service| must be able to stop and start the
  :ref:`sharding-balancing` on the source cluster.

- The source cluster has the same feature compatibility version
  *and* major MongoDB version as the target cluster. The major
  MongoDB verison is the first two digits of the full version,
  such as **4.2**.x, or **4.4**.x.

  To check the feature compatibility version of a host in the
  source cluster, run the following command from
  {+mongosh+}:

  .. code-block:: javascript

     db.runCommand( { getParameter : 1, "featureCompatibilityVersion" : 1 } )

  Use the :manual:`setFeatureCompatibilityVersion </reference/command/setFeatureCompatibilityVersion>`
  database command to set the ``featureCompatibilityVersion`` flag
  as needed.

- The target |service| sharded cluster must have the same number of
  :term:`shards <shard>` as the source sharded cluster.

  .. _live-import-sharded-security:

Source Cluster Security
~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/source-cluster-security.rst

.. include:: /includes/fact-failIndexKeyTooLong-import.rst

Considerations
--------------

.. include:: /includes/fact-network-encryption-pull-migration.rst

Source Cluster Balancer
~~~~~~~~~~~~~~~~~~~~~~~

|service| live migration stops the :manual:`sharded cluster balancer
</core/sharding-balancer-administration/>` on the source cluster at the
start of the procedure, and starts the balancer at the end of the
procedure.

If you cancel live migration, |service| restarts the balancer on the
source cluster.

.. note::

   Under some circumstances |service| cannot restart the balancer on the
   source cluster at the end of a live migration process. If the balancer
   fails to restart, the live migration still succeeds but a warning banner
   indicates that the source cluster balancer must be
   :manual:`restarted manually </tutorial/manage-sharded-cluster-balancer/>`.

Target Cluster Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When configuring the target |service| cluster, consider the
following:

.. include:: /includes/fact-live-migration-destination-cluster.rst

- You cannot target a :doc:`Global Cluster </global-clusters>` as the
  target for live migration.

  .. important::

     Once you start the live migration process, you cannot modify the
     target |service| cluster. If you need to scale up the target cluster,
     :ref:`cancel <live-import-sharded-cancel>` the live migration
     process, then scale up the cluster and restart the live migration
     process.

Database Users and Roles
~~~~~~~~~~~~~~~~~~~~~~~~

|service| does not migrate any user or role data to the target
cluster.

If the source cluster enforced authentication, you must re-create the
credentials used by your applications on the target |service|
cluster. |service| uses
:ref:`SCRAM <authentication-scram>` for user
authentication. See :doc:`/security-add-mongodb-users` for a tutorial
on creating database users in |service|.

.. _live-import-sharded-cancel:

Canceling Live Migration
~~~~~~~~~~~~~~~~~~~~~~~~

You can cancel the process at any time by clicking :guilabel:`Cancel`.
|service| displays the
:guilabel:`Sharded Cluster Live Import in Progress`
message for the target cluster until the cluster is ready for
normal access.

If you cancel the live migration process before completion,
|service| does not remove any data migrated up to that point.
If you restart the live migration process using the same
|service| cluster as the target cluster, |service| wipes all data
from the cluster.

Testing the Target Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~

You may want to migrate data to your target cluster, then
stop the migration process and test your target cluster
while leaving the source cluster running and serving data to your
applications.

To test your target cluster with production data, follow
the :ref:`migration procedure <live-migrate-sharded-procedure>`
as far as step 2. When you're ready to perform the complete
migration process, skip step 2 and proceed to step 3.

Avoid Namespace Changes
~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-mongomirror-namespace-changes.rst

Avoid Elections
~~~~~~~~~~~~~~~

.. include:: /includes/fact-avoid-elections.rst

Target Cluster Network Access
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

During live migration, the :binary:`~bin.mongos` processes on the
target cluster are shut down and cluster connectivity via the
``mongos`` servers is suspended. The ``mongos`` processes restart
automatically once migration is complete.

Rolling Restarts
~~~~~~~~~~~~~~~~

.. include:: /includes/live-import-rolling-restarts.rst

Migrate Your Sharded Cluster
----------------------------

.. note:: Staging and Production Migrations

   Consider running a partial live migration procedure first to create
   a staging environment before repeating the procedure to create your
   production environment. The following procedure includes a callout for
   the appropriate time to cancel the procedure and create a staging environment.

   Use the staging environment to test application behavior and
   performance using the latest :driver:`driver version </driver-compatibility-reference>` 
   that supports the MongoDB version of the target |service| cluster. Then,
   repeat the live migration procedure in full to transition your applications
   from your source cluster to the |service| target cluster.

.. important::

   Avoid making changes to the source cluster configuration while the
   live migration procedure runs, such as removing replica set members
   or modifying :binary:`mongod <bin.mongod>` runtime settings,
   such as ``featureCompatibilityVersion``.

.. include:: /includes/pre-migration-checklist.rst

.. _live-migrate-sharded-procedure:

Procedure
~~~~~~~~~

.. include:: /includes/steps/atlas-live-import-sharded.rst

.. _live-migration-sharded-support:

.. include:: /includes/live-migration-support.rst
