=============
Configuration
=============

.. default-domain:: mongodb

Overview
--------

The MMS Application Package and the MMS Backup Daemon Package include a
``conf-mms.properties`` file. Located in the ``<install_dir>/conf/``
directory, the ``conf-mms.properties`` files contain configuration
settings for their respective services.

To start either service, you must configure the
:ref:`application-url-settings` and :ref:`email-address-settings` in
the respective ``conf-mms.properties`` file.

Since the configuration file may contain user credentials in plain
text, follow standard practice and reduce the permissions on the
configuration file:

.. code-block:: sh

   sudo chmod 600 <install_dir>/conf/conf-mms.properties

Settings
--------

.. _application-url-settings:

Application URL Settings
~~~~~~~~~~~~~~~~~~~~~~~~

The following two settings are mandatory.

.. setting:: mms.centralUrl

   *Type*: string

   Required. Fully qualified URL, including the port number, of the MMS
   Monitoring server. For example,

   .. code-block:: ini

      mms.centralUrl=http://mms.example.com:8080

.. setting:: mms.backupCentralUrl

   *Type*: string

   Required. The hostname and port of MMS Backup server. For example,

   .. code-block:: ini

      mms.backupCentralUrl=http://mms.example.com:8081

   You must set :setting:`mms.backupCentralUrl`, even if you are only
   using MMS Monitoring and not MMS Backup.

Email Settings
~~~~~~~~~~~~~~

.. _email-address-settings:

Email Address Settings
``````````````````````

The following email address settings are mandatory. You **must** define
them before the |monitoring| instance will start.

.. setting:: mms.fromEmailAddr

   *Type*: string

   Required. The email address used for sending the general emails,
   such as MMS alerts. You can include an alias with the email address.
   For example:

   .. code-block:: ini

      mms.fromEmailAddr=MMS Alerts <mms-alerts@example.com>

.. setting:: mms.replyToEmailAddr

   *Type*: string

   Required. The email address to send replies to general emails. For
   example:

   .. code-block:: ini

      mms.replyToEmailAddr=mms-no-reply@example.com

.. setting:: mms.adminFromEmailAddr

   *Type*: string

   Required. The email address to send messages from the MMS admin. You
   can include an alias with the email address. For example:

   .. code-block:: ini

      mms.adminFromEmailAddr=MMS Admin <mms-admin@example.com>

.. setting:: mms.adminEmailAddr

   *Type*: string

   Required. The email address to send messages or replies to the MMS
   admin. You can include an alias with the email address. For example:

   .. code-block:: ini

      mms.adminEmailAddr=mms-admin@example.com

.. setting:: mms.bounceEmailAddr

   *Type*: string

   Required. The email address to send bounce messages, i.e. messages
   of non-delivery of alerts or messages from MMS admin. For example:

   .. code-block:: ini

      mms.bounceEmailAddr=bounce@example.com

Email Service Settings
``````````````````````

.. setting:: mms.emailDaoClass

   *Type*: string

   The email interface to use. For AWS Simple Email Service,
   specify ``com.xgen.svc.core.dao.email.AwsEmailDao``, as in:

   .. code-block:: ini

      mms.emailDaoClass=com.xgen.svc.core.dao.email.AwsEmailDao

   For AWS Simple Email Service, see also :setting:`aws.accesskey` and
   :setting:`aws.secretkey`.

   For JavaEmailDao, specify
   ``com.xgen.svc.core.dao.email.JavaEmailDao``, as in:

   .. code-block:: ini

      mms.emailDaoClass=com.xgen.svc.core.dao.email.JavaEmailDao

.. setting:: mms.mail.transport

   *Type*: string
   *Default*: smtp

   Transfer protocol ``smtp`` or ``smtps`` as specified by your email
   provider. For example:

   .. code-block:: ini

      mms.mail.transport=smtp

.. setting:: mms.mail.hostname

   *Type*: string
   *Default*: localhost

   Email hostname as specified by your email provider. For example:

   .. code-block:: ini

      mms.mail.hostname=mail.example.com

.. setting:: mms.mail.port

   *Type*: number
   *Default*: 25

   Port number for the transfer protocol as specified by your email
   provider. For example:

   .. code-block:: ini

      mms.mail.port=25

.. setting:: mms.mail.tls

   *Type*: boolean
   *Default*: false

   Indicator of whether the transfer protocol runs on top of TLS. For
   example:

   .. code-block:: ini

      mms.mail.tls=false

.. setting:: mms.mail.username

   *Type*: string

   User name of the email account. If unset, defaults to disabled SMTP
   authentication.

   .. code-block:: ini

       mms.mail.username=

.. setting:: mms.mail.password

   *Type*: string

   Password for the email account. If unset, defaults to disabled SMTP
   authentication.

   .. code-block:: ini

      mms.mail.password=emailPassword

.. setting:: aws.accesskey

   Required if using AWS Simple Email Service. The access key ID for AWS.

   .. code-block:: ini

      aws.accesskey=EXAMPLEAccessKeyID

.. setting:: aws.secretkey

   Required if using AWS Simple Email Service. The secret access key
   for AWS.

   .. code-block:: ini

      aws.secretkey=eXampLe/aCcESs/KEY

.. _twilio-sms-configure:

Twilio SMS Alert Settings
~~~~~~~~~~~~~~~~~~~~~~~~~

To receive alert notifications via SMS, you must have a `Twilio
<http://www.twilio.com/docs/quickstart>`_ account and specify your
Twilio account information in the configuration file.

.. setting:: twilio.account.sid

   *Type*: string

   Twilio account ID.

.. setting:: twilio.auth.token

   *Type*: string

   Twilio API token.

.. setting:: twilio.from.num

   *Type*: string

   Twilio phone number.

MongoDB Settings
~~~~~~~~~~~~~~~~

.. setting:: mongo.mongoUri

   *Type*: string

   Required. The :manual:`connection string
   </reference/connection-string/>` to the MongoDB server for
   MMS, i.e. the MMS Application Database. For example, the
   following specifies the URI for a :term:`replica set`:

   .. code-block:: ini

      mongo.mongoUri=mongodb://db1.example.net:40000,db2.example.net:40000,db3.example.net:40000

   For a MongoDB server with access control, prefix the hostname with
   the MongoDB username and password in the form
   ``<username>:<password>@``, and append after the port the ``/admin``
   database. For example:

   .. code-block:: ini

      mongo.mongoUri=mongodb://mongodbuser1:password@mydb1.example.net:40000/admin

   For a MongoDB server using LDAP as the authentication mechanism,
   prefix the hostname with the MongoDB username and password in the
   form ``<username>:<password>@``, and append the
   ``authMechanism=PLAIN&authSource=$external`` options after the
   port:

   .. code-block:: ini

      mongo.mongoUri=mongodb://mongodbuser1:password@mydb1.example.net:40000/?authMechanism=PLAIN&authSource=$external

   For additional considerations when specifying user credentials, such
   as encrypting user credentials or authenticating with Kerberos, see
   :ref:`on-prem-authentication-configuration`.

   See :manual:`Connection String URI Format
   </reference/connection-string/>` for more information on the
   connection string.

.. setting:: mongo.replicaSet

   *Type*: string

   Required if using a replica set for :setting:`mongo.mongoUri`. The
   name of the replica set. For example:

   .. code-block:: ini

      mongo.replicaSet=mmsreplset

.. setting:: mongo.encryptedCredentials

   *Type*: boolean

   Optional. Set to ``true`` if :setting:`mongo.mongoUri` contains the
   encrypted username and password.

   .. code-block:: ini

      mongo.encryptedCredentials=true

   The username and password must have been encrypted using the
   |monitoring| ``credentialstool``. See
   :ref:`on-prem-authentication-configuration` for more information on
   encrypting username and password.

   .. important::
      The ``conf-mms.properties`` file can contain multiple
      :setting:`mongo.MongoURI` settings. If
      :setting:`mongo.encryptedCredentials` is ``true``, you must encrypt
      all user credentials found in the various :setting:`mongo.MongoURI`
      settings.

MMS Backup Daemon Settings
~~~~~~~~~~~~~~~~~~~~~~~~~~

These settings in the ``conf-daemon.properties`` file, are
necessary only if you are using MMS Backup.

.. setting:: mongo.backupdb.mongoUri

   *Type*: string

   Required for MMS Backup. The :manual:`connection string
   </reference/connection-string/>` to the MMS Backup Blockstore Database.
   This must be a separate MongoDB Server than the MMS Application Database.
   For example:

   .. code-block:: ini

      mongo.backupdb.mongoUri=mongodb://db5.example.net:50000,db6.example.net:50000,db7.example.net:50000

.. setting:: mongo.backupdb.replicaSet

   *Type*: string

   Required for MMS Backup if using a replica set for
   :setting:`mongo.backupdb.mongoUri`. The name of the replica set. For
   example:

   .. code-block:: ini

      mongo.backupdb.replicaSet=mmsbackupreplset

.. setting:: rootDirectory

   *Type*: string

   The disk partition used by the Backup Daemon to dynamically create and
   maintain the :term:`replica set` HEAD directories. For more information
   on HEADs, see the :ref:`MMS Backup functional overview
   <mms-backup-functional-overview>`.

   This directory must be writable
   by the mongodb-mms user and must end in a trailing slash.  It is critical
   that this partition is sized appropriately.

   .. important::
      Data in this directory is dynamically created, maintained and destroyed by the
      MMS Backup Daemon. This partition should not be used for any other purpose.
      This partition should *not* overlap with the partition used for the Backup
      Blockstore Database.

.. setting:: mongodb.release.directory

   *Type*: string

   Specifies the full path to the directory that contains every MongoDB
   release needed by the Backup Daemon. When backing up a replica set, The
   Backup Daemon must use a :program:`mongod` that matches the version of
   the replica set being backed up.

   If you update versions manually, name the folders within this full
   directory path using the following form:

   .. code-block:: none

      mongodb-<platform>-<architecture>-<version>

   For example:

   .. code-block:: none

      mongodb-linux-x86_64-2.4.8
      mongodb-linux-x86_64-2.4.9
      mongodb-linux-x86_64-2.4.10
      mongodb-linux-x86_64-2.6.0

   The Backup Daemon includes the ``mongodb-fetch`` utility that will
   download the latest releases directly from
   `mongodb.org/downloads <http://www.mongodb.org/downloads>`_.
   The :setting:`mongodb.release.autoDownload` setting automatically runs
   this utility every hour once the service starts. For details, including
   the option to download manually, see :setting:`mongodb.release.autoDownload`.

.. todo: In On Prem the utility is named mongo-fetch. Should we create two
         paragraphs or create replacement tex?

   .. important::
      If you are backing up MongoDB custom builds, you must manually
      place a matching binary distribution for each custom build in this
      directory.

.. setting:: mongodb.release.autoDownload

   *Type*: boolean

   Specify ``true`` to enable automatic downloads; ``false`` to disable.

   When ``true``, Backup automatically downloads the latest
   release of MongoDB from
   `mongodb..org/downloads <http://www.mongodb.org/downloads>`_
   and stores it in the directory specified by the
   :setting:`mongodb.release.directory` setting. The Backup Daemon
   includes the ``mongodb-fetch`` utility, located in the
   ``/opt/mongodb/backup-daemon/bin`` directory, which runs once an hour
   to perform the downloads.

   If you set :setting:`mongodb.release.autoDownload` ``false``, then you
   must manually download and install the needed MongoDB releases in the
   :setting:`mongodb.release.directory`. If you backup deployments that
   use different MongoDB versions, you must download and install each
   version.

   Download MongoDB from `mongodb..org/downloads
   <http://www.mongodb.org/downloads>`_ and extract them.
   Alternately, you can use the ``mongodb-fetch`` utility manually, included in
   the distribution the backup component ensures that the Backup
   Daemon has the correct version of :program:`mongod` for every
   backed up replica set.

Session Management Setting
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. setting:: mms.session.maxHours

   *Type*: number

   The number of hours before a session on the MMS website expires.

Password Policy Settings
~~~~~~~~~~~~~~~~~~~~~~~~

You can configure the password policy for MMS user accounts with the
following settings:

.. setting:: mms.password.minChangesBeforeReuse

   *Type*: number

   The number of previous passwords to remember. You cannot reuse a
   remembered password as a new password.

.. setting:: mms.password.maxFailedAttemptsBeforeAccountLock

   *Type*: number

   The number of failed login attempts before an account becomes
   locked. Only an an MMS Administrator can unlock a locked account.

.. setting:: mms.password.maxDaysInactiveBeforeAccountLock

   *Type*: number

   The maximum number of days with no visits to the MMS website before
   MMS locks an account.

.. setting:: mms.password.maxDaysBeforeChangeRequired

   *Type*: number

   The number of days a password is valid before the password expires.

.. setting:: mms.multiFactorAuth.require

   *Type*: boolean
   *Default*: false

   When ``true``, MMS will require two-factor authentication for
   users to log in or to perform certain destructive operations within the
   application.

   If you configure :ref:`Twilio integration <twilio-sms-alert-settings>`,
   users may obtain their second factor tokens via Google Authenticator, SMS,
   or voice calls. Otherwise, the only mechanism to provide two-factor authentication is
   Google Authenticator.

.. setting:: mms.multiFactorAuth.allowReset

   *Type*: boolean
   *Default*: false

   When ``true``, MMS will allow users to reset their two-factor
   authentication settings via email in an analogous fashion to resetting their
   passwords.

   To reset two-factor authentication, a user must:

   - be able to receive email at the address associated with the user account
   - know the user account's password
   - know the Agent API key for any MMS Group of which the user is a member

.. setting:: mms.multiFactorAuth.issuer

   *Type*: string

   If Google Authenticator provides two-factor authentication, this
   string is the ``issuer`` in the Google Authenticator app. If
   left blank, the ``issuer`` is the domain name of the MMS
   installation.

.. _snmp-heartbeat-configure:

SNMP Heartbeat Settings
~~~~~~~~~~~~~~~~~~~~~~~

You can configure the On Prem MMS Server to send a periodic heartbeat
trap notification (v2c) that contain an internal health assessment of
the MMS Server. The MMS Server can send traps to one or more endpoints
on the standard SNMP UDP port 162.

To configure the On Prem MMS Server to send trap notifications,
download the Management Information Base (MIB) file at
`<http://downloads.mongodb.com/on-prem-monitoring/MMS-MONGODB-MIB.txt>`_
and configure the following settings:

.. setting:: snmp.default.hosts

   *Type*: string
   *Default*: blank

   Comma-separated list of hosts where 'heartbeat' traps will be sent
   on the standard UDP port 162.
   You must set :setting:`snmp.default.hosts` to enable the SNMP
   heartbeat functionality; otherwise, leaving the setting blank
   disables the SNMP heartbeat functionality.

.. setting:: snmp.listen.port

   *Type*: number
   *Default*: 11611

   Listening UDP port for SNMP. Setting to a number less than 1024 will
   require running MMS server with root privileges.

.. setting:: snmp.default.heartbeat.interval

   *Type*: number
   *Default*: 300

   Number of seconds between heartbeat notifications.

reCaptcha Settings
~~~~~~~~~~~~~~~~~~

To enable `reCaptcha anti-spam test
<http://www.google.com/recaptcha/whyrecaptcha>`_ on new user
registration, you must have a `reCaptcha account
<https://www.google.com/recaptcha/admin/create>`_ and specify the API
information in the configuration file.

.. setting:: reCaptcha.public.key

   *Type*: string

   The reCaptcha public key associated with your account.

.. setting:: reCaptcha.private.key

   *Type*: string

   The reCaptcha private key associated with your account.

LDAP Settings
~~~~~~~~~~~~~

LDAP Server Setting
```````````````````

.. setting:: mms.userSvcClass

   *Type*: string

   The LDAP service class ``com.xgen.svc.mms.svc.user.UserSvcLdap``; i.e.

   .. code-block:: ini

      mms.userSvcClass=com.xgen.svc.mms.svc.user.UserSvcLdap

LDAP User Settings
``````````````````

Specify the LDAP directory schema properties in the following settings:

.. setting:: mms.ldap.url

   *Type*: string

   The URI for the LDAP server. For example:

   .. code-block:: ini

      mms.ldap.url=ldap://174.129.71.167:3890

.. setting:: mms.ldap.bindDn

   *Type*: string

   The LDAP user used to execute searches for other users. For example:

   .. code-block:: ini

      mms.ldap.url=_search_

.. setting:: mms.ldap.bindPassword

   *Type*: string

   The credentials for the search user.  For example:

   .. code-block:: ini

      mms.ldap.bindPassword=dISDFFFnj7WMmc

.. setting:: mms.ldap.user.baseDn

   *Type*: string

   The base Directory Name (DN) used for searching for users. Escape
   the ``=`` sign with ``\``. For example:

   .. code-block:: ini

      mms.ldap.user.baseDn=c\=users,d\=identity

.. setting:: mms.ldap.user.searchAttribute

   *Type*: string

   The LDAP user record attribute that MMS uses to search and
   authenticate users when a user types their username into the MMS
   login form. For example:

   .. code-block:: ini

      mms.ldap.user.searchAttribute=uid

.. setting:: mms.ldap.user.firstName

   *Type*: string

   The LDAP user attribute that contains the user's first name. For
   example:

   .. code-block:: ini

      mms.ldap.user.firstName=givenName

.. setting:: mms.ldap.user.lastName

   *Type*: string

   The LDAP user attribute that contains the user's last name. For
   example:

   .. code-block:: ini

      mms.ldap.user.lastName=sn

.. setting:: mms.ldap.user.email

   *Type*: string

   The LDAP user attribute that contains the user's email address. For
   example:

   .. code-block:: ini

      mms.ldap.user.email=mail

.. setting:: mms.ldap.user.group

   *Type*: string

   The LDAP user attribute that contains the list of groups that the
   user belongs to.

   .. code-block:: ini

      mms.ldap.user.group=groups

   These can be either Common Names (CN's) or
   Distinguished Names (DN's) as long as they are consistent with those
   provided in the MMS :ref:`global-role-settings`. For example:

.. _global-role-settings:

LDAP Global Role Settings
~~~~~~~~~~~~~~~~~~~~~~~~~

Global parameters can be in any format for an LDAP group. They can be a
Common Name (i.e. ``cn``) or a Distinguished Name (i.e. ``dn``). The
format must match the property specified by the
:setting:`mms.ldap.user.group` setting.

.. setting:: mms.ldap.global.role.read_only

   *Type*: string

   The LDAP group attribute name for users assigned the global
   read-only role in MMS. This role can only view data in MMS. For example:

   .. code-block:: ini

      mms.ldap.global.role.read_only=AcmeDbas

.. setting:: mms.ldap.global.role.monitoring_admin

   *Type*: string

   The LDAP group attribute name for users assigned the global
   monitoring administrative role in MMS. This role can view hosts,
   charts, and other data, as well as monitor hosts, manage monitoring
   settings, download the Monitoring Agent, and other tasks. For example:

   .. code-block:: ini

      mms.ldap.global.role.monitoring_admin=AcmeDbas

.. setting:: mms.ldap.global.role.backup_admin

   *Type*: string

   The LDAP group attribute name for users assigned the global backup
   administrative role in MMS. This role can view backup status,
   snapshot lists, and modify backup settings, as well as
   start/stop/terminate backups, request restores, view/edit host
   passwords, and other tasks.

   .. code-block:: ini

      mms.ldap.global.role.backup_admin=AcmeDbas

.. setting:: mms.ldap.global.role.owner

   *Type*: string

   The LDAP group attribute name for users assigned the global owner
   role in MMS. This role can perform all administrative tasks in MMS.

   .. code-block:: ini

      mms.ldap.global.role.backup_admin=AcmeDbas

.. seealso:: :doc:`/reference/user-roles`

.. _configuration-kerberos-settings:

Kerberos Settings
~~~~~~~~~~~~~~~~~

To enable Kerberos authentication between the MMS application and its
:doc:`backing database </tutorial/prepare-backing-mongodb-instances>`,
configure the following settings. You must configure
all required Kerberos settings to enable Kerberos authentication.

.. setting:: jvm.java.security.krb5.kdc

   Required. The IP/FQDN (Fully Qualified Domain Name) of the KDC
   server. The value will be set to JVM's java.security.krb5.kdc.

   .. code-block:: properties

      jvm.java.security.krb5.kdc=kdc.example.com

.. setting:: jvm.java.security.krb5.realm

   Required. This is the default REALM for Kerberos. It is being used
   for JVM's java.security.krb5.realm.

   .. code-block:: properties

      jvm.java.security.krb5.realm=EXAMPLE.COM

.. setting:: mms.kerberos.principal

   Required. The principal we used to authenticate with MongoDB. This
   should be the exact same user on the :setting:`mongo.mongoUri` above.

   .. code-block:: properties

      mms.kerberos.principal=mms/mmsweb.example.com@EXAMPLE.COM

.. setting:: mms.kerberos.keyTab

   Required. The absolute path to the keytab file for the principal.

   .. code-block:: properties

      mms.kerberos.keyTab=/path/to/mms.keytab

.. setting:: mms.kerberos.debug

   Optional. The debug flag to output more information on Kerberos
   authentication process.

   .. code-block:: properties

      mms.kerberos.debug=false

.. _on-prem-authentication-configuration:

MongoDB Access Control Considerations
-------------------------------------

For a MongoDB server with access control, the :setting:`mongo.mongoUri`
includes the MongoDB user credentials. For example:

.. code-block:: ini

   mongo.mongoUri=mongodb://mongodbuser1:password@mydb1.example.net:40000/admin

Encrypt MongoDB User Credentials
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you do not want to store credentials in plain text, |monitoring|
provides a tool to encrypt the MongoDB credentials. To encrypt
authentication credentials:

#. Issue the following command to create an encrypted credential pair,
   replacing ``<username>`` with your username:

   .. code-block:: sh

      sudo <install_dir>/bin/credentialstool --username <username> --password

   This will prompt you to enter the password and will output the
   encrypted credential pair.

   ``credentialstool`` requires root privileges, (i.e. ``sudo``) when
   installed with ``rpm`` or ``deb`` packages, because it modifies the
   ``/etc/mongodb-mms/gen.key`` file.

#. Use the encrypted credential pair in the :setting:`mongo.MongoURI`
   settings where needed, and add the
   :setting:`mongo.encryptedCredentials = true
   <mongo.encryptedCredentials>` setting. For example:

   .. code-block:: sh

      mongo.mongoUri=mongodb://da83ex3s:a4fbcf3a1@mydb1.example.net:40000/admin
      mongo.encryptedCredentials=true

.. important::
   The ``conf-mms.properties`` file can contain multiple
   :setting:`mongo.MongoURI` settings. If
   :setting:`mongo.encryptedCredentials` is ``true``, you must encrypt
   all user credentials found in the various :setting:`mongo.MongoURI`
   settings.

Kerberos Authentication
~~~~~~~~~~~~~~~~~~~~~~~

To enable Kerberos authentication between the MMS application and its
:doc:`backing database </tutorial/prepare-backing-mongodb-instances>`,
see also :ref:`configuration-kerberos-settings`.

.. COMMENT - probably will be better to generalize with below section
.. but until everything is verified, will go with the known
.. 
..   Authentication Mechanisms and Source
..   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
..
   To connect to a MongoDB server using LDAP or Kerberos, include the
   :data:`~uri.authMechanism` and the :data:`~uri.authSource` options in
   the :setting:`mongo.mongoUri` connection string. See
   :setting:`mongo.mongoUri` for details.
..
   To enable Kerberos authentication between the MMS application and its
   :doc:`backing database </tutorial/prepare-backing-mongodb-instances>`,
   see also :ref:`configuration-kerberos-settings`.

MongoDB User Access
~~~~~~~~~~~~~~~~~~~

The MongoDB user *must* have the
following roles: :authrole:`readWriteAnyDatabase`,
:authrole:`clusterAdmin`, and :authrole:`dbAdminAnyDatabase`.
