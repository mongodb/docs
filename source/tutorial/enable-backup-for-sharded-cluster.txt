=====================================
Activate Backup for a Sharded Cluster
=====================================

.. default-domain:: mongodb

Overview
--------

You can start, restart, stop, and terminate backups for a :term:`sharded cluster`.
As appropriate, you also can specify which instance to use for the initial
sync, exclude namespaces, and change the snapshot schedule
and retention.

.. note::
   The sharded-cluster must be MongoDB version 2.4.3 or later.

Considerations
--------------

.. include:: /includes/considerations-backup-daemon-enable.rst

.. _considerations-backup-storage-engine:

.. include:: /includes/considerations-backup-daemon-storage.rst

.. _checkpoint:

Checkpoints
+++++++++++

Checkpoints provide additional restore points between snapshots. With
checkpoints enabled, |mms| Backup creates restoration points at
configurable intervals of every 15, 30 or 60 minutes between
snapshots.

To create a checkpoint, |mms| Backup stops the :term:`balancer`
and inserts a token into the :term:`oplog` of each
:term:`shard` and :term:`config server` in the cluster. These
checkpoint tokens are lightweight and do not have a consequential
impact on performance or disk use.

|mms| backup does not require checkpoints: by default, |mms| does not
enable checkpoints.

Restoring from a checkpoint requires |mms| Backup to apply the oplog of
each shard and config server to the last snapshot captured before the
checkpoint. Restoration from a checkpoint takes longer than
restoration from a snapshot.

.. _snapshot-while-balancer-enabled:

Snapshots when Agent Cannot Stop Balancer
+++++++++++++++++++++++++++++++++++++++++

In normal operation, |mms| disables the :term:`balancer` before taking a
cluster snapshot. In certain situations, such as a long migration or no
running :program:`mongos`, |mms| tries to disable the balancer but cannot.
In such cases, |mms| will continue to take cluster snapshots but will flag
the snapshots with a warning that data may be incomplete and/or
inconsistent. Cluster snapshots taken during an active balancing
operation the risk of containing data loss or orphaned data.

Snapshots when Agent Cannot Contact a ``mongod``
++++++++++++++++++++++++++++++++++++++++++++++++

If the Backup Agent cannot reach a :program:`mongod` instance, whether a
shard or config server, then the agent cannot insert a synchronization
:term:`oplog` token. If this happens, |mms| will not create the snapshot and
will display a warning message.

Prerequisites
-------------

Before enabling backup, ensure that the following is true for all replica
sets that you back up:

- |mms| Monitoring is actively collecting data from your cluster, including
  from at least one :program:`mongos`.

- All the cluster's :term:`config servers <config server>` are
  running, and the balancing round has completed within the last hour.

- There is an active :term:`primary`.

- If you explicitly select a sync target, ensure that the sync target is
  accessible on the network and keeping up with replication.

Procedure
---------

.. include:: /includes/steps/backup-activate-sharded-cluster.rst

Your Backup Agent will start polling the specified
instance for this sharded cluster.
