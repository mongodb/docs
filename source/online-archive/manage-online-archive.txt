.. _manage-online-archive:

====================
Archive Cluster Data
====================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

|service| offers a feature that moves infrequently accessed data from 
your |service| cluster to a MongoDB-managed read-only :adl:`Data Lake 
</>` on a cloud object storage without user action. Once |service| 
archives the data, you have a unified view of your |service| and 
{+Online-Archive+} data using a read-only |data-lake|.

|service| archives data based on the criteria you specify in an
archiving rule. The criteria can be one of the following:  

- A combination of a date field to archive data and number of days to 
  keep data on the |service| cluster. When the current date exceeds the 
  value of the specified date field, |service| subtracts the number of 
  days from the current time and then archives data after that many 
  days, hours, and minutes.
- A custom query. |service| runs the query specified in the archiving 
  rule to select the documents to archive.

Cluster Requirements for Online Archive
---------------------------------------

|service| offers this *{+Online-Archive+}* feature only on ``M10`` and
greater clusters that run MongoDB 3.6 or later.

.. _online-archive-job:

How |service| Archives Data
---------------------------

To archive data:

1. |service| periodically runs a query to determine the documents that 
   match the criteria for archiving. |service| refers to this query as 
   a *job*. Initially, |service| runs the job every five minutes. If 
   the size or number of documents to archive doesn't meet the 
   threshold, |service| expands the job interval by ten minutes, up to 
   a maximum of twelve hours. If the job interval reaches the maximum 
   or if either the size or number of documents to archive reaches the 
   threshold, |service| runs the job again and resets the job interval 
   to five minutes.

2. For documents that match the archival criteria, |service|:

   a. Writes to up to a maximum of 10,000 partitions per archival job.

   b. Writes up to 2GB of document data to partitions on the cloud 
      object storage for each unique combination of query field values 
      except dates, which are grouped during each run to reduce the 
      number of partitions.

   c. Writes each subsequent quantity of document data (up to 2 GB)
      with each query run.

|service| provides a unified endpoint through which you can query both
your live cluster and archived data using the same database and
collection name you use in your |service| cluster. You can't use the
unified endpoint over a private connection such as
:doc:`Peering </security-vpc-peering>` or {+aws-pl+}. You must use a
standard internet connection over |tls|.

If you activate {+Online-Archive+} for an |aws| cluster, the cloud 
object storage exists in the same region in |aws| as your cluster. If 
you activate {+Online-Archive+} for a |gcp| or |azure| cluster, 
{+Online-Archive+} creates the archive in the |aws| region closest to 
your cluster's primary based on a calculation of distance between the 
cluster and cloud object storage.

.. important::

   |service| encrypts your archived data using `Amazon's server-side encryption S3-managed keys (SSE-S3) <https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingServerSideEncryption.html>`__ for 
   archived data. It can't use any encryption-at-rest encryption 
   keys you might have used on your cluster data. 

When you archive data, |service| first copies the data to the cloud 
object storage and then deletes the data from your |service| cluster. 
:manual:`WiredTiger </core/wiredtiger/>` does not release the storage 
blocks of the deleted data back to the OS for performance reasons. 
However, |service| eventually automatically reuses these storage blocks 
for new data. This helps the |service| cluster to avoid fragmentation. 
To learn more about reclaiming the disk space, see :manual:`How do I 
reclaim disk space in WiredTiger? 
</faq/storage/#how-do-i-reclaim-disk-space-in-wiredtiger>`.

|data-lake| for {+Online-Archive+}
----------------------------------

When you configure your ``M10`` or greater |service| cluster for
{+Online-Archive+}, |service| creates a read-only :adl:`Data Lake </>`,
one per cluster, on a cloud object storage for your archived data.

Limitations
~~~~~~~~~~~

- You can't write to the {+Online-Archive+} |data-lake|.

- You can't :adl:`configure </config/config-data-lake>` or
  :adl:`administer </administration>` the {+Online-Archive+} 
  |data-lake| through the:

  - |service| console,
  - |data-lake| :adl:`CLI </reference/cli/datalake-cli>`, or
  - |data-lake| :adl:`API </reference/api/datalakes-api>`.

Viewing the {+Online-Archive+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To view your |data-lake| for the {+Online-Archive+}:

1. Navigate to the |data-lake| page in the |service| console.

2. Click :guilabel:`Data Lake` from the left navigation in your
   :guilabel:`Project` page.

Querying the {+Online-Archive+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To query your {+Online-Archive+} data, use the connection string
through the |data-lake| :guilabel:`Connect` button to connect to the 
cloud object storage.

You can also query your {+Online-Archive+} data with :abbr:`SQL 
(Structured Query Language)`. For more information, see :adl:`Querying 
with SQL </admin/query-with-sql>`.

Deleting {+Online-Archive+}s
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you delete all the {+Online-Archive+}s, |service| deletes the
|data-lake|. After deleting all the {+Online-Archive+}s, if you create
an {+Online-Archive+} with the same settings as a deleted
{+Online-Archive+}, |service| creates a new |data-lake| for the new
{+Online-Archive+}.

.. _online-archive-pricing:

{+Online-Archive+} Costs
------------------------

{+Online-Archive+} stores infrequently accessed data to lower the data 
storage costs on your |service| cluster. You incur costs for the 
following:

- storage on the cloud object storage,
- data scanned for queries, and
- data returned by queries.

To learn more about |data-lake| costs, see the billing 
documentation for :ref:`data-lake-billing`.

Manage Your {+Online-Archive+}
--------------------------

You can configure an {+Online-Archive+} for a collection on your
cluster through your |service| UI and |api|. Once you create an
{+Online-Archive+}, you can: 

- :doc:`View the list of Online Archives </online-archive/view-online-archives>`.
- :doc:`Edit an archiving rule </online-archive/edit-online-archive>`.
- :doc:`Pause archiving </online-archive/pause-resume-online-archive>`.
- :doc:`Delete your Online Archive </online-archive/delete-online-archive>`.
- :doc:`Restore archived data </online-archive/restore-archived-data>`.

.. toctree::
   :titlesonly:

   /online-archive/configure-online-archive
   /online-archive/connect-to-online-archive
   /online-archive/view-online-archives
   /online-archive/edit-online-archive
   /online-archive/pause-resume-online-archive
   /online-archive/delete-online-archive
   /online-archive/config-backup-online-archive
   /online-archive/restore-archived-data 
   /online-archive/download-query-logs
