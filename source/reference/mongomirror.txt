===========
mongomirror
===========

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. only:: (not man)

.. binary:: mongomirror

   A utility for migrating data from an existing MongoDB replica set
   to a MongoDB |service| replica set. ``mongomirror`` does
   not require you to shut down your existing replica set or
   applications.

.. include:: /includes/mongomirror-support.rst

.. important::

     :binary:`~bin.mongomirror` does not import user/role data or
     the ``config`` database.

Download ``mongomirror``
------------------------

.. admonition:: Debian 7 End of Life
   :class: note

   Debian 7 reached
   `End of Life <https://www.debian.org/News/2018/20180601>`_ on
   May 31, 2018. ``mongomirror`` 0.3.1 removed support for
   Debian 7 systems.

.. include:: /includes/list-table-mongomirror-downloads.rst



Syntax
------

To run ``mongomirror``, you must specify the source replica
set and the target |service| replica set. For |service|, you must
specify a user in the |service| cluster with
:ref:`appropriate privileges <destination-authorization>` and the
corresponding password. If the source replica set requires
authentication, you must specify a user with
:ref:`appropriate privileges <source-rs-authorization>`.

.. code-block:: sh

   mongomirror --host <sourceReplSet> \
      --destination <atlasCluster> \
      --destinationUsername <atlasAdminUser> \
      --destinationPassword <atlasPassword> \
      [Additional options]

For details on the options, see :ref:`mongomirror-options`.

Migration Process
-----------------

When you start ``mongomirror``:

#. First, ``mongomirror`` performs an initial sync, copying
   collections from the existing MongoDB replica set to the target
   cluster in |service|.

#. After the initial sync, ``mongomirror`` continuously
   tails the replica set's oplog for incoming changes and replays them
   on the target cluster in MongoDB |service|.

.. note:: 

   As of version 0.9.0, ``mongomirror`` uses wire compression if it is
   enabled with either the source or the target. Use the :option:`--compressors`
   option to specify which compression libraries to allow.

Once started, ``mongomirror`` runs continuously until you
shut down the process.

- If you shut down ``mongomirror`` during the initial sync
  stage, either ensure that the target cluster is empty before you
  restart ``mongomirror`` or run ``mongomirror``
  with the :option:`--drop` option.

- If you shut down ``mongomirror`` during the oplog tailing
  stage, you can restart ``mongomirror`` to continue from
  the last oplog record processed. See the
  :mongomirror:option:`--bookmarkFile` option.

Progress Measurement
~~~~~~~~~~~~~~~~~~~~

``mongomirror`` logs its progress to the standard output in
the terminal:

During the initial sync, ``mongomirror`` logs a progress
bar for each collection it copies. For example:

.. code-block:: sh
   :copyable: false

   2016-12-16T17:54:53.638-0800  [#....................]  park.events  2179/34184    (6.4%)
   2016-12-16T17:54:53.638-0800  [#############........]  zoo.animals  29000/49778  (58.3%)

When tailing the oplog, ``mongomirror`` logs the lag time,
in seconds, between the most recent oplog entry on the source and the
last processed oplog entry on the target. For example:

.. code-block:: sh
   :copyable: false

   2016-12-12T16:22:17.027-0800 Current lag from source: 6s

A lag time of 6 seconds means that the last oplog entry
``mongomirror`` processed was 6 seconds behind the most
recent one available on the source.

.. note::

   The amount of time it takes ``mongomirror`` to catch up
   completely may be greater or lesser than 6 seconds, depending on
   how many entries arrive per second.

A lag time of 0 seconds indicates that ``mongomirror`` is
processing entries that arrived less than one second before the latest
oplog entry.

If there are indexes on the source cluster, ``mongomirror`` builds the
same indexes on the target cluster. The progress log shows the start
time and end time of the index building process, but does not display
the iterative progress of the process. To check on the progress
of the index builds, you can either:

- Use the
  :manual:`currentOp </reference/method/db.currentOp/#db.currentOp>`
  command on the primary node of the target cluster. The ``command``
  field shows information about the currently running operation.
  Index building entries look similar to the following:

  .. code-block:: json
     :copyable: false

	 "command" : {
		"createIndexes" : "perfs",
		"indexes" : [
			{
				"key" : {
					"workTitle" : "text"
				},
				"name" : "workTitle_text"
			}
		]...

- Download the :ref:`mongodb logs <mongodb-logs>` for your target
  cluster and check recent entries for index-related lines. Log
  messages related to index building look similar to the following:

  .. code-block:: sh
     :copyable: false

     2018-11-29T16:58:25.018-0800 I INDEX    [conn1] build index on: example.airlines properties: { v: 2, key: { airline: 1.0 }, name: "airline_1", ns: "example.airlines" }

Performance
~~~~~~~~~~~

To avoid contention for network and CPU resources, do not run
``mongomirror`` on the same hosts that provide your replica
set’s mongod instances.

- ``mongomirror`` must have network access to the source
  replica set.

- ``mongomirror`` must have network access to the target
  cluster.

- ``mongomirror`` has approximately the same performance
  impact on your source replica set as a secondary:

  - For the initial sync stage, the load scales with the size of your
    data set.

  - Once an initial sync completes, the load scales with oplog
    gigabytes used per hour.

Considerations
--------------

Source MongoDB Deployment
~~~~~~~~~~~~~~~~~~~~~~~~~

- The source MongoDB deployment must be a replica set. If the source is
  a standalone MongoDB deployment, convert to a replica set first to
  use ``mongomirror``.
  See :manual:`Convert a Standalone to a Replica Set </tutorial/convert-standalone-to-replica-set/>`.

- The source replica set must run MongoDB version 2.6 through 4.4.

- The source MongoDB replica set cannot be an
  ``M0`` (Free Tier) or ``M2/M5`` shared cluster.

- You should not change the ``featureCompatibilityVersion`` flag while
  ``mongomirror`` is running.

- You should not make any namespace changes during the migration
  process, such as using the
  :dbcommand:`renameCollection <dbcmd.renameCollection>` command
  or executing an aggregation pipeline that includes the
  :pipeline:`$out <pipe.out>` aggregation stage.

  Contact MongoDB Support if you believe renaming or dropping
  a collection needs to occur during the migration process. From
  the |service| UI, click :guilabel:`Support` to open a
  support ticket.

Target |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~

- The target |service| cluster must be a replica set, but cannot be an
  ``M0`` (Free Tier) or ``M2/M5`` shared cluster.

- The target |service| cluster MongoDB version must be the same as
  or later than the source cluster MongoDB version.

- For the initial sync stage of ``mongomirror``, the target
  |service| cluster should be empty or you should run
  ``mongomirror`` with the :option:`--drop` option.

- The target |service| cluster must include in its whitelist either

  - The public IP address of the server on which
    ``mongomirror`` is running, or

  - If set up for VPC peering, either the peer’s VPC CIDR block (or a
    subset) or the peer VPC’s Security Group.

- ``mongomirror`` automatically connects to MongoDB
  |service| over |tls-ssl|.

- You should not change the ``featureCompatibilityVersion`` flag while
  ``mongomirror`` is running.

- .. include:: /includes/fact-mongomirror-ttl-indexes.rst

.. _source-rs-authorization:

Required Access on Source Replica Set
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the source replica set requires authentication, you must include
user credentials when running :binary:`~bin.mongomirror`. You must
specify a database user with, at a minimum, the following privileges:

- Read all databases and collections. The :authrole:`readAnyDatabase`
  role on the ``admin`` database covers this requirement.

- Read the oplog.

- Run the :dbcommand:`getParameter` command.

If no such user exists, create the user in your source MongoDB
replica set. Different MongoDB server versions have different
built-in roles. Select a built-in role based on your MongoDB
server version and execute the appropriate commands in the
:binary:`~bin.mongo` shell:

.. include:: /includes/mongomirror-required-roles.rst

.. _destination-authorization:

Required Access on Destination Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must specify an database user with the
:authrole:`Atlas admin` role to run :binary:`~bin.mongomirror`.
See :ref:`add-mongodb-users` for documentation on creating a 
database user.

.. _mongomirror-options:

Options
-------

.. include:: /includes/options/option-mongomirror-host.rst
.. include:: /includes/options/option-mongomirror-username.rst
.. include:: /includes/options/option-mongomirror-password.rst
.. include:: /includes/options/option-mongomirror-authenticationDatabase.rst
.. include:: /includes/options/option-mongomirror-authenticationMechanism.rst
.. include:: /includes/options/option-mongomirror-awsSessionToken.rst
.. include:: /includes/options/option-mongomirror-compressors.rst
.. include:: /includes/options/option-mongomirror-destination.rst
.. include:: /includes/options/option-mongomirror-destinationUsername.rst
.. include:: /includes/options/option-mongomirror-destinationPassword.rst
.. include:: /includes/options/option-mongomirror-drop.rst
.. include:: /includes/options/option-mongomirror-noIndexRestore.rst
.. include:: /includes/options/option-mongomirror-includeNamespace.rst
.. include:: /includes/options/option-mongomirror-includeDB.rst
.. include:: /includes/options/option-mongomirror-ssl.rst
.. include:: /includes/options/option-mongomirror-sslPEMKeyFile.rst
.. include:: /includes/options/option-mongomirror-sslPEMKeyPassword.rst
.. include:: /includes/options/option-mongomirror-sslCAFile.rst
.. include:: /includes/options/option-mongomirror-sslCRLFile.rst
.. include:: /includes/options/option-mongomirror-sslAllowInvalidHostnames.rst
.. include:: /includes/options/option-mongomirror-sslAllowInvalidCertificates.rst
.. include:: /includes/options/option-mongomirror-gssapiServiceName.rst
.. include:: /includes/options/option-mongomirror-gssapiHostName.rst
.. include:: /includes/options/option-mongomirror-readPreference.rst
.. include:: /includes/options/option-mongomirror-writeConcern.rst
.. include:: /includes/options/option-mongomirror-numParallelCollections.rst
.. include:: /includes/options/option-mongomirror-bypassDocumentValidation.rst
.. include:: /includes/options/option-mongomirror-bookmarkFile.rst
.. include:: /includes/options/option-mongomirror-forceDump.rst
.. include:: /includes/options/option-mongomirror-oplogPath.rst
.. include:: /includes/options/option-mongomirror-oplogBatchSize.rst
.. include:: /includes/options/option-mongomirror-httpStatusPort.rst
.. include:: /includes/options/option-mongomirror-collStatsThreshold.rst

Examples
--------

Migrate a Replica Set into Atlas
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example migrates from a source replica set that does not
require authentication:

.. code-block:: sh

   mongomirror --host  sourceRS/source-host1:27017,source-host2:27017 \
            --destination myAtlasRS/atlas-host1:27017,atlas-host2:27017 \
            --destinationUsername myAtlasUser \
            --destinationPassword myAtlasPwd

To migrate from a source replica set that does not require
authentication, run ``mongomirror`` with the following
options:

- :mongomirror:option:`--host` <sourceReplSet/seed list of members>
- :mongomirror:option:`--destination` <Atlas Cluster>
- :mongomirror:option:`--destinationUsername` <atlasUser>
- :mongomirror:option:`--destinationPassword` <atlasPassword>

For the destination, specify the replica set name followed by a seed
list of members in the following format:

.. code-block:: shell

   <replicaSetName>/<host1>:<port1>,<host2>:<port2>,<host3>:<port3>,...

The specified Atlas user must have the required privileges for
Atlas. The ``Atlas admin`` role provides the required privileges.

Source Replica Set Uses SCRAM-SHA1 Authentication
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example migrates from a source replica set that uses
SCRAM-SHA1 authentication:

.. code-block:: sh

   mongomirror --host sourceRS/source-host1:27017,source-host2:27017,source-host3:27017 \
      --username mySourceUser \
      --password mySourcePassword \
      --authenticationDatabase admin \
      --destination myAtlasRS/atlas-host1:27017,atlas-host2:27017 \
      --destinationUsername myAtlasUser \
      --destinationPassword atlasPassw0Rd

To migrate from a source replica set that does uses SCRAM-SHA1
authentication, run ``mongomirror`` with the following
options:

- :mongomirror:option:`--host` <sourceReplSet/seed list of members>
- :mongomirror:option:`--username` <sourceUser>
- :mongomirror:option:`--password` <sourcePassword>
- :mongomirror:option:`--authenticationDatabase` <sourceDatabase>
- :mongomirror:option:`--destination` <Atlas Cluster>
- :mongomirror:option:`--destinationUsername` <atlasUser>
- :mongomirror:option:`--destinationPassword` <atlasPassword>

The source replica set user must have the required access on source
cluster. The ``backup`` role provides the appropriate privileges.

For the destination, specify the replica set name followed by a seed
list of members in the following format:

.. code-block:: shell

   <replicaSetName>/<replicaMember>,<replicaMember>,<replicaMember>,...

The specified Atlas user must have the required access on Atlas. The
``Atlas admin`` role provides the required privileges.

Save ``mongomirror`` Output to a File
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

It is often helpful to save the output logs from a ``mongomirror``
procedure to a file for later examination and debugging. Use the following
format to save output to a file called ``mongomirror.log``:

.. code-block:: shell

   mongomirror <args> 2>&1 | tee -a mongomirror.log

Source Replica Set Requires X509 Client Authentication
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example migrates from a source replica set that uses
X.509 authentication:

.. code-block:: sh

   mongomirror --host sourceRS/source-host1:27017,source-host2:27017,source-host3:27017 \
      --username "CN=myName,OU=myOrgUnit,O=myOrg,L=myLocality,ST=myState,C=myCountry" \
      --authenticationDatabase '$external' \
      --authenticationMechanism MONGODB-X509 \
      --ssl \
      --sslPEMKeyFile <path-to-my-client-certificate.pem> \
      --sslCAFile <path-to-my-certificate-authority-certificate.pem> \
      --destination myAtlasRS/atlas-host1:27017,atlas-host2:27017 \
      --destinationUsername myAtlasUser \
      --destinationPassword atlasPassw0Rd

To migrate from a source replica set that uses X.509 authentication,
run ``mongomirror`` with the following options:

- :mongomirror:option:`--host` <sourceReplSet/seed list of members>
- :mongomirror:option:`--username` <subject from the client certificate>
- :mongomirror:option:`--authenticationMechanism` ``MONGODB-X509``
- :mongomirror:option:`--authenticationDatabase` ``'$external'``
- :mongomirror:option:`--ssl`
- :mongomirror:option:`--sslPEMKeyFile` <path-to-my-client-certificate.pem>
- :mongomirror:option:`--sslCAFile` <path to root CA PEM file>
- :mongomirror:option:`--destination` <Atlas Cluster>
- :mongomirror:option:`--destinationUsername` <atlasUser>
- :mongomirror:option:`--destinationPassword` <atlasPassword>

The source replica set user must have the required access on source
cluster. The ``backup`` role provides the appropriate privileges.

For the destination, specify the replica set name followed by a seed
list of members in the following format:

.. code-block:: shell

   <replicaSetName>/<replicaMember>,<replicaMember>,<replicaMember>,...

The specified Atlas user must have the required access on Atlas. The
``Atlas admin`` role provides the required privileges.

Source Replica Set Requires Kerberos/GSSAPI Authentication
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example migrates from a source replica set that uses
Kerberos authentication:

.. code-block:: sh

   mongomirror --host sourceRS/source-host1:27017,source-host2:27017,source-host3:27017 \
      --username sourceUser/administrator@MYREALM.COM \
      --authenticationDatabase '$external' \
      --authenticationMechanism GSSAPI \
      --destination myAtlasRS/atlas-host1:27017,atlas-host2:27017,atlas-host3:27017 \
      --destinationUsername atlasUser \
      --destinationPassword atlasPass

To migrate from a source replica set that uses X.509 authentication,
run ``mongomirror`` with the following options:

- :mongomirror:option:`--host` <sourceReplSet/seed list of members>
- :mongomirror:option:`--username` <Kerberos user principal>
- :mongomirror:option:`--authenticationDatabase` ``'$external'``
- :mongomirror:option:`--authenticationMechanism` ``GSSAPI``
- :mongomirror:option:`--destination` <Atlas Cluster>
- :mongomirror:option:`--destinationUsername` <atlasUser>
- :mongomirror:option:`--destinationPassword` <atlasPassword>

The source replica set user must have the required access on source
cluster. The ``backup`` role provides the appropriate privileges.

For the destination, specify the replica set name followed by a seed
list of members in the following format:

.. code-block:: shell

   <replicaSetName>/<replicaMember>,<replicaMember>,<replicaMember>,...

The specified Atlas user must have the required access on Atlas. The
``Atlas admin`` role provides the required privileges.
