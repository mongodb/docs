.. _remove-shards-from-cluster-tutorial:

====================================
Remove Shards from a Sharded Cluster
====================================

.. meta::
   :description: Safely migrate data and remove a shard from a sharded cluster by following a detailed procedure to ensure data is redistributed and the shard is properly drained.

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

To remove a :term:`shard` you must ensure the shard's data is migrated
to the remaining shards in the cluster. This procedure describes how to
safely migrate data and remove a shard.

About this Task
---------------

- Creating, sharding, or moving collections while performing this
  procedure may cause interruptions and lead to unexpected results.

- Do not use this procedure to migrate an entire cluster to new
  hardware. To migrate, see
  :ref:`migrate-cluster-to-different-hardware`.

- .. include:: /includes/fact-remove-shard-balance-order.rst

- .. include:: /includes/extracts/changestream-remove-shard-with-link.rst

- You can safely restart a cluster during a shard removal process. If
  you restart a cluster during an ongoing :term:`draining` process,
  draining continues automatically after the cluster components restart.
  MongoDB records the shard draining status in the :data:`config.shards`
  collection.

Before you Begin
----------------

1. This procedure uses the :method:`sh.moveCollection()` method to move
   collections off of the removed shard. Before you begin this
   procedure, review the ``moveCollection`` :ref:`considerations
   <moveCollection-method-considerations>` and :ref:`requirements
   <moveCollection-method-reqs>` to understand the command behavior.

#. To remove a shard, first connect to one of the cluster's
   :binary:`~bin.mongos` instances using :binary:`~bin.mongosh`.

.. note::
   
   When removing multiple shards, remove them simultaneously rather
   than one at a time. Removing one shard at a time causes the balancer
   to drain data into other remaining shards. A shard can only participate
   in one chunk migration at a time, so removing one shard limits the
   throughput of data migration.

Steps
-----

.. procedure::
   :style: normal

   .. step:: Ensure the balancer is enabled.

      To migrate data from a shard, the :term:`balancer` process must
      be enabled. To check the balancer state, use the
      :method:`sh.getBalancerState()` method:
      
      .. code-block:: javascript
         
         sh.getBalancerState()

      If the operation returns ``true``, the balancer is enabled.

      If the operation returns ``false``, see
      :ref:`sharding-balancing-enable`.

   .. step:: Determine the name of the shard to remove.
      
      To find the name of the shard, run the :dbcommand:`listShards` command:

      .. code-block:: javascript

         db.adminCommand( { listShards: 1 } )

      The ``shards._id`` field contains the shard name.

   .. step:: Start draining the shard.

      Run the :dbcommand:`startShardDraining` command to start
      moving chunks from the sharded collections to the other shards
      in the cluster:

      .. code-block:: javascript

         db.adminCommand( { startShardDraining: "shard04" } )

      If you need to remove multiple shards, you can start the
      draining processes to run in parallel.

   .. step:: Move collections.

      When you create a collection on :program:`mongos` and
      don't call :dbcommand:`shardCollection`, that collection
      remains unsharded and MongoDB stores it in full on a
      particular shard in the cluster. Databases that use the
      shard as a primary, also store their collections on the
      shard.

      If the shard you want to remove contains an unsharded
      collection or a primary database, you need to move the
      collection to another shard.

      To identify whether the shard you want to remove contains
      these collection and to see the draining status, run the
      :dbcommand:`shardDrainingStatus` command and check the
      array for the ``collectionsToMove`` output field:

      .. io-code-block::

         .. input::
            :language: javascript

            db.adminCommand( { shardDrainingStatus: "shard04" } )

         .. output::
            :language: javascript

            {
               msg: "draining ongoing",
               state: "ongoing",
               remaining: {
                  chunks: Long(2),
                  dbs: Long(2),
                  jumboChunks: Long(0),
                  collectionsToMove: Long(2)
               },
               shard: "shard04",
               note: "you need to call moveCollection for collectionsToMove and afterwards movePrimary for the dbsToMove",
               dbsToMove: [
                  "accounts",
               ],
               collectionsToMove: [
                  "accounts.us-east",
                  "accounts.us-west",
                  "locations.us",
               ],
               ok: 1,
               operationTime: Timestamp(1575399086, 1655),
               $clusterTime: {
                  clusterTime: Timestamp(1575399086, 1655),
                  signature: {
                     hash: BinData(0,"XBrTmjMMe82fUtVLRm13GBVtRE8="),
                     keyId: Long("6766255701040824328")
                  }
               }
            }

      Any collection found in the ``collectionsToMove`` field is
      a collection stored on this shard. Before you can remove
      the shard, you must first move these collections to
      another shard.

      To move a collection to another shard, use the
      :dbcommand:`moveCollection` command:

      .. code-block:: javascript

         db.adminCommand( { 
            moveCollection: "accounts.us-east",
            toShard: "shard05"
         } )

   .. step:: Move primaries.

      Sharded clusters designate a specific shard to serve as
      the primary shard for a database. If the shard you want to
      remove is a primary, you need to move it to a different
      shard.

      To identify primaries, run the
      :dbcommand:`shardDrainingStatus` command and check the
      array on the ``dbsToMove`` output field.

      .. io-code-block::

         .. input::
            :language: javascript

            db.adminCommand( { shardDrainingStatus: "shard04" } )

         .. output::
            :language: javascript

            {
               msg: "draining ongoing",
               state: "ongoing",
               remaining: {
                  chunks: Long(2),
                  dbs: Long(2),
                  jumboChunks: Long(0),
                  collectionsToMove: Long(2)
               },
               shard: "shard04",
               note: "you need to call moveCollection for collectionsToMove and afterwards movePrimary for the dbsToMove",
               dbsToMove: [
                  "accounts",
               ],
               collectionsToMove: [ ],
               ok: 1,
               operationTime: Timestamp(1575399086, 1655),
               $clusterTime: {
                  clusterTime: Timestamp(1575399086, 1655),
                  signature: {
                     hash: BinData(0,"XBrTmjMMe82fUtVLRm13GBVtRE8="),
                     keyId: Long("6766255701040824328")
                  }
               }
            }

      Each database shown in the ``dbsToMove`` field is a
      database you need to move onto a different shard.

      To move the database, use the :dbcommand:`movePrimary`
      command:

      .. code-block:: javascript

         db.adminCommand( { 
            movePrimary: "accounts",
            to: "shard05"
         })

   .. step:: Remove the shard.

      Before you remove the shard, check that the draining
      operation is complete.

      To check the status of the draining operation, run the
      :dbcommand:`shardDrainingStatus` command: 

      .. io-code-block:: 
      
         .. input::
            :language: javascript
      
            db.adminCommand( { shardDrainingStatus: "shard04" } )
      
         .. output::
            :language: javascript

            {
               "msg" : "draining completed successfully",
               "state" : "drainingComplete",
               "ok" : 1,
               "$clusterTime" : {
                  "clusterTime" : Timestamp(1771839836, 139),
                  "signature" : {
                     "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),
                     "keyId" : NumberLong(0)
                  }
               },
               "operationTime" : Timestamp(1771839836, 139)
            }

      When the ``state`` field returns ``drainingComplete`` for
      the shard you want to remove, the draining process is
      complete. You can now remove the shard.

      To remove the shard, run the
      :dbcommand:`commitShardRemoval` command:

      .. io-code-block:: 

         .. input::
            :language: javascript

            db.adminCommand( { commitShardRemoval: "shard04" } )

         .. output::
            :language: javascript

            {
               "ok" : 1,
               "$clusterTime" : {
                  "clusterTime" : Timestamp(1771840037, 12),
                  "signature" : {
                     "hash" : BinData(0,"AAAAAAAAAAAAAAAAAAAAAAAAAAA="),
                     "keyId" : NumberLong(0)
                  }
               },
               "operationTime" : Timestamp(1771840037, 12)
            }

      If the shard is not completely drained, the command
      returns an error.

Learn More
----------

- :ref:`sharding-procedure-add-member-to-shard`

- :ref:`back-up-sharded-cluster-metadata`

- :ref:`sharding-data-partitioning`
