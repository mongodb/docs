.. _vpc-peering:

=============================
Set up VPC Peering Connection
=============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

|service| supports `VPC <https://en.wikipedia.org/wiki/Virtual_private_cloud>`_
peering connections for |aws| and |gcp|-backed clusters.
|service| does not support VPC Peering for clusters deployed on
:ref:`microsoft-azure`. For |service| clusters deployed on
:abbr:`Azure (Microsoft Azure)`, add the IP addresses of your
:abbr:`Azure (Microsoft Azure)` services to |service| :doc:`project IP
whitelist </security-whitelist>` to grant those services access to the cluster.

.. important::

   To set up a VPC peering connection, you must be the project owner.

Configure the |service| VPC CIDR
--------------------------------

You can configure the |service| CIDR for a VPC peering connection if you
have not yet added any clusters  or VPC peering connections to a project. 
If you are unable to configure the |service| CIDR, create a new |service| project
or select the tab corresponding to your cluster's cloud provider.

.. tabs::

     tabs:

     - id: aws
       name: AWS
       content: |

          Remove all MongoDB clusters deployed in the same AWS region as your
          peering connection to enable configuration of the |service| CIDR.

     - id: gcp
       name: GCP
       content: |

           Remove all GCP-backed MongoDB clusters from the |service| project to enable
           configuration of the |service| CIDR.


     - id: azure
       name: Azure
       content: |

           Remove all Azure-backed MongoDB clusters from the |service| project to
           enable configuration of the |service| CIDR.

To configure the |service| VPC CIDR:

.. include:: /includes/steps/configure-atlas-vpc-cidr.rst

Configure a VPC Peering Connection
----------------------------------

To configure VPC Peering for a cluster, select the tab corresponding to
your cluster's cloud provider.

.. tabs-cloud-providers::
     
     tabs:

     - id: aws
       name: AWS
       content: |

         1. From the :guilabel:`Clusters` view, select the :guilabel:`Security`
            tab, then click :guilabel:`Peering`, then :guilabel:`New Peering
            Connection`.

         #. Enable DNS hostnames and DNS resolution in AWS.

            Enabling :guilabel:`DNS hostnames` and :guilabel:`DNS
            resolution` can result in faster :ref:`VPC <security-vpc>` peering.

            .. tip ::

               AWS VPC resolves hostnames in an |service| cluster to their 
               private IP addresses when you enable :guilabel:`DNS resolution`.
               You can use these DNS entries to connect to hosts in your
               |service| cluster from the peered VPC since AWS handles
               resolving the peered hostnames automatically.

            a. Log in to your :abbr:`AWS (Amazon Web Services)` account.
            
            #. Go to the `VPC dashboard <https://console.aws.amazon.com/vpc>`_.
            
            #. Open your list of VPC resources.
            
            #. Select the VPC you want to peer with.
            
            #. Enable :guilabel:`DNS hostnames` and :guilabel:`DNS
               resolution`. See `Updating DNS Support for Your VPC
               <http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-dns.html#vpc-dns-updating>`_ 
               for further documentation on how to enable these options.

         #.  Go to VPC Peering view.

             From the :guilabel:`Clusters` view, select the :guilabel:`Security`
             tab, then :guilabel:`Peering`.

         #. Click :guilabel:`New Peering Connection`.

         #. Enter the required information in the Peering Connection Dialog.

            To create the VPC Peering connection, fill in the requested
            information:
               
            .. list-table::
               :header-rows: 1
               :widths: 35 65
               
               * - Field
                 - Notes

               * - :guilabel:`Account ID`

                 - AWS Account ID of the owner of the peer VPC. Refer to the
                   dialog for instructions on finding your :guilabel:`AWS
                   Account ID`.

               * - :guilabel:`VPC ID`

                 - The ID of the peer VPC. Refer to the dialog
                   for instructions on finding your :guilabel:`VPC ID`.

               * - :guilabel:`VPC CIDR`

                 - The peer VPC CIDR block or subset. Must not overlap with your
                   :guilabel:`Atlas CIDR Block` or any other peering connection
                   :guilabel:`VPC CIDR`.

                   The CIDR block must be in one of the following 
                   `private networks <https://tools.ietf.org/html/rfc1918#section-3>`_:

                   - ``10.0.0.0`` - ``10.255.255.255``  (10/8 prefix)

                   - ``172.16.0.0`` - ``172.31.255.255``  (172.16/12 prefix)

                   - ``192.168.0.0`` - ``192.168.255.255`` (192.168/16 prefix)

                   You can choose to add the VPC CIDR block address (or a
                   subset) to the whitelist. For VPC peering connections, you
                   can also add the Security Group associated with the peer VPC
                   instead of the CIDR block. See :ref:`add-to-whitelist`.

                   See `RFC 4632 <https://tools.ietf.org/html/rfc4632>`_ for more
                   information about CIDR blocks.

               * - :guilabel:`Application VPC Region`

                 - AWS region where the peer VPC resides.

               * - :guilabel:`VPC CIDR Block`

                 - The |service| VPC CIDR block. Must not overlap with the peer
                   :guilabel:`VPC CIDR` block.
                   
                   .. include:: /includes/fact-vpc-cidr-block.rst

               * - :guilabel:`Atlas VPC Region`

                 - AWS region where the |service| VPC resides. |service|
                   creates a VPC for the |service| project in this region if no
                   ``M10+`` clusters or VPC peering connections exist for the
                   selected :guilabel:`Region`.

                   Uncheck :guilabel:`Same as application VPC region` to select
                   a different region than where the application VPC resides.

         #. Click :guilabel:`Initiate Peering`.

         #. Wait for approval of peering connection request

            The owner of the peer VPC must approve the VPC peering connection
            request. Ensure that the owner approves the request.

            |service| provides instructions for approving the connection request.

            .. important:: Requests expire after 7 days.

         #. Add to route table

            a. In the :guilabel:`VPC Dashboard`, click :guilabel:`Route Tables`.

            #. Select the Route Table for your VPC.

            #. Click the :guilabel:`Routes` tab.

            #. Click :guilabel:`Edit Routes`.

            #. Click :guilabel:`Add route`.

            #. Add the |service| VPC's CIDR block to the :guilabel:`Destination`
               column.

            #. Add the AWS Peering Connection ID to the :guilabel:`Target`
               column.

               This value is prefixed with ``pcx-``.

            #. Click :guilabel:`Save`.

               Once set up, you can edit or terminate VPC peering connection from the
               :guilabel:`Peering` table.

               You must add your VPC CIDR block address (or subset) or the
               Security Group associated with the peer VPC to the :ref:`whitelist
               <whitelist>` before your new VPC peer can connect to your |service|
               cluster.

               .. seealso::

                  `CIDR Subnet Selection for MongoDB Atlas <https://www.mongodb.com/blog/post/cidr-subnet-selection-for-mongodb-atlas>`_

     - id: gcp
       name: GCP
       content: |
         
         .. include:: /includes/fact-gcp-vpc-limitations.rst

         .. include:: /includes/fact-gcp-azure-vpc-prereqs.rst

         .. include:: /includes/gcp-vpc-procedure.rst

         .. note::

            Each |service| project may have a maximum of 25 peering
            connections.

         You must add your VPC CIDR block address (or subset) associated
         with the peer VPC to the :ref:`whitelist <whitelist>` before your
         new VPC peer can connect to your |service| cluster. See 
         `Auto mode IP ranges <https://cloud.google.com/vpc/docs/vpc#ip-ranges>`_
         for Auto mode IP ranges used by GCP.

     - id: azure
       name: Azure
       content: |

         .. include:: /includes/fact-gcp-vpc-limitations.rst

         .. include:: /includes/fact-gcp-azure-vpc-prereqs.rst
         
         .. include:: /includes/azure-vpc-procedure.rst
