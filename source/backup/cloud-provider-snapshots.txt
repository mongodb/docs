.. _backup-cloud-provider:

========================
Cloud Provider Snapshots
========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

|service| Cloud Provider Snapshots provide 
localized backup storage using the native snapshot functionality of the 
cluster's cloud service provider.

|service| only supports cloud provider snapshots for 
:ref:`Microsoft Azure <microsoft-azure>` or 
:ref:`Amazon Web Services (AWS) <amazon-aws>` backed replica sets. 

A project using the |service| Cloud Provider Snapshots
*cannot* create backups of sharded clusters *or* any cluster hosted
on :ref:`Google Cloud Provider (GCP) <google-gcp>`.


You can enable cloud provider snapshots during the 
:doc:`cluster creation </create-new-cluster>` or during the 
:doc:`modification of an existing cluster </scale-cluster>`. 
From the cluster configuration modal, toggle 
``Do you want to enable backup?`` to ``Yes`` and select the
:guilabel:`Cloud Provider Snapshots` card.

.. include:: /includes/extracts/backup-selection-cloud-provider.rst

Single Region Cluster Backups
-----------------------------

.. tabs::

     tabs:
  
     - id: azure
       name: Azure
       content: |
  
         |service| always selects the :term:`primary` member of the
         replica set for backup snapshots. |service| stores the 
         snapshots in the same cloud region as the cluster. |service| 
         retains snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-single-region-primary.rst

         If that member steps down
         to a :term:`secondary`, |service| changes the snapshot
         target to the current :term:`primary`.

         .. include:: /images/cloud-provider-snapshot-single-region-moved-primary.rst
  
     - id: aws
       name: AWS
       content: |
  
         |service| selects the :term:`primary` member of the replica 
         set *at the time you enable backups for the cluster* for backup 
         snapshots. |service| stores the snapshots in the same
         cloud region as the cluster. |service| retains snapshots based 
         on the :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-single-region-primary.rst

         |service| continues to use that member and its 
         corresponding region for snapshots and snapshot storage, even 
         if that member is no longer the primary.

         .. include:: /images/cloud-provider-snapshot-single-region-secondary.rst

         |service| automatically creates a new snapshot storage volume 
         if the existing snapshot storage volume becomes invalid. 
         |service| creates the new volume in the same region as the 
         cluster's current primary. |service| then takes a full-copy 
         snapshot to maintain backup availability and continues using 
         that member and its corresponding region for further 
         incremental snapshots.

         Events that can trigger storage invalidation include:

         - Changing the |service| cluster instance size,
         - Modifying the |service| cluster's storage volume or speed,
         - Changing the |service| cluster's :abbr:`AWS (Amazon Web Services)` region, and
         - Maintenance performed by |service| or :abbr:`AWS (Amazon Web Services)`.
  
         To manually reset the snapshot target and storage, disable and 
         re-enable backups for the cluster. Disabling |service| backups 
         removes all snapshots for the cluster. 
         For more information on snapshot retention, see
         :ref:`cloud-provider-retention-policy`.

Multi-Region Cluster Backups
----------------------------

.. tabs::

     tabs:
  
     - id: azure
       name: Azure
       content: |
  
         |service| always selects the :term:`primary` member of the
         replica set for backup snapshots. |service| stores snapshots
         in the same region as the primary member. |service| retains 
         snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-multi-region-primary.rst

         If that member steps down
         to a :term:`secondary`, |service| changes the snapshot
         target to the current :term:`primary`.

         .. include:: /images/cloud-provider-snapshot-multi-region-moved-primary.rst

         |service| stores subsequent snapshots in the region of the
         new primary member.
  
     - id: aws
       name: AWS
       content: |
  
         |service| selects the :term:`primary` member of the replica 
         set *at the time you enable backups for the cluster* for backup 
         snapshots. |service| stores snapshots in the same region as
         the primary member. |service| retains snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-multi-region-primary.rst

         If the member steps down to a :term:`secondary`, |service|
         continues to use that member for snapshots. |service|
         continues storing snapshots in the same region as that member,
         even if the primary is in a different region.

         .. include:: /images/cloud-provider-snapshot-multi-region-secondary.rst

         |service| automatically creates a new snapshot storage volume 
         if the existing snapshot storage volume becomes invalid. 
         |service| creates the new volume in the same region as the 
         cluster's current primary. |service| then takes a full-copy 
         snapshot to maintain backup availability and continues using 
         that member and its corresponding region for further 
         incremental snapshots.

         Events that can trigger storage invalidation include:

         - Changing the |service| cluster instance size,
         - Modifying the |service| cluster's storage volume or speed,
         - Changing the |service| cluster's :abbr:`AWS (Amazon Web Services)` region, and
         - Maintenance performed by |service| or :abbr:`AWS (Amazon Web Services)`.
  
         To manually reset the snapshot target and storage, disable and 
         re-enable backups for the cluster. Disabling |service| backups 
         removes all snapshots for the cluster. 
         For more information on snapshot retention, see
         :ref:`cloud-provider-retention-policy`.

.. _cloud-provider-backup-schedule:

Backup Schedule
---------------

|service| takes the first snapshot when you enable cloud provider
snapshots for a cluster, and takes subsequent snapshots of the cluster 
every 24 hours from that point in time.

.. _cloud-provider-retention-policy:

Retention Policy
----------------

|service| retains the last 3 snapshots for each cluster. If you disable 
backup for a cluster or terminate a cluster, |service| immediately 
deletes the backup snapshots for the cluster.
