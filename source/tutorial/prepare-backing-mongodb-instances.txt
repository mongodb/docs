===================================
Deploy Backing MongoDB Replica Sets
===================================

.. default-domain:: mongodb

Overview
--------

|onprem| uses two dedicated :term:`replica sets <replica set>` to store operational
data: one replica set to store the :ref:`mms-application-database` and another
to store the :ref:`backup-database`. If you use multiple Backup Databases,
set up separate replica sets for each database.

.. include:: /includes/note-cannot-manage-backing-dbs.rst

The backing MongoDB replica sets are dedicated to operational data and
**must store no other data**.

.. _requirements-backing-db-replica-sets:

Replica Sets Requirements
-------------------------

The replica set that hosts the |application| Database and each replica set
that hosts a Backup Database must:

- Store data in support of |onprem| operations **only** and **store no other data**.

- Run on a server that meets the :ref:`server prerequisites
  <backing-instances-prerequisites>` below.

- Run MongoDB 3.0.6 or later if running MongoDB 3.0 or run MongoDB 2.6.6
  or later if running MongoDB 2.6. Do not use a MongoDB version earlier
  than 2.6.6.

- Use the storage engine appropriate to your workload. In most cases, this
  is MMAPv1. See :ref:`storage engine considerations
  <storage-engine-considerations-for-backing-dbs>` below.

- Set the MongoDB :setting:`security.javascriptEnabled` option to ``true``, which
  is the default. The |application| uses the :query:`$where` query and
  requires this setting be enabled on the |application| Database.

- Must **not** run the MongoDB ``notablescan`` option.

.. _backing-instances-prerequisites:

Server Prerequisites
--------------------

The servers that run the replica sets must meet the following requirements.

- The hardware requirements described in
  :ref:`mms-application-database-specifications` or
  :ref:`backup-database-specifications`, depending on which
  database the server will host. If a server hosts other |onprem|
  components in addition to the database, you must sum the hardware
  requirements for each component to determine the requirements for the
  server.

- The system requirements in the :manual:`MongoDB Production Notes
  </administration/production-notes>`. The Production Notes include
  important information on :manual:`ulimits </reference/ulimit>`,
  :manual:`NUMA </administration/production-notes#production-numa>`,
  :manual:`Transparent Huge Pages (THP)
  </reference/transparent-huge-pages>`, and other configuration options.

- The MongoDB ports requirements described in
  :doc:`/reference/firewall-configuration`. Each server's firewall rules
  must allow access to the required ports.

- **RHEL servers only**: if the ``/etc/security/limits.d`` directory
  contains the ``90-nproc.conf`` file, remove the file. The file overrides
  ``limits.conf``, decreasing ``ulimit`` settings. Issue the following
  command to remove the file:

  .. code-block:: sh

     sudo rm /etc/security/limits.d/90-nproc.conf

.. _storage-engine-considerations-for-backing-dbs:

Choosing a Storage Engine for the Backing Databases
---------------------------------------------------

MongoDB provides both the MMAPv1 and WiredTiger storage engines. The
|application| and Backup Database schemas have been designed to achieve
maximum performance on MMAPv1. Therefore, while WiredTiger outperforms
MMAPv1 on typical workloads, we recommend MMAPv1 for the unique |onprem|
workload.

The MMAPv1 engine also minimizes storage in the Backup Database's
blockstore, as all the blocks are already compressed and padding is
disabled. There is typically no further storage benefit to be gained by
taking advantage of WiredTiger compression.

In one case, WiredTiger might be preferable. Backups of insert-only
MongoDB workloads that benefit from high levels of block-level
de-duplication in the blockstore may see a compression-based storage
reduction when running the Backup Database on the WiredTiger storage
engine.

The storage engine used by the Backup Database is independent from the
storage engine chosen to store a deployment's snapshots. If the Backup
Database uses the MMAPv1 storage engine, it can store backup snapshots for
WiredTiger backup jobs in its blockstore.

Procedures
----------

Install MongoDB on Each Server
++++++++++++++++++++++++++++++

.. warning::

   Failure to configure servers according to the :manual:`MongoDB
   Production Notes </administration/production-notes>` can lead to
   production failure.

Use servers that meet the above :ref:`prerequisites
<backing-instances-prerequisites>`. 

The following procedure assumes that you
are installing MongoDB on a server running Red Hat Enterprise Linux (RHEL).
If you are installing MongoDB on another operating system,
or if you prefer to use ``cURL`` rather than ``yum``,
see the :manual:`Install MongoDB </installation>` section
in the MongoDB manual.

To install MongoDB on a server running RHEL:

.. include:: /includes/steps/install-mongodb-for-backing-dbs.rst

Deploy a Backing Replica Set
++++++++++++++++++++++++++++

This procedure deploys a three-member replica set dedicated to store
either the |application| Database or Backup Database. Deploy
the replica set to three servers that meet the :ref:`requirements
<backing-instances-prerequisites>` for the database.

Repeat this procedure for each backing replica set that your installation
requires. For additional information on deploying replica sets, see
:manual:`Deploy a Replica Set </tutorial/deploy-replica-set>` in the
MongoDB manual.

.. include:: /includes/steps/deploy-backing-replica-set.rst
