.. _cluster-autoscaling:
.. _scale-cluster-autoscale:

====================
Cluster Auto-Scaling
====================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. admonition:: Feature Availability
   :class: note

   This feature is available for ``M10+`` clusters using the
   :guilabel:`General` storage class.

You can configure your |service| cluster to automatically scale
its cluster tier, storage capacity, or both in response to
cluster usage. Cluster auto-scaling removes the need to write scripts
or use consulting services to analyze cluster usage to make
scaling decisions.

Auto-scaling works on a rolling basis, meaning the process does not
incur any downtime.

.. _how-auto-scale-works:

How Auto-Scaling Works
----------------------

The following sections describe how |service| automatically scales
your cluster tier and storage capacity, and the metrics considered
for each scaling procedure.

.. _howitworks-scale-cluster-tier:

Scaling Cluster Tier
~~~~~~~~~~~~~~~~~~~~

|service| analyzes the following cluster metrics to determine when to
scale a cluster, and whether to scale the cluster tier up or down:

- CPU Utilization 

- Memory Utilization

To learn more about how to monitor cluster metrics, see
:ref:`monitor-cluster-metrics`.

Before scaling your cluster tier, |service| checks that the cluster
would not be in a tier outside of your specified
:guilabel:`Minimum` and :guilabel:`Maximum Cluster Size` range.

Scaling Up a Cluster Tier
`````````````````````````

If the next highest cluster tier is within your
:guilabel:`Maximum Cluster Size` range, |service| scales the cluster
up to the next tier if *one* of the following is true for the current
cluster:

- Average CPU Utilization has exceeded 75% for the past hour, or

- Memory Utilization has exceeded 75% for the past hour.

Scaling Down a Cluster Tier
```````````````````````````

If the next lowest cluster tier is within your
:guilabel:`Minimum Cluster Size` range, |service| scales the cluster
down to the next lowest tier if *both* of the following are true:

- Based on data collected from the past 72 hours, the desired CPU
  Utilization and Memory Utilization on the *target*
  cluster tier will not exceed 50%, and

- The cluster has not been scaled down in the past 72 hours.

.. _howitworks-scale-cluster-storage:

Scaling Cluster Storage
~~~~~~~~~~~~~~~~~~~~~~~

When cluster storage auto-scaling is enabled, |service| automatically
increases cluster storage when disk usage reaches 90%. The scaling
behavior differs by cloud provider:

- On :ref:`AWS <amazon-aws>` and :ref:`GCP <google-gcp>` clusters,
  |service| increases cluster storage capacity to achieve
  70% disk utilization. For information on |aws| storage change 
  limitations and how |service| works around them, see 
  :ref:`change-storage-capacity-aws`.

- On :ref:`Azure <microsoft-azure>` clusters, |service| doubles the 
  current amount of cluster storage.

.. include:: /includes/autoscale-oplog.rst

Configure Auto-Scaling Options
------------------------------

You can configure auto-scaling options when you
:ref:`create <create-new-cluster>` or :ref:`modify <scale-cluster>` a
cluster.

|service| displays auto-scaling options in the :guilabel:`Auto-scale`
section of the cluster builder:

.. figure:: /images/autoscale.png
   :figwidth: 720px
   :alt: Image showing the auto-scaling cluster options.

Auto-Scale Cluster Tier
~~~~~~~~~~~~~~~~~~~~~~~

In the :guilabel:`Cluster tier` section of the :guilabel:`Auto-scale`
options, you can specify the minimum and maximum sizes
to which your cluster can automatically scale.

Auto-scaling is disabled by default. To enable auto-scaling:

1. In the :guilabel:`Auto-Scale` section, check
   :guilabel:`Cluster tier`.

#. Select a :guilabel:`Maximum Cluster Size` from the dropdown.

When you enable auto-scaling, by default your cluster can only
automatically scale up to a higher cluster tier. To enable auto-scaling
to a lower cluster tier:

1. Check :guilabel:`Allow cluster to be scaled down`.

#. Select a :guilabel:`Minimum Cluster Size` from the dropdown.

.. admonition:: Considerations
   :class: important

   - Automatically scaling down to a lower cluster tier may leave your
     cluster unable to handle your workload. Only allow the cluster to
     be scaled down if you have a clear understanding of your cluster's
     workload. Ensure that you account for any possible spikes or dips
     in cluster activity.

   - You cannot scale to a cluster smaller than ``M10``.

Auto-Scale Cluster Storage
~~~~~~~~~~~~~~~~~~~~~~~~~~

Cluster storage scaling is enabled by default. To opt out of
cluster storage scaling, un-check the :guilabel:`Storage` checkbox in
the :guilabel:`Auto-scale` section.

For more information on cluster storage, see
:ref:`create-cluster-storage`.

Acknowledge Auto-Scaling Events
-------------------------------

When an auto-scaling event occurs:

- |service| logs the event in the project
  :guilabel:`Activity Feed`. For more information on the
  :guilabel:`Activity Feed`, see :ref:`project-activity-feed`.

- |service| sends an email to all cluster members with
  information on the event. The email includes the original cluster
  tier and the new cluster tier after auto-scaling has occurred.
