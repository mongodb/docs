=======================================
Configure the Backup Agent for Kerberos
=======================================

.. admonition:: Enterprise Feature

   Only MongoDB Enterprise provides support for Kerberos.

Kerberos is a generic authentication protocol available starting from
MongoDB Enterprise version 2.6. The Monitoring Agents can authenticate
to hosts using Kerberos.

Prerequisites
-------------

You must configure the Kerberos Key Distribution Center (KDC) to grant
tickets that are valid for at least four hours. The Backup Agent takes
care of periodically renewing the ticket. The KDC service provides session
tickets and temporary session keys to users and computers.

.. include:: /includes/fact-auth-backup-requirements.rst

Create Kerberos Principal
-------------------------

.. include:: /includes/note-kerberos-principal-for-agents.rst

.. include:: /includes/steps/kerberos-create-principal.rst

Create MongoDB User for the Principal
-------------------------------------

.. include:: /includes/note-kerberos-principal-for-agents.rst

Kerberos Principal for the Backup Agent
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-kerberos-principal-as-user.rst

MongoDB 2.6.4 or Later
``````````````````````

For MongoDB 2.6.4 or later, to add the principal for just the Backup
Agent, use an operation that resembles the following:

.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<Kerberos Principal>",
        roles: [
           { role: "backup", db: "admin" }
        ]
      }
   )

See :ref:`access-control-backup-2.6.4` for more information on
the required access for the Backup Agent.

2.6.0 through 2.6.3
```````````````````

For MongoDB 2.6.0 through 2.6.3, to add the principal for just the
Backup Agent, use an operation that resembles the following:

.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<Kerberos Principal>",
        roles: [ 
           "clusterAdmin",
           "readAnyDatabase",
           "userAdminAnyDatabase",
           { role: "readWrite", db: "admin" },
           { role: "readWrite", db: "local" },
        ]
      }
   )

See :ref:`access-control-backup-2.6.3` for more information on
the required access for the Backup Agent.

Kerberos Principal for the Monitoring Agent and Backup Agent
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-kerberos-principal-as-user.rst

For example, to add the same principal for both the Monitoring Agent
and the Backup Agent, specify required access for both agents. The
following example specifies access required to connect to MongoDB 2.6.4
or greater.

.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<Kerberos Principal>",
        roles: [
           { role: "clusterMonitor", db: "admin" },
           { role: "backup", db: "admin" }
        ]
      }
   )

See :ref:`access-control-monitoring-agent-2.6` and
:ref:`access-control-backup-2.6.4` for more information on the
required access for the Monitoring Agent and the Backup Agent.

Edit Agent Configuration File
-----------------------------

Edit the ``/etc/mongodb-mms/backup-agent.config`` file.

.. include:: /includes/steps/kerberos-agent-config-file.rst

Host Settings
-------------

.. include:: /includes/fact-access-control-host-settings.rst
