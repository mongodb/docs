==========================
Encrypted Backup Snapshots
==========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Starting in version 3.4, |onprem| supports encryption for any backup
job that was stored in a :term:`head database` running
:product:`MongoDB Enterprise <mongodb-enterprise-advanced>` 3.4 or
later with the :ref:`WiredTiger <encrypted-storage-engine>` storage
engine.

To encrypt backups, you use a master key that a |kmip|-compliant key
management appliance generates and maintains. This master key encrypts
the :term:`head databases <head database>`. As the
:term:`Backup Daemon` creates snapshots from the head databases,
resulting snapshots from the encrypted head databases are themselves
encrypted.

To restore from an encrypted backup, you need the same master key used
to encrypt the backup and either the same certificate as is on the
:term:`Backup Daemon` host or a new certificate provisioned with that
key from the |kmip| host.

Prerequisites
-------------

- :term:`Head databases <head database>` use `MongoDB Enterprise
  <https://www.mongodb.com/products/mongodb-enterprise-advanced>`_ 3.4
  or later with the WiredTiger :term:`storage engine`.

- A host running |kmip|-compliant key management to generate and store
  encryption keys.

- A valid |kmip| client certificate and |kmip| host |certauth| files.
  These files are used to authenticate |onprem| to the |kmip| host. The
  client certificate on the Backup Daemon host must have access to
  all keys in the |kmip| host.

.. important::

   You must maintain all keys, even rotated keys, in the |kmip| host.

.. _setup-kmip-server-conf:

Set up KMIP Host Configuration for |onprem|
-------------------------------------------

.. include:: /includes/steps/set-kmip-values.rst

.. _configure-group-kmip:

Configure Your Project to Use KMIP
----------------------------------

.. note::

   All deployments in the project use the same |kmip| client
   certificate file to authenticate.

.. include:: /includes/steps/set-group-kmip-values.rst

Encrypt Your Backup Job
-----------------------

.. important::

   For existing backups in a project, enabling encryption requires an
   initial backup sync to recreate the backups' head databases.

.. include:: /includes/steps/enable-backup.rst

.. _rotate-kmip-keys:

Rotate Master KMIP Keys
-----------------------

.. include:: /includes/steps/rotate-kmip-master-key.rst
