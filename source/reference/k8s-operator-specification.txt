.. _k8s-specification:

=======================================
MongoDB Database Resource Specification
=======================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecols

.. include:: /includes/admonitions/note-substitute-opsm-with-cloudm.rst

The :github:`MongoDB Enterprise Kubernetes Operator </mongodb/mongodb-enterprise-kubernetes>`
creates |k8s| |k8s-statefulsets| from specification files that you
wrote.

MongoDB resources are created in Kubernetes as
:k8sdocs:`custom resources </concepts/extend-kubernetes/api-extension/custom-resources/>`.
After you create or update a |k8s-mdbrsc| specification, you direct
|k8s-op-full| to apply this specification to your |k8s| environment.
|k8s-op-short| creates the defined |k8s-statefulsets|, services and
other Kubernetes resources. After the Operator finishes creating those
objects, it updates the |onprem-link| deployment configuration to
reflect changes.

.. list-table::
   :widths: 20 40 40
   :header-rows: 1
   :stub-columns: 1

   * - Deployment Type
     - StatefulSets
     - Size of StatefulSet

   * - Standalone
     - 1
     - 1 |k8s-pod|

   * - Replica Set
     - 1
     - 1 |k8s-pod| per member

   * - Sharded Cluster
     - <numberOfShards> + 2
     - 1 |k8s-pod| per |mongos|, shard, or config server member

Each |k8s-mdbrsc| uses an object specification in |yaml| to define the
characteristics and settings of the MongoDB object: standalone,
:term:`replica set`, and :term:`sharded cluster`.

Common Resource Settings
------------------------

Every resource type must use the following settings:

Required
~~~~~~~~

.. include:: /includes/option/setting-k8sSaConf-apiVersion.rst
.. include:: /includes/option/setting-k8sSaConf-kind.rst
.. include:: /includes/option/setting-k8sSaConf-metadata.name.rst
.. include:: /includes/option/setting-k8sSaConf-spec.credentials.rst
.. include:: /includes/option/setting-k8sSaConf-spec.persistent.rst
.. include:: /includes/option/setting-k8sSaConf-spec.type.rst
.. include:: /includes/option/setting-k8sSaConf-spec.version.rst

Conditional
~~~~~~~~~~~

Every resource must use *one* of the following settings:

.. include:: /includes/option/setting-k8sSaConf-spec.opsManager.configMapRef.name.rst
.. include:: /includes/option/setting-k8sSaConf-spec.cloudManager.configMapRef.name.rst

Optional
~~~~~~~~

Every resource type may use the following settings:

.. include:: /includes/option/setting-k8sSaConf-spec.featureCompatibilityVersion.rst
.. include:: /includes/option/setting-k8sSaConf-spec.clusterDomain.rst
.. include:: /includes/option/setting-k8sSaConf-spec.clusterName.rst
.. include:: /includes/option/setting-k8sSaConf-metadata.namespace.rst
.. include:: /includes/option/setting-k8sSaConf-spec.service.rst
.. include:: /includes/option/setting-k8sSaConf-spec.logLevel.rst
.. include:: /includes/option/setting-k8sSaConf-spec.security.authentication.ignoreUnknownUsers.rst

Deployment-Specific Resource Settings
-------------------------------------

Other settings you can and must use in a |k8s-mdbrsc| specification
depend upon which MongoDB deployment item you want to create:

- :ref:`standalone-settings`

- :ref:`replica-set-settings`

- :ref:`sharded-cluster-settings`

.. _standalone-settings:

Standalone Settings
~~~~~~~~~~~~~~~~~~~

.. note::

   All of the :ref:`standalone-settings` also apply to replica set
   resources.

.. include:: /includes/option/setting-k8sSaConf-spec.additionalMongodConfig.rst
.. include:: /includes/option/setting-k8sSaConf-spec.agent.rst
.. include:: /includes/option/setting-k8sSaConf-spec.agent.startupOptions.rst
.. include:: /includes/option/setting-k8sSaConf-spec.exposedExternally.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.nodeAffinity.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.persistence.single.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.persistence.multiple.data.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.persistence.multiple.journal.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.persistence.multiple.logs.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.podAffinity.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.podTemplate.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.podTemplate.metadata.rst
.. include:: /includes/option/setting-k8sSaConf-spec.podSpec.podTemplate.spec.rst

.. _replica-set-settings:

Replica Set Settings
~~~~~~~~~~~~~~~~~~~~

.. note::

   All of the :ref:`standalone-settings` also apply to replica set
   resources.

The following settings apply only to replica set resource types:

.. include:: /includes/option/setting-k8sRsConf-spec.backup.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.mode.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.autoTerminateOnDeletion.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.kmip.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.kmip.client.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.kmip.client.clientCertificatePrefix.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.snapshotIntervalHours.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.snapshotRetentionDays.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.dailySnapshotRetentionDays.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.weeklySnapshotRetentionWeeks.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.monthlySnapshotRetentionMonths.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.pointInTimeWindowHours.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.referenceHourOfDay.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.referenceMinuteOfHour.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.fullIncrementalDayOfWeek.rst
.. include:: /includes/option/setting-k8sSaConf-spec.clusterDomain.rst
.. include:: /includes/option/setting-k8sSaConf-spec.clusterName.rst
.. include:: /includes/option/setting-k8sRsConf-spec.connectivity.replicaSetHorizons.rst
.. include:: /includes/option/setting-k8sSaConf-spec.featureCompatibilityVersion.rst
.. include:: /includes/option/setting-k8sRsConf-spec.members.rst
.. include:: /includes/option/setting-k8sRsConf-spec.podSpec.podAntiAffinityTopologyKey.rst


.. _sharded-cluster-settings:

Sharded Cluster Settings
~~~~~~~~~~~~~~~~~~~~~~~~

The following settings apply only to sharded cluster resource types:

.. include:: /includes/option/setting-k8sRsConf-spec.backup.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.mode.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.kmip.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.kmip.client.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.encryption.kmip.client.clientCertificatePrefix.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.snapshotIntervalHours.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.snapshotRetentionDays.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.dailySnapshotRetentionDays.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.weeklySnapshotRetentionWeeks.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.monthlySnapshotRetentionMonths.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.pointInTimeWindowHours.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.referenceHourOfDay.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.referenceMinuteOfHour.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.fullIncrementalDayOfWeek.rst
.. include:: /includes/option/setting-k8sRsConf-spec.backup.snapshotSchedule.clusterCheckpointIntervalMin.rst
.. include:: /includes/option/setting-k8sSaConf-spec.exposedExternally.rst
.. include:: /includes/option/setting-k8sScConf-spec.configServerCount.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrv.additionalMongodConfig.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrv.agent.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrv.agent.startupOptions.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.persistence.single.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.persistence.multiple.data.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.persistence.multiple.journal.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.persistence.multiple.logs.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.nodeAffinity.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.podAffinity.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.podAntiAffinityTopologyKey.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.podTemplate.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.podTemplate.metadata.rst
.. include:: /includes/option/setting-k8sScConf-spec.configSrvPodSpec.podTemplate.spec.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongodsPerShardCount.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosCount.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongos.additionalMongodConfig.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongos.agent.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongos.agent.startupOptions.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosPodSpec.nodeAffinity.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosPodSpec.podAffinity.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosPodSpec.podAntiAffinityTopologyKey.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosPodSpec.podTemplate.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosPodSpec.podTemplate.metadata.rst
.. include:: /includes/option/setting-k8sScConf-spec.mongosPodSpec.podTemplate.spec.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardCount.rst
.. include:: /includes/option/setting-k8sScConf-spec.shard.additionalMongodConfig.rst
.. include:: /includes/option/setting-k8sScConf-spec.shard.agent.rst
.. include:: /includes/option/setting-k8sScConf-spec.shard.agent.startupOptions.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.nodeAffinity.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.persistence.single.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.persistence.multiple.data.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.persistence.multiple.journal.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.persistence.multiple.logs.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.podAffinity.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.podAntiAffinityTopologyKey.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.podTemplate.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.podTemplate.metadata.rst
.. include:: /includes/option/setting-k8sScConf-spec.shardPodSpec.podTemplate.spec.rst

.. _prometheus-settings:

Prometheus Settings
-------------------

You can use Prometheus with your standalone resource, replica sets, or 
sharded clusters. To learn more, see :ref:`deploy-prometheus`. To view 
an example, see :ref:`mdb-resource-prometheus`.

The following settings apply when you use Prometheus 
with your MongoDB resource:

.. setting:: spec.prometheus

   *Type*: array

   *Optional*

   List that contains the parameters for exposing metrics to Prometheus.

.. setting:: spec.prometheus.metricsPath

   *Type*: string

   *Optional*

   *Default*: ``"/metrics"``

   Human-readable string that indicates the path to the metrics 
   endpoint. If you don't specify this setting, the default applies.

.. setting:: spec.prometheus.passwordSecretRef

   *Type*: object

   *Conditional*

   Object that contains the details of the |k8s-secret| for 
   basic HTTP authentication. If you want to use Prometheus with your 
   MongoDB resource, you must specify this setting.

.. setting:: spec.prometheus.passwordSecretRef.key

   *Type*: string

   *Optional*

   *Default*: ``"password"``

   Human-readable string that indentifies the key in the |k8s-secret| 
   that stores the password for basic HTTP authentication. If you don't 
   specify this setting, the default applies.

.. setting:: spec.prometheus.passwordSecretRef.name

   *Type*: string

   *Conditional*

   Human-readable label that identifies the |k8s-secret| that contains 
   the password for basic HTTP authentication. If you want to use 
   Prometheus with your MongoDB resource, you must specify this setting.

.. setting:: spec.prometheus.port

   *Type*: integer

   *Optional*

   *Default:* 9216

   Number that identifies the port that the metrics endpoint will 
   bind to. If you don't specify this setting, the default applies.

.. setting:: spec.prometheus.tlseSecretKeyRef

   *Type*: object

   *Optional*

   Object that contains the details of the |k8s-secret| for |tls| 
   authentication.

.. setting:: spec.prometheus.tlseSecretKeyRef.key

   *Type*: string

   *Optional*

   *Default*: ``"password"``

   Human-readable string that indentifies the key in the |k8s-secret| 
   that stores the password for |tls| authentication. If you don't 
   specify this setting, the default applies.

.. setting:: spec.prometheus.tlseSecretKeyRef.name

   *Type*: string

   *Conditional*

   Human-readable label that identifies the |k8s-secret| that contains 
   the password for |tls| authentication. If you want to use 
   Prometheus with your MongoDB resource and you want to use |tls| 
   authentication, you must specify this setting.

.. setting:: spec.prometheus.username

   *Type*: string

   *Conditional*

   Human-readable label that identifies the user for basic HTTP 
   authentication. If you want to use Prometheus with your MongoDB 
   resource, you must specify this setting.

.. _tls-settings:
.. _security-settings:

Security Settings
-----------------

The following security settings apply only to replica set and sharded
cluster resource types:

.. include:: /includes/option/setting-k8sRsConf-spec.security.tls.enabled.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.tls.ca.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.certsSecretPrefix.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.tls.additionalCertificateDomains.rst
.. include:: /includes/option/setting-k8sRsConf-spec.additionalMongodConfig.net.ssl.mode.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.enabled.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.modes.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.internalCluster.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.requireClientTLSAuthentication.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.servers.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.timeoutMS.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.transportSecurity.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.caConfigMapRef.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.caConfigMapRef.name.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.caConfigMapRef.key.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.bindQueryUser.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.bindQueryPasswordSecretRef.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.bindQueryPasswordSecretRef.name.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.authzQueryTemplate.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.automationLdapGroupDN.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.userToDNMapping.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.ldap.userCacheInvalidationInterval.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.mode.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.automationUserName.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.automationPasswordSecretRef.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.automationPasswordSecretRef.name.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.automationPasswordSecretRef.key.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.authentication.agents.clientCertificateSecretRef.name.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.role.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.db.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.authenticationRestrictions.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.authenticationRestrictions.clientSource.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.authenticationRestrictions.serverAddress.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.privileges.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.privileges.actions.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.privileges.resource.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.privileges.resource.database.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.privileges.resource.collection.rst
.. include:: /includes/option/setting-k8sRsConf-spec.security.roles.privileges.resource.cluster.rst

Examples
--------

.. tabs::

   tabs:
     - id: standalone
       name: Standalone Pod
       content: |

         The following example shows a resource specification for a
         standalone deployment with every setting provided:

         .. literalinclude:: /reference/k8s/standalonepodspec.yaml
            :language: yaml

     - id: replicaset
       name: Replica Set Pod
       content: |

         The following example shows a resource specification for a
         :term:`replica set` with every setting provided:

         .. literalinclude:: /reference/k8s/replicasetpodspec.yaml
            :language: yaml

     - id: shardedcluster
       name: Sharded Cluster Pod
       content: |

         The following example shows a resource specification for a
         :term:`sharded cluster` with every setting provided:

         .. literalinclude:: /reference/k8s/shardedclusterpodspec.yaml
            :language: yaml

.. _statefulset-settings:

StatefulSet Settings
--------------------

The following |k8s-statefulsets| settings apply only to replica set and
sharded cluster resource types.

.. setting:: spec.statefulSet.spec

   *Type*: collection

   Specification for the |k8s-statefulset| that the |k8s-op| creates
   for |k8s-mdbrscs|.

.. setting:: spec.statefulSet.spec.serviceName

   *Type*: string

   *Default*: ``<resource_name>-svc`` and ``<resource_name>-svc-external``

   Name of the |k8s| service to be created or used for a
   |k8s-statefulset|. If the service with this name already exists, the
   |k8s-op-full| does not delete or recreate it. This setting lets
   you create your own custom services and lets the |k8s-op-short|
   reuse them.
