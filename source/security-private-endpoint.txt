.. _private-endpoint:

=========================
Set Up a Private Endpoint
=========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. _private-endpoint-overview:

Overview
--------

MongoDB |service| supports private endpoints on {+dedicated-clusters+}
and {+serverless-instances+}. Select your {+database-deployment+} type
to learn which cloud providers |service| supports:

.. tabs::

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      - |aws| using the `{+aws-pl+} 
        <https://aws.amazon.com/privatelink/>`__ feature.

      - |azure| using the `{+az-pl+} 
        <https://azure.microsoft.com/en-us/services/private-link/>`__
        feature.

      - |gcp| using the `{+gcp-psc+} 
        <https://cloud.google.com/vpc/docs/private-service-connect>`__
        feature.

      You can also set up private endpoints for your Online Archive. To 
      learn more, see :ref:`oa-config-private-endpoint`.

      .. tabs::

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            When you enable this feature, |service| creates its own 
            |vpc| and places {+database-deployments+} within a region
            behind a network load balancer in the |service| |vpc|.

            Then you create resources that establish a one-way
            connection from your |vpc| to the network load balancer in
            the |service| |vpc| using a private endpoint.

            .. tabs::

               .. tab:: {+aws-pl+}
                  :tabid: aws-pl-diagram

                  .. figure:: /images/atlas-aws-privatelink.svg
                     :width: 720px
                     :alt: Image showing how {+aws-pl+} establishes   
                           connections from your application VPC to
                           resources in the |service| VPC.

               .. tab:: {+aws-pl+} with Direct Connect
                  :tabid: aws-pl-directconnect-diagram

                  .. figure:: /images/atlas-aws-privatelink-directconnect.svg
                     :width: 720px
                     :alt: Image showing how you can use |aws| Direct
                           Connect to establish a transitive
                           connection from your data center to a
                           peered |aws| VPC to resources in the 
                           |service| VPC using |aws| Direct Connect.
            
            .. include:: /includes/fact-private-endpoint-connections-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            When you enable this feature, |service| creates a Private 
            Link service and places clusters within a region behind a 
            load balancer in the |service| VNet.

            Then you create resources that establish a one-way 
            connection from your VNet to the :azure:`Private Link 
            service </private-link/private-link-service-overview>` in 
            the |service| VNet using a private endpoint. The Private 
            Link service routes traffic to the load balancer that 
            fronts the clusters in the |service| VNet.

            .. include:: /includes/fact-private-endpoint-connections-azure.rst

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            When you enable this feature, |service| creates a private 
            endpoint service using :gcp:`service attachments 
            </vpc/docs/private-service-connect#service-attachments>`
            and load balancers.
      
            Next, you create resources that establish a one-way 
            connection from your |vpc| to the private endpoint service 
            in |service| using a private endpoint. The private endpoint 
            service routes traffic to the load balancers for the 
            {+clusters+} in the |service| |vpc|.

            To ensure the availability of resources for both current 
            and future {+clusters+}, |service| performs the following 
            actions when you enable this feature:

            .. include:: /includes/gcp-psc-connection-workflow.rst

            Connections to |service| clusters using private endpoints 
            offer the following advantages over other network access 
            management options:

            - Connections to private endpoints are one-way. |service| 
              |vpc|\s can't initiate connections back to your |gcp| 
              |vpc|\s. This ensures your perceived network trust 
              boundary is not extended. 
            - You can connect to private endpoints within your |vpc| 
              transitively from an on-premises data center connected 
              with Google Cloud VPN to the private endpoint-connected 
              |vpc|. This enables you to connect to |service| directly 
              from your on-premises data center without adding public IP
              addresses to the |service| access list.

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      - |aws| using the `{+aws-pl+} 
        <https://aws.amazon.com/privatelink/>`__ feature.

      - |azure| using the `{+az-pl+} 
        <https://azure.microsoft.com/en-us/services/private-link/>`__
        feature.

      .. important::

         {+Serverless-instances+} don't support {+gcp-psc+}.

      .. note::

         .. include:: /includes/fact-serverless-adding-features.rst

      You can also set up private endpoints for your Online Archive. To 
      learn more, see :ref:`oa-config-private-endpoint`.

      .. tabs::

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-connections-serverless.rst

            .. include:: /includes/fact-private-endpoint-connections-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-connections-serverless.rst

            .. include:: /includes/fact-private-endpoint-connections-azure.rst

.. _private-endpoint-considerations:

Considerations
--------------

.. _private-endpoint-ha:

High Availability
~~~~~~~~~~~~~~~~~

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-ha-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-ha-azure.rst

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            You don't need to take additional actions to ensure that 
            |gcp| private endpoint connections to |service| can 
            withstand an availability zone outage.

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-ha-aws.rst 

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-ha-aws.rst

.. _private-endpoint-port-ranges:

Port Ranges Used for Private Endpoints
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-ports-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}
 
            .. include:: /includes/fact-private-endpoint-ports-azure.rst

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            |service| services are accessed through 
            {+gcp-psc+} endpoints on ports 27015 through 27017. The 
            ports can change under specific circumstances, including 
            (but not limited to) cluster changes.

            .. important::
               MongoDB strongly recommends using the DNS seedlist 
               private endpoint-aware connection string, so that DNS 
               automatically updates the ports that {+gcp-psc+} uses if
               they change. For the same reason, MongoDB also strongly 
               recommends allow-listing the entire port range, instead
               of specific ports.

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-ports-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-ports-azure.rst

.. _private-endpoint-connection-strings:

Private Endpoint-Aware Connection Strings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/aws-pl-connection-strings.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/az-pl-connection-strings.rst

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            .. include:: /includes/gcp-psc-connection-strings.rst

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/aws-pl-connection-strings.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/az-pl-connection-strings.rst

.. seealso::

   :ref:`Connect to Atlas using a Private Endpoint <connect-private-endpoint>`

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. include:: /includes/fact-private-endpoint-considerations.rst

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      IP Access Lists with Private Endpoints
      --------------------------------------

      When you enable private endpoints, you can still enable access to 
      your |service| {+database-deployments+} using other methods, such 
      as adding public IPs to :doc:`IP access lists 
      </security/ip-access-list>`.

.. _atlas-pl-limitations:

Limitations
-----------

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            - {+aws-pl+} must be active in all regions into which you 
              deploy a multi-region {+cluster+}. You will receive an 
              error if {+aws-pl+} is active in some, but not all, 
              targeted regions. If you have a multi-cloud {+cluster+} 
              in |aws| or |azure|, you must provision an endpoint in 
              each provider or region. 

            - You can do only one of the following:

              - Create more than one private endpoint in a single 
                region.
              - Create no more than one private endpoint per region, if 
                nodes are deployed in more than one region.

                .. important::

                   This limitation applies across cloud providers. For
                   example, if you create more than one private 
                   endpoint in a single region in |aws|, you can't 
                   create private endpoints in more than one region in 
                   |azure|.

                See :ref:`atlas_regionalized-pl` for an exception for
                multi-region and global sharded clusters.

            .. include:: /includes/fact-private-endpoint-limits-aws.rst

            - You can use {+aws-pl+} in |service| projects with up to 50
              addressable targets **per region**. If you need more than 
              50 addressable targets in a region:

              - Contact :ref:`MongoDB Support <request-support>`, or 
              - Use additional projects or regions to connect to 
                addressable targets beyond this limit.

              Addressable targets include:

              - Each |mongod| instance in a replica set deployment 
                (sharded clusters excluded).
              - Each |mongos| instance in a sharded cluster deployment.
              - Each |bic| instance across all dedicated clusters in the
                project.

              .. note::

                 To request a one-time increase to use {+aws-pl+} with 
                 up to 100 addressable targets per |service| project, 
                 contact :ref:`MongoDB Support <request-support>`.

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            - You can use {+az-pl+} to connect to |service| clusters 
              that run MongoDB version 3.6 or later.

              .. include:: /includes/fact-privatelink-azure-az-limitations.rst

            - {+az-pl+} must be active in all regions into which you 
              deploy a multi-region cluster. You will receive an error 
              if {+az-pl+} is active in some, but not all, targeted 
              regions. If you have a multi-cloud cluster in |aws| or 
              |azure|, you must provision an 
              endpoint in each provider or region. 

            - You can do only one of the following:

              - Create more than one private endpoints in a single 
                region.
              - Create no more than one private endpoint per region, if 
                nodes are deployed in more than one region.

                .. important::

                   This limitation applies across cloud providers. For
                   example, if you create more than one private 
                   endpoint in a single region in |azure|, you can't 
                   create private endpoints in more than one region in 
                   |aws|.

              See :ref:`atlas_regionalized-pl` for an exception for
              multi-region and global sharded clusters.

            - To connect to |service| clusters using {+az-pl+} from 
              regions in which you haven't deployed a private endpoint 
              connection, you must peer VNets in those regions to VNets 
              in a region in which you have deployed a private endpoint 
              connection.

              To learn about Global VNet peering, see the
              :azure:`Azure documentation </virtual-network/virtual-networks-faq#can-i-create-a-peering-connection-to-a-vnet-in-a-different-region>`.

            - You can use {+az-pl+} in |service| projects with up to 150
              addressable targets **per region**. If you need more than 
              150 addressable targets in a region:

              - Contact :ref:`MongoDB Support <request-support>`, or 
              - Use additional projects or regions to connect to 
                addressable targets beyond this limit.

              Addressable targets include:

              - Each |mongod| instance in a replica set deployment 
                (sharded clusters excluded).
              - Each |mongos| instance in a sharded cluster deployment.
              - Each |bic| instance across all dedicated clusters in the
                project.

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            - You can use {+gcp-psc+} to connect to |service| clusters 
              that run MongoDB version 4.0 or later.

            - {+gcp-psc+} must be active in all regions into which you 
              deploy a multi-region cluster. You will receive an error 
              if {+gcp-psc+} is active in some, but not all, targeted 
              regions.

            - You can do only one of the following:

              - Create more than one group of private endpoints in a 
                single region.
              - Create one group of private endpoints in multiple 
                regions.

                .. important::

                   This limitation applies across cloud providers. For
                   example, if you create more than one private 
                   endpoint in a single region in |gcp|, you can't 
                   create private endpoints in more than one region in 
                   |aws|.

              See :ref:`atlas_regionalized-pl` for an exception for
              multi-region and global sharded clusters.

            - If this is the first private endpoint that you deploy to 
              a region, you must first resume any paused clusters in 
              your project with nodes deployed to that region.

              This limitation doesn't apply for additional private 
              endpoints that you deploy to the same region.

            - You can use {+gcp-psc+} in |service| projects with up to 
              50 nodes **per region**. If you need more than 50 nodes 
              in a region:

              - Contact :ref:`MongoDB Support <request-support>`, or 
              - Use additional projects or regions to connect to nodes 
                beyond this limit.

              .. note::

                 Each private endpoint in |gcp| reserves an IP address 
                 within your |gcp| |vpc| and forwards traffic from the 
                 endpoints' IP addresses to the 
                 :gcp:`service attachments </vpc/docs/private-service-connect#service-attachments>`.
                 You must create an equal number of private endpoints 
                 to the number of service attachments. The number of 
                 service attachments defaults to 50.

              .. note::

                 To request a one-time increase to use {+gcp-psc+} with 
                 up to 100 nodes per |service| project, contact
                 :ref:`MongoDB Support <request-support>`.

            - |gcp| {+google-psc+} supports up to 1024 outgoing 
              connections per virtual machine. As a result, you can't 
              have more than 1024 connections from a single |gcp| 
              virtual machine to an |service| cluster.

              To learn more, see the |gcp|
              :gcp:`cloud NAT documentation 
              </nat/docs/ports-and-addresses>`.

            - |gcp| {+google-psc+} is region-specific. You cannot use 
              |vpc| peering to access private endpoints from a 
              different |vpc|.

              When using {+google-psc+} to connect to multi-region
              {+clusters+}, you can connect only to {+cluster+} nodes 
              that are in the same region as the private endpoint. If 
              the endpoint and the primary node are in different 
              regions, you must:

              1. Set your application's
                 :manual:`read preference </core/read-preference/>`
                 to allow connections from a secondary node.

                 For example, you can set your application's read 
                 preferencento :manual:`secondaryPreferred </core/read-preference/#mongodb-readmode-secondaryPreferred>`.

              2. Ensure at least one secondary node is in the same 
                 region as the endpoint.

      - If this is the first private endpoint that you deploy to a
        region, you must first resume any paused 
        {+database-deployments+} in your project with nodes deployed to
        that region. This limitation doesn't apply for additional
        private  endpoints that you deploy to the same region.

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-limits-aws.rst
            
         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

      - Private endpoints for {+serverless-instances+} apply at the 
        {+database-deployment+} level. If you configure a private
        endpoint for a {+serverless-instance+}, that private endpoint 
        can't be used for other {+serverless-instances+} or {+clusters+}
        in the same project. You must configure a separate private endpoint for each {+serverless-instance+}.

      - You can connect up to two private endpoints per 
        {+serverless-instance+}.

Prerequisites
-------------

To enable connections to |service| using private endpoints, you must:

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-prereq-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-prereq-azure.rst

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            1. Have either the :authrole:`Project Owner` or
               :authrole:`Organization Owner` role in |service|.

            #. Have a |gcp| user account with an |iam| user policy and 
               a :gcp:`Compute Network Admin 
               </iam/docs/understanding-roles#compute.networkAdmin>`
               role that grants permissions to create, modify, and 
               delete networking resources. For more information on 
               managing private endpoints and connections, see the
               :gcp:`GCP documentation </vpc/docs/overview.html>`.

            #. :gcp:`Install gcloud CLI </sdk/docs/install>`.

            #. If you have not already done so, create your |vpc| and 
               Compute instances in |gcp|. See the :gcp:`GCP 
               documentation </vpc/docs/using-vpc.html>` for guidance.

            #. Make sure egress firewall rules permit traffic to the 
               internal IP address of the {+gcp-psc+} endpoint.
         
            #. (Optional) If you enforce a security perimeter with 
               |vpc| service controls (VPC-SC), you must create ingress 
               and egress rules to establish the connection between the 
               {+gcp-psc+} endpoint and |service| {+clusters+}. See the 
               :gcp:`GCP documentation </vpc/docs/configure-private-service-connect-services#vpc-sc>` 
               for guidance.

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/fact-private-endpoint-prereq-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-prereq-azure.rst

Procedures
----------

.. _atlas-configure-private-endpoint:

Configure an |service| Private Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Use these resources to configure an |service| private endpoint:

- :ref:`<cluster-private-endpoint>`
- :ref:`<serverless-private-endpoint>`

.. _connect-private-endpoint:
.. _atlas-connect-private-endpoint:

Connect to |service| using a Private Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note::

   For important considerations about private endpoint-aware connection
   strings, see
   :ref:`Private Endpoint-Aware Connection Strings <private-endpoint-connection-strings>`.

Use a private endpoint-aware connection string to connect to an
|service| {+database-deployment+} with the following procedure:

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. include:: /includes/steps/connect-to-database-deployment-privatelink.rst

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. include:: /includes/steps/connect-to-database-deployment-privatelink-sl.rst

.. _remove-private-endpoint:

Remove a Private Endpoint from |service|
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/steps/delete-privatelink-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/steps/delete-privatelink-azure.rst

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            .. include:: /includes/steps/delete-privateserviceconnect-gcp.rst 

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/steps/delete-privatelink-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/steps/delete-privatelink-azure.rst

.. _pl-troubleshooting:
.. _atlas-troubleshoot-private-endpoint:

Troubleshoot Private Endpoint Connection Issues
-----------------------------------------------

.. tabs::
   :hidden:

   .. tab:: {+Dedicated-Clusters+}
      :tabid: clusters

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/steps/troubleshoot-privatelink-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            .. include:: /includes/fact-private-endpoint-status-intro.rst

            :guilabel:`Atlas Endpoint Service Status`

            .. list-table::
               :widths: 30 70
               :header-rows: 1

               * - Status
                 - Description

               * - Creating private link
                 - |service| is creating the load balancer and VNet
                   resources.

               * - Failed
                 - A system failure has occurred.

               * - Available
                 - |service| created the load balancer and {+az-pl+} 
                   Service.
                   The {+az-pl+} Service is ready to receive connection
                   requests.

               * - Deleting
                 - |service| is deleting the {+az-pl+} Service.

            :guilabel:`Endpoint Status`

            .. list-table::
               :widths: 30 70
               :header-rows: 1

               * - Status
                 - Description

               * - Not configured
                 - |service| created the load balancer and {+az-pl+} 
                   Service, but you haven't created a private endpoint 
                   yet. Click :guilabel:`Edit` and complete the wizard 
                   to create the private endpoint.

               * - Initiating
                 - |service| has not yet accepted the connection to your
                   private endpoint.

               * - Failed
                 - |azure| failed to establish a connection between 
                   |service| VNet resources and the private endpoint in 
                   your VNet. Click :guilabel:`Edit`, verify that the 
                   information you provided is correct, and then create 
                   the private endpoint again.

               * - Available
                 - |service| VNet resources are connected to the private
                   endpoint in your VNet. You can connect to |service|
                   clusters in this region using {+az-pl+}.

               * - Deleting
                 - |service| is removing the private endpoint 
                   connection from the {+az-pl+} Service.

         .. tab:: {+gcp-psc+}
            :tabid: {+gcp-psc+}

            .. include:: /includes/troubleshoot-privateserviceconnect-gcp.rst

   .. tab:: {+Serverless-Instances+}
      :tabid: serverless-instances

      .. tabs::
         :hidden:

         .. tab:: {+aws-pl+}
            :tabid: {+aws-pl+}

            .. include:: /includes/steps/troubleshoot-privatelink-aws.rst

         .. tab:: {+az-pl+}
            :tabid: {+az-pl+}

            FILL

.. toctree::
   :titlesonly:

   /security-cluster-private-endpoint
   /security-serverless-private-endpoint