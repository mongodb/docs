---
title: "Create a :svc-cat:`ServiceInstance </resources/#serviceinstance>` resource definition for your :term:`sharded cluster`."
stepnum: 1
level: 4
ref: create-custom-resource
content: |

  a. Copy one of the following resource definition examples based on
     the scope of your {+osb+} instance.

     If you registered the {+osb+} instance as:

     - A ``ClusterServiceBroker``, select the :ref:`Cluster-scoped
       <osb-scope-cluster>` Instance tab.
     
     - A ``ServiceBroker``, select the :ref:`Namespace-scoped
       <osb-scope-namespace>` Instance tab.

     |

     .. tabs::

        .. tab:: Cluster-scoped Instance
           :tabid: clusterServiceBroker

           Copy the following |yaml| file, which you can modify to meet
           your desired configuration:

           .. literalinclude:: /reference/k8s/example-clusterServiceBroker-sharded-cluster-minimal.yaml
              :language: yaml
              :linenos:
              :emphasize-lines: 4-5,7-8,11-13

        .. tab:: Namespace-scoped Instance
           :tabid: serviceBroker

           Copy the following |yaml| file, which you can modify to meet
           your desired configuration:

           .. literalinclude:: /reference/k8s/example-serviceBroker-sharded-cluster-minimal.yaml
              :language: yaml
              :linenos:
              :emphasize-lines: 4-5,7-8,11-13

  #. Open your preferred text editor and paste the resource
     definition into a new text file.
---
title: "Configure the required settings."
stepnum: 2
level: 4
ref: configure-required-settings
content: |

  To deploy a :term:`sharded cluster`, you must specify the following
  settings:

  .. tabs::

     .. tab:: Cluster-scoped Instance
        :tabid: clusterServiceBroker

        .. list-table::
           :widths: 20 40 20
           :header-rows: 1

           * - Key
             - Description
             - Example

           * - ``metadata.name``
             - Name of the cluster in |k8s|. |service| randomly
               generates a corresponding |service| cluster name.
             - ``my-atlas-cluster``

           * - ``metadata.namespace``
             - |k8s| |k8s-ns| where this cluster is created.
             - ``atlas``

           * - ``spec.clusterServiceClassExternalName``
             - |k8s| class which corresponds to your |service| cloud
               service provider.

               View the available classes by invoking the
               following command:

               .. code-block:: sh

                  svcat marketplace -n <NAMESPACE>

               Class names are listed in the ``CLASS`` column of the
               command output.

               .. note::

                  You must use the ``mongodb-atlas-tenant`` class to
                  deploy ``M2`` or ``M5`` replica sets. The value you
                  specify for the ``spec.regionName`` setting determines
                  which cloud provider the cluster is deployed to.                 

             - ``mongodb-atlas-aws``

           * - ``spec.clusterServicePlanExternalName``
             - |k8s| service plan which corresponds to the desired
               |service| instance size.

               View the available plans by invoking the
               following command:

               .. code-block:: sh

                  svcat marketplace -n <NAMESPACE>

               Plan names are listed in the ``PLANS`` column of the
               command output.

             - ``M10``
          
           * - | ``spec.parameters.cluster``
               | ``.numShards``
             - Number of shards in the :term:`sharded cluster`.
             - ``3``

           * - | ``spec.parameters.cluster``
               | ``.providerSettings.regionName``
             - |service| region where the cluster is created.

               .. important::

                  Make sure you use the |service| region name for the desired
                  region, not the cloud provider region name. If you
                  deploy ``M2`` or ``M5`` clusters, make sure the region
                  you select supports these cluster sizes.

               For a list of available regions, see the |service|
               documentation for your cloud service provider:

               - :atlas:`Amazon Web Services (AWS) 
                 <reference/amazon-aws>`
               - :atlas:`Google Cloud Platform (GCP)
                 <reference/google-gcp>`
               - :atlas:`Microsoft Azure <reference/microsoft-azure>`

             - ``EU_CENTRAL_1``

     .. tab:: Namespace-scoped Instance
        :tabid: serviceBroker

        .. list-table::
           :widths: 20 40 20
           :header-rows: 1

           * - Key
             - Description
             - Example

           * - ``metadata.name``
             - Name of the cluster in |k8s|. |service| randomly
               generates a corresponding |service| cluster name.
             - ``my-atlas-cluster``

           * - ``metadata.namespace``
             - |k8s| |k8s-ns| where this cluster is created.
             - ``atlas``

           * - ``spec.serviceClassExternalName``
             - |k8s| class which corresponds to your |service| cloud
               service provider.

               View the available classes by invoking the
               following command:

               .. code-block:: sh

                  svcat marketplace -n <NAMESPACE>

               Class names are listed in the ``CLASS`` column of the
               command output.

               .. note::

                  You must use the ``mongodb-atlas-tenant`` class to
                  deploy ``M2`` or ``M5`` replica sets. The value you
                  specify for the ``spec.regionName`` setting determines
                  which cloud provider the cluster is deployed to.                 

             - ``mongodb-atlas-aws``

           * - ``spec.servicePlanExternalName``
             - |k8s| service plan which corresponds to the desired
               |service| instance size.

               View the available plans by invoking the
               following command:

               .. code-block:: sh

                  svcat marketplace -n <NAMESPACE>

               Plan names are listed in the ``PLANS`` column of the
               command output.

             - ``M10``

           * - | ``spec.parameters.cluster``
               | ``.numShards``
             - Number of shards in the :term:`sharded cluster`.
             - ``3``

           * - | ``spec.parameters.cluster``
               | ``.providerSettings.regionName``
             - |service| region where the cluster is created.

               .. important::

                  Make sure you use the |service| region name for the desired
                  region, not the cloud provider region name. If you
                  deploy ``M2`` or ``M5`` clusters, make sure the region
                  you select supports these cluster sizes.

               For a list of available regions, see the |service|
               documentation for your cloud service provider:

               - :atlas:`Amazon Web Services (AWS) 
                 <reference/amazon-aws>`
               - :atlas:`Google Cloud Platform (GCP)
                 <reference/google-gcp>`
               - :atlas:`Microsoft Azure <reference/microsoft-azure>`

             - ``EU_CENTRAL_1``

---
title: "(Optional) Configure any additional settings for a :term:`sharded cluster` deployment."
stepnum: 3
level: 4
ref: add-additional-settings
content: |

  .. include:: /includes/fact-additional-resource-settings.rst

  .. important::

     The following |api| parameters are overwritten by the required
     {+osb+} settings from the previous step and should not be
     specified:

     - ``providerSettings.instanceSizeName``
     - ``providerSettings.providerName``
     - ``name``

  .. tabs::

     .. tab:: Cluster-scoped Instance
        :tabid: clusterServiceBroker

        .. example::

           This example resource definition creates a :term:`sharded
           cluster` called ``my-sharded-cluster`` in the ``atlas``
           namespace that has the following configuration:

           - Managed by a cluster-scoped (``ClusterServiceBroker``) 
             {+osb+}
           - AWS as a cloud service provider
           - An instance size of ``M10``
           - Composed of three shards
           - Located in the EU (Frankfurt) region
           - Auto-scaling disabled
           - |service| continuous backups enabled

           .. code-block:: yaml

              apiVersion: servicecatalog.k8s.io/v1beta1
              kind: ServiceInstance
              metadata:
                name: my-sharded-cluster
                namespace: atlas
              spec:
                clusterServiceClassExternalName: mongodb-atlas-aws
                clusterServicePlanExternalName: M10
                parameters:
                  cluster:
                    numShards: 3
                    providerSettings:
                      regionName: EU_CENTRAL_1
                    autoscaling:
                      diskGBEnabled: false
                    backupEnabled: true

     .. tab:: Namespace-scoped Instance
        :tabid: serviceBroker

        .. example::

           This example resource definition creates a :term:`sharded
           cluster` called ``my-sharded-cluster`` in the ``atlas``
           namespace that has the following configuration:

           - Managed by a namespace-scoped (``ServiceBroker``) {+osb+}
           - AWS as a cloud service provider
           - An instance size of ``M10``
           - Composed of three shards
           - Located in the EU (Frankfurt) region
           - Auto-scaling disabled
           - |service| continuous backups enabled

           .. code-block:: yaml

              apiVersion: servicecatalog.k8s.io/v1beta1
              kind: ServiceInstance
              metadata:
                name: my-sharded-cluster
                namespace: atlas
              spec:
                serviceClassExternalName: mongodb-atlas-aws
                servicePlanExternalName: M10
                parameters:
                  cluster:
                    numShards: 3
                    providerSettings:
                      regionName: EU_CENTRAL_1
                    autoscaling:
                      diskGBEnabled: false
                    backupEnabled: true

---
title: "Save the file as ``sharded-cluster.yaml``."
stepnum: 4
level: 4
ref: save-resource-definition

---
title: "Deploy the :term:`sharded cluster`."
stepnum: 5
level: 4
ref: deploy-replica-set
content: |

   Invoke the following |k8s| command to create your
   :term:`sharded cluster`:

   .. code-block:: sh

      kubectl apply -f sharded-cluster.yaml

---
title: "Track the status of your sharded cluster deployment."
stepnum: 6
level: 4
ref: track-k8s-deployment
content: |

  To view the status of your deployment, pass the ``metadata.name``
  from ``sharded-cluster.yaml`` into the following command:

  .. code-block:: sh

     svcat describe instance <METADATA.NAME> -n <NAMESPACE>

  As the :term:`sharded cluster` is being deployed, the command returns
  the following status:

  .. code-block:: sh
     :copyable: false

     Provisioning - The instance is being provisioned asynchronously

  Once the :term:`sharded cluster` deploys successfully, the command
  returns the following status:

  .. code-block:: sh
     :copyable: false

     Ready - The instance was provisioned successfully

...
