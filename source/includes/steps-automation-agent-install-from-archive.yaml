title: "Login to |mms|."
stepnum: 1
ref: login
---
title: "Begin or Manage a Deployment"
stepnum: 2
ref: begin-deployment
content: |

  a. Click :guilabel:`Build New` or :guilabel:`Manage Existing` to begin
     the deployment wizard. When you reach the :guilabel:`Install an Automation
     Agent on each server` page, all hosts are listed.

  b. Click on the :guilabel:`Install Agent` menu of the first MongoDB
     host.

  c. Select :guilabel:`<Linux-Distribution> - TAR`.
---
title: Download the latest version of the Automation Agent archive.
stepnum: 3
ref: download-automation-agent-archive
pre: |
  On a system shell, issue a ``curl`` command to download the archive
  for the agent that works on your platform:
action:
  - heading: "For RHEL / CentOS (7.x) and SUSE 12 on x64 architecture:"
    language: sh
    copyable: true
    code: |
      curl -OL https://cloud.mongodb.com/download/agent/automation/mongodb-mms-automation-agent-latest.rhel7_x86_64.tar.gz
  - heading: "For RHEL / CentOS (7.x) on PowerPC architecture (managing MongoDB 3.4 or later deployments only):"
    language: sh
    copyable: true
    code: |
      curl -OL https://cloud.mongodb.com/download/agent/automation/mongodb-mms-automation-agent-latest.rhel7_ppc641e.tar.gz
  - heading: "For all other Linux distributions:"
    language: sh
    copyable: true
    code: |
      curl -OL https://cloud.mongodb.com/download/agent/automation/mongodb-mms-automation-agent-latest.linux_x86_64.tar.gz
edition:
  - cloud
---
title: Download the latest version of the Automation Agent archive.
stepnum: 3
ref: download-automation-agent-archive
pre: |
  On a system shell, issue a ``curl`` command to download the archive
  for the agent that works on your platform:

  .. note::

     Replace ``<OpsManagerHost>`` with the hostname of your |onprem|
     installation.

action:
  - heading: "For RHEL / CentOS (7.x) and SUSE 12 on x64 architecture:"
    language: sh
    copyable: true
    code: |
      curl -OL <OpsManagerHost>:<Port>/download/agent/automation/mongodb-mms-automation-agent-latest.rhel7_x86_64.tar.gz
  - heading: "For RHEL / CentOS (7.x) on PowerPC architecture (managing MongoDB 3.4 or later deployments only):"
    language: sh
    copyable: true
    code: |
      curl -OL <OpsManagerHost>:<Port>/download/agent/automation/mongodb-mms-automation-agent-latest.rhel7_ppc641e.tar.gz
  - heading: "For all other Linux distributions:"
    language: sh
    copyable: true
    code: |
      curl -OL <OpsManagerHost>:<Port>/download/agent/automation/mongodb-mms-automation-agent-latest.linux_x86_64.tar.gz
edition:
  - onprem
---
title: "Install the Automation Agent."
stepnum: 4
ref: extract
pre: |
  To install the agent that works on your platform, issue the
  appropriate command to extract the archive:
action:
  language: sh
  copyable: true
  code: |
    tar -xf mongodb-mms-automation-agent-latest.*.tar.gz
post: |
  The Automation Agent is installed.
---
title: "Generate an agent API key or retrieve an existing agent API key for your |mms| project." 
stepnum: 5
ref: retrieve-automation-mms-api-key
pre: |
      a. Click :guilabel:`+ Generate Key`.

      .. include:: /includes/extracts/agent-api-key-generate-note.rst

      b. Enter your password and click :guilabel:`Verify`.
  
      c. Click :guilabel:`+ Generate Key` again.

      .. include:: /includes/extracts/agent-api-key-admonition.rst
---
title: "Edit the ``local.config`` file to include your Project ID and agent API key."
stepnum: 6
ref: configure-automation-group-api-cloud
pre: |
  In the directory where you installed the Automation Agent, edit the
  ``local.config`` file.

  - For ``mmsGroupId``, enter your ProjectID as the value.
  - For ``mmsApiKey``, enter the project's :term:`agent API key`.
action:
  language: none
  code: |
    mmsGroupId=<Project ID>
    mmsApiKey=<agent API key>
edition:
  - cloud
---
title: "Edit the ``local.config`` file."
stepnum: 6
ref: configure-automation-group-api-onprem
pre: |
   In the directory where you installed the Automation Agent, edit the
   ``local.config`` file to either:

   .. include:: /includes/extracts/server-pool-agent-config-choice.rst

action:
   - heading: Configure for a Specific Project
     pre: |
        Update the following configuration keys:

        - For ``mmsGroupId``, set to your ProjectID.
        - For ``mmsApiKey``, set to the project's :term:`agent API key`.
        - For ``mmsBaseUrl``, set to the URL of the |application|. Include the port number.

     language: none
     code: |
       mmsGroupId=<Project ID>
       mmsApiKey=<agent API key>
       mmsBaseUrl=<application URL>
     post: |

       Do not configure the server pool settings:
       :asetting:`serverPoolKey`, :asetting:`serverPoolPropertiesFile`,
       :asetting:`serverPoolStateFile`.

       {{additionalstep}}

   - heading: Configure for a Server Pool
     pre: |
        Update the following configuration keys:

        - For ``mmsBaseUrl``, set to the URL of the |application|.
          Include the port number.

        - For  :asetting:`serverPoolKey`, set to the Server Pool Key.

          .. include:: /includes/extracts/server-pool-key-location.rst

        - For :asetting:`serverPoolPropertiesFile`, set to the full
          filepath of a file that contains server properties. Ensure
          the Automation Agent can read the file.

          .. include:: /includes/extracts/server-pool-properties-file-content-description.rst

          .. include:: /includes/extracts/server-pool-properties-file-note.rst

        - For :asetting:`serverPoolStateFile`, set to the full
          filepath of the file to be used by the Automation Agent.

          .. include:: /includes/extracts/server-pool-state-file-permission.rst
     language: none
     code: |
       mmsBaseUrl=<application URL>
       serverPoolKey=somekeyabc123
       serverPoolPropertiesFile=<path to server properties file>
       serverPoolStateFile=<path to server state file>
     post: |
        Do not configure the project settings:
        :asetting:`mmsGroupId` and :asetting:`mmsApiKey`.

        {{additionalstep}}

edition:
  - onprem
replacement:
   additionalstep: ""
---
stepnum: 7
source:
  file: steps-source-install-agent.yaml
  ref: proxy
replacement:
  agentname: "Automation"
  httpProxy: ":asetting:`httpProxy`"
  configfile: "<install-directory>/local.config"
---
title: "Create the automation and data directories."
stepnum: 8
ref: create-automation-directory
action:
  pre: |

    Create the directories for the Automation Agent:

    .. list-table::
       :widths: 40 60
       :header-rows: 1

       * - Component
         - Default Directory

       * - Automation Agent binaries
         - ``/var/lib/mongodb-mms-automation``

       * - Automation Agent logs
         - ``/var/log/mongodb-mms-automation``

       * - MongoDB databases created by the Automation Agent
         - ``/data``

  language: sh
  copyable: true
  code: |
     sudo mkdir -m 755 -p /var/lib/mongodb-mms-automation
     sudo mkdir -m 755 -p /var/log/mongodb-mms-automation
     sudo mkdir -m 755 -p /data

  post: |

    .. topic:: Using a Different Path than ``/var/lib``

       By default, the Automation Agent binaries and |mms|
       configuration backup file are located in ``/var/lib/mongodb-mms-automation``. 
       If you want to store these files in a different
       directory, follow these procedures:

       **To change the location of the Automation Agent Binaries:**

       a. Click :guilabel:`Deployment`; :guilabel:`Agents`; and then
          :guilabel:`Downloads & Settings`.

       b. Below the :guilabel:`Download Directory` heading, click the
          pencil icon to the right of the path shown in
          :guilabel:`Download Directory (Linux/MacOS)`.

       c. Change the path to the new path you want.

       d. Click :guilabel:`Save`.

       e. Create the new directory you specified on each host that runs
          an Automation Agent.

          .. code-block:: sh

               sudo mkdir -m 755 -p /<newPath>

       **To change the location of the Automation Agent configuration backup:**

       a. Open the
          :ref:`Automation Agent configuration file <automation-agent-config-file-location>`
          in your preferred text editor.

       b. Change the :asetting:`mmsConfigBackup` setting to the new path for
          the configuration backup file.

          .. code-block: ini

             mmsConfigBackup=/<newPath>/mms-cluster-config-backup.json

       c. Save the Automation Agent configuration file.

       d. Move the configuration backup file to the new directory.

          .. code-block:: sh

             sudo mv /var/lib/mongodb-mms-automation/mms-cluster-config-backup.json /<newPath>

---
title: "Assign permissions to the system user that runs the Automation Agent."
stepnum: 9
ref: assign-automation-agent-permissions
action:
  pre: |
    Run the following commands as the system user that will run the
    Automation Agent.
  language: sh
  copyable: true
  code: |
     sudo chown `whoami` /var/lib/mongodb-mms-automation
     sudo chown `whoami` /var/log/mongodb-mms-automation
     sudo chown `whoami` /data
---
title: "Start the Automation Agent."
stepnum: 10
ref: start-automation-agent
action:
  pre: |

    From the directory in which you installed the Automation Agent, issue the
    following command:

  language: sh
  copyable: true
  code: |
    nohup ./mongodb-mms-automation-agent --config=local.config >> /var/log/mongodb-mms-automation/automation-agent-fatal.log 2>&1 &
---
title: "Verify that the Automation Agent can connect to |mms|."
stepnum: 11
ref: verify-automation-agent
content: 
  Click :guilabel:`Verify Agent` on the :guilabel:`Automation Agent Installation Instructions` modal.
...
