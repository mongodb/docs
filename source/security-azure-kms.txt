.. _security-azure-kms:

============================================
Customer Key Management with Azure Key Vault
============================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

|service| uses your Azure Key Identifier (AKI) from your Azure Key
Vault (AKV) to encrypt and decrypt your MongoDB master keys. These
MongoDB master keys are used to encrypt cluster database files and
:ref:`cloud providers snapshots <backup-cloud-provider>`.

.. include:: /includes/fact-atlas-key-rotation.rst

|service| encrypts your data at rest using encrypted storage media.
Using keys you manage with |akv|, |service| encrypts your
data a second time when it writes it to the MongoDB
:manual:`encrypted storage engine </core/security-encryption-at-rest>`.
You use your |aki| to encrypt the MongoDB master encryption keys.

This page covers configuring customer key management using |akv| on
your |service| project.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

.. _azure-kms-prereqs:

.. _security-azure-kms-restrictions:

Prerequisites
-------------

.. include:: /includes/fact-azure-kms-prereqs.rst

.. include:: /includes/fact-kms-prereqs.rst

Procedure
---------

.. _azure-kms-configure-project:

Enable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must enable customer key management for a project before you can
enable it on a cluster in that project.

.. include:: /includes/steps/configure-azure-encryption-for-project.rst

.. _azure-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you :ref:`azure-kms-configure-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:doc:`Manage your own encryption keys </cluster-config/encryption/>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

Disable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must disable customer key management on each cluster in a project
before you can disable the feature for the project.

.. important::

   Do *not* disable or delete any |akv| keys that any cluster in your
   |service| project uses before you have disabled customer key
   management within the |service| project. If |service| cannot access
   an |akv| key, any data that key encrypted becomes inaccessible.

Alerts
------

|service| automatically creates an
:alert:`encryption key rotation alert <Azure encryption key elapsed time since last rotation is above (n) days>`
once you configure customer key management for a project.

To reset this alert, :doc:`/tutorial/security-azure-kms-rotate-key`.

Related Topics
--------------

- To enable Encryption at Rest using your Key Management when deploying
  an |service| cluster, see :ref:`create-cluster-enable-encryption`.

- To enable Encryption at Rest using your Key Management for an
  existing |service| cluster, see
  :ref:`scale-cluster-enable-encryption`.

- To learn more about Encryption at Rest using your Key Management in
  |service|, see :ref:`security-kms-encryption`.

.. class:: hidden

   .. toctree::
      :titlesonly:

      /tutorial/security-azure-kms-rotate-key
