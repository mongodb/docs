===================================
Restore a Replica Set from a Backup
===================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

When you restore a replica set from backup, |mms| provides you with a
restore file for the selected restore point. For an overview of the
restore process, please see :doc:`/core/restore-overview`.

Prerequisites
-------------

Oplog Size
++++++++++

To seed each replica set member, you will use the :file:`seedSecondary.sh`
or :file:`seedSecondary.bat` script included in the backup restore file. 
When you run the script, you will provide the replica set's oplog size, 
in gigabytes.

.. seealso::
   See the **Check the Size of the
   Oplog** section of the :manual:`Troubleshoot Replica Sets </tutorial/troubleshoot-replica-sets>` if you do not have the size.

Client Requests During Restoration
++++++++++++++++++++++++++++++++++

.. include:: /includes/considerations-restore-in-isolation.rst

Secure Copy (``scp``) Delivery
++++++++++++++++++++++++++++++

If you intend to delivery using ``scp``, you must 
:doc:`generate a key pair </tutorial/generate-key-pair-for-scp-restores>` 
before attempting to deliver the files. Windows machines do not come with 
``scp`` and require additional installation and configuration.

.. important::

   When copying files individually, the ``MaxStartups`` value in
   ``sshd_config`` should be increased to:

   (4 Ã— (number of shards + number of config servers)) + 10

   ``scp`` is performed in parallel and, by default, ``sshd`` installations
   use a small number of concurrent connections. Changing this setting allows
   ``scp`` to support sufficient connections to complete the restore.

   .. example::

      You are restoring a sharded cluster with 7 shards and 3 config servers.
      This would result in needing a ``MaxStartups`` value of ``50``.

      ``MaxStartups  50``

Procedures
----------

To have |mms| automatically restore the backup, perform the :ref:`select
the snapshot <select-snapshot-replica-set>` procedure.

To instead manually restore the backup, perform all the procedures below
in sequence. If you restore to existing hardware, use a different data
directory than used previously. 

.. seealso::
   See :manual:`Restore a Replica Set from a Backup </tutorial/restore-replica-set-from-backup>` 
   for alternative approaches to restoring replica sets.

.. _select-snapshot-replica-set:

Select the Snapshot
+++++++++++++++++++

.. include:: /includes/steps/download-snapshot-replica-set.rst

Restore the Primary
+++++++++++++++++++

You must have a copy of the snapshot on the server that provides the
primary. Use this procedure only for manual restores.

.. include:: /includes/steps/restore-primary.rst

Restore Each Secondary
++++++++++++++++++++++

After you have restored the primary you can restore all
secondaries. You must have a copy of the snapshot on all servers that
provide the secondaries. Use this procedure only for manual restores.

.. include:: /includes/steps/restore-secondary.rst
