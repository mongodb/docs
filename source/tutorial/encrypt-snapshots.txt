==========================
Encrypted Backup Snapshots
==========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Starting in 3.4, |onprem| supports encryption for any backup job that
uses :manual:`WiredTiger
</core/security-encryption-at-rest/#encrypted-storage-engine>`.

With encrypted backup, you encrypt the head databases using a master
key that is generated and maintained by a Key Management
Interoperability Protocol (KMIP) compliant key management appliance
(i.e. KMIP server). Because the Backup Daemon creates snapshots from
the head databases, resulting snapshots from the encrypted head
databases are themselves encrypted.

To restore from an encrypted backup, you need the same master key used
to encrypt the backup and either the same certificate as is on the
Backup Daemon server or a new certificate provisioned with that key
from the KMIP server..

Prerequisites
-------------

- Head databases use version 3.2 or greater of MongoDB with WiredTiger.

- Key Management Interoperability Protocol (KMIP) compliant key
  management appliance (i.e. KMIP server) to generate and store
  encryption keys.

- A valid KMIP client certificate and KMIP server Certificate Authority
  (CA) files. These files are used to authenticate |onprem| to the KMIP
  server. The client certificate on the Backup Daemon server must have
  access to all keys in the KMIP server.

.. important::

   - You must maintain all keys, even rotated keys, in the KMIP server.

.. _setup-kmip-server-conf:

Set up KMIP Server Configuration for |onprem|
---------------------------------------------

.. include:: /includes/steps/set-kmip-values.rst

.. _configure-group-kmip:

Configure Your Group to Use KMIP
--------------------------------

.. note::

   All deployments in the group will use the same KMIP client
   certificate file to authenticate.

.. include:: /includes/steps/set-group-kmip-values.rst

Encrypt Your Backup Job
-----------------------

.. important::
   
   For existing backups in a group, enabling encryption requires an
   initial backup sync to recreate the backups' head databases.

.. include:: /includes/steps/enable-backup.rst
