.. _aggregation-pipeline-sharded-collection:

============================================
Aggregation Pipeline and Sharded Collections
============================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

The aggregation pipeline supports operations on :term:`sharded
<sharded cluster>` collections. This section describes behaviors
specific to the :ref:`aggregation pipeline <aggregation-pipeline>` and
sharded collections.

Behavior
--------

When operating on a sharded collection, the aggregation pipeline is
split into two parts. The first pipeline runs on each shard, or if an
early :pipeline:`$match` can exclude shards through the use of the
shard key in the predicate, the pipeline runs on only the relevant
shards.

The second pipeline consists of the remaining pipeline stages and runs
on the :binary:`~bin.mongos`. The :binary:`~bin.mongos` merges the cursors from
the other shards and runs the second pipeline on these results.

When splitting the aggregation pipeline into two parts, the pipeline is
split to ensure that the shards perform as many stages as possible.

Impact of Aggregation Pipelines on ``mongos``
---------------------------------------------

.. versionchanged:: 2.2

Some :dbcommand:`aggregation pipeline <aggregate>` operations will
cause :binary:`~bin.mongos` instances to require more CPU resources
than in previous versions. This modified performance profile may
dictate alternate architectural decisions if you use the
:ref:`aggregation pipeline <aggregation-pipeline>` extensively in
a sharded environment.
