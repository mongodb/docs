===================================
Configure Cloud Service Integration
===================================

.. default-domain:: mongodb

Overview
--------

You can configure |mms| to integrate with a supported cloud service
provider to provision servers directly through |mms|. |mms| supports
automated provisioning of Amazon Web Services EC2 instances and Microsoft
Azure virtual machines. Servers provisioned through |mms| come with the
Automation Agent pre-installed and are ready for deployment of MongoDB
instances.

Prerequisites
-------------

You must have an existing account with the cloud service provider. You
must also meet the following prerequisites specific to your provider:

- :ref:`prerequisites-cloud-server-provisioning-aws`

- :ref:`prerequisites-cloud-server-provisioning-azure`

.. _prerequisites-cloud-server-provisioning-aws:

Prerequisites for AWS
~~~~~~~~~~~~~~~~~~~~~

To configure |mms| for Amazon Web Services (AWS) integration, you must first meet the following
prerequisites.

AWS Access Keys
```````````````
Access keys are **not** required if you use AWS's
cross-account access.

If you choose to authenticate to AWS through keys, then you must be able
to provide the following keys when configuring |mms| for AWS provisioning:

- The AWS account's Access Key ID and Secret Access Key. To access the
  keys, click your username in the top right corner of AWS and select
  *Security Credentials*.

- An SSH public key for the computer that accesses |mms|. When you
  :doc:`provision a server </tutorial/provision-cloud-servers>`, |mms|
  adds that public key to the authorized key file on the newly
  provisioned machine, allowing you to connect to the server through
  SSH. You provide the public key when you configure |mms| to provision
  servers through AWS.

.. _security-group:

AWS Security Group
``````````````````

The AWS account must have at least one :ref:`security group
<security-group>` configured. At minimum, the security group must have the
following inbound rules:

- A custom TCP rule that allows all members of the security group to
  access the MongoDB processes.

- An SSH rule on the SSH port, usually 22, and that allows traffic from
  all IPs.

  If you do not want to grant SSH access to all IPs, you must instead
  grant SSH access to the following ranges:

  - ``4.71.186.128/25``

  - ``4.35.16.128/25``

Optionally, add additional rules to your security group as needed. For
example, to grant access to MongoDB from hosts in another security group,
add a custom TCP rule that specifies the MongoDB ports and the other
security group. To grant access from a specific IP address, such as the IP
address for a specific office, add a custom TCP rule that specifies the
MongoDB ports and the specific IP address.

In addition, for security groups that are bound to a Virtual Private Cloud
(VPC), set the outbound rules to control access to |mms|.
The outbound CIDRs required for a security group in a VPC are:

- ``54.173.82.137/32``

- ``54.175.147.155/32``

The machine being provisioned must be able to access standard package
repositories to update the machine when provisioning. Ensure
your outbound access allows for this.

AWS Virtual Private Cloud
`````````````````````````

If you are deploying into a Virtual Private Cloud (VPC), the VPC must
exist before provisioning. If you are using a VPC that you created and not
a default AWS VPC, make sure that the VPC property ``DNS hostname`` is
``yes``, which guarantees that each instance provisioned in the VPC
receives a hostname.

Note that |mms| gives a public IP to any instances created on subnets.

.. _prerequisites-cloud-server-provisioning-azure:

Prerequisites for Azure
~~~~~~~~~~~~~~~~~~~~~~~

When configuring |mms| for Azure provisioning, you must have:

- Access to your Azure account so that you can upload the |mms| management
  certificate to the account.

- Your Azure subscription ID.

Procedures
----------

To configure |mms| for integration with a cloud service, do the following:

- *AWS only*: :ref:`configure-permissions-aws-user`

- :ref:`configure-cloud-server-provisioning`

.. _configure-permissions-aws-user:

Configure Permissions for an AWS User
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The AWS user associated with the access keys must have an attached IAM
policy with the permissions described in
:doc:`/reference/required-permissions-aws-user`. Without adequate
permissions, the user cannot provision AWS servers from |mms|.

To set the permissions, do the following:

.. include:: /includes/steps/configure-permissions-aws-user.rst

.. _configure-cloud-server-provisioning:

Configure Cloud Server Provisioning
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/steps/configure-cloud-server-settings.rst
