ref: queryable-backup-duration
edition: cloud
content: |

   |mms| provisions these queryable snapshots as *read-only* MongoDB
   instances.

   .. important::

      These instances are available for up to 24 hours.

---
ref: queryable-backup-duration
edition: onprem
content: |

   |mms| provisions these queryable snapshots as *read-only* MongoDB
   instances. Specifically, |mms| spins up a :program:`mongod` with
   data from the selected snapshot store.

   .. important::

      By default, these instances are available for up to 24 hours. You
      can configure the duration using
      :setting:`Expiration (Hours) <Expiration>`.
      For other queryable backup settings, see
      :ref:`queryable-snapshot-settings`.
---
ref: queryable-backup-prerequisites
edition: onprem
content: |

   MongoDB Version Compatibility between Snapshot and Target Database
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   You can query snapshots made from :term:`replica sets <replica set>`
   or :term:`sharded clusters <sharded cluster>` with |csrs| running
   MongoDB 3.2 or later.

   For a queryable backup to succeed, the MongoDB instance that is the
   target of a restore must run a compatible MongoDB version.
   The following table lists the compatibility requirements for each
   deployment type and MongoDB version.

   **Sharded Clusters**

   .. list-table::
      :header-rows: 1

      * - Snapshot Data MongoDB Version
        - Compatible MongoDB Version for Target Database
        - Platform

      * - 4.2.x
        - 4.2.0 Enterprise or later
        - Any

      * - 4.0.x
        - 4.0.0 Enterprise or later
        - Any

      * - 3.6.x
        - 3.6.5 Enterprise or later
        - Any

      * - 3.4.x
        - 3.4.11 Enterprise or later
        - Windows

      * - 3.4.x
        - 3.4.2 Enterprise or later
        - Linux or macOS

   **Replica Sets**

   .. list-table::
      :header-rows: 1

      * - Snapshot Data MongoDB Version
        - Compatible MongoDB Version for Target Database
        - Platform

      * - 4.2.x
        - 4.2.0 Enterprise or later
        - Any

      * - 4.0.x
        - 4.0.0 Enterprise or later
        - Any

      * - 3.6.x
        - 3.4.11 Enterprise or later
        - Windows

      * - 3.6.x
        - 3.4.2 Enterprise or later
        - Linux or macOS

      * - 3.4.x
        - 3.4.11 Enterprise or later
        - Windows

      * - 3.4.x
        - 3.4.2 Enterprise or later
        - Linux or macOS

      * - 3.2
        - 3.4.11 Enterprise or later
        - Windows

      * - 3.2.x
        - 3.4.2 Enterprise or later
        - Linux or macOS

   Authentication and Authorization
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   .. important::

      .. include:: /includes/fact-out-of-scope-ssl-certs.rst

   |onprem| needs a separate |pem| file to authenticate and authorize
   use of Queryable Backup. This |pem| file:

   - Must belong to the same platform user and group that owns the
     |onprem| process. On Linux, the ``mongodb-mms:mongodb-mms`` user
     and group owns this PEM file. On Windows, use the ``SYSTEM`` user.

   - Must be readable by the platform user only.

   - Must be saved in the same location on every |onprem| host if your
     deployment :doc:`uses high availability </tutorial/configure-application-high-availability>`.

   - Must be different than the one used for |https| connections to
     |onprem| (:setting:`HTTPS PEM Key File`).

   - Should use a key length greater than 512-bit. Using a 2048-bit RSA
     key is recommended.

   - Should use a message digest stronger than ``sha1``, such as
     ``sha256``.

   At minimum, the |pem| file consists of:

   - A server certificate / key pair and
   - A |certauth| certificate / key pair

   These pairs are merged to create a |pem| file that Queryable Backup
   can use. The pairs have the following requirements:

   Certificate Authority Certificate / Key Pair
   ````````````````````````````````````````````

   The |certauth| must sign any other certs and keys to be used in the
   PEM file. The |certauth| can be one of the following:

   - A private |certauth| (self signed; recommended for test purposes).

   - An intermediate |certauth| certificate/key pair from a
     :wikipedia:`certificate provider
     </Certificate_authority#Providers>`.

   - A |certauth| that your company security team issued.

   Server Certificate / Key Pair
   `````````````````````````````

   The |certauth| that you selected must sign this server certificate.

   The Common Name setting of the server certificate/key pair depends
   on how many hosts your |onprem| deployment uses:

   a. For a single |onprem| host, the Common Name in the pair must
      match the |fqdn| of the |onprem| host.

   b. For high availability, the Common Name in the pair must match the
      |fqdn| of the load balancer |url|.

   Concatenate the server certificate / key pair and the certificate
   chain to create the Proxy Server PEM Key.

   PEM File Location
   `````````````````

   For the queryable backup host, you must specify the location of the
   PEM file (which contains both a public key certificate and its
   associated private key) using the :setting:`Proxy Server PEM File`
   setting. If you have not already set up the queryable backup
   settings:

   #. Click on :guilabel:`Admin` on the upper-right hand corner. From
      the :guilabel:`Admin` screen, click on :guilabel:`General`
      :icon:`arrow-right` :guilabel:`Ops Manager Config`
      :icon:`arrow-right` :guilabel:`Backup`.

   #. Scroll to the :guilabel:`Queryable Snapshot Configuration` and
      specify the :setting:`Proxy Server PEM File` that the tunnel or
      clients can use to connect to the queryable :program:`mongod`
      instance.

      If the file is encrypted, specify the
      :setting:`Proxy Server PEM File Password`.

   #. *Optional.* Update other queryable snapshot settings as
      appropriate. For description of the settings, see
      :ref:`queryable-snapshot-settings`.

      .. include:: /includes/extracts/queryable-backup-proxy-requirements.rst

   Open Ports for App Server
   ~~~~~~~~~~~~~~~~~~~~~~~~~

   The app server requires that ports 27700-27719 be open for
   communication with queryable backup snapshots.

   If you use a load balancer, it must pass the |tcp| connection
   through the value in the :setting:`Proxy Port`.

   To learn more about port requirements, see
   :doc:`Firewall Configuration </reference/firewall-configuration>`.


   Sufficient Workers for the |mms| Backup Daemon
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   .. include:: /includes/extracts/queryable-backup-workers.rst

   Hostname
   ~~~~~~~~

   The |fqdn| that hosts the :binary:`~bin.mongod` for the queryable
   backup must match the one found the :guilabel:`Daemons` page. To
   find that hostname, click the :guilabel:`Admin` link, then click
   :guilabel:`Backup`, and then click :guilabel:`Daemons`.

   Queryable Backup Requires Enterprise Downloads
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   If |onprem| can connect to the internet, set
   :guilabel:`Backup Versions Auto Download Enterprise Builds` to
   **TRUE**. Queryable Backups require MongoDB Enterprise.

---
ref: queryable-backup-prerequisites
edition: cloud
content: |

   Queryable backups are available for MongoDB 3.2 or later replica
   sets or MongoDB 3.2 or later sharded clusters with |csrs|.

---
ref: queryable-backup-workers
edition: onprem
content: |

  To query a snapshot of a :term:`sharded cluster`, the
  :term:`Backup Daemon` requires at least one worker for the
  :manual:`config server</core/sharded-cluster-config-servers>`, one
  worker for each :term:`shard`, and one worker for each
  :binary:`~bin.mongos` instance.

  To query a snapshot of a :term:`replica set`, the Backup Daemon
  requires at least one worker for the replica set.

  .. example::

     If you restore a queryable backup from a 3-shard cluster with
     1 shard router (:program:`mongos`), you would need this value to
     be at least ``5``:

     - 1 per shard (``3``) +
     - 1 for the config server (``1``) +
     - 1 for the :binary:`~bin.mongos`

     When the queryable backup begins, the Backup Daemon spins
     up 5 or more workers to manage these components.

---
ref: queryable-backup-workers
edition: cloud
content: ""

---
ref: queryable-backup-pem-restriction
edition: onprem
content: |

   :setting:`Proxy Server PEM File` has the following restrictions:

   - The PEM should use a key length greater than 512-bit. Using a
     2048-bit RSA key is recommended.

   - The PEM should use a message digest stronger than ``sha1``, such as ``sha256``.

---
ref: queryable-backup-pem-restriction
edition: cloud
content: ""
---
ref: queryable-backup-certificate-duration
edition: cloud
content: |

   The X.509 certificates are valid for 24 hours.

---
ref: queryable-backup-certificate-duration
edition: onprem
content: |

   The client X.509 certificate is valid for the same length of time as
   the queryable instance :setting:`Expiration (Hours) <Expiration>`,
   which is 24 hours by default.
---
ref: queryable-backup-proxy-requirements
edition: onprem
content: |

   .. note::

      You must restart the Web Server if you change any of the
      following settings:

      - :setting:`Proxy Server Port`

      - :setting:`Proxy Server PEM File`

      - :setting:`Proxy Server PEM File Password`
---
ref: queryable-backup-proxy-requirements
edition: cloud
content: ""
---
ref: queryable-backup-proxy-port
edition: onprem
content: |
   After updating :setting:`Proxy Server Port`, restart the Web
   Server for the change to take effect.
---
ref: queryable-backup-proxy-port
edition: cloud
content: ""
---
ref: queryable-backup-proxy-pem-file
edition: onprem
content: |
   After updating :setting:`Proxy Server PEM File`, restart the Web
   Server for the change to take effect.
---
ref: queryable-backup-proxy-pem-file
edition: cloud
content: ""
---
ref: queryable-backup-proxy-pem-password
edition: onprem
content: |
   After updating :setting:`Proxy Server PEM File Password`, restart
   the Web Server for the change to take effect.
---
ref: queryable-backup-proxy-pem-password
edition: cloud
content: ""

...
