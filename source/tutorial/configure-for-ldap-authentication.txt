.. _security-ldap:

===============================================================
Configure |mms| Users for LDAP Authentication and Authorization
===============================================================


.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

You can use a Lightweight Directory Access Protocol (LDAP) service to
manage |mms| user authentication and authorization. Users log in
through |mms|, then |mms| searches the LDAP directory for the user and
synchronizes the user's name and email addresses in the |mms| user
records with the values in the LDAP user records.

To configure |mms| to use LDAP, go to: :guilabel:`Admin` >
:guilabel:`General` > :guilabel:`Ops Manager Config` > :guilabel:`User
Authentication`.

.. note::

   This tutorial describes authenticating users of the |mms| web
   interface.

   If your MongoDB deployments **also** use LDAP, you must separately
   create MongoDB users for the |mms| agents, as described in
   :doc:`/tutorial/configure-monitoring-agent-for-ldap` and
   :doc:`/tutorial/configure-backup-agent-for-ldap`.

This tutorial describes how to:

* Configure LDAP authentication for |mms|

* Map LDAP groups to both |mms| :ref:`organization-roles` and :ref:`project-roles`
  

User Authentication
~~~~~~~~~~~~~~~~~~~

When a user attempts to log in, |mms| searches for a matching user and
the user's groups using an LDAP query.

- |mms| logs into LDAP as the ``search`` user, using the credentials
  specified in the :guilabel:`LDAP Bind Dn` and :guilabel:`LDAP Bind
  Password` fields.

- |mms| searches under the base distinguished name specified in
  the :guilabel:`LDAP User Base Dn` field and matches the user
  according to the LDAP attribute specified in the :guilabel:`LDAP User
  Search Attribute` field.

- |mms| searches under the base distinguished name specified in the
  :guilabel:`LDAP Group Base Dn` field and matches the user's groups
  according to the LDAP attribute specified in the :guilabel:`LDAP Group
  Member Attribute` field. If no value is provided for the :guilabel:`LDAP
  Group Base Dn`, |mms| uses the value of :guilabel:`LDAP User Base Dn`
  to search for LDAP group memberships.

- If a matching user is found, |mms| authenticates the supplied
  password against the LDAP password for the provided user.

Authorization/Access Control
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

LDAP groups let you control access to |mms|. You associate LDAP groups
with organization and project |mms| roles and assign the LDAP groups
to the users who should have those roles.

LDAP entries map to |mms| records as follows: 

.. list-table:: 
   :header-rows: 1

   * - LDAP
     - |mms|

   * - User
     - User

   * - Group
     - Organization/Project Role

To use LDAP groups effectively, 
:doc:`create additional projects </tutorial/manage-projects>`
within |mms| to control access to specific deployments in your
organization, such as creating separate |mms| projects for development
and production environments. You can then map an LDAP group to a role
in the |mms| project to provide access to a deployment.

.. note::

   - Changes made to LDAP groups can take up to an hour to take effect 
     in |mms|. Changes take effect immediately for users in affected 
     groups when they log out and log back in to |mms|.

   - If an LDAP user does not belong to any LDAP group, |mms| does not
     assign any roles, organization or project, to the user.

   - If an LDAP user is assigned a project role but no organization role,
     |mms| automatically assigns the user the :ref:`Organization Member
     Role<organization-member-role>`.

If you have multiple departments with their own billing needs, alert settings,
and project members, create a new :doc:`organization </tutorial/manage-organizations>`
for each department.


.. _ldap-over-ssl:

LDAP Over SSL
~~~~~~~~~~~~~

If you use LDAP over an SSL connection (LDAPS), complete these fields:

.. list-table::
   :header-rows: 1
   :widths: 30 70

   * - Field
     - Needed Value

   * - :guilabel:`LDAP SSL CA File`
     - The path to a PEM key file for a trusted certificate authority.

   * - :guilabel:`LDAP SSL PEM Key File`
     - The path to a PEM key file containing a client certificate and
       private key.

   * - :guilabel:`LDAP SSL PEM Key File Password`
     - The password to decrypt it if the
       :guilabel:`LDAP SSL PEM Key File` is encrypted.

Prerequisites
-------------

The LDAP server must:

- Be installed, configured and accessible to |mms|.

- Embed each user's group memberships as an attribute of each user's
  LDAP Entry.

  .. important::

     Use the ``member`` LDAP user attribute if you want to include LDAP nested
     groups in |mms| group memberships. 

     .. example::
        LDAP user ``jsmith`` belongs to LDAP group ``B``. LDAP Group ``B`` belongs
        to LDAP group ``A``. Ops Manager recognizes ``jsmith`` as a member of groups
        ``A`` and ``B``.
     

- Include a user that can search the needed base distinguished name(s)
  that have the users and groups that use |mms|.

- Include a group that you can specify in the |mms| 
  :guilabel:`LDAP Global Role Owner` field. 

  - The first user to log into |mms| with LDAP authentication must
    belong to this LDAP group.

  - This user will also create the initial |mms| project.

  .. example:: 
     If LDAP has an ``admin`` group for use by |mms| administrators,
     enter ``admin`` in the :guilabel:`LDAP Global Role Owner` field.

.. _ldap-new-vs-convert:

Using LDAP from the Fresh Install vs. Converting to LDAP
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

All prerequisites apply to either scenario. The additional requirements
are:

.. list-table:: 
   :header-rows: 1
   :widths: 50 50

   * - Fresh LDAP Install
     - Conversion to LDAP

   * - The Global Owner to be the first user created.
     - The Global Owner exist in both LDAP and |mms| and belong to the
       LDAP group that will map to the |mms| Global Owner role.

.. important:: 

   Once |mms| is converted to LDAP Authentication, only the user with
   the Global Owner role changing the authentication method remains
   logged into |mms|. All other users are logged off and need to log
   back into |mms| using their LDAP username and password. Any users
   without an LDAP username and password can no longer log into |mms|.

.. _config-ldap-auth:

Procedure
---------

To configure LDAP authentication:

.. include:: /includes/steps/configure-ldap-authentication.rst

Troubleshooting
---------------

|mms| enables endpoint detection by default in the |jdk|. You must use
trusted server certificates for your |mms| hosts.

If you can't use trusted certificates:

1. Disable endpoint identification. Add the
   ``-Dcom.sun.jndi.ldap.object.disableEndpointIdentification=true`` to
   the ``JAVA_MMS_UI_OPTS`` property in the ``mms.conf``.
2. Restart all |mms| services after this change.

.. warning::

   Disabling this functionality impacts |mms| security. You should
   configure a valid and trusted certificate instead.
