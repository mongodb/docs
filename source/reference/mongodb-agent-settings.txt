======================
{+mdbagent+} Settings
======================

.. default-domain:: mongodb

.. include:: /includes/styles/corrections.rst

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. tabs-pillstrip:: platforms

This page describes possible settings for the {+mdbagent+}. These
values are set after first launching |mms| and not through manual
editing of these files.

.. cond:: onprem

   See :doc:`/reference/configuration/` for the
   |mms| settings and their values.

.. warning::

   If you edit authentication or |tls| settings through
   :guilabel:`Settings` or :guilabel:`Deployments` in the |mms|
   interface, those changes overwrite any manual changes in this
   configuration file.

.. _mongodb-agent-config-file-location:

Configuration File & Settings Locations
---------------------------------------

.. include:: /includes/list-table-mongodb-agent-conf-file-locations.rst

You can configure additional :ref:`{+magent+} settings
<mongodb-agent-monitoring-settings>` and :ref:`{+bagent+} settings
<mongodb-agent-backup-settings>` through the |mms| UI.

.. _mongodb-agent-settings-main:

{+mdbagent+} Settings
----------------------

.. cond:: cloud

   The following settings are required. All other settings are set to
   default values.

   .. setting:: mmsGroupId

      *Type*: string

      *Required*.

      Specifies the ID of your |mms| project. In |mms|, click
      :guilabel:`Deployments`, then :guilabel:`Agents` and then select
      the appropriate operating system under :guilabel:`Downloads &
      Settings`.

      When the :guilabel:`Install Agent Instructions` box appears,
      these values can be copied directly from this box by clicking
      :icon-fa5:`copy`.

      .. code-block:: ini

         mmsGroupId=8zvbo2s2asigxvmpnkq5yexf

   .. setting:: mmsApiKey

      *Type*: string

      *Required*.

      Specifies the |mms| agent |api| key of your |mms| project.

      .. include:: /includes/extracts/agent-api-key-specify.rst

      .. note::

         To enable the MongoDB Agent to request the Agent API Key from a shell
         command, set the :setting:`mmsApiKeyExec` option in the configuration file
         rather than setting the setting:`mmsApiKey` option.

      .. code-block:: ini

         mmsApiKey=8zvbo2s2asigxvmpnkq5yexf

   .. _mmsBaseUrl:

   .. setting:: mmsBaseUrl

      *Type*: string

      .. include:: /includes/extracts/automation-agent-configuration-mmsbaseurl.rst

.. cond:: onprem

   The following required settings vary depending on whether or not you
   use server pools. All other settings are set to default values.

   .. tabs::

      tabs:
        - id: project
          name: Projects
          content: |

            .. setting:: mmsGroupId

               *Type*: string

               *Required*.

               Specifies the ID of your |mms| project. In |mms|, click
               :guilabel:`Deployments`, then :guilabel:`Agents` and
               then select the appropriate operating system under
               :guilabel:`Downloads & Settings`.

               When the :guilabel:`Install Agent Instructions` box
               appears, these values can be copied directly from this
               box by clicking :icon-fa5:`copy`.

               This setting is usually set when the {+mdbagent+} is
               installed and is required to bind the server to a
               project.

               .. code-block:: ini

                  mmsGroupId=8zvbo2s2asigxvmpnkq5yexf

            .. setting:: mmsApiKey

               *Type*: string

               *Required*.

               Specifies the |mms| agent |api| key of your |mms|
               project.

               .. include:: /includes/extracts/agent-api-key-specify.rst

               This setting is usually set when the {+mdbagent+} is
               installed and is required to bind the server to a
               project.

               .. note::

                  You can specify the password from a shell
                  command by using the
                  :setting:`mmsApiKeyExec` option instead of
                  :setting:`mmsApiKey`.

               .. code-block:: ini

                  mmsApiKey=8zvbo2s2asigxvmpnkq5yexf

            .. important::

               Do not configure the Server Pool settings:

               - :setting:`serverPoolKey`
               - :setting:`serverPoolPropertiesFile`
               - :setting:`serverPoolStateFile`

        - id: server-pool
          name: Server Pools
          content: |

            .. include:: /includes/fact-server-pools-deprecated.rst

            .. setting:: serverPoolKey

               *Type*: string

               *Required*.

               Specifies the Server Pool Key.

               .. include:: /includes/extracts/server-pool-key.rst

               .. code-block:: ini

                  serverPoolKey=somekeyabc123

            .. setting:: serverPoolPropertiesFile

               *Type*: string

               *Required*.

               Specifies the full filepath of a file that contains
               server properties.

               .. include:: /includes/extracts/server-pool-properties-file.rst

               Ensure the {+mdbagent+} can read the file:

               .. code-block:: sh

                  chmod 755 /path/to/some/propertiesfile.txt

               .. code-block:: ini

                  serverPoolPropertiesFile=/path/to/some/propertiesfile.txt

            .. setting:: serverPoolStateFile

               Specifies the full filepath of the file to be used by
               the {+mdbagent+}. Required if adding the server to a
               server pool.

               .. include:: /includes/extracts/server-pool-state-file-permission.rst

               .. code-block:: ini

                  serverPoolStateFile=/path/to/some/statefile.txt

            .. _mmsBaseUrl:

            .. setting:: mmsBaseUrl

               *Type*: string

               *Required*.

               .. include:: /includes/extracts/mongodb-agent-configuration-mmsbaseurl.rst

            .. important::

               Do not configure the Project settings:

               - :setting:`mmsGroupId`
               - :setting:`mmsApiKey`

.. _mongodb-agent-logging-settings:

Logging Settings
~~~~~~~~~~~~~~~~

.. setting:: logFile

   *Type*: string

   Specifies the path to which |mms| should write the {+mdbagent+}'s
   log.

   The default path depends on your platform. The {+mdbagent+} uses the
   default filename ``automation-agent.log`` whether or not the
   deployment uses {+aagent+}.

   .. list-table::
      :header-rows: 1
      :widths: 20 80

      * - Platform
        - Default Path

      * - Linux
        - ``/var/log/mongodb-mms-automation/automation-agent.log``

      * - Windows
        - ``C:\MMSAutomation\log\mongodb-mms-automation\automation-agent.log``

   .. code-block:: ini

      logFile=/path/to/mongodb-mms-automation/automation-agent.log

.. setting:: logLevel

   *Type*: string

   Specifies the level of logging granularity.

   Choose from the following severity levels, from most to least
   amount of information:

   - ``DEBUG``
   - ``INFO``
   - ``WARN``
   - ``ERROR``
   - ``FATAL``

   By default, :setting:`logLevel` is ``INFO``.

   .. code-block:: ini

      logLevel=ROUTINE

   Each level includes the log items included in the succeeding levels.

   .. example::

      - If you choose ``DEBUG``, the {+mdbagent+} logs all
        messages, including ``INFO``, ``WARN``, ``ERROR``
        and ``FATAL``.

      - If you choose ``FATAL``, the {+mdbagent+} only logs
        ``FATAL`` messages.

.. setting:: maxLogFiles

   *Type*: integer

   Specifies the maximum number of rotated log files to retain.

   By default, :setting:`maxLogFiles` is ``10``. You can change the
   value to retain a different quantity of rotated log files.

   .. code-block:: ini

      maxLogFiles=15

.. setting:: maxLogFileDurationHrs

   *Type*: float

   Specifies the number of hours after which the logs are rotated.

   .. admonition:: Manually Rotate the {+mdbagent+} Logs
      :class: note

      On UNIX- and Linux-based systems you can manually rotate the
      {+mdbagent+} logs. Issue a :code:`kill` command with the
      :code:`SIGUSR1` signal for the Agent process:

      .. code-block:: sh

         kill -SIGUSR1 <AgentID>

      On Windows-based systems, you can manually restart the
      {+mdbagent+} with a Service restart:

      1. Click the :guilabel:`Start` menu.
      #. Search for ``services``.
      #. Find the {+mdbagent+}.
      #. Right-click on the Agent and click :guilabel:`Restart`.

      This rotates the {+mdbagent+} logs.

.. setting:: maxLogFileSizeBytes

   *Type*: integer

   Specifies the maximum size, in bytes, of a log file before the logs
   are rotated. If unspecified, the {+mdbagent+} does not rotate
   logs based on file size.

   .. code-block:: ini

      maxLogFileSizeBytes=536870912

.. _mongodb-agent-connection-settings:

Connection Settings
~~~~~~~~~~~~~~~~~~~

.. setting:: dialTimeoutSeconds

   *Type*: integer

   Specifies the number of seconds to wait before a connection times
   out. By default, connections time out after 40 seconds. However, The
   {+mdbagent+} may frequently time out of connections for one or
   more of the following reasons:

   - High network latency

   - High server load

   - Large |tls| keys

   - Lack of |tls| accelerator

   - Insufficient CPU speed

   MongoDB recommends gradually increasing the value of the
   :setting:`dialTimeoutSeconds` {+mdbagent+} configuration setting
   to prevent frequent premature connection timeouts.

   .. code-block:: ini

      dialTimeoutSeconds=40

   .. note::
      Increasing this value also increases the time required to deploy
      configuration changes to the {+mdbagent+}. Experiment with
      small, incremental increases until you determine the optimum
      value for your deployment.

.. setting:: serverSelectionTimeoutSeconds

   *Type*: integer

   Specifies the number of seconds the {+mdbagent+} waits before it 
   stops trying to establish a connection to a MongoDB process. By 
   default, the {+mdbagent+} abandons attempts to establish a connection 
   after 10 seconds.

   .. code-block:: ini

      serverSelectionTimeoutSeconds=10

HTTP Proxy Settings
~~~~~~~~~~~~~~~~~~~

.. setting:: httpProxy

   *Type*: string

   Specifies the URL of an |http| proxy server the {+mdbagent+} can
   use.

   .. code-block:: ini

      httpProxy=http://proxy.example.com:8080

Configuration Backup Settings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. setting:: mmsConfigBackup

   *Type*: string

   Specifies the path to the |mms| :ref:`configuration
   <automation-configuration-sample-entity>` backup file. This file
   describes the desired state of the deployment.

   .. code-block:: ini

      mmsConfigBackup=/path/to/mms-cluster-config-backup.json

   .. note::

      When |onprem| is installed, it stores the configuration backup
      file is stored in one of the following places, depending on your
      platform:

      .. list-table::
         :header-rows: 1
         :widths: 20 80

         * - Platform
           - Configuration Backup File Path

         * - Linux
           - ``/var/lib/mongodb-mms-automation/``

         * - Windows
           - ``%SystemDrive%\MMSAutomation``

.. _mongodb-agent-ssl-settings:
.. _mongodb-agent-tls-settings:

|mms| |tls| Settings
~~~~~~~~~~~~~~~~~~~~

Specify the settings that the {+mdbagent+} uses when communicating
with |mms| using |tls|.

.. setting:: httpsCAFile

   *Type*: string

   Specifies the *absolute* path that contains the trusted |certauth|
   certificates in ``PEM`` format. This certificate verifies that the
   {+mdbagent+} is talking to the designated |mms| instance.

   .. code-block:: ini

      httpsCAFile=/path/to/ca.pem

   .. note::

      Add the |certauth| for the ``downloads.mongodb.com`` certificate
      to this ``.pem`` file if you:

      1. Need your {+mdbagent+}s to download their MongoDB installers
         from the Internet,

      #. Use TLS to encrypt connections, and

      #. Signed your certificates with a private CA. (You set the
         ``httpsCAFile`` option.)

      To learn how to download TLS certificates from another web site,
      see the `OpenSSL Cookbook entry <https://www.feistyduck.com/library/openssl-cookbook/online/ch-testing-with-openssl.html#extracting-remote-certificates>`__. 

   .. important::

      When |mms| starts, it caches the |certauth| you provided. If you 
      change your |certauth| certificate, restart |mms|.

.. setting:: sslRequireValidMMSServerCertificates

   *Type*: boolean

   .. important::
      
      Deprecated. Use :setting:`tlsRequireValidMMSServerCertificates` 
      instead.

.. setting:: tlsRequireValidMMSServerCertificates

   *Type*: boolean

   Specifies if the {+mdbagent+} should validate |tls| certificates
   presented by |mms|.

   .. warning::

      Setting this option to ``false`` disables certificate
      verification and makes connections between the {+mdbagent+}
      and |mms| susceptible to *man-in-the-middle*
      attacks. Setting this option to ``false`` is only recommended for
      testing purposes.

   .. code-block:: ini

      tlsRequireValidMMSServerCertificates=true      

.. additional settings are in the following extracts file:

.. include:: /includes/extracts/mongodb-agent-configuration-ssl.rst

.. _mongodb-agent-external-config-settings:

Externally Sourced Configuration Settings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. setting:: enableLocalConfigurationServer

   *Type*: boolean

   Specifies whether the {+mdbagent+} stores MongoDB process
   configuration files on disk or cached in memory.

   This option defaults to ``false``, which stores the
   configuration files on disk. Setting this option to ``true`` caches
   the configuration in memory.

   .. warning::

      Setting this option to ``true`` impacts the availability of your
      deployment.

      .. include:: /includes/consideration-external-config-impacts-availability.rst

   .. code-block:: ini

      enableLocalConfigurationServer=false

   .. seealso:: :doc:`/reference/mongodb-agent-external-configuration`

.. setting:: localConfigurationServerPort

   *Type*: integer

   Specifies the port to serve the MongoDB process configuration to when
   using the local configuration server. To set this option,
   :setting:`enableLocalConfigurationServer` must be ``true``.

   If unspecified, the {+mdbagent+} chooses an available port
   automatically.

   .. code-block:: ini

      localConfigurationServerPort=20128

.. setting:: mmsApiKeyExec

   *Type*: string

   Specifies a shell command to call the |mms| agent |api| key of your
   |mms| project .

   .. code-block:: ini

      mmsApiKeyExec=echo $myKey

.. cond:: onprem      

   .. setting:: sslMMSServerClientCertificatePasswordExec

      *Type*: string

      .. important::
          
         Deprecated. Use :setting:`tlsMMSServerClientCertificatePasswordExec`
         instead.

   .. setting:: tlsMMSServerClientCertificatePasswordExec

      *Type*: string

      Specifies a shell command to call the password needed to decrypt the
      private key in the setting:`MMSServerClientCertificate` file. Either
      this setting or :setting:`tlsMMSServerClientCertificatePassword` is
      required when the client certificate ``PEM`` file is encrypted.

      .. code-block:: ini

         tlsMMSServerClientCertificatePasswordExec=python /path/to/PEMPassword.py

.. _mongodb-agent-automation-settings:

{+aagent+} Settings
-------------------

The following configuration settings are used for authentication in
automated clusters.

.. _mongodb-mongodb-kerberos-settings:

MongoDB Kerberos Settings
~~~~~~~~~~~~~~~~~~~~~~~~~

Specify these settings if {+aagent+} authenticates to hosts
using Kerberos. To configure Kerberos, see
:doc:`/tutorial/configure-monitoring-agent-for-kerberos`.

.. setting:: krb5ConfigLocation

   *Type*: string

   Specifies an *absolute* path to an non-system-standard location for
   the Kerberos configuration file.

   .. code-block:: ini

      krb5ConfigLocation=/path/to/krb_custom.conf

   .. include:: /includes/fact-set-krb5ccname.rst

.. setting:: backupAgentKrb5CCName

   *Type* string

   Specifies the ``KRB5CC`` environment variable that the MongoDB
   Agent sets for the {+bagent+} process. Used only to authenticate the
   {+bagent+} to your MongoDB deployment when the {+mdbagent+}
   starts the {+bagent+} function.

   .. code-block:: ini

      backupAgentKrb5CCName=/path/to/credentials_cache_file

.. setting:: monitoringAgentKrb5CCName

   *Type* string

   Specifies the ``KRB5CC`` environment variable that the MongoDB
   Agent sets for the {+magent+} function. Used only to authenticate
   {+magent+} to your MongoDB deployment when the MongoDB
   Agent starts the {+magent+} function.

   .. code-block:: ini

      monitoringAgentKrb5CCName=/path/to/credentials_cache_file

.. _mongodb-agent-monitoring-settings:

{+magent+} Settings
-------------------

Use the |mms| interface to configure {+magent+} settings.

Log Settings
~~~~~~~~~~~~

1. In the navigation, click :guilabel:`Deployment`.
#. Click the :guilabel:`Agents` tab.
#. Click :guilabel:`Downloads & Settings`.
#. In the :guilabel:`Agent Log Settings` section, click
   :icon-mms:`edit` next to :guilabel:`Monitoring Log Settings`.
#. Edit the {+magent+} log settings:

   .. list-table::
      :header-rows: 1
      :widths: 20 60 20

      * - Setting
        - Default Value
        - UI Suggested Value

      * - Linux Log File Path
        - ``/var/log/mongodb-mms-automation/monitoring-agent.log``
        -

      * - Windows Log File Path
        - ``%SystemDrive%\MMSAutomation\log\mongodb-mms-automation\monitoring-agent.log``
        -

      * - Rotate Logs
        - YES
        -

      * - Size Threshold (MB)
        - 1000
        -

      * - Time Threshold (Hours)
        - 24
        -

      * - Max Uncompressed Files
        -
        - 5

      * - Max Percent of Disk
        -
        - 2

      * - Total Number of Log Files
        - 0
        -


#. Click :guilabel:`Save`.

Custom Settings
~~~~~~~~~~~~~~~

1. In the navigation, click :guilabel:`Deployment`.
#. Click the :guilabel:`Agents` tab.
#. Click :guilabel:`Downloads & Settings`.
#. In the :guilabel:`Custom Configuration` section, next to
   :guilabel:`Edit Custom Configurations`, click :icon-mms:`edit`.
#. Enter the {+magent+} configuration setting and value.
#. Click :guilabel:`Save and Close`.

You can configure the following {+magent+} settings:

.. cond:: cloud

   - :msetting:`gssapiServiceName`
   - :msetting:`httpProxy`
   - :msetting:`krb5ConfigLocation`
   - :msetting:`krb5Keytab`
   - :msetting:`krb5Principal`
   - :msetting:`mmsApiKey`
   - :msetting:`mmsBaseUrl`
   - :msetting:`mmsGroupId`
   - :msetting:`sslClientCertificate`
   - :msetting:`sslClientCertificatePassword`
   - :msetting:`sslRequireValidServerCertificates`
   - :msetting:`httpsCAFile`
   - :msetting:`sslTrustedServerCertificates`
   - :msetting:`useSslForAllConnections`

   .. note::

      The following settings are deprecated:

      - :msetting:`enableMunin`
      - :msetting:`globalAuthPassword`
      - :msetting:`globalAuthUsername`

.. cond:: onprem

   - :msetting:`gssapiServiceName`
   - :msetting:`httpProxy`
   - :msetting:`krb5ConfigLocation`
   - :msetting:`krb5Keytab`
   - :msetting:`krb5Principal`
   - :msetting:`mmsApiKey`
   - :msetting:`mmsBaseUrl`
   - :msetting:`mmsGroupId`
   - :msetting:`sslClientCertificate`
   - :msetting:`sslClientCertificatePassword`
   - :msetting:`sslRequireValidMMSServerCertificates`
   - :msetting:`sslRequireValidServerCertificates`
   - :msetting:`sslServerClientCertificate`
   - :msetting:`sslServerClientCertificatePassword`
   - :msetting:`httpsCAFile`
   - :msetting:`sslTrustedServerCertificates`
   - :msetting:`useSslForAllConnections`

   .. note::

      The following settings are deprecated:

      - :msetting:`enableMunin`
      - :msetting:`globalAuthPassword`
      - :msetting:`globalAuthUsername`

.. _mongodb-agent-backup-settings:

{+bagent+} Settings
-------------------

Use the |mms| interface to configure {+bagent+} settings.

Log Settings
~~~~~~~~~~~~

1. In the navigation, click :guilabel:`Deployment`.
#. Click the :guilabel:`Agents` tab.
#. Click :guilabel:`Downloads & Settings`.
#. In the :guilabel:`Agent Log Settings` section, click
   :icon-mms:`edit` next to: guilabel:`Backup Log Settings`.
#. Edit the {+bagent+} log settings:

   .. list-table::
      :header-rows: 1
      :widths: 20 60 20

      * - Setting
        - Default Value
        - UI Suggested Value

      * - Linux Log File Path
        - ``/var/log/mongodb-mms-automation/backup-agent.log``
        -

      * - Windows Log File Path
        - ``%SystemDrive%\MMSAutomation\log\mongodb-mms-automation\backup-agent.log``
        -

      * - Rotate Logs
        - YES
        -

      * - Size Threshold (MB)
        - 1000
        -

      * - Time Threshold (Hours)
        - 24
        -

      * - Max Uncompressed Files
        -
        - 5

      * - Max Percent of Disk
        -
        - 2

      * - Total Number of Log Files
        - 0
        -

#. Click :guilabel:`Save`.

Custom Settings
~~~~~~~~~~~~~~~

1. In the navigation, click :guilabel:`Deployment`.
#. Click the :guilabel:`Agents` tab.
#. Click :guilabel:`Downloads & Settings`.
#. In the :guilabel:`Custom Configuration` section, next to
   :guilabel:`Edit Custom Configurations`, click :icon-mms:`edit`.
#. Enter a {+bagent+} configuration setting and value.
#. Click :guilabel:`Save and Close`.

You can configure the following {+bagent+} settings:

.. cond:: cloud

   - :bsetting:`gsappiServiceName`
   - :bsetting:`httpProxy`
   - :bsetting:`https`
   - :bsetting:`krb5ConfigLocation`
   - :bsetting:`krb5Keytab`
   - :bsetting:`krb5Principal`
   - :bsetting:`mmsApiKey`
   - :bsetting:`mmsGroupId`
   - :bsetting:`mothership`
   - :bsetting:`mothershipResponseHeaderTimeout`
   - :bsetting:`sslClientCertificate`
   - :bsetting:`sslClientCertificatePassword`
   - :bsetting:`sslRequireValidServerCertificates`
   - :bsetting:`sslTrustedMMSBackupServerCertificate`
   - :bsetting:`sslTrustedServerCertificates`

.. cond:: onprem

   - :bsetting:`gsappiServiceName`
   - :bsetting:`httpProxy`
   - :bsetting:`https`
   - :bsetting:`krb5ConfigLocation`
   - :bsetting:`krb5Keytab`
   - :bsetting:`krb5Principal`
   - :bsetting:`mmsApiKey`
   - :bsetting:`mmsGroupId`
   - :bsetting:`mothership`
   - :bsetting:`mothershipResponseHeaderTimeout`
   - :bsetting:`sslClientCertificate`
   - :bsetting:`sslClientCertificatePassword`
   - :bsetting:`sslRequireValidMMSBackupServerCertificate`
   - :bsetting:`sslRequireValidServerCertificates`
   - :bsetting:`sslServerClientCertificate`
   - :bsetting:`sslServerClientCertificatePassword`
   - :bsetting:`sslTrustedMMSBackupServerCertificate`
   - :bsetting:`sslTrustedServerCertificates`
