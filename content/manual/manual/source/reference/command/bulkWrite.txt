============================
bulkWrite (database command)
============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Definition
----------

.. dbcommand:: bulkWrite

.. versionadded:: 8.0

.. include:: /includes/bulkWrite-introduction.rst

To specify each collection in the ``bulkWrite`` command, use a
:term:`namespace` (database and collection name).

Compatibility
-------------

This command is available in deployments hosted in the following environments: 

.. include:: /includes/fact-environments-atlas-only.rst

.. include:: /includes/fact-environments-atlas-support-all.rst

.. include:: /includes/fact-environments-onprem-only.rst

Syntax
------

The command has this syntax:

.. code-block:: javascript
   
   db.adminCommand( {
      bulkWrite: 1,

      // Include the insert, update, and delete operations
      // in the ops array
      ops: [
         {
            insert: <integer>,  // Namespace ID index for insert operation.
                                // Must match a namespace ID index in
                                // ns specified later in the nsInfo array.
            document: <document>
         },
         {
            update: <integer>,  // Namespace ID index for update operation
            filter: <document>,
            updateMods: <document>,
            arrayFilters: [ <filterDocument0>, <filterDocument1>, ...  ],
            multi: <bolean>,
            hint: <document>,
            constants: <document>,
            collation: <document>
         },
         {
            delete: <integer>,  // Namespace ID index for delete operation
            filter: <document>,
            multi: <boolean>,
            hint: <document>,
            collation: <document>
         },
         ...
         // Additional insert, update, and delete operations in any order
         ...
      ],

      // Include the namespaces with collections to modify
      // in the nsInfo array. You can add multiple namespaces here.
      nsInfo: [
         {
            ns: <string>,  // Namespace (database and collection name) to modify.
                           // Each operation namespace ID index
                           // specified in the earlier ops array must
                           // match a namespace ID index here.
            collectionUUID: <string>,
            encryptionInformation: <document>
         },
         ...
         // Additional namespaces
         ...
      ],

      // Additional fields
      ordered: <boolean>,
      bypassDocumentValidation: <boolean>,
      comment: <string>,
      let: <document>,
      errorsOnly: <boolean>,
      cursor: { batchSize: <integer> },
      writeConcern: <string>
   } )

In the command syntax, you can specify multiple:

- Insert, update, and delete operations in any order in the ``ops``
  array.
- Namespaces for the operations in the ``nsInfo`` array. To match the
  operation to the namespace, use the same namespace ID index. Indexes
  start at ``0``. You can use :term:`sharded <sharding>` collections.

Command Fields
--------------

The command takes the following fields:

.. list-table::
  :header-rows: 1
  :widths: 10 15 10 65

  * - Field
    - Type
    - Necessity
    - Description

  * - ``insert``
    - integer
    - Required
    - Namespace ID index for an insert operation, which must match a
      namespace ID index in the ``ns`` field in the ``nsInfo`` array.
      Indexes start at ``0``.

  * - ``document``
    - document
    - Required
    - Document to insert into the collection.

  * - ``update``
    - integer
    - Required
    - Namespace ID index for an update operation, which must match a
      namespace ID index in the ``ns`` field in the ``nsInfo`` array.
      Indexes start at ``0``.

  * - ``filter``
    - document
    - Optional
    - :ref:`Query selector <query-selectors>` to limit the documents for
      the update or delete operation.

  * - ``updateMods``
    - document
    - Optional
    - Update operation to perform on the collection. You can specify one
      of these:

      - A document with :ref:`update operator <update-operators>`
        expressions.

      - An :ref:`aggregation pipeline <aggregation-pipeline>` in the
        form ``[ <stage1>, <stage2>, ... ]`` with stages for the
        updates.

  * - ``arrayFilters``
    - document array
    - Optional
    - Array of filter documents that specify the documents to
      modify for an update operation on an array field.

      For details, see :ref:`findAndModify-command-arrayFilters`.

  * - ``multi``
    - boolean
    - Optional
    - .. include:: /includes/bulkWrite-multi-field.rst
      
      Default is ``false``.

  * - ``hint``
    - document
    - Optional
    - :ref:`Index <indexes>` to use for the document ``filter``. If the
      index doesn't exist, the update operation returns an error.

  * - ``constants``
    - document
    - Optional
    - Constants for an :ref:`aggregation pipeline
      <aggregation-pipeline>` custom update.

  * - ``collation``
    - document
    - Optional
    - :ref:`Collation <collation>` for an update or delete operation.

  * - ``delete``
    - integer
    - Required
    - Namespace ID index for a delete operation, which must match a
      namespace ID index in the ``ns`` field in the ``nsInfo`` array.
      Indexes start at ``0``.

  * - ``ns``
    - string
    - Required
    - Namespace (database and collection) for the operations. Set the
      namespace ID index for each operation in ``ops`` to the matching
      namespace array index in ``ns``. Indexes start at ``0``.

  * - ``collectionUUID``
    - string
    - Optional
    - :abbr:`UUID (Universally unique identifier)` hexadecimal value
      that specifies the collection for the operations.

  * - ``encryptionInformation``
    - document
    - Optional
    - Encryption information schema and tokens for the operation. For
      details, see :ref:`csfle-fundamentals-create-schema`.

  * - ``ordered``
    - boolean
    - Optional
    - If ``true``, perform ordered operations. Otherwise, perform
      unordered operations.

      Ordered operations run in series. If an error occurs, any
      remaining operations are cancelled.

      Unordered operations run in parallel. If an error occurs, any
      remaining statements are run. The operations may be reordered by
      the server to increase performance. Therefore, your applications
      should not depend on the order of operation execution.

      Default is ``true``.

  * - ``bypassDocumentValidation``
    - boolean
    - Optional
    - If ``true``, the operation bypasses the :doc:`schema validation rules </core/schema-validation>`.
      If ``false``, the documents must be valid.
      
      Default is ``false``.

  * - ``comment``
    - string
    - Optional
    - .. include:: /includes/extracts/comment-content.rst

  * - ``let``
    - document
    - Optional
    - Document with a list of constants to reference in the operation.
      For ``let`` examples, see :ref:`update-variables-example` and
      :ref:`delete-let-example`.

  * - ``errorsOnly``
    - boolean
    - Optional
    - If ``true``, the operation only returns errors and omits
      other output.

      Default is ``false``.
      
  * - ``cursor batchSize``
    - integer
    - Optional
    - :term:`Cursor <cursor>` batch size for the ``bulkWrite`` command's
      returned results. For details, see :method:`cursor.batchSize()`.

  * - ``writeConcern``
    - string
    - Optional
    - :ref:`Write concern <write-concern>` for the operation. Omit to
      use the server default.

.. _bulkWrite-output:

Output
------

The command returns a document with these fields:

.. list-table::
   :header-rows: 1
   :widths: 25 25 50

   * - Field
     - Type
     - Description

   * - ``cursor``
     - document
     - Cursor with the command results.

   * - ``cursor.id``
     - integer
     - Cursor identifier.

   * - ``cursor.firstBatch``
     - document array
     - Results of the operations.

   * - ``cursor.firstBatch.ok``
     - integer
     - ``1`` indicates the operation was successful. Otherwise, ``0``.

   * - ``cursor.firstBatch.idx``
     - integer
     - Operation index number, which corresponds to the operation in the
       ``ops`` array. The first operation has an ``idx`` value of ``0``.

   * - ``cursor.firstBatch.code``
     - integer
     - Code number for an error.

   * - ``cursor.firstBatch.errmsg``
     - string
     - Description for an error.

   * - ``cursor.firstBatch.keyPattern``
     - document
     - Document index key specification for an error.

   * - ``cursor.firstBatch.keyValue``
     - document 
     - Document index key value for an error.

   * - ``cursor.firstBatch.n``
     - integer
     - Total number of documents affected by an operation.

   * - ``cursor.firstBatch.nModified``
     - integer
     - Number of documents modified by an update operation.

   * - ``nErrors``
     - integer
     - Number of errors for the ``bulkWrite`` command.

   * - ``nInserted``
     - integer
     - Number of inserted documents.

   * - ``nMatched``
     - integer
     - Number of matched documents.

   * - ``nModified``
     - integer
     - Number of modified documents.

   * - ``nUpserted``
     - integer
     - Number of upserted documents.

   * - ``nDeleted``
     - integer
     - Number of deleted documents.

   * - ``ok``
     - integer
     - ``1`` indicates the ``bulkWrite`` command was successful.
       Otherwise, ``0``.

.. note::

   The output fields may vary depending on the operations you run in the
   ``bulkWrite`` command.

Behavior
--------

This section describes the ``bulkWrite`` command behavior.

Multiple Document Field and Retryable Writes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/bulkWrite-multi-field.rst

To enable retryable writes, see :ref:`retryable writes
<retryable-writes>`.

You can use ``bulkWrite`` insert operations with retryable writes and
the ``multi`` field set to ``true``.

You can use ``bulkWrite`` update and delete operations with the
``multi`` field set to ``true``. But, you cannot use update or delete
operations with both ``multi`` set to ``true`` and retryable writes.

Write Concern Errors in Sharded Clusters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. |cmd| replace:: :dbcommand:`bulkWrite`
.. include:: /includes/fact-update-writeConcernError-mongos.rst

Operation Performance
~~~~~~~~~~~~~~~~~~~~~

If you rewrite existing insert, update, and delete commands as a
``bulkWrite`` command and set ``errorsOnly`` to ``true``, the
``bulkWrite`` command has similar performance as the existing commands.
If you set ``errorsOnly`` to ``false``, performance is worse.

In addition, if you have a sequence of commands like this:

.. code-block:: javascript
   :copyable: false

   insert
   update
   delete

If you replace those commands with the following example fragment, then
the command with the following fragment is faster regardless of other
options:

.. code-block:: javascript
   :copyable: false

   {
      bulkWrite: 1, 
      ops: [
         insert,
         update,
         delete
      ]
   }

Most of the performance improvement is because of network latency, which
is variable depending on your implementation, but the example is always
faster.

Examples
--------

.. include:: /includes/sample-data-usage.rst

Single Namespace Bulk Write Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following ``bulkWrite`` example modifies a single namespace:

.. procedure::
   :style: normal

   .. step:: Modify the ``users`` collection

      Run the following ``bulkWrite`` command to perform insert, update,
      and delete operations on the ``users`` collection:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/bulkWrite/single-namespace.js
         :language: javascript
         :category: usage example

      The ``users`` collection is in the ``sample_mflix`` database, so
      the ``ns`` namespace is ``"sample_mflix.users"``. The namespace ID index
      is ``0``, which is set in the first field of the insert, update,
      and delete operations in the ``ops`` array.

   .. step:: Examine the output

      The following ``bulkWrite`` example output, with various ``ok: 1``
      fields and ``nErrors: 0``, indicates all operations were
      successful:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/bulkWrite/single-namespace-output.sh
         :language: shell
         :category: example return object
         :copyable: false

      For details about the output fields, see the earlier
      :ref:`bulkWrite-output` section.

Multiple Namespaces Bulk Write Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can specify multiple namespaces in a ``bulkWrite`` command.

The following ``bulkWrite`` example contains insert, update, and delete
operations for two namespaces:

.. procedure::
   :style: normal

   .. step:: Modify the collections

      Run the following ``bulkWrite`` command to perform insert, update,
      and delete operations on the ``users`` and ``sample_mflix.theaters`` collections:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/bulkWrite/multiple-namespaces.js
         :language: javascript
         :category: usage example

   .. step:: Examine the output

      The following ``bulkWrite`` example output indicates the
      operations were successful:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/bulkWrite/multiple-namespaces-output.sh
         :language: shell
         :category: example return object
         :copyable: false

Learn More
----------

- :ref:`server-sessions`
- :ref:`query-selectors`
- :ref:`aggregation-pipeline`
- :ref:`indexes`
- :ref:`collation`
- :ref:`retryable-writes`
- :ref:`transactions`