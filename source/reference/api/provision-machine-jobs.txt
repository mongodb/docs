======================
Provision Machine Jobs
======================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: twocols

Overview
--------

The ``provisionMachineJobs`` resource allows you to create |mms| jobs that
provision servers through an integrated cloud service provider.

For more information on |mms| integration with cloud service providers, see
:doc:`/tutorial/nav/add-servers`.

Endpoints
---------

Get Endpoints for Available Cloud Service Providers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Get the API endpoints for the cloud service providers integrated with |mms|.

.. code-block:: none

   GET /api/public/v1.0/groups/GROUP-ID/provisionMachineJobs

Get All Provisioning Jobs for a Service Provider
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Get all provisioning jobs that have been issued for a cloud service provider.
Jobs can be in any of the following states:

- ``NOT_STARTED``
- ``IN_PROGRESS``
- ``FAILED``
- ``READY``
- ``UNKNOWN``

.. code-block:: none

   GET /api/public/v1.0/groups/GROUP-ID/provisionMachineJobs/PROVIDER-NAME

``PROVIDER-NAME`` is the endpoint for the cloud service provider.

Get a Single Provisioning Job
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   GET /api/public/v1.0/groups/GROUP-ID/provisionMachineJobs/PROVIDER-NAME/JOB-ID

``PROVIDER-NAME`` is the endpoint for the cloud service provider.

Provision a Single Machine
~~~~~~~~~~~~~~~~~~~~~~~~~~

Issue a job to provision a server on a cloud service provider integrated with
|mms|. ``PROVIDER-NAME`` is the endpoint for the cloud service provider.

.. code-block:: none

   POST /api/public/v1.0/groups/GROUP-ID/provisionMachineJobs/PROVIDER-NAME

Provision Multiple Machines
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Issue a job to provision multiple machines on a cloud service provider
integrated with |mms|. Include the ``instanceCount=N`` parameter, where ``N``
is the number of machines to provision. ``PROVIDER-NAME`` is the endpoint for
the cloud service provider.

.. code-block:: none

   POST /api/public/v1.0/groups/GROUP-ID/provisionMachineJobs/PROVIDER-NAME?instanceCount=N

Sample Entity
-------------

The following is an example entity for an AWS server.

.. code-block:: javascript

   {
     "batchId": "544c98d37d84085743e99ac9",
     "created" : "2016-05-25T13:22:03Z",
     "id": "544c98d37d84085743e99aca",
     "lastUpdated" : "2016-05-25T13:25:10Z",
     "links": [ ... ],
     "parameters": {
       "availabilityZoneName" : "AWS_US_EAST_1E",
       "dataDirectory": "D:\\data",
       "dataDirectoryVolume": {
         "attachmentTypeName": "EBS",
         "deleteOnTermination": true,
         "encrypted": false,
         "mountLocation": "D:\\",
         "name": "/dev/sdf",
         "sizeGB": 50,
         "volumeTypeName": "GENERAL_EC2"
       },
       "fileSystemTypeName": "NTFS",
       "hostnamePrefix": "my-host-prefix",
       "imageId": "ami-1ab2cd34",
       "instanceTypeName": "AWS_M4_LARGE",
       "machineUser": "myUser",
       "optimizeVolumes": false,
       "providerName": "AWS",
       "regionName": "AWS_US_EAST_1",
       "rootSizeGB": 30,
       "securityGroups": [ "sg-abcd1234" ],
       "sshKeyName": "myKey",
       "subnetId": "subnet-abcd1234"
     },
     "provisionedMachineId": "544c98d47d84085743e99acf",
     "statusName": "READY"
   }

Entity Fields
-------------

|mms| returns the following information for all cloud service providers. |mms|
also returns information specific to options available for a given provider.
For provider-specific information, see the provider's documentation. For
example, for options specific to AWS servers, see the `AWS Documentation
<http://aws.amazon.com/documentation/>`_.

For operations that use the ``POST`` method, send the ``parameters`` object.

.. list-table::
   :widths: 10 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description

   * - ``batchId``
     - string
     - The batch that the job is part of.

   * - ``created``
     - timestamp
     - The date and time the job was created.

   * - ``id``
     - string
     - Unique identifier.

   * - ``lastUpdated``
     - timestamp
     - The date and time the job completed.

   * - ``parameters``
     - object

     - The configuration of the machine that the job provisions on the cloud
       service provider. Send this object for operations that use the ``POST``
       method.

       Most of the options are specific to the cloud service provider. For
       descriptions of a provider-specific options, see the provider's
       documentation. For example, for options specific to AWS servers, see
       the `AWS Documentation <http://aws.amazon.com/documentation/>`_.

       The ``parameters.dataDirectory`` is the directory where the
       :program:`mongod` instance stores its data.

   * - ``provisionedMachineId``
     - string
     - The unique identifier of the machine provisioned by the job.

   * - ``statusName``
     - string
     - The current state of the job. The job can be one of the following states:

       - ``NOT_STARTED``
       - ``IN_PROGRESS``
       - ``FAILED``
       - ``READY``
       - ``UNKNOWN``

Links
-----

.. list-table::
   :header-rows: 1

   * - Relation
     - Description

   * - ``self``
     - Me.

   * - ``http://mms.mongodb.com/group``
     - The group the provisioned machine belongs to.

   * - ``http://mms.mongodb.com/provisionMachineJobs``
     - Jobs in the same batch.

   * - ``http://mms.mongodb.com/provisionedMachines``
     - Machines in the ``READY`` state.

Examples
--------

Get Endpoints for Available Cloud Service Providers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request
```````

.. code-block:: none

   curl -u "username:apiKey" --digest -i "https://cloud.mongodb.com/api/public/v1.0/groups/5421e044e4b09da19248b17f/provisionMachineJobs"

Response
````````

.. code-block:: none

   HTTP/1.1 200 OK

   {
     "links" : [
       ...,
       {
         "href" : "https://cloud.mongodb.com/api/public/v1.0/groups/5421e044e4b09da19248b17f/provisionMachineJobs/AWS",
         "rel" : "http://mms.mongodb.com/machineConfigOptions"
       }
     ]
   }

Get All Provisioning Jobs for a Service Provider
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request
```````

.. code-block:: none

   curl -u "username:apiKey" --digest -i "https://cloud.mongodb.com/api/public/v1.0/groups/5421e044e4b09da19248b17f/provisionMachineJobs/AWS"

Response
````````

.. code-block:: none

   HTTP/1.1 200 OK

   {
     "results" : [
       {
         "batchId" : "54885451e4b03042efe4b4c8",
         "created" : "2016-05-25T13:22:03Z",
         "id" : "54885451e4b03042efe4b4cc",
         "lastUpdated" : "2016-05-25T13:25:10Z",
         "links" : [ ... ],
         "parameters" : {
           "availabilityZoneName" : "AWS_US_EAST_1E",
           "dataDirectory" : "/data",
           "fileSystemTypeName" : "EXT4",
           "hostnamePrefix" : "test",
           "imageId" : "ami-978d91fe",
           "instanceTypeName" : "AWS_M3_MEDIUM",
           "machineUser" : "ec2-user",
           "optimizeVolumes" : false,
           "providerName" : "AWS",
           "regionName" : "AWS_US_EAST_1",
           "rootSizeGB" : 25,
           "securityGroups" : [ "sg-abcd1234" ],
           "sshKeyName" : "myKey"
         },
         "provisionedMachineId" : "54885457e4b040c7b7093b14",
         "statusName" : "READY"
       },
       ...
     ],
     "links" : [ ... ]
   }

Get a Single Provisioning Job
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request
```````

.. code-block:: none

   curl -u "username:apiKey" --digest -i "https://cloud.mongodb.com/api/public/v1.0/groups/5421e044e4b09da19248b17f/provisionMachineJobs/AWS/54885451e4b03042efe4b4cc"

Response
````````

.. code-block:: none

   HTTP/1.1 200 OK

   {
     "batchId" : "54885451e4b03042efe4b4c8",
     "created" : "2016-05-25T13:22:03Z",
     "id" : "54885451e4b03042efe4b4cc",
     "lastUpdated" : "2016-05-25T13:25:10Z",
     "links" : [ ... ],
     "parameters" : {
       "availabilityZoneName" : "AWS_US_EAST_1E",
       "dataDirectory" : "/data",
       "fileSystemTypeName" : "EXT4",
       "hostnamePrefix" : "test",
       "imageId" : "ami-978d91fe",
       "instanceTypeName" : "AWS_M3_MEDIUM",
       "machineUser" : "ec2-user",
       "optimizeVolumes" : false,
       "providerName" : "AWS",
       "regionName" : "AWS_US_EAST_1",
       "rootSizeGB" : 25,
       "securityGroups" : [ "sg-abcd1234" ],
       "sshKeyName" : "myKey"
     },
     "provisionedMachineId" : "54885457e4b040c7b7093b14",
     "statusName" : "READY"
   },

Provision a Single Machine
~~~~~~~~~~~~~~~~~~~~~~~~~~

Request
```````

.. code-block:: none

   curl -u "username:apiKey" --digest -H "Content-Type: application/json" -i -X POST "https://cloud.mongodb.com/api/public/v1.0/groups/5421e044e4b09da19248b17f/provisionMachineJobs/AWS" --data '
   {
     "parameters" : {
       "availabilityZoneName" : "AWS_US_EAST_1B",
       "dataDirectory" : "/data",
       "dataDirectoryVolume" : {
         "attachmentTypeName" : "EBS",
         "deleteOnTermination" : true,
         "encrypted" : false,
         "mountLocation" : "/data",
         "name" : "/dev/sdf",
         "sizeGB" : 20,
         "volumeTypeName" : "GENERAL_EC2"
       },
       "fileSystemTypeName" : "XFS",
       "hostnamePrefix": "my-host-prefix",
       "imageId" : "ami-abcd1234",
       "instanceTypeName" : "AWS_M4_LARGE",
       "machineUser" : "myuser",
       "optimizeVolumes" : false,
       "providerName" : "AWS",
       "regionName" : "AWS_US_EAST_1",
       "rootSizeGB" : 25,
       "securityGroups" : [ "sg-abcd1234" ],
       "sshKeyName" : "myKey"
     }
   }'

Response
````````

.. code-block:: none

   HTTP/1.1 202 Accepted

   {
     "results" : [
     {
       "batchId" : "57477304e4b0a46f8d167eda",
       "created" : "2016-05-26T22:04:54Z",
       "id" : "57477307e4b0a46f8d167edb",
       "lastUpdated" : "2016-05-26T22:04:55Z",
       "links" : [ ... ],
       "parameters" : {
         "availabilityZoneName" : "AWS_US_EAST_1B",
         "dataDirectory" : "/data",
         "dataDirectoryVolume" : {
           "attachmentTypeName" : "EBS",
           "deleteOnTermination" : true,
           "encrypted" : false,
           "mountLocation" : "/data",
           "name" : "/dev/sdf",
           "sizeGB" : 20,
           "volumeTypeName" : "GENERAL_EC2"
         },
         "fileSystemTypeName" : "XFS",
         "hostnamePrefix": "my-host-prefix",
         "imageId" : "ami-abcd1234",
         "instanceTypeName" : "AWS_M4_LARGE",
         "machineUser" : "myuser",
         "optimizeVolumes" : false,
         "providerName" : "AWS",
         "regionName" : "AWS_US_EAST_1",
         "rootSizeGB" : 25,
         "securityGroups" : [ "sg-abcd1234" ],
         "sshKeyName" : "myKey"
       },
       "statusName" : "NOT_STARTED"
     } ],
     "totalCount" : 7
   }

Provision Multiple Machines
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Request
```````

.. code-block:: none

   curl -u "username:apiKey" --digest -H "Content-Type: application/json" -i -X POST "https://cloud.mongodb.com/api/public/v1.0/groups/5421e044e4b09da19248b17f/provisionMachineJobs/AWS?instanceCount=3" --data '
   {
     "parameters" : {
       "availabilityZoneName" : "AWS_US_EAST_1B",
       "dataDirectory" : "/data",
       "dataDirectoryVolume" : {
         "attachmentTypeName" : "EBS",
         "deleteOnTermination" : true,
         "encrypted" : false,
         "mountLocation" : "/data",
         "name" : "/dev/sdf",
         "sizeGB" : 20,
         "volumeTypeName" : "GENERAL_EC2"
       },
       "fileSystemTypeName" : "XFS",
       "hostnamePrefix": "my-host-prefix",
       "imageId" : "ami-60b6c60a",
       "instanceTypeName" : "AWS_M3_MEDIUM",
       "machineUser" : "myuser",
       "optimizeVolumes" : false,
       "providerName" : "AWS",
       "regionName" : "AWS_US_EAST_1",
       "rootSizeGB" : 25,
       "securityGroups" : [ "sg-abcd1234" ],
       "sshKeyName" : "myKey"
     }
   }'

Response
````````

.. code-block:: none

   HTTP/1.1 202 Accepted

   {
     "links" : [ ... ],
     "results" : [
     {
       "batchId" : "57477fc6e4b08007467d0c2e",
       "created" : "2016-05-26T22:59:18Z",
       "id" : "57477fc6e4b08007467d0c2f",
       "lastUpdated" : "2016-05-26T22:59:18Z",
       "links" : [ ... ],
       "parameters" : {
         "availabilityZoneName" : "AWS_US_EAST_1B",
         "dataDirectory" : "/data",
         "dataDirectoryVolume" : {
           "attachmentTypeName" : "EBS",
           "deleteOnTermination" : true,
           "encrypted" : false,
           "mountLocation" : "/data",
           "name" : "/dev/sdf",
           "sizeGB" : 20,
           "volumeTypeName" : "GENERAL_EC2"
         },
         "fileSystemTypeName" : "XFS",
         "hostnamePrefix": "my-host-prefix",
         "imageId" : "ami-60b6c60a",
         "instanceTypeName" : "AWS_M3_MEDIUM",
         "machineUser" : "myuser",
         "optimizeVolumes" : false,
         "providerName" : "AWS",
         "regionName" : "AWS_US_EAST_1",
         "rootSizeGB" : 25,
         "securityGroups" : [ "sg-abcd1234" ],
         "sshKeyName" : "myKey"
       },
       "statusName" : "IN_PROGRESS"
     },
     ...
     ],
     "totalCount" : 7
   }
