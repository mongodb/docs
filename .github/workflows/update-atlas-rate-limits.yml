name: Update Atlas Rate Limits

on:
  schedule:
    # Runs every weekday at 1:30 PM Eastern (18:30 UTC in EST, 19:30 UTC in EDT)
    # Using 18:30 UTC to cover EST timezone
    - cron: '30 18 * * 1-5'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-rate-limits:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        working-directory: content/tools/atlas-rate-limits-generator
        run: npm install

      - name: Get latest Atlas API version
        run: |
          # Fetch the versions API and extract the latest version from versions.2.0 array
          LATEST_VERSION=$(curl -s https://cloud.mongodb.com/api/openapi/versions | jq -r '.versions."2.0" | last')
          echo "ATLAS_API_VERSION=${LATEST_VERSION}" >> "$GITHUB_ENV"
          echo "Using Atlas API version: ${LATEST_VERSION}"

      - name: Generate rate limits
        working-directory: content/tools/atlas-rate-limits-generator
        env:
          # Service Account (preferred - use these secrets)
          ATLAS_CLIENT_ID: ${{ secrets.DOCS_GEN_ATLAS_CLIENT_ID }}
          ATLAS_CLIENT_SECRET: ${{ secrets.DOCS_GEN_ATLAS_CLIENT_SECRET }}
          # API Key (fallback - only used if service account secrets not set)
          ATLAS_PUBLIC_KEY: ${{ secrets.ATLAS_PUBLIC_KEY }}
          ATLAS_PRIVATE_KEY: ${{ secrets.ATLAS_PRIVATE_KEY }}
          ATLAS_API_VERSION: ${{ env.ATLAS_API_VERSION }}
        run: |
          node rate-limits-generator.js > /dev/null

      - name: Check for changes
        run: |
          # Check if the file has actual changes beyond the timestamp
          if git diff --quiet content/atlas/source/includes/api-rate-limits.rst; then
            echo "rate_limits_changed=false" >> "$GITHUB_ENV"
            echo "No changes in rate limits"
          else
            # Check if only the timestamp changed
            git diff content/atlas/source/includes/api-rate-limits.rst | grep -v "Last updated:" | grep -E "^[+-]" | grep -vE "^(---|\+\+\+)" > /tmp/changes.txt || true
            if [ ! -s /tmp/changes.txt ]; then
              echo "rate_limits_changed=false" >> "$GITHUB_ENV"
              echo "Only timestamp changed"
            else
              echo "rate_limits_changed=true" >> "$GITHUB_ENV"
              echo "Rate limits content has changed"
            fi
          fi

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RATE_LIMITS_CHANGED: ${{ env.rate_limits_changed }}
        run: |
          # Set git config
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create branch name
          BRANCH_NAME="update-atlas-rate-limits-${{ github.run_number }}"
          
          # Create and checkout new branch
          git checkout -b $BRANCH_NAME
          
          # Stage and commit changes
          git add content/atlas/source/includes/api-rate-limits.rst
          
          if [ "$RATE_LIMITS_CHANGED" = "true" ]; then
            git commit -m "Update Atlas rate limits - Rate limits changed"
            PR_TITLE="Update Atlas Rate Limits - Rate Limits Changed"
            CHANGES_TEXT="### Changes Detected\nThe rate limits information has been updated with new or modified endpoint sets from the Atlas API."
          else
            git commit -m "Update Atlas rate limits - Timestamp refresh"
            PR_TITLE="Update Atlas Rate Limits - Timestamp Refresh"
            CHANGES_TEXT="### No Changes\nNo changes were detected in the rate limits. The timestamp has been refreshed to reflect the latest check."
          fi
          
          # Push branch
          git push origin $BRANCH_NAME
          
          # Create PR body
          TIMESTAMP=$(TZ='America/New_York' date '+%B %d, %Y at %I:%M %p %Z')
          if [ "${{ github.event_name }}" = "schedule" ]; then
            RUN_TYPE="Scheduled"
          else
            RUN_TYPE="Manual"
          fi
          
          if [ "$RATE_LIMITS_CHANGED" = "true" ]; then
            EVENTS_STATUS="Yes âœ…"
          else
            EVENTS_STATUS="No - Timestamp only"
          fi
          
          # Write PR body to file
          cat > /tmp/pr-body.md <<EOFBODY
          ## Atlas Rate Limits Update
          
          **Run Date:** ${RUN_TYPE} - ${TIMESTAMP}
          **Rate Limits Changed:** ${EVENTS_STATUS}
          
          This automated PR updates the Atlas rate limits documentation from the MongoDB Atlas API.
          
          ${CHANGES_TEXT}
          
          ---
          
          @jwilliams-mongo Please review this automated update.
          
          <details>
          <summary>About this automation</summary>
          
          This workflow runs every weekday (Monday through Friday) at 1:30 PM Eastern and:
          1. Fetches the latest rate limits from the MongoDB Atlas Admin API
          2. Generates an updated rate limits table with all endpoint sets
          3. Updates the timestamp at the top of the include file
          4. Creates this PR for review
          
          Rate limits file: \`content/atlas/source/includes/api-rate-limits.rst\`
          </details>
          EOFBODY
          
          # Create PR using gh CLI
          gh pr create \
            --title "$PR_TITLE" \
            --body-file /tmp/pr-body.md \
            --base ${{ github.ref_name }} \
            --head $BRANCH_NAME \
            --reviewer jwilliams-mongo
