.. _security-aws-kms:

====================================
Customer Key Management with AWS KMS
====================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

You can configure your |service| project to use an |aws| `IAM role 
<https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html>`__ 
for accessing your |aws| KMS keys for encryption at rest. You can 
either use an existing role or create a new role when you enable 
encryption at rest for your project.

This page covers configuring customer key management on your |service| 
project for role-based access.

If you have not yet enabled encryption at rest for your new or existing 
|service| project, follow the :ref:`aws-kms-enable-project` procedure 
to enable encryption at rest for your |service| project. If you have an 
|service| project for which you have already enabled encryption at rest 
and configured credentials-based access to your encryption keys, follow 
the :ref:`aws-kms-switch-project` procedure to switch to role-based 
access to your encryption keys.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

.. seealso:: 

   - :ref:`set-up-unified-aws-access`

.. _aws-ksm-prereqs:
.. _security-aws-kms-restrictions:

Prerequisites
-------------

To enable customer-managed keys with |aws| |kms| for a MongoDB
project, you must:

.. include:: /includes/fact-aws-kms-prereqs.rst

.. _aws-kms-enable-project:

Enable Role-Based Access to Your Encryption Key for a Project
-------------------------------------------------------------

.. tabs::

   .. tab:: UI
      :tabid: ui

      .. include:: /includes/steps/enable-rba-encryption-for-project.rst

   .. tab:: API
      :tabid: api
   
      .. include:: /includes/steps/enable-rba-encryption-api.rst

.. _aws-kms-switch-project:

Switch to Role-Based Access to Your Encryption Key for a Project
----------------------------------------------------------------

.. important:: 

   If you switch your |service| project from credentials-based access 
   to role-based access to your encryption keys, you cannot undo the 
   role-based access configuration and revert to credentials-based 
   access for that project.

.. tabs::

   .. tab:: UI
      :tabid: ui

      .. include:: /includes/steps/migrate-rba-encryption-for-project.rst

   .. tab:: API
      :tabid: api
   
      To update your encryption key management with the public API, use
      the same steps outlined in the :ref:`above procedure
      <aws-kms-enable-project>`.

.. _aws-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
-------------------------------------------------------

After you :ref:`aws-kms-enable-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:doc:`Manage your own encryption keys </cluster-config/encryption/>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

.. toctree::
   :titlesonly:

   /tutorial/security-aws-kms-rotate-key
