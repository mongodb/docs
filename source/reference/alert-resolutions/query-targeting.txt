.. _query-targeting:

===============
Query Targeting
===============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Description
-----------

``Query Targeting`` alerts indicate inefficient queries:

* :alert:`Query Targeting: Scanned Objects / Returned` occurs if the
  number of documents examined to fulfill a query relative to the actual
  number of returned documents meets or exceeds a user-defined threshold.
  The default is 1000, which means that a query must scan more than 1000
  documents for each document returned to trigger the alert.

* :alert:`Query Targeting: Scanned / Returned` occurs if the number of
  index keys examined to fulfill a query relative to the actual number of
  returned documents meets or exceeds a user-defined threshold. This alert
  is not enabled by default.

Ideally, the ratio of scanned documents to returned documents should
be close to 1. A high ratio negatively impacts query performance. The
following :ref:`mongod log <mongodb-logs>` entry shows statistics
generated from an inefficient query:

.. code-block:: json
   :copyable: false

   <Timestamp> COMMAND  <query>
   planSummary: COLLSCAN keysExamined:0 
   docsExamined: 10000 cursorExhausted:1 numYields:234 
   nreturned:4  protocol:op_query 358ms

This query scanned 10,000 documents and returned only 4 for a ratio of
2500, which is highly inefficient. No index keys were examined, so
MongoDB scanned all documents in the collection, known as a 
:term:`collection scan`.


Solution
--------
The query targeting alert typically occurs when there is no index to
support a query or queries or when an existing index only partially
supports a query or queries. Add one or more indexes to better serve
the inefficient queries.

The :doc:`Performance Advisor </performance-advisor>` provides the easiest
and quickest way to create an index. The Performance Advisor monitors queries
that MongoDB considers slow and recommends indexes to improve performance.
Click :guilabel:`Create Index` on a slow query for instructions on how to
create the recommended index.

.. note::
    
     The Performance Advisor recognizes a query as slow if it takes longer
     than 100 milliseconds to execute. It is possible to receive a Query Targeting
     alert message for an inefficient query without receiving index suggestions from
     the Performance Advisor if the query takes less than 100 milliseconds to execute
     and the ratio of scanned to returned documents is greater than the threshold specified in the alert.

In addition, you can use the following resources to determine which query
generated the alert:

* The :doc:`Real-Time Performance Panel </real-time-performance-panel/>`
  monitors and displays current network traffic and database operations
  on machines hosting MongoDB in your |service| clusters.

* The :ref:`MongoDB logs <mongodb-logs>` maintain an account of activity,
  including queries, for each ``mongod`` instance in your |service|
  clusters.

* The :manual:`cursor.explain() </reference/method/cursor.explain/>`
  command for the ``mongo`` shell provides performance details for
  all queries.

* The :manual:`Data Profiler </tutorial/manage-the-database-profiler/index.html>`
  records operations that take less than 100 ms with the data profiler.

  .. note::
     
     Enabling the Database Profiler incurs a performance overhead.


Refer to the following for more information on query performance:

- :manual:`MongoDB Indexing Strategies </applications/indexes>`
- :manual:`Query Optimization </core/query-optimization>`
- :manual:`Analyze Query Plan </tutorial/analyze-query-plan/>`
