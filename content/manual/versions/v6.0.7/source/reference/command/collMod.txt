=======
collMod
=======

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Definition
----------

.. dbcommand:: collMod

   :dbcommand:`collMod` makes it possible to add options to a collection
   or to modify view definitions.

   .. |method| replace:: :method:`~db.collection.hideIndex` and
      :method:`~db.collection.unhideIndex` helper methods
   .. include:: /includes/fact-dbcommand-tip

   .. note::

      The view modified by this command does not refer to materialized
      views. For discussion of on-demand materialized views, see
      :pipeline:`$merge` instead.

Syntax
------

The command has the following syntax:

.. note:: Starting in MongoDB 4.2

   - .. include:: /includes/collMod-note.rst

   - .. include:: /includes/extracts/views-restriction-output-to-disk.rst

.. code-block:: javascript

   db.runCommand( 
      { 
        collMod: <collection or view>, 
        <option1>: <value1>, 
        <option2>: <value2>,
        ... 
      } 
   )

For the ``<collection or view>``, specify the name of a collection
or view in the current database.

Options
-------

Index Options
~~~~~~~~~~~~~


.. collflag:: index

   The ``index`` option can change the following properties of
   an **existing** index:

   .. list-table::
      :header-rows: 1
      :widths: 20 80

      * - Index Property
        - Description

      * - ``expireAfterSeconds``
        - The number of seconds that determines the expiration
          threshold of a :ref:`TTL Collection <ttl-collections>`.

          If successful, the command returns a document that contains:

          - ``expireAfterSeconds_new``, the new value for
            ``expireAfterSeconds``
          - ``expireAfterSeconds_old``, the old value for
            ``expireAfterSeconds``, if the index had a value for
            ``expireAfterSeconds`` before.

          Modifying the index option ``expireAfterSeconds`` resets the
          :pipeline:`$indexStats` for the index.

          .. include:: /includes/indexes/expireAfterSeconds-warning.rst

      * - ``hidden``
        - A boolean that determines whether the index is :ref:`hidden
          <index-type-hidden>` or not from the query planner.

          If the ``hidden`` value changes, the command returns a
          document that contains both the old and new values for the
          changed property: ``hidden_old`` and ``hidden_new``.

          However, if the ``hidden`` value has not changed (i.e. hiding
          an already hidden index or unhiding an already unhidden
          index), the command omits the ``hidden_old`` and
          ``hidden_new`` fields from the output.

          To hide an index, you must have
          :ref:`featureCompatibilityVersion <view-fcv>` set to ``4.4``
          or greater.

          Modifying the index option ``hidden`` resets the
          :pipeline:`$indexStats` for the index if the value changes.

          .. versionadded:: 4.4

      * - ``prepareUnique``
        - A boolean that determines whether the index will accept
          new duplicate entries.

          New duplicate entries fail with DuplicateKey errors when
          ``prepareUnique`` is ``true``. The resulting index can be
          converted to a unique index. To convert the index, use
          ``collMod`` with the ``unique`` option.

          If an existing index is updated so that ``prepareUnique`` is
          ``true``, the index is not checked for pre-existing,
          duplicate index entries.

          .. versionadded:: 6.0

      * - ``unique``
        - A boolean that determines whether or not the index is unique.

          When ``unique`` is ``true``, ``collMod`` scans the
          ``keyPattern`` index for duplicates and then converts it to
          a unique index if there are no duplicate index entries.
          
          If duplicates are detected during the initial scan,
          ``collMod`` returns ``CannotConvertIndexToUnique`` and a list
          of conflicting documents. To convert an index with duplicate
          entries to a unique index, correct any reported conflicts and
          rerun ``collMod``.
          
          To end a conversion, set ``prepareUnique`` to ``false``.

          .. versionadded:: 6.0

   To change index options, specify either the key pattern or name of
   the existing index and the index option or options you wish to
   change:

   .. code-block:: javascript

      db.runCommand( {
         collMod: <collection>,
         index: {
            keyPattern: <index_spec> || name: <index_name>,
            expireAfterSeconds: <number>,  // Set the TTL expiration threshold
            hidden: <boolean>,             // Change index visibility in the query planner
            prepareUnique: <boolean>,      // Reject new duplicate index entries 
            unique: <boolean>              // Convert an index to a unique index
         }
      } )

   If the index does not exist, the command errors with the message
   ``"cannot find index <name|keyPattern> for ns <db.collection>"``.

   .. seealso::

      - :ref:`index-type-hidden`

Document Validation
~~~~~~~~~~~~~~~~~~~

.. collflag:: validator

   ``validator`` allows users to specify :doc:`validation rules
   or expressions </core/schema-validation>` for a collection.
   For more information, see :doc:`/core/schema-validation`.

   The ``validator`` option takes a document that specifies the
   validation rules or expressions. You can specify the expressions
   using the same operators as the :ref:`query operators
   <query-selectors>` with the exception of :query:`$near`,
   :query:`$nearSphere`, :query:`$text`, and :query:`$where`.

   .. note::

      - Validation occurs during updates and inserts. Existing
        documents do not undergo validation checks until modification.

      - You cannot specify a validator for collections in the ``admin``,
        ``local``, and ``config`` databases.

      - You cannot specify a validator for ``system.*`` collections.

.. collflag:: validationLevel

   The ``validationLevel`` determines how strictly MongoDB applies the
   validation rules to existing documents during an update.

   .. include:: /includes/extracts/table-validationLevel-values.rst

   To see an example that uses ``validationLevel``, see
   :ref:`schema-specify-validation-level`.

.. collflag:: validationAction

   The ``validationAction`` option determines whether to ``error`` on
   invalid documents or just ``warn`` about the violations but allow
   invalid documents.

   .. important::

      Validation of documents only applies to those documents as
      determined by the ``validationLevel``.

   To see an example that uses ``validationAction``, see
   :ref:`schema-validation-handle-invalid-docs`.

Views
~~~~~

.. note::

   The view modified by this command does not refer to materialized
   views. For discussion of on-demand materialized views, see
   :pipeline:`$merge` instead.

.. collflag:: viewOn

   The underlying source collection or view for the :doc:`view
   </core/views>`. The view definition is determined by applying the
   specified :collflag:`pipeline` to this source.

   Required if modifying a view on a MongoDB deployment that is running
   with access control.

.. collflag:: pipeline

   The :ref:`aggregation pipeline <aggregation-pipeline>` that defines
   the :doc:`view </core/views>`.

   .. note::

      .. include:: /includes/extracts/views-restriction-output-to-disk.rst

   Required if modifying a view on a MongoDB deployment that is running
   with access control.

   .. include:: /includes/extracts/views-public-definition.rst

.. code-block:: javascript

   db.runCommand( {
      collMod: "myView",
      viewOn: "activities",
      pipeline: [
        { $match: { status: "Q" } },
        { $project: { user: 1, date: 1, description: 1} } ]
   } )

Time Series Collections
~~~~~~~~~~~~~~~~~~~~~~~

To enable automatic removal of documents or change the
``expireAfterSeconds`` parameter value for an existing :ref:`time
series collection <manual-timeseries-collection>`, issue the following
:dbcommand:`collMod` command:

.. code-block:: javascript

   db.runCommand( {
      collMod: <collection>,
      expireAfterSeconds: <Number> || "off"
   } )

The ``expireAfterSeconds`` field must be either:

- A non-negative decimal number (``>=0``)
- The string ``"off"``.

A number specifies the number of seconds after which documents expire.
The string ``"off"`` removes the ``expireAfterSeconds`` parameter and
disables automatic removal.

.. seealso::

   :ref:`manual-timeseries-automatic-removal`

.. _resize-capped-collection:

Resize a Capped Collection
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. versionadded:: 6.0

Starting in MongoDB 6.0, you can resize a capped collection. To change a  
:ref:`capped collection's <manual-capped-collection>` maximum size in bytes, use
the ``cappedSize`` option. To change the maximum number of documents in 
an existing capped collection, use the ``cappedMax`` option.

.. note:: 

   You can't use these commands to resize the oplog. Use 
   :dbcommand:`replSetResizeOplog` instead. 

.. collflag:: cappedSize

   Specifies a new maximum size, in bytes, for a capped collection. ``cappedSize``
   must be greater than ``0`` and less than ``1e+15`` (1 PB). 

.. collflag:: cappedMax

   Specifies a new maximum number of documents in a capped collection. Setting
   ``cappedMax`` less than or equal to ``0`` implies no limit.

For example, the following command sets the maximum size of a capped collection 
to 100000 bytes and sets the maximum number of documents in the collection to 500:

.. code-block:: javascript

   db.runCommand( {
      collMod: <collection>,
      cappedSize: 100000,
      cappedMax: 500
   } )

.. _collMod-change-stream-pre-and-post-images:

Change Streams with Document Pre- and Post-Images
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/change-stream-pre-and-post-images-introduction.rst

To use :dbcommand:`collMod` to enable change stream pre- and post-images
for a collection, use the ``changeStreamPreAndPostImages`` field:

.. code-block:: javascript
   :copyable: false

   db.runCommand( {
      collMod: <collection>,
      changeStreamPreAndPostImages: { enabled: <boolean> }
   } )

To enable change stream pre- and post-images for a collection, set
``changeStreamPreAndPostImages`` to ``true``. For example:

.. code-block:: javascript

   db.runCommand( {
      collMod: "orders",
      changeStreamPreAndPostImages: { enabled: true }
   } )

To disable change stream pre- and post-images for a collection, set
``changeStreamPreAndPostImages`` to ``false``. For example:

.. code-block:: javascript

   db.runCommand( {
      collMod: "orders",
      changeStreamPreAndPostImages: { enabled: false }
   } )

.. include:: /includes/change-stream-pre-and-post-images-additional-information.rst

Write Concern
~~~~~~~~~~~~~

Optional. A document expressing the :doc:`write concern
</reference/write-concern>` of the :dbcommand:`collMod` command.

Omit to use the default write concern.

Access Control
--------------

If the deployment enforces authentication/authorization, you must have
the following privilege to run the :dbcommand:`collMod` command:

.. list-table::
   :header-rows: 1

   * - Task

     - Required Privileges

   * - Modify a non-capped collection

     - :authaction:`collMod` in the database

   * - Modify a view

     - :authaction:`collMod` in the database and either:

       - no :authaction:`find` on the view to modify, **or**

       - both :authaction:`find` on the view to modify and
         :authaction:`find` on the source collection/view.

The built-in role :authrole:`dbAdmin` provides the required privileges.

Behavior
--------

Resource Locking
~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/collMod-resource-lock.rst

Examples
--------

.. _ex-change-exp-value:

Change Expiration Value for Indexes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example updates the ``expireAfterSeconds`` property of an
existing TTL index ``{ lastAccess: 1 }`` on a collection named
``user_log``. The current ``expireAfterSeconds`` property for the index
is set to ``1800`` seconds (or 30 minutes) and the example changes the
value to ``3600`` seconds (or 60 minutes).

.. code-block:: javascript

   db.runCommand({ 
      collMod: "user_log",
      index: { 
         keyPattern: { lastAccess: 1 },
         expireAfterSeconds: 3600 
      }
   })

If successful, the operation returns a document that includes both the
old and new value for the changed property:

.. code-block:: javascript

   { "expireAfterSeconds_old" : 1800, "expireAfterSeconds_new" : 3600, "ok" : 1 }

Hide an Index from the Query Planner
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note::

   To hide an index, you must have :ref:`featureCompatibilityVersion
   <view-fcv>` set to ``4.4`` or greater. However, once hidden, the
   index remains hidden even with :ref:`featureCompatibilityVersion
   <view-fcv>` set to ``4.2`` on MongoDB 4.4 binaries.

The following example :doc:`hides </core/index-hidden>` an existing
index on the ``orders`` collection. Specifically, the operation hides
the index with the specification ``{ shippedDate: 1 }`` from the query
planner.

.. code-block:: javascript

   db.runCommand({
      collMod: "orders",
      index: {
         keyPattern: { shippedDate: 1 },
         hidden: true
      }
   })

If successful, the operation returns a document that includes both the
old and new value for the changed property:

.. code-block:: javascript

   { "hidden_old" : false, "hidden_new" : true, "ok" : 1 }

.. note::

   If the operation is successful but the ``hidden`` value has not
   changed (i.e. hiding an already hidden index or unhiding an already
   unhidden index), the command omits the ``hidden_old`` and
   ``hidden_new`` fields from the output.

To hide a text index, you must specify the index by ``name`` and not by
``keyPattern``.

.. seealso::

   - :doc:`/core/index-hidden`
   - :method:`db.collection.hideIndex()`
   - :method:`db.collection.unhideIndex()`


Convert an Existing Index to a Unique Index
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Create the ``apples`` collection:

.. code-block:: javscript

   db.apples.insertMany( [
      { type: "Delicious", quantity: 12 },
      { type: "Macintosh", quantity: 13 },
      { type: "Delicious", quantity: 13 },
      { type: "Fuji", quantity: 15 },
      { type: "Washington", quantity: 10 },
   ] )

Add a single field index on ``type``:

.. code-block:: javscript

   db.apples.createIndex( { type: 1 } )

Prepare the index on the ``type`` field for conversion:

.. code-block:: javscript

   db.runCommand( {
       collMod: "apples",
       index: {
          keyPattern: { type: 1 },
          prepareUnique: true
       }
    } )

The existing index may contain duplicate entries, but it will not
accept new documents that duplicate an index entry when
``prepareUnique`` is ``true``. 

Try to insert a document with a duplicate index value:

.. code-block:: javscript

   db.apples.insertOne( { type: "Delicious", quantity: 200 } )

The operation returns an error. The index will not accept new
duplicate entries. 

Use the ``unique``option to convert the index to a unique index.
``collMod`` checks the collection for duplicate index entries before
converting the index:

.. code-block:: javscript

   db.runCommand( {
       collMod: "apples",
       index: {
          keyPattern: { type: 1 },
          unique: true
       }
    } )

The response to this operation varies by driver. You will always
receive an error message about the duplicate entries.

.. code-block:: shell
   :copyable: false
   
   "errmsg" : "Cannot convert the index to unique. Please resolve
               conflicting documents before running collMod again."
   
Some drivers also return a list of ``ObjectIds`` for the duplicate
entries:

.. code-block:: shell
   :copyable: false

   {
        "ok" : 0,
        "errmsg" : "Cannot convert the index to unique. Please resolve \
                    conflicting documents before running collMod again.",
        "code" : 359,
        "codeName" : "CannotConvertIndexToUnique",
        "violations" : [
                {
                        "ids" : [
                                ObjectId("62a2015777e2d47c4da33146"),
                                ObjectId("62a2015777e2d47c4da33148")
                        ]
                }
        ]
   }

To complete the conversion, modify the duplicate entries to remove any
conflicts and re-run ``collMod()`` with the ``unique`` option.
