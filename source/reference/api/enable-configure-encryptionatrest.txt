=====================================================================================
Enable and Configure Encryption at Rest using Customer Key Management for One Project
=====================================================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/fact-projects-groups-synonyms.rst

.. include:: /includes/fact-atlas-free-tier-limits.rst

Enables, disables, and configures {+encrypt-at-rest+} for |a-service|
project with one of the following providers:

* :ref:`Amazon Web Services Key Management Service <security-aws-kms>`
* :ref:`Azure Key Vault <security-azure-kms>`
* :ref:`Google Cloud KMS <security-gcp-kms>`

After configuring at least one {+encrypt-at-rest+} provider for the
|service| project, :authrole:`Project Owners <Project Owner>` can
enable {+encrypt-at-rest+} for each |service| cluster for which they
require encryption. The {+encrypt-at-rest+} provider does *not* have to
match the cluster cloud service provider.

|service| does not automatically rotate user-managed encryption keys.
Defer to your preferred {+encrypt-at-rest+} provider's documentation
and guidance for best practices on key rotation. |service|
automatically creates a
:ref:`365-day key rotation alert <alert-conditions-encryption-at-rest>`
when you configure {+encrypt-at-rest+} using your Key Management in
|a-service| project.

.. include:: /includes/admonitions/notes/note-encrypt-storage.rst

.. seealso::

   To learn more about key management, see
   :doc:`{+encrypt-at-rest+} </security-aws-kms>`, including
   :ref:`prerequisites <aws-ksm-prereqs>` and
   :ref:`restrictions <security-aws-kms-restrictions>`.

.. include:: /includes/api-requirements.rst

.. include:: /includes/api-base-url.rst

Syntax
------

.. code-block:: http

   PATCH /groups/{PROJECT-ID}/encryptionAtRest

Request Path Parameters
~~~~~~~~~~~~~~~~~~~~~~~

.. list-table::
   :header-rows: 1
   :widths: 15 10 75

   * - Path Element
     - Necessity
     - Description

   * - ``PROJECT-ID``
     - Required
     - Unique identifier for the :ref:`project <group-id>`.

Request Query Parameters
~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/api/no-query-single-parameters.rst

Request Body Parameters
~~~~~~~~~~~~~~~~~~~~~~~

The required request body parameters depend on whether
{+encrypt-at-rest+} is currently enabled:

- If you have enabled {+encrypt-at-rest+}, |service| requires all of
  the parameters for the desired encryption provider.

  - If you want to use AWS KMS, |service| requires all the fields in
    the ``awsKms`` document.

  - If you want to use Azure Key Vault, |service| requires all the
    fields in the ``azureKeyVault`` document.

  - If you want to use Google Cloud KMS, |service| requires all the
    fields in the ``googleCloudKms`` document.

- If you have enabled {+encrypt-at-rest+}, administrators can pass only
  the changed fields for the ``awsKms``, ``azureKeyVault``, or
  ``googleCloudKms`` document to update the configuration to this
  endpoint.

.. tabs-cloud-providers::

   .. tab::
      :tabid: aws

      .. include:: /includes/encryption-at-rest-request-document-aws.rst

   .. tab::
      :tabid: gcp

      .. include:: /includes/encryption-at-rest-request-document-gcp.rst

   .. tab::
      :tabid: azure

      .. include:: /includes/encryption-at-rest-request-document-azure.rst

Response
~~~~~~~~

.. tabs-cloud-providers::
   :hidden:

   .. tab::
      :tabid: aws

      .. include:: /includes/encryption-at-rest-response-document-aws.rst

   .. tab::
      :tabid: azure

      .. include:: /includes/encryption-at-rest-response-document-azure.rst

   .. tab::
      :tabid: gcp

      .. include:: /includes/encryption-at-rest-response-document-gcp.rst

Example Request
---------------

Enable {encrypt-at-rest}
~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs-cloud-providers::
   :hidden:

   .. tab::
      :tabid: aws

      The following example enables and configures {+encrypt-at-rest+}
      for |a-service| project using |aws| |kms|:

      .. code-block:: sh
         :linenos:
         :emphasize-lines: 5-14

         curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
              --header "Accept: application/json" \
              --header "Content-Type: application/json" \
              --request PATCH "https://cloud.mongodb.com/api/atlas/v1.0/groups/{PROJECT-ID}/encryptionAtRest?pretty=true" \
              --data '
                {
                  "awsKms": {
                    "enabled": true,
                    "accessKeyID" : "AKIAIOSFODNN7EXAMPLE",
                    "secretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
                    "customerMasterKeyID" : "030gce02-586d-48d2-a966-05ea954fde0g",
                    "region" : "US_EAST_1"
                  }
                }'

   .. tab::
      :tabid: azure

      The following example enables and configures {+encrypt-at-rest+}
      for |a-service| project using Azure Key Vault:

      .. code-block:: sh
         :linenos:
         :emphasize-lines: 5-18

         curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
              --header "Accept: application/json" \
              --header "Content-Type: application/json" \
              --request PATCH "https://cloud.mongodb.com/api/atlas/v1.0/groups/6cbbae2187d9d675e009g35f/encryptionAtRest?pretty=true" \
              --data '
                {
                  "azureKeyVault" : {
                    "enabled" : true,
                    "clientID" : "g54f9e2-89e3-40fd-8188-EXAMPLEID",
                    "azureEnvironment" : "AZURE",
                    "subscriptionID" : "0ec944e3-g725-44f9-a147-EXAMPLEID",
                    "resourceGroupName" : "ExampleRGName",
                    "keyVaultName" : "EXAMPLEKeyVault",
                    "keyIdentifier" : "https://EXAMPLEKeyVault.vault.azure.net/keys/EXAMPLEKey/d891821e3d364e9eb88fbd3d11807b86",
                    "secret" : "EXAMPLESECRET",
                    "tenantID" : "e8e4b6ba-ff32-4c88-a9af-EXAMPLEID"
                  }
                }'

   .. tab::
      :tabid: gcp

      The following example enables and configures {+encrypt-at-rest+}
      for |a-service| project using |gcp| |kms|.

      .. note::

         The ``serviceAccountKey`` |json| object must be formatted as a
         string for |api| call purposes.

      .. code-block:: sh
         :linenos:
         :emphasize-lines: 5-13

         curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
              --header "Accept: application/json" \
              --header "Content-Type: application/json" \
              --request PATCH "https://cloud.mongodb.com/api/atlas/v1.0/groups/6cbbae2187d675e009g35f/encryptionAtRest?pretty=true" \
              --data '
                {
                  "googleCloudKms" : {
                    "enabled" : true,
                    "serviceAccountKey":
                       "{\"type\": \"service_account\",\"project_id\": \"my-project-common-0\",\"private_key_id\": \"e120598ea4f88249469fcdd75a9a785c1bb3\",\"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEuwIBA(truncated)SfecnS0mT94D9\\n-----END PRIVATE KEY-----\\n\",\"client_email\": \"my-email-kms-0@my-project-common-0.iam.gserviceaccount.com\",\"client_id\": \"10180967717292066\",\"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",\"token_uri\": \"https://accounts.google.com/o/oauth2/token\",\"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\",\"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/my-email-kms-0%40my-project-common-0.iam.gserviceaccount.com\"}",
                    "keyVersionResourceID": "projects/my-project-common-0/locations/us-east4/keyRings/my-key-ring-0/cryptoKeys/my-key-0/cryptoKeyVersions/1"
                   }
                }'

Disable {encrypt-at-rest}
~~~~~~~~~~~~~~~~~~~~~~~~~

The following example disables {+encrypt-at-rest+} for |a-service|
project:

.. code-block:: sh
   :linenos:
   :emphasize-lines: 6-10

   curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
        --header "Accept: application/json" \
        --header "Content-Type: application/json" \
        --request PATCH "https://cloud.mongodb.com/api/atlas/v1.0/groups/{PROJECT-ID}/encryptionAtRest?pretty=true" \
        --data '
          {
            "awsKms": {
              "enabled" : false
            }
          }'

Example Response
----------------

.. tabs-cloud-providers::
   :hidden:

   .. tab::
      :tabid: aws

      .. code-block:: json
         :copyable: false
         :linenos:
         :emphasize-lines: 2-8

         {
           "awsKms" : {
             "accessKeyID" : "AKIAIOSFODNN7EXAMPLE",
             "customerMasterKeyID" : "030gce02-586d-48d2-a966-05ea954fde0g",
             "enabled" : true,
             "region" : "US_EAST_1",
             "valid" : true
           },
           "azureKeyVault" : {
             "clientID" : null,
             "enabled" : false,
             "keyIdentifier" : null,
             "keyVaultName" : null,
             "resourceGroupName" : null,
             "subscriptionID" : null,
             "tenantID" : null,
             "valid" : false
           }
         }

   .. tab::
      :tabid: azure

      .. code-block:: json
         :copyable: false
         :linenos:
         :emphasize-lines: 9-18

         {
           "awsKms" : {
             "accessKeyID" : null,
             "customerMasterKeyID" : null,
             "enabled" : false,
             "region" : null,
             "valid" : false
           },
           "azureKeyVault" : {
             "enabled" : true,
             "clientID" : "g54f9e2-89e3-40fd-8188-EXAMPLEID",
             "azureEnvironment" : "AZURE",
             "subscriptionID" : "0ec944e3-g725-44f9-a147-EXAMPLEID",
             "resourceGroupName" : "ExampleRGName",
             "keyVaultName" : "EXAMPLEKeyVault",
             "keyIdentifier" : "https://EXAMPLEKeyVault.vault.azure.net/keys/EXAMPLEKey/d891821e3d364e9eb88fbd3d11807b86",
             "tenantID" : "e8e4b6ba-ff32-4c88-a9af-dc17efegdf63"
           }
         }

   .. tab::
      :tabid: gcp

      .. code-block:: json
         :copyable: false
         :linenos:
         :emphasize-lines: 19-23

         {
           "awsKms" : {
             "accessKeyID" : null,
             "customerMasterKeyID" : null,
             "enabled" : false,
             "region" : null,
             "valid" : false
           },
           "azureKeyVault" : {
             "clientID" : null,
             "enabled" : false,
             "keyIdentifier" : null,
             "keyVaultName" : null,
             "resourceGroupName" : null,
             "subscriptionID" : null,
             "tenantID" : null,
             "valid" : false
           },
           "googleCloudKms" : {
             "enabled": true,
             "keyVersionResourceID" : "projects/my-project-common-0/locations/us-east4/keyRings/my-key-ring-0/cryptoKeys/my-key-0/cryptoKeyVersions/1"
             "valid" : true
           }
         }

Disable {encrypt-at-rest}
~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: json
   :copyable: false
   :linenos:
   :emphasize-lines: 5

   {
     "awsKms" : {
       "accessKeyID" : null,
       "customerMasterKeyID" : null,
       "enabled" : false,
       "region" : null,
       "valid" : false
     },
     "azureKeyVault" : {
       "clientID" : null,
       "enabled" : false,
       "keyIdentifier" : null,
       "keyVaultName" : null,
       "resourceGroupName" : null,
       "subscriptionID" : null,
       "tenantID" : null,
       "valid" : false
     },
     "googleCloudKms" : {
       "enabled": false,
       "keyVersionResourceID" : null,
       "valid" : false
     }
   }
