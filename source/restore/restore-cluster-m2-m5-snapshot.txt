.. _m2-m5-restore-snapshot:

========================================
Restore a Cluster from an M2/M5 Snapshot
========================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

|service| lets you restore data from an
:ref:`M2 or M5 cluster snapshot <m2-m5-snapshots>`. You can restore
``M2`` and ``M5`` snapshots to a cluster of size ``M2`` or greater.

Restore Restrictions
--------------------

- |service| can only restore ``M2`` and ``M5`` snapshots to a
  :term:`replica set` that does *not* use
  :doc:`Encryption at Rest </security-aws-kms>`.

- The target cluster must run the same major release version of
  MongoDB as the snapshot MongoDB version. For example, you can only
  restore a snapshot using MongoDB 4.0 to a target cluster running
  MongoDB 4.0.

Prerequisites
-------------

1. .. include:: /includes/fact-stop-ops-during-restore.rst

2. To :ref:`download your snapshot via HTTPS <m2-m5-download-https>`, 
   you must add the |ipaddr| or |cidr| addresses of the client
   downloading the snapshot to your |service|
   :ref:`project whitelist <whitelist>`.

Procedure
---------

1. From the :guilabel:`Clusters` view, click the cluster name.

#. Click the :guilabel:`Backup` tab.

#. Find the desired cluster snapshot to restore.

#. For the desired cluster, click :guilabel:`Restore` or
   :guilabel:`Download`.

#. Follow the prompts to restore your cluster. You may choose to:

   - :ref:`Download your snapshot via HTTPS <m2-m5-download-https>`

   - :ref:`Restore your snapshot to an Atlas cluster <m2-m5-restore-project>`

.. _m2-m5-download-https:

Download your Snapshot via |https|
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. In the :guilabel:`Snapshots` tab, locate the snapshot you wish to
   download in the :guilabel:`All Daily Snapshots` table.

#. In the :guilabel:`Actions` column of the table, click
   :guilabel:`Download`.
   
#. In the :guilabel:`Download` prompt, click either
   :guilabel:`Copy Link` or :guilabel:`Download` to download the
   snapshot.

   - When you click :guilabel:`Copy Link`, |service| generates a
     download link that expires within 4 hours. You can use this link 
     multiple times prior to its expiration.

   - When you click :guilabel:`Download`, the download process begins
     immediately.

|service| compresses the snapshot into a ``.tar.gz`` file. Use your
preferred archive utility to extract the archive and access the data
files.

Once extracted, you can access the data files by starting a
:binary:`~bin.mongod` instance on the host and pointing it at the
extract directory using the
:option:`--dbpath <mongod.--dbpath>` option.

Example
```````

The following command uses the ``tar`` utility to extract a ``tar``
archive with ``gzip`` compression:

.. code-block:: shell

   tar -xvzf ~/Downloads/mongodb-snapshots/my-cluster-snapshot.tar.gz

The following command starts a :binary:`~bin.mongod` instance using
the extracted data file directory:

.. code-block:: shell

   mongod --dbpath ~/Downloads/mongodb-snapshots/my-cluster-snapshot/

.. _m2-m5-restore-project:

Restore your Snapshot to an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-restore-cluster-downtime-warning.rst

You can restore to any |service| cluster in a project for which you
have the :authrole:`Project Owner` role.

1. In the :guilabel:`Snapshots` tab, locate the snapshot you wish to
   restore in the :guilabel:`All Daily Snapshots` table.

#. In the :guilabel:`Actions` column of the table, click
   :guilabel:`Restore`.

#. From the :guilabel:`Restore` dialog, select the target cluster to
   which you want to restore.

#. Click :guilabel:`Restore`.

#. Restart your application and ensure it uses the new target cluster.
