======================
MongoDB Backup Methods
======================

.. default-domain:: mongodb

.. contents::
   :backlinks: none
   :depth: 2
   :local:

When deploying MongoDB in production, you should have a strategy for
capturing and restoring backups in the case of data loss
events. MongoDB supports  for creating backs up
MongoDB, depending on your requirements and configuration.

Backup Methods
--------------

Use the MongoDB Management Service (MMS)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The `MongoDB Management Service
<https://mms.10gen.com/?pk_campaign=MongoDB-Org&pk_kwd=Backup-Docs>`_
supports :mms:`backup and restore for MongoDB deployments </backup>`.

MMS continually backs up MongoDB replica sets and sharded
systems by reading the oplog data from your MongoDB cluster.

MMS Backup offers point in time recovery of MongoDB replica sets and a
consistent snapshot of sharded systems.

MMS achieves point in time recovery by storing oplog data so that it
can create a restore for any moment in time in the last 24 hours for a
particular replica set.

For sharded systems, MMS does not provide restores for arbitrary moments in
time. MMS *does* provide periodic consistent snapshots of the entire
sharded cluster. Sharded cluster snapshots are difficult to achieve
with other MongoDB backup methods.

To restore a MongoDB cluster from an MMS Backup snapshot, you download
a compressed archive of your MongoDB data files and distribute those
files before restarting the :program:`mongod` processes.

To get started with MMS Backup, see the :mms:`MMS documentation
</backup>`.

Capture Underlying Data Files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can create a backup of MongoDB by copying the underlying data
files where MongoDB persists data and restoring them as needed.

If the volume where MongoDB stores data files supports point in time
snapshots, you can use these snapshots to create backups of a MongoDB
system at an exact moment in time.

File systems snapshots are an operating system volume manager feature,
and are not specific to MongoDB. The mechanics of snapshots depend on
the underlying storage system. For example, if you use
Amazonâ€™s EBS storage system for EC2 supports snaphots. On
Linux the LVM manager can create a snapshot.

To get a correct snapshot of a running :program:`mongod` process, you
must have journaling enabled and the journal must reside on the same
logical volume as the other MongoDB data files. Without journaling
enabled, there is no guarantee that the snapshot
will be consistent or valid.

To get a consistent snapshot of a sharded system, you must disable the
balance and capture a snapshot from every shard and a config server at
approximately the same moment in time.

If your storage system does not support snapshots, you can copy the
files directly using ``cp``, ``rsync``, or a similar tool. Since,
copying multiple files is not an atomic operation, you must stop all
writes to the :program:`mongod` copying the files. Otherwise, you will
copy the files in an inconsistent and invalid state.

Backups produced by copying the underlying data do not support point
in time recovery for replica sets and are difficult to manage for
larger sharded clusters. Additionally, these backups are not space
efficient: by capturing the data files directly you also copy the
indexes, duplicate any underlying storage padding and
fragmentation.:program:`mongodump` and :program:`mongorestore`, by
contrast, are space efficient.

For more information, see the
:doc:`/tutorial/backup-and-restore-with-filesystem-snapshots` and
:doc:`/tutorial/backup-sharded-cluster-with-filesystem-snapshots` for
complete instructions on using LVM to create snapshots. Also see
:ecosystem:`Back up and Restore Processes for MongoDB on Amazon EC2
</tutorial/backup-and-restore-mongodb-on-amazon-EC2>`.

MongoDB Dump and Restore Tools
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The :program:`mongodump` tool reads data from a MongoDB database and
creates high fidelity BSON data files. The :program:`mongorestore`
tool can populate a MongoDB database with the data from these BSON
files. These tools are simple and efficient for backing up small
MongoDB deployments, but are *not* ideal for capturing backups of larger
systems.

:program:`mongodump` and :program:`mongorestore` can operate against a
running :program:`mongod` process, and can manipulate the underlying
data files directly. By default, :program:`mongodump` does *not*
capture the contents of the :ref:`local database <local-database>`.

:program:`mongodump` only captures the documents in the database. The
resulting backup is space efficient, but :program:`mongorestore` or
:program:`mongod` must rebuild the indexes after restoring data.

When connected to a MongoDB instance, :program:`mongodump` and impact
:program:`mongod` performance. Because these tools use normal queries,
the performance depends on the activity of other clients. If your data
is larger than system memory, the queries will change the working set
of the :program:`mongod` instance.

To mitigate the impact of :program:`mongodump` on the performance of
the replica set, use :program:`mongodump` to capture backups from a
:ref:`secondary <replica-set-secondary>` member of a replica set.
Alternatively, you can shut down a secondary and use
:program:`mongodump` with the data files directly. If you shut down a
secondary to capture data with :program:`mongodump` ensure that the
operation can complete before its oplog becomes too stale to continue
replicating.

For replica sets, :program:`mongodump` also supports a point in time
feature with the :option:`--oplog <mongodump --oplog>`
option. Applications may continue modifying data while
:program:`mongodump` captures the output. To restore a point in time
backup created with :option:`--oplog <mongodump --oplog>`, use
:program:`mongorestore` with the :option:`--oplogReplay
<mongorestore --oplogReplay>` option.

See :doc:`/tutorial/backup-and-restore-with-binary-database-dumps`,
:doc:`/tutorial/backup-small-sharded-cluster-with-mongodump`,
and :doc:`/tutorial/backup-sharded-cluster-with-database-dumps`
for more information.

Further Reading
---------------

.. include:: /includes/toc/dfn-list-administration-backup-and-recovery.rst
