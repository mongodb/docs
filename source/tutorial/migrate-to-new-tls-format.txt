.. _migrate-to-new-tls-format:

===================================================
Upgrade from |k8s-op-short| 1.12 with |tls| Enabled
===================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/styles/corrections.rst

|k8s-op| 1.13 :v1.13:`introduced several changes 
</release-notes/#k8s-op-short>` to how it handles |tls| secrets for 
|onprem| and database deployments.

If you installed |k8s-op-short| 1.12 or earlier and you secure access to
your resources using |tls|, complete this task to upgrade to the latest
|k8s-op-short| version and migrate your opaque |tls| secrets to 
:k8sdocs:`kubernetes.io/tls 
</concepts/configuration/secret/#tls-secrets>` type secrets without
re-creating your MongoDB resources and incurring downtime.

Considerations
--------------

|k8s-op-short| can migrate your |tls| secrets when you
upgrade from 1.12 or earlier to the latest version for as long as 1.12
is supported. After |k8s-op-short| 1.12 reaches End of Life (EOL), you 
might not be able to migrate your |tls| secrets automatically when you 
upgrade.

Limitations
-----------

|k8s-op-short| doesn't migrate the following |tls| secret 
types: 

- |tls| secrets that contain X.509 certificates for internal 
  server authentication
- |tls| secrets that contain {+mdbagent+} X.509 certificates

You must manually migrate these types of |tls| secrets from opaque to
:k8sdocs:`kubernetes.io/tls 
</concepts/configuration/secret/#tls-secrets>` type secrets by creating
new secrets that contain the relevant certificates and signing keys. To
learn how to create these secrets, see the following resources:

- :ref:`secure-tls`
- :ref:`secure-internal-auth`

Prerequisites
-------------

- Before you migrate your |tls| secrets and upgrade |k8s-op-short|, your
  CRDs must use the following fields to describe your |tls| secrets:

  - Application Database |tls| secrets: :opsmgrkube:`applicationDatabase.security.tls.secretRef.prefix`
  - |onprem| |tls| secrets: :opsmgrkube:`security.tls.secretRef.prefix`
  - Database resource |tls| secrets: :setting:`security.tls.secretRef.prefix`

  If your CRDs use any of the following fields to describe your |tls| 
  secrets, you must first update your CRDs to use the fields listed
  above instead:

  -  Application Database |tls| secrets:
     ``spec.applicationDatabase.security.tls.secretRef.name``
  - |onprem| |tls| secrets: ``spec.security.tls.secretRef.name``
  - Database resource |tls| secrets: ``spec.security.tls.secretRef.name``

- You must disable internal cluster and X.509 authentication before you 
  upgrade |k8s-op-short| to its latest
  version.

  When the upgrade is complete, you can re-enable internal cluster and
  X.509 authentication.

Procedure
---------

.. include::  /includes/steps/migrate-to-new-tls-format.rst
