name: Build OpenAPI Pages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    # We might want to think about consolidating to some singular "/openapi" directory
    # For now, define each OpenAPI spec separately
    paths:
      - 'content/relational-migrator/source/rm-openapi-latest.json'
  pull_request:
    branches:
      - main
    paths:
      - 'content/relational-migrator/source/rm-openapi-latest.json'

jobs:
  # Identify which OpenAPI specs have changed
  detect-changed-specs:
    name: Detect Changed OpenAPI Specs
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
      - name: Run Paths Filter
        id: filter
        # Only run paths-filter for push/pull_request.
        # For workflow_dispatch, this step is skipped, and its outputs will be empty.
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          # Add more filters here for each spec. Ensure the key matches a filter_name set in build-oas-matrix.js
          filters: |
            rm_api:
              - 'content/relational-migrator/source/rm-openapi-latest.json'
      - name: Build Matrix
        id: build-matrix
        uses: actions/github-script@v7
        env:
          FILTER_OUTPUTS: ${{ toJSON(steps.filter.outputs || '{}') }}
        with:
          script: |
            const buildMatrix = require('./.github/scripts/build-oas-matrix.js');
            buildMatrix({ context, core });

  # Deploy OpenAPI docs to Bump
  deploy-doc:
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    needs: detect-changed-specs
    name: Deploy API documentation on Bump.sh for ${{ matrix.spec.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        spec: ${{ fromJson(needs.detect-changed-specs.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deploy API documentation
        uses: bump-sh/github-action@59eaae922e81ac8d127bd2b2ac6dc4804bda8a4c
        with:
          doc: ${{ vars[matrix.spec.doc_id_var] }}
          token: ${{ secrets.BUMP_TOKEN }}
          file: ${{ matrix.spec.file }}

  # Create preview pages for OpenAPI docs on Bump
  api-preview:
    if: ${{ github.event_name == 'pull_request' }}
    needs: detect-changed-specs
    name: Create API preview on Bump.sh for ${{ matrix.spec.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        spec: ${{ fromJson(needs.detect-changed-specs.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create API preview
        uses: bump-sh/github-action@59eaae922e81ac8d127bd2b2ac6dc4804bda8a4c
        with:
          doc: ${{ vars[matrix.spec.doc_id_var] }}
          token: ${{ secrets.BUMP_TOKEN }}
          file: ${{ matrix.spec.file }}
          branch: main
          command: preview
