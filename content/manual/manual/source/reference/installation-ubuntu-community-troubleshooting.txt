.. _install-ubuntu-troubleshooting:

===============
Troubleshooting
===============

.. default-domain:: mongodb

.. meta::
   :keywords: on-prem
   :description: Resolve common installation issues for MongoDB on Ubuntu, including public key errors, package conflicts, and data directory access problems.
                    
.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. |arrow| unicode:: U+27A4
.. |distro-name| replace:: Ubuntu

.. include:: /includes/minor-release.rst

Public Key Retrieval Errors
---------------------------

Occurs during the :guilabel:`Import the public key used by the package management system`
step of :ref:`install-community-ubuntu-pkg`.

.. code-block:: text
   :copyable: false

   gpg: no valid OpenPGP data found.

Solution
~~~~~~~~

Copy the command exactly as documented. The operation should respond with ``OK``.

Verify that the MongoDB public GPG key exists on your system:

.. code-block:: text

   sudo apt-key list

Expected output resembles the following:

.. code-block:: text
   :copyable: false

   /etc/apt/trusted.gpg
   --------------------
   pub   rsa4096 2018-04-18 [SC] [expires: 2023-04-17]
         {+pgp-fingerprint-fmt+}
   uid           [ unknown] MongoDB 8.0 Release Signing Key <packaging@mongodb.com> 


``sudo apt update`` Errors
--------------------------

Occurs after running ``sudo apt update`` as part of the
:ref:`install-community-ubuntu-pkg` procedure. Often caused by a missing MongoDB Public GPG key.

.. code-block:: text
   :copyable: false

   W: GPG error: https://repo.mongodb.org/apt/ubuntu <release>/mongodb-org/{+version+} Release: \
      The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 4B7C549A058F8B6B
   E: The repository 'https://repo.mongodb.org/apt/ubuntu <release>/mongodb-org/{+version+} Release' \
      is not signed.
   N: Updating from such a repository can't be done securely, and is therefore disabled by default.
   N: See apt-secure(8) manpage for repository creation and user configuration details.

Solution
~~~~~~~~

Repeat the :guilabel:`Import the public key used by the package management system`
step in :ref:`install-community-ubuntu-pkg`. Copy the command and key exactly
as documented.

Verify the key:

.. code-block:: text

   sudo apt-key list

Expected output:

.. code-block:: text
   :copyable: false

   --------------------
   pub   rsa4096 2018-04-18 [SC] [expires: 2023-04-17]
         {+pgp-fingerprint-fmt+}
   uid           [ unknown] MongoDB 8.0 Release Signing Key <packaging@mongodb.com>

``sudo apt install -y {+package-name-org+}`` Errors
---------------------------------------------------

Occurs after running ``sudo apt install -y {+package-name-org+}`` 
in step :guilabel:`Create a list file for MongoDB` of the
:ref:`install-community-ubuntu-pkg` procedure. Often caused by a missing or 
misconfigured ``/etc/apt/sources.list.d/mongodb-org-{+pgp-version+}.list`` file.

.. code-block:: text
   :copyable: false

   Reading package lists... Done
   Building dependency tree       
   Reading state information... Done
   E: Unable to locate package {+package-name-org+}

Solution
~~~~~~~~

1. Check the file contents:

   .. code-block:: text

      cat /etc/apt/sources.list.d/mongodb-org-{+pgp-version+}.list

2. If contents don't match the documentation for your Ubuntu version, remove
   the file and repeat :guilabel:`Create a list file for MongoDB` step.

3. If the file doesn't exist, create it during that step.

4. Update repositories and retry installation:

   .. code-block:: text

      sudo apt update
      sudo apt install -y {+package-name-org+}

``dpkg-deb: error`` Package Conflicts
-------------------------------------

Occurs during ``sudo apt install -y {+package-name-org+}`` step of the
:ref:`install-community-ubuntu-pkg` procedure. Often caused by a conflicting 
|distro-name| ``mongodb`` package already installed.

.. code-block:: text
   :copyable: false

   dpkg: error processing archive /var/cache/apt/archives/mongodb-org-server_{+version+}.0_amd64.deb (--unpack):
   trying to overwrite '/usr/bin/mongod', which is also in package mongodb-server-core 1:3.6.3-0ubuntu1

Solution
~~~~~~~~

Check for conflict:

.. code-block:: text

   sudo apt list --installed | grep mongo

.. code-block:: text
   :copyable: false

   mongodb/bionic,now 1:3.6.3-0ubuntu1 amd64 [installed]
   mongodb-clients/bionic,now 1:3.6.3-0ubuntu1 amd64 [installed,automatic]
   mongodb-server/bionic,bionic,now 1:3.6.3-0ubuntu1 all [installed,automatic]
   mongodb-server-core/bionic,now 1:3.6.3-0ubuntu1 amd64 [installed,automatic]

If output shows |distro-name| packages like this, remove them:

.. code-block:: text

   sudo apt remove mongodb
   sudo apt purge mongodb
   sudo apt autoremove

.. note::
   
   ``sudo apt purge mongodb`` removes default configuration files. To preserve 
   modified configuration files, copy them to another directory (e.g., 
   ``/home/your-user-name``) before purging.

For mixed packages:

If output shows both ``{+package-name-org+}`` and ``mongodb`` packages, remove
``{+package-name-org+}`` first, then remove ``mongodb`` packages. After
clearing all MongoDB-related packages, retry :ref:`install-community-ubuntu-pkg`.

``mongod`` Socket Errors
------------------------

Occurs when starting a :binary:`mongod <bin.mongod>`. Often caused by another 
process (typically another :binary:`mongod <bin.mongod>`) using the
configured port.

.. code-block:: text
   :copyable: false

   Socket is already in use

.. code-block:: text
   :copyable: false

   Failed to unlink socket file

Solution
~~~~~~~~

Identify the process:

The following example uses ``ss`` to list all open TCP (``-t``) and UDP (``-u``)
sockets in the ``LISTEN`` (``-l``) state and the process using each socket 
(``-p``) without resolving any service names or hostnames (``-n``):

.. code-block:: text

   sudo ss -tulpn

Example output showing ``mongod`` on port ``27017``:

.. code-block:: text
   :copyable: false

   Netid        State        Local Address:Port 
   udp          UNCONN       127.0.0.53%lo:53        users:(("systemd-resolve",pid=663,fd=12))
   udp          UNCONN   10.1.16.87%enp0s3:68        users:(("systemd-network",pid=652,fd=15))
   tcp          LISTEN       127.0.0.53%lo:53        users:(("systemd-resolve",pid=663,fd=13))
   tcp          LISTEN             0.0.0.0:22        users:(("sshd",pid=819,fd=3))
   tcp          LISTEN        192.168.1.15:27017     users:(("mongod",pid=10027,fd=12))
   tcp          LISTEN           127.0.0.1:27017     users:(("mongod",pid=10027,fd=11))
   tcp          LISTEN                 ::]:22        users:(("sshd",pid=819,fd=4))

You can either:

- Shut down the existing process
- Select a new port for the conflicting :binary:`mongod <bin.mongod>` process:
   1. Modify :setting:`net.port` in the :ref:`configuration file <configuration-file>`
   2. Use :option:`--port <mongod --port>` on the command line

Data Directory Errors
---------------------

Occurs in the :binary:`mongod <bin.mongod>` 
:ref:`process log <monitoring-standard-loggging>`. Often caused by a data 
directory that doesn't exist or isn't accessible to the
:binary:`mongod <bin.mongod>`.

.. code-block:: text
   :copyable: false

   Data directory ... not found

   Attempted to create lock file on a read-only directory: ...

When starting as a service (``sudo systemctl start mongod`` or ``sudo 
service mongod start``), this may mean:

- :setting:`~storage.dbPath` in ``/etc/mongod.conf`` points to a directory
  without ``rwx`` permissions for ``mongodb`` user or group
- :setting:`~storage.dbPath` points to a nonexistent directory

When starting from the terminal, this may mean:

- :setting:`~storage.dbPath` or :option:`--dbpath <mongod --dbpath>` points to
  a directory without ``rwx`` permissions for the user or their group
- The Directory doesn't exist

Solution
~~~~~~~~

Depending on the cause, either create the data directory or set appropriate
permissions and ownership.

- Create the directory:

  Specify the data directory with :setting:`storage.dbPath` in the
  :ref:`configuration file <configuration-file>` or
  :option:`--dbpath <mongod --dbpath>` on the command line.

- Set default paths:

  - ``apt`` package manager installation: The default ``/etc/mongod.conf``
    :ref:`configuration file <configuration-file>` sets :setting:`storage.dbPath`
    to ``/var/lib/mongodb``
  - :binary:`mongod <bin.mongod>` on the command line without
    :option:`--dbpath <mongod --dbpath>`: ``/data/db``

  Ensure that the data directory exists or create the directory  using ``mkdir``
  before starting :binary:`mongod <bin.mongod>`.

- Set directory permissions:

  Set appropriate permissions and ownership:

  - The :binary:`mongod <bin.mongod>` needs ``rwx`` (read, write, execute)
    permissions
  - Use ``chown`` and ``chmod`` to configure ``user:group`` ownership and
    permissions prior to starting the :binary:`mongod <bin.mongod>`
