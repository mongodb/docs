# MongoDB Search with External MongoDB (No TLS) - Quick Start

This guide shows how to deploy MongoDB Search in Kubernetes and connect it to an existing external MongoDB replica set
without TLS. The mongot component runs in the cluster, while the MongoDB replica set exists externally.

## Prerequisites

Before you begin, ensure you have the following tools and configurations in place:

- **Kubernetes cluster**: A running Kubernetes cluster (e.g., Minikube, Kind, GKE, EKS, AKS) with kubeconfig available
  locally.
- **kubectl**: The Kubernetes command-line tool, configured to communicate with your cluster.
- **Helm**: The package manager for Kubernetes, used here to install the MongoDB Kubernetes Operator.
- **Bash 5.1+**: All shell commands in this guide are intended to be run in Bash. Scripts in this guide are
  automatically tested on Linux with Bash 5.1.
- **External MongoDB**: An existing MongoDB Community replica set (version 8.0.10 or higher) that will serve as the data
  source for search.

## Setup Steps

The following steps guide you through deploying MongoDB Search to connect to your external MongoDB. Each step provides a
shell script.
**It is important to first source the `env_variables.sh` script provided and customize its values for your environment.
**
The subsequent script snippets rely on the environment variables defined in `env_variables.sh`. You should copy and
paste each script into your Bash terminal.

### 1. Configure Environment Variables

First, you need to set up your environment. The `env_variables.sh` script, shown below, contains variables for the
subsequent steps. You should create this file locally or use the linked one.

Download or copy the content of `env_variables.sh`:
[env_variables.sh](env_variables.sh)

```shell copy
# set it to the context name of the k8s cluster
export K8S_CTX="<local cluster context>"

# the following namespace will be created if not exists
export MDB_NS="mongodb"

# minimum required MongoDB version for running MongoDB Search is 8.0.10
export MDB_VERSION="8.0.10"

# root admin user for convenience, not used here at all in this guide
export MDB_ADMIN_USER_PASSWORD="admin-user-password-CHANGE-ME"
# regular user performing restore and search queries on sample mflix database
export MDB_USER_PASSWORD="mdb-user-password-CHANGE-ME"
# user for MongoDB Search to connect to the replica set to synchronise data from
export MDB_SEARCH_SYNC_USER_PASSWORD="search-sync-user-password-CHANGE-ME"

export MDB_SEARCH_SERVICE_NAME="mdbs-search"
export MDB_SEARCH_HOSTNAME="mdbs-search.example.com"

# External MongoDB replica set members - REPLACE THESE VALUES with your actual external MongoDB hosts
# For testing purposes, these point to the MongoDB Community resource created by test.sh
# In production, replace with your actual external MongoDB replica set members
export MDB_EXTERNAL_HOST_0="mdbc-rs-0.mdbc-rs-svc.${MDB_NS}.svc.cluster.local:27017"
export MDB_EXTERNAL_HOST_1="mdbc-rs-1.mdbc-rs-svc.${MDB_NS}.svc.cluster.local:27017"
export MDB_EXTERNAL_HOST_2="mdbc-rs-2.mdbc-rs-svc.${MDB_NS}.svc.cluster.local:27017"
# REPLACE with your external MongoDB keyfile secret name
export MDB_EXTERNAL_KEYFILE_SECRET_NAME="mdbc-rs-keyfile"
# REPLACE with the actual keyfile content from your external MongoDB replica set
# For testing, this will be automatically generated by the MongoDB Community resource
export MDB_EXTERNAL_KEYFILE_CONTENT="your-mongodb-keyfile-content-CHANGE-ME"
# REPLACE with your actual external MongoDB replica set name
export MDB_EXTERNAL_REPLICA_SET_NAME="mdbc-rs"

export OPERATOR_HELM_CHART="mongodb/mongodb-kubernetes"
# comma-separated key=value pairs for additional parameters passed to the helm-chart installing the operator
export OPERATOR_ADDITIONAL_HELM_VALUES=""
```

This will load the variables into your current shell session, making them available for the commands in the following
steps.

### 2. Add MongoDB Helm Repository

First, add the MongoDB Helm repository. This repository contains the Helm chart required to install the MongoDB
Kubernetes Operator. The operator automates the deployment and management of MongoDB Search instances on Kubernetes.

[code_snippets/090_helm_add_mogodb_repo.sh](code_snippets/090_helm_add_mogodb_repo.sh)

```shell copy
helm repo add mongodb https://mongodb.github.io/helm-charts
helm repo update mongodb
helm search repo mongodb/mongodb-kubernetes
```

### 3. Install MongoDB Kubernetes Operator

Next, install the MongoDB Kubernetes Operator from the Helm repository you just added. The Operator will watch for
MongoDBSearch custom resources and manage the lifecycle of your MongoDB Search deployments.

[code_snippets/0100_install_operator.sh](code_snippets/0100_install_operator.sh)

```shell copy
helm upgrade --install --debug --kube-context "${K8S_CTX}" \
  --create-namespace \
  --namespace="${MDB_NS}" \
  mongodb-kubernetes \
  --set "${OPERATOR_ADDITIONAL_HELM_VALUES:-"dummy=value"}" \
  "${OPERATOR_HELM_CHART}"
```

This command installs the operator in the `mongodb` namespace (creating it if it doesn't exist).

## Deploying MongoDB Search

With the prerequisites and initial setup complete, you can now deploy MongoDB Search to connect to your external
MongoDB.

### 4. Create User Secrets

MongoDB Search requires authentication credentials to connect to your external MongoDB, and you'll also need credentials
for testing the search functionality. This step creates Kubernetes secrets for all required passwords: the search
synchronization user, admin user, and regular user passwords that must exist in your external MongoDB.

[code_snippets/04_0305_create_mongodb_community_user_secrets.sh](code_snippets/04_0305_create_mongodb_community_user_secrets.sh)

```shell copy
kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic mdb-admin-user-password \
  --from-literal=password="${MDB_ADMIN_USER_PASSWORD}"

kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic mdbc-rs-search-sync-source-password \
  --from-literal=password="${MDB_SEARCH_SYNC_USER_PASSWORD}"

kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic mdb-user-password \
  --from-literal=password="${MDB_USER_PASSWORD}"
```

Ensure these secrets are created in the same namespace where you plan to deploy MongoDB Search.

### 5. Create External MongoDB Keyfile Secret

Your external MongoDB replica set uses a keyfile for internal authentication between replica set members. MongoDB Search
needs access to this same keyfile to authenticate with your external MongoDB. This step creates a Kubernetes secret
containing the keyfile content from your external MongoDB.

**Important**: You must obtain the keyfile content from your external MongoDB replica set. This is typically a
base64-encoded string or the raw keyfile content used by your MongoDB instances.

[code_snippets/04_0318_create_external_keyfile_secret.sh](code_snippets/04_0318_create_external_keyfile_secret.sh)

```shell copy
kubectl --context "${K8S_CTX}" --namespace "${MDB_NS}" \
  create secret generic "${MDB_EXTERNAL_KEYFILE_SECRET_NAME}" \
  --from-literal=keyfile="${MDB_EXTERNAL_KEYFILE_CONTENT}"
```

**Note**: Make sure to set the `MDB_EXTERNAL_KEYFILE_CONTENT` environment variable to the exact keyfile content used by
your external MongoDB replica set.

### 6. Create MongoDB Search Resource

Deploy a `MongoDBSearch` resource named `mdbs` that connects to your external MongoDB replica set. The Search resource
lists the external replica set members under `spec.source.external.hostAndPorts` and uses the search synchronization
user credentials. TLS is disabled in this example.

Note: Public Preview of MongoDB Community Search comes with some limitations, and it is not suitable for production use:

* Only one instance of the search node is supported (load balancing is not supported)

[code_snippets/0320_create_mongodb_search_resource.sh](code_snippets/0320_create_mongodb_search_resource.sh)

```shell copy
kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<EOF
apiVersion: mongodb.com/v1
kind: MongoDBSearch
metadata:
  name: mdbs
spec:
  source:
    external:
      hostAndPorts:
        - ${MDB_EXTERNAL_HOST_0}
        - ${MDB_EXTERNAL_HOST_1}
        - ${MDB_EXTERNAL_HOST_2}
      keyfileSecretRef:
        name: ${MDB_EXTERNAL_KEYFILE_SECRET_NAME}
        key: keyfile
    username: search-sync-source
    passwordSecretRef:
      name: mdbc-rs-search-sync-source-password
      key: password
  resourceRequirements:
    limits:
      cpu: "3"
      memory: 5Gi
    requests:
      cpu: "2"
      memory: 3Gi
EOF
```

The `MongoDBSearch.spec` fields in this example are:

* `spec.source.external.hostAndPorts` - list of external MongoDB replica set members.
* `spec.source.external.keyfileSecretRef` - reference to the keyfile secret used by the external replica set.
* `spec.source.external.tls.enabled` - set to `false` to disable TLS between mongot and mongod.
* `spec.username` and `spec.passwordSecretRef` - credentials for the search synchronization user in the external
  MongoDB.
* `spec.resourceRequirements` - resource requests and limits for the search container.

### 7. Create LoadBalancer Service for External Search Access

To enable your external MongoDB instances to connect to the search service, create a LoadBalancer service that exposes
the search pods outside the Kubernetes cluster. This step creates a LoadBalancer service and waits for it to receive an
external IP address or hostname.

[code_snippets/04_0322_create_search_loadbalancer_service.sh](code_snippets/04_0322_create_search_loadbalancer_service.sh)

```shell copy
kubectl apply --context "${K8S_CTX}" -n "${MDB_NS}" -f - <<YAML
apiVersion: v1
kind: Service
metadata:
  name: ${MDB_SEARCH_HOSTNAME}
spec:
  type: LoadBalancer
  selector:
    app: mdbs-search-svc
  ports:
    - name: mongot
      port: 27027
      targetPort: 27027
YAML

# Wait for LoadBalancer to get an external IP/hostname
echo "Waiting for LoadBalancer to get an external IP..."
for i in {1..60}; do
  SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
  if [ -z "${SEARCH_IP}" ]; then
    SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
  fi

  if [ -n "${SEARCH_IP}" ]; then
    echo "LoadBalancer external address: ${SEARCH_IP}"
    break
  fi

  echo "Attempt ${i}/60: Waiting for external IP/hostname..."
  sleep 5
done

if [ -z "${SEARCH_IP}" ]; then
  echo "Error: LoadBalancer failed to get an external IP/hostname after 5 minutes"
  exit 1
fi
```

This service exposes the MongoDB Search service on port 27027 with an external IP address or hostname that can be
accessed from outside the Kubernetes cluster.

#### Alternative Service Exposure Methods

While this guide uses a LoadBalancer service, there are other ways to expose search pods outside the cluster:

**NodePort Service**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ${MDB_SEARCH_HOSTNAME}
spec:
  type: NodePort
  selector:
    app: mdbs-search-svc
  ports:
    - name: mongot
      port: 27027
      targetPort: 27027
      nodePort: 30027  # Optional: specify port 30000-32767
```

Access via `<NodeIP>:<NodePort>` from any cluster node.

**Ingress with TCP Support**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: search-ingress
  annotations:
    nginx.ingress.kubernetes.io/tcp-services-configmap: ${MDB_NS}/tcp-services
spec:
# Configure TCP passthrough for port 27027
```

Requires an ingress controller that supports TCP services (like NGINX).

**ClusterIP with Port Forwarding** (Development only)

```bash
kubectl port-forward -n ${MDB_NS} svc/${MDB_SEARCH_HOSTNAME} 27027:27027
```

Suitable for local development and testing only.

### 8. Update CoreDNS Configuration for External Access

When using external MongoDB instances, you need to configure DNS resolution so that the external MongoDB can resolve the
search service hostname. This step updates the CoreDNS configuration to map the search hostname to the LoadBalancer's
external IP address.

[code_snippets/04_0323_update_coredns_configmap.sh](code_snippets/04_0323_update_coredns_configmap.sh)

```shell copy
# Fetch the LoadBalancer external IP/hostname
SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
if [ -z "${SEARCH_IP}" ]; then
  SEARCH_IP=$(kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get svc "${MDB_SEARCH_HOSTNAME}" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
fi

if [ -z "${SEARCH_IP}" ]; then
  echo "Error: Could not get LoadBalancer external IP/hostname for service ${MDB_SEARCH_HOSTNAME}"
  exit 1
fi

echo "Using LoadBalancer external address: ${SEARCH_IP}"

kubectl --context "${K8S_CTX}" -n kube-system apply -f - <<YAML
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
data:
  Corefile: |
    .:53 {
        errors
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
        hosts {
           ${SEARCH_IP} ${MDB_SEARCH_HOSTNAME}
           fallthrough
        }
    }
YAML

kubectl --context "${K8S_CTX}" -n kube-system rollout restart deployment coredns
```

This configuration allows external MongoDB instances to resolve the search service hostname to the LoadBalancer's
external IP address.

### 9. Wait for Search Resource to be Ready

The Search deployment needs time to initialize. This step uses `kubectl wait` to pause until the `MongoDBSearch`
resource `mdbs` reports a `Running` status in its `.status.phase` field, indicating that the search nodes are
operational and ready to serve search requests.

[code_snippets/0325_wait_for_search_resource.sh](code_snippets/0325_wait_for_search_resource.sh)

```shell copy
echo "Waiting for MongoDBSearch resource to reach Running phase..."
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" wait \
  --for=jsonpath='{.status.phase}'=Running mdbs/mdbs --timeout=300s
```

This command polls the status of the `MongoDBSearch` resource `mdbs`.

### 10. List Running Search Pods

View the running search pods in your namespace. You should see pods for the MongoDB Kubernetes Operator and the MongoDB
Search nodes. Since we're connecting to external MongoDB, we only need to check the search-related resources.

[code_snippets/0335_show_running_pods.sh](code_snippets/0335_show_running_pods.sh)

```shell copy
echo; echo "MongoDBSearch resource"
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get mdbs/mdbs
echo; echo "Search pods running in cluster ${K8S_CTX}"
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get pods -l app=mdbs-search-svc
echo; echo "All pods in namespace ${MDB_NS}"
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" get pods
```

## Using MongoDB Search

Now that your MongoDB Search is deployed and connected to your external MongoDB, you can start using its search
capabilities.

### 11. Deploy MongoDB Tools Pod

To interact with your external MongoDB deployment for testing, this step deploys a utility pod named
`mongodb-tools-pod`. This pod runs a MongoDB Community Server image and is kept running with a `sleep infinity` command,
allowing you to use `kubectl exec` to run MongoDB client tools like `mongosh` and `mongorestore`.

[code_snippets/0410_run_mongodb_tools_pod.sh](code_snippets/0410_run_mongodb_tools_pod.sh)

```shell copy
kubectl apply -n "${MDB_NS}" --context "${K8S_CTX}" -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: mongodb-tools-pod
  labels:
    app: mongodb-tools
spec:
  containers:
  - name: mongodb-tools
    image: mongodb/mongodb-community-server:${MDB_VERSION}-ubi8
    command: ["/bin/bash", "-c"]
    args: ["sleep infinity"]
  restartPolicy: Never
EOF

echo "Waiting for the mongodb-tools to be ready..."
kubectl --context "${K8S_CTX}" -n "${MDB_NS}" wait \
  --for=condition=Ready pod/mongodb-tools-pod --timeout=60s
```

### 12. Import Sample Data

To test the search functionality, this step imports the `sample_mflix.movies` collection into your external MongoDB. It
downloads the sample dataset and uses `mongorestore` to load the data into the `sample_mflix` database.

[code_snippets/0420_import_movies_mflix_database.sh](code_snippets/0420_import_movies_mflix_database.sh)

```shell copy
kubectl exec -n "${MDB_NS}" --context "${K8S_CTX}" \
  mongodb-tools-pod -- /bin/bash -eu -c "$(cat <<EOF
echo "Downloading sample database archive..."
curl https://atlas-education.s3.amazonaws.com/sample_mflix.archive \
  -o /tmp/sample_mflix.archive
echo "Restoring sample database"
mongorestore \
  --archive=/tmp/sample_mflix.archive \
  --verbose=1 \
  --drop \
  --nsInclude 'sample_mflix.*' \
  --uri="mongodb://mdb-user:${MDB_USER_PASSWORD}@mdbc-rs-0.mdbc-rs-svc.${MDB_NS}.svc.cluster.local:27017/?replicaSet=mdbc-rs"
EOF
)"
```

This command uses `mongorestore` from the `mongodb-tools-pod` to load data from the downloaded `sample_mflix.archive`
file.

### 13. Create Search Index

Before performing search queries, create a search index. This step uses `kubectl exec` to run `mongosh` in the
`mongodb-tools-pod`. It connects to the external MongoDB and calls `db.movies.createSearchIndex()` to create a search
index named "default" with dynamic mappings on the `movies` collection. Dynamic mapping automatically indexes all fields
with supported types.

[code_snippets/0430_create_search_index.sh](code_snippets/0430_create_search_index.sh)

```shell copy
kubectl exec --context "${K8S_CTX}" -n "${MDB_NS}" mongodb-tools-pod -- \
  mongosh --quiet \
    "mongodb://mdb-user:${MDB_USER_PASSWORD}@mdbc-rs-0.mdbc-rs-svc.${MDB_NS}.svc.cluster.local:27017/?replicaSet=mdbc-rs" \
    --eval "use sample_mflix" \
    --eval 'db.movies.createSearchIndex("default", { mappings: { dynamic: true } });'
```

### 14. Wait for Search Index to be Ready

Creating a search index is an asynchronous operation. This script waits for the search index to be created and ready for
use.

[code_snippets/0440_wait_for_search_index_ready.sh](code_snippets/0440_wait_for_search_index_ready.sh)

```shell copy
# Currently it's not possible to check the status of search indexes, we need to just wait
echo "Sleeping to wait for search indexes to be created"
sleep 60
```

### 15. Execute a Search Query

Once the search index is ready, execute search queries using the `$search` aggregation pipeline stage. MongoDB Search
supports various types of queries such as text search, autocomplete, faceting, and more. You can combine `$search` with
other aggregation stages to further refine and process your results.

[code_snippets/0450_execute_search_query.sh](code_snippets/0450_execute_search_query.sh)

```shell copy
mdb_script=$(cat <<'EOF'
use sample_mflix;
db.movies.aggregate([
  {
    $search: {
      "compound": {
        "must": [ {
          "text": {
            "query": "baseball",
            "path": "plot"
          }
        }],
        "mustNot": [ {
          "text": {
            "query": ["Comedy", "Romance"],
            "path": "genres"
          }
        } ]
      },
      "sort": {
        "released": -1
      }
    }
  },
  {
    $limit: 3
  },
  {
    $project: {
      "_id": 0,
      "title": 1,
      "plot": 1,
      "genres": 1,
      "released": 1
    }
  }
]);
EOF
)

kubectl exec --context "${K8S_CTX}" -n "${MDB_NS}" \
  mongodb-tools-pod -- /bin/bash -eu -c "$(cat <<EOF
echo '${mdb_script}' > /tmp/mdb_script.js
mongosh --quiet "mongodb://mdb-user:${MDB_USER_PASSWORD}@mdbc-rs-0.mdbc-rs-svc.${MDB_NS}.svc.cluster.local:27017/?replicaSet=mdbc-rs" < /tmp/mdb_script.js
EOF
)"
```
