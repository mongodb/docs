
.. _index-type-sparse:

==============
Sparse Indexes
==============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Sparse indexes only contain entries for documents that have the indexed
field, even if the index field contains a null value. The index skips
over any document that is missing the indexed field. The index is
"sparse" because it does not include all documents of a collection. By
contrast, non-sparse indexes contain all documents in a collection,
storing null values for those documents that do not contain the indexed
field.

.. important::

   :ref:`Partial indexes <partial-sparse-index-comparison>` can function as 
   sparse indexes, but also support filter expressions for conditions beyond 
   whether a field exists. Use a partial index for greater 
   control if you need precise filtering.

Create a Sparse Index
---------------------

To create a sparse index, use the :method:`db.collection.createIndex()`
method with the ``sparse`` option set to ``true``.

For example, the following operation in :binary:`~bin.mongosh` creates a
sparse index on the ``plot`` field of the ``movies`` collection:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/create-1.js
   :language: javascript
   :category: usage example

The index does not index documents that do not include the ``plot``
field.

.. note::

   Do not confuse sparse indexes in MongoDB with `block-level`_
   indexes in other databases. Think of them as dense indexes with a
   specific filter.

   .. _`block-level`: http://en.wikipedia.org/wiki/Database_index#Sparse_index

Behavior
--------

Sparse Index and Incomplete Results
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If a sparse index would result in an incomplete result set for queries
and sort operations, MongoDB will not use that index unless a
:method:`~cursor.hint()` explicitly specifies the index.

For example, the query ``{ plot: { $exists: false } }`` will not use a
sparse index on the ``plot`` field unless explicitly hinted. See
:ref:`sparse-index-incomplete-results` for an example that details the
behavior.

.. include:: /includes/fact-sparse-index-hint-count.rst

Indexes that are Sparse by Default
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following index types are always sparse:

- :ref:`2d <2d-index>`

- :ref:`2dsphere (version 2) <2dsphere-v2>`

- :ref:`Text <index-feature-text>`

- :ref:`Wildcard <wildcard-index-core>`

.. _sparse-compound-indexes:

Sparse Compound Indexes
~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/indexes/sparse-compound-indexes.rst

.. _sparse-unique-index:

Sparse and Unique Properties
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

An index that is both sparse and :ref:`unique <index-type-unique>`
prevents a collection from having documents with duplicate values for a
field but allows multiple documents that omit the key.

Examples
--------

Create a Sparse Index On A Collection
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following example creates a sparse index on the field ``password``:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/create-2.js
   :language: javascript
   :category: usage example

Then, the following query on the ``users`` collection uses the sparse
index to return the documents that have the ``password`` field:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/query-1.js
   :language: javascript
   :category: usage example

If a user does not contain the
``password`` field, the query does not return that user. 

.. _sparse-index-incomplete-results:

Sparse Index On A Collection Cannot Return Complete Results
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consider the ``movies`` collection where some documents do not have a ``plot``
field.

The following example creates a sparse index on the field ``plot``:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/create-1.js
   :language: javascript
   :category: usage example

Consider the following query to return **all** documents in the ``movies``
collection, sorted by the ``plot`` field:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/query-2.js
   :language: javascript
   :category: usage example

Even though the sort is by the indexed field, if some documents in the
``movies`` collection do not have a ``plot`` field, MongoDB does **not** select
the sparse index to fulfill the query in order to return complete results.

To use the sparse index, explicitly specify the index with
:method:`~cursor.hint()`:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/query-3.js
   :language: javascript
   :category: usage example

This query only returns documents in the ``movies`` collection that contain the
``plot`` field. 

.. seealso::

   - :method:`~cursor.explain()`
   - :doc:`/tutorial/analyze-query-plan`


Sparse Index with Unique Constraint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following operation creates an index with a :ref:`unique constraint
<index-type-unique>` and sparse filter on the ``password`` field in the
``users``:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/create-4.js
   :language: javascript
   :category: usage example

This index *would permit* the insertion of documents that had unique
values for the ``password`` field *or* did not include a ``password`` field.
As such, given the existing documents in the ``users`` collection, the
index permits the following :doc:`insert operations
</tutorial/insert-documents>`:

.. literalinclude:: /code-examples/tested/command-line/mongosh/indexes/sparse/insert.js
   :language: javascript
   :category: usage example

However, the index *would not permit* the addition of the 
documents that contain email addresses that already exist in the collection.

.. _sparse-and-non-sparse_example:

Sparse and Non-Sparse Unique Indexes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-5.0-sparse-unique-index-updates.rst
