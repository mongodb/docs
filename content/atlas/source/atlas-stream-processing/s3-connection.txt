.. _atlas-sp-s3-connection:

==================
AWS S3 Connections
==================

.. default-domain:: mongodb

.. meta::
   :keywords: atlas stream processing, streaming data, real time, data processing, s3, s3 bucket, aws, amazon web services
   :description: Learn how to create and configure sink connections to AWS S3 buckets in your Stream Processing Instance connection registry

.. facet::
   :name: genre
   :values: tutorial

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

{+atlas-sp+} supports only sink connections to {+aws+} |s3| buckets.

.. _atlas-sp-s3-connection-add:

Add an {+aws+} S3 Connection
--------------------------------------------------------------

To add an S3 connection to your {+spi+}'s connection registry:

.. composable-tutorial::
   :options: interface, connection-type
   :defaults: atlas-ui, public

   .. selected-content::
      :selections: atlas-cli, public

      .. procedure::
         :style: normal

	 .. step:: Set up Unified AWS Access.

	    Follow the procedure described in `Set Up Unified AWS
	    Access
	    <https://docs.mongodb.com/atlas/security/set-up-unified-aws-access/?interface=atlas-admin-api>`__.

	    Ensure that you grant your IAM role ``ListAllMyBuckets`` and
	    ``PutObject`` permissions.

	    Note the ARN value in ``Statement.Principal.AWS`` for later in this
	    procedure.

	 .. include:: /includes/nav/steps-project-access-manager

	 .. step:: Create an API key.

	    The :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>` API endpoint
	    requires digest authorization when creating an S3 Connection. To
	    support this, you must create an API Key.

	    a. In the :guilabel:`Project Access Manager`, select the
	       :guilabel:`Applications` tab, then click :guilabel:`API Keys`.

	    b. Click :guilabel:`Create API Key`. Provide a short description
	       for the key.

	    c. In the :guilabel:`Project Permissions` dropdown menu,
	       select both the :guilabel:`Project Stream Processing Owner` and
	       :guilabel:`Project Owner` roles. Click :guilabel:`Next`.

	    d. Save both the public and private keys for later in this procedure.

         .. step:: Create the S3 connection.

            .. include:: /includes/extracts/atlas-streams-connections-create.rst

            In your configuration file, set the following key-value pairs:

	    .. list-table::
	       :widths: 35 65
	       :header-rows: 1

	       * - Key
		 - Value

	       * - ``type``
		 - ``"S3"``

	       * - ``aws.roleArn``
		 - Value of the ARN noted in an earlier step.

   .. selected-content::
      :selections: atlas-ui, public

      .. procedure::
         :style: normal

	 .. step:: Set up Unified AWS Access.

	    Follow the procedure described in `Set Up Unified AWS
	    Access
	    <https://docs.mongodb.com/atlas/security/set-up-unified-aws-access/?interface=atlas-ui>`__.

	    Ensure that you grant your IAM role ``ListAllMyBuckets`` and
	    ``PutObject`` permissions.

	    Note the ARN value in ``Statement.Principal.AWS`` for later in this
	    procedure.

	 .. include:: /includes/nav/steps-project-access-manager

	 .. step:: Create an API key.

	    The :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>` API endpoint
	    requires digest authorization when creating an S3 Connection. To
	    support this, you must create an API Key.

	    a. In the :guilabel:`Project Access Manager`, select the
	       :guilabel:`Applications` tab, then click :guilabel:`API Keys`.

	    b. Click :guilabel:`Create API Key`. Provide a short description
	       for the key.

	    c. In the :guilabel:`Project Permissions` dropdown menu,
	       select both the :guilabel:`Project Stream Processing Owner` and
	       :guilabel:`Project Owner` roles. Click :guilabel:`Next`.

	    d. Save both the public and private keys for later in this procedure.

	 .. include:: /includes/nav/steps-stream-processing.rst  

	 .. step:: Go to the :guilabel:`Connection Registry`.  

	    a. Locate the overview panel of the {+spi+} you want to  
	       modify and click :guilabel:`Configure`.  

	    #. Select the :guilabel:`Connection Registry` tab.  

	 .. step:: Click :guilabel:`+ Add connection`.  

	 .. step:: Add a new connection.  

	    a. Select an :guilabel:`S3` connection.  

	    #. Provide a :guilabel:`Connection Name`. Each connection
	       name must be unique within a {+spi+}.  This is the name
	       used to reference the connection in {+atlas-sp+}
	       :ref:`aggregations <stream-aggregation>`.

            #. From the :guilabel:`AWS IAM Role ARN` drodpwon, select
               the ARN of the unified access role you authorized in a
               prior step.

            #. Click :guilabel:`Add connection`.

   .. selected-content::
      :selections: atlas-admin-api, public

      .. procedure::
	 :style: normal

	 .. step:: Set up Unified AWS Access.

	    Follow the procedure described in `Set Up Unified AWS
	    Access
	    <https://docs.mongodb.com/atlas/security/set-up-unified-aws-access/?interface=atlas-admin-api>`__.

	    Ensure that you grant your IAM role ``ListAllMyBuckets`` and
	    ``PutObject`` permissions.

	    Note the ARN value in ``Statement.Principal.AWS`` for later in this
	    procedure.

	 .. include:: /includes/nav/steps-project-access-manager

	 .. step:: Create an API key.

	    The :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>` API endpoint
	    requires digest authorization when creating an S3 Connection. To
	    support this, you must create an API Key.

	    a. In the :guilabel:`Project Access Manager`, select the
	       :guilabel:`Applications` tab, then click :guilabel:`API Keys`.

	    b. Click :guilabel:`Create API Key`. Provide a short description
	       for the key.

	    c. In the :guilabel:`Project Permissions` dropdown menu,
	       select both the :guilabel:`Project Stream Processing Owner` and
	       :guilabel:`Project Owner` roles. Click :guilabel:`Next`.

	    d. Save both the public and private keys for later in this procedure.

	 .. step:: Create the S3 Connection.

	    The {+atlas-admin-api+} provides an endpoint to
	    :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>`. You must send this
	    request using digest authorization.

	    In your HTTP request interface, enable digest authorization. For
	    the ``username``, provide the public key you generated
	    previously. For the ``password``, provide the private key you
	    generated previously.

	    For an {+aws+} |s3| connection, set the following key-value pairs:

	    .. list-table::
	       :widths: 35 65
	       :header-rows: 1

	       * - Key
		 - Value

	       * - ``type``
		 - ``"S3"``

	       * - ``aws.roleArn``
		 - Value of the ARN noted in an earlier step.

   .. selected-content::
      :selections: atlas-admin-api, private-link

      .. procedure::
         :style: normal
	 
	 .. step:: Set up Unified AWS Access.

	    Follow the procedure described in `Set Up Unified AWS
	    Access
	    <https://docs.mongodb.com/atlas/security/set-up-unified-aws-access/?interface=atlas-admin-api>`__.

	    Ensure that you grant your IAM role ``ListAllMyBuckets`` and
	    ``PutObject`` permissions.

	    Note the ARN value in ``Statement.Principal.AWS`` for later in this
	    procedure.

	 .. include:: /includes/nav/steps-project-access-manager

	 .. step:: Create an API key.

	    The :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>` API endpoint
	    requires digest authorization when creating an S3 Connection. To
	    support this, you must create an API Key.

	    a. In the :guilabel:`Project Access Manager`, select the
	       :guilabel:`Applications` tab, then click :guilabel:`API Keys`.

	    b. Click :guilabel:`Create API Key`. Provide a short description
	       for the key.

	    c. In the :guilabel:`Project Permissions` dropdown menu,
	       select both the :guilabel:`Project Stream Processing Owner` and
	       :guilabel:`Project Owner` roles. Click :guilabel:`Next`.

	    d. Save both the public and private keys for later in this procedure.

	 .. step:: Create the Private Link Connection.

	    The {+atlas-admin-api+} provides an endpoint to
	    :oas-atlas-tag:`Create One Private Link Connection
	    </Streams/operation/createPrivateLinkConnection>`. 

	    For an {+aws+} |s3| Private Link connection, set the
	    following key-value pairs:

	    .. list-table::
	       :widths: 35 65
	       :header-rows: 1

	       * - Key
		 - Value

	       * - ``vendor``
		 - ``"S3"``

	       * - ``provider``
		 - ``"AWS"``         

	       * - ``region``
		 - The {+aws+} region in which you create the endpoint.

	       * - ``serviceEndpointId``
		 - ``"com.amazonaws.<region>.s3"`` where ``<region>``
		   is the name of the {+aws+} region in which you
		   create the endpoint.

	    Use :oas-atlas-tag:`Return All Private Link Connections
	    </Streams/operation/listPrivateLinkConnections>` to check
	    the ``state`` of your endpoint. When it reaches a ``DONE``
	    state, note the value of the ``_id`` field and proceed to
	    the next step.

	 .. step:: Create the S3 Connection.

	    The {+atlas-admin-api+} provides an endpoint to
	    :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>`. You must send this
	    request using digest authorization.

	    In your HTTP request interface, enable digest authorization. For
	    the ``username``, provide the public key you generated
	    previously. For the ``password``, provide the private key you
	    generated previously.

	    For an {+aws+} |s3| Private Link connection, set the
	    following key-value pairs:

	    .. list-table::
	       :widths: 35 65
	       :header-rows: 1

	       * - Key
		 - Value

	       * - ``name``
		 - The name you want to give to the connection.

	       * - ``type``
		 - ``"S3"``

	       * - ``aws.roleArn``
		 - Value of the ARN noted in an earlier step.

	       * - ``networking.access.type``
		 - "PRIVATE_LINK"

	       * - ``networking.access.connectionId``
		 - The ``_id`` value in the response when you create
		   the Private Link connection.

   .. selected-content::
      :selections: atlas-ui, private-link

      .. procedure::
         :style: normal

	 .. include:: /includes/nav/steps-network-access.rst

	 .. step:: Navigate to the {+atlas-sp+} private endpoint interface.

	    a. Select the :guilabel:`Private Endpoint` tab.

	    #. Select the :guilabel:`{+atlas-sp+}` tab.

	       If you have not created an {+atlas-sp+} private endpoint
	       previously, click :guilabel:`Create endpoint`. If you have,
	       click :guilabel:`Add ASP Endpoint`.

	 .. step:: Select your cloud provider and vendor.

	    a. Set :guilabel:`Cloud Provider` to :guilabel:`Azure`.

	    #. Set :guilabel:`Vendor` to :guilabel:`EventHub`.

	    #. Click :guilabel:`Next, enter service details`

         .. step:: Provide your AWS |s3| endpoint region.

            Your endpoint must be in the same region in which you
            intend to host the stream processors that use it.

	 .. step:: Set up Unified AWS Access.

	    Follow the procedure described in `Set Up Unified AWS
	    Access
	    <https://docs.mongodb.com/atlas/security/set-up-unified-aws-access/?interface=atlas-ui>`__.

	    Ensure that you grant your IAM role ``ListAllMyBuckets`` and
	    ``PutObject`` permissions.

	    Note the ARN value in ``Statement.Principal.AWS`` to use
	    later in this procedure.

	 .. include:: /includes/nav/steps-project-access-manager

	 .. step:: Create an API key.

	    The :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>` API endpoint
	    requires digest authorization when creating an S3 Connection. To
	    support this, you must create an API Key.

	    a. In the :guilabel:`Project Access Manager`, select the
	       :guilabel:`Applications` tab, then click :guilabel:`API Keys`.

	    b. Click :guilabel:`Create API Key`. Provide a short description
	       for the key.

	    c. In the :guilabel:`Project Permissions` dropdown menu,
	       select both the :guilabel:`Project Stream Processing Owner` and
	       :guilabel:`Project Owner` roles. Click :guilabel:`Next`.

	    d. Save both the public and private keys to use later in this procedure.

	 .. include:: /includes/nav/steps-stream-processing.rst  

	 .. step:: Go to the :guilabel:`Connection Registry`.  

	    a. Locate the overview panel of the {+spi+} you want to  
	       modify and click :guilabel:`Configure`.  

	    #. Select the :guilabel:`Connection Registry` tab.  

	 .. step:: Click :guilabel:`+ Add connection`.  

	 .. step:: Add a new connection.  

	    a. Select an :guilabel:`S3` connection.  

	    #. Provide a :guilabel:`Connection Name`. Each connection
	       name must be unique within a {+spi+}.  This is the name
	       used to reference the connection in {+atlas-sp+}
	       :ref:`aggregations <stream-aggregation>`.

            #. Click the :guilabel:`PrivateLink` button. From the
               dropdown menu, select the private endpoint you created
	       earlier.

            #. From the :guilabel:`AWS IAM Role ARN` drodpwon, select
               the ARN of the unified access role you authorized in a
               prior step.

            #. Click :guilabel:`Add connection`.

   .. selected-content::
      :selections: atlas-cli, private-link

      .. procedure::
         :style: normal

	 .. step:: Set up Unified AWS Access.

	    Follow the procedure described in `Set Up Unified AWS
	    Access
	    <https://docs.mongodb.com/atlas/security/set-up-unified-aws-access/?interface=atlas-admin-api>`__.

	    Ensure that you grant your IAM role ``ListAllMyBuckets`` and
	    ``PutObject`` permissions.

	    Note the ARN value in ``Statement.Principal.AWS`` to use later in this
	    procedure.

	 .. include:: /includes/nav/steps-project-access-manager

	 .. step:: Create an API key.

	    The :oas-atlas-tag:`Create One Connection
	    </Streams/operation/createStreamConnection>` API endpoint
	    requires digest authorization when creating an S3 Connection. To
	    support this, you must create an API Key.

	    a. In the :guilabel:`Project Access Manager`, select the
	       :guilabel:`Applications` tab, then click :guilabel:`API Keys`.

	    b. Click :guilabel:`Create API Key`. Provide a short description
	       for the key.

	    c. In the :guilabel:`Project Permissions` dropdown menu,
	       select both the :guilabel:`Project Stream Processing Owner` and
	       :guilabel:`Project Owner` roles. Click :guilabel:`Next`.

	    d. Save both the public and private keys to use later in this procedure.

	 .. step:: Create the Private Link Connection.

            .. include:: /includes/extracts/atlas-streams-privateLinks-create.rst

	    In your configuration file, set the following key-value
	    pairs:

	    .. list-table::
	       :widths: 35 65
	       :header-rows: 1

	       * - Key
		 - Value

	       * - ``vendor``
		 - ``"S3"``

               * - ``provider``
	         - ``"AWS"``         

               * - ``region``
	         - The {+aws+} region in which you create the endpoint.

               * - ``serviceEndpointId``
	         - ``"com.amazonaws.<region>.s3"`` where ``<region>``
	           is the name of the {+aws+} region in which you
	           create the endpoint.

            Use :atlascli:`atlas streams privateLinks list
            <atlas-streams-privateLinks-list>` command to check
            the ``state`` of your endpoint. When it reaches a ``DONE``
            state, note the value of the ``_id`` field and proceed to
            the next step.

	 .. step:: Create the S3 Connection.

            .. include:: /includes/extracts/atlas-streams-connections-create.rst

            In your configuration file, set the following key-value pairs:

	    .. list-table::
	       :widths: 35 65
	       :header-rows: 1

	       * - Key
		 - Value

               * - ``name``
	         - The name you want to give to the connection.

	       * - ``type``
		 - ``"S3"``

	       * - ``aws.roleArn``
		 - Value of the ARN noted in an earlier step.

	       * - ``networking.access.type``
		 - "PRIVATE_LINK"

	       * - ``networking.access.connectionId``
		 - The ``_id`` value in the response when you create
		   the Private Link connection.

Supported Aggregation Behavior
------------------------------

{+aws+} |s3| sink connections support only the ``$emit`` stage, not
the ``$merge`` stage. For more information, see :ref:`$emit
<atlas-sp-agg-emit>`.

