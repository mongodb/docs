.. facet::
   :name: programming_language
   :values: c, cpp, csharp, java, javascript/typescript, python, shell

.. _ref-create-index:
.. _default-index-definition:

============================
Create an Atlas Search Index
============================

.. default-domain:: mongodb

.. meta::
   :keywords: video tutorial, search index status, code example, atlas api, java sync, atlas ui, atlas cli, compass, node.js
   :description: Create an Atlas Search index using the Atlas UI, Atlas Search API, Atlas CLI, or Terraform.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/facts/fts-index-description.rst

You can create an |fts| index for all collections except :manual:`time 
series </core/timeseries-collections/>` collections on your |service|
{+cluster+} through the {+atlas-ui+}, :oas-atlas-op:`API
</createAtlasSearchIndex>`, :atlas:`Atlas CLI 
</cli/stable/command/atlas-clusters-search-indexes-create/>`, and 
`Terraform
<https://registry.terraform.io/providers/mongodb/mongodbatlas/latest/docs/resources/search_index>`__. 

.. include:: /includes/atlas-search-out-agg.rst

Prerequisites
-------------

To create an |fts| index, you must have an |service| cluster with:

- MongoDB version ``4.2`` or higher on any {+cluster+} tier.

- Collection for which to create the |fts| index.

Required Access
---------------

.. include:: /includes/fact-fts-required-roles.rst

You must have at least the :atlasrole:`readWriteAnyDatabase` role or
``readWrite`` access to the database where you want to create the
indexes. To learn more, see :ref:`atlas-user-privileges` or
:ref:`atlas-specific-privileges`.

Index Limitations
-----------------

- .. include:: /includes/search-shared/fact-fts-shared-tier-limitations.rst

  We recommend that you create no more than 2,500 search indexes on a 
  single ``M10+`` cluster.

- To create an |fts| index from {+Compass+}, you must have an ``M10+`` 
  |service| {+cluster+} running MongoDB 7.0 or higher.

Estimate the Size of Your Index 
-------------------------------

You can estimate the size of your index by creating an index on a subset
of your collection:

1. Take a sample of your data and create a new collection with the
   sample data. 
#. Create a search index on the collection with the sample data. 

   .. note:: 

      The index definition for the sample data must be the same as 
      the index definition you want to create on the full collection.

#. Scale the size of the sample data index based on the total size of
   your data. 

   .. code-block:: shell 
      :copyable: false 

      estimated-index-size = ( subset-data-index-size / subset-data-size ) x total-collection-data-size

.. example:: 

   This example uses the ``sample_mflix.movies`` namespace. We first run
   :pipeline:`$sample` to randomly select 10 documents from the
   ``movies`` collection and create a new collection named
   ``sample_data`` that contains the ``$sample`` output documents: 

   .. io-code-block:: 
      :copyable: true 

      .. input:: 
         :language: js 

         db.movies.aggregate([
           { $sample: { size: 10 } },
           { $out: "sample_data" }
         ]) 
   
      .. output:: /includes/fts-tutorial/search-index-management/estimate-index-size-sample-data.js 
         :language: js 
         :visible: false

   Next, for the ``$sample`` output data that we added to the
   ``sample_data`` collection by using :pipeline:`$out`, we create an
   index on just the ``title`` field:  

   .. code-block:: 
      :copyable: true 

      {
        "mappings": {
          "dynamic": false,
          "fields": {
            "title": {
              "type": "string"
            }
          }
        }
      }

   The size of the index on the ``title`` field in the ``sample_data`` 
   collection with 10 documents is 4.34 KB. The size of the
   ``sample_data`` collection is 14.19 KB. The total size of the
   ``movies`` collection is 32.54 MB, which is 32540 KB. We use the
   following calculations to estimate the index size for the entire
   ``movies`` collection: 

   .. code-block:: 
      :copyable: false 

      4.34 KB / 14.19 KB = 0.30584918957012 KB (per document) 
      0.30584918957012 KB x 32540 KB = 9952.3326286117048 KB 
      9265.466 KB x 0.001 MB = 9.952332628611705 MB 
   
   The estimated size index size for the ``title`` field in the
   ``movies`` collection is 9.95 MB. However, the index size for the
   ``movies`` collection might vary based on the length of the titles in
   the other non-sampled documents.  

.. _ref-create-index-programmatically:

Create an |fts| Index
---------------------

You can create an |fts| index using the {+atlas-ui+}, |compass|, or
programmatically by using {+mongosh+}, the {+atlas-cli+}, the |api|, or
a supported :driver:`MongoDB Driver </>` in your preferred language. 

.. |command-type| replace:: create
.. |compatibility-table| replace:: :ref:`fts-index-supported-drivers`

.. |search-type| replace:: :guilabel:`Atlas Search`
.. |index-name| replace:: ``default`` is the default index name. 
      Index names must be unique within the namespace, regardless of the index type. 
      You can accept the default name or specify a custom name. 
      If you use the default name, you don't need to specify an
      ``index`` parameter in the :ref:`$search <query-syntax-ref>` pipeline
      stage. If you specify a custom name, you must specify this parameter.
.. |database-name| replace:: Select the database for which to create the index.
.. |collection-name| replace:: Select the collection for which to create the index.

.. note::

   |fts| indexes must apply to a full collection, rather than to 
   only a portion of a collection. 
 
----------

.. |arrow| unicode:: U+27A4

|arrow| Use the **Select your language** drop-down menu to set the 
language of the example in this section.

----------

.. tabs-selector:: drivers

.. tabs-drivers::

   .. tab::
      :tabid: atlas-cli

      .. include:: /includes/fact-atlas-cli-local-deployment-for-fts.rst

      Create an |fts| Index for a Cloud Deployment 
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      .. include:: /includes/extracts/atlas-clusters-search-indexes-create.rst

      Create an |fts| Index for a Local Deployment 
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      .. include:: /includes/extracts/atlas-deployments-search-indexes-create.rst

      Example
      ~~~~~~~

      The following example shows you how to use the
      ``atlas clusters`` or ``atlas deployments`` command to create an
      |fts| index in non-interactive mode with a configuration file.

      .. procedure::
         :style: normal

         .. step:: Create an ``indexDef.json`` configuration file.

            .. code-block:: json

               {
                 "collectionName": "movies",
                 "database": "sample_mflix",
                 "definition": {
                   "mappings": {
                    "dynamic": true
                   },
                 },
                 "name": "searchIndex"
               }

         .. step:: Create an |fts| index.

            a. Run one of the following commands.

               **Cloud Deployment:**

               .. code-block:: sh

                  atlas clusters search indexes create --file indexDef.json

               **Local Deployment:**

               .. code-block:: sh

                  atlas deployments search indexes create --file indexDef.json

            #. Specify the deployment and press :kbd:`Enter`.

   .. tab::
      :tabid: atlas-api

      To create an |fts| index:
      
      .. procedure::
         :style: normal
         
         .. step:: Send a ``POST`` request.
            
            Send a ``POST`` request to the ``search/indexes`` 
            :oas-atlas-op:`endpoint </createAtlasSearchIndex>`.

            .. code-block:: sh

               curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
               --header "Accept: application/json" \
               --header "Content-Type: application/json" \
               --include \
               --request POST "https://cloud.mongodb.com/api/atlas/v2/groups/{groupId}/clusters/{clusterName}/search/indexes" \
               --data '
                 {
                   "collectionName": "string",
                   "database": "string",
                   "name": "string",
                   "type": "search",
                   "definition": 
                   {
                     "analyzer": "lucene.<analyzer>",
                     "analyzers": [
                       {
                         "charFilters": [ ... ],
                         "name": "string",
                         "tokenFilters": [ ... ],
                         "tokenizer": { ... }
                       }
                     ],
                     "mappings": {
                       "dynamic": true | false,
                       "fields": {
                         "property1": {},
                         ...
                       }
                     },
                     "searchAnalyzer": "lucene.<analyzer>",
                     "storedSource": {
                       "include | exclude": [...]
                     },
                     "synonyms": [
                       {
                         "analyzer": "lucene.<analyzer>",
                         "name": "string",
                         "source": {
                           "collection": "string"
                         }
                       }
                     ]
                   }
                 }'
            
            To learn more about the syntax and parameters for this 
            endpoint, see :oas-atlas-op:`Create One 
            </createAtlasSearchIndex>`.

         .. step:: Review the response.

            .. note:: 

               |service| doesn't create the index if the collection 
               doesn't exist, but it still returns a ``200`` status.

   .. tab::
      :tabid: atlas-ui

      For :pipeline:`$search` queries, you create an index of the
      default ``search`` type. 

      Procedure 
      ~~~~~~~~~

      To create an |fts| index from the {+atlas-ui+}:

      .. include:: /includes/steps-create-fts-index.rst

      Prefer to Learn by Watching?
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      Follow along with this video tutorial walk-through that demonstrates 
      how to create |fts| indexes of various complexity.

      *Duration: 15 Minutes*

      .. video:: https://youtu.be/o2ss2LJNZVE 

   .. tab::
      :tabid: shell

      .. include:: /includes/steps-fts-create-index-shell.rst
   
   .. tab::
      :tabid: compass

      .. |database| replace:: name of the database
      .. |collection| replace:: name of the collection
      .. |index-name| replace:: ``default``

      .. include:: /includes/steps-fts-tutorial-create-index-compass.rst

   .. tab::
      :tabid: nodejs

      .. include:: /includes/steps-fts-create-index-node.rst

   .. tab::
      :tabid: csharp

      .. include:: /includes/steps-fts-create-index-csharp.rst

   .. tab::
      :tabid: java-sync

      .. include:: /includes/steps-fts-create-index-java.rst

   .. tab::
      :tabid: python

      .. include:: /includes/steps-fts-create-index-python.rst

   .. tab::
      :tabid: c

      .. include:: /includes/steps-fts-create-index-c.rst

   .. tab::
      :tabid: cpp

      .. include:: /includes/steps-fts-create-index-cxx.rst

When you create the |fts| index, the |fts| page displays information
about |fts| indexes. The :guilabel:`Status` column shows the current
state of the index on the primary node of the cluster. To learn more,
see :ref:`search-index-statuses`. 

.. include:: /includes/fact-shardCollection-fts-indexes.rst

.. toctree::
   :titlesonly:

   1: Process Data with Analyzers </atlas-search/analyzers>
   2: Define Field Mappings </atlas-search/define-field-mappings>
   3: Configure Stored Fields </atlas-search/stored-source-definition>
   4: Configure Synonym Mappings </atlas-search/synonyms> 
   5: Partition Your Index </atlas-search/index-partition> 
   6: Review Search Syntax </atlas-search/index-definitions>
