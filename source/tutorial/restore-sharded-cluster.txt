=======================================
Restore a Sharded Cluster from a Backup
=======================================

.. default-domain:: mongodb

Overview
--------

You can restore a :term:`sharded cluster` onto new hardware from the
artifacts captured by |backup|.

You can restore from a snapshot or checkpoint. When you restore from a
checkpoint, MMS takes the snapshot previous to the checkpoint and applies
the :manual:`oplog </core/replica-set-oplog/>` to create a custom
snapshot. Checkpoint recovery takes longer than recovery from a stored
snapshot.

MMS provides restore files as downloadable zip files. MMS provides a
separate file for each :term:`shard` and one file for the :term:`config
servers <config server>`.

The sequence to restore a snapshot is to:

- select and download the restore files,

- distribute the restore files to their new locations,

- start the :program:`mongod` instances,

- configure each shard's replica set, and

- configure and start the cluster.

.. todo: add this info an a link when the 'download via scp' tutorial is written:
   "You can optionally download the replica set directly to your server through SCP."

For a functional overview of MMS restore, see :ref:`restores`.

Procedures
----------

.. todo: do we need instructions on stopping the cluster?

Select and Download the Snapshot Files
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/steps/download-snapshot-sharded-cluster.rst

Restore Each Shard
~~~~~~~~~~~~~~~~~~

For each shard, restore the primary and secondaries.

Restore the Primary for a Shard
```````````````````````````````

To perform this procedure you must have a copy of the snapshot's tar file
on the server that runs the primary.

.. include:: /includes/steps/restore-primary.rst

Restore Each Secondary for a Shard
``````````````````````````````````

Perform this procedure separately for each secondary for a shard. Before
you perform these steps, each secondary must have a copy of the shard's
tar file.

.. include:: /includes/steps/restore-secondary.rst

Restore Each Config Server
~~~~~~~~~~~~~~~~~~~~~~~~~~

Perform this procedure separately for each :term:`config server`. Each
config server must have a copy of the tar file with the config server
data.

.. include:: /includes/steps/restore-config-server.rst

Start the mongos
~~~~~~~~~~~~~~~~

Start the cluster's :program:`mongos` bound to your new config servers.
