=======================================
Configure the Backup Agent for Kerberos
=======================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/styles/corrections.rst

:term:`MongoDB Enterprise` provides support for Kerberos. Kerberos is a
network authentication protocol available in MongoDB Enterprise. The
:term:`Backup Agent` can authenticate to MongoDB instances using
Kerberos.

.. include:: /includes/note-manage-agent-auth-with-automation-kerberos.rst

Prerequisites
-------------

Configure |kdc| to Issue Tickets with Four-Hour Minimum Lifetime
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Kerberos tickets are only valid, or used to authenticate users, for a
limited time. You must configure the Kerberos Key Distribution Center
(KDC) to issue tickets that are valid for at least four hours. The
Backup Agent periodically renews the ticket. The |kdc| service provides
session tickets and temporary session keys to users and computers.

Add Kerberos as Authentication Mechanism for Deployment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-access-control-host-settings.rst


For the purposes of this tutorial, you must ensure your:

- Deployment supports Kerberos authentication and
- Agents use Kerberos authentication.

To learn how to enable Kerberos authentication, see
:doc:`/tutorial/enable-kerberos-authentication-for-group`.

Configure Backup Agent Host to Use Kerberos
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/note-needed-kerberos-files-for-agent.rst

Create Kerberos User Principal for the Backup Agent
---------------------------------------------------

.. include:: /includes/steps/kerberos-create-principal.rst

<<<<<<< ad85d64787a76448bc931a4abdf041ac9f58288d
Create a User and Assign Roles for the Backup Agent |upn|
=======
Create a User and Assign Roles for the Backup Agent |spn|
>>>>>>> (DOCS-9325): Added note about Windows Agent users with Kerberos.
---------------------------------------------------------

.. include:: /includes/fact-kerberos-principal-as-user.rst

From a :program:`mongo` shell connected to your MongoDB deployment,
issue the following commands to create the users:

MongoDB 3.0 or Later
~~~~~~~~~~~~~~~~~~~~

.. code-block:: javascript

   db.getSiblingDB("$external").createUser(
      {
        user: "<Kerberos Principal>",
        roles: [
           { role: "backup", db: "admin" }
        ]
      }
   )

MongoDB 2.6
~~~~~~~~~~~

.. code-block:: javascript

   db.getSiblingDB("$external").createUser(
      {
        user: "<Kerberos Principal>",
        roles: [ 
           "clusterAdmin",
           "readAnyDatabase",
           "userAdminAnyDatabase",
           { role: "readWrite", db: "admin" },
           { role: "readWrite", db: "local" },
        ]
      }
   )

To learn more about the required access, see
:doc:`/reference/required-access-backup-agent`.

Edit the Backup Agent Configuration File
----------------------------------------

Edit the Backup Agent configuration file. The following table lists the
default installation paths for some common platforms. Depending on your
deployment, you may need to substitute the default path for the custom
installation path used for your |mms| agent installation.

.. list-table::
   :header-rows: 1
   :widths: 40 60

   * - Platform
     - Path

   * - RHEL, Ubuntu
     - ``/etc/mongodb-mms/backup-agent.config``

   * - Linux Archive, macOS
     - ``<userSelected>/local.config``

   * - Windows
     - ``C:\MMSData\Backup\local.config``

.. include:: /includes/steps/kerberos-agent-config-file.rst
