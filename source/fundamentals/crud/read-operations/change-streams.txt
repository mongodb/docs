.. _java-fundamentals-change-streams:
.. _retrieve-watch:

===================
Open Change Streams
===================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

In this guide, you can learn how to use a **change stream** to monitor
real-time changes to your database. A change stream is a {+mdb-server+}
feature that allows your application to subscribe to data changes on a single
collection, database, or deployment. You can specify a set of aggregation
operators to filter and transform the data your application receives. When
connecting to a MongoDB deployment v6.0 or later, you can configure the
events to include the document data before and after the change.

Learn how to open and configure your change streams in the following
sections:

- :ref:`<java-change-stream-open>`
- :ref:`<java-change-stream-aggregation>`
- :ref:`<java-change-stream-configure-pre-post>`

.. _java-change-stream-open:

Open a Change Stream
--------------------

You can open a change stream to subscribe to specific types of data changes
and produce change events in your application.

To open a change stream, call the ``watch()`` method on an instance of a
``MongoCollection``, ``MongoDatabase``, or ``MongoClient``.

.. important::

   Standalone MongoDB deployments don't support change streams because
   the feature requires a replica set oplog. To learn more about the oplog,
   see the :ref:`<replica-set-oplog>` {+mdb-server+} manual page.

The object on which you call the ``watch()`` method on determines the scope of
events that the change stream listens for.

If you call ``watch()`` on a ``MongoCollection``, the change stream monitors
a collection.

If you call ``watch()`` on a ``MongoDatabase``, the change stream monitors all
collections in that database.

If you call ``watch()`` on a ``MongoClient``, the change stream monitors all
changes in the connected MongoDB deployment.

Example
~~~~~~~

This example shows how to open a change stream on the
``myColl`` collection and print change stream events as they occur.

The driver stores change stream events in a variable of type
``ChangeStreamIterable``. In the following example, we specify that the
driver should populate the ``ChangeStreamIterable`` object with ``Document``
types. As a result, the driver stores individual change stream events as
``ChangeStreamDocument`` objects.

.. literalinclude:: /includes/fundamentals/code-snippets/change-streams/ChangeStreams.java
   :language: java
   :dedent:
   :start-after: begin openChangeStreamExample
   :end-before: end openChangeStreamExample

An insert operation on the collection should produce output similar to the
following text:

.. code-block::
   :copyable: false

   Received a change: ChangeStreamDocument{
      operationType='insert',
      resumeToken={"_data": "825EC..."},
      namespace=myDb.myColl,
      ...
   }

For a runnable example, see the :ref:`<java-usage-watch>` usage example page.

To learn more about the ``watch()`` method, see the following API
documentation:

- `MongoCollection.watch() <{+api+}/apidocs/mongodb-driver-sync/com/mongodb/client/MongoCollection.html#watch()>`__
- `MongoDatabase.watch() <{+api+}/apidocs/mongodb-driver-sync/com/mongodb/client/MongoDatabase.html#watch()>`__
- `MongoClient.watch() <{+api+}/apidocs/mongodb-driver-sync/com/mongodb/client/MongoClient.html#watch()>`__

.. _java-change-stream-aggregation:

Apply Aggregation Operators to your Change Stream
-------------------------------------------------

You can pass an aggregation pipeline as a parameter to the ``watch()`` method
to specify which change events the change stream receives.

To learn which aggregation operators your {+mdb-server+} version supports, see
:ref:`<change-stream-modify-output>`.


Example
~~~~~~~

The following code example shows how you can apply an aggregation pipeline to
configure your change stream to receive change events for only insert and
update operations:

.. literalinclude:: /includes/fundamentals/code-snippets/change-streams/ChangeStreams.java
   :language: java
   :dedent:
   :start-after: begin aggregationExample
   :end-before: end aggregationExample

When the change stream receives an update change event, the preceding code
example outputs the following text:

.. code-block:: text
   :copyable: false

   Received a change to the collection: ChangeStreamDocument{
   operationType=update, resumeToken={...},
   ...

.. _java-change-stream-configure-pre-post:

Include Pre-images and Post-images
----------------------------------

You can configure the change event to contain or omit the following data:

- The **pre-image** which is a document that represents the version of the
  document before the operation if it exists
- The **post-image** which is a document that represents the version of the
  document after the operation if it exists

To receive change stream events that include a pre-image or post-image, you
must connect to a MongoDB v6.0 or later deployment and set up the following:

- Enable pre-images and post-images for the collection on your MongoDB
  deployment.

  .. tip::

     To learn how to enable these on your deployment, see the
     :manual:`Change Streams with Document Pre- and Post-Images </changeStreams/#change-streams-with-document-pre--and-post-images>`
     {+mdb-server+} manual page.

     To learn how to instruct the driver to create a collection with pre-images
     and post-images enabled, see the :ref:`<java-change-stream-pre-post-collection>`
     section.

- Configure your change stream to retrieve either or both the pre-images and
  post-images.

  .. tip::

     To configure your change stream to include the pre-image, see
     the :ref:`<java-pre-image-example>`.

     To configure your change stream to include the post-image, see the
     :ref:`<java-post-image-example>`.

.. _java-change-stream-pre-post-collection:

Create a Collection with Pre-Image and Post-Images Enabled
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To create a collection with the pre-image and post-image option using the
driver, specify an instance of  ``ChangeStreamPreAndPostImagesOptions``
and call the ``createCollection()`` method as shown in the following example:

.. literalinclude:: /includes/fundamentals/code-snippets/change-streams/ChangeStreams.java
   :language: java
   :dedent:
   :start-after: begin createCollection
   :end-before: end createCollection

You can change the pre-image and post-image option in an existing collection
by running the ``collMod`` command from the MongoDB Shell. To learn how to
perform this operation, see the :manual:`collMod </reference/command/collMod#change-streams-with-document-pre--and-post-images>`
{+mdb-server+} manual.

.. warning::

   When you modify this option on a collection, any change streams open on
   that collection in your application may fail if configured to require
   receiving the pre-image or post-image.

.. _java-pre-image-example:

Pre-image Configuration Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following code example shows how you can configure a change stream to
include the pre-image and output the results:

.. literalinclude:: /includes/fundamentals/code-snippets/change-streams/ChangeStreams.java
   :language: java
   :dedent:
   :start-after: begin fullDocumentBeforeChangeExample
   :end-before: end fullDocumentBeforeChangeExample

The preceding example configures the change stream to use the
``FullDocumentBeforeChange.REQUIRED`` option. This configures the change
stream to return pre-images for replace, update, and delete change events and
for the MongoDB deployment to raise an error if the pre-image is unavailable.

Suppose an application updated the ``latestVersion`` field of a document in a
collection of software library dependencies from the value of ``2.0.0`` to
``2.1.0``. The corresponding change event output by the preceding code example
should resemble the following text:

.. code-block:: text
   :emphasize-lines: 3
   :copyable: false

   Received a change: ChangeStreamDocument{ operationType=update, resumeToken={...}
   namespace=software.libraries, destinationNamespace=null, fullDocument=null,
   fullDocumentBeforeChange=Document{{_id=6388..., latestVersion=2.0.0, ...}},
   ...

For a list of options, see the `FullDocumentBeforeChange <{+api+}/apidocs/mongodb-driver-core/com/mongodb/client/model/changestream/FullDocumentBeforeChange.html>`__
API documentation.

.. _java-post-image-example:

Post-image Configuration Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following code example shows how you can configure a change stream to
include the post-image and output the results:

.. literalinclude:: /includes/fundamentals/code-snippets/change-streams/ChangeStreams.java
   :language: java
   :dedent:
   :start-after: begin fullDocumentExample
   :end-before: end fullDocumentExample

The preceding example configures the change stream to use the
``FullDocument.UPDATE_LOOKUP`` option. This configures the change
stream to return both the deltas between the original and changed document
and a copy of the document at some point in time after the change occurred.

Suppose an application updated the ``population`` field of a document from
the value of ``800`` to ``950`` in a collection of city census data. The
corresponding change event output by the preceding code example should
resemble the following text:

.. code-block:: text
   :emphasize-lines: 3
   :copyable: false

   Received a change: ChangeStreamDocument{ operationType=update, resumeToken={...},
   namespace=censusData.cities, destinationNamespace=null,
   fullDocument=Document{{_id=6388..., city=Springfield, population=950, ...}},
   updatedFields={"population": 950}, ...
   ...

For a list of options, see the `FullDocument <{+api+}/apidocs/mongodb-driver-core/com/mongodb/client/model/changestream/FullDocument.html>`__
API documentation.

