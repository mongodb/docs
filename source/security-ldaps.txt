.. _ldaps-authentication-authorization:

======================================================
Set up User Authentication and Authorization with LDAP
======================================================

.. default-domain:: mongodb

.. meta::
   :keywords: connect

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

|service| provides the ability to manage user authentication and
authorization from all MongoDB clients using your own Lightweight
Directory Access Protocol (|ldap|) server over |tls|. A single |ldaps|
(|ldap| over |tls|) configuration applies to all clusters in a project.

If you enable user authorization with |ldap|, you can create |ldap|
groups on the ``admin`` database by mapping |ldap| groups to MongoDB
roles on your |service| databases. To use |ldap| groups effectively,
:doc:`create additional projects </tutorial/manage-projects>` within
|service| to control access to specific deployments in your
organization, such as creating separate |service| projects for
development and production environments. You can then map an |ldap|
group to a role in the |service| project to provide access to the
desired deployment.

.. note::

   When you enable user authorization and an |ldap| user doesn't belong
   to any |ldap| group, |service| doesn't assign any database roles to
   the user. When you enable user authentication and you disable user
   authorization, |service| assigns MongoDB database roles to the
   |ldap| user.

If you have multiple departments with their own billing needs, alert
settings, and project members, consider creating a new set of 
:doc:`projects </tutorial/manage-projects>` or a new :doc:`organization 
</tutorial/manage-organizations>` for each department or business unit.

.. note::

   An explanation of |ldap| is out of scope for the MongoDB
   documentation. Please review :rfc:`RFC 4515 <4515>` and
   :rfc:`RFC 4516 <4516>`  or refer to your preferred |ldap|
   documentation.

Prerequisites
-------------

You must meet the following prerequisites to manage user authentication
and authorization using |ldap| in |service|:

- |service| cluster using MongoDB 3.6 or later.

- |ldap| server using |tls| that your |service| clusters can access
  over the network using either  :doc:`VPC </security-vpc-peering>` or
  VNet peering connection or the cluster nodes' public IP addresses.

- |ldap| group memberships embedded as an attribute for each user in
  the |ldap| entry for user authorization only.

Recommendation
--------------

For your |ldaps| service to access |service| clusters, MongoDB
recommends one of two configurations:

Using a |vpc| or VNet:

1. Run your |ldap| server in a |vpc| or VNet.
#. Establish a peering connection to your |service| project.
#. Use a public |fqdn| that resolves to the private IP address
   of your |ldap| server.

Using your data center:

1. Run your |ldap| server with a public |fqdn| that resolves to a
   public IP address.
#. Configure the |ldap| server to allow inbound access from the
   |service| cluster nodes' public IP addresses.

Considerations
--------------

Conflicts between LDAP Authorization and X.509 Users
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you enable LDAP authorization, you can't connect to your
{+database-deployments+} with users that authenticate with an
|service|-managed X.509 certificate.

After you enable LDAP authorization, you *can* connect to your
{+database-deployments+} with users that authenticate with an
:ref:`self-managed X.509 certificate <self-managed-x509>`. However, 
the user's Common Name in their X.509 certificate must match the 
Distinguished Name of a user who is authorized to access your 
database with LDAP.

Usernames
~~~~~~~~~

|service| uses the full Distinguished Name (DN) of users in your |ldap|
server as the |service| username. For example, an example |ldap| user
named ``ralph`` has the following username in |service|:

``cn=ralph,cn=Users,dc=aws-atlas-ldap-01,dc=myteam,dc=com``

Connection String
~~~~~~~~~~~~~~~~~

If the administrator enables user authentication or both user
authentication and authorization with |ldap|, database users must
override the following parameters in the connection string for their
clients.

* ``authSource`` must be ``$external``

* ``authenticationMechanism`` must be ``PLAIN``

.. example::

   The following connection string for {+mongosh+}
   authenticates an |ldap| user named ``rob``:

   ``mongosh "mongodb+srv://cluster0-tijis.mongodb.net/test?authSource=%24external" --authenticationMechanism PLAIN --username cn=rob,cn=Users,dc=atlas-ldaps-01,dc=myteam,dc=com``

To copy the connection string:

1. Click :guilabel:`Databases` in the top-left corner of |service|.
#. Click :guilabel:`Connect` on the :guilabel:`{+Database-Deployments+}` page.
#. Edit the string with your ``User DN`` and password.


.. include:: /includes/admonitions/notes/note-escape-special-chars-pwd.rst

Rolling Restart on Configuration Change
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you change your |ldap| configuration, |service| performs a rolling
restart of your cluster. This restart allows |service| to use the
correct settings to authenticate users.

Using Public IP Addresses
~~~~~~~~~~~~~~~~~~~~~~~~~

You can use public IP addresses that refer to other internal or private
IP addresses using Network Address Translation to allow |service|
traffic to your |ldap| server. If you do this, be aware that
:doc:`certain activities <reference/faq/networking>` trigger a change
in the |service| cluster's public IP addresses.

If you allowed |ldap| server access based on public IP addresses,
changes to the |service| cluster's public IP address prevent |ldap|
access. To restore |ldap| access, add the new |service| cluster public
IP addresses to the |ldap| access list.

Limitations
~~~~~~~~~~~

You cannot use both |ldap| and SCRAM authentication for the same
database user.

Procedures
----------

Configure Authentication with LDAP
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Use the following procedure to configure user authentication with
|ldap| for all clusters in a project.

.. include:: /includes/steps/configure-authentication-ldaps.rst

Configure Authorization
~~~~~~~~~~~~~~~~~~~~~~~

Use the following procedure to configure user authorization with |ldap|
for all clusters in a project:

.. include:: /includes/fact-ldap-authz-intro.rst

.. include:: /includes/steps/configure-authorization-ldaps.rst

Tutorials for Third-Party LDAP Providers
----------------------------------------

Use the following tutorials to configure |service| to authenticate and
authorize users from third-party LDAP providers:

- :doc:`security-ldaps-azure`
- :doc:`security-ldaps-okta`
- :doc:`security-ldaps-onelogin`

.. toctree::
  :titlesonly:
  :hidden:

  /security-ldaps-azure
  /security-ldaps-okta
  /security-ldaps-onelogin
