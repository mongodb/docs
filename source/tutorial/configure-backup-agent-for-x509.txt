=======================================================================
Configure Backup Agent User for x.509 Client Certificate Authentication
=======================================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/enable-auth-intro.rst

.. next paragraph stolenish from the MongoDB Manual

MongoDB supports x.509 certificate authentication for use with a secure
:doc:`TLS/SSL </tutorial/enable-ssl-for-a-deployment>` connection. The x.509
client authentication allows clients to authenticate to servers with
certificates rather than with a username and password.

.. include:: /includes/extracts/note-manage-agent-auth-with-automation-x509.rst

Considerations
--------------

.. important::

   .. include:: /includes/fact-out-of-scope-ssl-certs.rst

To enable x.509 Authentication for |mms|, you must obtain
valid certificates generated and signed by a single certificate authority.
Refer to the :manual:`Client x.509 Certificate </tutorial/configure-x509-client-authentication>`
in the MongoDB Manual for more about the certificate requirements.

.. important:: 
   x.509 Client Certificate Authentication requires that SSL be enabled
   and configured for the deployment.

Procedures
----------

This tutorial assumes that you have already configured your MongoDB
deployment to use x.509 certificate authentication and SSL. If you have not done
so, refer to the :manual:`Use x.509 Certificates to Authenticate Clients
</tutorial/configure-x509-client-authentication>` and 
:manual:`Configure mongod and mognos for TLS/SSL </tutorial/configure-ssl>` tutorials.

Create MongoDB User for the ``subject``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In order for the Backup Agent to connect to your MongoDB deployment, you
must create a user for the Monitoring Agent in the ``$external`` database.

For x.509 certificate authentication, use the ``subject`` value of your
client certificate as the username.

Use the following commands to create the users from a :program:`mongo`
shell connected to your MongoDB deployment:

MongoDB 3.0 or Later
````````````````````
.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<x.509 subject>",
        roles: [
           { role: "backup", db: "admin" }
        ]
      }
   )

MongoDB 2.6
```````````

.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<x.509 subject>",
        roles: [ 
           "clusterAdmin",
           "readAnyDatabase",
           "userAdminAnyDatabase",
           { role: "readWrite", db: "admin" },
           { role: "readWrite", db: "local" },
        ]
      }
   )

See :doc:`/reference/required-access-backup-agent` for more information on the required access.

You can only associate an x.509 client certificate with a single user:
each user must have its own certificate. However, you may use the same
user for both the Backup and Monitoring agents. If you choose to use the
same user for both agents, ensure that the user possesses the required
permissions for both the backup agent **and** the :doc:`monitoring agent
</reference/required-access-monitoring-agent>`.

Edit Agent Configuration File
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

x.509 requires that you configure the agent for SSL:

.. include:: /includes/steps/monitoring-agent-configure-ssl.rst

:doc:`/tutorial/configure-monitoring-agent-for-ssl` provides more details
about configuring the Monitoring Agent for SSL.

Once you have configured the Backup agent, you still need to configure
the x.509 Authentication mechanism in the |mms| interface, as in
:doc:`/tutorial/enable-x509-authentication-for-group`.
