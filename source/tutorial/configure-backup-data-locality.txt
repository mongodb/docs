=======================================================
Configure Multiple Blockstores in Multiple Data Centers
=======================================================

.. default-domain:: mongodb

Overview
--------

The :ref:`Backup Blockstore databases <mms-backup-blockstore-database>`
are the primary storage systems for the backup data of your MongoDB
deployments. A Backup Blockstore database requires a dedicated replica set
of at least 3 members that hold data.

If needed, you can deploy multiple blockstores in multiple data
centers, each backing up different MongoDB replica sets and sharded clusters.
You can attach a particular |onprem| Group to a particular |onprem| Application
instance and blockstore.

Add additional blockstore instances when:

- existing blockstores have reached capacity.

- two sets of backed up data that cannot have co-located storage for
  regulatory reasons.

- you have multiple data centers and want to reduce cross-data center
  network traffic by keeping each blockstore in the data center it
  backs.

This tutorial describes how to set up two blockstores in two separate data
centers.

Also consider ref:`mms-blockstore-database-specifications`.

Procedures
----------

The following procedures set up two blockstores in two data centers.

.. TODO:

   When converting these procedures to use the structured steps-.yaml
   files, find some way to annotate "Data Center 1" and "Data Center
   2"

Provision Servers in Each Data Center
+++++++++++++++++++++++++++++++++++++

Each blockstore requires a separate instance of the
:ref:`mms-application-package` and the :ref:`backup-daemon`.
The |onprem| Application requires a dedicated :ref:`mms-application-database`.

To support automatic :manual:`failover
</core/replica-set-high-availability>` for the Backup Blockstore and
|onprem| Application database, deploy one :term:`replica set` as the
*backing MongoDB instance* for each database.

Each data center should have the following servers:

- A server to run:

  - the :ref:`mms-application-package`, and

  - a member and an arbiter for the :term:`replica set` that stores the
    :ref:`mms-application-database`. For
    specifications, see the :ref:`mms-application-database-specifications`.

- A server to run the second member of the replica set that stores the
  MMS Application database.

- A server to run:

  - the :ref:`Backup Daemon <backup-daemon>`, and

  - a member and an arbiter for the replica set that stores the
    :ref:`Backup Blockstore database <mms-backup-blockstore-database>`.

- A server to run the second member of the replica set that stores the
  Backup Blockstore database.

Optionally, for high availability, a data center can have additional
servers to run additional :ref:`Backup Daemons <backup-daemon>` and
:ref:`Backup Blockstore databases <mms-backup-blockstore-database>`. For
more information on using multiple Backup Daemons and high availability,
see :ref:`multiple-backup-daemons`.

Install MongoDB and Deploy Replica Sets
+++++++++++++++++++++++++++++++++++++++

.. TODO

   reuse content in this section from existing tutorials which describe
   this procedure

On *both* :ref:`|onprem| Application <mms-application-package>` servers in *each*
data center and on *both* :ref:`Backup Daemon <backup-daemon>` servers in
*each* data center:

1. Install the MongoDB software package. See the :manual:`MongoDB
   Installation tutorials </installation>` to find the correct install
   procedure for your operating system. Perform only the installation
   procedure and *not* the start procedure.

2. Create the necessary data directories.

   On the first |onprem| Application or Backup Daemon server in each data
   center, issue the following commands:

   .. code-block:: sh

      mkdir /data/db0
      mkdir /data/db1

   On the second |onprem| Application or Backup Daemon server in each data
   center, issue the following command:

   .. code-block:: sh

      mkdir /data/db0

3. Set ulimits. Set the maximum number of open file descriptors and
   maximum number of processes available to a single user to ``64000``:

   .. code-block:: sh

      ulimit -n 64000 -u 64000

4. Deploy a :term:`replica set` to host the database. Issue the following
   commands.

   On the first |onprem| Application or Backup Daemon server in each data
   center, issue the following commands to deploy the first two members of
   the replica set:

   .. code-block:: sh

      mongod --dbpath /data/db0 --fork --logpath /tmp/mongo.log --replSet rs
      mongod --dbpath /data/db1 -fork --logpath /tmp/arb.log --replSet rs --port 27018

   Then, start a :program:`mongo` shell connected to the first
   instance:

   .. code-block:: sh

      mongo

   Now use the :method:`rs.initiate()` to create the new replica set:

   .. code-block:: javascript

      rs.initiate()

   On the second |onprem| Application or Backup Daemon server in each data
   center, issue the following command:

   .. code-block:: sh

      mongod --dbpath /data/db0 --fork --logpath /tmp/mongo.log --replSet rs

   On the first |onprem| Application or Backup Daemon server in each data
   center, issue the following to enter the :program:`mongo` shell, add the deployed
   members to the replica set, and then verify that the members were
   added:

   .. code-block:: sh

      mongo

   .. code-block:: javascript

      rs.add("<hostname-of-second-server>:<port>")
      rs.addArb("<hostname-of-first-server>:<port>")
      rs.status()

   Issue the following to exit the :program:`mongo` shell:

   .. code-block:: javascript

      quit()

At this point, you have replica sets running for all the backing
databases.

Install the |onprem| Application
++++++++++++++++++++++++++++++++

On the first |onprem| Application server in each data center, install the
:ref:`|onprem| Application <mms-application-package>` using the procedure
appropriate to the operating system. Open the :doc:`list of install
procedures </tutorial/nav/advanced-deployments>` and go to the page specific to
your OS. Perform the procedure to install the service but *do not* perform
the step to *start* the service.

In the step for configuring the ``conf-mms.properties`` file, set the
following fields as follows:

.. code-block:: sh

   mms.centralUrl = <first-MMS-Application-server>:<8080>

   mms.centralBackupUrl = <first-MMS-Application-server>:<8081>

   mongo.mongoUri=mongodb://<first-MMS-Application-mongod>:<27017>,<second-MMS-Application-mongod>:<27017>

   mongo.replicaSet=rs

Install the Backup Daemon
+++++++++++++++++++++++++

.. TODO clarify here what is the "first backup daemon server"

On the first Backup Daemon server in each data center, install the Backup
Daemon using the procedure appropriate to the operating system. For install
instructions, go to :doc:`/tutorial/nav/advanced-deployments` and select the page
specific to your OS. Perform the procedure for installing the *Backup
Component*, including the step to start the service.

In the step for configuring the ``conf-daemon.properties`` file, set the
following fields as follows:

.. The assumption in the code-block below is that every Backup Daemon in
   every data center has the exact same settings.

.. code-block:: sh

   mongo.mongoUri=mongodb://<MMS-application-database-Data-Center-1>:<27017>,<MMS-application-database-in-Data-Center-2>:<27017>

   mongo.replicaSet=rs

   mongo.backupdb.mongoUri=mongodb://<blockstore-in-Data-Center-1>:<27017>

   mongo.backupdb.replicaSet=rs

See :setting:`mongo.mongoUri` and :setting:`mongo.backupdb.mongoUri`
for more information.

Copy the ``gen.key``
++++++++++++++++++++

The ``/etc/mongodb-mms/gen.key`` from the first MMS Application server in
**Data Center 1** will be the ``gen.key`` for all servers in both data
centers. The ``gen.key`` file is a binary file. Use SCP to copy the file.

1. Use SCP to copy the ``/etc/mongodb-mms/gen.key`` from the first MMS Application
   server in Data Center 1 to the ``/etc/mongodb-mms`` directory on the
   first MMS Application server in Data Center 2.

2. Use SCP to copy this ``gen.key`` to the ``/etc/mongodb-mms`` directory of each
   Backup Daemon server.

Start the |onprem| Application Service
++++++++++++++++++++++++++++++++++++++

1. On the first |onprem| Application server in Data Center 1, issue the following:

   .. code-block:: sh

      service mongodb-mms start

2. On the first |onprem| Application server in Data Center 2, issue the following:

   .. code-block:: sh

      service mongodb-mms start

Bind Groups to Daemons
++++++++++++++++++++++

1. In a web browser, go to the URL for the |onprem| Application in Data Center 1:

   .. code-block:: sh

      <first-MMS-Application-server>:<8080>

2. Register a new account, with the group set to a particular data center.

   To test this, go to the URL for the MMS Application server in Data
   Center **2** and try to log in with the new account. It should succeed.

3. Once logged into |onprem|, select the :guilabel:`Administration` tab and
   then the :guilabel:`My Groups` page. Create a new
   group for other data center.

   You should now have one group for each data center.

4. In |onprem|, select the :guilabel:`Admin` and then select
   :guilabel:`Backup`. Do the following:

   - Select :guilabel:`Daemons` and ensure there are two daemons listed.

   - Select :guilabel:`Blockstores`. Add a blockstore with the hostname
     and port of the blockstore for Data Center 2 and click :guilabel:`Save`.

   - Select :guilabel:`Sync Stores`. Add a sync store with the hostname
     and port of the blockstore for Data Center 2 and click :guilabel:`Save`.

   - Select :guilabel:`Oplog Stores`. Add an oplog store with the hostname
     and port of the blockstore for Data Center 2 and click :guilabel:`Save`.

5. Select the :guilabel:`General` tab, then select :guilabel:`Groups`,
   then select ``Data Center 1``, and then select the :guilabel:`View`
   link for the :guilabel:`Backup Configuration`.

6. For each of the following, click the drop-down box and select the
   local option for the group:

   - :guilabel:`Backup Daemons`

   - :guilabel:`Sync Stores`

   - :guilabel:`Oplog Stores`

   - :guilabel:`Block Stores`

7. Repeat the above steps for the Data Center 2 group.

8. For all users in Data Center 1, download the Monitoring and Backup
   agents from the group assigned to Data Center 1. For all users in Data
   Center 2, download the Monitoring and Backup agents from the group
   assigned to Data Center 2.

   See the following pages for the procedures for installing the agents:

   - :doc:`/tutorial/nav/install-monitoring-agent`

   - :doc:`/tutorial/nav/install-backup-agent`
