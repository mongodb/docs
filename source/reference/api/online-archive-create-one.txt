.. _api-online-archive-create-one:

========================
Create an Online Archive
========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

You can create an :ref:`online archive <manage-online-archive>` from the 
API and |service| :ref:`UI <config-online-archive>`. You must have the 
``GROUP_DATA_ACCESS_ADMIN`` (:authrole:`Project Data Access Admin`) role 
to create an online archive.

.. include:: /includes/api-requirements.rst

.. include:: /includes/fact-projects-groups-synonyms.rst

.. include:: /includes/api-base-url-new.rst

.. _api-online-archive-create-one-syntax:

Syntax
------

.. code-block:: none

   POST /groups/{GROUP-ID}/clusters/{CLUSTER-NAME}/onlineArchives

.. _api-online-archive-create-one-params:

Request Parameters
------------------

.. _api-online-archive-create-one-path-params:

Request Path Parameters
~~~~~~~~~~~~~~~~~~~~~~~

.. list-table::
   :header-rows: 1
   :widths: 15 10 75

   * - Path Element
     - Necessity
     - Description

   * - ``GROUP-ID``
     - Required
     - Unique identifier for the :ref:`project <projects>`
       that contains the specified cluster.

   * - ``CLUSTER-NAME``
     - Required
     - Name of the cluster that contains the collection for which
       you want to create an online archive.

.. _api-online-archive-create-one-query-params:

Request Query Parameters
~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/no-query-parameters.rst

.. _api-online-archive-create-one-body-params:

Request Body Parameters 
~~~~~~~~~~~~~~~~~~~~~~~

.. list-table:: 
   :header-rows: 1
   :widths: 15 10 10 65

   * - Name
     - Type
     - Necessity
     - Description

   * - ``collName``
     - string
     - Required
     - Name of the collection for which to create an online 
       archive.

   * - ``dbName``
     - string
     - Required
     - Name of the database that contains the collection.

   * - ``criteria``
     - object
     - Required
     - Criteria to use for archiving data.

   * - ``criteria.type``
     - string
     - Required
     - Type of criteria. Value can be one of the following: 

       - ``DATE`` - to select documents for archiving based on a date.
       - ``CUSTOM`` - to select documents for archiving based on a custom 
         |json| query. 

   * - ``criteria.dateField``
     - string
     - Conditional
     - Required if ``criteria.type`` is ``DATE``.
     
       Name of an already indexed date field from the documents. 
       Data is archived when the current date is greater than the 
       value of the date field specified here plus the number of days 
       specified via the ``expireAfterDays`` parameter.

   * - ``criteria.dateFormat``
     - enum
     - Optional
     - If ``criteria.type`` is ``DATE``, the date format. Value can be 
       one of the following: 

       - ``ISODATE`` - ISO-8601 format date (default)
       - ``EPOCH_SECONDS`` - Unix timestamp in seconds
       - ``EPOCH_MILLIS`` - Unix timestamp in milliseconds
       - ``EPOCH_NANOSECONDS`` - Unix timestamp in nanoseconds

       If omitted, defaults to ``ISODATE``.

   * - ``criteria.dateFormat``
     - enum
     - Optional
     - Date format of the specified date field. Value can be 
       one of the following: 

       - ``ISODATE`` - ISO-8601 format date (default)
       - ``EPOCH_SECONDS`` - Unix timestamp in seconds
       - ``EPOCH_MILLIS`` - Unix timestamp in milliseconds
       - ``EPOCH_NANOSECONDS`` - Unix timestamp in nanoseconds

       If omitted, defaults to ``ISODATE``.

   * - ``criteria.expireAfterDays``
     - int
     - Conditional
     - Required if ``criteria.type`` is ``DATE``.
     
       Number of days that specifies the age limit for the data 
       in the live |service| cluster. Data is archived when the current 
       date is greater than the value of the date field specified via 
       the ``dateField`` parameter plus the number of days specified 
       here.

   * - ``criteria.query``
     - string
     - Conditional
     - Required if ``criteria.type`` is ``CUSTOM``.
     
       |json| query to use to select documents for archiving. |service| 
       uses the specified query with the :manual:`db.collection.find(query) 
       </reference/method/db.collection.find/>` command. The empty 
       document ``{}`` to return all documents is not supported.

   * - ``partitionFields``
     - document array
     - Optional
     - Fields to use to partition data. You can specify up to two 
       frequently queried fields to use for partitioning data. Note 
       that queries that donâ€™t contain the specified fields will 
       require a full collection scan of all archived documents, which 
       will take longer and increase your costs. To learn more about 
       how partition improves query performance, see `Data Structure 
       in S3 <https://docs.mongodb.com/datalake/admin/optimize-query-performance#data-structure-in-s3>`__. 

       .. include:: /includes/fact-online-archive-partition-field-length.rst

   * - ``partitionFields.fieldName``
     - string
     - Required
     - Name of the field. To specify a nested field, use the 
       :manual:`dot notation </core/document/#embedded-documents>`.

   * - ``partitionFields.order``
     - int
     - Required
     - Position of the field in the partition. Value can be: 

       - ``0`` - for the first position 
       - ``1`` - for the second position
       - ``2`` - for the third position

       By default, the date field specified in the 
       ``criteria.dateField`` parameter is in the first position of the 
       partition.

.. _api-online-archive-create-one-response:

Response Elements 
-----------------

.. include:: /includes/list-table-online-archive-response.rst

.. _api-online-archive-create-one-eg:

Examples 
--------

Date Criteria Examples 
~~~~~~~~~~~~~~~~~~~~~~

.. tabs:: 

   .. tab:: Basic Example
      :tabid: basic
   
      The following example request creates an online archive for 
      an example ``people.employees`` collection in a cluster named 
      ``myTestClstr``. Data in the collection will be archived based on the 
      ``created`` date field and partitioned based on the ``firstName`` and 
      ``lastName`` fields. The criteria for archiving data specifies that data 
      should be archived when current date is greater than the value of the 
      ``created`` date field plus ``5`` days.

      **Example Request** 

      .. code-block:: json 

         curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
         --header "Content-Type: application/json" \
         --include \
         --request POST "https://cloud.mongodb.com/api/atlas/v1.0/groups/5e2211c17a3e5a48f5497de3/clusters/myTestClstr/onlineArchives?pretty=true" \
         --data '
         {
	         "dbName": "people",
	         "collName": "employees",
	         "partitionFields": [
		         {
			         "fieldType": "string",
			         "fieldName": "firstName", 
			         "order": 0
		         }, 
		         {
			         "fieldType": "string",
			         "fieldName": "lastName",
			         "order": 1
		       }], 
	         "criteria": {
		         "type": "DATE",
		         "dateField": "created",
		         "dateFormat": "ISODATE",
		         "expireAfterDays": 5
           }
         }'

      **Example Response** 

      .. code-block:: json 
         :copyable: false 

         {
           "_id": "5ebad3c1fe9c0ab8d37d61e1",
           "clusterName": "myTestClstr",
           "collName": "employees",
           "criteria": {
             "type": "DATE",
             "dateField": "created",
             "dateFormat": "ISODATE",
             "expireAfterDays": 5
           },
           "dbName": "people",
           "groupId": "5e2211c17a3e5a48f5497de3",
           "partitionFields": [
             {
               "fieldName": "firstName",
               "fieldType": "string",
               "order": 0
             },
             {
               "fieldName": "lastName",
               "fieldType": "string",
               "order": 1
             }
           ],
           "paused": false,
           "state": "PENDING"
         }

   .. tab:: Advanced Example
      :tabid: advanced

      The following example request creates an online archive for 
      an example ``accounting.invoices`` collection in a cluster named 
      ``myTestClstr``. Data in the collection will be archived based on the 
      ``created`` date field. Data is partitioned based on the ``created`` 
      field, which is moved to the first position, ``customerID`` field, and  
      ``invoiceNumber`` field. The criteria for archiving data specifies that 
      data should be archived when current date is greater than the value of 
      the ``created`` date field plus ``7`` days.

      **Example Request** 

      .. code-block:: json 

         curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
         --header "Content-Type: application/json" \
         --include \
         --request POST "https://cloud.mongodb.com/api/atlas/v1.0/groups/5e2211c17a3e5a48f5497de3/clusters/myTestClstr/onlineArchives?pretty=true" \
         --data '
         {
	         "dbName": "accounting",
	         "collName": "invoices",
	         "partitionFields": [
		         {
			         "fieldType": "date",
			         "fieldName": "created", 
			         "order": 0
		         }, 
		         {
			         "fieldType": "string",
			         "fieldName": "customerID",
			         "order": 1
		         },
		         {
			         "fieldType": "int",
			         "fieldName": "invoiceNumber",
			         "order": 2
		       }], 
	         "criteria": {
		         "type": "DATE",
		         "dateField": "created",
		         "dateFormat": "ISODATE",
		         "expireAfterDays": 7
           }
         }'

      **Example Response** 

      .. code-block:: json 
         :copyable: false 

         {
           "_id": "5f9869ddb41cea31cfcb000a",
           "clusterName": "myTestClstr",
           "collName": "invoices",
           "criteria": {
             "type": "DATE",
             "dateField": "created",
             "dateFormat": "ISODATE",
             "expireAfterDays": 7
           },
           "dbName": "accounting",
           "groupId": "5e2211c17a3e5a48f5497de3",
           "partitionFields": [
             {
               "fieldName": "created",
               "fieldType": "date",
               "order": 0
             },
             {
               "fieldName": "customerID",
               "fieldType": "string",
               "order": 1
             },
             {
               "fieldName": "invoiceNumber",
               "fieldType": "int",
               "order": 2
             }
           ],
           "paused": false,
           "state": "PENDING"
         }

Custom Criteria Example 
~~~~~~~~~~~~~~~~~~~~~~~

The following example request creates an online archive for an example 
``people.employees`` collection in a cluster named ``myTestClstr``. 
Documents in the collection will be selected for archiving based on a 
custom query and data is partitioned based on the ``firstName`` and 
``lastName`` fields. 

**Example Request**

.. code-block:: json

   curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
   --header "Content-Type: application/json" \
   --include \
   --request POST "https://cloud.mongodb.com/api/atlas/v1.0/groups/5e2211c17a3e5a48f5497de3/clusters/myTestClstr/onlineArchives?pretty=true" \
   --data '
   {
        "dbName": "people",
        "collName": "employees",
        "partitionFields": [
              {
                      "fieldType": "string",
                      "fieldName": "firstName",
                      "order": 0
              },
              {
                      "fieldType": "string",
                      "fieldName": "lastName",
                      "order": 1
              }],
        "criteria": {
              "type": "CUSTOM",
              "query": "{ department: engineering }"
        }
   }'

**Example Response**

.. code-block:: json
   :copyable: false

   {
     "_id": "5f9856146b3c0c4e454b9409",
     "clusterName": "osTest",
     "collName": "employees",
     "criteria": {
        "type": "CUSTOM",
        "query": "{department: engineering}"
     },
     "dbName": "people",
     "groupId": "5e2211c17a3e5a48f5497de3",
     "partitionFields": [
        {
            "fieldName": "name.firstName",
            "fieldType": null,
            "order": 0
        },
        {
            "fieldName": "name.lastName",
            "fieldType": null,
            "order": 1
        }
     ],
     "paused": false,
     "state": "PENDING"
   }

.. _api-online-archive-create-one-errors:

Error Codes 
-----------

If the request fails, it returns one of the following errors: 

.. list-table:: 
   :header-rows: 1
   :widths: 30 70

   * - Error Code
     - Description

   * - ``INVALID_GROUP_ID``
     - The specified project ID is not valid.

   * - ``CLUSTER_NOT_FOUND``
     - There is no cluster with the specified name in the specified 
       project.

   * - ``CLUSTER_DELETE_REQUESTED``
     - The cluster for the online archive is being deleted.

   * - ``ONLINE_ARCHIVE_ALREADY_EXISTS``
     - An online archive with identical settings already exists.

   * - ``NAMESPACE_HAS_ONLINE_ARCHIVE``
     - The collection has another active online archive and so, an 
       online archive with the specified criteria can't be created.

   * - ``RESOURCE_NOT_FOUND``
     - The specified archive ID is not valid.
