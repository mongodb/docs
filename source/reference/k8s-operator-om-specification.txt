.. _k8s-om-specification:

==================================
Ops Manager Resource Specification
==================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

The :github:`MongoDB Enterprise Kubernetes Operator </mongodb/mongodb-enterprise-kubernetes>`
creates a containerized |onprem| deployment from specification files
that you write.

After you create or update an |onprem| resource specification, you
direct |k8s-op-full| to apply this specification to your |k8s|
environment. |k8s-op-short| creates the services and custom |k8s|
resources that |onprem| requires, then deploys |onprem| and its backing
application database in containers in your |k8s| environment.

Each |onprem| resource uses an |k8s-obj| specification in |yaml| to
define the characteristics and settings of the deployment.

Examples
---------

The following example shows a resource specification for an |onprem|
deployment:

.. literalinclude:: /reference/k8s/example-ops-manager.yaml
   :language: yaml
   :linenos:


Required |onprem| Resource Settings
-----------------------------------

This section describes settings that you must use for all |onprem|
resources.

.. opsmgrkube:: apiVersion

   *Type*: string

   *Required*. Version of the MongoDB |k8s| resource schema.

.. opsmgrkube:: kind

   *Type*: string

   *Required*. Kind of MongoDB Kubernetes resource to create. Set this
   to ``MongoDBOpsManager``.

.. opsmgrkube:: metadata.name

   *Type*: string

   *Required*. Name of the MongoDB |k8s| resource you are creating.

   .. include:: /includes/fact-resource-name-char-limit.rst

.. opsmgrkube:: spec.replicas

   *Type*: integer

   *Required*. Number of |onprem| instances to run in parallel.
   The minimum accepted value is ``1``.

   .. include:: /includes/admonitions/note-highly-available-om.rst

.. opsmgrkube:: spec.version

   *Type*: string

   *Required*. Version of |onprem| that you want to install
   on this MongoDB |k8s| resource.

.. opsmgrkube:: spec.adminCredentials

   *Type*: string

   *Required*. Name of the |k8s| |k8s-secret| you created for
   the |onprem| admin user. When you deploy the |onprem| resource,
   |k8s-op-short| creates a user with these credentials.

   .. include:: /includes/facts/fact-can-change-secret-storage-tool.rst

   The admin user is granted the
   :opsmgr:`Global Owner </reference/user-roles/#global-automation-admin-role>`
   role.

.. opsmgrkube:: spec.applicationDatabase.members

   *Type*: integer

   *Required*. Number of members in the
   :opsmgr:`Application Database </core/system-overview/#application-database>`
   replica set.

.. opsmgrkube:: spec.applicationDatabase.version

   *Type*: string

   *Required*. Version of MongoDB installed on the |onprem|
   :opsmgr:`Application Database </core/system-overview/#application-database>`.
   You must specify a compatible enterprise MongoDB version based on the tag in the
   :qr-mdb:`container registry </mongodb-enterprise-appdb-database?tab=tags>`.

   .. include:: /includes/admonitions/ubi-8-min-db-versions.rst

   .. note::

      If you update this value to a later version of MongoDB for the 
      Application Database, the Feature Compatibility Version (FCV) *does 
      not change* unless you also specify the 
      ``featureCompatibilityVersion``
      parameter under :opsmgrkube:`spec.applicationDatabase`.


.. _optional-om-k8s-settings:

Optional |onprem| Resource Settings
-----------------------------------

|onprem| resources can use the following settings:

.. opsmgrkube:: spec.applicationDatabase

   *Type*: collection

   |onprem| :opsmgr:`Application Database </core/system-overview/#application-database>`
   resource definition.

   The following settings from the
   :ref:`replica set <replica-set-settings>` resource specification are
   optional:

   - ``spec.applicationDatabase.``:setting:`~spec.additionalMongodConfig`
   - ``spec.applicationDatabase.``:setting:`~spec.agent`
   - ``spec.applicationDatabase.agent.``:setting:`~spec.agent.startupOptions`
   - ``spec.applicationDatabase.monitoringAgent.``:setting:`~spec.agent.startupOptions`
   - ``spec.applicationDatabase.``:setting:`~spec.featureCompatibilityVersion`
   - ``spec.applicationDatabase.``:setting:`~spec.logLevel`
   - ``spec.applicationDatabase.podSpec.persistence.``:setting:`~spec.podSpec.persistence.single`
   - ``spec.applicationDatabase.podSpec.persistence.multiple.``:setting:`~spec.podSpec.persistence.multiple.data`
   - ``spec.applicationDatabase.podSpec.persistence.multiple.``:setting:`~spec.podSpec.persistence.multiple.journal`
   - ``spec.applicationDatabase.podSpec.persistence.multiple.``:setting:`~spec.podSpec.persistence.multiple.logs`
   - ``spec.applicationDatabase.podSpec.``:setting:`~spec.podSpec.podTemplate`

.. note::
   All settings under ``spec.applicationDatabase.agent`` apply to both
   Automation and Monitoring, unless you specify values for Automation
   and Monitoring separately in ``spec.applicationDatabase.agent`` and
   ``spec.applicationDatabase.monitoringAgent``.

.. opsmgrkube:: spec.applicationDatabase.passwordSecretKeyRef.name

   *Type*: string

   Name of the :ref:`secret <om-db-user-secret>` that contains the
   password for the |onprem| database user ``mongodb-ops-manager``.
   |onprem| uses this password to :ref:`authenticate to the Application
   Database <app-db-auth>`.

.. opsmgrkube:: spec.applicationDatabase.passwordSecretKeyRef.key

   *Type*: string

   Name of the field in the :ref:`secret <om-db-user-secret>` that
   contains the password for the |onprem| database user
   ``mongodb-ops-manager``. |onprem| uses this password to
   :ref:`authenticate to the Application Database <app-db-auth>`.

   The default value is ``password``.

.. opsmgrkube:: spec.applicationDatabase.security.certsSecretPrefix

   *Type*: string

   Text to prefix to the name of the secret that contains the
   application database's |tls| certificate. Name the secret
   ``<prefix>-<metadata.name>-db-cert``.

.. opsmgrkube:: spec.applicationDatabase.security.tls.ca

   *Type*: string

   Name of the |k8s| |k8s-configmap| containing the |certauth| file for
   the application database.

   .. important::

      :opsmgrkube:`spec.applicationDatabase.security.tls.ca` is required
      if you use a Custom Certificate Authority to sign your application
      database |tls| certificates.

      The |k8s-op-short| requires that the certificate is named
      ``ca-pem`` in the ConfigMap.

      The |certauth| specified in this section is also used for 
      configuring custom |tls| certificates for |s3| storage when either
      :opsmgrkube:`spec.backup.s3OpLogStores.customCertificate` or
      :opsmgrkube:`spec.backup.s3Stores.customCertificate` are set to 
      `true`.

   This |certauth| signs the certificates that:
   
   - the application database replica set members use to communicate
     with one another, and
   - |onprem| uses to communicate with the application database replica
     set.

   .. include:: /includes/admonitions/warning-concatenate-download-certs.rst

.. opsmgrkube:: spec.app

   *Type*: string

   Text to prefix to the |k8s| |k8s-secret| that you
   created that contains your application database's |tls| key and 
   certificate.

   You must name your secret ``<prefix>-<metadata.name>-db-cert``.

   To learn how to configure your |onprem| instance to run over
   |https|, see :ref:`deploy-om-container`.

.. opsmgrkube:: spec.applicationDatabase.security.tls.enabled

  .. important::

     :setting:`spec.security.applicationDatabase.tls.enabled` is 
     deprecated and will be removed in a future release. To enable 
     |tls|, provide a value for the 
     :setting:`spec.security.applicationDatabase.certsSecretPrefix` 
     setting.

  Encrypts communications using |tls| certificates between |onprem| and
  the application database.

.. opsmgrkube:: spec.backup.assignmentLabels

   *Type*: array of strings

   A list of assignment labels for the :ref:`backup-daemon` processes.
   Use assignment labels to identify that specific backup daemon
   processes are associated with particular projects. If you set assignment
   labels using the |k8s-op-short|, the values that you set in the |k8s|
   configuration file for assignment labels override the values defined
   in the |mms| UI. Assignment labels that you don't set using the
   |k8s-op-short| continue to use the values set in the |mms| UI.

.. opsmgrkube:: spec.backup.enabled

   *Type*: boolean

   Flag that enables Backup for your |onprem| resource. When set to
   ``false``, Backup is disabled.

   Default value is ``true``.

.. opsmgrkube:: spec.backup.encryption

   *Type*: object

   Object that contains the backup encryption configuration settings.

.. opsmgrkube:: spec.backup.encryption.kmip

   *Type*: object

   Object that contains the |kmip| backup encryption configuration 
   settings. To learn more, see :ref:`configure-kmip-backup-encryption`.

.. opsmgrkube:: spec.backup.encryption.kmip.server

   *Type*: object

   Object that contains the |kmip| backup encryption server 
   configuration settings.

.. opsmgrkube:: spec.backup.encryption.kmip.server.ca

   *Type*: string

   Human-readable label that identifies the ConfigMap that contains an 
   entry for the |certauth| certificate (``ca.pem``) to use for |kmip| 
   authentication.

.. opsmgrkube:: spec.backup.encryption.kmip.server.url

   *Type*: string

   |url| for the |kmip| server that uses the ``hostname.port`` format 
   (for example, ``192.168.1.3:5696`` or 
   ``my-kmip-server.mycorp.com:5696``).

.. opsmgrkube:: spec.backup.headDB

   *Type*: collection

   Configuration settings for the :ref:`head database <backup-daemon>`.
   |k8s-op-short| creates a |k8s-pvc| with the specified configuration.

   .. list-table::
      :widths: 20 20 60
      :header-rows: 1

      * - Scalar
        - Data Type
        - Description

      * - ``labelSelector``
        - string
        - `Tag
          <https://kubernetes.io/docs/concepts/storage/persistent-volumes/#selector>`__
          used to bind mounted volumes to directories.

      * - ``storage``
        - string
        - Minimum size of |k8s-pv| that should be mounted. This value is
          expressed as an integer followed by a unit of storage in
          |jedec| notation.

          Default value is ``30Gi``.

          .. seealso::

             :ref:`backup-hardware-requirements`

          .. example::

             If the head database requires 60 gigabytes of storage
             space, set this value to ``60Gi``.

      * - ``storageClass``
        - string
        - Type of storage specified in a |k8s-pvc|. You may create 
          this storage type as a |k8s-sc| object before using it in this
          |k8s-obj| specification.

          .. note::

             .. include:: /includes/admonitions/fact-reclaimpolicy-to-retain.rst

.. opsmgrkube:: spec.backup.jvmParameters

   *Type*: array of strings

   *Optional*. |jvm| parameters passed to the |onprem| backup service
   in the container.

   This |k8s-op-short| parameter defaults to an empty list.

   .. code-block:: yaml

      spec:
        backup:
          jvmParameters: ["-XX:+UseStringCache"]

   .. admonition:: Change the JVM Memory Heap values at your own risk
      :class: warning

      |k8s-op-short| calculates the |jvm| memory heap values of the
      backup service based on the container's memory. Changing the
      ``-Xms`` and ``-Xmx`` values can cause issues with |onprem|.

.. opsmgrkube:: spec.backup.members

   *Type*: integer
   
   *Optional*. Number of :opsmgr:`backup daemon services
   </core/system-overview/#backup-daemon-service>`
   to deploy in |k8s|. If not specified, defaults to ``1``.
   To ensure high availability for your backup service, deploy
   :opsmgr:`multiple backup daemons </tutorial/configure-backup-high-availability/#multiple-backup-daemons>`
   in |onprem|.
   
.. opsmgrkube:: spec.backup.opLogStores

   *Type*: collection

   *Required if you enable backup.*

   Array of :ref:`oplog stores <backup-database-specifications>` used
   for backup. Each item in the array references a MongoDB database
   resource deployed in the |k8s| cluster by the |k8s-op-short|.

.. opsmgrkube:: spec.backup.opLogStores.assignmentLabels

   *Type*: array of strings

   A list of assignment labels for the :ref:`oplog store <backup-database-specifications>`.
   Use assignment labels to identify that specific oplog stores are associated
   with particular projects. If you set assignment labels using the |k8s-op-short|,
   the values that you set in the |k8s| configuration file for assignment
   labels override the values defined in the |mms| UI. Assignment labels
   that you don't set using the |k8s-op-short| continue to use the values
   set in the |mms| UI.

.. opsmgrkube:: spec.backup.opLogStores.name

   *Type*: string

   *Required if you enable Backup.*

   Name of the oplog store.

   .. important::

      Once specified, don't edit the name of the oplog store.

.. opsmgrkube:: spec.backup.opLogStores.mongodbResourceRef.name

   *Type*: string

   *Required if you enable Backup.*

   Name of the MongoDB database resource that you create to store oplog
   slices. You must deploy this database resource in the same namespace
   as the |onprem| resource.

   .. include:: /includes/admonitions/fact-backing-db-auth.rst

   .. include:: /includes/admonitions/watch-backup-resources.rst

.. opsmgrkube:: spec.backup.opLogStores.mongodbUserRef.name

   *Type*: string

   *Required if SCRAM authentication is enabled on the oplog
   store database.*

   Name of the MongoDB user resource used to connect to the oplog store
   database. Deploy this user resource in the same
   namespace as the |onprem| resource and with all of the following roles:
   
   - :manual:`readWriteAnyDatabase
     </reference/built-in-roles/#readWriteAnyDatabase>`
   - :manual:`dbAdminAnyDatabase
     </reference/built-in-roles/#dbAdminAnyDatabase>`
   - :manual:`clusterMonitor
     </reference/built-in-roles/#mongodb-authrole-clusterMonitor>`

.. opsmgrkube:: spec.backup.blockStores

   *Type*: collection

   *Required if you enable Backup using a blockstore.*

   Array of :ref:`blockstores <backup-database-specifications>` used
   for Backup. Each item in the array references a MongoDB database
   resource deployed in the |k8s| cluster by the |k8s-op-short|.

.. opsmgrkube:: spec.backup.blockStores.assignmentLabels

   *Type*: array of strings

   A list of assignment labels for the :ref:`blockstore <backup-database-specifications>`.
   Use assignment labels to identify that specific blockstores are
   associated with particular projects. If you set assignment labels using
   the |k8s-op-short|, the values that you set in the |k8s| configuration
   file for assignment labels override the values defined in the |mms| UI.
   Assignment labels that you don't set using the |k8s-op-short| continue
   to use the values set in the |mms| UI.

.. opsmgrkube:: spec.backup.blockStores.name

   *Type*: string

   *Required if you enable backup using a blockstore.*

   Name of the blockstore.

   .. important::

      Once specified, don't edit the name of the :ref:`blockstore <backup-database-specifications>`.



.. opsmgrkube:: spec.backup.blockStores.mongodbResourceRef.name

   *Type*: string

   *Required if you enable backup using a blockstore.*

   Name of the MongoDB database resource that you create for the
   blockstore. You must deploy this database resource in the same
   namespace as the |onprem| resource.

   The blockstore database only supports the ``SCRAM`` authentication
   mechanism. You cannot enable other authentication mechanisms.

   If you enable ``SCRAM`` authentication on the blockstore database,
   you must:

   - Create a MongoDB user resource to connect |onprem| to the
     blockstore database.
   - Specify the :opsmgrkube:`~spec.backup.blockStores.mongodbUserRef.name`
     of the user in the |onprem| resource definition.

   .. include:: /includes/admonitions/watch-backup-resources.rst

.. opsmgrkube:: spec.backup.blockStores.mongodbUserRef.name

   *Type*: string

   *Required if SCRAM authentication is enabled on the blockstore database.*

   Name of the MongoDB user resource used to connect to the blockstore
   database. Deploy this user resource in the same
   namespace as the |onprem| resource and with all of the following roles:
   
   - :manual:`readWriteAnyDatabase
     </reference/built-in-roles/#readWriteAnyDatabase>`
   - :manual:`dbAdminAnyDatabase
     </reference/built-in-roles/#dbAdminAnyDatabase>`
   - :manual:`clusterMonitor
     </reference/built-in-roles/#mongodb-authrole-clusterMonitor>`

.. opsmgrkube:: spec.backup.queryableBackupSecretRef.name

   *Type*: string

   Name of the secret that contains the :opsmgr:`queryable.pem </reference/configuration/#brs.queryable.pem>`
   file from |onprem| that you will use for accessing and querying backups
   based on your deployment's |tls| requirements.The PEM file contains
   a public key certificate and its associated private key that are needed
   to access and run queries on backup snapshots in |onprem|.
   To query backups, specify the value for this parameter. If not set,
   backups are not affected, but you can't query them.

.. opsmgrkube:: spec.backup.statefulSet.spec

   *Type*: collection

   Specification for the |k8s-statefulset| that the |k8s-op| creates
   for the :opsmgr:`backup daemon service
   </core/system-overview/#backup-daemon-service>`.

   To review which fields you can add to
   :opsmgrkube:`spec.backup.statefulSet.spec`, see
   :k8sdocs:`StatefulSetSpec v1 apps
   </reference/generated/kubernetes-api/{+k8s-api-version+}/#statefulsetspec-v1-apps>` in the |k8s| documentation.

.. opsmgrkube:: spec.backup.statefulSet.spec.template

   *Type*: collection

   :k8sdocs:`Template </concepts/workloads/pods/pod-overview/#pod-templates>`
   for the |k8s| pods in the |k8s-statefulset| that the |k8s-op| creates
   for the :opsmgr:`backup daemon service
   </core/system-overview/#backup-daemon-service>`.

   .. note::

      The |k8s-op-short| doesn't validate the fields you provide
      in :opsmgrkube:`spec.backup.statefulSet.spec.template`.

.. opsmgrkube:: spec.backup.statefulSet.spec.template.metadata

   *Type*: collection

   Metadata for the |k8s| pods in the |k8s-statefulset| that the
   |k8s-op| creates for the :opsmgr:`backup daemon service
   </core/system-overview/#backup-daemon-service>`.

   To review which fields you can add to
   :opsmgrkube:`spec.backup.statefulSet.spec.template.metadata`, see
   the :k8sdocs:`Kubernetes documentation
   </reference/generated/kubernetes-api/{+k8s-api-version+}/#objectmeta-v1-meta>`.

.. opsmgrkube:: spec.backup.statefulSet.spec.template.spec

   *Type*: collection

   Specifications of the |k8s| pods in the |k8s-statefulset| that the
   |k8s-op| creates for the :opsmgr:`backup daemon service
   </core/system-overview/#backup-daemon-service>`.

   To review the complete list of fields you can add to
   :opsmgrkube:`spec.backup.statefulSet.spec.template.spec`, see the
   :k8sdocs:`Kubernetes documentation
   </reference/generated/kubernetes-api/{+k8s-api-version+}/#podspec-v1-core>`.

   The following example ``spec.backup.statefulSet.spec.template.spec``
   defines minimum and maximum CPU and memory capacity for one
   :opsmgr:`backup daemon service
   </core/system-overview/#backup-daemon-service>` container the |k8s-op| deploys:

   .. code-block:: yaml

      statefulSet:
        spec:
          template:
            spec:
              containers:
              - name: mongodb-backup-daemon
                resources:
                  requests:
                    cpu: "0.50"
                    memory: "4500M"
                  limits:
                    cpu: "1"
                    memory: "6000M"


.. opsmgrkube:: spec.backup.statefulSet.spec.template.spec.containers

   *Type*: collection

   List of containers that belong to the |k8s| pods in the
   |k8s-statefulset| that the |k8s-op| creates for the
   :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>`.

   To modify the specifications of the :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>` container,
   you must provide the exact name of the container using the ``name``
   field, as shown in the following example:

   .. code-block:: yaml

         backup:
          statefulSet:
            spec:
              template:
                spec:
                  containers:
                  - name: mongodb-backup-daemon

   .. note::

      When you add containers to
      ``spec.backup.statefulSet.spec.template.spec.containers``,
      the |k8s-op-short| adds them to the |k8s| pod. These containers
      are appended to the :ref:`backup-daemon` containers in the pod.

.. opsmgrkube:: spec.backup.statefulSet.spec.template.spec.containers.resources.requests.cpu

   *Type*: string

   Minimum CPU capacity that must be available on a |k8s| |k8s-node| to
   host the :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>`.

   The requested value must be less than or equal to
   :opsmgrkube:`spec.backup.statefulSet.spec.template.spec.containers.resources.limits.cpu`.

.. opsmgrkube:: spec.backup.statefulSet.spec.template.spec.containers.resources.limits.cpu

   *Type*: string

   Maximum CPU capacity for the |k8s-node| being created to host
   the :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>`.
   If omitted, this value is set to
   :opsmgrkube:`spec.backup.statefulSet.spec.template.spec.containers.resources.requests.cpu`.

.. opsmgrkube:: spec.backup.statefulSet.spec.template.spec.containers.resources.requests.memory

   *Type*: string

   Minimum memory capacity that must be available on a |k8s| |k8s-node|
   to host the :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>` on |k8s|.
   This value is expressed as an integer followed by a unit of memory
   in |jedec| notation.

   .. note::

      Set this value to at least ``4.5Gi``. Values of less than ``4.5Gi``
      might result in an error.

   The requested value must be less than or equal to
   :opsmgrkube:`spec.backup.statefulSet.spec.template.spec.containers.resources.limits.memory`.

.. opsmgrkube:: spec.backup.statefulSet.spec.template.spec.containers.resources.limits.memory

   *Type*: string

   Maximum memory capacity for the |k8s-node| being created to host
   the :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>`. If omitted,
   this value is set to :opsmgrkube:`spec.backup.statefulSet.spec.template.spec.containers.resources.requests.memory`.

   The |k8s-op-short| calculates and sets parameters for Java heap size
   based on the container's memory.

   .. admonition:: Limit this value to less than 32 GB
      :class: warning

      Setting this value to a value greater than 32 GB (``32Gi``) can
      cause issues with the backup service. Excessive heaps can cause
      unpredictable results in |onprem|.

.. opsmgrkube:: spec.clusterDomain

   *Type*: string

   |k8s| assigns each |k8s-pod| a |fqdn|. The |k8s-op-short| calculates
   the |fqdn| for each |k8s-pod| using a provided ``clusterDomain``.
   |k8s| doesn't provide an |api| to query these hostnames.

.. opsmgrkube:: spec.clusterName

   .. admonition:: ``spec.clusterName`` is Deprecated
      :class: important

      Use :setting:`spec.clusterDomain` instead.

   *Type*: string

   |k8s| assigns each |k8s-pod| a |fqdn|. The |k8s-op-short| calculates
   the |fqdn| for each |k8s-pod| using a provided ``clusterName``. |k8s|
   doesn't provide an |api| to query these hostnames.

.. opsmgrkube:: spec.configuration

   *Type*: collection

   |onprem| configuration properties.
   See :opsmgr:`Ops Manager Configuration Settings
   </reference/configuration/>` for property names and descriptions.
   Each property takes a value of type ``string``.

   .. include:: /includes/admonitions/mms-centralurl-external-mdb.rst

.. opsmgrkube:: spec.configuration.mms.mongoDbUsage.defaultUsageType

   *Type*: string

   The |k8s| service's :opsmgr:`default server type
   </reference/config/ui-settings/index.html#Default-Ops-Manager-MongoDB-Server-Type>`.

   Accepted values are: ``PRODUCTION_SERVER``, ``TEST_SERVER``, ``DEV_SERVER``, and
   ``RAM_POOL``.

.. opsmgrkube:: spec.externalConnectivity

   *Type*: collection

   Configuration object that enables external connectivity to |onprem|.
   If provided, the |k8s-op-short| creates a |k8s| :k8sdocs:`service
   </concepts/services-networking/service/>` that allows traffic
   originating from outside of the |k8s| cluster to reach the |onprem|
   application.

   If not provided, the |k8s-op-short| doesn't create a |k8s| service.
   You must create one manually or use a third-party solution that
   enables you to route external traffic to the |application| in your
   |k8s| cluster.

.. opsmgrkube:: spec.externalConnectivity.type

   *Type*: string

   The |k8s| service :k8sdocs:`ServiceType
   </concepts/services-networking/service/#publishing-services-service-types>`
   that exposes |onprem| outside of |k8s|.

   *Required* if :opsmgrkube:`spec.externalConnectivity.type` is
   present.

   Accepted values are: ``LoadBalancer`` and ``NodePort``.
   ``LoadBalancer`` is recommended if your cloud provider supports it.
   Use ``NodePort`` for local deployments.

.. opsmgrkube:: spec.externalConnectivity.port

   *Type*: integer

   Value that indicates which port that a |k8s| service exposes the
   |application| should use for external traffic.


   - If :opsmgrkube:`spec.externalConnectivity.type` is ``NodePort``:
   
     - The |k8s| service exposes the |application| to external traffic
       through this port.

     - If you don't provide a :opsmgrkube:`spec.externalConnectivity.port`
       value, the |k8s| service routes traffic to the |application| from an
       available port selected randomly from the following default range: ``30000``-``32767``.

       .. note::

          You must configure your network's firewall to allow traffic over
          this port.

   - If :opsmgrkube:`spec.externalConnectivity.type` is ``LoadBalancer``:

     - The load balancer resource that your cloud provider creates exposes
       the |application| through this port.

     - If you don't provide a :opsmgrkube:`spec.externalConnectivity.port`
       value, the |k8s| service exposes the |application| to external
       traffic through the default HTTP (8080) or HTTPS (8443) port.

.. opsmgrkube:: spec.externalConnectivity.loadBalancerIP

   *Type*: string

   The IP address the ``LoadBalancer`` |k8s| service uses when the
   |k8s-op-short| creates it.

   This setting can only be used if your cloud provider supports it and
   :opsmgrkube:`spec.externalConnectivity.type` is ``LoadBalancer``. To
   learn more about the
   :k8sdocs:`Type LoadBalancer
   </concepts/services-networking/service/#loadbalancer>`, see the
   |k8s| documentation.

.. opsmgrkube:: spec.externalConnectivity.externalTrafficPolicy

   *Type*: string

   Routing policy for external traffic to the |onprem| |k8s| service.
   The service routes external traffic to node-local or cluster-wide
   endpoints depending the value of this setting.

   Accepted values are: ``Cluster`` and ``Local``. To learn which of
   values meet your requirements, see :k8sdocs:`Source IPs in Kubernetes
   </tutorials/services/source-ip/>` in the |k8s| documentation.

   .. note::

      If you select ``Cluster``, the ``Source-IP`` of your clients are
      lost during the network hops that happen at the |k8s|
      network boundary.

.. opsmgrkube:: spec.externalConnectivity.annotations

   *Type*: collection

   Key-value pairs that allow you to provide cloud provider-specific
   configuration settings.

   To learn more about
   :k8sdocs:`Annotations </concepts/overview/working-with-objects/annotations/>`
   and
   :k8sdocs:`TLS support on AWS </concepts/services-networking/service/#ssl-support-on-aws>`,
   see the |k8s| documentation.

.. opsmgrkube:: spec.jvmParameters

   *Type*: array of strings

   *Optional*. |jvm| parameters passed to the |application| in the
   container. Any parameters given replace the default |jvm| parameters
   for the |application|.

   This |k8s-op-short| parameter defaults to an empty list.

   .. code-block:: yaml

      spec:
        jvmParameters: ["-XX:+HeapDumpOnOutOfMemoryError","-XX:HeapDumpPath=/tmp"]

   .. important:: Change the JVM Memory Heap values at your own risk

      |k8s-op-short| calculates its |jvm| memory heap values of the
      |application| based on the container's memory. Changing the
      ``-Xms`` and ``-Xmx`` values can cause issues with |onprem|.

.. opsmgrkube:: spec.security.certsSecretPrefix

   *Type*: string

   Text to prefix to the |k8s| |k8s-secret| that you
   created that contain |onprem|\'s |tls| key and certificate.

   You must name your secret ``<prefix>-<metadata.name>-cert``.

   To learn how to configure your |onprem| instance to run over
   |https|, see :ref:`deploy-om-container`.

.. opsmgrkube:: spec.security.tls.ca

   Name of the |k8s| |k8s-configmap| that contains a custom |certauth|
   file for |onprem|.

   .. important::

      :opsmgrkube:`spec.security.tls.ca` is required if you use a Custom
      Certificate Authority to sign your |onprem| |tls| certificates.

      The |k8s-op-short| requires that the certificate is named
      ``mms-ca.crt`` in the ConfigMap.

   This |certauth| signs the certificates that:

   - clients use to connect to the |application|, and
   - agents in the application database |k8s-pods| use to communicate
     with |onprem|.

   .. include:: /includes/admonitions/warning-concatenate-download-certs.rst

.. opsmgrkube:: spec.security.tls.enabled

  .. important::

     :setting:`spec.security.tls.enabled` is 
     deprecated and will be removed in a future release. To enable 
     |tls|, provide a value for the 
     :setting:`spec.security.certsSecretPrefix` 
     setting.

  Encrypts communications using |tls| certificates between clients and 
  |onprem|.

.. opsmgrkube:: spec.statefulSet.spec

   *Type*: collection

   Specification for the |k8s-statefulset| that the |k8s-op| creates
   for |onprem|.

   To review which fields you can add to
   :opsmgrkube:`spec.statefulSet.spec`, see
   :k8sdocs:`StatefulSetSpec v1 apps
   </reference/generated/kubernetes-api/{+k8s-api-version+}/#statefulsetspec-v1-apps>`
   in the |k8s| documentation.

.. opsmgrkube:: spec.statefulSet.spec.template

   *Type*: collection

   :k8sdocs:`Template </concepts/workloads/pods/pod-overview/#pod-templates>`
   for the |k8s| pods in the |k8s-statefulset| that the |k8s-op| creates
   for the |onprem|.

   .. note::

      The |k8s-op-short| doesn't validate the fields you provide
      in :opsmgrkube:`spec.statefulSet.spec.template`.

.. opsmgrkube:: spec.statefulSet.spec.template.metadata

   *Type*: collection

   Metadata for the |k8s| pods in the |k8s-statefulset| that the
   |k8s-op| creates for the |onprem|.

   To review which fields you can add to
   :opsmgrkube:`spec.statefulSet.spec.template.metadata`, see
   the :k8sdocs:`Kubernetes documentation
   </reference/generated/kubernetes-api/{+k8s-api-version+}/#objectmeta-v1-meta>`.

.. opsmgrkube:: spec.statefulSet.spec.template.spec

   *Type*: collection

   Specifications of the |k8s| pods in the |k8s-statefulset| that the
   |k8s-op| creates for the |onprem|.

   To review the complete list of fields you can add to
   :opsmgrkube:`spec.statefulSet.spec.template.spec`, see the
   :k8sdocs:`Kubernetes documentation
   </reference/generated/kubernetes-api/{+k8s-api-version+}/#podspec-v1-core>`.

   The following example ``spec.statefulSet.spec.template.spec`` defines
   minimum and maximum CPU and memory capacity for one |onprem|
   container the |k8s-op| deploys:

   .. code-block:: yaml

      statefulSet:
        spec:
          template:
            spec:
              containers:
                - name: mongodb-ops-manager
                  resources:
                    requests:
                      cpu: "0.70"
                      memory: "6Gi"
                    limits:
                      cpu: "1"
                      memory: "7000M"

.. opsmgrkube:: spec.statefulSet.spec.template.spec.containers

   *Type*: collection

   List of containers that belong to the |k8s| pods in the
   |k8s-statefulset| that the |k8s-op| creates for the
   |onprem|.

   To modify the specifications of the |onprem| container,
   you must provide the exact name of the container using the ``name``
   field, as shown in the following example:

   .. code-block:: yaml

         backup:
          statefulSet:
            spec:
              template:
                spec:
                  containers:
                  - name: mongodb-ops-manager

   .. note::

      When you add containers to
      ``spec.statefulSet.spec.template.spec.containers``,
      the |k8s-op-short| adds them to the |k8s| pod. These containers
      are appended to the |onprem| containers in the pod.

.. opsmgrkube:: spec.statefulSet.spec.template.spec.containers.resources.requests.cpu

   *Type*: string

   Minimum CPU capacity that must be available on a |k8s| |k8s-node| to
   host the |onprem|.

   The requested value must be less than or equal to
   :opsmgrkube:`spec.statefulSet.spec.template.spec.containers.resources.limits.cpu`.

.. opsmgrkube:: spec.statefulSet.spec.template.spec.containers.resources.limits.cpu

   *Type*: string

   Maximum CPU capacity for the |k8s-node| being created to host
   the |onprem|. If omitted, this value is set to
   :opsmgrkube:`spec.statefulSet.spec.template.spec.containers.resources.requests.cpu`.

.. opsmgrkube:: spec.statefulSet.spec.template.spec.containers.resources.requests.memory

   *Type*: string

   Minimum memory capacity that must be available on a |k8s| |k8s-node|
   to host the |onprem| on |k8s|. This value is expressed as
   an integer followed by a unit of memory in |jedec| notation.

   .. example::

      If |onprem| on |k8s| requires 6 gigabytes of memory, set
      this value to ``6Gi``.

   .. note::

      MongoDB recommends setting this value to at least ``5Gi``.

   The requested value must be less than or equal to
   :opsmgrkube:`spec.statefulSet.spec.template.spec.containers.resources.limits.memory`.

.. opsmgrkube:: spec.statefulSet.spec.template.spec.containers.resources.limits.memory

   *Type*: string

   Maximum memory capacity for the |k8s-node| being created to host
   the |onprem|. If omitted, this value is set to
   :opsmgrkube:`spec.statefulSet.spec.template.spec.containers.resources.requests.memory`.

   The |k8s-op-short| calculates and sets parameters for Java heap size
   based on the container's memory.

   .. admonition:: Limit this value to less than 32 GB
      :class: warning

      Setting this value to a value greater than 32 GB (``32Gi``) can
      cause issues with the backup service. Excessive heaps can cause
      unpredictable results in |onprem|.

.. _om-prometheus-settings:

Prometheus Settings
~~~~~~~~~~~~~~~~~~~

The following settings apply when you use Prometheus with your 
application database:

.. setting:: spec.applicationDatabase.prometheus

   *Type*: array

   *Optional*

   List that contains the parameters for exposing metrics to Prometheus.

.. setting:: spec.applicationDatabase.prometheus.metricsPath

   *Type*: string

   *Optional*

   *Default*: ``"/metrics"``

   Human-readable string that indicates the path to the metrics 
   endpoint. If you don't specify this setting, the default applies.

.. setting:: spec.applicationDatabase.prometheus.passwordSecretRef

   *Type*: object

   *Conditional*

   Object that contains the details of the |k8s-secret| for 
   basic HTTP authentication. If you want to use Prometheus with your 
   application database, you must specify this setting.

.. setting:: spec.applicationDatabase.prometheus.passwordSecretRef.key

   *Type*: string

   *Optional*

   *Default*: ``"password"``

   Human-readable string that identifies the key in the |k8s-secret| that
   stores the password for basic HTTP authentication. If you don't specify
   this setting, the default applies.

.. setting:: spec.applicationDatabase.prometheus.passwordSecretRef.name

   *Type*: string

   *Conditional*

   Human-readable label that identifies the |k8s-secret| that contains 
   the password for basic HTTP authentication. If you want to use 
   Prometheus with your application database, you must specify this 
   setting.

.. setting:: spec.applicationDatabase.prometheus.port

   *Type*: integer

   *Optional*

   *Default:* 9216

   Number that identifies the port that the metrics endpoint will 
   bind to. If you don't specify this setting, the default applies.

.. setting:: spec.applicationDatabase.prometheus.tlseSecretKeyRef

   *Type*: object

   *Optional*

   Object that contains the details of the |k8s-secret| for |tls| 
   authentication.

.. setting:: spec.applicationDatabase.prometheus.tlseSecretKeyRef.key

   *Type*: string

   *Optional*

   *Default*: ``"password"``

   Human-readable string that identifies the key in the |k8s-secret| that
   stores the password for |tls| authentication. If you don't specify this
   setting, the default applies.

.. setting:: spec.applicationDatabase.prometheus.tlseSecretKeyRef.name

   *Type*: string

   *Conditional*

   Human-readable label that identifies the |k8s-secret| that contains 
   the password for |tls| authentication. If you want to use 
   Prometheus with your application database and you want to use |tls| 
   authentication, you must specify this setting.

.. setting:: spec.applicationDatabase.prometheus.username

   *Type*: string

   *Conditional*

   Human-readable label that identifies the user for basic HTTP 
   authentication. If you want to use Prometheus with your application 
   database, you must specify this setting.

.. _om-s3-settings:

S3 Settings
~~~~~~~~~~~~~~~~~~~

You can configure |onprem| to use |s3| for storing oplogs and backup
snapshots, and secure connections to |s3| with |tls| using keys 
issued by custom |certauth|. 

To configure custom CA keys, use the ConfigMap with which you 
configured |tls| for your application database as described on
the :guilabel:`TLS-Encrypted Connection (HTTPS)` tab of 
:ref:`deploy-om-container`.
Set :opsmgrkube:`spec.applicationDatabase.security.tls.ca` to this ConfigMap.

You can use |tls| for both |s3| and your application database, or for 
|s3| only. 

- To use |tls| for both, get certificates for both purposes from the 
  same `ca-pem` referenced in the ConfigMap.
- To use |tls| for |s3| only, don't define 
  :setting:`spec.security.applicationDatabase.certsSecretPrefix` in 
  your ConfigMap.

.. opsmgrkube:: spec.backup.s3OpLogStores.assignmentLabels

   *Type*: array of strings

   A list of assignment labels for |s3| oplog stores. Use assignment labels
   to identify that specific |s3| oplog stores are associated with particular
   projects. If you set assignment labels using the |k8s-op-short|, the values
   that you set in the |k8s| configuration file for assignment labels override
   the values defined in the |mms| UI. Assignment labels that you don't set
   using the |k8s-op-short| continue to use the values set in the |mms| UI.

.. opsmgrkube:: spec.backup.s3OpLogStores.customCertificate

   *Type*: boolean

   Flag that indicates whether you use custom |tls| certificates for 
   your |s3| oplog store specified by 
   :opsmgrkube:`spec.applicationDatabase.security.tls.ca`.
   The default is ``False``.

.. opsmgrkube:: spec.backup.s3OpLogStores.irsaEnabled

   *Type*: boolean

   Flag that enables using |aws| :aws:`IAM roles for service accounts </eks/latest/userguide/iam-roles-for-service-accounts>`
   in |aws| :aws:`EKS </eks/latest/userguide/what-is-eks>` to configure
   an |s3| oplog store. The default is ``False``. If you aren't using
   |aws| EKS, this flag has no effect. When set to ``False``, using |aws|
   IAM roles for service accounts in EKS to configure an |s3| oplog store
   is disabled. To learn more, see
   :aws:`IAM roles for service accounts in EKS </eks/latest/userguide/iam-roles-for-service-accounts>`.

.. opsmgrkube:: spec.backup.s3OpLogStores.name

   *Type*: string

   *Required to store the oplog using an S3 store.*

   Name of the |s3| oplog store.

.. opsmgrkube:: spec.backup.s3OpLogStores.mongodbResourceRef.name

   *Type*: string

   Name of the MongoDB database resource that you create to store
   metadata for the |s3| oplog store. You must deploy this database
   resource in the same namespace as the |onprem| resource.

   .. note::

      Omit this setting to use the application database to store
      metadata for the |s3| oplog store.

      If you omit this setting, you must also omit the
      :opsmgrkube:`spec.backup.s3OpLogStores.mongodbUserRef.name` setting.
      The |k8s-op-short| handles ``SCRAM`` user authentication
      internally.

   If you enable ``SCRAM`` authentication on this database, you must:

   - Create a MongoDB user resource to connect |onprem| to the
     database.
   - Specify the
     :opsmgrkube:`~spec.backup.s3OpLogStores.mongodbUserRef.name` of the
     user in the |onprem| resource definition.

.. opsmgrkube:: spec.backup.s3OpLogStores.mongodbUserRef.name

   *Type*: string

   *Required if you created a MongoDB database resource to store
   S3 oplog metadata and SCRAM is enabled on this database.*

   Name of the MongoDB user resource used to connect to the metadata
   database of the |s3| oplog store. Deploy this user resource in the
   same namespace as the |onprem| resource and with all of the following roles:
   
   - :manual:`readWriteAnyDatabase
     </reference/built-in-roles/#readWriteAnyDatabase>`
   - :manual:`dbAdminAnyDatabase
     </reference/built-in-roles/#dbAdminAnyDatabase>`
   - :manual:`clusterMonitor
     </reference/built-in-roles/#mongodb-authrole-clusterMonitor>`

   .. important::

      Once specified, don't edit the name of the |s3| metadata oplog
      store username.

.. opsmgrkube:: spec.backup.s3OpLogStores.s3SecretRef.name

   *Type*: string

   *Required to store the oplog using an S3 store.*

   Name of the secret that contains the ``accessKey`` and
   ``secretKey`` fields. The :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>` uses
   the values of these fields as credentials to access your
   |aws| |s3| or |s3|-compatible bucket. To configure the |s3| oplog 
   store, you must specify both keys in the secret.

.. opsmgrkube:: spec.backup.s3OpLogStores.pathStyleAccessEnabled

   *Type*: boolean

   Indicates the style of the bucket endpoint URL.

   .. list-table::
      :widths: 30 30 30
      :header-rows: 1

      * - Value
        - Description
        - Example

      * - ``true``
        - Path-style URL
        - ``s3.amazonaws.com/<bucket>``

      * - ``false``
        - Virtual-host-style URL
        - ``<bucket>.s3.amazonaws.com``

   Default value is ``true``.

.. opsmgrkube:: spec.backup.s3OpLogStores.s3BucketEndpoint

   *Type*: string

   *Required to store the oplog using an S3 store.*

   URL of the |aws| |s3| bucket or |s3|-compatible bucket that hosts the
   oplog store.

   .. note::

      If your endpoint doesn't include a region in its |url|, 
      specify the :opsmgrkube:`s3RegionOverride <spec.backup.s3OpLogStores.s3RegionOverride>` 
      field.

.. opsmgrkube:: spec.backup.s3OpLogStores.s3BucketName

   *Type*: string

   *Required to store the oplog using an S3 store.*

   Name of the |aws| |s3| bucket or |s3|-compatible bucket that hosts
   the oplog store.

.. opsmgrkube:: spec.backup.s3OpLogStores.s3RegionOverride

   *Type*: string

   Region where your |s3|-compatible bucket resides. Use this 
   field only if your |s3| oplog store's
   :opsmgrkube:`s3BucketEndpoint <spec.backup.s3OpLogStores.s3BucketEndpoint>`
   doesn't support region scoping. Region scoping is when your endpoint doesn't include a region in its |url|.
   
   Don't use this field with |aws| |s3| buckets. For more information, see 
   :opsmgr:`S3 Blockstore Configuration </reference/api/admin/backup/snapshot/s3Configs/create-one-s3-blockstore-configuration/>`.

.. opsmgrkube:: spec.backup.s3Stores.assignmentLabels

   *Type*: array of strings

   A list of assignment labels for the |s3| or |s3|-compatible buckets
   where :opsmgr:`stores </tutorial/manage-s3-blockstore-storage>` the
   database backup snapshots. Use assignment labels to identify that
   specific |s3| stores are associated with particular projects.
   If you set assignment labels using the |k8s-op-short|, the values that
   you set in the |k8s| configuration file for assignment labels override
   the values defined in the |mms| UI. Assignment labels that you don't set
   using the |k8s-op-short| continue to use the values set in the |mms| UI.

.. opsmgrkube:: spec.backup.s3Stores.customCertificate

   *Type*: boolean

   Flag that indicates whether you use custom |tls| certificates for 
   your |s3| snapshot store specified by 
   :opsmgrkube:`spec.applicationDatabase.security.tls.ca`.
   The default is ``False``.

.. opsmgrkube:: spec.backup.s3Stores.irsaEnabled

   *Type*: boolean

   Flag that enables using |aws| :aws:`IAM roles for service accounts </eks/latest/userguide/iam-roles-for-service-accounts>`
   in |aws| :aws:`EKS </eks/latest/userguide/what-is-eks>` to configure
   an |s3| snapshot store. The default is ``False``. If you aren't using
   |aws| EKS, this flag has no effect. When set to ``False``, using |aws|
   IAM roles for service accounts in EKS to configure an |s3| snapshot
   store is disabled. To learn more, see
   :aws:`IAM roles for service accounts in EKS </eks/latest/userguide/iam-roles-for-service-accounts>`.

.. opsmgrkube:: spec.backup.s3Stores.name

   *Type*: string

   *Required to store the oplog using an S3 store.*

   Name of the |s3| snapshot store.

   .. important::

      Once specified, don't edit the name of the |s3| snapshot store. This change will likely fail if
      backups use the old name. The consequences of
      a successful change are unpredictable.

.. opsmgrkube:: spec.backup.s3Stores.mongodbResourceRef.name

   *Type*: string

   Name of the MongoDB database resource that you create to store
   metadata for the |s3| snapshot store. You must deploy this database
   resource in the same namespace as the |onprem| resource.

   .. note::

      Omit this setting to use the application database to store
      metadata for the |s3| snapshot store.

      If you omit this setting, you must also omit the
      :opsmgrkube:`spec.backup.s3Stores.mongodbUserRef.name` setting.
      The |k8s-op-short| handles ``SCRAM`` user authentication
      internally.

   If you enable ``SCRAM`` authentication on this database, you must:

   - Create a MongoDB user resource to connect |onprem| to the
     database.
   - Specify the
     :opsmgrkube:`~spec.backup.s3Stores.mongodbUserRef.name` of the
     user in the |onprem| resource definition.

   .. important::

      Once specified, don't edit the name of the |s3| snapshot store.
      This change will likely fail if backups use the old name. The
      consequences of a successful change are unpredictable.

   .. include:: /includes/admonitions/watch-backup-resources.rst

.. opsmgrkube:: spec.backup.s3Stores.mongodbUserRef.name

   *Type*: string

   *Required if you created a MongoDB database resource to store
   |s3| snapshot metadata and SCRAM is enabled on this database.*

   Name of the MongoDB user resource used to connect to the metadata
   database of the |s3| snapshot store. Deploy this user resource in the
   same namespace as the |onprem| resource and with all of the following roles:
   
   - :manual:`readWriteAnyDatabase
     </reference/built-in-roles/#readWriteAnyDatabase>`
   - :manual:`dbAdminAnyDatabase
     </reference/built-in-roles/#dbAdminAnyDatabase>`
   - :manual:`clusterMonitor
     </reference/built-in-roles/#mongodb-authrole-clusterMonitor>`

   .. important::

      Once specified, don't edit the name of the |s3| metadata snapshot
      store username.

.. opsmgrkube:: spec.backup.s3Stores.s3SecretRef.name

   *Type*: string

   *Required if you enable Backup using an S3 store.*

   Name of the secret that contains the ``accessKey`` and
   ``secretKey`` fields. The :opsmgr:`backup daemon service
   </current/core/system-overview/#backup-daemon-service>` uses
   the values of these fields as credentials to access your
   |aws| |s3| or |s3|-compatible bucket. The |s3| snapshot store
   can't be configured if the secret is missing either key.

.. opsmgrkube:: spec.backup.s3Stores.pathStyleAccessEnabled

   *Type*: boolean

   Indicates the style of the bucket endpoint URL.

   .. list-table::
      :widths: 30 30 30
      :header-rows: 1

      * - Value
        - Description
        - Example

      * - ``true``
        - Path-style URL
        - ``s3.amazonaws.com/<bucket>``

      * - ``false``
        - Virtual-host-style URL
        - ``<bucket>.s3.amazonaws.com``

   Default value is ``true``.

.. opsmgrkube:: spec.backup.s3Stores.s3BucketEndpoint

   *Type*: string

   *Required if you enable Backup using an S3 store.*

   URL of the |aws| |s3| bucket or |s3|-compatible bucket that hosts the
   snapshot store. 

   .. note::

      If your endpoint doesn't include a region in its |url|, 
      specify the :opsmgrkube:`s3RegionOverride <spec.backup.s3Stores.s3RegionOverride>` 
      field.

.. opsmgrkube:: spec.backup.s3Stores.s3BucketName

   *Type*: string

   *Required if you enable Backup using an S3 store.*

   Name of the |aws| |s3| bucket or |s3|-compatible bucket that hosts
   the snapshot store.

.. opsmgrkube:: spec.backup.s3Stores.s3RegionOverride

   *Type*: string

   Region where your |s3|-compatible bucket resides. Use this 
   field only if your |s3| store's 
   :opsmgrkube:`s3BucketEndpoint <spec.backup.s3Stores.s3BucketEndpoint>`
   doesn't support region scoping. Region scoping is when your endpoint doesn't include a region in its |url|.
   
   Don't use this field with |aws| |s3| buckets. For more information, see 
   :opsmgr:`S3 Blockstore Configuration </reference/api/admin/backup/snapshot/s3Configs/create-one-s3-blockstore-configuration/>`.
