=================
Manage Journaling
=================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

MongoDB uses *write ahead logging* to an on-disk :term:`journal` to
guarantee :doc:`write operation </crud>` durability.
The MMAPv1 storage engine also requires the `journal` in order to
provide crash resiliency.

The WiredTiger storage engine does not require journaling to guarantee
a consistent state after a crash. The database will be restored to the
last consistent :ref:`checkpoint <storage-wiredtiger-checkpoints>`
during recovery.  However, if MongoDB exits unexpectedly in between
checkpoints, journaling is required to recover writes that occurred
after the last checkpoint.

.. note::

  .. include:: /includes/wiredtiger-node-nojournal.rst

With journaling enabled, if :binary:`~bin.mongod` stops unexpectedly, the
program can recover everything written to the journal. MongoDB will
re-apply the write operations on restart and maintain a consistent
state. By default, the greatest extent of lost writes, i.e., those not
made to the journal, are those made in the last 100 milliseconds, plus
the time it takes to perform the actual journal writes. See
:setting:`~storage.journal.commitIntervalMs` for more information on
the default.

Procedures
----------

Disable Journaling
~~~~~~~~~~~~~~~~~~

.. warning::

  Do not disable journaling on production systems.

  - .. include:: /includes/wiredtiger-node-nojournal.rst

  - When using the MMAPv1 storage engine *without* a journal, if
    your :binary:`~bin.mongod` instance stops without shutting down
    cleanly unexpectedly for any reason, (e.g. power failure) and
    you are not running with journaling, then you must recover from
    an unaffected :term:`replica set` member or backup, as described
    in :doc:`repair
    </tutorial/recover-data-following-unexpected-shutdown>`.

To disable journaling, start :binary:`~bin.mongod` with the
:option:`--nojournal <mongod --nojournal>` command line option.

Get Commit Acknowledgement
~~~~~~~~~~~~~~~~~~~~~~~~~~

You can get commit acknowledgement with the :ref:`write-concern` and
the :writeconcern:`j` option. For details, see
:ref:`write-concern-operation`.


.. _journaling-avoid-preallocation-lag:

Avoid Preallocation Lag for MMAPv1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

With the :doc:`MMAPv1 storage engine </core/mmapv1>`, MongoDB may
preallocate journal files if the :binary:`~bin.mongod` process determines
that it is more efficient to preallocate journal files than create new
journal files as needed.

Depending on your filesystem, you might experience a preallocation lag
the first time you start a :binary:`~bin.mongod` instance with journaling
enabled. The amount of time required to pre-allocate files might last
several minutes; during this time, you will not be able to connect to
the database. This is a one-time preallocation and does not occur with
future invocations.

To avoid :ref:`preallocation lag <journaling-journal-files>`, you can
preallocate files in the journal directory by copying them from
another instance of :binary:`~bin.mongod`.

Preallocated files do not contain data. It is safe to later remove
them.  But if you restart :binary:`~bin.mongod` with journaling,
:binary:`~bin.mongod` will create them again.

.. example:: The following sequence preallocates journal files for an
  instance of :binary:`~bin.mongod` running on port ``27017`` with a
  database path of ``/data/db``.

  For demonstration purposes, the sequence starts by creating a set
  of journal files in the usual way.

  1. Create a temporary directory into which to create a set of
     journal files:

     .. code-block:: sh

        mkdir ~/tmpDbpath

  #. Create a set of journal files by starting a :binary:`~bin.mongod`
     instance that uses the temporary directory. For example:

     .. code-block:: sh

        mongod --port 10000 --dbpath ~/tmpDbpath --journal --bind_ip localhost,<hostname(s)|ip address(es)> --storageEngine mmapv1

     .. include:: /includes/tip-hostnames.rst

     .. include:: /includes/warning-bind-ip-security-considerations.rst

  #. When you see the following log output, indicating
     :binary:`~bin.mongod` has the files, press CONTROL+C to stop the
     :binary:`~bin.mongod` instance:

     .. code-block:: sh

        ... NETWORK  [initandlisten] waiting for connections on port 10000

  #. Preallocate journal files for the new instance of
     :binary:`~bin.mongod` by moving the journal files from the data
     directory of the existing instance to the data directory of the
     new instance:

     .. code-block:: sh

        mv ~/tmpDbpath/journal /data/db/

  #. Start the new :binary:`~bin.mongod` instance. For example:

     .. code-block:: sh

        mongod --port 27017 --dbpath /data/db --journal --bind_ip localhost,<hostname(s)|ip address(es)> --storageEngine mmapv1

     .. include:: /includes/tip-hostnames.rst
     
     .. include:: /includes/warning-bind-ip-security-considerations.rst

Monitor Journal Status
~~~~~~~~~~~~~~~~~~~~~~

The :dbcommand:`serverStatus` command/:method:`db.serverStatus()`
method returns :serverstatus:`wiredTiger.log`, which contains
statistics on the WiredTiger journal.

.. _journaling-journal-commit-interval:

Change the Group Commit Interval for MMAPv1
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For the :doc:`MMAPv1 storage engine </core/mmapv1>`, you can set the
group commit interval using the :option:`--journalCommitInterval
<mongod --journalCommitInterval>` command line option. The allowed
range is ``2`` to ``300`` milliseconds.

Lower values increase the durability of the journal at the expense of
disk performance.

Recover Data After Unexpected Shutdown
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

On a restart after a crash, MongoDB replays all journal files in the
journal directory before the server becomes available. If MongoDB must
replay journal files, :binary:`~bin.mongod` notes these events in the log
output.

There is no reason to run :dbcommand:`repairDatabase` in these
situations.

.. _manage-journaling-change-wt-journal-compressor:

Change WiredTiger Journal Compressor
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

With the WiredTiger storage engine, MongoDB, by default, uses the
``snappy`` compressor for the journal. To specify a different
compressions algorithm or no compression for a :binary:`~bin.mongod`
instance:

.. tip::

   If you encounter an unclean shutdown for a :binary:`~bin.mongod`
   during this procedure, you must use the old compressor settings to
   recover using the journal files. Once recovered, you can retry the
   procedure.

.. tabs::

   tabs:

      - id: standalone
        name: Standalone
        content: |

           Use the following procedure to change the journal compressor
           for a standalone :binary:`~bin.mongod` instance:

           #. Update the
              :setting:`storage.wiredTiger.engineConfig.journalCompressor` setting
              to the new value.

              If you use command-line options instead of a configuration file, you
              will have to update the :option:`--wiredTigerJournalCompressor
              <mongod --wiredTigerJournalCompressor>` command-line option during
              the restart below.

           #. Perform a clean shutdown of the :binary:`~bin.mongod`
              instance. For example, connect a :binary:`~bin.mongo`
              shell to the instance and issue
              :method:`db.shutdownServer()`:

              .. code-block:: javascript

                 db.getSiblingDB('admin').shutdownServer()


           #. Once you have confirmed that the process is no longer running,
              restart the :binary:`~bin.mongod` instance:

              - If you are using a configuration file:

                .. code-block:: sh

                   mongod -f <path/to/myconfig.conf>

              - If you are using command-line options instead of a configuration
                file, update the :option:`--wiredTigerJournalCompressor <mongod
                --wiredTigerJournalCompressor>` option.

                .. code-block:: sh

                   mongod --wiredTigerJournalCompressor <differentCompressor|none>  ...

      - id: replset
        name: "Replica Set Member"
        content: |

           Use the following procedure to change the journal compressor
           for a member of a replica set:

           .. note::

              The following procedure involves restarting the replica member as a
              standalone without the journal.

           #. Perform a clean shutdown of the :binary:`~bin.mongod`
              instance. For example, connect a :binary:`~bin.mongo`
              shell to the instance and issue
              :method:`db.shutdownServer()`:

              .. code-block:: javascript

                 db.getSiblingDB('admin').shutdownServer()

           #. Update the :doc:`configuration file
              </reference/configuration-options>` to prepare to restart as a
              standalone:

              - Set :setting:`storage.journal.enabled` to ``false``.

              - Comment out the :ref:`replication <replication-options>` settings
                for your deployment.

              - Set parameter ``disableLogicalSessionCacheRefresh`` to
                ``true`` in the :setting:`setParameter` section.

              For example:

              .. code-block:: none

                 storage:
                    journal:
                       enabled: false
                 #replication:
                 #   replSetName: replA
                 setParameter:
                    disableLogicalSessionCacheRefresh: true

              If you use command-line options instead of a configuration file, you
              will have to update the command-line option during the restart.

           #. Restart the :binary:`~bin.mongod` instance:

              - If you are using a configuration file:

                .. code-block:: sh

                   mongod -f <path/to/myconfig.conf>

              - If you are using command-line options instead of a
                configuration file, 
                
                - Include the :option:`--nojournal <mongod
                  --nojournal>` option
                
                - Remove any :ref:`replication command-line options
                  <cli-mongod-replica-set>` (such as :option:`--replSet
                  <mongod --replSet>`):

                - Set parameter ``disableLogicalSessionCacheRefresh``
                  to ``true`` in the :option:`--setParameter <mongod
                  --setParameter>` option.

                  .. code-block:: sh

                     mongod --nojournal --setParameter disableLogicalSessionCacheRefresh=true  ...

           #. Perform a clean shutdown of the :binary:`~bin.mongod` instance:

              .. code-block:: javascript

                 db.getSiblingDB('admin').shutdownServer()

              Confirm that the process is no longer running.

           #. Update the configuration file to prepare to restart as a replica set
              member with the new journal compressor:

              - Remove the :setting:`storage.journal.enabled` setting.

              - Uncomment the :ref:`replication <replication-options>`
                settings for your deployment.

              - Remove the ``disableLogicalSessionCacheRefresh``
                parameter.
         
              - Remove
                :setting:`storage.wiredTiger.engineConfig.journalCompressor` setting
                to use the default journal compressor or specify a  new value.


         
              For example:

              .. code-block:: none

                 storage:
                    wiredTiger:
                       engineConfig:
                          journalCompressor: <newValue>
                 replication:
                    replSetName: replA

              If you use command-line options instead of a configuration file, you
              will have to update the command-line options during the restart
              below.


           #. Restart the :binary:`~bin.mongod` instance as a replica set member:

              - If you are using a configuration file:

                .. code-block:: sh

                   mongod -f <path/to/myconfig.conf>

              - If you are using command-line options instead of a configuration
                file:

                - Remove the :option:`--nojournal <mongod --nojournal>` option.

                - Remove the :option:`--wiredTigerJournalCompressor <mongod
                  --wiredTigerJournalCompressor>` command-line option to use
                  the default journal compressor or update to a new value.

                - Include your :ref:`replication command-line options
                  <cli-mongod-replica-set>` as well as any additional
                  options for your replica set member.

                - Remove the ``disableLogicalSessionCacheRefresh``
                  parameter.

                .. code-block:: sh

                   mongod --wiredTigerJournalCompressor <differentCompressor|none> --replSet ...


      - id: shardedcluster
        name: "Sharded Cluster Member"
        content: |

           Use the following procedure to change the journal compressor
           for a member of a shard replica set or config server replica set:

           .. note::

              The following procedure involves restarting the replica member as a
              standalone without the journal.

           #. Perform a clean shutdown of the :binary:`~bin.mongod`
              instance. For example, connect a :binary:`~bin.mongo`
              shell to the instance and issue
              :method:`db.shutdownServer()`:

              .. code-block:: javascript

                 db.getSiblingDB('admin').shutdownServer()

           #. Update the :doc:`configuration file
              </reference/configuration-options>` to prepare to restart as a
              standalone:

              - Set :setting:`storage.journal.enabled` to ``false``.

              - Set parameter :parameter:`skipShardingConfigurationChecks` to true.

              - Set parameter ``disableLogicalSessionCacheRefresh`` to
                ``true`` in the :setting:`setParameter` section.

              - Comment out the :ref:`replication <replication-options>`
                settings for your deployment.

              - Comment out the :setting:`sharding.clusterRole` setting.

              - Set the :setting:`net.port` to the member's
                current port, if it is not explicitly set.

              For example:

              .. code-block:: none

                 storage:
                    journal:
                       enabled: false
                 setParameter:
                    skipShardingConfigurationChecks: true
                    disableLogicalSessionCacheRefresh: true
                 #replication:
                 #   replSetName: shardA
                 #sharding:
                 #   clusterRole: shardsvr
                 net:
                   port: 27218

              If you use command-line options instead of a configuration file, you
              will have to update the command-line option during the restart.

           #. Restart the :binary:`~bin.mongod` instance:

              - If you are using a configuration file:

                .. code-block:: sh

                   mongod -f <path/to/myconfig.conf>

              - If you are using command-line options instead of a
                configuration file:

                - Include the :option:`--nojournal <mongod --nojournal>`
                  option.

                - Set parameter :parameter:`skipShardingConfigurationChecks` to true.

                - Set parameter ``disableLogicalSessionCacheRefresh``
                  to ``true`` in the :option:`--setParameter <mongod
                  --setParameter>` option.

                - Remove any :ref:`replication command-line options
                  <cli-mongod-replica-set>` (such as :option:`--replSet
                  <mongod --replSet>`).

                - Remove :option:`--shardsvr <mongod
                  --shardsvr>`/:option:`--configsvr <mongod --configsvr>` option.

                - Explicitly include :option:`--port <mongod --port>` set to
                  the instance's current port.

                .. code-block:: sh

                   mongod --nojournal --setParameter skipShardingConfigurationChecks=true --setParameter disableLogicalSessionCacheRefresh=true --port <samePort> ...

           #. Perform a clean shutdown of the :binary:`~bin.mongod` instance:

              .. code-block:: javascript

                 db.getSiblingDB('admin').shutdownServer()

              Confirm that the process is no longer running.

           #. Update the configuration file to prepare to restart with the new journal compressor:

              - Remove the :setting:`storage.journal.enabled` setting.

              - Remove the :parameter:`skipShardingConfigurationChecks` parameter setting.

              - Remove the ``disableLogicalSessionCacheRefresh``
                parameter setting.
                  
              - Uncomment the :ref:`replication <replication-options>`
                settings for your deployment.

              - Uncomment the :setting:`sharding.clusterRole` setting.

              - Remove
                :setting:`storage.wiredTiger.engineConfig.journalCompressor` setting
                to use the default journal compressor or specify a  new value.

              For example:

              .. code-block:: none

                 storage:
                    wiredTiger:
                       engineConfig:
                          journalCompressor: <newValue>
                 replication:
                    replSetName: shardA
                 sharding:
                    clusterRole: shardsvr
                 net:
                   port: 27218

              If you use command-line options instead of a configuration file, you
              will have to update the command-line options during the restart
              below.


           #. Restart the :binary:`~bin.mongod` instance as a replica set member:

              - If you are using a configuration file:

                .. code-block:: sh

                   mongod -f <path/to/myconfig.conf>

              - If you are using command-line options instead of a configuration
                file:

                - Remove the :option:`--nojournal <mongod --nojournal>` option.

                - Remove the :parameter:`skipShardingConfigurationChecks` parameter setting.

                - Remove the ``disableLogicalSessionCacheRefresh``
                  parameter.
                
                - Remove the :option:`--wiredTigerJournalCompressor <mongod
                  --wiredTigerJournalCompressor>` command-line option to use
                  the default journal compressor or update to a new value.

                - Include :option:`--shardsvr <mongod
                  --shardsvr>`/:option:`--configsvr <mongod --configsvr>` option.

                - Include your :ref:`replication command-line options
                  <cli-mongod-replica-set>` as well as any additional
                  options for your replica set member.

                .. code-block:: sh

                   mongod --shardsvr --wiredTigerJournalCompressor <differentCompressor|none> --replSet ...
