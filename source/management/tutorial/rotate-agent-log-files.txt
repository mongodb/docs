======================
Rotate Agent Log Files
======================

.. default-domain:: mms

.. contents::
   :backlinks: none
   :local:

Overview
--------

During normal operation, the monitoring agent and backup agent report a live
account of all activity and operations to a log file. When a log file reaches a
user-specified limit, the file must be replaced or rotated.

On Linux based systems, :program:`logrotate` software automatically copies,
renames, compresses, and removes older archived log files.

For programs that cannot be told to close its log file, the
:program:`copytruncate` command is available to adapt the log rotation process.
This command also allows rotating log files without restarting the backup and
monitoring agents.

Log Rotation With :program:`logrotate`
--------------------------------------

:program:`logrotate` is installed on most Linux systems. Check the
``logrotate.conf`` configuration file exists in the ``/etc`` folder or install
the :program:`logrotate` package.

The behavior of the :program:`logrotate` command is set in the
``logrotate.conf`` configuration file. Open this file then add entries and
directives for the monitoring and backup agent log files.

The ``logrotate.conf`` file includes a set of directives in a structured
format, for example:

.. code-block:: javascript

   #sample configuration file
   compress
      
   <backup agent log file location> {
       size 10M
       copytruncate
   }

   <monitoring agent log file location> {
       size 10M
       copytruncate
   }

In this example, the configuration directives include:

- **compress**: sets a global option to compress log files after each file is
  rotated. This directive can be placed within each entry if compression is
  needed for one agent log file but not another.

- **<backup agent log file location>** or **<monitoring agent log file
  location>**: sets commands specific to the backup agent or monitoring agent
  log file. The names and locations of backup and monitoring agent log files
  are set when the agents are installed. The default log file path location is
  ``/log/mms-agent/*log``

- **size 10M**: rotates the log file once it exceeds 10 megabytes in size.
  
- **copytruncate**: rotates the log file without shutting down the agent
  software. This directive copies the contents of the current log file to a new
  archive file then deletes the contents of the current log file. New log
  activity is added to the now empty current log file. The directive can be
  used to rotate logs file without restarting the backup and monitoring agents.
    
  When :program:`copytruncate` is used, the :program:`create` command option
  has no effect because the old log file stays in place. There also is a very
  small time window between copying the log file and emptying it. Some logging
  data may be lost with this method.
  
In this example, the entries and directives in the ``logrotate.conf``
configuration file will rotate the backup agent log file and monitoring agent
log file once they exceed 10MB in size and compress the old file using gzip
(default). The copytruncate option ensures the MMS agents do not have to
be restarted for ``logrotate`` to complete rotation of log files.

In this example, **compress** is a global configuration directive and **size
10M** and **copytruncate** are local directives. Configuration directives have
either a global scope or local scope. Global directives are placed at the top
of the ``logrotate.conf`` file and apply to all log files defined within the
file. Local directives appear only in a specific log file definition in the
``logrotate.conf`` file. Local configuration directives have no effect on other
log files.

If logs must be rotated ``daily`` or ``weekly`` or ``monthly``, then these
directives should be added above and the ``size`` directive removed. Size does
not work in conjunction with frequency.

.. seealso:: 
   
   - `logrotate Man Page <http://linuxcommand.org/man_pages/logrotate8.html>`_.

   - `Install the MMS Monitoring Agent
     <https://mms.mongodb.com/help/monitoring/tutorial/set-up-mms/>`_.
     
   - `Install and Start the MMS Backup Agent
     <https://mms.mongodb.com/help/backup/tutorial/install-and-start-backup-agent/>`_.

