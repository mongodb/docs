.. _performance-advisor:
.. _pa-slow-queries:

================================
Monitor and Improve Slow Queries
================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

*Only available on M10+ clusters and {+serverless-instances+}*

The Performance Advisor monitors queries that MongoDB considers slow and
suggests new indexes to improve query performance. The threshold for
slow queries varies based on the average time of operations on your
cluster to provide recommendations pertinent to your workload.

Recommended indexes are accompanied by sample queries, grouped by
:term:`query shape`, that were run against a collection that would
benefit from the suggested index. The Performance Advisor does not
negatively affect the performance of your |service| clusters.

Common Reasons for Slow Queries
-------------------------------

If a query is slow, common reasons include:

- The query is unsupported by your current indexes. 
- Some documents in your collection have large array fields that are 
  costly to search and index.
- One query retrieves information from multiple collections with 
  :manual:`$lookup </reference/operator/aggregation/lookup>`.

.. note::

   By default, |service| dynamically adjusts your slow query threshold
   based on the execution time of operations across your cluster. To
   opt out of this feature and instead use a fixed slow query
   threshold of 100 milliseconds, you must use the |service| |api|.
   See :ref:`api-managed-slowms-disable`. For 
   ``M0``, ``M2``, ``M5`` clusters and {+serverless-instances+}, 
   |service| disables the |service|-managed slow query operation 
   threshold by default and you can't enable it.

Index Considerations
--------------------

Indexes improve read performance, but a large number of indexes can
negatively impact write performance since indexes must be updated during
writes. If your collection already has several indexes, consider this 
tradeoff of read and write performance when deciding whether to create 
new indexes. Examine whether a query for such a collection can be 
modified to take advantage of existing indexes, as well as whether a 
query occurs often enough to justify the cost of a new index.

Access Performance Advisor
--------------------------

To access the :guilabel:`Performance Advisor`:

.. tabs::

   .. tab:: M10+ Clusters
      :tabid: m10-clusters

      .. include:: /includes/steps/performance-advisor-view.rst

   .. tab:: Serverless Instances
      :tabid: serverless-instances

      .. include:: /includes/steps/performance-advisor-view-sl.rst

The :guilabel:`Performance Advisor` displays up to 20 query shapes
across all collections in the cluster and suggested indexes for those
shapes. The indexes are ranked according to their :guilabel:`Impact`
score, which estimates the improvement in total operational latency
across the cluster that creating the index would cause. For
more information on index ranking, see :ref:`pa-index-ranking`.

.. note::

   To view field values in a sample query in the :guilabel:`Performance
   Advisor`, you must be a user with at least one of the following
   access levels:

   - :authrole:`Project Owner` access

   - :authrole:`Project Data Access Admin` access

   Users without the aforementioned access cannot see the field values.

.. _query-inefficiency-score:

Index Suggestions
-----------------

The indexes suggested by the Performance Advisor are ordered by their
respective :guilabel:`Impact` scores. :guilabel:`Impact` indicates the
estimated performance improvement that the suggested index would bring.
For more information on how the Performance Advisor ranks indexes, see
:ref:`pa-index-ranking`.

The |pa| displays a warning icon next to any index with an
:guilabel:`Impact` score of 5% or greater, indicating indexes with the
most potential to improve cluster performance.

To learn how to create indexes suggested by the Performance
Advisor, see :ref:`pa-create-suggested-indexes`.

Index Metrics
~~~~~~~~~~~~~

Each index suggested by the Performance Advisor contains the following
metrics. These metrics apply specifically to queries which would be
improved by the index:

.. list-table::
   :header-rows: 1
   :widths: 20 40

   * - Metric
     - Description

   * - :guilabel:`Execution Count`
     - Number of queries executed per hour which would be
       improved.

   * - :guilabel:`Average Execution Time`
     - Current average execution time in milliseconds for affected
       queries.

   * - :guilabel:`Average Query Targeting`
     - Average number of documents read per document returned by
       affected queries. A higher query
       targeting score indicates a greater degree of inefficiency. For
       more information on query targeting, see :ref:`query-targeting`.

   * - :guilabel:`In Memory Sort`
     - Current number of affected queries per hour that needed to be
       sorted in memory.

Sample Queries
~~~~~~~~~~~~~~

For each suggested index, the Performance Advisor shows the most
commonly executed query shapes which would be improved by index. For
each query shape, the Performance Advisor displays the following
metrics:

.. list-table::
   :header-rows: 1
   :widths: 20 40

   * - Metric
     - Description

   * - :guilabel:`Execution Count`
     - Number of queries executed per hour which match the query
       shape.

   * - :guilabel:`Average Execution Time`
     - Average execution time in milliseconds for queries
       which match the query shape.

   * - :guilabel:`Average Query Targeting`
     - Average number of documents read for
       every document returned by matching queries. A higher query
       targeting score indicates a greater degree of inefficiency. For
       more information on query targeting, see :ref:`query-targeting`.

The Performance Advisor also shows individual sample queries executed
which match the query shape, with specific metrics for that query.

.. _query-targeting:

Query Targeting
~~~~~~~~~~~~~~~

Each index suggestion includes an :guilabel:`Average Query Targeting`
score indicating how many documents were read for every document
returned for the index's corresponding query shapes. A score of 1
represents very efficient query shapes because every document read
matched the query and was returned with the query results. All suggested
indexes represent an opportunity to improve query performance.

Filter Index Suggestions
~~~~~~~~~~~~~~~~~~~~~~~~

By default, the Performance Advisor suggests indexes for all clusters
in the deployment. To only show suggested indexes from a specific
collection, use the :guilabel:`Collection` dropdown at the top of
the Performance Advisor.

You can also adjust the time range the Performance Advisor takes into
account when suggesting indexes by using the :guilabel:`Time Range`
dropdown at the top of the Performance Advisor.

Limitations of Index Suggestions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Timestamp Format
````````````````

The Performance Advisor cannot suggest indexes for MongoDB databases
configured to use the ``ctime`` timestamp format. As a workaround, set
the timestamp format for such databases to either ``iso8601-utc`` or
``iso8601-local``. To learn more about timestamp formats, see
:manual:`mongod --timeStampFormat </reference/program/mongod/#std-option-mongod.--timeStampFormat>`.

Log Size
````````

The Performance Advisor analyzes up to 200,000 of your cluster's most
recent log lines.


Log Quantity
````````````

.. include:: /includes/log-rate-limiting.rst

Time-Series Collections
```````````````````````

Performance Advisor doesn't provide performance suggestions for
time-series collections.

User Feedback
`````````````

The Performance Advisor includes a user feedback button for Index 
Suggestions. |service| hides this button for {+serverless-instances+}.

.. _pa-create-suggested-indexes:

Create Suggested Indexes
------------------------

You can create :manual:`indexes </core/indexes>` suggested by the
Performance Advisor directly within the Performance Advisor itself.
When you create indexes, keep the ratio of reads to writes on the
target collection in mind. Indexes come with a performance cost, but
are more than worth the cost for frequent queries on large data sets.
To learn more about indexing strategies, see
:manual:`Indexing Strategies </applications/indexes/>`.

Behavior and Limitations
~~~~~~~~~~~~~~~~~~~~~~~~

- You cannot create indexes through the Performance Advisor if
  :ref:`Data Explorer <data-explorer>` is disabled for your project. You
  can still view Performance Advisor recommendations, but you must
  create those indexes from {+mongosh+}.

- You can only create one index at a time through the Performance
  Advisor. If you want to create more simultaneously, you can do so
  using :ref:`Data Explorer <data-explorer-indexes>`, a
  :doc:`driver </driver-connection>`, or the
  :ref:`shell <connect-mongo-shell>`

- Indexes created in the Performance Advisor are always created at
  the top level of the deployment. If you create an index while viewing
  the Performance Advisor for a single shard in a sharded cluster,
  |service| creates that index for the whole sharded cluster.

Procedure
~~~~~~~~~

To create a suggested index:

.. include:: /includes/steps/pa-create-index.rst

.. toctree::
   :hidden:
   :titlesonly:

   /performance-advisor/index-ranking
   /performance-advisor/drop-indexes
   /performance-advisor/enable-disable
