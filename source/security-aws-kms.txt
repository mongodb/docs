.. _security-aws-kms:

=================================
Manage Customer Keys with AWS KMS
=================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-aws-kms-role-auth.rst

.. include:: /includes/serverless-preview-dont-use.rst

You can configure your |service| project to use an |aws| `IAM role 
<https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html>`__ 
for accessing your |aws| KMS keys for encryption at rest. You can 
either use an existing role or create a new role when you enable 
encryption at rest for your project.

This page covers configuring customer key management on your |service| 
project for role-based access.

If you have not yet enabled encryption at rest for your new or existing 
|service| project, follow the :ref:`aws-kms-enable-project` procedure 
to enable encryption at rest for your |service| project. If you have an 
|service| project for which you have already enabled encryption at rest 
and configured credentials-based access to your encryption keys, follow 
the :ref:`aws-kms-switch-project` procedure to switch to role-based 
access to your encryption keys.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

.. seealso:: 

   - :ref:`set-up-unified-aws-access`

Enable Customer-Managed Keys with AWS KMS
-----------------------------------------

.. _aws-ksm-prereqs:
.. _security-aws-kms-restrictions:

Prerequisites
~~~~~~~~~~~~~

To enable customer-managed keys with |aws| |kms| for a MongoDB
project, you must:

.. include:: /includes/fact-aws-kms-prereqs.rst

.. _aws-kms-enable-project:

Enable Role-Based Access to Your Encryption Key for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: UI
      :tabid: ui

      .. include:: /includes/steps/enable-rba-encryption-for-project.rst

   .. tab:: API
      :tabid: api
   
      .. include:: /includes/steps/enable-rba-encryption-api.rst

.. _aws-kms-switch-project:

Switch to Role-Based Access to Your Encryption Key for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. important:: 

   If you switch your |service| project from credentials-based access 
   to role-based access to your encryption keys, you cannot undo the 
   role-based access configuration and revert to credentials-based 
   access for that project.

.. tabs::

   .. tab:: UI
      :tabid: ui

      .. include:: /includes/steps/migrate-rba-encryption-for-project.rst

   .. tab:: API
      :tabid: api
   
      To update your encryption key management with the 
      {+atlas-admin-api+}, use the same steps outlined in the 
      :ref:`above procedure <aws-kms-enable-project>`.

.. _aws-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you :ref:`aws-kms-enable-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:ref:`Manage your own encryption keys 
<create-cluster-enable-encryption>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

.. _security-aws-kms-rotate-key:

Rotate your AWS Customer Master Key
-----------------------------------

.. meta::
   :keywords: encryption

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

.. include:: /includes/fact-atlas-key-rotation.rst

|service| does *not* automatically rotate the |aws| customer master key
(CMK) used for |aws|\-provided Encryption at Rest.

|service| automatically creates an
:alert:`alert <AWS encryption key elapsed time since last rotation is above (n) days>`
to remind you to rotate your |cmk| every 90 days by default when you
:ref:`enable Encryption at Rest <security-aws-kms>` for |a-service|
project.

|aws| |kms| supports
:aws:`automatic CMK rotation </kms/latest/developerguide/rotate-keys.html>`.
|aws| automatic |cmk| rotation does not require you to update the
|service| Encryption at Rest project settings, including the |cmk| ID.

This page explains how to create a new key and update the |cmk| ID in
|service| to rotate your |service| project |cmk|. This method of key
rotation supports more granular control of the rotation period compared
to |aws| |kms| automatic |cmk| rotation.

.. important:: {+Cloud-Backup+}s with Encryption at Rest

   For clusters using :doc:`Encryption at Rest </security-aws-kms>` and
   :ref:`backup-cloud-provider`, |service| uses the project's |cmk| and
   |aws| |iam| user credentials at the time of the snapshot to
   automatically encrypt the snapshot data files. This is an additional
   layer of encryption on the existing encryption applied to all
   |service| storage and snapshot volumes.

   |service| does *not* re-encrypt snapshots with the new |cmk| after
   rotation. Do *not* delete the old |cmk| until you check *every*
   backup-enabled cluster in the project for any snapshots still using
   that |cmk|. |service| deletes backups in accordance to the
   :ref:`cloud-provider-retention-policy`. After |service| deletes all
   snapshots depending on a given |cmk|, you can delete that |cmk|
   safely.

Procedure
~~~~~~~~~

.. include:: /includes/steps/rotate-aws-kms-cmk.rst

Related Topics
--------------

- To learn more about MongoDB Encryption at Rest, see
  :manual:`Encryption at Rest </core/security-encryption-at-rest/>` in
  the MongoDB server documentation.

- To learn more about Encryption at Rest with {+Cloud-Backup+}s, see 
  :ref:`encrypted-cloud-provider-snapshot`.
