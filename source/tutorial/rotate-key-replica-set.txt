============================
Rotate Keys for Replica Sets
============================

.. default-domain:: mongodb



Replica set members can use :ref:`keyfiles <internal-auth-keyfile>` to
authenticate each other as memers of the same deployment.

Starting in version 4.2, a :ref:`keyfile <internal-auth-keyfile>` can
contain multiple keys and membership authentication is established if
at least one key is common across members. This allows for rolling
upgrade of the keys without downtime.

The following tutorial steps through the process to update the key for
a replica set without downtime. [#exclude-encryption-keyfile]_ 

.. warning::

   The example keys in this tutorial are for illustrative purposes
   only. Do :red:`NOT` use for your deployment. Instead, generate a
   keyfile using any method you choose (for example, ``openssl rand -base64
   756``, etc.).

Consider a replica set where each member's keyfile contains the
following key:

.. figure:: /images/example-key1.png
   :alt: Image of current key to replace.
   :figwidth: 568px

The following procedure updates the replica set members to use a new
key:

.. figure:: /images/example-key2.png
   :alt: Image of new key.
   :figwidth: 568px

.. [#exclude-encryption-keyfile]

   This tutorial is not applicable to the :ref:`keyfile
   <encrypt-local-key-mgmt>` used for the :doc:`MongoDB's encrypted
   storage engine </core/security-encryption-at-rest>` local key
   management. That :ref:`keyfile <encrypt-local-key-mgmt>` can only
   contain a single key.

Procedure
---------

1. Modify the Keyfile to Include Old and New Keys
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Modify each member's keyfile to include both the old and new keys. You
can specify multiple keys either as strings enclosed in quotes or as a
sequence of keys.

.. warning::

   The example keys in this tutorial are for illustrative purposes
   only. Do :red:`NOT` use for your deployment. Instead, generate a
   keyfile using any method you choose (e.g. ``openssl rand -base64
   756``, etc.).

.. tabs::

   tabs:

      - id: multiple-key-strings
        name: Multiple Key Strings
        content: |

           You can specify multiple key strings where each key
           string is **enclosed in quotes**.

           .. figure:: /images/example-multiple-keys1.png
              :alt: Image of multiple key strings.
              :figwidth: 600px

      - id: multiple-key-sequence
        name: Multiple Key Sequence
        content: |

           You can specify multiple key strings as a sequence of key
           strings (optionally enclosed in quotes).

           .. figure:: /images/example-multiple-keys2.png
              :alt: Image of multiple key string sequence.
              :figwidth: 600px

2. Restart Each Member
~~~~~~~~~~~~~~~~~~~~~~

Once all the keyfiles contain both the old and new keys, restart each
member one at a time.

**For each secondary member**, connect a :binary:`~bin.mongo` shell to the
member and:

a. Use the :method:`db.shutdownServer()` method to shut down the member:

   .. code-block:: javascript

         use admin
         db.shutdownServer()

b.   Restart the member.

**For the primary**, connect a :binary:`~bin.mongo` shell to the member and

a. Use :method:`rs.stepDown()` to step down the member:

   .. code-block:: javascript

      rs.stepDown()


#. Use the :method:`db.shutdownServer()` method to shut down the member:

   .. code-block:: javascript

      use admin
      db.shutdownServer()

#. Restart the member.

Since the keyfiles contains both the old and new keys, all members can
now accept either keys for membership authentication.

3. Update Keyfile Content to the New Key Only
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. warning::

   The example keys in this tutorial are for illustrative purposes
   only. Do :red:`NOT` use for your deployment. Instead, generate a
   keyfile using any method you choose (e.g. ``openssl rand -base64
   756``, etc.).

Modify each member's keyfile to include only the new password.

.. figure:: /images/example-key2.png
   :alt: Image of new key.
   :figwidth: 558px


4. Restart Each Member
~~~~~~~~~~~~~~~~~~~~~~

Once all the keyfiles contain the new key only, restart each member one
at a time.

**For each secondary member**, connect a :binary:`~bin.mongo` shell to the
member and:

a. Use the :method:`db.shutdownServer()` method to shut down the member:

   .. code-block:: javascript

      use admin
      db.shutdownServer()

b.   Restart the member.

**For the primary**, connect a :binary:`~bin.mongo` shell to the member and

a. Use :method:`rs.stepDown()` to step down the member:

   .. code-block:: javascript

      rs.stepDown()


#. Use the :method:`db.shutdownServer()` method to shut down the member:

   .. code-block:: javascript

      use admin
      db.shutdownServer()

#. Restart the member.

All members now accept only the new key for membership authentication.
