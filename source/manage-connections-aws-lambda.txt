.. _atlas-lambda-connections:

==================================
Manage Connections with AWS Lambda
==================================

.. default-domain:: mongodb

.. meta::
   :keywords: lambda connection

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. tabs-selector:: drivers

.. _lambda-aws-best-practices:

Best Practices
~~~~~~~~~~~~~~

Use the following best practices to properly manage connections
between :aws:`AWS Lambda </lambda/latest/dg/welcome.html>`
and |service|:

- Define the client to the MongoDB server outside
  the :aws:`AWS Lambda handler function </lambda/latest/dg/nodejs-prog-model-handler.html>`.

  Don't define a new MongoClient object each time you invoke your
  function. Doing so causes the driver to create a new database
  connection with each function call. This can be expensive and
  can result in your application exceeding database connection limits.
  As an alternative, do the following:

  1. Create the MongoClient object once.
  2. Store the object so your function can reuse the MongoClient across
     function invocations.

  The :ref:`Connection Example <lambda-aws-example>` reuses existing
  database connections to speed up communication with the database and
  keep connection counts to the database at a reasonable level with
  respect to application traffic.

.. tabs-drivers::

   .. tab::
      :tabid: csharp

   .. tab::
      :tabid: java-sync
   
   .. tab::
      :tabid: nodejs

      - If your handler takes a callback as its last argument, set the
        ``callbackWaitsForEmptyEventLoop`` property on the
        :aws:`AWS Lambda Context </lambda/latest/dg/nodejs-context.html#nodejs-prog-model-context-properties>`
        object to **false**.

        .. code-block:: js

           context.callbackWaitsForEmptyEventLoop = false;

        This allows a Lambda function to return its result to the caller
        without requiring that the MongoDB database connection be closed.
        Setting this property is not applicable for `async handlers
        <https://docs.aws.amazon.com/lambda/latest/dg/nodejs-handler.html>`__.
   
   .. tab::
      :tabid: python

   .. tab::
      :tabid: ruby

- Restrict network access to your |service| cluster.
  
  Connect to your |service| cluster over private networking using a
  :doc:`Network Peering connection </security-vpc-peering>` 
  between your |service| cluster and your |aws| Lambda function, or,
  alternatively, a :doc:`private endpoint </security-private-endpoint/>`,
  so that you can allow only private IP addresses to your
  :doc:`IP access list </security/ip-access-list/>`.

  If private networking is not an option, consider connecting to your
  |service| cluster via a `NAT gateway <https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html>`__
  with a mapped Elastic IP address. Otherwise, you must
  allow all IP addresses (0.0.0.0/0) to access your service cluster.

  .. warning::

     Adding ``0.0.0.0/0`` to your :doc:`IP access list </security/ip-access-list/>`
     allows cluster access from anywhere in the public internet.
     Ensure that you're using strong credentials for all database
     users when allowing access from anywhere.

- :doc:`/security/set-up-unified-aws-access` and use |aws| IAM authentication where possible.

  You can connect to your |service| {+clusters+} using |aws| `IAM roles <https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html>`__
  instead of hardcoding your credentials in Lambda. Hardcoded credentials are
  viewable by anyone who accesses your AWS Lambda environment, which can pose
  a security risk. With |aws| IAM authentication, |service| accesses |aws| Lambda
  through an `assumed IAM role <https://docs.aws.amazon.com/IAM/latest/UserGuide/using-service-linked-roles.html>`__,
  so you don't need credentials in your connection strings.
  
  |service| supports |aws| IAM authentication for {+clusters+} running
  MongoDB version 4.4 or higher. We strongly advise using |aws| IAM
  authentication for Lambda connections if your {+cluster+} meets the
  requirements.

.. _lambda-aws-example:

Connection Example
~~~~~~~~~~~~~~~~~~

.. tabs-drivers::

   .. tab::
      :tabid: csharp

      |aws| IAM Authentication
      ````````````````````````
      
      .. literalinclude:: /includes/drivers-examples/AwsLambdaExamples.cs 
         :start-after: // Start AWS Lambda Example 2
         :end-before: // End AWS Lambda Example 2
         :language: csharp
         :copyable:
         :dedent:

      Other Authentication
      ````````````````````

      .. literalinclude:: /includes/drivers-examples/AwsLambdaExamples.cs 
         :start-after: // Start AWS Lambda Example 1
         :end-before: // End AWS Lambda Example 1
         :language: csharp
         :copyable:
         :dedent:

   .. tab::
      :tabid: java-sync

      .. literalinclude:: /includes/drivers-examples/ExampleAwsLambdaHandler.java
         :start-after: // Start AWS Lambda Example 1
         :end-before: // End AWS Lambda Example 1
         :language: java
         :copyable:
         :dedent:

   .. tab::
      :tabid: nodejs

      |aws| IAM Authentication
      ````````````````````````
      .. literalinclude:: /includes/drivers-examples/aws_handler.js
         :start-after: // begin lambda connection
         :end-before: // end lambda connection
         :language: js
         :copyable:
         :dedent:

      Other Authentication
      ````````````````````

      .. literalinclude:: /includes/drivers-examples/handler.js
         :start-after: // begin lambda connection
         :end-before: // end lambda connection
         :language: js
         :copyable:
         :dedent:

   .. tab::
      :tabid: python

      .. literalinclude:: /includes/drivers-examples/test_auth_aws.py
         :start-after: # Start AWS Lambda Example 1
         :end-before: # End AWS Lambda Example 1
         :language: python
         :copyable:
         :dedent:

   .. tab::
      :tabid: ruby

      |aws| IAM Authentication
      ````````````````````````

      .. literalinclude:: /includes/drivers-examples/aws_lambda_examples_spec.rb
         :start-after: # Start AWS Lambda Example 2
         :end-before: # End AWS Lambda Example 2
         :language: ruby
         :copyable:
         :dedent:

      Other Authentication
      ````````````````````

      .. literalinclude:: /includes/drivers-examples/aws_lambda_examples_spec.rb
         :start-after: # Start AWS Lambda Example 1
         :end-before: # End AWS Lambda Example 1
         :language: ruby
         :copyable:
         :dedent:

.. MM - 10/5/22 - The following drivers aren't yet released in a release tag

..   .. tab::
      :tabid: rust

..      AWS IAM Authentication
      ````````````````````````

..      .. literalinclude:: /drivers-examples/auth.rs
         :start-after: // begin lambda connection example 2
         :end-before: // end lambda connection example 2
         :language: rust
         :copyable:
         :dedent:

..      Other Authentication
      ```````````````````````

..      .. literalinclude:: /drivers-examples/no_auth.rs
         :start-after: // begin lambda connection example 1
         :end-before: // end lambda connection example 1
         :language: rust
         :copyable:
         :dedent:

..   .. tab::
      :tabid: swift-sync

..      .. literalinclude:: /drivers-examples/MongoHandler.swift
         :start-after: // begin lambda connection example 1
         :end-before: // end lambda connection example 1
         :language: swift
         :copyable:
         :dedent:

