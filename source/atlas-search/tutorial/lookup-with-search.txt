.. facet::
   :name: programming_language
   :values: csharp, go, java, javascript/typescript, kotlin, python, shell

.. _lookup-with-search-tutorial:

======================================================
How to Run ``$lookup`` with an |fts| ``$search`` Query
======================================================

.. default-domain:: mongodb

.. meta::
   :keywords: join at query time for search, join and search, foreign field, local field, queries on multiple collections, queries across collections, code example, java sync, compass, node.js
   :description: Learn how to join multiple collections in the same database at query-time with the $lookup aggregation pipeline stage and run an Atlas search query.


.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Starting in v6.0, the MongoDB :pipeline:`$lookup` aggregation stage 
supports :pipeline:`$search` inside the :pipeline:`$lookup` 
``pipeline`` option. Using :pipeline:`$lookup`, you can join 
multiple collections in the same database at query-time and run a 
:pipeline:`$search` query to further narrow down your search.

.. note:: 

   :pipeline:`$lookup` queries are not very performant because |fts| 
   does a full document lookup on the database for each document in the 
   collection. To learn more, see 
   :ref:`embedded-documents-arrays-anti-pattern`.

This tutorial demonstrates how to run a :pipeline:`$lookup` query 
with :pipeline:`$search` against the ``accounts`` and ``customers`` 
collections in the ``sample_analytics`` database. It takes you through 
the following steps:

1. Set up an |fts| index with dynamic mapping for the ``accounts`` 
   collection in the ``sample_analytics`` database.
#. Run :pipeline:`$lookup` query with :pipeline:`$search` to find 
   customers from the ``customers`` collections whose accounts have 
   purchased both ``CurrencyService`` and ``InvestmentStock`` products 
   in the ``accounts`` collection.

Before you begin, ensure that your |service| cluster meets the 
requirements described in the :ref:`fts-tutorials-prereqs`.

.. note:: 

   To run :pipeline:`$lookup` query with :pipeline:`$search`, your 
   cluster must run MongoDB v6.0 or later. If not, |fts| displays the 
   following error message:

   .. code-block::

      $_internalSearchMongotRemote is not allowed within a $lookup's sub-pipeline.

   To learn more, see :ref:`upgrade-major-MongoDB-version`.

.. include:: /includes/atlas-roles/create-search-index.rst

Create the |fts| Index
----------------------

Create an |fts| index named ``lookup-with-search-tutorial`` on all the
fields in the ``sample_analytics.accounts`` collection. 

.. |search-type| replace:: :guilabel:`Atlas Search`
.. |index-name| replace:: ``lookup-with-search-tutorial``
.. |database-name| replace:: ``sample_analytics`` database 
.. |collection-name| replace:: ``accounts`` collection

.. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-create-index.txt

Run ``$lookup`` with ``$search`` to Search the Collections 
----------------------------------------------------------

----------

.. |arrow| unicode:: U+27A4

|arrow| Use the **Select your language** drop-down menu on this page to 
set the language of the examples in this section.

----------

.. tabs-selector:: drivers

Connect to your |service| cluster and run the sample query against the
indexed collections in the ``sample_analytics`` database. 

.. tabs-drivers::

   .. tab::
      :tabid: shell

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query.txt

   .. tab::
      :tabid: compass

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-compass.txt

   .. tab::
      :tabid: csharp

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-cs.txt

   .. tab:: 
      :tabid: go

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-go.txt

   .. tab:: 
      :tabid: java-sync 

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-java.txt 

   .. tab:: 
      :tabid: kotlin-coroutine

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-kotlin.txt

   .. tab::
      :tabid: nodejs

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-nodejs.txt

   .. tab::
      :tabid: python

      .. include:: /includes/fts/lookup-with-search/procedures/steps-fts-lookup-tutorial-run-query-python.txt 
