.. _deploy-rs-for-mongot:

===========================================================
Deploy a Replica Set with Keyfile Authentication for mongot 
===========================================================

.. facet::
   :name: genre
   :values: tutorial

About this Task
---------------

This procedure guides you through setting up a ``mongod`` locally
in order to complete the :ref:`community-search-deploy` Tarball
installation tutorial.

.. note::

   If you already have a replica set with keyfile authentication set 
   up, you can skip this procedure. 

Steps
-----

.. procedure::
   :style: normal

   .. step:: Create your keyfile.

      .. _create-your-keyfile:

      .. include:: /includes/extracts/keyfile-intro-replica-set.rst

      .. code-block:: shell

         openssl rand -base64 756 > <path/to/keyfile>
         chmod 400 <path/to/keyfile>

      See :ref:`internal-auth-keyfile` for additional details  and requirements
      for using keyfiles.

   .. step:: Copy the keyfile.

      Copy the keyfile to each server hosting the replica set members. 
      Ensure that the user running the ``mongod`` instances is the owner 
      of the file and can access the keyfile.

      Avoid storing the keyfile on storage mediums that can be easily 
      disconnected from the hardware that hosts the ``mongod`` instances, such 
      as a USB drive or a network attached storage device.

   .. step:: Create your mongod configuration file.

      .. _create-mongod-config:
  
      To create your configuration file, save the following code to ``mongod.conf`` 
      or your preferred location.

      .. include:: /includes/search-in-community/sample-mongod-conf-tarball.rst
      
   .. step:: Start your replica set without authentication.

      .. _start-repset-no-auth:

      To start the ``mongod``, run the following command, specifying the configuration file
      you created above:

      .. code-block:: shell

         ./mongod --config mongod.conf

   .. step:: Connect to the primary node.

      Use ``mongosh`` to connect to the primary node with this command:

      .. code-block:: shell

         mongosh --port 27017

   .. step:: Initiate your replica set.

      Use the :method:`rs.initiate()` method to initiate your replica
      set. For details, see :ref:`this example <rs-initiate-example>`. 

   .. step:: Create your admin user.

      .. include:: /includes/search-in-community/create-admin-user-step.rst

      For details, see :ref:`create-user-defined-role`.

   .. step:: Exit mongosh.

      To exit ``mongosh``, run:

      .. code-block:: javascript

         exit
      
   .. step:: Update your config file to point to your keyfile.

      .. _mongod-specify-keyfile:

      Uncomment the following lines in the ``mongod.conf`` file you created in
      :ref:`Create your mongod configuration file <create-mongod-config>`. 
      Replace ``</path/to/keyfile>`` with the path to the keyfile you 
      created in :ref:`Create your keyfile <create-your-keyfile>`.

      .. code-block:: yaml

         security:
            authorization: enabled  # Equivalent to --auth
            keyFile: </path/to/keyfile>

   .. step:: Restart mongod with keyfile authentication.

      To start ``mongod`` with keyfile authentication, specify the 
      config file that you created in :ref:`Create your mongod 
      configuration file <create-your-keyfile>` and updated throughout
      the procedure.

      .. code-block:: bash

         ./mongod --config mongod.conf 

Next Steps
----------

- :ref:`community-search-deploy`
