.. _ruby-atlas-search:

==========================
Run a MongoDB Search Query
==========================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: search, atlas, read

Overview
--------

In this guide, you can learn how to query a {+search+} index and use advanced full-text
search functionality in your {+driver-short+} applications. You can query a search index by 
using a ``$search`` aggregation pipeline stage.

To learn more about the ``$search`` pipeline stage, see the :manual:`$search
</reference/operator/aggregation/search/>` guide in the {+mdb-server+} manual.

.. note:: Atlas and Community Edition Version Requirements

   The ``$search`` aggregation-pipeline operator is available only for
   collections hosted on :atlas:`MongoDB Atlas </>` clusters running
   MongoDB v4.2 or later, or on :manual:`MongoDB Community Edition
   </installation>` clusters running MongoDB v8.2 or later. Collections
   must be covered by a :atlas:`{+search+} index
   </reference/atlas-search/index-definitions/>`. To learn more about
   the required setup and the functionality of this operator, see the
   :atlas:`{+search+} </atlas-search>` documentation.


Sample Data
~~~~~~~~~~~

The examples in this guide use the ``sample_mflix.movies`` collection
from the :atlas:`Atlas sample datasets </sample-data>`. To learn how to create a
free MongoDB Atlas cluster and load the sample datasets, see
:ref:`<ruby-get-started>`.

Create a {+search+} Index
-----------------------------

Before you can perform a search on an Atlas collection, you must first create a **{+search+} index** 
on the collection. A {+search+} index is a data structure that
categorizes data in a searchable format. To learn how to create a {+search+} index,
see the :ref:`ruby-atlas-search-index` guide.

Search Your Data
----------------

To use the ``$search`` aggregation pipeline stage, you must specify a {+search+} query
operator that indicates the type of query you want to run. You can optionally
use a collector to specify the values and ranges of the query output. To view a
table of all the operators and collectors available with {+search+}, see the
:atlas:`Operators and Collectors </atlas-search/operators-and-collectors>` page
in the Atlas documentation.  

The following example uses the ``compound`` operator to combine several operators into a
single query. To learn more, see the :atlas:`Compound Operator
</atlas-search/compound>` guide in the Atlas documentation.  

The query has the following search criteria:

- The ``genres`` field must not contain ``Comedy``.
- The ``title`` field must contain the string ``New York``.

The query also includes the following stages:

- :pipeline:`$limit`, to limit the output to 10 results.
- :pipeline:`$project`, to exclude all fields except
  ``title`` and add a field named ``score``.

.. io-code-block::
   :copyable: true

   .. input::
      :language: ruby

      pipeline = [
        {
          "$search" => {
            "index" => "index_name",
            "compound" => {
              "mustNot" => [
                {
                  "text" => {
                    "query" => ["Comedy"],
                    "path" => "genres"
                  }
                }
              ],
              "must" => [
                {
                  "text" => {
                    "query" => ["New York"],
                    "path" => "title"
                  }
                }
              ]
            }
          }
        },
        { "$limit" => 10 },
        {
          "$project" => {
            "_id" => 0,
            "title" => 1,
            "score" => { "$meta" => "searchScore" }
          }
        }
      ]

      result = collection.aggregate(pipeline)
      puts result.to_a

   .. output::
      :language: none
      :visible: false

      {'title': 'New York, New York', 'score': 6.786379814147949}
      {'title': 'New York', 'score': 6.258603096008301}
      {'title': 'New York Doll', 'score': 5.381444931030273}
      {'title': 'Escape from New York', 'score': 4.719935417175293}
      {'title': 'Autumn in New York', 'score': 4.719935417175293}
      {'title': 'Sleepless in New York', 'score': 4.719935417175293}
      {'title': 'Gangs of New York', 'score': 4.719935417175293}
      {'title': 'Sherlock Holmes in New York', 'score': 4.203253746032715}
      {'title': 'New York: A Documentary Film', 'score': 4.203253746032715}
      {'title': 'An Englishman in New York', 'score': 4.203253746032715}

Additional Information
----------------------

To learn more about the available {+search+} operators, see the :atlas:`Operators and
Collectors </atlas-search/operators-and-collectors>` guide in the MongoDB Atlas
documentation.

For more information about {+search+}, and to view more query examples, see the
:atlas:`{+search+} documentation </atlas-search>`. 

If you'd like to perform vector searches on your data stored in Atlas, you must use
{+vector-search+}. To learn more about {+vector-search+}, see the :atlas:`{+vector-search+}
documentation </atlas-vector-search/vector-search-overview/>`. 