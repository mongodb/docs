:noprevnext:

=========================
Install the |k8s-op-full|
=========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/styles/corrections.rst

.. include:: /includes/note-k8s-supported-in-om4.rst

|k8s-op-full| allows you to deploy MongoDB deployment items with |k8s|
and |onprem|. This Operator uses |k8s| and |onprem| |api| methods to
deploy standalone, replica set, and sharded cluster deployments that
|onprem| manages.

.. note::

   This tutorial presumes some knowledge of |k8s|, but does link to
   relevant |k8s| documentation where possible. If you are unfamiliar
   with |k8s|, please review that documentation first.

Prerequisites
-------------

|onprem| Prerequisites
~~~~~~~~~~~~~~~~~~~~~~

To install the |k8s-op-full|, you must:

1. Have or generate a :ref:`Public API Key <generate-public-api-key>`.

#. Grant the user with this new Public API Key the
   :authrole:`Project Owner` role.

#. Add the |ipaddr| or |cidr| block of any hosts that serve the
   |k8s-op-short| to the
   :ref:`API Whitelist <configure-access-to-whitelisted-ops>`.

#. *(Optional).* Have or create an |onprem|
   :opsmgr:`Organization </tutorial/manage-organizations>`.

   .. note::

      Unlike earlier |k8s-op-short| versions, use the Operator to
      create your |mms| project. The Operator adds additional metadata
      to Projects that it creates to help manage the deployments.

.. _k8s-prerequisites:

|k8s| Prerequisites
~~~~~~~~~~~~~~~~~~~

1. Have a |k8s| solution available to use.

   If you need a |k8s| solution, see the |k8s|
   `documentation on picking the right solution <https://kubernetes.io/docs/setup/pick-right-solution/>`__.

#. Clone the `MongoDB Enterprise Kubernetes Operator repository <https://github.com/mongodb/mongodb-enterprise-kubernetes>`__.

   .. code-block:: sh

      git clone https://github.com/mongodb/mongodb-enterprise-kubernetes.git

   .. note::

      You can use `Helm <https://helm.sh/>`__ to install the
      |k8s-op-short|. To learn how to install Helm, see its
      `documentation on GitHub <https://github.com/kubernetes/helm>`__

#. Create a |k8s-ns| for your |k8s| deployment. By default, The
   |k8s-op-short| uses the ``mongodb`` namespace. To simplify your
   installation, consider creating a namespace labeled ``mongodb``
   using the following |kubectl| command:

   .. code-block:: sh

      kubectl create namespace mongodb

   If you do not want to use the ``mongodb`` namespace, you can label
   your namespace anything you like:

   .. code-block:: sh

      kubectl create namespace <namespaceName>

Considerations
--------------

|k8s| Compatibility
~~~~~~~~~~~~~~~~~~~

|k8s-op-full| is compatible with |k8s| v1.11 or later.


Docker Container Details
~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB builds the container images from the latest
`Ubuntu 16.04 <https://www.ubuntu.com/containers>`__ and
`Red Hat Enterprise Linux 7 <https://www.redhat.com/en/topics/containers>`__
upstream images. MongoDB updates all
packages on these images before releasing them every three weeks.

Only One Operator per Namespace
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The |k8s-op-full| can only exist in one |k8s-ns|. Your deployment can
have:

- One cluster-wide |k8s-op-short| or
- Multiple Kubernetes Operators in their own namespaces

Do not try to deploy more than one Kubernetes Operator in the same
namespace as another Operator. Multiple Operators cannot coordinate
with one another within the same namespace.

.. _default namespace: https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/#viewing-namespaces

.. _install-k8s-operator:

Install the |k8s-op-full|
-------------------------

.. tabs::

   tabs:
     - id: kubectl
       name: Online using kubectl
       content: |

         .. _install-k8s-operator-kubectl:

         .. admonition:: Use the same namespace throughout
            :class: note

            The following examples assume that you created a |k8s-ns|
            using the default |k8s-op-short| namespace of ``mongodb``.
            If you specified a different label for your namespace when
            you :ref:`created it <k8s-prerequisites>`, change all
            values for ``metadata.namespace`` to that namespace.

            To change the label for the namespace for the following
            deployment to ``production``, edit all values for
            ``metadata.namespace`` in ``mongodb-enterprise.yaml``:

            .. code-block:: yaml
               :emphasize-lines: 8, 16

               ##---
               # Source: mongodb-enterprise-operator/templates/serviceaccount.yaml
               ---
               apiVersion: v1
               kind: ServiceAccount
               metadata:
                 name: mongodb-enterprise-operator
                 namespace: production
               ##---
               # Source: mongodb-enterprise-operator/templates/operator.yaml
               ---
               apiVersion: apps/v1
               kind: Deployment
               metadata:
                 name: mongodb-enterprise-operator
                 namespace: production

               ---
               # Example truncated
               ---
               ...

         1. Change to the directory in which you cloned the repository.

         #. Install the |k8s-crds| for MongoDB deployments using the
            following |kubectl| command:

            .. code-block:: sh

               kubectl apply -f crds.yaml

         #. If you use `OpenShift <https://www.openshift.com/>`__ as
            your |k8s| orchestrator, you need to allow OpenShift to
            manage the Security Context for the |k8s-op-short|.

            Change the ``MANAGED_SECURITY_CONTEXT`` value as described
            in the next step.

         #. You can edit the Operator |yaml| file to further customize
            your Operator before installing it.

            a. Open your ``mongodb-enterprise.yaml`` in your preferred
               text editor.

            #. You may need to add one or more of the following
               options:

               .. include:: /includes/list-table-k8s-kubectl-install-options.rst

         #. Install the |k8s-op-short| using the following
            |kubectl| command:

            .. code-block:: sh

               kubectl apply -f mongodb-enterprise.yaml

         To troubleshoot your |k8s-op-short|, see
         :ref:`review-k8s-op-logs`.

         .. include:: /includes/fact-remove-k8s-resources-first.rst

     - id: helmonline
       name: Online using Helm
       content: |

         .. _install-k8s-operator-helm:

         If you have not already installed Helm, follow the 
         instructions on `GitHub <https://github.com/kubernetes/helm>`__
         to install it.

         1. Change to the directory in which you cloned the repository.

         #. Install the |k8s-op-short| using the following
            ``helm`` command:

            .. code-block:: sh

               helm template helm_chart > operator.yaml
               kubectl apply -f operator.yaml 

            You can customize your Chart before installing it by using
            the ``--set`` option. For this Chart, you may need to add
            one or more of the following options:

            .. include:: /includes/list-table-k8s-helm-install-options-online.rst

         To troubleshoot your |k8s-op-short|, see
         :ref:`review-k8s-op-logs`.

         .. include:: /includes/fact-remove-k8s-resources-first.rst

     - id: helmoffline
       name: Offline using Helm and Docker
       content: |

         Before continuing, install Helm following the instructions on
         `GitHub <https://github.com/kubernetes/helm>`__

         To install the |k8s-op-short| on a host not connected to the
         Internet, you have two options, you can download the
         |k8s-op-short| files from either:

         .. tabs::

            tabs:
              - id: internet
                name: The Internet
                content: |

                  1. Connect to the Internet.

                  #. Use ``docker`` to request the files.

                     .. code-block:: sh

                        docker pull quay.io/mongodb/mongodb-enterprise-operator:0.1; \
                        docker pull quay.io/mongodb/mongodb-enterprise-database:0.1

                  #. Disconnect from the Internet.

                  #. Install the |k8s-op-short| with modified pull
                     policy values using the following ``helm``
                     command:

                     .. code-block:: sh

                        helm template --set registry.pullPolicy=IfNotPresent \
                          helm_chart > operator.yaml
                        kubectl apply -f operator.yaml 

                     You can further customize your Chart before
                     installing it by using the ``--set`` option. For
                     this Chart, you may need to add one or more of the
                     following options:

                     .. include:: /includes/list-table-k8s-helm-install-options-offline.rst

                  To troubleshoot your |k8s-op-short|, see
                  :ref:`review-k8s-op-logs`.

                  .. include:: /includes/fact-remove-k8s-resources-first.rst

              - id: host
                name: Another Host
                content: |

                  #. Use ``docker`` to request the files on a host
                     connected to the Internet.

                     .. code-block:: sh

                        docker pull quay.io/mongodb/mongodb-enterprise-operator:0.1; \
                        docker pull quay.io/mongodb/mongodb-enterprise-database:0.1

                  #. Save the Operator files to transferrable files.

                     .. code-block:: sh

                        docker save quay.io/mongodb/mongodb-enterprise-operator:0.1 -o mongodb-enterprise-operator.tar; \
                        docker save quay.io/mongodb/mongodb-enterprise-database:0.1 -o mongodb-enterprise-database.tar

                  #. Copy these ``.tar`` files to the host running the
                     |k8s| ``docker`` daemon.

                  #. Import the ``.tar`` files into ``docker``.

                     .. code-block:: sh

                        docker import mongodb-enterprise-operator.tar quay.io/mongodb/mongodb-enterprise-operator:0.1; \
                        docker import mongodb-enterprise-database.tar quay.io/mongodb/mongodb-enterprise-database:0.1

                  #. Install the |k8s-op-short| with modified pull
                     policy values using the following ``helm``
                     command:

                     .. code-block:: sh

                        helm template --set registry.pullPolicy=IfNotPresent \
                          helm_chart > operator.yaml
                        kubectl apply -f operator.yaml 

                     You can further customize your Chart before
                     installing it by using the ``--set`` option. For
                     this Chart, you may need to add one or more of the
                     following options:

                     .. include:: /includes/list-table-k8s-helm-install-options-offline.rst

                  To troubleshoot your |k8s-op-short|, see
                  :ref:`review-k8s-op-logs`.

                  .. include:: /includes/fact-remove-k8s-resources-first.rst

Next Steps
----------

Now that you installed the |k8s-op-full|, you need to:

- Create your |com| project and |k8s| ConfigMap

- Create credentials so the |k8s-op-short| can update your |com|
  project

For detailed instructions for both procedures, see
:doc:`/configuration`.
