title: Set up a server and firewall.
stepnum: 1
ref: set-up-server
content: |
  Prepare the server that will run the MMS On-Prem components, the
  Application Database, and Backup Blockstore Database.

  Use a RHEL 6+ or Amazon Linux Server with at least:

  - 15 GB of memory.

  - 50 GB of disk space for the root partition.

  For example, you can meet the size requirements by using an AWS EC2
  ``m3.xlarge`` instance and changing the size of the root partition from
  8 to 50 gigabytes. When you log into the instance, use "``df -h``" to
  verify the root partition has 50 gigabytes of space.

  Set up a firewall or EC2 Security Group that:

  - Allows administrators to SSH into the server.

  - Allows MMS users to connect from browsers to ports ``8080`` and ``8081`` through the server's public IP address.
---
title: Configure ``ulimits``.
stepnum: 2
ref: ulimits
action:
  - pre: |
      Remove the default ``ulimit`` settings that come with the operating
      system:
    language: sh
    code: |
      sudo rm /etc/security/limits.d/90-nproc.conf
  - pre: |
      Use root privileges to open the ``/etc/security/limits.conf`` file
      in an editor and then add the following settings:
    language: cfg
    code: |
      * soft nofile 64000
      * hard nofile 64000
      * soft nproc 32000
      * hard nproc 32000
---
title: Install MongoDB.
stepnum: 3
ref: install-mongodb
pre: |
  Use the following series of commands to install MongoDB, which you use
  for the MMS Application Database and the MMS Backup Blockstore Database.
action:
  - pre: |
      Go to your home directory:
    language: sh
    code: |
      cd ~
  - pre: |
      Set up a repository definition by issuing the following command:
    language: sh
    code: |
      echo "[MongoDB]
      name=MongoDB Repository
      baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
      gpgcheck=0
      enabled=1" | sudo tee -a /etc/yum.repos.d/mongodb.repo
  - pre: |
      Install MongoDB by issuing the following two commands:
    language: sh
    code: |
      sudo yum install -y mongodb-org

      sudo yum install -y mongodb-org mongodb-org-shell
---
title: Install the MMS Application Package.
stepnum: 4
ref: application-package
pre: |
  Download the latest version of the MMS Application Package from `the MMS
  downloads page <http://www.mongodb.com/subscription/downloads/mms>`_.
  The MMS Application Package is listed as "Monitoring and Core" on the
  downloads page.
action:
  - pre: |
      Alternately, you can download the MMS Application Package by issuing
      the following command, where ``<version>`` is the MMS version:
    language: sh
    code: |
      sudo curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.4.2.73-1`` issue:
    language: sh
    code: |
      curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-1.4.2.73-1.x86_64.rpm
  - pre: |
      Install the package using the following command, where ``<version>``
      is the MMS version:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.4.2.73-1`` issue:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-1.4.2.73-1.x86_64.rpm
---
title: Install the Backup Daemon Package.
stepnum: 5
ref: backup-package
pre: |
  Download the latest version of the Backup Daemon Package from `the MMS
  downloads page <http://www.mongodb.com/subscription/downloads/mms>`_.
action:
  - pre: |
      Alternately, you can download the package by issuing the following
      command, where ``<version>`` is the MMS version:
    language: sh
    code: |
      curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-backup-daemon-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.4.2.73-1`` issue:
    language: sh
    code: |
      curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-backup-daemon-1.4.2.73-1.x86_64.rpm
  - pre: |
      Install the package using the following command, where ``<version>``
      is the MMS version:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-backup-daemon-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.4.2.73-1``, you would issue the following:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-backup-daemon-1.4.2.73-1.x86_64.rpm
---
title: Set up the two backing databases.
stepnum: 6
ref: backing-databases
pre: |
  The :doc:`backing databases
  </tutorial/prepare-backing-mongodb-instances>` are the MMS Application
  Database and MMS Backup Blockstore Database.
action:
  - heading: Create a data directory for each backing database.
    pre: |
      The following command creates two data directories, one for each
      backing database. You can use different directory names:
    language: sh
    code: |
      sudo mkdir -p /data /data/mmsdb /data/backupdb
  - heading: Set ownership of the data directories to ``mongod.mongod``.
    pre: |
      For example, the following command sets ``mongod.mongod``
      as owner of the ``/data``, ``/data/mmsdb``, and ``/data/backupdb``:
    language: sh
    code: |
      sudo chown mongod.mongod /data /data/mmsdb /data/backupdb
---
title: Start the MongoDB instances for the two backing databases.
stepnum: 7
ref: mongod
pre: |
  Start each MongoDB instance using the :program:`mongod` daemon and
  specifying ``mongod`` as the user. Start each instance on its own
  dedicated port number and with the data directory you created in the
  last step.
action:
  pre: |
    The following two commands start separate instances for the MMS
    Application Database and for the Backup Blockstore Database:
  language: sh
  code: |
    sudo -u mongod mongod --port 27017 --dbpath /data/mmsdb --logpath /data/mmsdb/mongodb.log --fork
    sudo -u mongod mongod --port 27018 --dbpath /data/backupdb --logpath /data/backupdb/mongodb.log --fork
---
title: Configure and start the MMS Application Service.
stepnum: 8
ref: mms-application
action:
  - heading: Configure the MMS Application Service.
    pre: |
      Use root privileges to edit
      ``/opt/mongodb/mms/conf/conf-mms.properties``. Set values for the
      following properties, substituting your install's values for
      *<public_ip>* and *mms-admin@example.net*:
    language: cfg
    code: |
      mms.centralUrl=http://<public_ip>:8080
      mms.backupCentralUrl=http://<public_ip>:8081

      mms.fromEmailAddr=mms-admin@example.net
      mms.replyToEmailAddr=mms-admin@example.net
      mms.adminFromEmailAddr=mms-admin@example.net
      mms.adminEmailAddr=mms-admin@example.net
      mms.bounceEmailAddr=mms-admin@example.net

      mongo.mongoUri=mongodb://127.0.0.1:27017/
      mongo.backupdb.mongoUri=mongodb://127.0.0.1:27018/
  - heading: Start the MMS Application Service.
    pre: |
      Issue the following command:
    language: sh
    code: |
      sudo service mongodb-mms start
  - heading: Verify the MMS Application Service is accessible.
    pre: |
      In a browser, verify the MMS On-Prem home page is accessible at
      ``http://<public_ip>:8080``, where ``<public_ip>`` is the public IP
      address of the server.
  - heading: Register the first user.
    pre: |
      To register the first user, click the :guilabel:`Register` link and
      enter the user's information. The registration email will be sent to
      the address you specified in ``conf-mms.properties``. For more
      information on creating users, see :doc:`/core/user-management`
---
title: Configure and start the MMS Backup Daemon Service.
stepnum: 9
ref: mms-backup
action:
  - heading: Configure the MMS Backup Daemon Service.
    pre: |
      Use root privileges to edit
      ``/opt/mongodb/mms-backup-daemon/conf/conf-daemon.properties``. Set
      the following properties as specified here:
    language: cfg
    code: |
      mongo.mongoUri=mongodb://127.0.0.1:27017/

      mongo.backupdb.mongoUri=mongodb://127.0.0.1:27018/
  - heading: Start the MMS Backup Daemon Service.
    pre: |
      Issue the following command:
    language: sh
    code: |
      sudo service mongodb-mms-backup-daemon start
...
