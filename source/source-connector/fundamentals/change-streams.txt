.. _kafka-source-change-streams:

==============
Change Streams
==============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

In this guide, you can learn about **change streams** and how they are
used in a {+mkc+} source connector.

Change Streams
--------------

Change streams are a feature of MongoDB that allow you to receive real-time
updates on data changes. Change streams return
**change event documents**. A change event document is a document in your
**oplog** that contains idempotent instructions to recreate a change that
occurred in your MongoDB deployment as well as the metadata related to that
change.

The oplog is a special collection in MongoDB that keeps track of all changes
within a MongoDB replica set. Change streams help you use the change event data
stored in the oplog without you having to learn details about how the oplog
works.

.. important:: You must have a replica set or a sharded cluster

   Change streams are available for replica sets and sharded clusters. A
   standalone MongoDB instance cannot produce a change stream.

To view a list of all configuration options for change streams, see the
:ref:`<source-configuration-change-stream>` page.

To learn more about change streams, see the following resources:

- :manual:`Change Streams </changeStreams>` in the MongoDB manual
- `An Introduction to Change Streams <https://www.mongodb.com/blog/post/an-introduction-to-change-streams>`__
  blog post

To learn more about the oplog, see the MongoDB manual entry on the
:manual:`Replica Set Oplog </core/replica-set-oplog/>`.

Aggregation
~~~~~~~~~~~

Use an aggregation pipeline to configure your source connector's change stream.
Some of the ways you can configure your connector's change stream are as follows:

- Filter change events by operation type
- Project specific fields
- Update the value of fields
- Add fields
- Trim the amount of data generated by the change stream

To learn which aggregation operators you can use with a change stream, see
the :manual:`Modify Change Stream Output </changeStreams/#modify-change-stream-output>`
guide in the MongoDB manual.

To view examples that use an aggregation pipeline to modify a change stream,
see the following pages:

- :ref:`<source-usage-example-custom-pipeline>` Usage Example
- :ref:`<source-usage-example-copy-existing-data>` Usage Example

.. _source-connector-fundamentals-change-event:

Change Event Structure
~~~~~~~~~~~~~~~~~~~~~~

Find the complete structure of change event documents, including
descriptions of all fields,
:ref:`in the MongoDB manual <change-stream-output>`.

.. note:: The Full Document Option

   If you want Kafka Connect to receive just the document created or modified
   from your change operation, use the ``publish.full.document.only=true``
   option. For more information, see the :ref:`<source-configuration-change-stream>`
   page.

Source Connectors
-----------------

A {+mkc+} source connector works by opening a single change stream with
MongoDB and sending data from that change stream to Kafka Connect. Your source
connector maintains its change stream for the duration of its runtime, and your
connector closes its change stream when you stop it.

To view the available options to configure your source connector's change stream,
see the :ref:`<source-configuration-change-stream>` page.

Resume Tokens
~~~~~~~~~~~~~

Your connector uses a **resume token** as its **offset**. An offset is a value
your connector stores in an {+ak+} topic to keep track of what source data it
has processed. Your connector uses its offset value when it must recover from
a restart or crash. A resume token is a piece of data that references the
``_id`` field of a change event document in your MongoDB oplog.

If your source connector does not have an offset, such as when you start
the connector for the first time, your connector starts a new change stream.
Once your connector receives its first change event document and publishes that
document to {+ak+}, your connector stores the resume token of that document as
its offset.

If the resume token value of your source connector's offset does not correspond to
any entry in your MongoDB deployment's oplog, your connector has an invalid resume
token. To learn how to recover from an invalid resume token, see the
:ref:`invalid token troubleshooting guide <kafka-troubleshoot-invalid-resume-token>`.

To learn more about resume tokens, see the following resources:

- :manual:`Resume a Change Stream </changeStreams/#resume-a-change-stream>`
  in the MongoDB manual
- :manual:`Change Events </reference/change-events/#std-label-change-stream-event-id>`
  in the MongoDB manual

To learn more about offsets, see the following resources:

- {+kc+} ``offset.storage.topic``
  `configuration option documentation <https://docs.confluent.io/platform/current/installation/configuration/connect/index.html#offset-storage-topic>`__
- {+kc+} ``OffsetStorageReader``
  `API documentation  <https://kafka.apache.org/0110/javadoc/org/apache/kafka/connect/storage/OffsetStorageReader.html>`__
