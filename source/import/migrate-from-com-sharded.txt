.. _live-migrate-com-sharded:

===================================================================================
Live Migrate (Push) a Sharded {+Cluster+} Monitored by Ops Manager or Cloud Manager
===================================================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

|service| can faciliate a live migration where if |com| monitors a source
sharded {+cluster+}, it pushes this {+cluster+} to a sharded |service|
{+cluster+}. |service| keeps the destination {+cluster+} in sync with the
source {+cluster+} until you cut your applications over to the destination
{+cluster+} in |service|.

Once you reach the cutover step in the following procedure, stop writes
to the source {+cluster+}: stop your application instances, point them
to the |service| {+cluster+}, and restart them.

Restrictions
------------

.. include:: /includes/live-migration-from-com-restrictions.rst

- You can't use a :doc:`Global Cluster </global-clusters>` as the
  destination for live migration.

- .. include:: /includes/fact-c2c.rst

- To live migrate a replica set {+cluster+} from |com| to |service|, see
  :doc:`/import/migrate-from-com-rs`.



.. _migrate-from-com-vpc-support-sharded:

Support for VPC Peering and Private Endpoints
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/live-migration-from-com-vpc-support-sharded.rst

Prerequisites
-------------

Before you begin the live migration from |com| to |service|:

.. include:: /includes/live-migration-from-com-prereqs-sharded.rst

.. _live-migration-from-com-workflow-sharded:

Live Migration Workflow
~~~~~~~~~~~~~~~~~~~~~~~

This section outlines the workflow. For detailed steps,
see the :ref:`procedure for migrating a sharded cluster from
Ops Manager or Cloud Manager to Atlas <lm-com-procedure-sharded>`.

.. include:: /includes/live-migration-from-com-workflow.rst

.. _lm-com-upgrade-path-sharded:

Migration Path and Supported Platforms
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/list-tables/live-migration-from-com-platforms.rst

|service| live migration (push) supports the following migration paths:

.. include:: /includes/list-tables/push-live-migration-upgrade-path-sharded.rst

.. note::

   For sharded {+clusters+}, the major MongoDB versions on the source and
   destination {+clusters+} must be exactly the same. The major MongoDB version
   in the full **4.4.x** version is **4.4**.

.. _lm-com-network-access-sharded:

.. include:: /includes/import/network-access-lm-from-com.rst

.. _lm-com-migration-validation-sharded:

Pre-Migration Validation
~~~~~~~~~~~~~~~~~~~~~~~~

Before starting the live migration procedure, |service| runs validation
checks on the source and destination {+clusters+}.

- The source {+cluster+} is a sharded {+cluster+}.

- .. include:: /includes/fact-validate-enable-collect-dbstats.rst

- The destination |service| {+cluster+} is a sharded {+cluster+} with the same
  number of :term:`shards <shard>` as the source sharded {+cluster+}.

- The destination |service| {+cluster+} doesn't have |bic| enabled.

.. _live-import-push-security-of-migration-servers:

Security Requirements for the Migration Host
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-live-migration-push-security-of-lm-server.rst

Index Key Limits
~~~~~~~~~~~~~~~~

.. include:: /includes/fact-failIndexKeyTooLong-import.rst

Considerations
--------------

.. include:: /includes/fact-network-encryption-push-migration.rst

.. _security-lm-com-sharded:

Database Users and Roles
~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-create-atlas-user.rst

.. include:: /includes/import/security-lm-from-com.rst

Destination {+Cluster+} Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When you configure the destination {+cluster+}, consider the following:

.. include:: /includes/fact-live-migration-perf-target-cluster.rst

- The destination |service| {+cluster+} must be a sharded {+cluster+}.

- You can't select an ``M0`` (Free Tier) or ``M2/M5`` shared-tier
  {+cluster+} as the destination for live migration.

- Do **not** change the ``featureCompatibilityVersion`` flag while
  |service| live migration is running.

Destination {+Cluster+} Network Access
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-target-cluster-nw-access.rst

Dropping Data in the Destination {+Cluster+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your destination sharded {+cluster+} contains existing data, the live
migration process detects this and warns you that it drops data and
collections from the destination sharded {+cluster+} before live migrating
data into it.

Avoid Workloads on the Target {+Cluster+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-mongomirror-no-workloads-target-cluster.rst

Avoid Cloud Backups
~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-avoid-backups.rst

Avoid Namespace Changes
~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-mongomirror-namespace-changes.rst

Avoid Elections
~~~~~~~~~~~~~~~

.. include:: /includes/fact-avoid-elections.rst

Rolling Restarts
~~~~~~~~~~~~~~~~

.. include:: /includes/live-import-rolling-restarts.rst

Staging and Production Environments
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/live-migrate-from-com-staging-prod.rst

Migrating from MongoDB Community
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you are :opsmgr:`migrating </tutorial/migrate-community-to-atlas>`
to |service| from MongoDB Community using |onprem|, you must accept
the :opsmgr:`Ops Manager Migration Agreement
</reference/legal/live-migration-atlas-licensing>` as the first step
in the :ref:`live migration procedure <lm-com-procedure-sharded>`.

Migrate Your {+Cluster+}
------------------------

.. important::

   Avoid making changes to the source {+cluster+} configuration while the
   live migration procedure runs, such as removing sharded {+cluster+}
   members or modifying :binary:`mongod <bin.mongod>` runtime settings,
   such as ``featureCompatibilityVersion``.

.. _lm-com-procedure-sharded:

Procedure
~~~~~~~~~

.. include:: /includes/steps/migrate-from-com.rst

.. _lm-com-api-sharded:

Push Live Migration APIs
------------------------

.. include:: /includes/live-migration-apis.rst

Migration Support
-----------------

.. _lm-com-support-sharded:

.. include:: /includes/live-migration-support.rst

Push Live Migration CLI Commands
--------------------------------

.. include:: /includes/live-migrate-with-cli-sharded.rst
