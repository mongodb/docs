# Atlas Go SDK Project - Examples and Unit Tests

> NOTE: This is an internal-only file and refers to the internal project details.
> User-facing project details are documented in the [README.md](README.md) file, which is copied to the artifact repo.

This project contains the infrastructure to test and extract Go SDK code
examples for use in the Atlas Architecture Center docs. This project
also generates a public-facing sample app with a collection of runnable examples. These
examples are intended to be copied to the user-facing artifact repo.
The artifact repo is located at: https://github.com/mongodb/atlas-architecture-go-sdk

## Terms
Architecture Center
  The documentation site that uses the code examples generated by this
  project. The source files for the docs are located in the
  [atlas-architecture](../content/atlas-architecture) repo.

Artifact Repo
  The user-facing GitHub repo that contains the sanitized version of
  this project (i.e. stripped of any internal comments, markup, test
  files, etc.). Files are automatically copied from the `project-copy` directory in
  this repo to the artifact repo via the Copier App.

Bluehawk
  The tool used to generate code examples from the source code using
  simple markup. This is outlined in detail in the [Generate Code Example Files](#generate-code-example-files) section below. See
  the [Bluehawk documentation](https://mongodb-university.github.io/Bluehawk/) for more details.

Code Examples
  The code files that are generated from the source code
  using Bluehawk markup. These files are either runnable code **snippets** (examples
  used in
  the Architecture Center docs using `literalinclude` or
  `io-code-block`) or **copies** (entire files that are then copied to the
  artifact repo).

Copier App
  The DevDocs team's GitHub app that listens for PR events from this source
  repository and copies files to target repositories upon merge. We
  use this app to automatically copy the files from the `project-copy` directory in
  this repo to the artifact repo.

## Project Structure
The project module is named `atlas-sdk-examples`. The structure is as
follows:

```text
.
├── examples/              # Self-contained, runnable examples by category
├── configs/               # Atlas details
├── internal/              # Shared utilities and helpers
├── go.mod
├── CHANGELOG.md           # User-facing list of major project changes
│── README.md              # User-facing README for copied project
│── INTERNAL_README.md     # (NOTE: INTERNAL ONLY - DON'T COPY TO ARTIFACT REPO)
│── scripts/               # (NOTE: INTERNAL ONLY) Script to generate code examples
│   └── snip.sh
├── .gitignore           # Ignores .env file and log output
└── .env.example         # Example environment variables
(NOTE: ALL TEST FILES ARE INTERNAL ONLY - DON'T COPY TO ARTIFACT REPO)
```
Unless noted, all files are automatically copied to the `project-copy`
dir, then copied to the artifact repo. This includes `.gitignore` and
`.env.example`.

### Runnable Scripts
After setting up your local environment, you can run individual scripts
from the terminal. For example, to run `get_logs/main.go`:
```shell
go run examples/monitoring/get_logs/main.go
```

To set up your local environment, see the instructions in the main [README](README.md) file.

## Set Up the Project
> NOTE: Contact the Developer Docs team with any setup questions or issues.

### Prerequisites
You must have `Go` 1.24+ installed. See the [Go installation
page](https://golang.org/doc/install) for details.

### Install dependencies
From the root of the `/go/atlas-sdk` directory, run the following command to install dependencies:
```sh
go mod download
```

## Create a New Example Script
To create a new example script for the Atlas Architecture Center,

1. [Create a new file in the `examples` directory](#create-a-new-example).
2. (Optional) [Create internal helper files in the `internal` directory](#create-any-internal-helper-functions) .
3. [Add corresponding tests](#write-tests)
4. [Update any required documentation`](#update-documentation)
5. [Mark up the code example files](#generate-code-example-files)
6. [Run the snip command](#run-the-bluehawk-script) to generate the tested
   code example files to the `/content/code-examples/tested/go/atlas-sdk` directory.
7. Use the code example in a `literalinclude` or `io-code-block` in
   the [atlas-architecture](../content/atlas-architecture) repo.

### Create an example file

Create a new file in the `/examples` directory. Organize examples to group
related concepts based on the Architecture Center navigation - e.g. create a `/billing` directory and within that create
`historical/main.go` and `line-items/main.go`.

Example files should be fully runnable main files (`main.go`), which implement functions that:

- Connect to MongoDB using environment variables
- Execute the desired operations
- Return results for comparison with expected output

### (Optional) Create internal helper functions
If your example script requires any helper functions, create them in
the `internal` directory. Organize helper files by topic, e.g.
`internal/billing/line_items.go`.

- Check that the functionality doesn't already exist before creating a new one.
- If a relevant file already exists, add your helper functions to the existing file.
- If a helper file is only used by one example, it's okay to create a
  new file for it.

### (Optional) Create configuration settings
If your example requires any new configuration settings, make sure to update the
configuration loading functionality in the `internal/config` directory
to support your new settings.

- Check that a similar setting doesn't already exist before creating a new one.
- Update the example `config.json` and the `README.md` to reflect the
  new settings.

> **IMPORTANT:** Do NOT add configuration settings as environment variables. The
> environment variables should only hold credentials. Currently,
> the project only supports loading service account credentials from the
> `.env` file.

## Write Unit Tests
Unlike the other Grove test suites, this project does not have a
separate `/tests` directory. Instead, we create individual test files
that test the functionality used in the example.

This might only require testing the helper functions, or you might
need to test private functions from the example file itself.

### Updating an existing example
If you're updating an existing example, make sure you update the
existing test files. This might require adding new tests to an existing
file, updating existing tests to reflect your changes, or creating a
new test file for a different topic.

You might also add tests to an existing file if the tests are for similar
functionality. For example, as part of a new example, you added a new
helper function to `internal/billing/line-items.go`. So you add
new tests to the existing `internal/billing/line-items_test.go` file.

### Creating a new test file
To create a new test file, create a new file in the same subdirectory as
the file you're testing, and append the file name with `_test.go`:
**File**: `/internal/billing/line-items.go`
**Test**: `/internal/billing/line-items_test.go`

If you're testing an example file in the `/examples` directory, create
a new `main_test.go` in the same subdirectory.

Then add your tests to the file.

## Update Documentation
Depending on the changes you make, you might need to update the
documentation in this repo.

### Update README.md and CHANGELOG.md
If your changes are user-facing (e.g. you added a new example), you
most likely need to update the `README.md` and `CHANGELOG.md` files as
well. In the README, these changes can include:

- Updates to the project structure
- Adding instructions for running a new example
- Updating the set up instructions with any new requirements (e.g. new
  dependencies, new environment variables, etc.) that users need to run
  the examples

### Update INTERNAL_README.md
If your changes also impact this document (e.g. you added a new
configuration variable, changed the testing strategy, etc.), update
this `INTERNAL_README.md` file accordingly.

## Run Examples
The examples in this project are runnable code that you can execute
locally. Currently, the full examples are not tested in CI.

To run the full examples locally, follow the set up instructions in
the main [README](README.md).

> NOTE: Some examples may require specific cluster configurations,
> data, and permissions to successfully run.

## Run Tests
Currently, the project only contains unit tests. This means that you
do NOT need an Atlas cluster, local deployment, or credentials to run the
tests.

### Run all tests locally from the command line
From the root directory, run:

```sh
go test -v ./...
```

This command runs all tests in the current module and its subdirectories.

### Run test packages from the command line
You can run tests for a single package. From the root directory, run:

```sh
go test -v ./internal/<package-name>
```

### Run individual tests from the command line
You can run a single test function within a given package. From the directory containing the test file, run:

```sh
go test -v ./... -run TestExampleOperations/YourExampleName
```

## Run Tests in CI
A GitHub workflow runs these tests in CI automatically when you change any
files in the `atlas-sdk` directory:

- `.github/workflows/go-sdk-examples-unit-tests.yml`

GitHub reports the results as passing or failing checks on any PR that changes
an example.

If changing an example causes its test to fail, this should be considered
blocking to merge the example.

If changing an example causes an _unrelated_ test to fail, create a Jira ticket
to fix the unrelated test, but this should not block merging an example update.

## Generate Code Example Files
This project uses
[Bluehawk](https://mongodb-university.github.io/Bluehawk/) markup to
generate code examples from the source code.

> **IMPORTANT** Do not modify the generated files. If you need to
> make changes to the output, update the source file, and re-run the
> Bluehawk script instead.

Bluehawk lets us create two types of output from the source code:
- A **snippet** - a specific section of the source code. Used for
  tested code examples in docs.
- A **copy** - the entire source file. These files are copied to the artifact repo.

### Creating a new code snippet
To create a new code snippet to use directly in the docs, use
Bluehawk's [`snippet` tag](https://mongodb-university.github.io/Bluehawk/reference/tags#snippet)
to mark the snippet content.

Inside your code example, add the comment `// :snippet-start: <SNIPPET-NAME>`
where you want to start the snippet, and add `// :snippet-end:` to end the snippet.
See the existing code files in the `/examples` directory for examples.

### Copying the entire file
By default, Bluehawk also copies all source files (except the ignored
files; see [below](#files-ignored-by-the-copy-function)) to the `project-copy` output directory in their
original directory structure, which is then automatically copied to
the artifact repo.

You do not need to add any markup to the source file for this to work.
The copy function also honors the same markup tags as the snippet
function, such as `:remove:`, so you don't need to maintain two
different versions of your source file.

#### (Optional) Add markup for copied file
If you find that you need to manipulate the copied file output, you can use
Bluehawk's [`state` tag](https://mongodb-university.github.io/Bluehawk/reference/tags#state)
to mark content to be included or removed based on the state `copy`.

For example, to remove a log line from the copied file:
```go
// :state-remove-start: copy
// Some code you want to exclude from the copied file
// :state-remove-end:
```

> **EXAMPLE** See [internal_main.go](examples/internal_example/internal_main.go) for
> an example of using the snippet and "copy" state markup to
> manipulate content in the outputted file.

#### Files ignored by the copy function
The copy function currently IGNORES the following:
- all `_test` files
- internal-only files (e.g. `INTERNAL_README.md`, `scripts/bluehawk.sh`)
- any non-example `config.json` and `.env` files
- any `tmp` or `temp` directories

Also note that the copy function purposefully INCLUDES the following files:
- `go.mod`
- `configs/config.example.json` and `.env.example`
- `.gitignore`
- `README.md`
- `CHANGELOG.md`
- `LICENSE.md`

If you do _not_ want a file copied to the artifact repo, update the
`IGNORE_PATTERNS` array in the
[snip.sh](scripts/snip.sh) file. Include a
comment with the reason for ignoring the file, if needed.

### Run the Bluehawk script
If you do not already have Bluehawk, install it with the following command:

```sh
npm install -g bluehawk
```

To generate the code examples, run the following script from the root
of the `/go/atlas-sdk` directory:
```shell
./scripts/snip.sh
```

The script does the following:
1. Runs `go fmt` to format the code
2. Executes Bluehawk to generate the code examples and output them to
   the `content/code-examples/tested/go/atlas-sdk` directory:
   - Snippets output to `snippets` directory as `.snippet.` files
   - Copied files output to `project-copy` directory in the original directory structure

## Tips and Troubleshooting
### Format the code example files
This project uses Go's built-in formatting tools to enforce style formatting
for the files in the `examples` directory. You can check and fix formatting
manually on your machine before making your PR:

#### Run Go formatting from the command line
To automatically fix any formatting issues, run:

```sh
go fmt ./...
```

#### Run Go imports from the command line
To automatically group and sort imports across the entire project, run:

```sh
goimports -w -local atlas-sdk/ .
```

#### Configure VS Code to automatically apply formatting on save
Go formatting works with popular editors such as VS Code through extensions. To
format automatically when you save a file in VS Code:

1. Install the Go plugin: [Go for Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=golang.Go).
2. Open your settings and enable `"editor.formatOnSave"`:

   ```json
   "editor.formatOnSave": true
   ```

3. Set Go as the default formatter:

   ```json
   "[go]": {
     "editor.defaultFormatter": "golang.Go"
   }
   ```

You can find similar extensions for other editors and IDEs, such as GoLand.

#### Manage Go versions
We recommend using a Go version manager like [g](https://github.com/stefanmaric/g)
to manage your Go versions.

### Common troubleshooting
**Import errors**: Make sure your import path matches your directory structure exactly
- ✅ Good: `"atlas-sdk-examples/examples/billing/historical"` for `/examples/billing/historical/`
- ❌ Bad: `"billing/historical"` (missing the `atlas-sdk-examples/examples` prefix)

**Test naming**: Go test functions must start with `Test` and test helper functions should be lowercase
- ✅ Good: `TestBillingHistorical` (main test), `testGetInvoices` (helper function)
- ❌ Bad: `testBillingHistorical` (won't run as main test)

**Test file naming**: Go test functions must be in filenames that end with `_test.go`
- ✅ Good: `billing/historical_test.go` for examples in `examples/billing/historical`
- ❌ Bad: `billing/historical-test.go` (uses hyphen `-` instead of underscore `_`)
