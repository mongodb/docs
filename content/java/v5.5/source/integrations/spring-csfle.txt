.. _java-spring-csfle:

====================================================
Implement CSFLE in Java by Using Spring Data MongoDB
====================================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. facet::
   :name: genre
   :values: tutorial
.. meta::
   :keywords: spring data, client-side field level encryption, csfle, java, tutorial

Overview
--------

This guide shows you how to integrate MongoDB
:manual:`Client-Side Field Level Encryption </core/csfle/>`
(CSFLE) with `Spring Data MongoDB <https://spring.io/projects/spring-data-mongodb>`__.

.. note::

   If you haven't worked with CSFLE before, see the :manual:`CSFLE Tutorials </core/csfle/tutorials/>`
   guide in the {+mdb-server+} manual.
   
   If you haven't worked with Spring Data MongoDB before, see
   the `Spring Data MongoDB documentation <https://docs.spring.io/spring-data/mongodb/reference/>`__.

GitHub Repository
~~~~~~~~~~~~~~~~~

To view the source code for this guide, see the
:github:`mongodb-java-spring-boot-csfle <mongodb-developer/mongodb-java-spring-boot-csfle>`
repository on GitHub.

You can also retrieve the source code from its GitHub
repository by running the following command:

.. code-block:: bash

   git clone git@github.com:mongodb-developer/mongodb-java-spring-boot-csfle.git

Prerequisites
~~~~~~~~~~~~~

Before you use this guide, perform the following steps:

1. Install `Java 17 <https://www.oracle.com/java/technologies/javase/jdk17-archive-downloads.html>`__
#. Install the `MongoDB Automatic Encryption Shared Library <https://www.mongodb.com/docs/manual/core/queryable-encryption/reference/shared-library/#download-the-automatic-encryption-shared-library>`__
   v7.0.2 or later
#. Review the `README.md <https://github.com/mongodb-developer/java-spring-boot-csfle/blob/main/README.md>`__
   for information on how to run the example code.

You also need access to a `MongoDB cluster <https://www.mongodb.com/atlas/database>`__
running MongoDB v7.0.2 or later.

Example Features
~~~~~~~~~~~~~~~~

This example provides templated code for a production environment, and includes the
following features:

- Multiple encrypted collections
- Automated JSON Schema generation
- Server-side JSON Schema
- Separated clusters for Data Encryption Keys (DEKs) and encrypted collections
- Automated DEK generation or retrieval
- Spring Expression Language (SpEL) evaluation extension
- Auto-implemented repositories
- OpenAPI 3.0.1 documentation

The template follows SOLID principles to increase code readability and reuse.
To learn more about SOLID, see :wikipedia:`SOLID <SOLID>` on Wikipedia.

Project Diagrams
----------------

The following diagram shows the components required to create a
CSFLE-enabled ``MongoClient`` that can encrypt and decrypt fields
automatically. The arrows in the diagram show dependencies and relationships
between components.

.. figure:: /includes/figures/spring_mongo_csfle.png
   :alt: Project high-level diagram
   :width: 700px

The arrows in the diagram show dependencies and relationships
between components.

After the application establishes a connection with MongoDB, it
uses a three-tier architecture to expose a REST API and manage
communication with the MongoDB database, as shown in the following diagram:

.. figure:: /includes/figures/controller_service_repos.png
   :alt: Three-tier architecture
   :width: 700px

Create the Key Vault Collection
--------------------------------

This section shows you how to create the key vault collection and
its unique index.

If you are starting from a new MongoDB cluster, you must first create
the key vault collection and its unique index on the
``keyAltNames`` field.

Set Up the Key Vault and DEKs
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``KeyVaultAndDekSetup`` class creates the key vault collection
and its unique index by using a standard connection to MongoDB.
Then it creates the DEKs required to encrypt
the documents in each encrypted collection.

The following code shows the ``KeyVaultAndDekSetup`` class:

.. literalinclude:: /includes/integrations/spring-data-csfle/KeyVaultAndDekSetup.java
   :language: java
   :start-after: // start-key-vault-and-dek-setup
   :end-before: // end-key-vault-and-dek-setup
   :dedent:

.. important::

   In production, you can create the key vault collection and its
   unique index on the ``keyAltNames`` field manually. After you
   create them, you can remove this code.

This code uses a standard (not CSFLE-enabled) and temporary
``MongoClient`` connection in a ``try``-with-resources block to create
a collection and an index in the MongoDB cluster.

Create the Key Vault Collection
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``KeyVaultServiceImpl`` class creates the key vault collection
and the ``keyAltNames`` unique index.

The following code shows the ``KeyVaultServiceImpl`` class:

.. literalinclude:: /includes/integrations/spring-data-csfle/KeyVaultServiceImpl.java
   :language: java
   :start-after: // start-key-vault-service-impl
   :end-before: // end-key-vault-service-impl
   :dedent:

After you create the key vault collection and index, you can close
the standard MongoDB connection.

Create the Data Encryption Keys
--------------------------------

This section shows you how to create the DEKs by using the ``ClientEncryption``
connection.

Configure the Key Vault Client
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``MongoDBKeyVaultClientConfiguration`` class creates a
``ClientEncryption`` bean that the ``DataEncryptionKeyService``
uses to create the DEKs.

The following code shows the
``MongoDBKeyVaultClientConfiguration`` class:

.. literalinclude:: /includes/integrations/spring-data-csfle/MongoDBKeyVaultClientConfiguration.java
   :language: java
   :start-after: // start-mongodb-key-vault-client-configuration
   :end-before: // end-mongodb-key-vault-client-configuration
   :dedent:

You can create a ``ClientEncryption`` bean by using the 
`Key Management System (KMS) <https://www.mongodb.com/docs/manual/core/queryable-encryption/fundamentals/kms-providers/>`__
and use it to generate the DEKs. You need one DEK for each
encrypted collection.

Implement the Data Encryption Key Service
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``DataEncryptionKeyServiceImpl`` class creates and stores the DEKs. When you evaluate
the SpEL expressions in the entities to create the JSON Schemas, you must
retrieve the DEKs.

The following code shows the ``DataEncryptionKeyServiceImpl``
class:

.. literalinclude:: /includes/integrations/spring-data-csfle/DataEncryptionKeyServiceImpl.java
    :language: java
    :start-after: // start-data-encryption-key-service-impl
    :end-before: // end-data-encryption-key-service-impl
    :dedent:

.. note::

   Because the DEKs are stored in a map, you don't need to
   retrieve them again later for the JSON Schemas.

Define Entities
---------------

Spring Data MongoDB uses a POJO-centric model to implement the
repositories and map the documents to the MongoDB collections.

Create the Person Entity
~~~~~~~~~~~~~~~~~~~~~~~~~

The following code shows the ``PersonEntity`` class:

.. literalinclude:: /includes/integrations/spring-data-csfle/PersonEntity.java
    :language: java
    :start-after: // start-person-entity
    :end-before: // end-person-entity
    :dedent:

The preceding class contains all the information needed to automate CSFLE. The class uses
the ``@Encrypted`` annotation in the following ways:

- The ``@Encrypted`` class annotation contains the SpEL expression ``#{mongocrypt.keyId(#target)}``.
  This expression specifies the ``keyId`` of the DEK that you generated or retrieved in a previous step. CSFLE uses
  this DEK for encryption.
- The ``@Encrypted`` annotation on the ``ssn`` field specifies that it requires a deterministic algorithm.
- The ``@Encrypted`` annotation on the ``bloodType`` field specifies that it requires a random algorithm.

The JSON Schema generated by Spring Data MongoDB for this entity is as follows:

.. code-block:: json

   {
     "encryptMetadata": {
       "keyId": [
         {
           "$binary": {
             "base64": "WyHXZ+53SSqCC/6WdCvp0w==",
             "subType": "04"
           }
         }
       ]
     },
     "type": "object",
     "properties": {
       "ssn": {
         "encrypt": {
           "bsonType": "string",
           "algorithm": "AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic"
         }
       },
       "bloodType": {
         "encrypt": {
           "bsonType": "string",
           "algorithm": "AEAD_AES_256_CBC_HMAC_SHA_512-Random"
         }
       }
     }
   }

Configure SpEL Evaluation
--------------------------

The ``EntitySpelEvaluationExtension`` class enables evaluation of the SpEL expression.
The following code shows this class:

.. literalinclude:: /includes/integrations/spring-data-csfle/EntitySpelEvaluationExtension.java
    :language: java
    :start-after: // start-entity-spel-evaluation-extension
    :end-before: // end-entity-spel-evaluation-extension
    :dedent:

.. note::

   This class retrieves the DEKs and matches them with the
   ``target``. In this example, the ``target`` is
   ``PersonEntity``.

Generate JSON Schemas and Configure MongoClient
-----------------------------------------------

The following sections show how to generate JSON Schemas in a Spring Data MongoDB project.

Understand the Schema Generation Process
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To generate the JSON Schemas, you need the ``MappingContext``
entities that are created by the automatic
configuration of Spring Data. The automatic configuration creates
the ``MongoClient`` connection and the ``MongoTemplate``.

However, to create the ``MongoClient`` with automatic encryption
enabled, you need JSON Schemas.

The solution is to inject the JSON Schema creation in the
autoconfiguration process by instantiating the
``MongoClientSettingsBuilderCustomizer`` bean.

Configure the Secure MongoDB Client
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following code shows the ``MongoDBSecureClientConfiguration``
class:

.. literalinclude:: /includes/integrations/spring-data-csfle/MongoDBSecureClientConfiguration.java
   :language: java
   :start-after: // start-mongodb-secure-client-configuration
   :end-before: // end-mongodb-secure-client-configuration
   :dedent:

.. tip::

   If you want to use different backup retention policies for different
   clusters, you can store one DEK in each cluster. This lets you fully
   erase a DEK from a cluster and all backups, which might be required
   for legal compliance.
   
   For more information, see
   `CSFLE with the Java Driver <https://www.mongodb.com/developer/languages/java/java-client-side-field-level-encryption/>`__.

Implement the Schema Service
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following code shows the ``SchemaServiceImpl`` class, which
stores the generated JSON Schemas in a map:

.. literalinclude:: /includes/integrations/spring-data-csfle/SchemaServiceImpl.java
   :language: java
   :start-after: // start-schema-service-impl
   :end-before: // end-schema-service-impl
   :dedent:

The application stores its JSON Schemas because this template also implements
server-side JSON Schemas. This is a best practice for CSFLE.

Create or Update Encrypted Collections
---------------------------------------

Understand Server-Side JSON Schemas
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Only the client-side JSON Schemas are required for the Automatic
Encryption Shared Library. However, without server-side JSON
Schemas, another misconfigured client or an admin connected
directly to the cluster could insert or update documents without
encrypting the fields.

To prevent this, you can use the server-side JSON Schema to enforce
a field type in a document.

The JSON Schema changes with the different versions of your
application, so the JSON Schemas need to be updated each time you
restart your application.

Implement Encrypted Collections Setup
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following code shows the ``EncryptedCollectionsSetup`` class:

.. literalinclude:: /includes/integrations/spring-data-csfle/EncryptedCollectionsSetup.java
   :language: java
   :start-after: // start-encrypted-collections-setup
   :end-before: // end-encrypted-collections-setup
   :dedent:

Support Multiple Entities
-------------------------

The template in this guide can support any number of entities.

To add another type of entity, create the components of the
three-tier architecture as described in previous steps. Then, add the entity
to the ``EncryptedCollectionsConfiguration`` class, as shown in the following
example:

.. literalinclude:: /includes/integrations/spring-data-csfle/EncryptedCollectionsConfiguration.java
   :language: java
   :start-after: // start-encrypted-collections-configuration
   :end-before: // end-encrypted-collections-configuration
   :dedent:
   :emphasize-lines: 4

Because you added the ``@Encrypted(algorithm = "AEAD_AES_256_CBC_HMAC_SHA_512-Deterministic")``
annotation to fields in the entity class, the framework uses the server-side
JSON Schema to automatically generate the DEKs and create the encrypted collection.

Query by an Encrypted Field
---------------------------

This template implements the ``findFirstBySsn(ssn)`` method. You can
use this method to find a person's document by their Social Security number, even if
this field is encrypted.

.. note::

   This method works only because a deterministic encryption
   algorithm is used.

Implement the Person Repository
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following code shows the ``PersonRepository`` interface:

.. literalinclude:: /includes/integrations/spring-data-csfle/PersonRepository.java
   :language: java
   :start-after: // start-person-repository
   :end-before: // end-person-repository
   :dedent:

Additional Resources
--------------------

If you have questions, open an issue in the :github:`mongodb-java-spring-boot-csfle <mongodb-developer/mongodb-java-spring-boot-csfle>`
repository or ask a question in the `MongoDB Community Forum <https://www.mongodb.com/community/forums/c/data/java-frameworks/164>`__.

To learn more about CSFLE, see the following resources:

- `CSFLE with the Java Driver <https://www.mongodb.com/developer/languages/java/java-client-side-field-level-encryption/>`__
  (without Spring Data)
- `CSFLE MongoDB Documentation <https://www.mongodb.com/docs/manual/core/csfle/>`__
- `CSFLE Encryption Schemas <https://www.mongodb.com/docs/manual/core/csfle/reference/encryption-schemas/>`__
- `CSFLE Quick Start <https://www.mongodb.com/docs/manual/core/csfle/quick-start/>`__

To learn more about Spring Data MongoDB, see the following
resources:

- `Spring Data MongoDB Project <https://spring.io/projects/spring-data-mongodb>`__
- `Spring Data MongoDB Documentation <https://docs.spring.io/spring-data/mongodb/docs/current/reference/html/>`__
- `Baeldung Spring Data MongoDB Tutorial <https://www.baeldung.com/spring-data-mongodb-tutorial>`__
- `Spring Initializr <https://start.spring.io/>`__

You can view a version of this guide in video format on the
`MongoDB YouTube channel <https://www.youtube.com/watch?v=YePIQimYnxI>`__.
