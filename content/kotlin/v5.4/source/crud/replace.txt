.. _kotlin-replace-document:
.. _replace-operation:
.. _kotlin-usage-replaceone:

=================
Replace Documents
=================

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: replace,update, code example, filter

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

In this guide, you can learn how to use the {+driver-short+} to replace documents in a
MongoDB collection. A replace operation uses a query filter to match a document in a
collection, then replaces the document with a new one.

Replace One Document
--------------------

The `replaceOne() <{+driver-api+}/-mongo-collection/replace-one.html>`__
method removes all the existing fields and values in the
matching document (except the ``_id`` field) and inserts the fields and values from the
replacement document.

You can call the ``replaceOne()`` method on a ``MongoCollection``
instance as follows: 

.. code-block:: kotlin

    collection.replaceOne(<query>, <replacementDocument>)

If multiple documents match the query filter specified in
the ``replaceOne()`` method, the operation replaces the first result. You can
specify a sort in a ``ReplaceOptions`` instance to apply an order to
matched documents before the driver performs the replace operation, as
shown in the following code:

.. literalinclude:: /examples/generated/ChangeTest.snippet.replace-one-options.kt
   :language: kotlin

If zero documents match the query filter in the replace operation,
``replaceOne()`` makes no changes to documents in the collection. See
the :ref:`Upsert <kotlin-fundamentals-upsert>` guide to
learn how to insert a new document instead of replacing one if no
documents match.

.. important::

    The ``replaceOne()`` method cannot make changes to a document that
    violates unique index constraints on the collection. See the MongoDB
    Server manual for more information about :manual:`unique indexes </core/index-unique/>`.

Replace Operation Parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``replaceOne()`` method accepts the following parameters:

.. list-table::
   :widths: 30 70
   :header-rows: 1

   * - Parameter
     - Description

   * - ``filter``
     - A query filter that specifies the document to replace. For more information about
       query filters, see the
       :manual:`{+mdb-server-capital+} manual </core/document/#query-filter-documents>`.

       **Data Type:** `BSON <{+driver-api+}/-mongo-collection/replace-one.html>`__

   * - ``replacement``
     - A replacement document, which specifies the fields and values to insert in the new 
       document. If the documents in your collection are mapped to a {+language+} class,
       the replacement document can be an instance of this class. 

       **Data Type:** ``document: T`` 

   * - ``options``
     - *Optional.* An instance of the ``ReplaceOptions`` class that specifies the
       configuration for the replace operation. The default value is ``null``.

       **Data Type:** `ReplaceOptions <{+driver-api+}/-mongo-collection/replace-one.html>`__

Customize the Replace Operation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``replaceOne()`` method optionally accepts a ``ReplaceOptions`` object as a parameter,
which represents options you can use to configure the replace operation.

The ``ReplaceOptions`` class contains the following properties:

.. list-table::
   :widths: 30 70
   :header-rows: 1

   * - Property
     - Description

   * - ``bypassDocumentValidation``
     - Specifies whether the replace operation bypasses document validation. This lets you 
       replace documents that don't meet the schema validation requirements, if any 
       exist. See :manual:`the {+mdb-server-capital+} manual </core/schema-validation/#schema-validation>`
       for more information on schema validation.

       **Data Type:** `boolean <{+core-api+}/client/model/ReplaceOptions.html#upsert(boolean)>`__

   * - ``collation``
     - Specifies the kind of language collation to use when sorting
       results.

       **Data Type:** `Collation <{+core-api+}/client/model/Collation.html>`__

   * - ``comment``
     - Gets or sets the user-provided comment for the operation. 
       See :manual:`the {+mdb-server-capital+} manual</reference/command/update/#command-fields>`
       for more information.

       **Data Type:** `String
       <https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/String.html>`__
       or `BsonValue <{+api-root+}/bson/org/bson/BsonValue.html>`__

   * - ``hint``
     - Gets or sets the index to use to scan for documents. 
       See :manual:`the {+mdb-server-capital+} manual</reference/command/update/#std-label-update-command-hint>`
       for more information.

       **Data Type:** `Bson <{+api-root+}/bson/org/bson/conversions/Bson.html>`__

   * - ``hintString``
     - Gets or sets the index to use to scan for documents. 
       See :manual:`the {+mdb-server-capital+} manual</reference/command/update/#std-label-update-command-hint>`
       for more information.

       **Data Type:** `String
       <https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/String.html>`__

   * - ``upsert``
     - Specifies whether the replace operation performs an upsert operation if no 
       documents match the query filter. 
       See :manual:`the {+mdb-server-capital+} manual </reference/command/update/#std-label-update-command-upsert>`
       for more information.

       **Data Type:** `boolean <{+core-api+}/client/model/ReplaceOptions.html#upsert(boolean)>`__

   * - ``sort``
     - Determines which document the operation replaces if the query
       selects multiple documents, because the replace operation replaces
       the first document in the sort order specified. 

       **Data Type:** `Bson <{+api-root+}/bson/org/bson/conversions/Bson.html>`__

   * - ``let``
     - Gets or sets the let document to add top-level variables for the operation. 
       See :manual:`the {+mdb-server-capital+} manual </reference/command/update/#std-label-update-let-syntax>`
       for more information.

       **Data Type:** `Bson <{+api-root+}/bson/org/bson/conversions/Bson.html>`__

Return Value
~~~~~~~~~~~~

Upon successful execution, the ``replaceOne()`` method returns an ``UpdateResult``
instance. The ``UpdateResult`` class contains the following properties:

.. list-table::
   :widths: 30 70
   :header-rows: 1

   * - Property
     - Description

   * - ``wasAcknowledged``
     - Indicates whether the replace operation was acknowledged by MongoDB.

       **Data Type:** ``boolean``

   * - ``getMatchedCount``
     - The number of documents that matched the query filter, regardless of
       whether one was replaced. 

       **Data Type:** ``long``

   * - ``getModifiedCount``
     - The number of documents replaced by the replace operation. 

       **Data Type:** ``long``

   * - ``getUpsertedId``
     - The ID of the document that was upserted in the database, if the driver
       performed an upsert.

       **Data Type:** `BsonValue <{+api-root+}/bson/org/bson/BsonValue.html>`__

Exceptions
~~~~~~~~~~

If your replacement operation fails, the driver raises an exception.

For example, if the value of the ``_id`` field in your replacement document differs from
the value in the original document, the method throws the following
``MongoWriteException``:

.. code-block:: none
   :copyable: false

   After applying the update, the (immutable) field '_id' was found to have been altered to _id: ObjectId('...)

If your replacement document contains a change that violates unique index
rules, the method throws a ``MongoWriteException`` with an error
message similar to the following:

.. code-block:: none
   :copyable: false

   E11000 duplicate key error collection: ...

For more information on the types of exceptions raised under specific
conditions, see the API documentation for ``replaceOne()``, linked at the
bottom of this page.

Replace One Example
-------------------

A paint store sells five different colors of paint. The documents in the following collection represent paint colors
in the store's inventory:

.. code-block:: json

    { "_id": 1, "color": "red", "qty": 5 }
    { "_id": 2, "color": "purple", "qty": 8 }
    { "_id": 3, "color": "yellow", "qty": 0 }
    { "_id": 4, "color": "green", "qty": 6 }
    { "_id": 5, "color": "pink", "qty": 20 }

The following {+language+} data class models this data:

.. literalinclude:: /examples/generated/ChangeTest.snippet.data-model.kt
   :language: kotlin

The paint store must update their inventory to replace
20 cans of pink paint with 25 cans of orange paint. 

To update the inventory, call the ``replaceOne()`` method:

.. io-code-block::

   .. input:: /examples/generated/ChangeTest.snippet.replace-one.kt
      :language: kotlin

   .. output:: 
      :language:  console

        Matched document count: 1
        Modified document count: 1

The preceding replace operation creates the following document:

.. code-block:: json
   :copyable: false

    { "_id": 5, "color": "orange", "qty": 25 }

Advanced Replace One Example
----------------------------

In the following example, the ``replaceOne()`` method replaces the first match of the
query filter in the ``movies`` collection of the :atlas:`Atlas sample_mflix.movies dataset
</sample-data/sample-mflix>` with a replacement document. The operation deletes
all fields except ``_id`` from the original document and inserts the fields from the
replacement document. The following ``Movie`` data class models the documents in this
collection for use with the Kotlin driver:

.. literalinclude:: /examples/generated/AggregatesBuilderTest.snippet.movie-data-class.kt
   :language: kotlin

.. include:: /includes/fundamentals/builders-dataclass.rst

Before the ``replaceOne()`` operation runs, the original document contains
several fields describing the movie. After the operation runs, the resulting
document contains only the fields specified by the replacement document
(``title`` and ``fullplot``) and the ``_id`` field.

The following example uses the following objects and methods:

- A **query filter** that is passed to the ``replaceOne()`` method. The ``eq``
  filter matches only movies with the title exactly matching the text
  ``"Music of the Heart"``.

- A **replacement document** that contains the document that replaces the
  matching document, if it exists.

- A **ReplaceOptions** object with the ``upsert`` option set to ``true``.
  This option specifies that the method inserts the data contained in
  the replacement document if the query filter does not match any documents.

.. include:: /includes/connect-guide-note.rst

.. literalinclude:: /examples/generated/Replace.snippet.replace-usage-example.kt
   :language: kotlin

The preceding example returns the following output:

.. code-block:: none
   :copyable: false 

   Modified document count: 1
   Upserted id: null

If the preceding example resulted in an upsert, the code returns the following output:

.. code-block:: none
   :copyable: false

   Modified document count: 0
   Upserted id: BsonObjectId{value=...}

If you query the replaced document, the query returns the following output:

.. code-block:: none
   :copyable: false

   Movie(title=50 Violins, fullplot= A dramatization of the true story of Roberta Guaspari
   who co-founded the Opus 118 Harlem School of Music)

Additional Information
----------------------

To learn more about the methods and classes used on this page,
see the following API documentation:

- `ReplaceOne <{+driver-api+}/-mongo-collection/replace-one.html>`__
- `ReplaceOptions <{+core-api+}/client/model/ReplaceOptions.html?is-external=true>`__
- `UpdateResult <{+core-api+}/client/result/UpdateResult.html>`__
- `eq() <{+core-api+}/client/model/Filters.html#eq(java.lang.String,TItem)>`__
