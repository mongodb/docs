.. _streams-agg-pipeline-validate:

=============
``$validate``
=============

.. default-domain:: mongodb

.. meta::
   :keywords: atlas stream processing, $validate aggregation pipeline stage 
   :description: Learn how to use the $validate stage to provide schema enforcement 
                 for your streaming data
.. facet::
   :name: genre
   :values: reference

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: includes/atlas-sp/public-preview.rst

Definition
~~~~~~~~~~

The :pipeline:`$validate` stage checks streaming documents for 
conformity to a schema of expected ranges, values, or datatypes.

.. pipeline:: $validate

   A ``$validate`` pipeline stage has the following prototype form:

   .. code-block:: json

      {
        "$validate": {
          "validator": { <filter> },
          "validationAction" : "discard" | "dlq"
        }  
      }

Syntax
~~~~~~

The ``$validate`` stage takes a document with the following fields: 

.. list-table:: 
   :header-rows: 1
   :widths: 10 15 15 70

   * - Field 
     - Type 
     - Necessity 
     - Description

   * - ``validator``
     - document
     - Required
     - Document of expressions used to validate incoming messages
       against a user-defined schema. You can use all but the
       following :ref:`query operators <query-selectors>` to define 
       validation expressions:

       - ``$near``
       - ``$nearSphere``
       - ``$text``
       - ``$where``

   * - ``validationAction`` 
     - string
     - Optional 
     - Specifies the action to take when a message violates the
       user-defined schema. You can specify one of the following 
       values:

       - ``discard``: Discards the message. If you do not specify a 
         value for ``validationAction``, this is the default behavior.
       - ``dlq``: Logs the violation to the collection defined in your
         Stream Processor configuration and performs a best-effort 
         discard without transactional guarantees.


Behavior
~~~~~~~~

You can use ``$validate`` at any point in a pipeline after the 
``$source`` stage, and before the ``$emit`` or ``$merge`` stage.

If you specify either the ``discard`` or ``dlq`` options for the
``validationAction`` field, {+atlas-sp+} logs messages which fail
validation in the following format:

.. code-block:: json

   {
    "t": <datetime>,
    "s": "<severity-level>",
    "c": "streams-<job-name>",
    "ctx": "<processed-pipeline>",
    "msg": "<message-body>",
    "attrs": {
      <result-of-logAttributes-evaluation>
    },
    "tags": <array-of-strings>,
    "truncated": {
      <truncation-description>
    },
    "size": <size-of-entry>
  }

The following table describes the log entry fields:

.. list-table:: 
   :header-rows: 1
   :widths: 15 15 70

   * - Field 
     - Type 
     - Description

   * - ``attrs``
     - document 
     - Document containing the results of evaluating the 
       ``logAttributes`` field in the ``$validate`` definition. The
       result is a list of fields.

   * - ``c``
     - string 
     - Name of the specific stream processing job in which the 
       failure occurred. 

   * - ``ctx`` 
     - string
     - Name of the streaming data pipeline being processed.

   * - ``msg``
     - string
     - Body of the message that failed validation. 
     
.. Add the following back to the above field description when
   $validatedSource is added:
   If the log is generated by a :pipeline:`$validatedSource` stage, it
   includes additional metadata from the source stream.

   * - ``s`` 
     - string
     - Severity level of the validation failure.

   * - ``size`` 
     - integer
     - Original size of the message in bytes. Included only if
       the message was truncated on ingestion.

   * - ``t`` 
     - datetime
     - Timestamp of the validation failure event.

   * - ``tags`` 
     - array
     - Array of strings where each string is a tag on the message.

   * - ``truncated`` 
     - document
     - Document containing information about the truncation of the
       message.

{+atlas-sp+} supports only 
`JSON Schema Draft 4 <https://json-schema.org/specification-links.html#draft-4>`__
or earlier.

Validator Example
`````````````````

The following document shows an example validator expression using 
:manual:`$and </reference/operator/query/and/>` to perform a logical 
AND operation:

.. code-block:: json

  { 
    $validate: {
      validator: {
        $and: [{
          $expr: {
            $ne: [
              "$Racer_Name",
              "Pace Car"
            ]
          }
        },
        {
          $jsonSchema: {
            required: [ "Racer_Num", "Racer_Name", "lap", "Corner_Num", "timestamp" ],
            properties: {
              Racer_Num: {
                bsonType: "int",
                description: "'Racer_Num' is the integer number of the race car and is required"
              },
              Racer_Name: {
                bsonType: "string",
                description: "'Racer_Name' must be a string and is required"
              },
              lap: {
                bsonType: "int",
                minimum: 1,
                description: "'lap' must be a int and is required"
              },
              Corner_Num: {
                bsonType: "int",
                minimum: 1,
                maximum: 4,
                description: "'Corner_Num' must be a int between 1 and 4 and is required"
              },
              timestamp: {
                bsonType: "string",
                pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{6}$",
                description: "'timestamp' must be a string matching iso date pattern and is required"
              }
            }
          }
        }]
      }, validationAction : "dlq"
    }
  }

.. Commit 2de43ac of PR 4592 for DOCSP-30690 contains a description of
   the $validatedSource aggregation stage. At the time of this comment
   (26th of June, 2023) it is not slated for private preview and has
   been removed. Refer to the aforementioned commit for the text rather
   than rewriting the whole section when it's implemented.
