.. _scale-cluster:

====================
Modify a {+Cluster+}
====================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

You can modify your {+cluster+} after initial configuration.

- For a summary of available options, see :ref:`cluster-config-options`.

- For in-depth configuration steps, see :ref:`scale-cluster-open-dialog` and 
  the options that follow.

For more information about the impact, cost, and backup policy of your
{+cluster+} changes, see :ref:`cluster-config-considerations`.

.. _cluster-config-options:

|service| Configuration Options
-------------------------------
  
You can change the following options of your |service| {+cluster+}:

.. list-table::
   :widths: 20 40 40
   :header-rows: 1
   :stub-columns: 1

   * - Setting
     - Action
     - Limitations


   * - :ref:`Cluster Type <change-cluster-type>`
     
     - Change the {+cluster+} type.

     - You can only move from a shared {+cluster+} to a dedicated {+cluster+}.

   * - :ref:`Global Cluster Configuration <scale-cluster-global-config>`

     - Enable |global-write| for your {+cluster+} or change existing global
       {+cluster+} configurations.

     - After you enable |global-write| for a {+cluster+}, you can't disable
       them.

   * - :ref:`Cloud Provider & Region <scale-cluster-cloud-provider>`

     - Select a different provider to change the cloud provider for
       your {+dedicated-clusters+}. If you created an |service| cluster 
       on GCP or Azure before October 2020 when |service| added support 
       for multi-cloud clusters, changing to a different provider
       changes the connection string to your new {+cluster+}.

       Consider scheduling a time to :ref:`update your applications 
       with the new connection string <atlas-faq-migrate-providers>`
       to connect to the {+cluster+} again. |service| migrates data to 
       the new {+cluster+}.

     - Adding or moving a node to a region without the primary
       requires each newly migrated replica set member to perform an
       :manual:`initial sync </core/replica-set-sync>`

   * - :ref:`Deploy or Configure a multi-cloud, multi-region {+cluster+} <scale-cluster-region>`
     - Deploy or modify a multi-cloud, multi-region {+cluster+}.

     - None

   * - :ref:`Cluster Tier <scale-cluster-instance>`

     - Change the {+cluster+} tier.

     - If your {+cluster+} uses :ref:`NVMe storage <nvme-storage>`,
       |service| must perform an
       :manual:`initial sync </core/replica-set-sync>`.

   * - :ref:`Cluster Storage Options <create-cluster-storage>`

     - Change the storage options for the {+cluster+} tier.

       .. include:: /includes/autoscale-oplog.rst

     - Clusters using |nvme| storage have a fixed size for each {+cluster+}
       tier.

   * - :ref:`Cluster Autoscaling Options <cluster-autoscaling>`

     - Change the {+cluster+}'s autoscaling options.

     - None

   * - :ref:`MongoDB Version <scale-cluster-version>`

     - Upgrade the major MongoDB version of the {+cluster+}.

     - You can't downgrade the MongoDB version.

   * - :ref:`Deploy a Sharded {+Cluster+} <scale-cluster-sharding>`

     - Upgrade a replica set to a sharded {+cluster+}.

     - You can't reverse this upgrade.

       |service| allows Sharded Clusters for ``M30`` or larger
       clusters.

       .. include:: /includes/cluster-settings/convert-to-sharded-cluster-limitations.rst

   * - :ref:`Modify the Number of Shards <scale-cluster-shardNum>`

     - Set the number of shards for a sharded {+cluster+}.

     - Removing a shard takes some time. Any subsequent MongoDB
       configuration changes start after |service| removes the shard.

       .. include:: /includes/fact-reduce-shards-warning.rst

       |service| allows Sharded Clusters for ``M30`` or larger
       clusters.

   * - :ref:`Enable or Disable Backup <scale-cluster-backups>`

     - Enable or disable backups for the {+cluster+}.

     - |service| enables backups for M2 and M5 {+clusters+} automatically.
       You can't disable backup for clusters on those tiers.

   * - :ref:`Enable or Disable the Business Intelligence Connector <create-cluster-enable-bi>`

     - Enable or disable the |bic| for this {+cluster+}.

       .. include:: /includes/extracts/cluster-option-bi-cluster-requirements.rst

     - None

   * - :ref:`Manage your own encryption keys <scale-cluster-enable-encryption>`

     - Enable or disable using your own encryption keys with this
       {+cluster+}.

     - None

Click :ref:`Apply Changes <scale-cluster-payment>` when complete.

.. _cluster-config-considerations:

Considerations
--------------

Migration, Availability, and Performance Impact
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Making changes to a {+cluster+} often requires migrating to new
servers and storage volumes. The time required for an
:term:`initial sync` and resynchronizing data across storage volumes
increases linearly with the amount of data in the {+cluster+}.

The following migrations require an :term:`initial sync`:

- Upgrades from a {+free-clusters+} or {+shared-clusters+} (``M0``, ``M2``, and ``M5``
  {+clusters+}) to a higher {+cluster+} tier.

- Changes to :ref:`NVMe storage volumes <nvme-storage>`. NVMe clusters
  auto-scale to the next higher tier when 90% of the available storage
  space is consumed, and the migration requires an initial sync.

- Changes from general to NVMe storage volumes.

- Changes from NVMe to general storage.

- For clusters deployed to |azure|, changes to the 
  :ref:`storage-class-ui` require an :term:`initial sync`.

To maximize availability:

- For a replica set, |service| migrates one node at a time, starting
  with the secondary nodes first and then the primary.

- For a sharded {+cluster+}, |service| performs the migration of the shards
  independently of each other. For each shard (i.e. replica set),
  |service| migrates one node at a time, starting with the secondary
  nodes first and then the primary.

:manual:`Retryable writes </core/retryable-writes>` should prevent any
write errors during the election of a new primary. On average, an
election can take five seconds.

Migration can affect performance if your primary is already reaching
operational capacity: each newly migrated replica set node must
perform an :term:`initial sync` from the primary, adding to the
operational load. Migrations can also affect performance if you set
:manual:`read preferences </core/read-preference>` to read from
secondaries: the replica set is down one secondary during the
migration.

.. include:: /includes/fact-auto-index.rst

.. Note to writers: beginning in v20160712, a {+cluster+} tier change
.. with no disk change does not require an initial sync

Billing
~~~~~~~

As you change your {+cluster+}, you can compare the costs of different
options before applying them. The :guilabel:`Cluster Overview` box
displays the cost of the selected configuration, excluding data
transfer.

.. important:: {+Free-Clusters+}

   Upgrading an ``M0`` {+free-cluster+} to an ``M2`` or greater paid
   tier {+cluster+} starts billing for the {+cluster+}. See :doc:`billing` for
   complete documentation on |service| billing.

The following sections provide complete documentation for each of the
|service| {+cluster+} scaling configuration options.

Backup
~~~~~~

.. include:: /includes/fact-continuous-backup-transition.rst

.. _scale-cluster-open-dialog:

Open the :guilabel:`Editing {+Cluster+}` Dialog
-----------------------------------------------

For the {+cluster+} you want to modify, click the ellipses :guilabel:`...`
icon, then select :guilabel:`Edit Configuration`.

Alternatively, if you are already viewing the specific {+cluster+},
click the :guilabel:`Configuration` button.

For ``M0`` {+free-clusters+}, you can also click the
:guilabel:`Upgrade` button for the {+cluster+}.

.. _change-cluster-type:

Modify the Cluster Type
-----------------------

If you have a shared {+cluster+}, you can change it to a dedicated {+cluster+}. 
This allows you to upgrade your ``M0``, ``M2``, or ``M5`` {+cluster+}
to an ``M10+`` {+cluster+}. 

At the top of your configuration settings, click the :guilabel:`Dedicated` tab 
to begin changing your {+cluster+} to a dedicated {+cluster+}. Then, 
:ref:`select your preferred cluster tier <scale-cluster-instance>`. 
Dedicated {+clusters+} have more configuration options than shared {+clusters+}.

.. note:: Considerations

   - You can't change a dedicated {+cluster+} to a shared {+cluster+}. 

   - You can't change {+clusters+} to serverless instances or migrate 
     serverless instances to {+clusters+}.

   For a full list of serverless instance limitations, 
   see :ref:`serverless-instance-limitations`
  
.. _scale-cluster-global-config:

Modify the :guilabel:`Global {+Cluster+} Configuration`
------------------------------------------------------

.. important::

   You can't disable |global-write| for a {+cluster+} once deployed.

You can enable global writes for your {+cluster+} or modify
existing global {+cluster+} configurations.

.. seealso::

   - :ref:`global-clusters`.
   - :ref:`create-new-global-write-cluster`.

.. _scale-cluster-region:
.. _scale-cluster-cloud-provider:

Modify the :guilabel:`Cloud Provider & Region`
----------------------------------------------

.. note:: Considerations

   .. include:: /includes/fact-modify-cloud-provider.rst

- To view the current cloud providers and regions for this {+cluster+},
  select :guilabel:`Cloud Provider & Region`.

- To modify the cloud providers and regions applied to this {+cluster+},
  follow the procedures on :ref:`deploy-across-multiple-regions`.

- To upgrade from an |service| free- or {+shared-cluster+}, select
  from the available cloud providers.

.. seealso::

   - :ref:`create-cluster-cloud-provider-region`.
   - :ref:`move-cluster`.

.. _scale-cluster-storage:
.. _scale-cluster-instance:

Modify the :guilabel:`Cluster Tier`
-----------------------------------

You can change the {+cluster+} tier, as well as the memory, storage,
and |iops| (speed) specifications for the selected {+cluster+}.

.. note:: {+Free-Cluster+} and {+Shared-Cluster+} Considerations

   - You can't downgrade an ``M10`` or larger {+cluster+} to an
     ``M0`` {+free-cluster+} or ``M2/M5`` {+shared-cluster+}.

   - Changing the {+cluster+} tier requires downtime in the following 
     scenarios:
     
     - You change from an ``M0`` {+free-cluster+} or ``M2/M5``
       {+shared-cluster+} to an ``M10`` or larger {+cluster+} tier.
  
     - You change from an ``M0`` {+free-cluster+} to an ``M2/M5`` {+shared-cluster+}.
       
     - You change from an ``M2`` {+shared-cluster+} to an ``M5`` 
       {+shared-cluster+}.
     
     To prevent data corruption, halt write operations to your cluster 
     for the duration of your upgrade.

Select your preferred {+cluster+} tier. The selected instance size dictates
the memory, storage, and |iops| specification for each data-bearing
server [#data-bearing]_ in the {+cluster+}.

.. warning::

   Upgrading from a tenant (free or shared) tier to a {+dedicated-cluster+}
   tier:

   - deletes the current {+cluster+}
   - deletes any backup snapshots for that {+cluster+}

   To keep your existing snapshots,
   :doc:`download those snapshots </backup/cloud-backup/restore>`.

.. seealso::

   - :ref:`retention-policy`
   - :ref:`create-cluster-instance`

From the :guilabel:`Cluster Tier` section, you can also:

- :ref:`create-cluster-storage`

- :ref:`Configure Autoscaling Options <cluster-autoscaling>`

Modify :guilabel:`Additional Settings`
--------------------------------------

You can set the following options:

- :ref:`scale-cluster-version`
- :ref:`scale-cluster-backups`
- :ref:`scale-cluster-sharding`
- :ref:`scale-cluster-shardNum`
- :ref:`scale-cluster-enable-bi`
- :ref:`scale-cluster-enable-encryption`
- :ref:`scale-cluster-more-configuration-options`

.. _scale-cluster-version:

Upgrade the MongoDB Version of the {+Cluster+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-upgrade-best-practices.rst

1. Select :guilabel:`Additional Settings` to view the currently
   configured MongoDB version for the {+cluster+}.

   .. include:: /includes/extracts/fact-mongodb-version-downgrade-restriction-scale.rst

2. From the :guilabel:`Select a version` dropdown, select the new
   MongoDB version.

   |service| supports the following upgrade paths:

   - MongoDB 3.6 -> MongoDB 4.0
   - MongoDB 4.0 -> MongoDB 4.2
   - MongoDB 4.2 -> MongoDB 4.4
   - MongoDB 4.4 -> MongoDB 5.0
   - MongoDB 5.0 -> Latest Release

   .. note::

      If you enabled backup for your {+cluster+} and want to upgrade to
      MongoDB 4.2 or later, you must enable
      :doc:`/backup/cloud-backup/overview` if
      :doc:`{+Old-Backup+}s </backup/legacy-backup/overview>` are
      currently enabled.

.. _scale-cluster-sharding:

Scale your Replica Set to a Sharded {+Cluster+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/cluster-settings/convert-to-sharded-cluster-limitations.rst

To deploy your {+cluster+} as a :term:`sharded {+cluster+} <sharded cluster>`,
toggle :guilabel:`Shard your {+cluster+} (M30 and up)` to ``Yes``.

.. include:: /includes/fact-upgrade-to-sharded-cluster-warning.rst

.. seealso::

   :ref:`create-cluster-sharding`.

.. _scale-cluster-shardNum:

Modify the :guilabel:`Number of Shards`
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/cluster-option-clusterShardingNum.rst

.. _scale-cluster-backups:

Enable or Disable Backup for the {+Cluster+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Backups are automatically enabled for ``M2`` and ``M5`` {+shared-clusters+}
and can't be disabled.

.. seealso::

   :ref:`m2-m5-snapshots`.

To enable backups for an ``M10+`` |service| {+cluster+}, toggle
:guilabel:`Turn on {+Cloud-Backup+} (M10 and up)` to ``Yes``.
If enabled, |service| takes snapshots of your databases at
regular intervals and retains them according to your project's
:ref:`retention policy <retention-policy>`.

For detailed descriptions of the available backup options, see
:ref:`create-cluster-backups`.

.. _scale-cluster-enable-bi:

Enable or Disable |bic| for the {+Cluster+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To enable :bic:`BI Connector for Atlas </>` for this {+cluster+}, toggle
:guilabel:`Enable Business Intelligence Connector (M10 and up)` to
:guilabel:`Yes`.

.. seealso::

   :ref:`create-cluster-enable-bi`.

.. _scale-cluster-enable-encryption:

Enable Encryption at Rest
~~~~~~~~~~~~~~~~~~~~~~~~~

To enable |service| Encryption at Rest for this cluster using your 
|kms|, toggle :guilabel:`Manage your own encryption keys (M10 and up)` 
to :guilabel:`Yes`. To learn more, see 
:ref:`create-cluster-enable-encryption`.

.. note::

   All changes to :manual:`customer KMS </security-kms-encryption>`
   require an :manual:`initial sync </core/replica-set-sync/>`.

.. _scale-cluster-more-configuration-options:

Configure Additional Configuration Options
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Configure additional options for your {+cluster+} from this section.

For details on these options, see
:ref:`create-cluster-more-configuration-options`.

.. _scale-cluster-payment:

Review and Apply Your Changes
-----------------------------

Click :guilabel:`Review Changes` to review the changes you have made.

The :guilabel:`Review Changes` page displays a complete side-by-side
summary of the modified attributes with any warnings or notes
pertaining to the changes. The original attribute settings are listed
on the left and the corresponding new settings with changes in pricing
are listed on the right.

|service| displays all warnings and notes related to the change at the
top. These include changes that:

- Can't be rolled back
- Require an :manual:`initial sync </core/replica-set-sync/>`
- Result in expected delays in execution, increase in workload, or
  downtime.

Once you have reviewed the changes, click :guilabel:`Apply Changes` to
apply them to your {+cluster+}.

If you are upgrading from an ``M0`` {+free-cluster+}, |service|
prompts you to enter payment information before applying your changes.

.. include:: /includes/footnote-databearing.rst

.. _convert-replset-to-sharded:

Convert a Replica Set to a Sharded Cluster
------------------------------------------

You can convert a :term:`replica set <replica set>` to a :term:`sharded 
cluster <sharded cluster>`. 

Prerequisites 
~~~~~~~~~~~~~

To convert your replica set to a sharded {+cluster+}:

- Your {+cluster+} must be an ``M10+`` {+cluster+}.
- You must have the :authrole:`Project Cluster Manager` or higher role.

Procedure 
~~~~~~~~~

.. include:: /includes/steps/convert-replset-to-sharded-cluster.rst
