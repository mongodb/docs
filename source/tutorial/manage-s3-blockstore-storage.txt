=====================================
Manage S3 Blockstore Snapshot Storage
=====================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-backup-snapshot-store-options.rst

This tutorial covers backing up your MongoDB databases as snapshots
stored in S3 and S3-compatible buckets. The metadata for
:term:`S3 snapshot stores <S3 Snapshot Store>` is stored in a MongoDB
database.

.. include:: /includes/note-add-capacity-using-multiple-stores.rst

Considerations
--------------

S3 Blockstore Can't Be Moved
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you create an |s3| blockstore, you cannot move it to another |s3| bucket.
If you need to use a different |s3|
bucket to host your |s3| blockstore, you must create a new |s3|
blockstore in that |s3| bucket.


Storage API Support
~~~~~~~~~~~~~~~~~~~

MongoDB supports endpoints for:

- |aws| |s3| :aws:`API </AmazonS3/latest/API/Welcome.html>`
- IBM `Cloud Object Storage <https://developer.ibm.com/recipes/tutorials/cloud-object-storage-s3-api-intro/>`_ `API <https://ibm-public-cos.github.io/crs-docs/index.html>`__
- Dell EMC `Elastic Cloud Storage <https://www.Dell EMC.com/en-us/storage/ecs/index.htm#collapse=>`_ `API <https://www.emc.com/techpubs/ecs/ecs_s3_supported_features-1.htm>`__.

IBM and Dell EMC support a subset of the full |aws| |s3| |api|.

You can use other |s3|-compatible endpoints. |mms| attempts to validate
these endpoints when you save the |s3| blockstore setup. If validation
passes, |mms| saves the configuration. If validation fails, |mms| displays
an error and doesn't save the configuration.

Prerequisites
-------------

Metadata Storage Prerequisites
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- :doc:`Deploy the dedicated MongoDB instance(s) </tutorial/prepare-backing-mongodb-instances>`
  to serve the :term:`S3 snapshot store <S3 Snapshot Store>` metadata
  and :term:`Oplog Store <Oplog Store Database>`. Serve these
  instances on the same hosts as the |onprem| server, the
  :term:`backing databases`, or snapshot stores. Attach storage
  volume(s) with enough capacity to store the databases these
  instances manage.

- Ensure the host serving the |onprem| :term:`Backup Daemon` service
  has enough capacity to store the :term:`head` database.

- Secure the instance that stores your
  :term:`S3 snapshot store <S3 Snapshot Store>` metadata database
  using :ref:`authentication <configure-auth-backing>` and
  :ref:`SSL <configure-ssl-backing>`. S3 snapshot store metadata
  databases support :manual:`all authentication mechanisms </reference/connection-string#urioption.authMechanism>`.

AWS S3 Storage Prerequisites
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Make sure you have an
   :aws:`IAM user </IAM/latest/UserGuide/id_users_create.html>`
   on |aws|.

#. Create your own
   `AWS access keys <https://aws.amazon.com/developers/access-keys/>`_
   for your |iam| user. This allows you to create |s3| buckets and
   store snapshot files in them. MongoDB does not create or issue |aws|
   access keys.

#. Create your own
   :aws:`S3 bucket </AmazonS3/latest/dev/UsingBucket.html#create-bucket-intro>`
   to store your :term:`S3 snapshot store <S3 Snapshot Store>`
   snapshots.

   .. note::
      The |iam| user for which you created the |aws| access keys must
      :aws:`own </AmazonS3/latest/user-guide/set-bucket-permissions.html>`
      the |aws| |s3| Bucket.

IBM Cloud Object Storage Prerequisites
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Create an Access Key and Secret Key using IBM credential tools.
#. Create your own S3-compatible bucket.

DellEMC Elastic Cloud Storage Prerequisites
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Create an Access Key and Secret Key from your `ECS User ID <https://www.emc.com/techpubs/ecs/ecs_s3_supported_features-1.htm#GUID-D21EE42B-CA1D-4425-A29D-386320CAD31A>`_.
#. Create your own S3-compatible bucket.

Other S3-Compatible Storage
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Other |s3|-compatible endpoints can be used. |mms| attempts to validate
these endpoints when you save the configuration. If validation passes,
the configuration is saved. If validation fails, |mms| displays an
error and the configuration is not saved.

.. _add-s3-blockstore:

Add an S3 Blockstore
--------------------

.. include:: /includes/steps/admin-add-s3-blockstore.rst

.. _edit-s3-blockstore:

Edit an Existing S3 Blockstore
------------------------------

Once created, S3 snapshot stores are listed directly on the
:guilabel:`Snapshot Storage` page in a table. Each row contains the
settings for each S3 blockstore.

.. include:: /includes/steps/admin-edit-s3-blockstore.rst

.. _delete-s3-blockstore:

Delete an S3 Blockstore
-----------------------

.. include:: /includes/steps/admin-delete-s3-blockstore.rst
