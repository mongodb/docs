=======================================
Restore a Sharded Cluster from a Backup
=======================================

.. default-domain:: mongodb

Overview
--------

When you restore a cluster from a backup, |mms| provides you with a
restore files for the selected restore point. For an overview of the
restore process, please see :doc:`/core/restore-overview`.

Prerequisites
-------------

Client Requests During Restoration
++++++++++++++++++++++++++++++++++

.. include:: /includes/considerations-restore-in-isolation.rst

Snapshots when Agent Cannot Stop Balancer
+++++++++++++++++++++++++++++++++++++++++

|mms| displays a warning next to cluster snapshots taken while the
:term:`balancer <balancer>` is enabled. If you restore from such a
snapshot, you run the risk of lost or orphaned data. For more information,
see :ref:`snapshot-while-balancer-enabled`.

Procedures
----------

Perform the following procedures in sequence. If you choose to have |mms|
automatically restore your snapshot, you will perform only the first few
steps of the first procedure, at which point you will be instructed to
skip the rest of the steps and procedures.

If you choose to manually restore the backup, perform all the procedures
below, in sequence. You will select the snapshot, distribute the restore
files to the target servers, start and configure each shard's replica set,
and then start and configure the cluster.

Select the Snapshot
+++++++++++++++++++

.. include:: /includes/steps/download-snapshot-sharded-cluster.rst

Restore Each Shard's Primary
++++++++++++++++++++++++++++

For *all* shards, restore the primary. You must have a copy of the
snapshot on the server that provides the primary:

.. include:: /includes/steps/restore-primary.rst

Restore All Secondaries
+++++++++++++++++++++++

After you have restored the primary for a shard you can restore all
secondaries. You must have a copy of the snapshot on all servers that
provide the secondaries:

.. include:: /includes/steps/restore-secondary.rst

Restore Each Config Server
++++++++++++++++++++++++++

Perform this procedure separately for each :term:`config server`. Each
config server must have a copy of the tar file with the config server
data.

.. include:: /includes/steps/restore-config-server.rst

Start the ``mongos``
++++++++++++++++++++

Start the cluster's :program:`mongos` bound to your new config servers.
