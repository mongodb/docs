.. _release-notes-8.1:

=============================
Release Notes for MongoDB 8.1
=============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: twocols

.. include:: /includes/in-dev.rst

.. include:: /includes/rapid-release.rst

Aggregation
-----------

Aggregation Accumulators
~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, the following aggregation accumulators are 
available:

- :group:`$concatArrays`
- :group:`$setUnion`

Aggregation Stages
~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, the following aggregation stages
are available:

- :pipeline:`$listClusterCatalog`

$geoNear Improvements
~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, some previously failing 
:pipeline:`$geoNear` queries with hidden 2d or
2dsphere indexes will now succeed. In previous
releases, some ``$geoNear`` queries 
used to unnecessarily fail with an ``IndexNotFound``
error when they included a hidden index due to 
confusion over which index to use.

$merge Missing Fields
~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, if the :pipeline:`$merge` aggregation stage's
:ref:`supporting index <merge-on-supporting-index>` is not
sparse, the fields specified for the :ref:`on <merge-on>`
option can be missing or contain a null value.

Stable API
----------

Starting in MongoDB 8.1, the :dbcommand:`renameCollection` command and
corresponding shell method, :method:`db.collection.renameCollection()`,
are included in :ref:`Stable API <stable-api>` V1.

General Changes 
---------------

Query Statistics
~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, query statistics are collected and reported for
:dbcommand:`count` and :dbcommand:`distinct` commands. For details, see
:ref:`queryStats-count-query-shape` and
:ref:`queryStats-distinct-query-shape`.

Improved Accuracy for Operation Duration Metric
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, the ``durationMillis`` metric reported in
:ref:`slow query logs <log-message-json-examples-slow-op>` accounts for
time spent processing authorization and parsing the command. As a
result, ``durationMillis`` more closely reflects the full command
duration.

``serverStatus`` Metrics
~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1 (and 8.0.4 and 7.0.14), the :serverstatus:`indexStats` 
section of the :dbcommand:`serverStatus` command output tracks indexes in 
``prepareUnique`` state.

MongoDB 8.1 adds the following server status metrics:

- ``maxTimestampEligibleForTruncate`` in
  :serverstatus:`changeStreamPreImages.purgingJob`
- :serverstatus:`metrics.ttl.invalidTTLIndexSkips`
- :serverstatus:`metrics.repl.timestamps`
- :serverstatus:`metrics.repl.timestamps.oldestTimestamp`
- :serverstatus:`query.planning.fastPath.express`
- :serverstatus:`query.planning.fastPath.idHack`
- :serverstatus:`metrics.abortExpiredTransactions.successfulKills`
- :serverstatus:`metrics.abortExpiredTransactions.timedOutKills`
- :serverstatus:`wiredTiger.version`

Add Comments to Query Settings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1 (and 8.0.4), you can use
:dbcommand:`setQuerySettings` to add comments to query settings. For
example, add a comment that indicates why you added query settings.

Slow Query Metrics for Disk Spilling
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. |disk-spilling-intro| replace:: Starting in MongoDB 8.1, :ref:`log messages for slow queries <log-message-slow-ops>`

.. include:: /includes/disk-spilling-metrics-overview.rst

.. list-table::
   :header-rows: 1
   :widths: 10 20

   * - Metric
     - Description

   * - ``<executionPart>Spills``
     - Number of times the corresponding query execution stage wrote
       temporary files to disk

   * - ``<executionPart>SpilledBytes``
     - Size, in bytes, of the memory released by writing temporary files
       to disk
     
   * - ``<executionPart>SpilledDataStorageSize``
     - Size, in bytes, of disk space used for temporary files

   * - ``<executionPart>SpilledRecords``
     - Number of records written to temporary files on disk

For more information on writing temporary files to disk, see
:method:`~cursor.allowDiskUse()`.

Server Parameters
~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, the following server parameters are available:

- :parameter:`enableAutoCompaction`
- :parameter:`upsertMaxRetryAttemptsOnDuplicateKeyError`
- :parameter:`AbortExpiredTransactionsSessionCheckoutTimeout`
- :parameter:`JWKSMinimumQuiescePeriodSecs`
- :parameter:`catalogCacheCollectionMaxEntries`
- :parameter:`catalogCacheDatabaseMaxEntries`
- :parameter:`catalogCacheIndexMaxEntries`

Inconsistency Types
~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, the following inconsistency types are 
available:

- :data:`CollectionAuxiliaryMetadataMismatch` 

``connectionStatus`` Connection UUID
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, you can access the currently connected client's 
UUID through :data:`connectionStatus.authInfo.UUID`.

Validate Command Index Specifications Output
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, the :dbcommand:`validate` command includes
index specifications in the :data:`validate.indexDetails` output field.

Validation Action for Handling Invalid Documents
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Starting in MongoDB 8.1, you can set your schema's ``validationAction`` 
option to ``errorAndLog``, in which MongoDB rejects any insert or update that 
violates the validation criteria and logs the error to the ``mongod`` log file.

For more information, see :ref:`schema-validation-handle-invalid-docs`.

Disk Space
~~~~~~~~~~

Starting in MongoDB 8.1 (and 8.0.5), if disk space is running low,
MongoDB will fail queries that are spilling to disk.

.. toctree::
   :titlesonly:
   :hidden:
   
   Compatibility Changes </release-notes/8.1-compatibility>
   Changelog </release-notes/8.1-changelog>
