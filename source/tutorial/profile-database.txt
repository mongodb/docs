=================
Profile Databases
=================

.. default-domain:: mongodb

.. only:: cloud

   .. note:: **Available only with Cloud Manager Premium**. This feature is
      available only with Cloud Manager Premium, which comes with certain
      MongoDB subscriptions. `Contact MongoDB <https://www.mongodb.com/contact>`_
      for more information.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

A :manual:`database profiler </tutorial/manage-the-database-profiler>`
gathers statistics about writes, cursors, and commands on one running
:program:`mongod` instance.

|mms| can collect and display statistics from any of your
:program:`mongod` instances that have profiling enabled. |mms| displays this
data in the :guilabel:`Profiler` section of an instance's :guilabel:`Metrics` 
page.

- To enable a given :program:`mongod`\'s profiler and have |mms| collect its
  profiling data, see the :ref:`enable-profiling-through-automation`
  procedure.

- To allow |mms| to collect profiling data from a :program:`mongod` instance
  that has profiling enabled, see the :ref:`enable-profiling-manually`
  procedure.

- To enable or disable |mms| profiling data collection for all instances in
  the project, see :ref:`group-settings-page`.

.. _considerations-profile-database:

Considerations
--------------

.. important:: Please read the following considerations before enabling profiling.

Security
~~~~~~~~

Profile data may include sensitive information including the content of
database queries. Ensure that exposing this data to |mms| is consistent
with your information security practices.

``system.profile`` Collection
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The MongoDB profiler stores data in the :data:`system.profile
<<database>.system.profile>` collection. This is a :term:`capped collection
<capped collections>` with a 1 MB default size. You may increase the size of
this collection up to 4 MB.

When collecting data from the profiler, |mms| ignores data about operations on
the :data:`system.profile <<database>.system.profile>` collection, such as
Monitoring Agent queries of the :data:`system.profile <<database>.system.profile>` 
collection.

Resource Consumption Impact
~~~~~~~~~~~~~~~~~~~~~~~~~~~

The profiler consumes resources which may slow MongoDB performance.
Consider the resource impact before enabling profiling.

Data Collection
+++++++++++++++

Every minute, the agent queries the :data:`system.profile
<<database>.system.profile>` collection for the last 20 documents created. The
agent sends
:manual:`those documents </reference/database-profiler>` to |mms|.

.. seealso::

   :manual:`Database Profiler </tutorial/manage-the-database-profiler>` 
   in the MongoDB Manual.

|mms| samples profile documents until it samples either all documents returned
or 4 MB of returned document data. This 4 MB limit may be reached if you
increase the collection's size to 4 MB *and* your database creates large
:manual:`profiler documents </reference/database-profiler>`.

The Monitoring Agent tries to minimize its effect on the monitored systems. If
polling profile data slows database performance, |mms| throttles how often it
collects data.

.. admonition:: Leaking Cursors with Monitoring Agent version **earlier than 3.8.0.230**
   :class: important

   If the agent authenticates as a user containing the
   :authrole:`clusterAdmin` role, the agent might leak cursors if you enable
   profiling. A leaked cursor automatically times out on the server after 10
   minutes.

Data Display
++++++++++++

|mms| displays no more than 10,000 data points in the :guilabel:`Profiler`
charts.

Time to Propagate Changes to the Automation Agent
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

With profiling enabled, configuration changes made in |mms| can
take up to 2 minutes to propagate to the agent and 1 more minute before
profiling data appears in the |mms| interface.

Rolling Restart of ``mongod`` Processes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-profiling-restart-mongods.rst

.. _enable-profiling-through-automation:

Enable Profiling and the Collection of Profiling Data
-----------------------------------------------------

.. include:: /includes/steps/profiling-enable-through-automation.rst

.. _enable-profiling-manually:

Enable Collection of Profiling Data
-----------------------------------

This procedure enables |mms| to collect profiling data from a
:program:`mongod` instance. Separate from enabling |mms|, you must enable each
instance's profiler, either upon deployment or through the
:manual:`setProfilingLevel </reference/method/db.setProfilingLevel>` command.
If you are using Automation, set the ``profile`` option under
:guilabel:`Advanced Options` to enable profiling upon deployment.

To enable collection of profiling data from an instance's active
profiler:

.. include:: /includes/steps/profiling-enable.rst

