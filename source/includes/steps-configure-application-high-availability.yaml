title: Configure a load balancer with the pool of |application| hosts.
stepnum: 1
level: 4
ref: configure-load-balancer
pre: |
   Configure the load balancer to perform a health check on each 
   |onprem| health API endpoint:

   .. code-block:: sh

      http://<OpsManagerHost>/monitor/health

   |onprem| responds with one of two |http| codes:

   .. list-table::
      :widths: 30 70
      :header-rows: 1

      * - HTTP Status Code
        - Health Status

      * - 200
        - |onprem| host and :term:`application database` appear 
          healthy.

      * - 500
        - |onprem| host or :term:`application database` appear 
          unhealthy.

          .. seealso::

             If this endpoint returns ``HTTP 500`` often, review the 
             :doc:`/troubleshooting` section.

   The load balancer must not return cached content.
---
title: "Configure |onprem| to use the load balancer."
stepnum: 2
level: 4
ref: update-load-balanced-url
content: |
  a. In |mms|, click :guilabel:`Admin`, then the :guilabel:`General` tab, and
     then :guilabel:`Ops Manager Config`.

  b. Configure the :setting:`URL to Access Ops Manager` property to point to
     the load balancer URL.

  c. Set the :setting:`Load Balancer Remote IP Header` property to the name of
     the HTTP header field the load balancer uses to identify the client's IP
     address.
---
title: "Update each |application| server with the replication hosts information."
stepnum: 3
level: 4
ref: update-replication-hosts
pre: |
  On each server, edit the ``conf-mms.properties`` file to
  set the :setting:`mongo.mongoUri` property to the :manual:`connection string
  </reference/connection-string/>` of the :ref:`mms-application-database`. You
  *must* specify at least **3** hosts in the :setting:`mongo.mongoUri`
  connection string. For example:
action:
  language: ini
  code: |
    mongo.mongoUri=mongodb://<mms0.example.net>:<27017>,<mms1.example.net>:<27017>,<mms2.example.net>:<27017>/?maxPoolSize=100
---
title: "On each server, manually update the :ref:`mmsBaseUrl <mmsBaseUrl>`
       property in the Automation Agent configuration file to point to the
       load balancer."
stepnum: 4
level: 4
ref: update-centralUrl-automation
action:
  language: json
  code: |
     mmsBaseUrl=<LOAD-BALANCER-URL>:<PORT>
content: |

   See :doc:`Automation Agent Configuration </reference/automation-agent>`
   for the name and location of the configuration file for your platform.
---
title: "On each server, manually update the :ref:`mmsBaseUrl <mmsBaseUrl>`
       property in the configuration file for the Monitoring Agent to point
       to the load balancer."
stepnum: 5
level: 4
ref: update-centralUrl-monitoring
action:
  language: json
  code: |
     mmsBaseUrl=<LOAD-BALANCER-URL>:<PORT>
content: |

   .. note::

      Perform this step only for Monitoring Agents that are not managed
      by the Automation Agent.

   See :doc:`Monitoring Agent Configuration </reference/monitoring-agent>`
   for the name and location of the configuration file for your platform.
---
title: "On each server, manually update the ``mothership`` property
       in the configuration file for the Backup Agent to point
       to the load balancer."
level: 4
ref: update-centralUrl-backup
stepnum: 6
action:
  language: json
  code: |
     mothership=<LOAD-BALANCER-URL>:<PORT>
content: |

   .. note::

      Perform this step only for Backup Agents that are not managed by the
      Automation Agent. 

   See :doc:`Backup Agent Configuration </reference/backup-agent>`
   for the name and location of the configuration file for your platform.
---
title: "Start one of the |application-s|."
stepnum: 7
level: 4
ref: start-app
pre: |
  For example, if you installed the |application| with an
  ``rpm`` or ``deb`` package, issue the following:
action:
  language: sh
  code: |
    service mongodb-mms start
---
title: "Copy the ``gen.key`` file."
stepnum: 8
ref: copy-gen-key
level: 4
content: |
  The ``gen.key`` file is located in ``/etc/mongodb-mms/`` for
  installations from a package manager and in ``${HOME}/.mongodb-mms/``
  for installations from an archive.

  Copy the ``gen.key`` file from the running |application|'s server to the
  appropriate directory on the other |application| servers.
---
title: "Start the remaining |application-s|."
stepnum: 9
level: 4
ref: start-other apps
...
