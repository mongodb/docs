==========================================
Configure a Highly Available |application|
==========================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

The |application| provides high availability through
use of multiple |application| servers behind a load balancer
and through use of a :term:`replica set`
to host the :ref:`mms-application-database`.

Multiple |application| Servers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The |application|'s :ref:`components <mms-application-package>` are
stateless between requests. Any |application| server can
handle requests as long as all the servers read from the same |application|
Database. If one |application| becomes unavailable, another
fills requests.

To take advantage of this for high availability, configure a load balancer
to balance between the pool of |application| servers. Use the load
balancer of your choice. The load balancer must not return cached content.

In |mms|, set the :setting:`URL to Access Ops Manager` property to the load
balancer URL. Set the :setting:`Load Balancer Remote IP Header` property to
the HTTP header field the load balancer uses to identify the originating
client's IP address (for example, ``X-Forwarded-For``).
The |application| uses the client's IP address for auditing,
logging, and white listing for the API.

Replica Set for the |application| Database
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Deploy a :term:`replica set` rather than a standalone to host the
:ref:`mms-application-database`.
Replica sets have automatic :manual:`failover
</core/replica-set-high-availability>` if the :term:`primary` becomes
unavailable.

If the replica set has members in multiple facilities, ensure
that a single facility has enough votes to elect a :term:`primary` if
needed. Choose the facility that hosts the core application systems. Place
a majority of voting members and all the members that can become primary
in this facility. Otherwise, network partitions could prevent the set from
being able to form a majority. For details on how replica sets elect
primaries, see :manual:`Replica Set Elections
</core/replica-set-elections>`.

You can create backups of the replica set using :manual:`file system
snapshots </tutorial/backup-with-filesystem-snapshots>`. File system
snapshots use system-level tools to create copies of the device that holds
replica set's data files.

To deploy the replica set that hosts the |application| Database, see
:doc:`backing MongoDB instance </tutorial/prepare-backing-mongodb-instances>`.

.. _gen-key:

The ``gen.key`` File
~~~~~~~~~~~~~~~~~~~~

An identical 24-byte binary key file called ``gen.key`` must be stored
on every |onprem| server to encrypt and decrypt |onprem|\'s backing
databases and user credentials.

The ``gen.key`` file can be generated automatically, when |onprem|
starts for the first time, or manually using a software tool that
generates key files.

.. example::

   To generate the ``gen.key`` file manually with the ``openssl`` tool:

   .. code-block:: sh

      openssl rand 24 > /<keyPath>/gen.key

   .. note:: 

      The ``openssl`` tool is not a MongoDB product. Refer to the
      ``openssl`` web site for usage.

After you create the ``gen.key`` file on one |onprem| server but
*before* starting the other |onprem| servers, you must copy that key
file to the other |onprem| servers to the appropriate directory:

* ``/etc/mongodb-mms/`` for RPM or Ubuntu installations

* ``<installPath>/.mongodb-mms/`` for an archive (``.tar``) file
  installations

* ``<installPath>\MMSData\Secrets`` for Microsoft Windows Server
  installations

.. important::

   * Any shared storage resource that stores the ``gen.key`` file
     should be configured for high availability so as not to introduce
     a potential single point of failure.

   * Any |onprem| server that does not have the ``gen.key`` file
     installed cannot connect to the backing databases and become part
     of an HA |onprem| instance.

   * Once you have generated the ``gen.key`` for your |onprem| instance
     on the first |onprem| server, back up the ``gen.key`` file to a
     secure location.

Prerequisites
-------------

Deploy the replica set that hosts the :ref:`mms-application-database`.
To deploy a replica set, see 
:manual:`Deploy a Replica Set </tutorial/deploy-replica-set>` in the
MongoDB manual.

Procedure
---------

The following procedure assumes you will let one of the |application|\ s
create the ``gen.key``. If you instead create your own ``gen.key``,
distribute it to the servers before starting any of the |application|\ s.

.. important::

   The load balancer placed in front of the |application| servers must not
   return cached content. The load balancer must have caching turned off.

To configure multiple |application|\ s with load balancing:

.. include:: /includes/steps/configure-application-high-availability.rst

Additional Information
----------------------

For information on making |mms| Backup highly available, see
:doc:`/tutorial/configure-backup-high-availability`.
