============================
Migrate with ``mongomirror``
============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

:binary:`~bin.mongomirror` is a utility for migrating data from an existing
MongoDB replica set to a MongoDB |service| replica set.
:binary:`~bin.mongomirror` does not require you to shut down your existing replica
set or applications.

.. include:: /includes/mongomirror-support.rst

.. important::

   :binary:`~bin.mongomirror` does not import user/role data.

Download ``mongomirror``
------------------------

.. include:: /includes/list-table-mongomirror-downloads.rst

Prerequisites
-------------

Source
~~~~~~

- The source MongoDB deployment must be a replica set. If the source is
  a standalone MongoDB deployment, convert to a replica set first to
  use :binary:`~bin.mongomirror`. See
  :manual:`Convert a Standalone to a Replica Set
  </tutorial/convert-standalone-to-replica-set/>`.

- The source replica set must run MongoDB version 2.6 through 4.2.

- The source MongoDB replica set cannot be an
  ``M0`` (Free Tier) or ``M2/M5`` shared cluster.

- You should not change the ``featureCompatibilityVersion`` flag
  at any time during the procedure.

- .. include:: /includes/fact-mongomirror-namespace-changes.rst

  Contact MongoDB Support if you believe renaming or dropping
  a collection needs to occur during the migration process. From
  the |service| UI, click :guilabel:`Support` to open a
  support ticket.

Required Access on Source Replica Set
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the source replica set requires authentication, you must include
user credentials when running :binary:`~bin.mongomirror`. You must
specify a database user with, at a minimum, the following privileges:

- Read all databases and collections. The :authrole:`readAnyDatabase`
  role on the ``admin`` database covers this requirement.

- Read the oplog.

- Run the :dbcommand:`getParameter` command.

If no such user exists, create the user in your source MongoDB
replica set. Different MongoDB server versions have different
built-in roles. Select a built-in role based on your MongoDB
server version and execute the appropriate commands in the
:binary:`~bin.mongo` shell:

.. include:: /includes/mongomirror-required-roles.rst

Target
~~~~~~

- The target |service| cluster must be a replica set.

- The target |service| cluster should not contain any namespaces that
  overlap with the source cluster. If ``mongomirror`` detects
  overlapping namespaces on the target cluster it errors out before
  the migration process begins. If your target cluster contains
  overlapping namespaces, you can either:

  - Run :binary:`~bin.mongomirror` with the :option:`--drop` option
    to delete all non-system data from the target cluster, or

  - Use the :option:`--includeNamespace` option to specify particular
    namespaces to import from the source cluster.

- The target |service| cluster cannot be an ``M0`` (Free Tier),
  ``M2``, or ``M5`` shared cluster.

- The target |service| cluster MongoDB version must be the same as
  or later than the source cluster MongoDB version.

- You should not change the ``featureCompatibilityVersion`` flag
  at any time during the procedure.

- .. include:: /includes/fact-mongomirror-ttl-indexes.rst

Procedure
---------

.. include:: /includes/steps/migrate-using-mongomirror-1.rst

When you start :binary:`~bin.mongomirror`:

#. First, :binary:`~bin.mongomirror` performs an initial sync, copying
   collections from the existing MongoDB replica set to the target
   cluster in |service|. :binary:`~bin.mongomirror` does not copy the
   ``config`` database.

   .. note::

      Starting in version 0.5.0, :binary:`~bin.mongomirror` builds
      all indexes on the destination cluster in the foreground,
      regardless of how the indexes were built on the source
      cluster. Foreground index builds block all other operations on
      the database. For more information on foreground index builds,
      see :manual:`Index Build Operations on a Populated Collection
      </core/index-creation>`.

#. After the initial sync, :binary:`~bin.mongomirror` continuously
   tails the replica set's oplog for incoming changes and replays
   them on the target cluster in MongoDB |service|.

Once started, :binary:`~bin.mongomirror` runs continuously until you shut
down the process. To fully migrate to the |service|, continue on to
:ref:`mongomirror-migrate-to-atlas` steps.

.. _mongomirror-migrate-to-atlas:

Switch to |service|
-------------------

After the :binary:`~bin.mongomirror` has performed the initial sync and has
been tailing the replica set's oplog,  to switch over to |service|
cluster:

.. include:: /includes/steps/migrate-using-mongomirror-2.rst

Additional Information
----------------------

For more information on ``mongomirror``, including behavior,
options, and examples, see the :doc:`mongomirror reference page
</reference/mongomirror/>`.

.. class:: hidden

   .. toctree::
      :titlesonly:

      /reference/mongomirror
      /release-notes/mongomirror
      /reference/mongomirror-old-versions
