
==============================================
Read and Write with the {+data-api+} (Preview)
==============================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. toctree::
   
   {+data-api+} Resources </api/data-api-resources>

The |service-fullname| {+data-api+} lets you read and write data in
|service| with standard HTTPS requests. The API includes endpoints that
create, read, update, delete, and aggregate documents in your cluster.
To use the {+data-api+}, all you need is an HTTPS client and a valid API
key.

The {+data-api+} is not a direct connection to your database. Instead,
the API is a fully-managed middleware service that sits between your
cluster and client apps. Clients send requests to specific endpoints,
which each represent a MongoDB operation. For each request, the
{+data-api+} authorizes the request, decodes and runs the database
operation, and then returns the results of the operation in an HTTPS
response.

For example, this :mdn:`POST <Web/HTTP/Methods/POST>` request stores a
document in |service| by calling the ``insertOne`` endpoint:

.. io-code-block::
   
   .. input::
      :language: bash
      
      curl --request POST \
        'https://data.mongodb-api.com/app/data-xtest/endpoint/data/beta/action/insertOne' \
        --header 'Content-Type: application/json' \
        --header 'Access-Control-Request-Headers: *' \
        --header 'api-key: TpqAKQgvhZE4r6AOzpVydJ9a3tB1BLMrgDzLlBLbihKNDzSJWTAHMVbsMoIOpnM6' \
        --data-raw '{
            "dataSource": "Cluster0",
            "database": "learn-data-api",
            "collection": "hello",
            "document": {
              "text": "Hello from the {+data-api+}!",
            }
        }'
   
   .. output::
      :language: json
      :visible: true
      
      {"insertedId":"5f1a785e1536b6e6992fd588"}

When to Use the {+data-api+}
----------------------------

You can use the {+data-api+} to integrate |service| into any apps and
services that support HTTPS requests. For example, you might:

- call the API from a serverless edge function
- access test data and log events in a CI/CD workflow
- integrate Atlas into a federated API gateway
- connect from an environment not currently supported via a MongoDB
  Driver or Realm SDK

An operation called through an API endpoint will likely take longer than
the corresponding MongoDB operation called through a connected MongoDB
Driver. For high-load use-cases and latency sensitive applications, we
recommend connecting directly to your database with a MongoDB driver. To
learn more, visit the :driver:`MongoDB Drivers </>` documentation.

Get Started
-----------

Follow the steps below to set up the {+data-api+} and send your first requests.

.. _enable-data-api:

1. Enable the {+data-api+}
~~~~~~~~~~~~~~~~~~~~~~~~~~

The {+data-api+} is disabled by default. To use the API, you need to
turn it on in the {+atlas-ui+} for one or more clusters.

Click :guilabel:`{+data-api+}` in the left navigation menu. On the
following screen, select one or more clusters that you want to enable
the API on from the dropdown menu and then click :guilabel:`Enable the
{+data-api+}`.

.. note::
   
   You can enable or disable the {+data-api+} for a cluster at any time
   from the :guilabel:`{+data-api+}` screen.

.. _create-data-api-key:

2. Create a {+data-api+} Key
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The {+data-api+} uses project-level API keys to manage access and
prevent unauthorized requests. Every request must include a valid
{+data-api+} key.

A {+data-api+} key grants full read and write access every collection in
a cluster and can access any enabled cluster in the project.

.. important::
   
   {+data-api+} keys are not the same as the :ref:`programmatic API keys
   <atlas-prog-api-key>` used to access the |service| and Realm
   Administration APIs.

Click :guilabel:`Create API Key`, enter a unique name for the new key,
and then click :guilabel:`Create API Key`.

You can now see and copy your new API key for the first and only time.
Once you close the modal, |service| will never expose the value again.

Copy the new API key and store it somewhere safe where you can reference
it later. {+data-api+} keys are sensitive, so make sure not to hardcode
them directly into user-facing apps or commit them to version control. 

.. tip::

   You can delete a {+data-api+} key at any time. Any request that
   includes a deleted key will fail. You might delete a key to prevent
   an existing client from continuing to use the API or if you
   accidentally expose the key and need to replace it.

.. _send-data-api-request:

3. Send a {+data-api+} Request
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You include your {+data-api+} key when you call action endpoints that
read and write documents in MongoDB. For a list of all available actions
& endpoints, see :ref:`data-api-resources`.

You can run the following commands in a shell to make sure everything
works and then start exploring:

.. tip::

   Make sure to replace placeholder values before you run each request:
   
   - ``<{+data-api+} App ID>``: Your {+data-api+} App ID, which you can
     find in the :guilabel:`URL Endpoint` section of the UI.

   - ``<{+data-api+} key>``: The {+data-api+} key you just created.

   - ``<cluster name>``: The name of a cluster with the {+data-api+}
     enabled.

A. Insert a test document:

   .. code-block:: bash
      
      curl --request POST \
        'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
        --header 'Content-Type: application/json' \
        --header 'Access-Control-Request-Headers: *' \
        --header 'api-key: <{+data-api+} Key>' \
        --data-raw '{
            "dataSource": "<cluster name>",
            "database": "learn-data-api",
            "collection": "people",
            "document": {
              "name": "John Sample",
              "age": 42
            }
        }'

B. Then, find the test document that you just inserted:

   .. code-block:: bash
      
      curl --request POST \
        'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/findOne' \
        --header 'Content-Type: application/json' \
        --header 'Access-Control-Request-Headers: *' \
        --header 'api-key: <{+data-api+} Key>' \
        --data-raw '{
            "dataSource": "<cluster name>",
            "database": "learn-data-api",
            "collection": "people",
            "filter": { "name": "John Sample" }
        }'

C. Finally, delete the test document:

   .. code-block:: bash
      
      curl --request POST \
        'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/deleteOne' \
        --header 'Content-Type: application/json' \
        --header 'Access-Control-Request-Headers: *' \
        --header 'api-key: <{+data-api+} Key>' \
        --data-raw '{
            "dataSource": "<cluster name>",
            "database": "learn-data-api",
            "collection": "people",
            "filter": { "name": "John Sample" }
        }'

.. _data-api-ejson-responses:

Extended JSON Responses
-----------------------

By default, the {+data-api+} encodes response body content in |json|.
MongoDB stores data as |bson| and uses :manual:`MongoDB Extended JSON
</reference/mongodb-extended-json/>`, or EJSON, to
represent types that do not exist in the JSON format.
To translate MongoDB EJSON data into JSON responses, the {+data-api+}
translates fields into JSON values when possible and
omits the values of EJSON fields that have no JSON equivalent.

The following table shows how JSON and EJSON can differ in responses
from the {+data-api+}:

.. list-table::
   :header-rows: 1
   :widths: 15 42 42
   
   * - Type
     - EJSON Representation
     - JSON Representation
   
   * - ``Array``
     
     - .. code-block:: json
          :copyable: false

          [ <elements> ]
     
     - .. code-block:: json
          :copyable: false

          [ <elements> ]

   * - ``Binary``
     
     - .. code-block:: json
          :copyable: false

          {
             "$binary": {
                "base64": "e67803a39588be8a95731a21e27d7391",
                "subType": "05"
             }
          }
     
     - .. code-block:: json
          :copyable: false

          {
             "Subtype": 5,
             "Data": "e67803a39588be8a95731a21e27d7391"
          }

   * - ``Date``
     
     - .. code-block:: json
          :copyable: false

          {
             "$date": {
                "$numberLong": "1641954803067"
             }
          }
     
     - .. code-block:: json
          :copyable: false

          "2022-01-12T02:33:23.067Z"

   * - ``Decimal128``
     
     - .. code-block:: json
          :copyable: false

          { "$numberDecimal": "9823.1297" }
     
     - .. code-block:: json
          :copyable: false

          "9823.1297"

   * - ``Document``
     
     - .. code-block:: json
          :copyable: false

          { <content> }
     
     - .. code-block::
          :copyable: false

          { <content> }

   * - ``Double``
     
     - .. code-block:: json
          :copyable: false

          {
             "$numberDouble": "10.5"
          }
     
     - .. code-block:: json
          :copyable: false

          10.5
   * - ``Int32``
     
     - .. code-block:: json
          :copyable: false

          {"$numberInt":"10"}
     
     - .. code-block:: json
          :copyable: false

          10

   * - ``Int64``
     
     - .. code-block:: json
          :copyable: false

          {"$numberLong":"50"}
     
     - .. code-block:: json
          :copyable: false

          50

   * - ``MaxKey``
     
     - .. code-block:: json
          :copyable: false

          { "$maxKey": 1 }
     
     - .. code-block:: json
          :copyable: false

          {}

   * - ``MinKey``
     
     - .. code-block:: json
          :copyable: false

          { "$minKey": 1 }
     
     - .. code-block:: json
          :copyable: false

          {}

   * - ``ObjectId``
     
     - .. code-block:: json
          :copyable: false

          {
             "$oid":"5d505646cf6d4fe581014ab2"
          }
     
     - .. code-block:: json
          :copyable: false

          "5d505646cf6d4fe581014ab2"

   * - ``Regular Expression``
     
     - .. code-block:: json
          :copyable: false

          {
             "$regularExpression": {
                "pattern":"^H",
                "options":"i"
             }
          }
     
     - .. code-block:: json
          :copyable: false

          {
             "Pattern": "^H",
             "Options": "i"
          },

   * - ``Timestamp``
     
     - .. code-block:: json
          :copyable: false

          {
             "$timestamp": {
                "t":1565545664,
                "i":1
              }
          }
     
     - .. code-block:: json
          :copyable: false

          {
             "T": 1565545664,
             "I": 1
          }

.. important::

   EJSON values with no JSON equivalent, such as ``MinKey`` and ``MaxKey``,
   translate to an empty document (``{}``).


To avoid any field value translations or omissions, configure the
{+data-api+} to respond with EJSON. Use the ``Accept``
header to control the response type:

.. tabs::

    .. tab:: JSON
       :tabid: json
 
       ``Accept`` header value:

       .. code-block::

          application/json

       Example request and response:

       .. io-code-block::

          .. input::
             :language: bash
             
             curl --request POST \
               'https://data.mongodb-api.com/app/data-xtest/endpoint/data/beta/action/findOne' \
               --header 'Content-Type: application/json' \
               --header 'Accept: application/json' \
               --header 'Access-Control-Request-Headers: *' \
               --header 'api-key: TpqAKQgvhZE4r6AOzpVydJ9a3tB1BLMrgDzLlBLbihKNDzSJWTAHMVbsMoIOpnM6' \
               --data-raw '{
                   "dataSource": "Cluster0",
                   "database": "learn-data-api",
                   "collection": "hello",
                   "filter": {
                     "_id": { "$oid" : "428bce77527c32e0f6f930e8"},
                   }
               }'
          
          .. output::
             :language: json
             :visible: true
      
             {
                "Name": "Mango",
                "Year": 2022,
                "Weight": {},
                "Date": "2022-01-12T02:33:23.067Z"
             }


    .. tab:: EJSON
       :tabid: ejson
 
 
       ``Accept`` header value:
 
       .. code-block::
 
          application/ejson

       Example request and response:
 
       .. io-code-block::
 
          .. input::
             :language: bash
             
             curl --request POST \
               'https://data.mongodb-api.com/app/data-xtest/endpoint/data/beta/action/findOne' \
               --header 'Content-Type: application/json' \
               --header 'Accept: application/ejson' \
               --header 'Access-Control-Request-Headers: *' \
               --header 'api-key: TpqAKQgvhZE4r6AOzpVydJ9a3tB1BLMrgDzLlBLbihKNDzSJWTAHMVbsMoIOpnM6' \
               --data-raw '{
                   "dataSource": "Cluster0",
                   "database": "learn-data-api",
                   "collection": "hello",
                   "filter": {
                     "_id": { "$oid" : "428bce77527c32e0f6f930e8"},
                   }
               }'
          
          .. output::
             :language: json
             :visible: true
      
             {
                "Name": "Mango",
                "Year": { "$numberLong": "2022" },
                "Weight": { "$numberDecimal": "9823.1297" },
                "Date": { "$date": { "$numberLong": "1641954803067" } }
             }

.. _data-api-ejson-requests:

Extended JSON Requests
----------------------

The {+data-api+} uses canonical :manual:`MongoDB Extended JSON
</reference/mongodb-extended-json/>` to encode BSON data types in
request bodies.

The following sections demonstrate how to define EJSON types in your
requests.

Binary
~~~~~~

To specify a binary value, use ``$binary`` with the value encoded in
Base64 and a `BSON subtype <https://bsonspec.org/spec.html>`_ encoded as
a two-character hexadecimal string:

.. code-block:: bash
   :emphasize-lines: 11-16
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "data": {
             "$binary": {
               "base64": "46d989eaf0bde5258029534bc2dc2089",
               "subType": "05"
             }
           }
         }
     }'

Date
~~~~

To specify a date, use ``$date`` with the `UNIX timestamp in
milliseconds <https://currentmillis.com/>`_ as a 64-bit integer:

.. code-block:: bash
   :emphasize-lines: 11
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "createdAt": { "$date": { "$numberLong": "1638551310749" } }
         }
     }'

Decimal128
~~~~~~~~~~

To specify a 128-bit decimal, use ``$numberDecimal`` with the decimal
value as a string:

.. code-block:: bash
   :emphasize-lines: 11
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "accountBalance": { "$numberDecimal": "128452.420523" }
         }
     }'

Double
~~~~~~

To specify a 64-bit signed floating point value (commonly referred to as
a "double"), use ``$numberDouble`` with the integer value as a string:

.. code-block:: bash
   :emphasize-lines: 11
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "temperatureCelsius": { "$numberDouble": "23.847" }
         }
     }'


Int64
~~~~~

To specify a 64-bit signed integer value, use ``$numberLong`` with the
integer value as a string:

.. code-block:: bash
   :emphasize-lines: 11
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "population": { "$numberLong": "8047923148" }
         }
     }'

Int32
~~~~~

To specify a 32-bit signed integer value, use ``$numberInt`` with the
integer value as a string:

.. code-block:: bash
   :emphasize-lines: 11
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "coins": { "$numberInt": "2147483647" }
         }
     }'

ObjectId
~~~~~~~~

To specify an ObjectId value, use ``$oid`` with the ID as a byte string:

.. code-block:: bash
   :emphasize-lines: 11
   :copyable: false
   
   curl --request POST \
     'https://data.mongodb-api.com/app/<{+data-api+} App ID>/endpoint/data/beta/action/insertOne' \
     --header 'Content-Type: application/json' \
     --header 'Access-Control-Request-Headers: *' \
     --header 'api-key: <{+data-api+} Key>' \
     --data-raw '{
         "dataSource": "<cluster name>",
         "database": "<database name>",
         "collection": "<collection name>",
         "document": {
           "_id": { "$oid": "61f02ea3af3561e283d06b91" }
         }
     }'

Request Logs
------------

The {+data-api+} logs all requests and stores the logs for 30 days.

You can view them on the :guilabel:`Data API` screen in the :guilabel:`Logs` tab.

Request Limitations
-------------------

The {+data-api+} enforces the following limitations on all requests:

- Incoming requests may not exceed 18 MB.
- Response body content may not exceed 16 MB.
- Request processing time may not exceed 90 seconds.

Billing
-------

The {+data-api+} uses the same usage-based pricing as MongoDB Realm
applications. For details, see :realm:`MongoDB Realm Billing
</billing>`.

{+data-api+} usage is billed based on the following dimensions:

- **Requests:** Every action adds one request to your billed total
  regardless of whether or not the action is successful.

- **Compute:** Every action bills for time and memory that the server
  uses to process the action. The exact usage depends on your workload.

- **Data Transfer:** Every action bills for data returned to the caller
  in the response. The response may include the result set of the action
  or metadata that describes the result of the action.
