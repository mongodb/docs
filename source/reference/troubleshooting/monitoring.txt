==========
Monitoring
==========

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol


.. "Ops Manager Installation:"

.. include:: /includes/extracts/troubleshooting-onprem-installation.rst

Alerts
------

For resolutions to alert conditions, see also :doc:`/tutorial/nav/alert-resolutions`.

For information on creating and managing alerts, see
:doc:`/tutorial/manage-alert-configurations` and
:doc:`/tutorial/manage-alerts-and-events`.

Cannot Turn Off Email Notifications
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There are at least two ways to turn off alert notifications:

- Remove the deployment from your |mms| account. See :doc:`/tutorial/unmanage-deployment`.

- Disable or delete the alert configuration. See
  :doc:`/tutorial/manage-alert-configurations`.

- Turn off alerts for a specific host. See
  :ref:`manage-host-alerts`.

Receive Duplicate Alerts
~~~~~~~~~~~~~~~~~~~~~~~~

If the notification email list contains multiple email-groups, one or
more people may receive multiple notifications of the same alert.

.. _open-file-limits:

Receive "Host has low open file limits" or "Too many open files" error messages
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These error messages appear on the :guilabel:`Deployment` page, under
a host's name. They appear if the number of available connections does
not meet the |mms|-defined minimum value. These errors are not
generated by the :binary:`~bin.mongos` instance and, therefore, not
appear in :binary:`~bin.mongos` log files.

On a host by host basis, the {+magent+} compares the number of
open file descriptors and connections to the maximum connections
limit. The max open file descriptors ulimit parameter directly affects
the number of available server connections. The agent calculates
whether or not enough connections exist to meet the |mms|\-defined
minimum value.

In ping documents, for each node and its ``serverStatus.connections``
values, if the sum of the ``current`` value plus the ``available``
value is less than the ``maxConns`` configuration value set for a
monitored host, the {+magent+} will send a
:guilabel:`Host has low open file limits` or
:guilabel:`Too many open files` message to |mms|.

Ping documents are data sent by {+magent+}s to |mms|. To view
ping documents:

.. include:: /includes/extracts/admonition-pii-user-role.rst

#. Click the :guilabel:`Deployment` page.

#. Click the host's name.

#. Click :guilabel:`Last Ping`.

To prevent this error, we recommend you set ``ulimit`` open files to
``64000``. We also recommend setting the ``maxConns`` command in the
|mongo| shell to at least the recommended settings.

To learn more, see
:manual:`the MongoDB ulimit reference page </reference/ulimit>` and
the :manual:`the MongoDB maxConns reference page </reference/configuration-options/#maxConns>`.

.. cond:: onprem

   Deployments
   -----------

   {+magent+} Fails to Collect Data
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   Possible causes for this state:

   - If the {+magent+} can't connect to the server because of
     networking restrictions or issues (i.e. firewalls, proxies,
     routing.)

   - If your database is running with SSL. You must enable SSL either
     globally or on a per-host basis. To learn more, see
     :doc:`/tutorial/configure-monitoring-agent-for-ssl` and
     :doc:`/tutorial/enable-ssl-for-a-deployment`.

   - If your database is running with authentication. You must supply
     |mms| with the authentication credentials for the host. See
     :doc:`/tutorial/edit-host-authentication-credentials`.

   Deployments are not Visible
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~

   Problems with the {+magent+} detecting deployments can be
   caused by a few factors:

   Deployment not added
   ++++++++++++++++++++

   To fix this issue:

   1. Click :guilabel:`Deployment`.
   #. Click the :guilabel:`Processes` tab
   #. Click :guilabel:`Add Deployment`.
   #. In the :guilabel:`New Deployment` window, specify the:

      - deployment type
      - internal hostname
      - internal port.

   #. If appropriate, add: 

      - Add the database username and password.
      - Enable |tls-ssl| SSL to connect with your {+magent+}. 

   .. note::

      It is not necessary to restart your {+magent+} when
      adding (or removing) a deployment.

   Accidental duplicate :binary:`~bin.mongod`\s
   ++++++++++++++++++++++++++++++++++++++++++++

   If you add the deployment after a crash and restart the
   {+magent+}, you might not see the hostname on the
   :guilabel:`Deployment` page. |mms| detects the deployment as a
   duplicate and suppresses its data. 

   To reset:

   1. Click :guilabel:`Settings`.
   #. Click :guilabel:`Project Settings`.
   #. Click :guilabel:`Reset Duplicates`.

   {+magent+}s cannot detect deployments
   ++++++++++++++++++++++++++++++++++++++++++++

   If your deployments exist across multiple data centers, make sure
   that all of your deployments can be discovered by all of your
   {+magent+}s.

   Cannot Delete a Deployment
   ~~~~~~~~~~~~~~~~~~~~~~~~~~

   In rare cases, the :binary:`~bin.mongod` is brought down and the
   replica set is reconfigured. The down deployment cannot be deleted
   and returns an error message:

   .. warning:: 
      This deployment cannot be deleted because it is enabled 
      for backup.

   Contact MongoDB Support for help in deleting these deployments.


Projects
--------

Additional Information on Projects
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Create a project to monitor additional segregated systems or
environments for servers, agents, users, and other resources.

.. example::

   Firewalls may separate your deployment among two or more
   environments. In this case, you would need two or more separate
   |mms| projects.

|api| keys are unique to each project. Each project requires its own agent with the appropriate |api| keys. Within each project, the agent needs to be able to connect to all hosts it monitors in the project.

To learn more about creating and managing projects, see
:doc:`/tutorial/manage-projects`.

.. _troubleshooting-munin:

Munin
-----

.. important::

   As of {+aagent+} 2.7.0, hardware monitoring using ``munin-
   node`` is deprecated.

   ``munin-node`` is a third-party package. For problems related to
   installing ``munin-node``, see the
   `Munin Wiki <http://munin-monitoring.org/wiki>`_.

Install and configure the ``munin-node`` service on the MongoDB
server(s) to be monitored before starting |mms| monitoring. The |mms|
agent's ``README`` file provides guidelines to install ``munin-node``.

.. seealso::
   See :doc:`/tutorial/configure-monitoring-munin-node/` for details
   about monitoring hardware with ``munin-node``.

Red Hat Enterprise Linux (RHEL 6, 7) can generate the following error
messages.

:guilabel:`No package munin-node is available` Error
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To correct this error:

1. Follow the instructions on the
   `Extra Packages for Enterprise Linux repository <https://fedoraproject.org/wiki/EPEL/FAQ #How_can_I _install_the_packages_from_the_EPEL_software_repository.3F>`_
   wiki page to install the ``epel-release rpm`` for your version of your enterprise Linux.

2. After the package is installed, type this command to install
   ``munin-node`` and all of its dependencies:

   .. code-block:: sh

      sudo yum install munin-node

3. After the ``munin-node`` is installed, check to see if the
   ``munin-node`` service is running. If it is not, type these
   commands to start the ``munin-node`` service.

   .. code-block:: sh

      service munin-node status
      service munin-node start

Non-localhost IP Addresses are Blocked
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default, munin blocks incoming connections from non-localhost IP
addresses. The ``/var/log/munin/munin-node.log`` file will display a
"Denying connection" error for your non-localhost IP address.

To fix this error, open the ``munin-node.conf`` configuration file and
comment out these two lines:

.. code-block:: sh

   allow ^127\.0\.0\.1$
   allow ^::1$

Then add this line to the ``munin-node.conf`` configuration file with
a pattern that matches your subnet:

.. code-block:: sh

   cidr_allow 0.0.0.0/0

Restart ``munin-node`` after editing the configuration file for
changes to take effect.

"# Unknown service" Error Returned
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Verifying iostat and other plugins/services can return this error.

The first step is to confirm there is a problem. Open a telnet session
and connect to ``iostat``, ``iostat_ios``, and ``cpu``:

.. code-block:: sh

   telnet HOSTNAME 4949 <default/required munin port>
   fetch iostat
   fetch iostat_ios
   fetch cpu

The ``iostat_ios`` plugin creates the ``iotime`` chart. The ``cpu``
plugin creates the ``cputime`` chart.

If any of these telnet ``fetch`` commands returns an
``# Unknown Service`` error, create a link to the plugin or service in
``/etc/munin/plugins/`` by typing these commands:

.. code-block:: sh

   cd /etc/munin/plugins/
   sudo ln -s /usr/share/munin/plugins/<service> <service>

Replace ``<service>`` with the name of the service that generates the
error.

Disk names are not listed by Munin
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In some cases, Munin will omit disk names with a dash between the name
and a numerical prefix like ``dm-0`` or ``dm-1``. There is
`a documented fix`_ for Munin's iostat plugin.

.. _`a documented fix`: https://bugs.launchpad.net/ubuntu/+source/munin/+bug/493982
