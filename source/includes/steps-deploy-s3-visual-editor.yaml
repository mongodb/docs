level: 4
ref: select-dataset-s3
source: 
  file: steps-adf-deploy-source.yaml
  ref: select-datasets
content: |
  Click :guilabel:`Add Data Sources` to select your data store.
---
title: "Specify your data store."
level: 4
ref: specify-data-store
content: | 
  Choose :guilabel:`Amazon S3` to configure a {+fdi+} for data in |aws| 
  |s3| buckets.

  Corresponds to :datalakeconf-aws:`stores.[n].provider` |json| 
  configuration setting.
---
title: "Select an |aws| IAM role for |service|."
level: 4
ref: select-role-for-service
content: |
  You can select an existing |aws| IAM role that |service| is 
  authorized for from the role selection dropdown list or choose 
  :guilabel:`Authorize an AWS IAM Role` to authorize a new role. 
  
  If you selected an existing role that |service| is authorized for, 
  proceed to the next step to list your |aws| |s3| buckets. 
  
  If you are authorizing |service| for an existing role or are creating 
  a new role, complete the following steps before proceeding to the 
  next step:
  
  a. Select :guilabel:`Authorize an AWS IAM Role` to authorize a new 
     role or select an existing role from the dropdown and click 
     :guilabel:`Next`.

  #. Use the |aws| :abbr:`ARN (Amazon Resource Name)` and unique 
     External ID in the :guilabel:`Add Atlas to the trust relationships 
     of your AWS IAM role` section to add |service| to the trust 
     relationships of an existing or new |aws| IAM role. 

     In the |service| UI, click and expand one of the following:

     - The :guilabel:`Create New Role with the AWS CLI` shows how to 
       use the |arn| and the unique External ID to add |service| to the 
       trust relationships of a new |aws| |iam| role. Follow the steps 
       in the |service| UI for creating a new role. To learn more, see  
       :atlas:`Create New Role with the AWS CLI 
       </security/set-up-unified-aws-access/#procedure>`. 

       When authorizing a new role, if you quit the ``Configure a New 
       Data Lake`` workflow: 
     
       - Before validating the role, |service| will not create the 
         {+fdi+}. You can go to the |service| :guilabel:`Integrations` 
         page to :atlas:`authorize 
         </security/set-up-unified-aws-access/>` a new role. You can 
         :atlas:`resume </security/set-up-unified-aws-access/#resume-an-authorization-procedure>` 
         the workflow when you have the |aws| IAM role |arn|.
       - After validating the role, |service| will not create the 
         {+fdi+}. However, the role is available in the role selection 
         dropdown and can be used to create a {+fdi+}. You do not need 
         to authorize the role again. 

     - The :guilabel:`Add Trust Relationships to an Existing Role` 
       shows how to use the |arn| and the unique External ID to add 
       |service| to the trust relationships of an existing |aws| |iam| 
       role. Follow the steps in the |service| UI for adding |service| 
       to the trust relationship to an existing role. To learn more, 
       see :atlas:`Add Trust Relationships to an Existing Role 
       </security/set-up-unified-aws-access/#procedure>` . 

     .. important::

        If you modify your custom |aws| role |arn| in the future, 
        ensure that the access policy of the role includes the 
        appropriate access to the |s3| resources for the {+fdi+}.

     .. seealso:: 

        - :atlas:`Set Up Unified AWS Access 
          </security/set-up-unified-aws-access/>`
        - :atlas:`Create a Cloud Provider Access Role 
          </reference/api/cloud-provider-access-create-one-role>`

  #. Click :guilabel:`Next`.

---
title: "Enter the S3 bucket information."
level: 4
ref: provide-aws-bucket-name
content: |

  a. Enter the name of your S3 bucket.

     Corresponds to :datalakeconf-aws:`stores.[n].bucket` |json| 
     configuration setting.

  #. Specify whether the bucket is :guilabel:`Read-only` or both 
     :guilabel:`Read and write`. 

     |service| can only query :guilabel:`Read-only` buckets; if you 
     wish to query and save query results to your |s3| bucket, choose 
     :guilabel:`Read and write`. To save query results to your |s3| 
     bucket, the role policy that grants |service| access to your |aws| 
     resources must include the ``s3:PutObject`` and 
     ``s3:DeleteObject`` permissions in addition to the 
     ``s3:ListBucket``, ``s3:GetObject``, ``s3:GetObjectVersion``, and 
     ``s3:GetBucketLocation`` permissions, which grant read access. See 
     step 4 below to learn more about assigning access policy to your 
     |aws| |iam| role.
  
  #. Select the region of the |s3| bucket. 

     Corresponds to :datalakeconf-aws:`stores.[n].region` |json| 
     configuration setting.

     .. note::

        You can't create a {+fdi+} if {+adf+} is unable to retrieve the  
        region of the specified |s3| bucket.
  
  #. **Optional**. Specify a prefix that {+df+} should use when 
     searching the files in the |s3| bucket. If omitted, {+df+} 
     does a recursive search for all files from the root of the |s3| 
     bucket.

     Corresponds to :datalakeconf-aws:`stores.[n].prefix` |json| 
     configuration setting.

  #. Click :guilabel:`Next`.
---
title: "Assign an access policy to your |aws| IAM role."
level: 4
ref: assign-role-access-policy
content: |
  a. Follow the steps in the |service| user interface to assign an 
     access policy to your |aws| IAM role.

     Your role policy for read-only or read and write access should look similar to the following:

     .. tabs:: 

        .. tab:: Read-Only Access 
           :tabid: readonly

           .. code-block:: json 
              
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:ListBucket",
                      "s3:GetObject",
                      "s3:GetObjectVersion",
                      "s3:GetBucketLocation"
                    ],
                    "Resource": [
                      <role arn>
                    ]
                  }
                ]
              }

        .. tab:: Read-Write Access 
           :tabid: readwrite

           .. code-block:: json 
              
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:ListBucket",
                      "s3:GetObject",
                      "s3:GetObjectVersion",
                      "s3:GetBucketLocation",
                      "s3:PutObject",
                      "s3:DeleteObject"
                    ],
                    "Resource": [
                      <role arn>
                    ]
                  }
                ]
              }

  #. Click :guilabel:`Next`.
---
title: "Define the path structure for your files in the |s3| bucket and 
       click :guilabel:`Next`."
level: 4
ref: define-data-sources
content: | 
  For example: 

  .. code-block:: sh
     
     s3://<bucket-name>/<path>/<to>/<files>/<filename>.<file-extension>

  To add additional paths to data on your |s3| bucket, click 
  :guilabel:`Add Data Source` and enter the path. To learn more about 
  paths, see :ref:`adf-path-syntax`.

  Corresponds to 
  :datalakeconf-aws:`databases.[n].collections.[n].dataSources.[n].path` 
  |json| configuration setting.
---
level: 4
ref: drag-drop-data-store-s3
inherit:
  file: steps-adf-deploy-source.yaml
  ref: drag-drop-data-store
---
title: "Repeat steps 1 through 6 in the Visual Editor tab above to 
       define additional |aws| |s3| data stores."
optional: true
level: 4
ref: additional-s3-data-stores 
content: | 
  To add |service| or |http| data stores for federated queries, see: 

  - :ref:`Configure Atlas Data Source from the UI 
    <deploy-atlas-datastore>`
  - :ref:`Configure HTTP Data Source from the UI 
    <deploy-http-datastore>`

  .. seealso:: 

   - :ref:`federated-queries`  
---
title: "Click :guilabel:`Save` to create the {+fdi+}."
level: 4
ref: save-configuration
content: | 

  .. note:: 

     If {+adf+} is unable to read the specified |s3| bucket, it 
     displays a modal to: 

     - :guilabel:`Cancel` this operation and specify a different |iam| 
       role to retrieve the object metadata from the specified |s3| 
       bucket. 
     - :guilabel:`Use Role Anyway` to create the {+fdi+} for the 
       specified bucket using the specified |iam| role. 
       
...
