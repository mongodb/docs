stepnum: 1
title: "Stop all existing |onprem| services."
level: 4
ref: shutdown
pre: |

   Shut down the |onprem| Application.
action:
    language: sh
    code: |
      <install_dir>/bin/mongodb-mms stop
---
stepnum: 2
title: "On each |onprem| server, back up your existing configuration files and logs to a directory other than the install directory."
level: 4
ref: create-backups
content: |

  .. important::

     You need the backed-up ``<install_dir>/conf/conf-mms.properties``
     file for later in this procedure.

  .. example::

     The following commands back up the configuration files and logs to
     your home directory:

     .. class:: copyable-code
     .. code-block:: sh

        cp -a <install_dir>/conf ~/mms_conf.backup
        cp -a <install_dir>/logs ~/mms_logs.backup
---
stepnum: 3
level: 4
# Note: This step is borrowed from the archive install procedure, not from steps-source-upgrade.
source:
  file: steps-install-on-prem-from-archive.yaml
  ref: download
---
stepnum: 4
title: "Install the |onprem| package on each server being used for |onprem|."
level: 4
ref: install
content: |

  Navigate to the directory to which to install |onprem|. Extract the
  archive to that directory:

  .. code-block:: sh

     tar -zxf mongodb-mms-<version>.x86_64.tar.gz
---
stepnum: 5
title: "On each |onprem| server, restore the backed up logs and configuration files into the |onprem| installation directory."
ref: backcopy-logs
content: |

    All log files should be restored.
    Most, but not all, configuration file should be restored. Restore:

    ``conf-mms.properties``
      The :doc:`settings </reference/configuration>` for this 
      |mms| deployment.

    ``gen.key``
      The :ref:`encryption key <gen-key>` for the 
      :term:`backing databases` of this |mms| deployment.

    .. example::

       These commands restore the configuration files and logs from
       your home directory:

       .. class:: copyable-code
       .. code-block:: sh

          cp -a ~/mms_logs.backup <install_dir>/logs
          cp -a ~/mms_conf.backup/conf-mms.properties <install_dir>/conf/conf-mms.properties
          cp -a ~/mms_conf.backup/gen.key <install_dir>/conf/gen.key
---
stepnum: 6
title: "*Optional.* On each |onprem| server, merge any needed changes into the ``mms.conf`` file from your backup."
ref: merge-mms-conf
content: |

  The ``mms.conf`` file is rarely customized, as it contains port and
  |jvm| configuration settings. If you :doc:`modified the ports
  </tutorial/manage-ports>` or the |jvm| settings that |onprem| uses,
  you need to re-apply those changes from your backup
  copy to the ``mms.conf`` file after |onprem| is upgraded. 

  The upgrade to |onprem| 4.1 and 4.2 removed the ``-d64`` flag from
  the ``JAVA_MMS_UI_OPTS`` parameter.

---
stepnum: 7
title: "Start |onprem| on every server."
ref: start
pre: |
  Issue the following command:
action:
  language: sh
  code: |
    <install_dir>/bin/mongodb-mms start
---
stepnum: 8
level: 4
source:
  file: steps-source-upgrade-onprem.yaml
  ref: upgrade-install-agents
...
