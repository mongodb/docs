.. facet::
   :name: genre
   :values: tutorial

.. facet::
   :name: programming_language
   :values: javascript/typescript

.. meta::
   :keywords: queryable encryption, code example, node.js

.. _qe-create-encryption-schema:

========================================================================
Create an {+enc-schema-title+}
========================================================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

About this Task
---------------

To make encrypted fields queryable, create an :term:`{+enc-schema+}`. 
This schema defines which fields are queryable, and which
query types are permitted. For more information, see
:ref:`qe-fundamentals-encrypt-query`.

.. important::

   {+qe+} supports equality and range queries. You can configure a
   field for only one query type.

Before you Begin
----------------

When you make encrypted fields queryable, consider performance and
security. For details on how each configuration option affects these,
see :ref:`qe-field-configuration`.

To use the Public Preview prefix, suffix, or substring queries with
:binary:`mongosh`, you must separately download the :manual:`{+shared-library+}
</core/queryable-encryption/install-library>` 8.2 or higher, then specify the
library path to ``mongosh`` using the :mongosh:`--cryptSharedLibPath </reference/options>` option.

.. _qe-specify-fields-for-encryption:

.. _qe-enable-substring-queries:

Steps
-----

.. procedure::
   :style: normal

   .. step:: Create the {+enc-schema+}.

      Include an ``encryptedFieldsObject`` with a nested ``fields`` array:

      .. code-block:: javascript

         const encryptedFieldsObject = {
            fields: []
         }
   
   .. step:: Specify fields to encrypt.

      a. Add the ``path`` and ``bsonType`` strings to a document
         within the fields array:

         .. code-block:: javascript
            :emphasize-lines: 4, 5

            const encryptedFieldsObject = {
               fields: [
                  {
                     path: "myDocumentField",
                     bsonType: "int"
                  }
               ]
            }

         .. important::

            You can specify any field for encryption except the
            ``_id`` field.

      #. Optionally, set a ``keyId`` field with the {+dek-abbr+} ID.

         .. important::
         
            Key IDs must be unique, otherwise the server returns an error.
         
         By configuring ``AutoEncryptionSettings`` on the client, you can use
         the ``createEncryptedCollection`` helper method to create keys
         automatically.

         .. code-block:: javascript
            :emphasize-lines: 4

            {
               path: "myDocumentField",
               bsonType: "int",
               keyId: "<unique data encryption key>"
            }

   .. step:: Enable equality queries on desired fields.
      
      This enables querying with the :query:`$eq`, :query:`$ne`, :query:`$in`, 
      and :query:`$nin` operators.

      .. _qe-enable-queries:

      Add the ``queries`` object and set ``queryType`` to ``"equality"``:

      .. code-block:: javascript
         :emphasize-lines: 4

         {
            path: "myDocumentField",
            bsonType: "int",
            queries: { queryType: "equality" }
         }

   .. step:: Enable range queries on desired fields.
      
      This enables querying with the :query:`$lt`, :query:`$lte`, :query:`$gt`, and :query:`$gte` operators.

      For details on how the following options affect security and performance, see :ref:`qe-field-configuration`.

      a. Add the ``queries`` object and set ``queryType`` to ``"range"``:
            
         .. code-block:: javascript
            :emphasize-lines: 4

            {
               path: "myDocumentRangeField",
               bsonType: "int",
               queries: { queryType: "range" }
            }
      
      #. Set the following fields:
      
         .. list-table::
            :header-rows: 1
            :widths: 20 30 50

            * - Field
              - Type
              - Description
            
            * - :ref:`min and max <qe-field-min-max>`
              - Same as field ``bsonType``
              - Required if ``bsonType`` is ``decimal`` or
                ``double``. Optional but highly recommended if it is ``int``,
                ``long``, or ``date``. Defaults to the minimum and maximum
                values of the ``bsonType``.
                
                When possible, specifying bounds on a query improves 
                performance. If querying values outside of these inclusive 
                bounds, MongoDB returns an error.
         
         .. code-block:: javascript
            :emphasize-lines: 5-6

            {
               path: "myDocumentRangeField",
               bsonType: "int",
               queries: { queryType: "range",
                          min: 0,
                          max: 1200
               }
            }

   .. step:: Enable prefix, suffix, or substring queries on desired fields.

      These query types are for ``string`` fields only. You can enable both
      ``prefixPreview`` and ``suffixPreview`` on the same field, but can't
      enable either if using ``substringPreview``.

      .. include:: includes/queryable-encryption/qe-warning-public-preview.rst

      - ``prefixPreview`` queries enable the :expression:`$encStrStartsWith`
        and :expression:`$encStrNormalizedEq` aggregation expressions.
      - ``suffixPreview`` queries enable the :expression:`$encStrEndsWith` 
        and :expression:`$encStrNormalizedEq` aggregation expressions.
      - ``substringPreview`` queries enable the :expression:`$encStrContains`
        and :expression:`$encStrNormalizedEq` aggregation expressions.

      a. Add the ``queries`` object and set ``queryType`` to 
         ``"prefixPreview"``, ``"suffixPreview"``, or ``"substringPreview"``:
                  
         .. code-block:: javascript
            :emphasize-lines: 4

            {
               path: "myDocumentStringField",
               bsonType: "string",
               queries: { queryType: "substringPreview" }
            }
            
      #. Set the following fields.

         For details on how they affect security and performance, see 
         :ref:`qe-field-configuration`.
      
         .. list-table::
            :header-rows: 1
            :widths: 20 30 50

            * - Field
              - Type
              - Description
              
            * - :parameter:`strMaxLength`
              - integer
              - ``substringPreview`` queries only. The maximum allowed length
                for a substring-indexed field.

            * - :parameter:`strMinQueryLength`
              - integer
              - The minimum allowed prefix/suffix/substring length to query.

            * - :parameter:`strMaxQueryLength`
              - integer
              - The maximum allowed prefix/suffix/substring length to query.

                :gold:`IMPORTANT:` This setting strongly impacts query
                performance. Limit it whenever possible.

            * - :parameter:`caseSensitive`
              - Boolean
              - Optional. Whether queries are case-sensitive. Defaults to
                ``true``.
              
            * - :parameter:`diacriticSensitive`
              - Boolean
              - Optional. Whether queries are diacritic-sensitive. Defaults to
                ``true``.

         .. code-block:: javascript
            :emphasize-lines: 6-7

            {
               path: "myDocumentStringField",
               bsonType: "string",
               queries: {
                  "queryType": "substringPreview",
                  "strMaxLength": 30,
                  "strMinQueryLength": 1,
                  "strMaxQueryLength": 20,
                  "caseSensitive": false
               }
            }


Example
-------

This example shows how to create an {+enc-schema+} for hospital data.

Consider the following document that contains personally identifiable information
(PII), credit card information, and sensitive medical information:

.. code-block:: json

   {
      "firstName": "Jon",
      "lastName": "Snow",
      "patientId": 12345187,
      "address": "123 Cherry Ave",
      "medications": [
         "Adderall",
         "Lipitor"
      ],
      "patientInfo": {
         "ssn": "921-12-1234",
         "billing": {
               "type": "visa",
               "number": "1234-1234-1234-1234"
         }
      }
   }

To ensure the PII and sensitive medical information stays secure, this 
{+enc-schema+} adds the relevant fields:

.. code-block:: javascript

   const encryptedFieldsObject = {
      fields: [
         {
            path: "patientId",
            bsonType: "int"
         },
         {
            path: "patientInfo.ssn",
            bsonType: "string"
         },
         {
            path: "medications",
            bsonType: "array"
         },
         {
            path: "patientInfo.billing",
            bsonType: "object"
         }
      ]
   }

Adding the ``queries`` property makes the ``patientId`` and
``patientInfo.ssn`` fields queryable. This example enables equality queries:

.. code-block:: javascript
   :emphasize-lines: 6, 11

   const encryptedFieldsObject = {
      fields: [
         {
            path: "patientId",
            bsonType: "int",
            queries: { queryType: "equality" }
         },
         {
            path: "patientInfo.ssn",
            bsonType: "string",
            queries: { queryType: "equality" }
         },
         {
            path: "medications",
            bsonType: "array"
         },
         {
            path: "patientInfo.billing",
            bsonType: "object"
         },
      ]
   }
