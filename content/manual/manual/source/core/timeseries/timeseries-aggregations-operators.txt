.. _manual-timeseries-aggregations-operators:

=======================================
Aggregation and Operator Considerations
=======================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. meta::
   :keywords: IOT


Some aggregation stages and operators require special considerations
when you use them with :ref:`time series collections
<manual-timeseries-landing>`. 

$geoNear
~~~~~~~~

Time series collections only support the :pipeline:`$geoNear`
aggregation stage for sorting :ref:`geospatial data
<geospatial-queries>` from queries against :ref:`2dsphere
<2dsphere-index>` indexes. You can't use the :query:`$near` and
:query:`$nearSphere` operators on time series collections.

.. include:: /includes/fact-geoNear-timeseries-query-restriction.rst

.. include:: /includes/fact-geoNear-timeseries-key-required.rst

$merge
~~~~~~

You cannot use the :pipeline:`$merge` aggregation stage to add data from
another collection to a time series collection.

$out
~~~~

Starting in MongoDB 7.0, you can use the :pipeline:`$out` aggregation stage to write
documents to a time series collection. For more information, see
:ref:`migrate-data-into-a-timeseries-collection`. 

Frequently Used Operations
~~~~~~~~~~~~~~~~~~~~~~~~~~

The following aggregation pipeline operators and stages are often used to analyze
time series data:

- :expression:`$dateAdd`: Adds a specified amount of time to a Date
  object.
- :expression:`$dateDiff`: Returns the time difference between two dates.
- :expression:`$dateTrunc`: Returns a date that has been truncated to
  the specific unit.
- :pipeline:`$setWindowFields`: Runs calculations on documents in a
  given window.

Examples
~~~~~~~~

.. composable-tutorial::
   :options: interface, language
   :defaults: mongosh, None

   .. selected-content::
      :selections: mongosh, None

      .. include:: /includes/time-series/timeseries-operators-mongosh.rst

   .. selected-content::
      :selections: driver, csharp

      .. include:: /includes/time-series/timeseries-operators-csharp.rst

   .. selected-content::
      :selections: driver, python

      .. include:: /includes/time-series/timeseries-operators-python.rst

   .. selected-content::
      :selections: driver, java-sync

      .. include:: /includes/time-series/timeseries-operators-java.rst

   .. selected-content::
      :selections: driver, nodejs

      .. include:: /includes/time-series/timeseries-operators-javascript.rst
