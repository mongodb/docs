.. _manage-online-archive:

====================
Archive Cluster Data
====================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

|service| offers a feature that moves infrequently accessed data from 
your |service| cluster to a MongoDB-managed read-only :adl:`Data Lake 
</>` on a cloud object storage without user action. Once |service| 
archives the data, you have a unified view of your |service| and 
{+Online-Archive+} data using a read-only |data-lake|.

|service| archives data based on the criteria you specify in an
archiving rule. The criteria combines a date with a number of
days. |service| archives data when the current date exceeds the
date plus the number of days specified in the archiving rule.

Cluster Requirements for Online Archive
---------------------------------------

|service| offers this *{+Online-Archive+}* feature only on ``M10`` and
greater clusters that run MongoDB 3.6 or later.

.. _online-archive-job:

How |service| Archives Data
---------------------------

To archive data:

1. |service| runs a query every five minutes to determine the documents 
   that match the criteria for archiving. |service| refers to this 
   query as a *job*.

2. For documents that match the archival criteria, |service|:

   a. Writes to up to a maximum of 10,000 partitions per archival job.

   b. Writes up to 2GB of document data to partitions on the cloud 
      object storage for each unique combination of query field values 
      except dates, which are grouped during each run to reduce the 
      number of partitions.

   c. Writes each subsequent quantity of document data (up to 2 GB)
      with each query run.

|service| provides a unified endpoint through which you can query both
your live cluster and archived data using the same database and
collection name you use in your |service| cluster. You can't use the
unified endpoint over a private connection such as
:doc:`Peering </security-vpc-peering>` or {+aws-pl+}. You must use a
standard internet connection over |tls|.

If you activate {+Online-Archive+} for an |aws| cluster, the cloud object 
storage exists in the same region in |aws| as your cluster. If you activate 
{+Online-Archive+} for a |gcp| or |azure| cluster, {+Online-Archive+}
creates the archive in the |aws| region closest to your cluster's primary
based on a calculation of distance between the cluster and cloud object 
storage.

.. important::

   |service| encrypts your archived data using MongoDB's |aws|
   encryption keys. It can't use any encryption-at-rest encryption keys
   you might have used on your cluster data.

|data-lake| for {+Online-Archive+}
----------------------------------

When you configure your ``M10`` or greater |service| cluster for
{+Online-Archive+}, |service| creates a read-only :adl:`Data Lake </>`,
one per cluster, on a cloud object storage for your archived data.

Limitations
~~~~~~~~~~~

- You can't write to the {+Online-Archive+} |data-lake|.

- You can't :adl:`configure </config/config-data-lake>` or
  :adl:`administer </administration>` the {+Online-Archive+} 
  |data-lake| through the:

  - |service| console,
  - |data-lake| :adl:`CLI </reference/cli/datalake-cli>`, or
  - |data-lake| :adl:`API </reference/api/datalakes-api>`.

Viewing the {+Online-Archive+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To view your |data-lake| for the {+Online-Archive+}:

1. Navigate to the |data-lake| page in the |service| console.

2. Click :guilabel:`Data Lake` from the left navigation in your
   :guilabel:`Project` page.

Querying the {+Online-Archive+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To query your {+Online-Archive+} data, use the connection string
through the |data-lake| :guilabel:`Connect` button to connect to the 
cloud object storage.

You can also query your {+Online-Archive+} data with :abbr:`SQL (Structured
Query Language)`. For more information, see :adl:`Querying with SQL
</admin/query-with-sql>`.

Deleting {+Online-Archive+}s
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you delete all the {+Online-Archive+}s, |service| deletes the
|data-lake|. After deleting all the {+Online-Archive+}s, if you create
an {+Online-Archive+} with the same settings as a deleted
{+Online-Archive+}, |service| creates a new |data-lake| for the new
{+Online-Archive+}.

.. _online-archive-pricing:

{+Online-Archive+} Costs
------------------------

{+Online-Archive+} stores infrequently accessed data to lower the data 
storage costs on your |service| cluster. You incur costs for storage on 
the cloud object storage and queries on archived data.

.. seealso::

   To learn more about the storage and query costs, see
   :website:`Atlas pricing page </cloud/atlas/pricing>`.

Manage Your {+Online-Archive+}
--------------------------

You can configure an {+Online-Archive+} for a collection on your
cluster through your |service| UI and |api|. Once you create an
{+Online-Archive+}, you can view the list of archives, edit an
archiving rule, pause archiving, and delete your {+Online-Archive+} at
any time. If you need to move archived data back to your cluster, you
must use |mongodump| or |mongoexport|. The following pages describe how
to:

.. toctree::
   :titlesonly:

   /online-archive/configure-online-archive
   /online-archive/connect-to-online-archive
   /online-archive/view-online-archives
   /online-archive/edit-online-archive
   /online-archive/pause-resume-online-archive
   /online-archive/delete-online-archive
   /online-archive/restore-archived-data 
