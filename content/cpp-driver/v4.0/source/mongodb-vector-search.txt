.. _cpp-mongodb-vector-search:

=================================
Run a MongoDB Vector Search Query
=================================

.. facet::
   :name: genre
   :values: reference
 
.. meta::
   :keywords: code example, semantic, text, embeddings
   :description: Learn how to use the C++ driver to perform MongoDB Vector Search queries and find similar items to your search query using the aggregation framework.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

In this guide, you can learn how to perform searches on your documents
by using the {+vector-search+} feature. The {+driver-short+} allows you to
perform {+vector-search+} queries by using the aggregation framework.
To learn more about performing aggregations, see the
:ref:`cpp-aggregation` guide.

.. note:: Deployment Compatibility

   You can use the {+vector-search+} feature only on MongoDB Atlas clusters. This feature
   is not available for self-managed deployments.

To learn more about {+vector-search+}, see the :atlas:`{+vector-search+} Overview
</atlas-vector-search/vector-search-overview/>` in the Atlas
documentation.

.. note:: {+search+}

   To perform advanced full-text search on your documents, you can use the
   {+search+} feature. To learn about this feature, see the
   :atlas:`{+search+} Overview </atlas-search/atlas-search-overview/>`.

{+vector-search+} Index
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Before you can perform {+vector-search+} queries, you must create a
{+vector-search+} index on your collection. To learn more about
creating this index, see the :ref:`cpp-vector-search-index` guide.

Vector Search Aggregation Stage
-------------------------------

To create a ``$vectorSearch`` stage in your aggregation pipeline, perform the
following actions:

1. Create a vector to store the pipeline stages.

#. Specify the ``$vectorSearch`` operator and provide details about the
   vector search query.

You must define the following fields in your ``$vectorSearch`` stage:

.. list-table::
   :header-rows: 1

   * - Parameter
     - Data Type
     - Description

   * - ``index``
     - ``string``
     - Name of the vector search index

   * - ``path``
     - ``string``
     - Field that contains vector embeddings

   * - ``queryVector``
     - ``BSON::Binary`` vector subtype, ``BSON::Vector``, or array of numbers
     - Vector representation of your query

   * - ``limit``
     - ``number``
     - Number of results to return

Then, include the stage in an aggregation pipeline and pass the pipeline
to the ``aggregate`` method.

.. _cpp-avs-examples:

{+search+} Query Examples
------------------------------

In this section, you can learn how to perform {+vector-search+} queries. The examples in this section use sample data from the
``sample_mflix.embedded_movies`` collection. To learn how to load this
sample data, see the :atlas:`Load Data into Atlas </sample-data/>`
tutorial in the Atlas documentation.

Basic Vector Search Query
~~~~~~~~~~~~~~~~~~~~~~~~~

The following code performs a {+vector-search+} query on the
``plot_embedding`` vector field by using a query vector that is a vector
embedding of the phrase "time travel":

.. io-code-block::
   :copyable: true

   .. input:: /includes/mongodb-vector-search.cpp
      :language: cpp
      :dedent:
      :start-after: vector-search-start
      :end-before: vector-search-end

   .. output::
      :language: none
      :visible: false

      { "plot" : "At the age of 21, Tim discovers he can travel in time and change what happens and has happened in his own life. His decision to make his world a better place by getting a girlfriend turns out not to be as easy as you might think.", "title" : "About Time" }
      { "plot" : "A psychiatrist makes multiple trips through time to save a woman that was murdered by her brutal husband.", "title" : "Retroactive" }
      { "plot" : "A time-travel experiment in which a robot probe is sent from the year 2073 to the year 1973 goes terribly wrong thrusting one of the project scientists, a man named Nicholas Sinclair into a...", "title" : "A.P.E.X." }
      { "plot" : "An officer for a security agency that regulates time travel, must fend for his life against a shady politician who has a tie to his past.", "title" : "Timecop" }
      { "plot" : "After visiting 2015, Marty McFly must repeat his visit to 1955 to prevent disastrous changes to 1985... without interfering with his first trip.", "title" : "Back to the Future Part II" }
      { "plot" : "A reporter, learning of time travelers visiting 20th century disasters, tries to change the history they know by averting upcoming disasters.", "title" : "Thrill Seekers" }
      { "plot" : "Lyle, a motorcycle champion is traveling the Mexican desert, when he find himself in the action radius of a time machine. So he find himself one century back in the past between rapists, ...", "title" : "Timerider: The Adventure of Lyle Swann" }
      { "plot" : "Hoping to alter the events of the past, a 19th century inventor instead travels 800,000 years into the future, where he finds humankind divided into two warring races.", "title" : "The Time Machine" }
      { "plot" : "A romantic drama about a Chicago librarian with a gene that causes him to involuntarily time travel, and the complications it creates for his marriage.", "title" : "The Time Traveler's Wife" }
      { "plot" : "A modern aircraft carrier is thrown back in time to 1941 near Hawaii, just hours before the Japanese attack on Pearl Harbor.", "title" : "The Final Countdown" }

This query uses the ``$vectorSearch`` stage to:

- Perform an Approximate Nearest Neighbor (ANN) vector search

- Search for the specified term in the ``plot_embedding_voyage_3_large`` field

- Set the number of nearest neighbors used in the search to 150 by using the
  ``numCandidates`` option

- Return a maximum of 10 documents from the query using the ``limit`` option

It uses the ``$project`` stage to:

- Only include the movie ``plot`` and ``title`` fields in the results

Vector Search Score
~~~~~~~~~~~~~~~~~~~

The following code performs the same query as in the preceding example,
but uses the ``$project`` stage to output only the ``title`` field and ``vectorSearchScore`` meta
field, which describes how well the document matches the query vector:

.. io-code-block::
   :copyable: true

   .. input:: /includes/mongodb-vector-search.cpp
      :language: cpp
      :dedent:
      :start-after: start-score-query
      :end-before: end-score-query
      :emphasize-lines: 15

   .. output::
      :language: none
      :visible: false

      { "title" : "About Time", "score" : 0.77101051807403564453 }
      { "title" : "Retroactive", "score" : 0.76004779338836669922 }
      { "title" : "A.P.E.X.", "score" : 0.7576859593391418457 }
      { "title" : "Timecop", "score" : 0.757656097412109375 }
      { "title" : "Back to the Future Part II", "score" : 0.75213932991027832031 }
      { "title" : "Thrill Seekers", "score" : 0.75099325180053710938 }
      { "title" : "Timerider: The Adventure of Lyle Swann", "score" : 0.75026416778564453125 }
      { "title" : "The Time Machine", "score" : 0.75025022029876708984 }
      { "title" : "The Time Traveler's Wife", "score" : 0.74949628114700317383 }
      { "title" : "The Final Countdown", "score" : 0.7469132542610168457 }

Vector Search Options
---------------------

You can use a ``$vectorSearch`` stage to perform many types of Atlas
Vector Search queries. Depending on your desired query, you can specify the
following options in the stage definition:

.. list-table::
   :widths: 20 20 40 20
   :header-rows: 1

   * - Optional Parameter
     - Data Type
     - Description
     - Default Value

   * - ``exact``
     - boolean
     - Specifies whether to run an Exact Nearest Neighbor (``true``) or
       Approximate Nearest Neighbor (``false``) search
     - ``false``

   * - ``filter``
     - document
     - Specifies a pre-filter for documents to search on
     - No filtering

   * - ``numCandidates``
     - number
     - Specifies the number of nearest neighbors to use during the
       search
     - No limit

To learn more about these options, see the :atlas:`Fields
</atlas-vector-search/vector-search-stage/#fields>` section of the
``$vectorSearch`` operator reference in the Atlas documentation.

.. _cpp-avs-addtl-info:

Additional Information
----------------------

To learn more about the concepts mentioned in this guide, see the
following Server manual entries:

- :atlas:`Run Vector Search Queries </atlas-vector-search/vector-search-stage/>`
- :manual:`Aggregation Pipeline </core/aggregation-pipeline/>`
- :manual:`Aggregation Stages </reference/mql/aggregation-stages/#std-label-aggregation-pipeline-operator-reference)>`

To learn more about the behavior of the ``aggregate`` method, see the
:ref:`cpp-aggregation` guide.

API Documentation
~~~~~~~~~~~~~~~~~

To learn more about the methods and types mentioned in this
guide, see the following API documentation:

- `aggregate() <{+api+}/classmongocxx_1_1v__noabi_1_1collection.html#a480f6d0f9986d43b1d17d6ed8876941d>`__