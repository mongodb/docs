.. _k8s-considerations:

==============
Considerations
==============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/styles/corrections.rst

Set ``MANAGED_SECURITY_CONTEXT`` for |k8s-op-short| OpenShift Deployments
-------------------------------------------------------------------------

When you deploy the |k8s-op-short| to OpenShift, you must set the
``MANAGED_SECURITY_CONTEXT`` flag to ``true``. This value is set for
you in the :github-raw:`values-openshift.yaml </mongodb/helm-charts/main/charts/enterprise-operator/values-openshift.yaml>`
file. To learn more, see the :ref:`Operator installation
<install-k8s-operator>` and choose the installation method you want to use.

Understand the Default Permissions for |k8s-op-short| Objects
-------------------------------------------------------------

Objects in the |k8s-op-short| configuration use the following default
permissions. These are the minumum permissions required for
the |k8s-op-short| to deploy and manage |onprem| and MongoDB resources
in a |k8s| cluster:

.. include:: /includes/list-tables/default-k8s-object-permissions.rst

.. _k8s-validation-webhook:

Check Messages from the Validation Webhook
------------------------------------------

The |k8s-op-short| uses a validation |k8s-webhook| to prevent users
from applying invalid resource definitions. The webhook rejects invalid
requests.

The |k8s-cr| and |k8s-crb| for the webhook are included in the default
configuration files that you apply during the installation. To create
the role and binding, you must have :k8sdocs:`cluster-admin privileges </reference/access-authn-authz/rbac/#user-facing-roles>`.

If you create an invalid resource definition, the webhook returns
a message similar to the following that describes the error to the shell:

.. code-block:: sh
   :copyable: false
 
   error when creating "my-ops-manager.yaml":
   admission webhook "ompolicy.mongodb.com" denied the request:
   shardPodSpec field is not configurable for application databases as
   it is for sharded clusters and appdb replica sets

When the |k8s-op-short| reconciles each resource, it also validates that
resource. The |k8s-op-short| doesn't require the validation webhook to
create or update resources.

If you omit the validation webhook, or if you remove the webhook's role
and binding from the default configuration, or have insufficient
privileges to run the configuration, the |k8s-op-short| issues warnings,
as these are not critical errors. If the |k8s-op-short| encounters a
critical error, it marks the resource as ``Failed``.

.. admonition:: |gke| deployments

   |gke| has a known issue with the webhook when deploying to private
   clusters. To learn more, see :ref:`k8s-private-cluster-on-gke`.


Customize the CustomResourceDefinitions that the |k8s-op-short| Watches
-----------------------------------------------------------------------

Earlier versions of the |k8s-op-short| would crash on startup if any
one of the MongoDB |k8s-crds| was not present in the cluster. For
instance, you had to install the CustomResourceDefinition for |onprem|
even if you did not plan to deploy it with the |k8s-op-short|.

You can now specify which custom resources you want the |k8s-op-short|
to watch. This allows you to install the CustomResourceDefinition for
only the resources that you want the |k8s-op-short| to manage.

You must use ``helm`` to configure the |k8s-op-short| to watch only the
custom resources you specify. Follow the relevant ``helm``
:ref:`installation instructions <install-k8s-operator>`,
but make the following adjustments:

1. Decide which CustomResourceDefinitions you want to install. You can
   install any number of the following:

   .. include:: /includes/list-tables/crds.rst

#. Install the Helm Chart and specify which 
   CustomResourceDefinitions you want the 
   |k8s-op-short| to watch.
   
   Separate each custom resource with a comma:

   .. code-block:: sh

      helm install <deployment-name> mongodb/enterprise-operator \
        --set operator.watchedResources="{mongodb,mongodbusers}" \
           --skip-crds
