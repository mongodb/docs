.. _explain-results:

===============
Explain Results
===============

.. meta::
   :description: Understand how to interpret MongoDB's explain results for query plans and execution statistics, including key fields and stages.

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

To return information on :ref:`query plans
<query-plans-query-optimization>` and execution statistics of the query
plans, MongoDB provides the following methods:

- :method:`db.collection.explain()`

- :method:`cursor.explain()`

To learn about important explain result fields and how to interpret
them, see :ref:`interpret-explain-plan`.

.. important::

   ``explain`` ignores the plan cache. Instead, a set 
   of candidate plans are generated, and a winner is chosen without consulting 
   the plan cache. Furthermore, ``explain`` prevents the MongoDB query planner 
   from caching the winning plan.

.. note::

   Only the most important output fields are shown on this page, and fields for 
   internal use are not documented. The fields listed in the output are subject 
   to change.

.. _explain-output-structure:

Explain Output Structure
------------------------

The ``explain`` results present the query plans as a tree of stages. 
The output structure can differ based on which query engine the 
operation uses. Operations can use the classic query engine or the 
:ref:`slot-based execution query engine <sbe-landing>`.

To see how the output structure can differ between the two execution 
engines, see the following examples:

.. tabs::

   tabs:

      - id: classic-sample-output
        name: "Classic Execution Engine"
        content: |

            .. code-block:: javascript
               :copyable: false

               winningPlan: {
                  stage: <STAGE1>,
                  ...
                  inputStage: {
                     stage: <STAGE2>,
                     ...
                     inputStage: {
                        stage: <STAGE3>,
                        ...
                     }
                  }
               },

      - id: sbe-sample-output
        name: "Slot-based Execution Engine"
        content: |

            .. code-block:: javascript
               :copyable: false

               winningPlan: {
                  queryPlan: {
                     stage: <STAGE1>,
                     ...
                     inputStage: {
                        stage: <STAGE2>,
                        ...
                        inputStage: {
                           stage: <STAGE3>,
                           ...
                        }
                     }
                  }
                  slotBasedPlan: {
                     ...  
                  }
               },

Each stage passes its resulting documents or index keys to the
parent node. The leaf nodes access the collection or the indices. The
internal nodes use the documents or the index keys that result from the 
child nodes. The root node indicates the stage that MongoDB ultimately 
derives the result set from.

Stages are descriptive of the operation. For example:

- ``COLLSCAN`` for a collection scan

- ``IXSCAN`` for scanning index keys

- ``FETCH`` for retrieving documents

- ``GROUP`` for grouping documents

- ``SHARD_MERGE`` for merging results from shards

- ``SHARDING_FILTER`` for filtering out orphan documents from shards

- ``TS_MODIFY`` for modifying a time series collection

- ``BATCHED_DELETE`` for multiple document deletions that are batched
  together internally (starting in MongoDB 6.1)

- ``EOF`` for when a stage is end-of-stream

- ``EXPRESS`` stages for a limited set of queries that can bypass
  regular query planning to use optimized index scan plans *(New in
  version 8.0.)*
  
  ``EXPRESS`` stages can be one of the following:
  
  - ``EXPRESS_CLUSTERED_IXSCAN`` 
  - ``EXPRESS_DELETE``
  - ``EXPRESS_IXSCAN`` 
  - ``EXPRESS_UPDATE``

.. _explain-results-5.1-later:

Explain Output for MongoDB 5.1 and Later
----------------------------------------

This section shows the ``explain`` output for MongoDB 5.1 and later. To 
see the explain output for older versions of MongoDB, refer to the 
documentation for that version.

.. data:: explain.explainVersion

   Integer field.

   .. include:: /includes/explainVersion.rst

   .. versionadded:: 5.1

.. _queryPlanner:

``queryPlanner``
~~~~~~~~~~~~~~~~

:data:`explain.queryPlanner` information details the plan selected by
the :ref:`query optimizer <read-operations-query-optimization>`.

These examples may combine the output structures of MongoDB's classic
and slot-based execution engines. They are not meant to be 
representative. Your output may differ significantly.

.. tabs::

   tabs:

      - id: unsharded
        name: "Unsharded Collections"
        content: |

            For unsharded collections, ``explain`` returns the following
            ``queryPlanner`` information:

            .. code-block:: javascript
               :copyable: false

               queryPlanner: {
                  namespace: <string>,                                                                                                                                                                                                   
                  indexFilterSet: <boolean>,                                                                                                                                                                                                      
                  parsedQuery: {                                                                                                                                                                                                              
                     ...                                                                                                                                                  
                  },
                  planCacheShapeHash: <hexadecimal string>,                                                                                                                                                                                                      
                  planCacheKey: <hexadecimal string>,                                                                                                                                                                                                   
                  maxIndexedOrSolutionsReached: <boolean>,                                                                                                                                                                                        
                  maxIndexedAndSolutionsReached: <boolean>,                                                                                                                                                                                       
                  maxScansToExplodeReached: <boolean>,                                                                                                                                                                                            
                  winningPlan: {  
                    stage: <STAGE1>,
                    type: <string>,
                    inputStage: {
                      stage: <string>,
                      ...
                    }
                  },
                  rejectedPlans: [
                    <candidate plan1>,
                  ]
               }                                                                                                               

            .. include:: /includes/plan-cache-rename.rst

      - id: sharded
        name: "Sharded Collections"
        content: |
            For sharded collections, ``explain`` includes the core
            query planner and server information for each accessed
            shard in the ``shards`` field:

            .. code-block:: javascript
               :copyable: false

               {
                  queryPlanner: {
                     mongosPlannerVersion: <int>
                     winningPlan: {
                        stage: <STAGE1>,
                        type: <string>,
                        shards: [
                        { 
                           shardName: <string>,
                           connectionString: <string>,
                           serverInfo: {
                              ...
                           },
                           namespace: <string>,
                           indexFilterSet: <boolean>,
                           parsedQuery: {
                              ...
                           },
                           querySettings: {
                              ...
                           },
                           planCacheShapeHash: <hexadecimal string>,
                           planCacheKey: <hexadecimal string>,
                           maxIndexedOrSolutionsReached: <boolean>,
                           maxIndexedAndSolutionsReached: <boolean>,
                           maxScansToExplodeReached: <boolean>,
                           winningPlan: {
                              stage: <STAGE1>,
                              type: <string>,
                              inputStage: {
                                 stage: <string>,
                                 ...
                              }
                           },
                           rejectedPlans: [
                             <candidate plan1>,
                           ] 
                        }
                        ]
                     }
                  }
               }

            .. include:: /includes/plan-cache-rename.rst

.. data:: explain.queryPlanner

   Contains information on the selection of the query plan by the
   :ref:`query optimizer <read-operations-query-optimization>`.

   .. data:: explain.queryPlanner.namespace

      A string that specifies the :term:`namespace` with the names of
      the database and the collection accessed by the query. The
      namespace has the format ``<database>.<collection>``.

   .. data:: explain.queryPlanner.indexFilterSet

      A boolean that specifies whether MongoDB applied an :ref:`index
      filter <index-filters>` for the :term:`plan cache query shape`.

   .. data:: explain.queryPlanner.querySettings

      If query settings are set, ``querySettings`` contains details
      about the query settings that are applied to the query shape.

      To add query settings and explore examples, which
      include ``explain()`` output with ``querySettings``, see
      :dbcommand:`setQuerySettings`.
      
      .. versionadded:: 8.0

   .. data:: explain.queryPlanner.planCacheShapeHash

      .. include:: /includes/plan-cache-rename.rst

      A hexadecimal string that represents the hash of the
      :term:`plan cache query shape` and is dependent only on the plan cache query shapes.
      ``planCacheShapeHash`` can help identify slow queries (including the
      query filter of write operations) with the same plan cache query shape.

      .. note::

         As with any hash function, two different plan cache query shapes may result
         in the same hash value. However, the occurrence of hash
         collisions between different plan cache query shapes is unlikely.

      For more information on ``planCacheShapeHash`` and ``planCacheKey``,
      see :ref:`query-hash-plan-cache-key`.

   .. data:: explain.queryPlanner.planCacheKey

      A hash of the key for the plan cache entry associated with the
      query.

      Unlike the :data:`explain.queryPlanner.planCacheShapeHash`, the
      :data:`explain.queryPlanner.planCacheKey` is a function of both
      the plan cache query shape and the currently available indexes for
      that shape. Specifically, if indexes that can support the query
      shape are added or dropped, the ``planCacheKey`` value may change
      but the ``planCacheShapeHash`` value wouldn't change.

      For more information on ``planCacheShapeHash`` and ``planCacheKey``,
      see :ref:`query-hash-plan-cache-key`.

   .. data:: explain.queryPlanner.optimizationTimeMillis

      Time in milliseconds the query planner spent on query
      optimization. This result doesn't include time spent
      optimizing inner :pipeline:`$lookup` queries.

      .. versionadded:: 8.0

   .. data:: explain.queryPlanner.optimizedPipeline

      A boolean that indicates that the entire aggregation pipeline
      operation was optimized away, and instead, fulfilled by a tree
      of query plan execution stages.

      For example, the following aggregation operation can be fulfilled by the 
      tree of query plan execution rather than using the aggregation pipeline.
      
      .. code-block:: javascript

         db.example.aggregate([ { $match: { someFlag: true } } ] )

      The field is only present if the value is ``true`` and only
      applies to explain on aggregation pipeline operations. When
      ``true``, because the pipeline was optimized away, no
      aggregation stage information appears in the output.

   .. data:: explain.queryPlanner.winningPlan

      A document that details the plan selected by the :doc:`query
      optimizer </core/query-plans>`. 

   .. data:: explain.queryPlanner.winningPlan.stage

      A string that denotes the name of the stage.

      Each stage consists of information specific to the stage. For
      example, an ``IXSCAN`` stage includes the index bounds along with
      other data specific to the index scan. If a stage has a child
      stage or multiple child stages, the stage will have an
      ``inputStage`` or ``inputStages``.

      This field appears if the operation used the classic query
      execution engine. 

   .. data:: explain.queryPlanner.winningPlan.type

      If ``stage`` is set to ``"EOF"``, ``type`` is a string
      that denotes the reason for the EOF stage:

      - ``"nonExistentNamespace"``: indicates the query namespace 
        does not exist.
      - ``"predicateEvalsToFalse"``: indicates that 
        expression simplification determines that
        the query will not match any documents.

   .. data:: explain.queryPlanner.winningPlan.inputStage

      A document that describes the child stage, which provides the 
      documents or index keys to its parent. The field is present *if* 
      the parent stage has only one child.

   .. data:: explain.queryPlanner.winningPlan.inputStages

      An array of documents describing the child stages. Child stages 
      provide the documents or index keys to the parent stage. The field 
      is present *if* the parent stage has multiple child nodes. 
      For example, stages for :ref:`$or expressions
      <explain-output-or-expression>` might consume input from multiple 
      sources.

      This field appears if the operation used the classic query
      execution engine. 
   
   .. data:: explain.queryPlanner.winningPlan.isCached

      A boolean that indicates if the winningPlan is in the plan cache.  
      
      This field is ``true`` for a maximum of one plan between the winning plan 
      and the rejected plans. If the query has no cached plan, the field is
      ``false`` for the winning plan and the rejected plans.


   .. data:: explain.queryPlanner.winningPlan.queryPlan

      A document that details the plan selected by the :doc:`query
      optimizer </core/query-plans>`. MongoDB presents the plan as a tree
      of stages.
      
      This document appears if the query used the :ref:`slot-based 
      execution query engine <sbe-landing>`.
      
      .. versionadded:: 5.1

      .. data:: explain.queryPlanner.winningPlan.queryPlan.stage

         A string that denotes the name of the stage.

         Each stage consists of information specific to the stage. For
         example, an ``IXSCAN`` stage includes the index bounds along
         with other data specific to the index scan.

      .. data:: explain.queryPlanner.winningPlan.queryPlan.type

         If ``stage`` is set to ``"EOF"``, ``type`` is a string
         that denotes the reason for the EOF stage:

         - ``"nonExistentNamespace"``: indicates the query namespace 
           does not exist.
         - ``"predicateEvalsToFalse"``: indicates that expression 
           simplification determines that the query will not match any documents.

      .. data:: explain.queryPlanner.winningPlan.queryPlan.planNodeId

         Unique integer field that identifies each stage in the execution
         plan. Field is included in all stages throughout the ``explain``
         results.

         .. versionadded:: 5.1
      
      .. data:: explain.queryPlanner.winningPlan.queryPlan.inputStage

         See :data:`explain.queryPlanner.winningPlan.inputStage`.

   .. data:: explain.queryPlanner.winningPlan.slotBasedPlan

      Document with information about the slot-based query execution plan
      tree and stages. **For internal use by MongoDB.**

      .. versionadded:: 5.1

   .. data:: explain.queryPlanner.winningPlan.slotBasedPlan.stages

      String that includes information on each stage in the slot-based query
      execution plan, including execution order, operations, and slot
      assignments. **For internal use by MongoDB.**

      Starting in MongoDB 8.0, if a query uses :ref:`block processing 
      <timeseries-querying-block-processing>`, ``block_to_row`` and 
      ``ts_bucket_to_cellblock`` appear in the ``stages`` output.

      .. versionchanged:: 8.0

.. data:: explain.queryPlanner.rejectedPlans

   Array of candidate plans considered and rejected by the
   query optimizer. The array can be empty if there were no other
   candidate plans.

   Rejected plans have the same fields as
   ``explain.queryPlanner.winningPlan``.

   .. include:: /includes/explain-results/8.0-rejected-query-plan-changes.rst

.. _executionStats:

``executionStats``
~~~~~~~~~~~~~~~~~~

The returned :data:`explain.executionStats` information details the
execution of the winning plan. In order to include
``executionStats`` in the results, you must run the explain in either:

- :ref:`executionStats <explain-method-executionStats>` or

- :ref:`allPlansExecution <explain-method-allPlansExecution>`
  verbosity mode. Use ``allPlansExecution`` mode to include partial
  execution data captured during :ref:`plan selection
  <query-plans-query-optimization>`.

These examples may combine the output structures of MongoDB's classic
and slot-based execution engines. They are not meant to be 
representative. Your output may differ significantly.

.. tabs::

   tabs:

      - id: unsharded
        name: "Unsharded Collections"
        content: |

            For unsharded collections, ``explain`` returns the following
            ``executionStats`` information:

            .. code-block:: javascript
               :copyable: false

               executionStats: {
                  executionSuccess: <boolean>,
                  nReturned: <int>,
                  executionTimeMillis: <int>,
                  totalKeysExamined: <int>,
                  totalDocsExamined: <int>,
                  executionStages: {
                     stage: <STAGE1>
                     nReturned: <int>,
                     executionTimeMillisEstimate: <int>,
                     opens: <int>, // Starting in MongoDB 5.1
                     closes: <int>, // Starting in MongoDB 5.1
                     works: <int>,
                     advanced: <int>,
                     needTime: <int>,
                     needYield: <int>,
                     saveState: <int>,
                     restoreState: <int>,
                     isEOF: <boolean>,
                     ...
                     inputStage: {
                        stage: <STAGE2>,
                        nReturned: <int>,
                        ...
                        numReads: <int>, // Starting in MongoDB 5.1
                        ...
                        executionTimeMillisEstimate: <int>,
                        ...
                        inputStage: {
                           ...
                        }
                     }
                  },
                  allPlansExecution: [
                     {
                        nReturned: <int>,
                        executionTimeMillisEstimate: <int>,
                        totalKeysExamined: <int>,
                        totalDocsExamined:<int>,
                        executionStages: {
                           stage: <STAGEA>,
                           nReturned: <int>,
                           executionTimeMillisEstimate: <int>,
                           ...
                           inputStage: {
                              stage: <STAGEB>,
                              ...
                              inputStage: {
                                ...
                              }
                           }
                        }
                     },
                     ...
                  ]
                  operationMetrics: {
                     cpuNanos: <int>,
                     cursorSeeks: <int>,
                     docBytesRead: <int>,
                     docBytesWritten: <int>,
                     docUnitsRead: <int>,
                     docUnitsReturned: <int>,
                     docUnitsWritten: <int>,
                     idxEntryBytesRead: <int>,
                     idxEntryBytesWritten: <int>,
                     idxEntryUnitsRead: <int>,
                     idxEntryUnitsWritten: <int>,
                     totalUnitsWritten: <int>,
                     keysSorted: <int>,
                     sorterSpills: <int>
                  }
               }

      - id: sharded
        name: "Sharded Collections"
        content: |

            For sharded collections, ``explain`` includes the execution
            statistics for each accessed shard.

            .. code-block:: javascript
               :copyable: false

               executionStats: {
                  nReturned: <int>,
                  executionTimeMillis: <int>,
                  totalKeysExamined: <int>,
                  totalDocsExamined: <int>,
                  executionStages: {
                     stage: <STAGE1>
                     nReturned: <int>,
                     executionTimeMillis: <int>,
                     opens: <int>, // Starting in MongoDB 5.1
                     closes: <int>, // Starting in MongoDB 5.1
                     totalKeysExamined: <int>,
                     totalDocsExamined: <int>,
                     totalChildMillis: <NumberLong>,
                     shards: [
                        {
                           shardName: <string>,
                           executionSuccess: <boolean>,
                           executionStages: {
                              stage: <STAGE2>,
                              nReturned: <int>,
                              executionTimeMillisEstimate: <int>,
                              ...
                              chunkSkips: <int>,
                              inputStage: {
                                 stage: <STAGE3>,
                                 ...
                                 numReads: <int>, // Starting in MongoDB 5.1
                                 ...
                                 inputStage: {
                                    ...
                                 }
                              }
                           }
                        },
                        ...
                     ]
                  }
                  allPlansExecution: [
                     {
                        shardName: <string>,
                        allPlans: [
                           {
                              nReturned: <int>,
                              executionTimeMillisEstimate: <int>,
                              totalKeysExamined: <int>,
                              totalDocsExamined:<int>,
                              executionStages: {
                                 stage: <STAGEA>,
                                 nReturned: <int>,
                                 executionTimeMillisEstimate: <int>,
                                 ...
                                 inputStage: {
                                    stage: <STAGEB>,
                                    ...
                                    inputStage: {
                                      ...
                                    }
                                 }
                              }
                           },
                           ...
                        ]
                     },
                     {
                        shardName: <string>,
                        allPlans: [
                         ...
                        ]
                     },
                     ...
                  ]
               }

.. data:: explain.executionStats

   Contains statistics that describe the completed query execution for
   the winning plan. For write operations, completed query execution
   refers to the modifications that *would* be performed, but does
   *not* apply the modifications to the database.

   .. data:: explain.executionStats.nReturned

      Number of documents returned by the winning query plan.
      :data:`~explain.executionStats.nReturned` corresponds to the ``n`` field
      returned by ``cursor.explain()`` in earlier versions of MongoDB.

   .. data:: explain.executionStats.executionTimeMillis

      Total time in milliseconds required for query plan selection and
      query execution. It includes the time it takes to run the trial phase 
      part of the plan selection process, but does not include the network time 
      to transmit the data back to the client.

      The time reported by ``explain.executionStats.executionTimeMillis`` is 
      not necessarily representative of actual query time. During steady 
      state operations (when the query plan is cached), or when using 
      :method:`cursor.hint()` with ``cursor.explain()``, MongoDB bypasses the 
      plan selection process, resulting in a faster actual time, leading to 
      a lower ``explain.executionStats.executionTimeMillis`` value.


   .. data:: explain.executionStats.totalKeysExamined

      Number of index entries scanned.
      :data:`explain.executionStats.totalKeysExamined` corresponds to the
      ``nscanned`` field returned by ``cursor.explain()`` in
      earlier versions of MongoDB.

   .. data:: explain.executionStats.totalDocsExamined

      Number of documents examined during query execution. Common
      query execution stages that examine documents are ``COLLSCAN``
      and ``FETCH``.

      .. note::

         :data:`explain.executionStats.totalDocsExamined` refers to
         the total number of documents examined and *not* to the
         number of documents returned. For example, a stage can
         examine a document in order to apply a filter. If the
         document is filtered out, then it has been examined but
         will not be returned as part of the query result set.

         If a document is examined multiple times during query
         execution,
         :data:`explain.executionStats.totalDocsExamined` counts
         each examination. That is,
         :data:`explain.executionStats.totalDocsExamined` is *not* a
         count of the total number of *unique* documents examined.

   .. data:: explain.executionStats.executionStages

      Details the completed execution of the winning plan as a tree of
      stages; i.e. a stage can have an ``inputStage`` or multiple
      ``inputStages``.

      Starting in MongoDB 5.1, a stage can have these input stages:
      
      - ``thenStage``
      - ``elseStage``
      - ``innerStage``
      - ``outerStage``

      Each stage consists of execution information specific to the
      stage.

      .. data:: explain.executionStats.executionStages.executionTimeMillisEstimate

         The estimated amount of time in milliseconds for query execution.

      .. data:: explain.executionStats.executionStages.opens

         Starting in MongoDB 5.1, the number of times a stage was
         opened during query execution.

      .. data:: explain.executionStats.executionStages.closes

         Starting in MongoDB 5.1, the number of times a stage was
         closed during query execution.

      .. data:: explain.executionStats.executionStages.works

         Specifies the number of "work units" performed by the query 
         execution stage. Query execution divides its work into small 
         units. A "work unit" might consist of examining a single index 
         key, fetching a single document from the collection, applying 
         a projection to a single document, or doing a piece of internal 
         bookkeeping.

         This field appears if the operation used the classic query
         execution engine. 

      .. data:: explain.executionStats.executionStages.saveState

         The number of times that the query stage suspended processing
         and saved its current execution state, for example in
         preparation for yielding its locks.

      .. data:: explain.executionStats.executionStages.restoreState

         The number of times that the query stage restored a saved
         execution state, for example after recovering locks that it had
         previously yielded.

      .. data:: explain.executionStats.executionStages.isEOF

         Specifies whether the execution stage has reached end of stream:

         - If ``true`` or ``1``, the execution stage has reached
           end-of-stream.

         - If ``false`` or ``0``, the stage may still have results to
           return. For example, consider a query with a limit whose
           execution stages consists of a ``LIMIT`` stage with an
           input stage of ``IXSCAN`` for the query. If the query
           returns more than the specified limit, the ``LIMIT`` stage
           will report ``isEOF: 1``, but its underlying ``IXSCAN`` stage
           will report ``isEOF: 0``.

      .. data:: explain.executionStats.executionStages.opType

         For operations on time series collections, the type of operation.

      .. data:: explain.executionStats.executionStages.bucketFilter

         For operations on time series collections, the filter used to reduce
         the number of buckets queried in the bucket catalog.

      .. data:: explain.executionStats.executionStages.residualFilter

         For operations on time series collections, the filter used to query
         the bucket catalog.

      .. data:: explain.executionStats.executionStages.nBucketsUnpacked

         For operations on time series collections, the number of buckets
         unpacked to resolve the operation.

      .. data:: explain.executionStats.executionStages.nMeasurementsDeleted

         For operations on time series collections, the number of
         documents deleted.

      .. data:: explain.executionStats.executionStages.nMeasurementsInserted

         For operations on time series collections, the number of
         documents inserted.

      .. data:: explain.executionStats.executionStages.nMeasurementsMatched

         For operations on time series collections, the number of
         documents matched.

      .. data:: explain.executionStats.executionStages.nMeasurementsModified

         For operations on time series collections, the number of
         documents modified.

      .. data:: explain.executionStats.executionStages.nMeasurementsUpserted

         For operations on time series collections, the number of
         documents upserted.

      .. data:: explain.executionStats.executionStages.inputStage

         Each ``inputStage`` can have different fields depending on the
         value of ``inputStage.stage``. The following table describes 
         possible fields and what stages they can appear in.

         Each ``inputStage`` can have another ``inputStage`` as a field.
         See :ref:`explain-output-structure`.

         .. list-table::                                    
            :widths: 30,40,30
            :header-rows: 1

            * - Field
              - Description
              - Applicable Stages

            * - ``docsExamined``
              - Specifies the number of documents scanned during the
                query execution stage.
              - ``COLLSCAN``, ``FETCH``

            * - ``keysExamined``
              - For query execution stages that scan an index ``keysExamined`` 
                is the total number of in-bounds and out-of-bounds
                keys that are examined in the process of the index scan. If the
                index scan consists of a single contiguous range of keys, only
                in-bounds keys need to be examined. If the index bounds consists of
                several key ranges, the index scan execution process may examine
                out-of-bounds keys in order to skip from the end of one range to the
                beginning of the next.
              - ``IXSCAN``

            * - ``numReads``
              - The number of documents scanned or index keys examined during
                the query execution stage. 

                .. versionadded:: 5.1
              - ``COLLSCAN``, ``IXSCAN``

            * - ``seeks``
              - The number of times that we had to seek the index cursor to
                a new position in order to complete the index scan.
              - ``IXSCAN``
            
            * - ``spilledBytesApprox``
              - The approximate number of in-memory bytes spilled to disk in 
                the stage.

                .. versionadded:: 5.3
              - ``GROUP``

            * - ``spilledRecords``
              - The number of produced records spilled to disk in the stage.
                
                .. versionadded:: 5.3
              - ``GROUP``

            * - ``usedDisk``
              - Whether the stage wrote to disk.

                .. versionadded:: 5.3
              - ``GROUP``

   .. data:: explain.executionStats.allPlansExecution

      Contains *partial* execution information captured during the
      :ref:`plan selection phase <query-plans-query-optimization>` for
      both the winning and rejected plans. The field is present only if
      ``explain`` runs in ``allPlansExecution`` verbosity mode.

   .. data:: explain.executionStats.operationMetrics

      Contains resource consumption statistics, as long as they 
      are not zero. The field is present only if ``explain`` 
      runs in ``executionStats`` verbosity mode or higher and if 
      :parameter:`profileOperationResourceConsumptionMetrics` is enabled.

.. _serverInfo:

``serverInfo``
~~~~~~~~~~~~~~

.. tabs::

   tabs:

      - id: unsharded
        name: "Unsharded Collections"
        content: |

            For unsharded collections, ``explain`` returns the following
            ``serverInfo`` information for the MongoDB instance:

            .. code-block:: javascript
               :copyable: false

               serverInfo: {
                  host: <string>,
                  port: <int>,
                  version: <string>,
                  gitVersion: <string>
               }

      - id: sharded
        name: "Sharded Collections"
        content: |

           For sharded collections, ``explain`` returns the
           ``serverInfo`` for each accessed shard, and a top-level
           ``serverInfo`` object for the :binary:`bin.mongos`.

           .. code-block:: javascript
              :copyable: false

              queryPlanner: {
                 ...
                 winningPlan: {
                    stage: <STAGE1>,
                    shards: [
                       {
                          shardName: <string>,
                          connectionString: <string>,
                          serverInfo: {
                             host: <string>,
                             port: <int>,
                             version: <string>,
                             gitVersion: <string>
                          },
                          ...
                       }
                       ...
                    ]
                 }
               },
               serverInfo: {      // serverInfo for mongos
                 host: <string>,
                 port: <int>,
                 version: <string>,
                 gitVersion: <string>
               }
               ...

.. _explain-results-lookup:

Execution Plan Statistics for Query with ``$lookup`` Pipeline Stage
-------------------------------------------------------------------

.. versionadded:: 5.0

The :ref:`explain results <explain-results>` can include execution
statistics for queries that use a :pipeline:`$lookup` pipeline stage. To
include those execution statistics, you must run the explain operation
in one of these execution verbosity modes:

- :ref:`executionStats <explain-method-executionStats>`
- :ref:`allPlansExecution <explain-method-allPlansExecution>`

The following fields are included in the explain results for a
:pipeline:`$lookup` query:

.. code-block:: none
   :copyable: false

   '$lookup': {
      from: <string>,
      as: <string>,
      localField: <string>,
      foreignField: <string>
   },
   totalDocsExamined: <long>,
   totalKeysExamined: <long>,
   collectionScans: <long>,
   indexesUsed: [ <string_1>, <string_2>, ..., <string_n> ],
   executionTimeMillisEstimate: <long>

To see the descriptions for the fields in the ``$lookup`` section, see
the :pipeline:`$lookup` page.

The other fields are:

.. data:: explain.totalDocsExamined

   Number of documents examined during the query execution.

.. data:: explain.totalKeysExamined

   Number of index keys examined.

.. data:: explain.collectionScans

   Number of times a collection scan occurred during query execution.
   During a collection scan, each document in a collection is compared
   to the query predicate. Collection scans occur if no appropriate
   :ref:`index <indexes>` exists that :ref:`covers
   <indexes-covered-queries>` the query.

.. data:: explain.indexesUsed

   Array of strings with the names of the indexes used by the query.

.. data:: explain.executionTimeMillisEstimate

   Estimated time in milliseconds for the query execution.

.. _explain-output-collection-scan:

Collection Scan
---------------

If the query planner selects a collection scan, the explain result
includes a ``COLLSCAN`` stage.

If the query planner selects an index, the explain result includes a
``IXSCAN`` stage. The stage includes information such as the index
key pattern, direction of traversal, and index bounds.

Starting in MongoDB 5.3, if the query planner selects a :ref:`clustered
index <db.createCollection.clusteredIndex>` for a :ref:`clustered
collection <clustered-collections>` and the query contains bounds that
define the portion of the index to search, the explain result includes a
``CLUSTERED_IXSCAN`` stage. The stage includes information about the
clustered index key and index bounds.

If the query planner selects a :ref:`clustered index
<db.createCollection.clusteredIndex>` for a :ref:`clustered collection
<clustered-collections>` and the query *does not* contain bounds, the
query performs an unbounded collection scan and the explain result
includes a ``COLLSCAN`` stage.

.. note::

   The :parameter:`notablescan` parameter does not allow unbounded
   queries that use a clustered index because the queries require a
   full collection scan.

For more information on execution statistics of collection scans, see
:doc:`/tutorial/analyze-query-plan`.

.. _explain-output-covered-queries:

Covered Queries
---------------

When an index :ref:`covers <indexes-covered-queries>` a query, 
MongoDB can both match the query conditions **and** return the 
results using only the index keys. MongoDB does not need to 
examine documents from the collection to perform any part of the 
query.

When an index covers a query, the explain result has an ``IXSCAN``
stage that is **not** a descendant of a ``FETCH`` stage, and in the
:ref:`executionStats`, the :data:`explain.executionStats.totalDocsExamined` 
is ``0``.

.. _explain-output-or-expression:

``$or`` Expression
------------------

If MongoDB uses indexes for an :query:`$or` expression, the result will
include the ``OR`` stage with an
:data:`explain.queryPlanner.winningPlan.inputStages` array that
details the indexes; e.g.:

.. code-block:: javascript
   :copyable: false

   {
      stage: 'OR',
      inputStages: [
         {
            stage: 'IXSCAN',
            ...
         },
         {
            stage : 'IXSCAN',
            ...
         },
         ...
      ]
   }

In previous versions of MongoDB, ``cursor.explain()`` returned the
``clauses`` array that detailed the indexes.

.. _sort-and-group-executionStats-and-above:

``$sort`` and ``$group`` Stages
-------------------------------

When ``explain`` is run in either  
:ref:`executionStats <explain-method-executionStats>` or 
:ref:`allPlansExecution <explain-method-allPlansExecution>` verbosity 
mode, the :pipeline:`$sort` and :pipeline:`$group` stages have 
additional output.

.. list-table::
   :header-rows: 1
   :widths: 20 15 15 50

   * - Stage

     - Field

     - Type

     - Description

   * - :pipeline:`$sort` 

     - ``totalDataSizeSortedBytesEstimate``

     - long

     - An estimated number of bytes processed in the :pipeline:`$sort` 
       stage.
      
   * - :pipeline:`$sort`
 
     - ``usedDisk``

     - boolean

     - Whether the :pipeline:`$sort` stage wrote to disk. 

   * - :pipeline:`$group`

     - ``totalOutputDataSizeBytes``
     
     - long

     - An estimate of the total size of all documents output by the 
       :pipeline:`$group` stage in bytes.

   * - :pipeline:`$group`
 
     - ``usedDisk``

     - boolean

     - Whether the :pipeline:`$group` stage wrote to disk. 

   * - :pipeline:`$group`
   
     - ``spillFileSizeBytes``

     - long 

     - The size of the spill file written to disk in the :pipeline:`$group` 
       stage. Due to compression, the value of ``spillFileSizeBytes`` should be 
       less than or equal to ``numBytesSpilledEstimate``.

   * - :pipeline:`$group` 
   
     - ``numBytesSpilledEstimate``

     - long 
     
     - An estimate of the number of bytes written to disk in the 
       :pipeline:`$group` stage before compression.

.. _explain-output-sort:

Sort Stage
----------

If MongoDB cannot use an index or indexes to obtain the sort order, the
results include a ``SORT`` stage indicating a blocking sort operation.
Blocking sorts do not block concurrent operations on the
collection or database. The name refers to the requirement that the
``SORT`` stage reads all input documents before returning any output
documents, blocking the flow of data for that specific query.

If MongoDB requires using more than 100 megabytes of system memory for
the blocking sort operation, MongoDB returns an error *unless* the query
specifies :method:`cursor.allowDiskUse()`. :method:`cursor.allowDiskUse()` 
allows MongoDB to use temporary files on disk to store data exceeding the 100 
megabyte system memory limit while processing a blocking sort operation. If the 
explain plan does not contain an explicit ``SORT`` stage, then MongoDB can use 
an index to obtain the sort order.

.. _explain-output-query-shape-hash:

Query Shape Hash
----------------

Starting in MongoDB 8.0, ``explain`` outputs the following field:

.. data:: explain.queryShapeHash

   A hexadecimal string that represents the hash of the :term:`query
   shape`. For more information, see :ref:`query-shapes`.

   .. versionadded:: 8.0

.. toctree::
   :titlesonly:

   Interpret Results </tutorial/analyze-query-plan>
