.. _security-gcp-kms:

==========================================
Manage Customer Keys with Google Cloud KMS
==========================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

|service| uses your |gcp| Service Account Key to encrypt and decrypt
your MongoDB master keys. These MongoDB master keys are used to encrypt
cluster database files and
:ref:`cloud providers snapshots <backup-cloud-provider>`.

.. include:: /includes/fact-atlas-key-rotation.rst

|service| encrypts your data at rest using encrypted storage media.
Using keys you manage with |gcp| |kms|, |service| encrypts your
data a second time when it writes it to the MongoDB
:manual:`encrypted storage engine </core/security-encryption-at-rest>`.
You use your |gcp| |sak| to encrypt the MongoDB master encryption keys.

This page covers configuring customer key management using |gcp| on
your |service| project.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

Enable Customer-Managed Keys with Google Cloud KMS
--------------------------------------------------

.. _gcp-kms-prereqs:
.. _security-gcp-kms-restrictions:

Prerequisites
~~~~~~~~~~~~~

To enable customer-managed keys with |gcp| |kms| for a MongoDB
project, you must have:

.. include:: /includes/fact-gcp-kms-prereqs.rst

.. _gcp-kms-configure-project:

Enable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must enable customer key management for a project before you can
enable it on a cluster in that project.

.. include:: /includes/steps/configure-gcp-encryption-for-project.rst

.. _gcp-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you :ref:`gcp-kms-configure-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:ref:`Manage your own encryption keys 
<create-cluster-enable-encryption>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

Alerts
~~~~~~

|service| automatically creates an :alert:`encryption key rotation alert <GCP encryption key elapsed time since last rotation is above (n) days>`
once you configure customer key management for a project. You can reset this alert at any time by
:ref:`rotating your GCP Key Version Resource ID <gcp-kms-rotate-key>`.

.. _gcp-kms-rotate-key:

Rotate your GCP Key Version Resource ID
---------------------------------------

.. meta::
   :keywords: encryption

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

.. include:: /includes/fact-atlas-key-rotation.rst

|service| does *not* automatically rotate the Key Version Resource ID
used for |gcp| key management.

|service| automatically creates an
:alert:`encryption key rotation alert <GCP encryption key elapsed time since last rotation is above (n) days>`
to remind you to rotate your GCP Key Version Resource ID every 90 days
by default when you :ref:`enable Encryption at Rest <security-gcp-kms>`
for |a-service| project.

Prerequisites
~~~~~~~~~~~~~

You must create a new Service Account Key in the |gcp| account
associated with your |service| project.

Procedure
~~~~~~~~~

The following procedure documents how to rotate your |service| project Key Identifier by specifying a new Key Version Resource ID in |service|.

.. include:: /includes/steps/rotate-gcp-encryption-key.rst

Alerts
~~~~~~

|service| resets the
:alert:`encryption key rotation alert <GCP encryption key elapsed time since last rotation is above (n) days>`
timer at the completion of this procedure.

Related Topics
--------------

- To enable Encryption at Rest using your Key Management when deploying
  an |service| cluster, see :ref:`create-cluster-enable-encryption`.

- To enable Encryption at Rest using your Key Management for an
  existing |service| cluster, see
  :ref:`scale-cluster-enable-encryption`.

- To learn more about Encryption at Rest using your Key Management in
  |service|, see :ref:`security-kms-encryption`.

- To learn more about MongoDB Encryption at Rest, see
  :manual:`Encryption at Rest </core/security-encryption-at-rest/>` in
  the MongoDB server documentation.

- To learn more about Encryption at Rest with {+Cloud-Backup+}s, see
  :ref:`encrypted-cloud-provider-snapshot`.
