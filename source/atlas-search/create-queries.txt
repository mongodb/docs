.. _fts-create-queries:

==============
Create a Query
==============

.. default-domain:: mongodb

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: atlas search, create atlas search query, atlas search operators, perform specific searches, $search aggregation pipeline stage, $searchMeta pipeline stage, atlas search options, run atlas search query with mongosh, run atlas search query with a driver, run atlas search query with the atlas user interface, get detailed score results
   :description: Create an Atlas Search query to perform a full text search on indexed fields using the Mongo Shell (mongosh), MongoDB Compass, a driver, or the Atlas user interface.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

After you create :ref:`an Atlas Search index <ref-index-definitions>` on
the collection for all the fields that you want to search, you can
create |fts| queries using the :pipeline:`$search` and
:pipeline:`$searchMeta` stages.   

You can create and run an |fts| query by performing the following steps. 

.. procedure::
   :style: normal

   .. step:: Construct your |fts| query.
      
      a. Select an aggregation pipeline stage.

         Select a tab corresponding to the aggregation pipeline stage you want to use:
      
         .. tabs::

            .. tab:: $search
               :tabid: search-stage

               You can use the :ref:`$search <search-agg-pipeline>` aggregation
               pipeline to perform a full-text search of the indexed fields for
               data that matches your query.

               .. code-block:: json
                  :emphasize-lines: 2

                  {
                     $search: {
                        "index": "<index-name>",
                        ...
                     }
                  }

            .. tab:: $searchMeta
               :tabid: searchMeta-stage

               You can use the :ref:`$searchMeta <searchMeta-agg-pipeline>`
               aggregation pipeline stage to return metadata about your search
               results.

               .. code-block:: json
                  :emphasize-lines: 2

                  {
                     $searchMeta: {
                        "index": "<index-name>",
                        ...
                     }
                  }

         To learn more, see :ref:`Choose the Aggregation Pipeline
         Stage <query-syntax-ref>`. 

      b. Specify operators.
                     
         Select one or more :ref:`operators <fts-operators>` or
         :ref:`collectors  <collectors-ref>` to perform a  
         specific search on your collection.
      
         .. tabs::

            .. tab:: $search
               :tabid: search-stage

               .. code-block:: json
                  :emphasize-lines: 4-6

                  {
                     $search: {
                        "index": "<index-name>",
                        "<operator-name>": {
                        <operator-specifications>
                        },
                     }
                  }

            .. tab:: $searchMeta
               :tabid: searchMeta-stage

               .. code-block:: json
                  :emphasize-lines: 4-6

                  {
                     $searchMeta: {
                        "index": "<index-name>",
                        "<operator-name>"|"<collector-name>": {
                           <operator-specifications>|<collector-specifications>
                        }
                     }
                  }

         To learn more, see :ref:`Use Operators and Collectors in
         Atlas Search Queries <operators-ref>`. 

      c. (Optional) Retrieve additional information about your |fts| query.
      
         .. tabs::

            .. tab:: $search
               :tabid: search-stage

               Specify one or more options to adjust your |fts| query results.

               .. code-block:: json
                  :emphasize-lines: 7-9

                  {
                     $search: {
                        "index": "<index-name>",
                        "<operator-name>": {
                           <operator-specifications>
                        },
                        "highlight": {
                           <highlight-options>
                        }
                     }
                  }

               You can customize your search results in the following ways:
               
               .. list-table::
                  :widths: 30 70
                  :header-rows: 1
                        
                  * - Option
                    - Use Case
                        
                  * - :ref:`score <scoring-ref>`
                    - Modify the ``score`` of the documents in the results to ensure |fts| returns    relevant results.
                        
                  * - :ref:`scoreDetail <fts-score-details>`
                    -  Retrieve a detailed breakdown of the score for each document |fts| returns.

                  * - :ref:`highlight <highlight-ref>`
                    - Display your search terms in their original
                        context as fields in your query result.
                        
                  * - :ref:`explain <explain-ref>`
                    - Retrieve information and execution statistics
                      about which Lucene queries |fts| executed to
                      satify your query, and how much time your query
                      spends in the various stages of execution.

                  * - :ref:`returnStoredSource <fts-return-stored-source-option>`
                    - Run your |fts| query more efficiently by only
                      retrieving fields stored on ``mongot`` as
                      specified in your |fts| index definition for a
                      collection.

                  * - :ref:`count <count-ref>` 
                    - Display the number of results from your |fts| query.

                  * - :ref:`sort <sort-ref>` 
                    - Sort your |fts| query results by number, string, and date fields and by score.

            .. tab:: $searchMeta
               :tabid: searchMeta-stage
               
               Return metadata, such as the number of results, along with your |fts| query.

               .. code-block:: json
                  :emphasize-lines: 7-9

                  {
                     $searchMeta: {
                        "index": "<index-name>",
                        "<operator-name>": {
                           <operator-specifications>
                        },
                        "count": {
                           <count-options>
                        }
                     }
                  }

         To learn more, see :ref:`Define Additional Search Options
         <fts-search-options>`. 

   .. step:: Run your |fts| query.

      Review your |fts| query syntax and then run it in 
      your application using a :ref:`driver <atlas-search-query-drivers>`, 
      {+mongosh+}, :ref:`Compass <atlas-search-query-compass>`,
      or the :ref:`Search Tester <atlas-search-query-ui>`.

.. note:: 

   .. include:: /includes/fts/facts/fact-fts-troubleshooting.rst

Procedure 
---------

.. toctree::
   :titlesonly:

   1. Choose Aggregation Pipeline Stage </atlas-search/query-syntax>
   2. Use Operators & Collectors </atlas-search/operators-and-collectors>
   3. Construct Query Path </atlas-search/path-construction>
   4. Score Documents </atlas-search/scoring>
   5. Define Additional Search Options </atlas-search/search-options>
