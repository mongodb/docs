.. _security-azure-kms:

=========================================
Manage Customer Keys with Azure Key Vault
=========================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

|service| uses your Azure Key Identifier (AKI) from your Azure Key
Vault (AKV) to encrypt and decrypt your MongoDB master keys. These
MongoDB master keys are used to encrypt cluster database files and
:ref:`cloud providers snapshots <backup-cloud-provider>`.

.. include:: /includes/fact-atlas-key-rotation.rst

|service| encrypts your data at rest using encrypted storage media.
Using keys you manage with |akv|, |service| encrypts your
data a second time when it writes it to the MongoDB
:manual:`encrypted storage engine </core/security-encryption-at-rest>`.
You use your |aki| to encrypt the MongoDB master encryption keys.

This page covers configuring customer key management using |akv| on
your |service| project.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

Enable Customer-Managed Keys with Azure Key Vault
-------------------------------------------------

.. _azure-kms-prereqs:

.. _security-azure-kms-restrictions:

Prerequisites
~~~~~~~~~~~~~

To enable customer-managed keys with Azure Key Vault for a MongoDB
project, you must:

.. include:: /includes/fact-azure-kms-prereqs.rst

.. _azure-kms-configure-project:

Enable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must enable customer key management for a project before you can
enable it on a cluster in that project.

.. include:: /includes/steps/configure-azure-encryption-for-project.rst

.. _azure-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you :ref:`azure-kms-configure-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:ref:`Manage your own encryption keys 
<create-cluster-enable-encryption>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

Disable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must disable customer key management on each cluster in a project
before you can disable the feature for the project.

.. important::

   Do *not* disable or delete any |akv| keys that any cluster in your
   |service| project uses before you have disabled customer key
   management within the |service| project. If |service| cannot access
   an |akv| key, any data that key encrypted becomes inaccessible.

Revoke Access to an Encryption Key
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can revoke |service|'s access to an encryption key from within |akv|.
|service| automatically pauses your {+clusters+} when you revoke access to the
encryption key unless your |akv| IP access list restricts the |service| control plane.

To allow automatic pausing of your {+cluster+}, you must either:

- Disable the IP access list for your |akv|
- Allow access to your |akv| from the :ref:`Atlas control plane <atlas-add-inbound-ips>`.  
  
.. note::
    
   MongoDB adds new |service| control plane IP addresses over time. You must keep
   the IP access list updated to allow automatic {+cluster+} pausing while using an
   IP access list for your |akv|.

If the IP access list for your |akv| restricts access from the |service| control plane when
you revoke access to an encryption key, you must pause
your {+clusters+} manually to revoke |service|'s access.

Alerts
~~~~~~

|service| automatically creates an
:alert:`encryption key rotation alert <Azure encryption key elapsed time since last rotation is above (n) days>`
once you configure customer key management for a project.

To reset this alert, :ref:`azure-kms-rotate-key`.

.. _azure-kms-rotate-key:

Rotate your Azure Key Identifier
--------------------------------

.. meta::
   :keywords: encryption

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

.. include:: /includes/fact-atlas-key-rotation.rst

|service| does *not* automatically rotate the Key Identifier
used for Azure-provided key management.

|service| automatically creates an
:alert:`encryption key rotation alert <Azure encryption key elapsed time since last rotation is above (n) days>`
to remind you to rotate your Azure Key Identifier every 90 days by
default when you :ref:`enable Encryption at Rest <security-azure-kms>`
for |a-service| project.

Prerequisites
~~~~~~~~~~~~~

You must create a new key in the Azure Key Vault associated to the
|service| project.

Procedure
~~~~~~~~~

The following procedure documents how to rotate your |service| project Key Identifier by specifying a new key identifier in |service|.

.. include:: /includes/steps/rotate-azure-encryption-key.rst

Alerts
~~~~~~

|service| resets the :alert:`encryption key rotation alert <Azure encryption key elapsed time since last rotation is above (n) days>`
alert at the completion of this procedure.

Related Topics
--------------

- To enable Encryption at Rest using your Key Management when deploying
  an |service| cluster, see :ref:`create-cluster-enable-encryption`.

- To enable Encryption at Rest using your Key Management for an
  existing |service| cluster, see
  :ref:`scale-cluster-enable-encryption`.

- To learn more about Encryption at Rest using your Key Management in
  |service|, see :ref:`security-kms-encryption`.

- To learn more about MongoDB Encryption at Rest, see
  :manual:`Encryption at Rest </core/security-encryption-at-rest/>` in
  the MongoDB server documentation.

- To learn more about Encryption at Rest with {+Cloud-Backup+}s, see :ref:`encrypted-cloud-provider-snapshot`.
