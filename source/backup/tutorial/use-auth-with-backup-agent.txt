.. _use-auth-with-backup-agent:

==================================================
Use MongoDB Authentication with the |backup| Agent
==================================================

If you are using |backup| with a MongoDB instance with authentication
enabled, there are additional steps you will need to take before you
can start using |backup|.

The |backup| agent does not have to be configured with authentication. One
agent can handle both authenticated and non-authenticated replica sets and
hosts with no agent upgrade or reconfiguration needed. The agent receives
configurations from replica sets and hosts, as well as credentials from the MMS
:guilabel:`Backup` tab.

Create a New User for the |backup| Agent
----------------------------------------

Connect to the :program:`mongod` or :program:`mongos` instance you
will be backing up using the :program:`mongo` shell.

Create a new user for the |backup| Agent using a command that
resembles the following:

.. code-block:: javascript

   use admin
   db.addUser(
   {
       user: 'USERNAME',
       pwd: 'PASSWORD',
       roles: ['readAnyDatabase', 'clusterAdmin', 'userAdminAnyDatabase'],
       otherDBRoles: {local: ['readWrite'], admin: ['readWrite']}
   } )

.. TODO: following note is true until BRS-837 gets resolved

You can now install the |backup| Agent. See:
:doc:`/backup/tutorial/install-and-start-backup-agent` for more
information. You will need to provide the username and password during
the |backup| setup process.

Resync |backup| Agent Username and Password
-------------------------------------------

Credentials for MMS and |backup| agents are independent and, therefore, can be
managed separately. |backup| agent username and password settings can be reset
on the local machines then resynced with the MMS application for each replica
set.

To resynchronize |backup| agent credentials:

1. Create a backup user with proper entitlements.

2. Go to the Backup tab in MMS, click :guilabel:`Replica Set Status`, then
   click the :guilabel:`resync` link for a replica set.

3. Enter the auth credentials and approve a resync.

Enable Authentication for Replica Sets
--------------------------------------

MMS Backup is available for replica sets, with or without authentication. A
replica set is a group of :program:`mongod` processes that maintain the same
data set.

To configure a replica set with authentication enabled:

1. Create a backup user with proper entitlements.

2. Restart your replica set with authentication enabled.

3. Go to the Backup tab in MMS, click :guilabel:`Replica Set Status`, then
   click the :guilabel:`resync` link for a replica set.

4. Enter the auth credentials and approve a resync.

You can optionally shut down the Backup Agent before you start. However,
shutting down the agent will cause backups of other replica sets to fall
behind. Leaving the agent up will result in some error messages in the logs
until you perform a resync.

