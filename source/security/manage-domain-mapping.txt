.. _mms-manage-fed-domain-map:

==================================================
Manage Domain Mapping for Federated Authentication
==================================================

.. default-domain:: mongodb

.. meta::
   :keywords: connect

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

You can map domains to your |idp| to streamline the login experience
for users from specified domains by authenticating them through an
|idp|. Domain mapping ensures that all users with a particular domain
in their email address have the same login experience.

.. important::

   You can map a single domain to multiple identity providers. If you
   do, users who log in using that domain must authenticate using the
   :guilabel:`Login URL` associated with the desired |idp|. If users
   attempt to use that domain on the |mms| login screen, |mms|
   returns an error.

To map a domain to your |idp|, you must verify that you own the
domain. You can either:

- Upload an |html| file containing a verification key to a host in your
  domain or

- Create a |dns| :wikipedia:`TXT record </TXT_record?oldid=930320014>`
  that contains a verification key.

Prerequisites
-------------

To complete this tutorial, you must have already linked an |idp| to
|mms|. To learn how to link an |idp| to |mms|, see
:ref:`mms-manage-fed-auth`.

Federation Management Access
----------------------------

.. include:: /includes/fact-fed-management-access.rst

Map a Domain to Your Identity Provider
--------------------------------------

Open the :guilabel:`Federation Management Console`
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/steps/open-fed-auth-console.rst

Enter Domain Mapping Information
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. Click :guilabel:`Add a Domain`.

#. On the :guilabel:`Domains` screen, click :guilabel:`Add Domain`.

#. Enter the following information for your domain mapping:

   .. list-table::
      :widths: 20 40
      :header-rows: 1
      
      * - Field
        - Description

      * - Display Name
        - Name to easily identify the domain.

      * - Domain Name
        - :wikipedia:`Domain name </Domain_name&oldid=919136520>` to
          map.

#. Click :guilabel:`Next`.

Choose How to Verify Your Domain
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note::

   You can choose the verification method once. It cannot be modified.
   To select a different verification method, delete and recreate the
   domain mapping.

Select the appropriate tab based on whether you are verifying
your domain by uploading an |html| file or creating a |dns| TXT record:

.. tabs::

   .. tab:: Upload HTML File
      :tabid: upload-html

      Upload an |html| file containing a verification key to verify that
      you own your domain.

      1. Click :guilabel:`HTML File Upload`.

      #. Click :guilabel:`Next`.

      #. Download the ``mongodb-site-verification.html`` file
         that |mms| provides.

      #. Upload the |html| file to a web site on your domain. You must
         be able to access the file at
         ``<https://host.domain>/mongodb-site-verification.html``.

      #. Click :guilabel:`Finish`.

   .. tab:: Create DNS Record
      :tabid: create-dns

      Create a |dns| TXT record with your domain provider to verify that
      you own your domain. Each |dns| record associates a specific
      |mms| organization with a specific domain.

      1. Click :guilabel:`DNS Record`.

      #. Click :guilabel:`Next`.

      #. Copy the provided TXT record. The TXT record has the following
         form:

         .. code-block:: ini
            :copyable: false

            mongodb-site-verification=<32-character string>

      #. Log in to your domain name provider (such as GoDaddy.com or
         networksolutions.com).

      #. Add the TXT record that |mms| provides to your domain.

      #. Return to |mms| and click :guilabel:`Finish`.

Verify Your Domain
~~~~~~~~~~~~~~~~~~

The :guilabel:`Domains` screen displays both unverified and verified
domains you've mapped to your |idp|. To verify your domain, click
the target domain's :guilabel:`Verify` button. |mms| shows whether
the verification succeeded in a banner at the top of the screen.

.. _associate-domain-with-idp:

Associate Your Domain with Your Identity Provider
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After successfully verifying your domain, associate the domain with
your |idp|:

1. Click :guilabel:`Identity Providers` in the left navigation.

#. For the |idp| you want to associate with your domain, click
   :icon-fa5:`pencil-alt` next to :guilabel:`Associated Domains`.

#. Select the domain you want to associate with the |idp|. 

#. Click :guilabel:`Confirm`.

Test Your Domain Mapping
~~~~~~~~~~~~~~~~~~~~~~~~

.. important::

   While testing, keep your session logged in to the
   :guilabel:`Federation Management Console`. If you log out while your
   federation is not properly configured, you may get locked out of
   your account.

To test the integration between your domain and your |idp|:

#. In a private browser window, navigate to the |mms| log in page.

#. Enter a username (usually an email address) with your verified
   domain.

   .. example::

      If your verified domain is ``mongodb.com``, enter
      ``alice@mongodb.com``.

#. Click :guilabel:`Next`.

If you mapped your domain correctly, you're redirected to your |idp| to
authenticate. If authenticating with your |idp| succeeds, you're
redirected back to |mms|. 

.. note::

   You can bypass the |mms| log in page by navigating directly to
   your |idp|'s :guilabel:`Login URL`. The :guilabel:`Login URL`
   takes you directly to your |idp| to authenticate.

Delete a Domain Mapping
-----------------------

Open the :guilabel:`Federation Management Console`
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/steps/open-fed-auth-console.rst

Delete the Domain
~~~~~~~~~~~~~~~~~

.. important::

   You cannot delete a domain mapping if it is
   :ref:`associated with an IdP <associate-domain-with-idp>`.
   To disassociate a domain from an IdP:
   
   1. From the management console, click :guilabel:`Identity Providers`
      in the left navigation.
      
   #. For the |idp| you want to disassociate from your domain, click
      :icon-fa5:`pencil-alt` next to :guilabel:`Associated Domains`.

   #. Deselect the domain desired domain.

   #. Click :guilabel:`Confirm`.

To delete a domain from the Federation Management instance:

1. Click :guilabel:`Add a Domain`.

#. Open the :guilabel:`Actions` menu for the domain you want to delete.

#. Click :guilabel:`Delete`.

#. Click :guilabel:`Confirm`.
