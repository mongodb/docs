.. _collection-update:

=======================================
db.collection.update() (mongosh method)
=======================================

.. default-domain:: mongodb

.. meta:: 
   :keywords: deprecated
   :description: The update method is deprecated should be replaced by updateOne or updateMany.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-mongosh-shell-method-deprecated.rst

Definition
----------

.. method:: db.collection.update(query, update, options)

   Modifies an existing document or documents in a collection. The
   method can modify specific fields of an existing document or documents
   or replace an existing document entirely, depending on the
   :ref:`update parameter <update-parameter>`.

   By default, the :method:`db.collection.update()` method updates a
   **single** document. Include the option :ref:`multi: true <multi-parameter>`
   to update all documents that match the query criteria.

Compatibility
-------------

.. |operator-method| replace:: ``db.collection.update()``

This method is available in deployments hosted in the following environments:

.. include:: /includes/fact-environments-atlas-only.rst

.. include:: /includes/fact-environments-atlas-support-all.rst

.. include:: /includes/fact-environments-onprem-only.rst

Syntax
------

.. versionchanged:: 5.0

The :method:`db.collection.update()` method has the following form:

.. code-block:: javascript

   db.collection.update(
      <query>,
      <update>,
      {
        upsert: <boolean>,
        multi: <boolean>,
        writeConcern: <document>,
        collation: <document>,
        arrayFilters: [ <filterdocument1>, ... ],
        hint:  <document|string>,
        let: <document>,
        maxTimeMS: <int>,
        bypassDocumentValidation: <boolean>
      }
   )

.. _update-parameters:

Parameters
~~~~~~~~~~

The :method:`db.collection.update()` method takes the following
parameters:

.. list-table::
   :header-rows: 1
   :widths: 20 20 80

   * - Parameter
     - Type
     - Description

   * - :ref:`query <update-query>`
     - document
     - .. _update-query:

       The selection criteria for the update. The same :ref:`query
       selectors <query-selectors>` as in the :method:`find()
       <db.collection.find()>` method are available.

       .. include:: /includes/fact-upsert-id.rst
          :end-before: end-short-description

   * - :ref:`update <update-parameter>`
     - document or pipeline
     - .. _update-parameter:

       The modifications to apply. Can be one of the following:

       .. list-table::
          :widths: 40 80
          :class: border-table

          * - :ref:`Update document <update-method-update-document>`
            - .. _update-method-update-document:

              Contains only :ref:`update operator expressions
              <update-operators>`.

          * - :ref:`Replacement document
              <update-method-replacement-document>`
            - .. _update-method-replacement-document:

              Contains only ``<field1>: <value1>`` pairs.

          * - :ref:`Aggregation pipeline <update-method-agg-pipeline>`

            - .. _update-method-agg-pipeline:

              Contains only the following aggregation stages:

              .. include:: /includes/list-update-agg-stages.rst

       For details and examples, see :ref:`update-method-examples`.

   * - :ref:`upsert <update-upsert>`
     - boolean
     - .. _update-upsert:

       .. include:: /includes/extracts/update-upsert-behavior-method.rst

   * - :ref:`multi <update-multi>`
     - boolean
     - .. _update-multi:

       Optional. If set to ``true``, updates multiple documents that
       meet the ``query`` criteria. If set to ``false``, updates one
       document. The default value is ``false``. For additional
       information, see :ref:`Update Multiple Documents Examples
       <multi-parameter>`.

   * - :ref:`writeConcern <update-wc>`
     - document
     - .. _update-wc:

       Optional. A document expressing the :ref:`write concern
       <write-concern>`. Omit to use the default write concern 
       ``w: "majority"``.

       .. include:: /includes/extracts/transactions-operations-write-concern.rst

       For an example using ``writeConcern``, see
       :ref:`example-update-write-concern`.

   * - :ref:`collation <update-collation>`
     - document
     - .. _update-collation:

       Optional.

       .. include:: /includes/extracts/collation-description.rst

       For an example using ``collation``, see
       :ref:`example-update-collation`.

   * - :ref:`arrayFilters <update-array-filters>`
     - array
     - .. _update-array-filters:

       Optional. An array of filter documents that determine which array
       elements to modify for an update operation on an array field.

       In the :ref:`update document <update-parameter>`, use the
       :update:`$[\<identifier\>]` to define an identifier to update
       only those array elements that match the corresponding filter
       document in the ``arrayFilters``.

       You cannot have an array filter document for an identifier if
       the identifier is not included in the update document.

       For examples, see :ref:`update-arrayFilters`.

   * - :ref:`hint <update-hint>`
     - Document or string
     - .. _update-hint:

       Optional. A document or string that specifies the :ref:`index
       <indexes>` to use to support the :ref:`query predicate
       <update-query>`.

       The option can take an index specification document or the index
       name string.

       If you specify an index that does not exist, the operation
       errors.

       For an example, see :ref:`ex-update-hint`.

   * - :ref:`let <db.collection.update-let-syntax>`
     - document
     - .. _db.collection.update-let-syntax:
     
       Optional.
     
       .. include:: /includes/let-variables-syntax.rst
       .. include:: /includes/let-variables-syntax-note.rst

       For a complete example using ``let`` and variables, see
       :ref:`db.collection.update-let-example`.

   * - :ref:`maxTimeMS <update-maxTimeMS>`
     - integer
     - .. _update-maxTimeMS:
        
       Optional. Specifies the time limit in milliseconds for the
       update operation to run before timing out.

   * - :ref:`bypassDocumentValidation <update-bypassDocumentValidation>`
     - boolean
     - .. _update-bypassDocumentValidation:
       
       Optional. Enables :dbcommand:`insert` to bypass schema validation
       during the operation. This lets you insert documents that do not
       meet the validation requirements.

Returns
~~~~~~~

The method returns a :ref:`writeresults-update` document that contains
the status of the operation.

Access Control
--------------

On deployments running with :setting:`~security.authorization`, the
user must have access that includes the following privileges:

- :authaction:`update` action on the specified collection(s).

- :authaction:`find` action on the specified collection(s).

- :authaction:`insert` action on the specified collection(s) if the
  operation results in an upsert.

The built-in role :authrole:`readWrite` provides the required
privileges.

.. _update-behavior:

Behavior
--------

Limitations
~~~~~~~~~~~

If you set ``multi: true``, use the ``update()`` method only for 
:term:`idempotent` operations.

Using ``$expr`` in an Update with ``Upsert``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Attempting to use the :manual:`$expr </reference/operator/query/expr/>` 
operator with the upsert flag set to ``true`` will generate an error.

.. _update-sharded-collection:

Sharded Collections
~~~~~~~~~~~~~~~~~~~

To use :method:`db.collection.update()` with ``multi: false`` on a
sharded collection, you must include an exact match on the ``_id``
field or target a single shard (such as by including the shard key).

When the :method:`db.collection.update()` performs update operations
(and not document replacement operations),
:method:`db.collection.update()` can target multiple shards.

.. seealso::

   :method:`~db.collection.findAndModify()`


Replace Document Operations on a Sharded Collection
```````````````````````````````````````````````````

Replace document operations attempt to target a single shard, first by using 
the query filter. If the operation cannot target a single shard by the query 
filter, it then attempts to target by the replacement document.

In earlier versions, the operation attempts to target using the
replacement document.

.. _method-update-sharded-upsert:

``upsert`` on a Sharded Collection
``````````````````````````````````

For a :method:`db.collection.update()` operation that includes
:ref:`upsert: true <update-upsert>` and is on a sharded collection, you
must include the full shard key in the ``filter``:

- For an update operation.

- For a replace document operation.

.. include:: /includes/extracts/missing-shard-key-equality-condition-update.rst

.. _method-update-shard-key-modification:

Shard Key Modification
``````````````````````

.. include:: /includes/limits-sharding-shardkey-document-immutable.rst

To modify the **existing** shard key value with
:method:`db.collection.update()`:

- You :red:`must` run on a :binary:`~bin.mongos`. Do :red:`not`
  issue the operation directly on the shard.

- You :red:`must` run either in a :ref:`transaction
  <transactions>` or as a :ref:`retryable write
  <retryable-writes>`.

- You :red:`must` specify ``multi: false``.

- You :red:`must` include an equality :ref:`query filter
  <update-query>` on the full shard key.

.. tip::

   .. include:: /includes/extracts/missing-shard-key-equality-condition-abridged.rst

See also :ref:`method-update-sharded-upsert`.

.. _method-update-missing-shard-key:

Missing Shard Key
`````````````````

Documents in a sharded collection can be
:ref:`missing the shard key fields <shard-key-missing>`. To use
:method:`db.collection.update()` to set the document's
**missing** shard key, you :red:`must` run on a
:binary:`~bin.mongos`. Do :red:`not` issue the operation directly on
the shard.

In addition, the following requirements also apply:

.. list-table::
   :header-rows: 1
   :widths: 30 70

   * - Task

     - Requirements

   * - To set to ``null``

     - - Can specify ``multi: true``.

       - Requires equality filter on the full shard key if ``upsert:
         true``.

   * - To set to a non-``null`` value

     - - :red:`Must` be performed either inside a :ref:`transaction
         <transactions>` or as a :ref:`retryable write
         <retryable-writes>`.

       - :red:`Must` specify ``multi: false``.

       - Requires equality filter on the full shard key if either:

         - ``upsert: true``, or

         - if using a replacement document and the new shard key
           value belongs to a different shard.

.. tip::

   .. include:: /includes/extracts/missing-shard-key-equality-condition-abridged.rst

See also:

- :ref:`method-update-sharded-upsert`

- :ref:`shard-key-missing`

Transactions
~~~~~~~~~~~~

.. include:: /includes/extracts/transactions-supported-operation.rst

.. include:: /includes/extracts/transactions-usage.rst

Upsert within Transactions
``````````````````````````

.. include:: /includes/extracts/transactions-upsert-availability.rst


Write Concerns and Transactions
````````````````````````````````

.. include:: /includes/extracts/transactions-operations-write-concern.rst

.. |operation| replace:: :method:`db.collection.update()`

.. _update-method-examples:
.. _update-behavior-operator-expressions-document:
.. _multi-parameter:
.. _example-update-specific-fields:
.. _example-update-replace-fields:
.. _update-behavior-replacement-document:

Oplog Entries
~~~~~~~~~~~~~

If a ``db.collection.update()`` operation successfully updates one or
more documents, the operation adds an entry on the :term:`oplog`
(operations log). If the operation fails or does not find any documents
to update, the operation does not add an entry on the oplog. 

Upsert with Dotted ``_id`` Query
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-upsert-id.rst

.. _update-with-unique-indexes:
.. _retryable-update-upsert:
.. _upsert-duplicate-key-error:

Upsert with Duplicate Values
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Upserts can create duplicate documents, unless there is a
:ref:`unique index <index-type-unique>` to prevent duplicates.

If all ``db.collection.update()`` operations finish the query phase before any
client successfully inserts data, **and** there is no unique index on
the ``name`` field, each ``db.collection.update()`` operation may result in an
insert, creating multiple documents with ``name: Andy``.

A unique index on the ``name`` field ensures that only one document
is created. With a unique index in place, the multiple ``db.collection.update()``
operations now exhibit the following behavior:

- Exactly one ``db.collection.update()`` operation will successfully insert a new
   document.

- Other ``db.collection.update()`` operations either update the newly-inserted
   document or fail due to a unique key collision.
   
   In order for other ``db.collection.update()`` operations to update the
   newly-inserted document, **all** of the following conditions must
   be met:

   - The target collection has a unique index that would cause a
      duplicate key error.

   - The update operation is not ``updateMany`` or ``multi`` is
      ``false``.

   - The update match condition is either:

     - A single equality predicate. For example ``{ "fieldA" : "valueA" }``

     - A logical AND of equality predicates. For example ``{ "fieldA" :
       "valueA", "fieldB" : "valueB" }``

   - The fields in the equality predicate match the fields in the
      unique index key pattern.

   - The update operation does not modify any fields in the
      unique index key pattern.

.. seealso::

   :update:`$setOnInsert`

.. _update-arrayFilters:

Array Update Operations
~~~~~~~~~~~~~~~~~~~~~~~

In the update document, use the :update:`$[\<identifier\>]` filtered positional
operator to define an identifier, which you then reference in the array filter
documents. You cannot have an array filter document for an identifier if the
identifier is not included in the update document.

The ``<identifier>`` must begin with a lowercase letter and contain only
alphanumeric characters.

You can include the same identifier multiple times in the update document;
however, for each distinct identifier (``$[identifier]``) in the update
document, you must specify **exactly one** corresponding array filter document.
That is, you cannot specify multiple array filter documents for the same
identifier. However, you can specify compound conditions on the same identifier
in a single filter document

.. note::

   ``arrayFilters`` is not available for updates that use an
   aggregation pipeline.

.. _writeresults-update:

WriteResult
-----------

Successful Results
~~~~~~~~~~~~~~~~~~

The :method:`db.collection.update()` method returns a
:method:`WriteResult` object that contains the status of the operation.
Upon success, the :method:`WriteResult` object contains the number of
documents that matched the query condition, the number of documents
inserted by the update, and the number of documents modified.

.. see:: 

   - :data:`WriteResult.nMatched`
   - :data:`WriteResult.nUpserted`
   - :data:`WriteResult.nModified`

Write Concern Errors
~~~~~~~~~~~~~~~~~~~~

If the :method:`db.collection.update()` method encounters write
concern errors, the results include the
:data:`WriteResult.writeConcernError` field.

The following table explains the possible values of
``WriteResult.writeConcernError.provenance``:

.. include:: /includes/fact-wc-provenance-table.rst

Errors Unrelated to Write Concern
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the :method:`db.collection.update()` method encounters a non-write
concern error, the results include the :data:`WriteResult.writeError`
field.

Examples
--------

.. include:: /includes/sample-data-usage.rst

.. tabs::

   .. tab:: Set
      :tabid: op-expr

      Use Update Operator Expressions (``$inc`` and ``$set``)
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      If the ``<update>`` document contains :ref:`update operator
      <update-operators>` modifiers, such as those using the
      :update:`$set` modifier, then:

      - The ``<update>`` document must contain *only*
        :ref:`update operator <update-operators>` expressions.

      - The :method:`db.collection.update()` method updates only the
        corresponding fields in the document.

        - To update an embedded document or an array as a whole,
          specify the replacement value for the field.

        - To update particular fields in an embedded document or in
          an array, use :ref:`dot notation <document-dot-notation>`
          to specify the field.

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/update-operator-expressions.js
         :language: javascript
         :category: usage example

      In this operation:

      - The ``<query>`` parameter of ``{ title: "The Godfather" }`` specifies which
        document to update

      - the :update:`$inc` operator increments the ``numReviews`` field in the
        ``tomatoes.viewer`` embedded document

      - the :update:`$set` operator updates the ``meter`` field in the 
        ``tomatoes.viewer`` embedded document.

      If the ``query`` parameter matches multiple documents,
      the operation only updates one matching document. To
      update multiple documents, set the ``multi`` option
      to ``true``.

      .. seealso::

         :update:`$set`, :update:`$inc`,
         :ref:`update operators <update-operators>`
         :ref:`dot notation <document-dot-notation>`

   .. tab:: Arrays
      :tabid: push-elements-existing-array

      Push Elements to Existing Array (``$push``)
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      The following operation uses the :update:`$push` update
      operator to append a value to the ``genres`` array.

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/existing-array.js
         :language: javascript
         :category: usage example

      After the update, the ``genres`` array includes the new value.

      .. seealso::

         :update:`$push`

   .. tab:: Unset
      :tabid: remove-fields

      Remove Fields (``$unset``)
      ~~~~~~~~~~~~~~~~~~~~~~~~~~

      The following operation uses the :update:`$unset` operator to remove
      the ``metacritic`` field from "The Godfather" document.

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/remove-fields.js
         :language: javascript
         :category: usage example

      After the update, the ``metacritic`` field is removed.

      .. seealso::

         :update:`$unset`, :update:`$rename`, :ref:`update operators <update-operators>`

   .. tab:: Multiple
      :tabid: update-multiple

      Update Multiple Documents (``$update`` With ``multi``)
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      If ``multi`` is set to ``true``, the
      :method:`db.collection.update()` method updates *all* documents
      that meet the ``<query>`` criteria. The ``multi`` update
      operation may interleave with other read/write operations.

      The following operation sets the ``test_field`` field to ``true``
      for documents where the title is either "The Godfather" or "The Matrix".

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/update-multiple.js
         :language: javascript
         :category: usage example

      The operation updates both matching documents.

      You cannot specify ``multi: true`` when performing a replacement
      and the :ref:`update <update-parameter>` document contains *only*
      ``field:value`` expressions.

      .. seealso::

         :update:`$set`

.. _example-update-upsert:
.. _upsert-parameter:
.. _upsert-behavior:

Insert a New Document if No Match Exists (``Upsert``)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When you specify the option :ref:`upsert: true <update-upsert>`:

- If document(s) match the query criteria,
  :method:`db.collection.update()` performs an update.

- If no document matches the query criteria,
  :method:`db.collection.update()` inserts a *single* document.

  .. note::

     If multiple, identical :term:`upserts <upsert>` are issued at
     roughly the same time, it is possible for
     :method:`~db.collection.update()` used with :ref:`upsert: true
     <update-upsert>` to create duplicate documents. See
     :ref:`update-with-unique-indexes` for more information.

If you specify ``upsert: true`` on a sharded collection, you must
include the full shard key in the ``filter``. For additional
:method:`db.collection.update()` behavior on a sharded collection, see
:ref:`update-sharded-collection`.

The following tabs showcase a variety of uses of the ``upsert`` modifier
with :method:`~db.collection.update()`.

.. tabs::

   .. tab:: Replace
      :tabid: upsert-example

      Upsert with Replacement Document
      ````````````````````````````````

      If no document matches the query criteria and the ``<update>``
      parameter is a replacement document (i.e., contains only field
      and value pairs), the update inserts a new document with the
      fields and values of the replacement document.

      - If you specify an ``_id`` field in either the query parameter
        or replacement document, MongoDB uses that ``_id`` field in the
        inserted document.

      - If you do not specify an ``_id`` field in either the query
        parameter or replacement document, MongoDB generates adds the
        ``_id`` field with a randomly generated :ref:`objectid`
        value.

        You cannot specify different ``_id`` field values in the
        query parameter and replacement document. If you do, the
        operation errors.

      For example, the following update sets the :ref:`upsert
      <upsert-parameter>` option to ``true``:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/upsert-with-replacement.js
         :language: javascript
         :category: usage example

      If no document matches the ``<query>`` parameter, the update
      operation inserts a document with *only* the replacement
      document. Because no ``_id`` field was specified in the
      replacement document or query document, the operation creates a
      new unique ``ObjectId`` for the new document's ``_id`` field.
      You can see the ``upsert`` reflected in the :ref:`WriteResult
      <writeresults-update>` of the operation.

   .. tab:: Set
      :tabid: upsert-op-expr

      Upsert with Operator Expressions (``$set``)
      ```````````````````````````````````````````

      If no document matches the query criteria and the ``<update>``
      parameter is a document with :ref:`update operator expressions
      <update-operators>`, then the operation creates a base document
      from the equality clauses in the ``<query>`` parameter and
      applies the expressions from the ``<update>`` parameter.

      :ref:`Comparison <query-projection-operators-top>` operations from
      the ``<query>`` will not be included in the new document. If
      the new document does not include the ``_id`` field, MongoDB
      adds the ``_id`` field with an :ref:`objectid` value.

      For example, the following update sets the :ref:`upsert
      <upsert-parameter>` option to ``true``:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/upsert-with-set.js
         :language: javascript
         :category: usage example

      If no documents match the query condition, the operation
      inserts the corresponding document.

      .. seealso::

         :update:`$setOnInsert`

   .. tab:: Aggregation
      :tabid: agg-pipeline-upsert

      Upsert using an Aggregation Pipeline
      ````````````````````````````````````

      If the ``<update>`` parameter is an :ref:`aggregation pipeline
      <update-behavior-agg-pipeline>`, the update creates a base
      document from the equality clauses in the ``<query>``
      parameter, and then applies the pipeline to the document to
      create the document to insert. If the new document does not
      include the ``_id`` field, MongoDB adds the ``_id`` field with
      an :ref:`objectid` value.

      For example, the following aggregation pipeline inserts a new document in
      the ``movies`` collection because there is not an existing document that
      matches the query filter:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/upsert-with-aggregation.js
         :language: javascript
         :category: usage example

      .. seealso::

         For additional examples of updates using
         aggregation pipelines, see :ref:`update-behavior-agg-pipeline`.

   .. tab:: Multiple
      :tabid: combine-upsert-multi

      Using ``upsert`` with ``multi`` (Match)
      ```````````````````````````````````````

      The following operation specifies both the ``multi`` option and
      the ``upsert`` option. If matching documents exist, the
      operation updates all matching documents. If no matching
      documents exist, the operation inserts a new document.

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/upsert-with-multi.js
         :language: javascript
         :category: usage example

      Since both movies exist in the collection, the operation updates 
      both matching documents.

      Using ``upsert`` with ``multi`` (No Match)
      ``````````````````````````````````````````

      If the collection had *no* matching document, the operation
      would result in the insertion of a single document using the
      fields from both the ``<query>`` and the ``<update>``
      specifications. For example, consider the following operation:

      .. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/upsert-no-match.js
         :language: javascript
         :category: usage example

      The operation inserts the corresponding document into the ``movies``
      collection.

.. _update-behavior-agg-pipeline:
.. _update-example-agg:

Update with Aggregation Pipeline
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The :method:`db.collection.update()` method can accept an 
:ref:`aggregation pipeline <aggregation-pipeline>` 
``[ <stage1>, <stage2>, ... ]`` that specifies the modifications to 
perform. The pipeline can consist of the following stages:

.. include:: /includes/list-update-agg-stages.rst

Using the aggregation pipeline allows for a more expressive update
statement, such as expressing conditional updates based on current
field values or updating one field using the value of another field(s).

Modify a Field Using the Values of the Other Fields in the Document
```````````````````````````````````````````````````````````````````

The following example creates a ``displayTitle`` field that combines the movie's
title and year with an aggregation pipeline that performs these operations:

- creates a ``displayTitle`` field by concatenating the ``title`` and ``year`` 
  fields

- sets a ``lastModified`` timestamp

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/modify-with-field.js
   :language: javascript
   :category: usage example

.. seealso::

   :ref:`updates-agg-pipeline`

Perform Conditional Updates Based on Current Field Values
`````````````````````````````````````````````````````````

The following example updates movies released in 2015 to calculate a combined
rating score from IMDB and Tomatoes ratings, and assign a grade based on the
score.

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/conditional-updates.js
   :language: javascript
   :category: usage example

.. note::

   The ``$set`` used in the pipeline refers to the aggregation stage
   :pipeline:`$set`, and not the update operators :update:`$set`.

The :pipeline:`$set` stage:

- calculates a new field ``combinedScore`` by averaging the IMDB rating 
  (scaled by 10) and Tomatoes viewer rating (scaled by 10), then 
  rounding to one decimal place. See :group:`$avg`, 
  :expression:`$multiply`, and :expression:`$round` for more information.

- sets the field ``lastUpdate`` to the value of the aggregation
  variable :variable:`NOW`. 

- assigns a letter grade based on the ``combinedScore`` using the
  :expression:`$switch` operator.

.. seealso::

   :ref:`updates-agg-pipeline`

Specify ``arrayFilters`` for Array Update Operations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Update Elements Match ``arrayFilters`` Criteria
```````````````````````````````````````````````

To update all array elements which match a specified criteria, use the
:ref:`arrayFilters <update-array-filters>` parameter.

The following example updates all movies that have ``"English"`` in their 
``languages`` array. The operation replaces ``"English"`` with ``"EN"``. 

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/arrayfilters-match.js
   :language: javascript
   :category: usage example

Update Specific Elements of an Array Using Pattern Matching
```````````````````````````````````````````````````````````

You can also use the :ref:`arrayFilters <update-array-filters>`
parameter with the filtered positional operator to update specific 
array elements that match a pattern.

The following example uses "The Godfather" movie from the existing collection,
which has a ``writers`` array. The operation updates only the writers whose
names contain "screenplay" by appending a suffix.

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/pattern-matching.js
   :language: javascript
   :category: usage example

The operation targets "The Godfather" document and updates only array 
elements matching the filter criteria. After the operation, the writers
who worked on the screenplay have " - UPDATED" appended.

.. _ex-update-hint:

Specify ``hint`` for Update Operations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The ``hint`` option allows you to specify which index MongoDB should use
for the update operation. This is useful when updating multiple documents
and you want to ensure a specific index is used for performance. This example 
uses the existing ``movies`` collection from the sample_mflix database.

First, create an index on the ``year`` field:

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/create-index.js
   :language: javascript
   :category: usage example

The following update operation explicitly :ref:`hints <update-hint>` to
use the ``{ year: 1 }`` index to update all movies from 2010-2015:

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/hint.js
   :language: javascript
   :category: usage example

.. note::

   If you specify an index that does not exist, the operation errors.   

To see the index used, run :dbcommand:`explain` on the operation:

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/explain.js
   :language: javascript
   :category: usage example

The :method:`db.collection.explain().update() <db.collection.explain>`
does not modify the documents.

.. _db.collection.update-let-example:

Use Variables in ``let``
~~~~~~~~~~~~~~~~~~~~~~~~

.. |let-option| replace:: :ref:`let <db.collection.update-let-syntax>`

.. include:: /includes/let-example-introduction.rst

The example:

- Defines two variables in the ``let`` option: ``targetTitle`` (set to "The Matrix") 
  and ``newTitle`` (set to "The Matrix Reloaded")

- Uses ``$expr`` in the query filter to compare the document's ``title`` field 
  against the ``$$targetTitle`` variable

- Uses an aggregation pipeline with ``$set`` to update the ``title`` field to 
  the value of ``$$newTitle``

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/let.js
   :language: javascript
   :category: usage example

.. _example-update-write-concern:

Override Default Write Concern
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following operation to a replica set specifies a :ref:`write concern
<write-concern>` of ``w: 2`` with a ``wtimeout`` of 5000
milliseconds. This operation either returns after the write propagates
to both the primary and one secondary, or times out after 5 seconds.

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/write-concern.js
   :language: javascript
   :category: usage example

The operation successfully completes after the write is acknowledged by the
primary and at least one secondary, as specified by ``w: 2``.

Write Concern Errors in Sharded Clusters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. |cmd| replace:: :method:`db.collection.update()`
.. include:: /includes/fact-update-writeConcernError-mongos.rst

.. _example-update-collation:

Specify Collation
~~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/collation-option.rst

This operation updates all movies with titles that start with
``night`` and uses ``strength: 1`` for case-insensitive comparison:

.. literalinclude:: /code-examples/tested/command-line/mongosh/mongosh-commands/db.collection.update/collation.js
   :language: javascript
   :category: usage example
