=========================
Configure AWS Integration
=========================

.. default-domain:: mongodb

Overview
--------

If you have an Amazon Web Services (AWS) account, you can configure |mms| to
deploy EC2 servers to that account directly from the |mms| interface. |mms|
integrates with AWS to deploy EC2 instances that come with Automation
Agents pre-installed.

.. _aws-checklist:

Prerequisites
-------------

To configure |mms| for AWS integration, you must first meet the following
prerequisites. Access keys are **not** required if you use AWS's
cross-account access.

Access Keys
~~~~~~~~~~~

If you choose to authenticate to AWS through keys, then you must be able
to provide the following keys when configuring |mms| for AWS provisioning:

- The AWS account's Access Key ID and Secret Access Key. To access the
  keys, click your username in the top right corner of AWS and select
  *Security Credentials*.

- An SSH public key for the computer that accesses |mms|.

.. _security-group:

Security Group
~~~~~~~~~~~~~~

The AWS account must have at least one :ref:`security group
<security-group>` configured. At minimum, the security group must have the
following inbound rules:

- A custom TCP rule that allows all members of the security group to
  access the MongoDB processes.

- An SSH rule on the SSH port, usually 22, and that allows traffic from
  all IPs.

  If you do not want to grant SSH access to all IPs, you must instead
  grant SSH access to the following ranges:

  - ``4.71.186.128/25``

  - ``4.35.16.128/25``

Optionally, add additional rules to your security group as needed. For
example, to grant access to MongoDB from hosts in another security group,
add a custom TCP rule that specifies the MongoDB ports and the other
security group. To grant access from a specific IP address, such as the IP
address for a specific office, add a custom TCP rule that specifies the
MongoDB ports and the specific IP address.

In addition, for security groups that are bound to a VPC, set the outbound
rules to control access to |mms|.
The outbound CIDRs required for a security group in a VPC are:

- ``54.173.82.137/32``

- ``54.175.147.155/32``

The machine being provisioned must be able to access standard package
repositories to update the machine when provisioning. Ensure
your outbound access allows for this.

VPC
~~~

If you are deploying into a Virtual Private Cloud (VPC), the VPC must
exist before provisioning. If you are using a VPC that you created and not
a default AWS VPC, make sure that the VPC property ``DNS hostname`` is
``yes``, which guarantees that each instance provisioned in the VPC
receives a hostname.

Note that |mms| gives a public IP to any instances created on subnets.

Procedures
----------

To configure |mms| for AWS integration, perform the following procedures.

Configure Permissions for the AWS User
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The AWS user associated with the access keys must have an attached IAM
policy with the permissions described in
:doc:`/reference/required-permissions-aws-user`. Without adequate
permissions, the user cannot provision AWS servers from |mms|.

To set the permissions, do the following:

.. include:: /includes/steps/configure-permissions-aws-user.rst



Configure |mms| for AWS Provisioning
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/steps/configure-aws-settings.rst
