.. _node-mongoose-qe:

============================================
Tutorial: Queryable Encryption with Mongoose
============================================

.. facet::
   :name: genre
   :values: tutorial 

.. meta:: 
   :description: Learn how to implement Queryable Encryption with Mongoose for automatic field encryption and decryption.
   :keywords: integrations, mongoose, queryable encryption, field level encryption, security, automatic

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

In this guide, you can learn how to create an application that uses
**Mongoose** to implement MongoDB's **{+qe+}** feature.

{+qe+} allows you to automatically encrypt and decrypt document fields.
You can use {+qe+} to encrypt sensitive data in your application, store data fields
as randomized encrypted data on the server, and query the encrypted fields.
This tutorial shows you how to set up {+qe+} by using Mongoose, which provides
an Object Document Mapper (ODM) library for data interaction.

Prerequisites
~~~~~~~~~~~~~

Before you begin this tutorial, complete the following prerequisite
tasks:

- Create a MongoDB Atlas account and configure a cluster. Ensure that
  your cluster runs on {+mdb-server+} version 7.0 or later. To learn more,
  see the `MongoDB Get Started <https://www.mongodb.com/docs/get-started/?language=nodejs>`__ guide.
- Download the Automatic Encryption Shared Library. To view instructions,
  see the :manual:`Install and Configure a Query Analysis Component 
  </core/queryable-encryption/install-library/?encryption-component=crypt_shared#procedure>`
  guide. These instructions show how to navigate to the MongoDB Download Center
  and fill out the form required to download the library.
- Install `Node.js <https://nodejs.org/en/download>`__ {+min-node-version+} or later.

Tutorial
--------

This tutorial shows how to create a {+qe+} application that uses Mongoose.
The application encrypts and decrypts patient medical records and queries
encrypted medical data.

.. tip:: Complete Application

   To view the complete sample application for this tutorial,
   see the :github:`mongoose-qe-app </mongodb/docs/tree/main/content/node/current/source/includes/mongoose/mongoose-qe-app>`
   folder on GitHub.

Set Up Your Project
~~~~~~~~~~~~~~~~~~~

Follow the steps in this section to install the project dependencies,
configure your environment, and create the application structure.

.. procedure::
   :style: connected

   .. step:: Set up your environment.

      Run the following commands in your terminal to initialize your project and
      install the necessary dependencies:

      .. code-block:: bash

         mkdir mongoose-qe-app
         cd mongoose-qe-app
         npm init -y
         npm pkg set main="queryable-encryption-tutorial.js"
         npm pkg set type="module"
         npm pkg set scripts.start="node queryable-encryption-tutorial.js"
         npm i mongoose mongodb dotenv mongodb-client-encryption

      These commands create a ``mongoose-qe-app`` project directory and install the
      following dependencies:

      - Mongoose, the Node.js ODM
      - {+driver-short+}
      - `Dotenv <https://www.npmjs.com/package/dotenv>`__, a module for
        loading environment variables
      - `mongodb-client-encryption <https://www.npmjs.com/package/mongodb-client-encryption>`__,
        the encryption package

   .. step:: Specify your environment variables.

      In your project root, create an ``.env`` file and paste the following code:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/env_template
         :language: bash
         :dedent:

      Replace the ``<connection URI>`` placeholder with the connection URI that
      connects to your cluster, and replace the ``<Automatic Encryption Shared Library path>``
      with the full path to your Automatic Encryption Shared Library. Ensure the path
      points to ``lib/mongo_crypt_v1.dylib`` inside your downloaded package.

      If you use one of the Key Management Systems (KMS) listed in the ``.env``
      template, replace the corresponding placeholder values. Otherwise, you can
      leave these values unassigned and store your Customer Master Key locally.
      This application creates the local Customer Master Key file for you.

      .. warning:: Local CMK Storage

         If you store your Customer Master Key locally, do not use this application
         in production. Without a remote KMS, you risk unauthorized access to the encryption key or loss
         of the key needed to decrypt your data.

      .. tip:: Key Management Systems

         To learn more about KMS, see the :wikipedia:`Key Management <w/index.php?title=Key_management&oldid=1320428824>`
         Wikipedia entry.

   .. step:: Create your application files.

      Navigate to your ``mongoose-qe-app`` directory and create a file named
      ``queryable-encryption-tutorial.js``, which will store your application logic. Paste the following code into this
      file:

      .. literalinclude:: /includes/mongoose/tutorial-template.js
         :language: javascript
         :dedent:

      Then, create a file named ``queryable-encryption-helpers.js`` and paste
      the following code:

      .. literalinclude:: /includes/mongoose/helpers-template.js
         :language: javascript
         :dedent:

      This file contains a ``dropExistingDatabase()`` helper function for your application.
      Future steps in this tutorial instruct you to add additional helper functions.

   .. step:: Assign your application variables.

      Specify the initial database and encryption variables by pasting the following code in
      the ``runExample()`` function of your ``queryable-encryption-tutorial.js`` file:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-setup-application-variables
         :end-before: end-setup-application-variables
         :dedent:

      Replace the ``'<KMS provider>'`` placeholder with your key provider: ``'aws'``,
      ``'azure'``, ``'gcp'``, or ``'kmip'``. To store your Customer Master Key locally,
      set this value to ``'local'``.

      The code pre-populates the following variables:
      
      - **keyVaultDatabaseName** - The database in MongoDB that stores your data
        encryption keys (DEKs). This tutorial uses the ``encryption`` database.
      - **keyVaultCollectionName** - The collection in MongoDB that stores your DEKs.
        The code sets this variable to ``__keyVault``, prefixed with
        an underscore to distinguish it from a user collection.
      - **keyVaultNamespace** - The namespace in MongoDB that stores your DEKs.
        This variable consists of your ``keyVaultDatabaseName``
        and ``keyVaultCollectionName`` variables, separated by a period.
      - **encryptedDatabaseName** - The database in MongoDB that stores your encrypted
        data. This tutorial uses the ``medicalRecords`` database.
      - **encryptedCollectionName** - The collection in MongoDB that stores your encrypted
        data. This tutorial uses the ``patients`` collection.

Configure Encryption Credentials
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After setting up your project structure, follow the steps in this section
to configure your KMS provider credentials and encryption options.

.. procedure::
   :style: connected

   .. step:: Retrieve your KMS provider credentials.

      Add the ``getKMSProviderCredentials()`` function to your ``queryable-encryption-helpers.js``
      file. This function retrieves the credentials for your Key Management System provider,
      or it creates a local Customer Master Key file if you do not use a KMS provider.

      Paste the following code after the ``dropExistingDatabase()`` function:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-helpers.js
         :language: javascript
         :start-after: start-kms-credentials
         :end-before: end-kms-credentials
         :dedent:

      This ``getKMSProviderCredentials()`` function supports multiple KMS providers, including AWS, Azure, GCP, KMIP, and local key storage.

   .. step:: Retrieve your Customer Master Key credentials.

      Add the ``getCustomerMasterKeyCredentials()`` function to your ``queryable-encryption-helpers.js``
      file. This function retrieves Customer Master Key credentials based on your KMS provider.

      Paste the following code after the ``getKMSProviderCredentials()`` function:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-helpers.js
         :language: javascript
         :start-after: start-cmk-credentials
         :end-before: end-cmk-credentials
         :dedent:

      This function configures the corresponding Customer Master Key credentials for your chosen KMS provider.

   .. step:: Retrieve your automatic encryption options.

      Add the ``getAutoEncryptionOptions()`` function to your ``queryable-encryption-helpers.js``
      file. This function configures the automatic encryption options for your application.

      Paste the following code after the ``getCustomerMasterKeyCredentials()`` function:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-helpers.js
         :language: javascript
         :start-after: start-auto-encryption-options
         :end-before: end-auto-encryption-options
         :dedent:

   .. step:: Assign your credentials variables.

      Now that you've defined helper functions, you can use them to access
      your credentials from the main application file. 
      
      Navigate to your ``queryable-encryption-tutorial.js`` file and paste the following code
      after the ``// Paste credential and options variables below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-credentials
         :end-before: end-credentials
         :dedent:

      This code calls your helper functions to retrieve the KMS provider credentials,
      Customer Master Key credentials, and automatic encryption options used
      to configure {+qe+}.

Encrypt and Connect to MongoDB
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After configuring encryption settings, follow the steps in this section
to set up your MongoDB connection, create data keys, and define your encrypted schema.

.. procedure::
   :style: connected

   .. step:: Configure your MongoDB connection and client.

      To set up your MongoDB connection and client, navigate to your
      ``queryable-encryption-tutorial.js`` file and paste the following code
      after the ``// Paste connection and client configuration below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-connection-setup
         :end-before: end-connection-setup
         :dedent:

      This code creates a Mongoose connection for encrypted operations, a MongoDB client
      for key management, and a ``ClientEncryption`` instance for creating data keys.
      It also drops any existing databases to ensure a clean setup for the tutorial.

   .. step:: Create your data keys.

      To create the necessary data keys, paste the following code after the
      ``// Paste data key creation code below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-create-data-key
         :end-before: end-create-data-key
         :dedent:

      This code creates three data encryption keys used encrypt
      different fields in your patient documents. Each encrypted
      field requires its own data key.

   .. step:: Define your encryption schema.

      To create the encrypted schema definition, paste the following code after
      the ``// Paste encryption schema below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-define-encrypted-schema
         :end-before: end-define-encrypted-schema
         :dedent:

      This schema defines the structure for documents in the ``patients`` collection and
      specifies the following encrypted fields:
      
      - ``patientRecord.ssn``: Encrypted and configured for equality queries
      - ``patientRecord.billing.type``: Encrypted, but not queryable
      - ``patientRecord.billing.number``: Encrypted, but not queryable

   .. step:: Register the encryption schema on a model.

      Create a new model named ``Patient`` to represent the ``patients`` collection
      and register your encryption schema on the model. To create the model, paste the following code after
      the ``// Paste the model below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-create-model
         :end-before: end-create-model
         :dedent:

      This code creates a Mongoose model that handles automatic encryption and decryption
      of fields when you perform database operations.

   .. step:: Establish your database connection.

      After registering your model, you can establish the database connection
      by pasting the following code after the ``// Paste connection code below``
      code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-connect-db
         :end-before: end-connect-db
         :dedent:

      This establishes the connection to your ``medicalRecords`` database, on which
      automatic encryption is enabled.

Perform Encrypted Operations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After configuring your application and database connection, follow the steps
in this section to insert and query encrypted documents.

.. procedure::
   :style: connected

   .. step:: Insert encrypted data.

      To insert a document that has encrypted fields, navigate to your
      ``queryable-encryption-tutorial.js`` file and paste the following code
      after the ``// Paste the insertion operation below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-insert-document
         :end-before: end-insert-document
         :dedent:

      {+qe+} automatically encrypts the ``patientRecord.ssn`` and 
      ``patientRecord.billing`` fields before storing the document in MongoDB.

   .. step:: Query encrypted data.

      To query an encrypted field, paste the following code after
      the ``// Paste the encrypted query below`` code comment:

      .. literalinclude:: /includes/mongoose/mongoose-qe-app/queryable-encryption-tutorial.js
         :language: javascript
         :start-after: start-find-document
         :end-before: end-find-document
         :dedent:

      This code performs an equality query on the encrypted ``patientRecord.ssn`` field. 

   .. step:: Run your application.

      Finally, you can run the encrypted operations defined in the previous
      steps by running the following command from your ``mongoose-qe-app`` directory: 

      .. code-block:: bash

         npm start

      If successful, your command output resembles the following example:

      .. code-block:: javascript
         :copyable: false

         Successfully inserted the patient document.
         Document ID: new ObjectId('...')
         Found patient:
         {
            patientRecord: {
               billing: { type: 'Visa', number: '4111111111111111' },
               ssn: '987-65-4320',
               billAmount: 1500
            },
            _id: new ObjectId('...'),
            patientName: 'Jon Doe',
            patientId: 12345678,
            __v: 0,
            __safeContent__: [
               Binary.createFromBase64('EGzhQwBpf1B6W9udskSxJ8kwEEnF5P+SJPZ6ygQ9Ft8=', 0)
            ]
         }
         Connection closed.

Next Steps
----------

Congratulations on completing the Mongoose {+qe+} tutorial! You now have a sample
Mongoose application that uses {+qe+} to automatically
encrypt and decrypt document fields. Your application encrypts sensitive data
on the server side and queries the data on the client side.

To learn more about {+qe+} and Mongoose, visit the following resources:

- View more driver {+qe+} tutorials in the :manual:`{+mdb-server+} manual
  </core/queryable-encryption/tutorials/>`.
- Learn how to create an application that uses Mongoose without {+qe+} in
  the :ref:`Mongoose Get Started <node-mongoose-get-started>` tutorial.
- Learn more about Mongoose in the `Mongoose <https://mongoosejs.com/docs/>`__
  documentation.