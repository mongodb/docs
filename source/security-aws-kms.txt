.. _security-aws-kms:

=================================
Manage Customer Keys with AWS KMS
=================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/fact-aws-kms-role-auth.rst

.. include:: /includes/serverless-dont-use.rst

You can configure your |service| project to use an |aws| `IAM role 
<https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html>`__ 
for accessing your |aws| KMS keys for encryption at rest. You can 
either use an existing role or create a new role when you enable 
encryption at rest for your project.

This page covers configuring customer key management on your |service| 
project for role-based access.

If you have not yet enabled encryption at rest for your new or existing 
|service| project, follow the :ref:`aws-kms-enable-project` procedure 
to enable encryption at rest for your |service| project. If you have an 
|service| project for which you have already enabled encryption at rest 
and configured credentials-based access to your encryption keys, follow 
the :ref:`aws-kms-switch-project` procedure to switch to role-based 
access to your encryption keys.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

.. seealso:: 

   - :ref:`set-up-unified-aws-access`

Enable Customer-Managed Keys with AWS KMS
-----------------------------------------

Key Concepts 
~~~~~~~~~~~~

.. expression:: MongoDB Master Key

   :expression:`MongoDB Master Key` is an encryption key used by the
   MongoDB Server to encrypt the WiredTiger Storage Engine. The key
   isn't stored in the MongoDB database, but it's supplied externally
   through |kmip| or a local keyfile. When the MongoDB server starts, it
   obtains the master key from the |kmip| or local file and then stores
   it in memory. This key is then used to decrypt the data stored in the
   WiredTiger storage engine. 

   |service| maintains a layer that translates requests between MongoDB
   Server and a |cmk| that you created in |aws|. To translate the
   requests, |service| uses the layer to request the |cmk| to create an
   encrypted data encryption key (DEK). This encrypted
   :abbr:`DEK (data encryption key)` is generated per |service| deployment. 

   For example, for a three node M10+ replica set as shown in the
   following figure, there are three unique encrypted :abbr:`DEK (data
   encryption key)`\s, one per node. |service| stores the encrypted
   :abbr:`DEK (data encryption key)` on disk on each node in the
   |service| cluster. When the cluster starts up, the |service| layer
   decrypts the :abbr:`DEK (data encryption key)` using the customer
   provided encryption key and supplies this to the MongoDB Server.  

   .. figure:: /images/aws-kms-cmk-key-concepts.png 
      :figwidth: 100%
      :alt: Atlas and AWS KMS key transfer workflow

.. expression:: Per Database Encryption Key in a MongoDB Cluster

   MongoDB Server maintains a per database encryption key in the MongoDB 
   cluster. In the preceding figure, there are three databases on the
   MongoDB cluster, each of which is encrypted with a unique database
   encryption key. Each of these keys are then encrypted with the
   :expression:`MongoDB Master Key`.  

.. expression:: Data Encryption Key (in cloud provider terminology) or MongoDB Master Key 

   |service| uses the customer provided encryption key to create an
   encrypted :abbr:`DEK (data encryption key)`. |service| also uses a 
   customer key management instance to decrypt this encrypted :abbr:`DEK
   (data encryption key)` and supply the resulting plaintext key to the 
   MongoDB Server over the wire using |tls|. When MongoDB Server uses
   this plaintext key, it refers to it as the :expression:`MongoDB
   Master Key`, whereas a cloud provider's customer key management
   instance might refer to it as a :abbr:`DEK (data encryption key)`. 
   To learn more about :abbr:`DEK (data encryption key)`\s, see `Data Keys
   <https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#data-keys>`__.

.. expression:: Customer Master Key (CMK)

   :abbr:`Customer Master Key (CMK)` is a concept of a customer key
   management instance. |cmk|\s are used to  encrypt and decrypt a
   :expression:`MongoDB Master Key` (or :abbr:`DEK (data encryption
   key)`). The |cmk| exists only on the customer key management
   instance. To learn more about |cmk|\s, see `Data Keys
   <https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#key-mgmt>`__.

.. _aws-ksm-prereqs:
.. _security-aws-kms-restrictions:

Prerequisites
~~~~~~~~~~~~~

To enable customer-managed keys with |aws| |kms| for a MongoDB
project, you must:

.. include:: /includes/fact-aws-kms-prereqs.rst

.. _aws-kms-enable-project:

Enable Role-Based Access to Your Encryption Key for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: UI
      :tabid: ui

      .. include:: /includes/steps/enable-rba-encryption-for-project.rst

   .. tab:: API
      :tabid: api
   
      .. include:: /includes/steps/enable-rba-encryption-api.rst

.. _aws-kms-switch-project:

Switch to Role-Based Access to Your Encryption Key for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-switching-access-to-encryption-keys.rst

.. tabs::

   .. tab:: UI
      :tabid: ui

      .. include:: /includes/steps/migrate-rba-encryption-for-project.rst

   .. tab:: API
      :tabid: api
   
      To update your encryption key management with the 
      {+atlas-admin-api+}, use the same steps outlined in the 
      :ref:`above procedure <aws-kms-enable-project>`.

.. _aws-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you :ref:`aws-kms-enable-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:ref:`Manage your own encryption keys 
<create-cluster-enable-encryption>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

.. _security-aws-kms-rotate-key:

Rotate your AWS Customer Master Key
-----------------------------------

.. meta::
   :keywords: encryption

.. include:: /includes/unavailable-serverless-m0-m2-m5-clusters.rst

MongoDB Master Key - MongoDB Responsibility
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-atlas-key-rotation.rst

Your |aws| |cmk| - Your Responsibility
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

|service| does *not* automatically rotate the |aws| |cmk| used for
|aws|\-provided Encryption at Rest. 

As a best practice, |service| creates an :alert:`alert <AWS encryption
key elapsed time since last rotation is above (n) days>` to remind you
to rotate your |aws| |cmk| every 90 days by default when you
:ref:`enable Encryption at Rest <security-aws-kms>` for |a-service|
project. You can configure the time period of this alert.

You can rotate your |aws| |cmk| yourself or configure your |aws| |kms|
instance to :aws:`automatically rotate
</kms/latest/developerguide/rotate-keys.html>` your |cmk|. If
you configure automatic |aws| |cmk| rotation, the default time period
for rotation is approximately 365 days.

If you have already set up an automatic |cmk| rotation in |aws| and
don't want to receive the |service| alert to rotate your |cmk| every 90 
days, you can :ref:`modify <configure-alerts>` the default alert period
to be greater than 365 days.

This page explains how to create a new key and update the |cmk| ID in
|service| to rotate your |service| project |cmk|. This method of key
rotation supports more granular control of the rotation period compared
to |aws| |kms| automatic |cmk| rotation.

.. important:: {+Cloud-Backup+}s with Encryption at Rest

   For clusters using :doc:`Encryption at Rest </security-aws-kms>` and
   :ref:`backup-cloud-provider`, |service| uses the project's |cmk| and
   |aws| |iam| user credentials at the time of the snapshot to
   automatically encrypt the snapshot data files. This is an additional
   layer of encryption on the existing encryption applied to all
   |service| storage and snapshot volumes.

   |service| does *not* re-encrypt snapshots with the new |cmk| after
   rotation. Do *not* delete the old |cmk| until you check *every*
   backup-enabled cluster in the project for any snapshots still using
   that |cmk|. |service| deletes backups in accordance to the
   :ref:`cloud-provider-retention-policy`. After |service| deletes all
   snapshots depending on a given |cmk|, you can delete that |cmk|
   safely.

Procedure
~~~~~~~~~

.. include:: /includes/steps/rotate-aws-kms-cmk.rst

.. _aws-kms-regional-outage:

Reconfigure AWS KMS Region During an Outage
-------------------------------------------

During a regional outage, your |aws| KMS region might
become unavailable. If you've enabled :ref:`security-kms-encryption`,
you can perform encrypt and decrypt operations while at least one node
is still available. However, if all nodes become unavailable,
you can't perform cryptographic operations. A node becomes unavailable
if it restarts during the outage.

To get the unavailable nodes to a healthy state, you
can reconfigure your current |aws| KMS region to an available region.
To change your KMS region, your AWS KMS key must be a :aws:`multi-Region key 
</kms/latest/developerguide/multi-region-keys-overview>`. 
To create a multi-Region Key, see the :aws:`AWS documentation 
</kms/latest/developerguide/multi-region-keys-create>`.

.. note:: 

   You can't convert a single-Region key to a multi-Region Key.

Procedure
~~~~~~~~~

To reconfigure your |aws| KMS region, complete the following steps
in |service|:

.. include:: /includes/steps/update-aws-kms-region.rst

Related Topics
--------------

- To learn more about MongoDB Encryption at Rest, see
  :manual:`Encryption at Rest </core/security-encryption-at-rest/>` in
  the MongoDB server documentation.

- To learn more about Encryption at Rest with {+Cloud-Backup+}s, see 
  :ref:`encrypted-cloud-provider-snapshot`.
