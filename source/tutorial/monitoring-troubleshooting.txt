====================================
Diagnostic and Troubleshooting Guide
====================================

.. default-domain:: mongodb

This document provide troubleshooting advice for common issues encountered
installing the Monitoring Agent. Begin by working through the checklist below
to ensure issues are not easily resolved. Questions and answers also are
listed below for issues not caused by easily fixed installation or connectivity
problems.

For answers to other questions, see the :doc:`monitoring FAQ
</faq/monitoring>`.

.. _troubleshooting:

.. index:: troubleshooting
   single: agent; troubleshooting

Getting Started Checklist
-------------------------

Most problems with MMS are the result of issues with installation,
connectivity, and other problems easily resolved. To begin troubleshooting,
complete these tasks:

#. :ref:`monitoring-troubleshooting-auth-creds`
#. :ref:`monitoring-troubleshooting-check-logs`
#. :ref:`monitoring-troubleshooting-one-agent`
#. :ref:`monitoring-troubleshooting-host-connectivity`
#. :ref:`monitoring-troubleshooting-mms-connectivity`
#. :ref:`monitoring-troubleshooting-discover-hosts`
 
Installation
------------

.. _monitoring-troubleshooting-auth-creds:

Authentication Errors
~~~~~~~~~~~~~~~~~~~~~

If your MongoDB instances run with authentication enabled, ensure MMS has these
credentials. For new hosts, click the :guilabel:`Add Host` button on the
:guilabel:`Hosts` page then specify credentials for every host with
authentication enabled. For hosts already listed in MMS, click the
:guilabel:`gear icon` to the right of a host name on the :guilabel:`Host` page
then select :guilabel:`Edit Host` to provide credentials.

Please :doc:`consult the Authentication Requirements documentation
</reference/authentication>` for details about
how to use authentication.

Agent
-----

.. _monitoring-troubleshooting-check-logs:

Check Agent Output or Log
~~~~~~~~~~~~~~~~~~~~~~~~~

If you continue to encounter problems, check the agent's output or logs for
errors.

.. _monitoring-troubleshooting-one-agent:

Confirm Only One Agent is Active and Running
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. todo:: Something needs to be ironed out here. The header talks about
          confirming one active agent, but the second para below talks about
          finding which agent is primary, indicating multiple agents. Also,
          wouldn't a standby still send pings?

If :ref:`running multiple Monitoring Agents
<monitoring-agent-redundancy>`, then to determine which agent is the
primary agent look at the Last Ping value in the
:guilabel:`Monitoring Agents` tab on the :guilabel:`Hosts` page. If there is
no Last Ping value for a listed agent, the agent is a standby agent.

When you upgrade a Monitoring Agent, do not forget to kill the old hot standby agent.

If you run a primary agent and a hot standby agent, confirm both agents are
the same version.

See :doc:`/faq/monitoring` and
:doc:`/tutorial/add-hosts-to-monitoring` for more information.

.. _monitoring-troubleshooting-host-connectivity:

Ensure Connectivity Between Agent and Monitored Hosts
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Ensure the system running the agent can resolve and connect to the
MongoDB instances. To confirm, log into the system where the agent
is running and issue a command in the following form:

.. code-block:: sh

   mongo [hostname]:[port]

Replace ``[hostname]`` with the hostname and ``[port]`` with the
port that the database is listening on.

.. _monitoring-troubleshooting-mms-connectivity:

Ensure Connectivity Between Agent and MMS Server
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Verify that the Monitoring Agent can connect on TCP port 443
(outbound) to the MMS server (i.e. "``mms.mongodb.com``".)

.. _monitoring-troubleshooting-discover-hosts:

Allow Agent to Discover Hosts and Collect Initial Data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Allow the agent to run for 5-10 minutes to allow host discovery and initial
data collection.

Alerts
------

How to Set Up Alerts
~~~~~~~~~~~~~~~~~~~~

In MMS, click the :guilabel:`Activity` tab then :guilabel:`Alert Settings`.
Click the :guilabel:`Add Alert` button to add an alert. On the
:guilabel:`Create a New Alert` window, select the alert conditions, for which
hosts, and where to send alerts.

See :doc:`Activity: Alerts and Events </tutorial/manage-alerts-and-events>` for details.

Cannot Turn Off Email Notifications
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There are at least two ways to turn off alert notifications:

Remove the host from your MMS account. Click the :guilabel:`Hosts` tab then
click the :guilabel:`gear icon` to the right of a host name and select
:guilabel:`Remove Host`.

Disable or delete the alert in MMS. Click the :guilabel:`Activity` tab then
click :guilabel:`Alert Settings`. To the right of an alert, select the
:guilabel:`gear icon` and select :guilabel:`Disable` or :guilabel:`Delete`.

Receive Duplicate Alerts
~~~~~~~~~~~~~~~~~~~~~~~~

If the notification email list contains multiple email-groups, one or more
people may receive multiple notifications of the same alert.

Receive "Host has low open file limits" or "Too many open files" error messages
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These error messages appear on the :guilabel:`Hosts`, :guilabel:`Mongos`, and
:guilabel:`Configs` pages under the Host name. They appear if the number of
available connections does not meet an MMS-defined minimum value. These errors
are not generated by the :program:`mongos` instance and, therefore, will not
appear in :program:`mongos` log files.

On a host by host basis, the Monitoring Agent compares the number of open
file descriptors and connections to the maximum connections limit. The max open
file descriptors ulimit parameter directly affects the number of available
server connections. The agent calculates whether or not enough connections
exist to meet an MMS-defined minimum value.

In ping documents, for each node and its ``serverStatus.connections`` values,
if the sum of the ``current`` value plus the ``available`` value is less than
the ``maxConns`` configuration value set for a monitored host, the Monitoring
Agent will send a :guilabel:`Host has low open file limits` or :guilabel:`Too
many open files` message to MMS.

Ping documents are data sent by Monitoring Agents to MMS. To view ping
documents, click the :guilabel:`Hosts` page, the :guilabel:`Host Name`, and the
:guilabel:`Last Ping` tab on the charts page for the selected host.

To prevent this error, we recommend you set ``ulimit`` open files to 64000. We
also recommend setting the ``maxConns`` command in the mongo shell to at least
the recommended settings.

See :manual:`the MongoDB ulimit reference page </reference/ulimit>` and the
:manual:`the MongoDB maxConns reference page
</reference/configuration-options/#maxConns>` for details.

Hosts
-----

Hosts are not Visible
~~~~~~~~~~~~~~~~~~~~~

Problems with the Monitoring Agent detecting hosts can be caused by a few
factors.

**Host not added to MMS**: In MMS, click the :guilabel:`Hosts` tab then click
the :guilabel:`Add Host` button. In the :guilabel:`New Host` window, specify
the host type, internal hostname, and port. If appropriate, add the database
username and password and whether or not MMS should use SSL to connect with
your Monitoring Agent. Note it is not necessary to restart your Monitoring
Agent when adding (or removing) a host.

**Accidental duplicate mongods** If you add the host after a crash and restart
the Monitoring Agent, you might not see the hostname in the MMS
:guilabel:`Mongos` page. MMS detects the host as a duplicate and suppresses its
data. To reset, select :guilabel:`Settings` then :guilabel:`Group Settings`.
Click the :guilabel:`Reset Duplicates` button.

**Too many Monitoring Agents installed**: Only one Monitoring Agent is needed
to monitor all hosts within a single network. You can use a single Monitoring
Agent if your hosts exist across multiple data centers and can be discovered by
a single agent. Check you have only one Monitoring Agent and remove old agents
after upgrading the Monitoring Agent.

A second Monitoring Agent can be set up for redundancy. However, the MMS
Monitoring Agent is robust. MMS sends an *Agent Down* alert only when there are
no available Monitoring Agents available. See :doc:`Monitoring FAQ
</faq/monitoring>` and :doc:`Monitoring Architecture
</tutorial/add-hosts-to-monitoring>` for more information.


Cannot Delete a Host
~~~~~~~~~~~~~~~~~~~~

In rare cases, the :program:`mongod` is brought down and the replica set is
reconfigured. The down host cannot be deleted and returns an error message,
"This host cannot be deleted because it is enabled for backup." `Contact MMS
Support <https://mms.mongodb.com/links/support>`_ for help in deleting these
hosts.

For more information on deleted hosts, see :ref:`removing-hosts`.

Groups
------

Cannot Delete a Group
~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-remove-group.rst

How to Add a Group
~~~~~~~~~~~~~~~~~~

Create a group to monitor additional segregated systems or environments for
servers, agents, users, and other resources. For example, your deployment might
have two or more environments separated by firewalls. In this case, you would
need two or more separate MMS groups.

API and shared secret keys are unique to each group. Each group requires its
own agent with the appropriate API and shared secret keys. Within each group,
the agent needs to be able to connect to all hosts it monitors in the group.

.. include:: /includes/steps/add-group.rst

See :doc:`User and Environment Management </core/user-management/>` for
more details.

.. only:: hosted

   Monitoring Server
   -----------------

   Why doesn't the monitoring server startup successfully?
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

   If you use authentication, whether or not you enable backup, confirm these
   properties are in the ``<install_dir>/conf/conf-mms.properties``
   file:

   .. code-block:: ini

      mongo.mongoUri=<SetToValidUri>
      mongo.replicaSet=<ValidRSIfUsed>

   Otherwise, MMS will fail while trying to connect to the default 127.0.0.1:27017
   URL.

   If you use the MMS :program:`<install_dir>/bin/credentialstool` to encrypt
   the password used in the ``mongo.mongoUri`` value, also add the
   ``mongo.encryptedCredentials`` key to the
   ``<install_dir>/conf/conf-mms.properties`` file and set the value for this
   property to true:

   .. code-block:: ini

      mongo.encryptedCredentials=true

   For more details, see :ref:`on-prem-authentication-configuration`.

Munin
-----

Install and configure the ``munin-node`` daemon on the monitored MongoDB
server(s) before starting MMS monitoring. The MMS agent README file provides
guidelines to install ``munin-node``. However, new versions of Linux,
specifically Red Hat Linux (RHEL) 6, can generate error messages. See
:doc:`Configure MMS Monitoring </tutorial/configure-monitoring/>` for details about
monitoring hardware with ``munin-node``.

Restart ``munin-node`` after creating links for changes to take effect.

"No package munin-node is available" Error
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To correct this error, install the most current version of the Linux repos.
Type these commands:

.. code-block:: sh

   sudo yum install http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm

Then type this command to install ``munin-node`` and all dependencies:

.. code-block:: sh

   sudo yum install munin-node

Non-localhost IP Addresses are Blocked
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default, munin blocks incoming connections from non-localhost IP addresses.
The ``/var/log/munin/munin-node.log`` file will display a
"Denying connection" error for your non-localhost IP address.

To fix this error, open the ``munin-node.conf`` configuration file and comment
out these two lines:

.. code-block:: sh

   allow ^127\.0\.0\.1$
   allow ^::1$

Then add this line to the ``munin-node.conf`` configuration file with a pattern
that matches your subnet:

.. code-block:: sh

   cidr_allow 0.0.0.0/0

Restart ``munin-node`` after editing the configuration file for changes to take effect.

Verifying iostat and Other Plugins/Services Returns "# Unknown service" Error
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The first step is to confirm there is a problem. Open a telnet session and
connect to ``iostat``, ``iostat_ios``, and ``cpu``:

.. code-block:: sh

   telnet HOSTNAME 4949 <default/required munin port>
   fetch iostat
   fetch iostat_ios
   fetch cpu

If any of these telnet ``fetch`` commands returns an "# Unknown Service" error,
create a link to the plugin or service in /etc/munin/plugins/ by typing these
commands:

.. code-block:: sh

   cd /etc/munin/plugins/
   sudo ln -s /usr/share/munin/plugins/<service> <service>

Replace ``<service>`` with the name of the service that generates the error.

Disk names are not listed by Munin
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In some cases, Munin will omit disk names with a dash between the name and a
numerical prefix, for example, ``dm-0`` or ``dm-1``. There is `a documented fix`_ for
Munin's iostat plugin.

.. _`a documented fix`: https://bugs.launchpad.net/ubuntu/+source/munin/+bug/493982

Two-Factor Authentication
-------------------------

Missed SMS Authentication Tokens
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Unfortunately SMS is not a 100% reliable delivery mechanism for messages,
especially across international borders. The Google authentication option is
100% reliable. Unless you must use SMS for authentication, use the
Google Authenticator application for two-factor authentication.

If you do not receive the SMS authentication tokens:

1. Refer to the :doc:`Settings </core/settings/>`
   page for more details about using two-factor authentication. This
   page includes any limitations which may affect SMS delivery times.

2. Enter the SMS phone number with country code first followed by the
   area code and the phone number. Also try 011 first followed by
   the country code, then area code, and then the phone number.

If you do not receive the authentication token in a reasonable amount
of time `contact MMS Support <https://mms.mongodb.com/links/support>`_ to
rule out SMS message delivery delays.

How to Delete or Reset Two-Factor Authentication
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. only:: saas

   `Contact MMS Support <https://mms.mongodb.com/links/support>`_ to delete or
   reset any two-factor authentications you have configured.

.. only:: hosted

   Contact your system administrator to remove or reset two-factor
   authentication on your account.

   For administrative information on two-factor authentication, see
   :doc:`/tutorial/manage-two-factor-authentication`.
