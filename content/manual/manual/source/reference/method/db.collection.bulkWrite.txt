==========================================
db.collection.bulkWrite() (mongosh method)
==========================================

.. default-domain:: mongodb

.. meta::
   :description: Perform a series of ordered or unordered write operations.

.. facet::
   :name: programming_language 
   :values: shell

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/wayfinding/mongosh-method-bulkWrite.rst

.. note:: New Bulk Write Command in MongoDB 8.0

   Starting in MongoDB 8.0, you can use the :method:`Mongo.bulkWrite()`
   ``mongosh`` method to perform bulk writes across multiple databases and
   collections. To learn more about different bulk write methods and commands,
   see :ref:`bulk-write-operations`.

Definition
----------

.. method:: db.collection.bulkWrite()

   Performs multiple write operations on **one** collection, with controls for 
   order of execution.

   :returns:
      - A boolean ``acknowledged`` as ``true`` if the operation ran with
        :term:`write concern` or ``false`` if write concern was disabled.
      - A count for each write operation.
      - An array containing an ``_id`` for each successfully inserted or
        upserted documents.

Compatibility
-------------

.. |operator-method| replace:: ``db.collection.bulkWrite()``

|operator-method| is available in deployments hosted in the following environments:

.. include:: /includes/fact-environments-atlas-only.rst

.. include:: /includes/fact-environments-atlas-support-all.rst

.. include:: /includes/fact-environments-onprem-only.rst

.. note::

   You can't perform :ref:`bulk write <bulk-write-operations>` 
   operations in the :ref:`Atlas UI <atlas-ui-docs>`. 
   To insert multiple documents, you must insert an array of documents.
   To learn more, see :ref:`atlas-ui-docs` in the Atlas documentation. 

Syntax
------

The :method:`~db.collection.bulkWrite()` method has the following form:

.. code-block:: javascript

   db.collection.bulkWrite(
       [ <operation 1>, <operation 2>, ... ],
       {
         writeConcern : <document>,
         ordered : <boolean>
       }
   )

Parameters
~~~~~~~~~~

The :method:`~db.collection.bulkWrite()` method takes the following
parameters:

.. list-table::
   :header-rows: 1
   :widths: 20 20 80

   * - Parameter
     - Type
     - Description

   * - ``operations``
     - array
     - An array of :method:`~db.collection.bulkWrite()` write
       operations.

       Valid operations are:

       .. hlist::
          :columns: 2

          - :ref:`insertOne <bulkwrite-write-operations-insertOne>`
          - :ref:`updateOne <bulkwrite-write-operations-updateOneMany>`
          - :ref:`updateMany <bulkwrite-write-operations-updateOneMany>`
          - :ref:`deleteOne <bulkwrite-write-operations-deleteOneMany>`
          - :ref:`deleteMany <bulkwrite-write-operations-deleteOneMany>`
          - :ref:`replaceOne <bulkwrite-write-operations-replaceOne>`

       See :ref:`bulkwrite-write-operations` for usage of each operation

   * - ``writeConcern``
     - document
     - Optional. A document expressing the :ref:`write concern
       <write-concern>`. Omit to use the default write concern.
 
       .. include:: /includes/extracts/transactions-operations-write-concern.rst

   * - ``ordered``
     - boolean
     - Optional. A boolean specifying whether the :binary:`~bin.mongod` instance should perform
       an ordered or unordered operation execution. Defaults to ``true``.

       See :ref:`bulkwrite-write-operations-executionofoperations`

Behavior
--------

:method:`~db.collection.bulkWrite()` takes an array of write operations and
executes each of them. By default operations are executed in order.
See :ref:`bulkwrite-write-operations-executionofoperations` for controlling
the order of write operation execution.


.. _bulkwrite-write-operations:

Write Operations
~~~~~~~~~~~~~~~~

.. _bulkwrite-write-operations-insertOne:

insertOne
+++++++++

Inserts a single document into the collection.

.. code-block:: javascript

   db.collection.bulkWrite( [
      { insertOne : { "document" : <document> } }
   ] )

See :method:`db.collection.insertOne()`.

.. _bulkwrite-write-operations-updateOneMany:

updateOne and updateMany
++++++++++++++++++++++++

.. tabs::

   tabs:

      - id: updateOne
        name: updateOne
        content: |

           ``updateOne`` updates a *single* document in the collection that matches the
           filter. If multiple documents match, ``updateOne`` will update the *first*
           matching document only.

           .. code-block:: javascript

              db.collection.bulkWrite( [
                 { updateOne :
                    {
                       "filter": <document>,
                       "update": <document or pipeline>, 
                       "upsert": <boolean>,
                       "collation": <document>,  
                       "arrayFilters": [ <filterdocument1>, ... ], 
                       "hint": <document|string> 
                    }
                 }
              ] )

      - id: updateMany
        name: updateMany
        content: |

           ``updateMany`` updates *all* documents in the collection
           that match the filter.

           .. code-block:: javascript

              db.collection.bulkWrite( [
                 { updateMany :
                    {
                       "filter" : <document>,
                       "update" : <document or pipeline>, 
                       "upsert" : <boolean>,
                       "collation": <document>,                  
                       "arrayFilters": [ <filterdocument1>, ... ],
                       "hint": <document|string>
                    }
                 }
              ] )

.. list-table::
   :widths: 15 85
   :header-rows: 1

   * - Field
     - Notes

   * - ``filter``

     - The selection criteria for the update. The same :ref:`query
       selectors <query-selectors>` as in the
       :method:`db.collection.find()` method are available.

   * - ``update``

     - The update operation to perform. Can specify either:

       - A document that only contains :ref:`update operator
         <update-operators>` expressions.

       - An :ref:`aggregation pipeline <aggregation-pipeline>` ``[
         <stage1>, <stage2>, ... ]`` that specifies the modifications to
         perform.

   * - ``upsert``

     - Optional. A boolean to indicate whether to perform an upsert.

       By default, ``upsert`` is ``false``.

   * - ``arrayFilters``

     - Optional. An array of filter documents that determine which
       array elements to modify for an update operation on an array
       field.

   * - ``collation``

     - Optional. Specifies the :ref:`collation <collation>` to use for
       the operation.

   * - ``hint``

     - Optional. The :ref:`index <indexes>` to use to support the
       update ``filter``. If you specify an index that does not exist,
       the operation errors.


For details, see :method:`db.collection.updateOne()` and
:method:`db.collection.updateMany()`.

.. _bulkwrite-write-operations-replaceOne:

replaceOne
++++++++++

``replaceOne`` replaces a *single* document in the collection that matches the
filter. If multiple documents match, ``replaceOne`` will replace the *first*
matching document only.

.. code-block:: javascript

   db.collection.bulkWrite([
      { replaceOne :
         {
            "filter" : <document>,
            "replacement" : <document>,
            "upsert" : <boolean>,
            "collation": <document>, 
            "hint": <document|string> 
         }
      }
   ] )

.. list-table::
   :widths: 15 85
   :header-rows: 1

   * - Field
     - Notes

   * - ``filter``

     - The selection criteria for the replacement operation. The same
       :ref:`query selectors <query-selectors>` as in the
       :method:`db.collection.find()` method are available.

   * - ``replacement``

     - The replacement document. The document cannot contain
       :ref:`update operators <update-operators>`.

   * - ``upsert``

     - Optional. A boolean to indicate whether to perform an upsert. By
       default, ``upsert`` is ``false``.

   * - ``collation``

     - Optional. Specifies the :ref:`collation <collation>` to use for
       the operation.

   * - ``hint``

     - Optional. The :ref:`index <indexes>` to use to support the
       update ``filter``. If you specify an index that does not exist,
       the operation errors.

For details, see to :method:`db.collection.replaceOne()`.

.. _bulkwrite-write-operations-deleteOneMany:

deleteOne and deleteMany
++++++++++++++++++++++++

.. tabs::

   tabs:

      - id: deleteOne
        name: deleteOne
        content: |

           ``deleteOne`` deletes a *single* document in the collection that match the
           filter. If multiple documents match, ``deleteOne`` will delete the *first*
           matching document only.

           .. code-block:: javascript

              db.collection.bulkWrite([
                 { deleteOne : {
                    "filter" : <document>,
                    "collation" : <document>                   // Available starting in 3.4
                 } }
              ] )

      - id: deleteMany
        name: deleteMany
        content: |

           ``deleteMany`` deletes *all* documents in the collection
           that match the filter.

           .. code-block:: javascript

              db.collection.bulkWrite([
                 { deleteMany: {
                    "filter" : <document>,
                    "collation" : <document>                    // Available starting in 3.4
                 } }
              ] )

.. list-table::
   :widths: 15 85
   :header-rows: 1

   * - Field
     - Notes

   * - ``filter``

     - The selection criteria for the delete operation. The same
       :ref:`query selectors <query-selectors>` as in the
       :method:`db.collection.find()` method are available.

   * - ``collation``

     - Optional. Specifies the :ref:`collation <collation>` to use for
       the operation.


For details, see :method:`db.collection.deleteOne()` and
:method:`db.collection.deleteMany()`.

.. _bulkwrite-write-operations-id:


``_id`` Field
~~~~~~~~~~~~~

If the document does not specify an :term:`_id` field, then :binary:`~bin.mongod`
adds the ``_id`` field and assign a unique
:method:`ObjectId` for the document before inserting or upserting it.
Most drivers create an ObjectId and insert the ``_id`` field, but the
:binary:`~bin.mongod` will create and populate the ``_id`` if the driver or
application does not.

If the document contains an ``_id`` field, the ``_id`` value must be
unique within the collection to avoid duplicate key error.

Update or replace operations cannot specify an ``_id`` value that differs
from the original document.

.. _bulkwrite-write-operations-executionofoperations:

Execution of Operations
~~~~~~~~~~~~~~~~~~~~~~~

By default, :method:`~db.collection.bulkWrite()` runs an ordered list of
operations:

- Operations run serially. 
- If an operation has an error, that operation and
  any following operations are not run.
- Operations listed before the error operation are completed.

The ``ordered`` parameter specifies whether
:method:`~db.collection.bulkWrite()` will execute operations in order or not.
By default, operations are executed in order.

The following code represents a :method:`~db.collection.bulkWrite()` with
five operations.

.. code-block:: javascript

   db.collection.bulkWrite(
      [
         { insertOne : <document> },
         { updateOne : <document> },
         { updateMany : <document> },
         { replaceOne : <document> },
         { deleteOne : <document> },
         { deleteMany : <document> }
      ]
   )

In the default ``ordered : true`` state, each operation will
be executed in order, from the first operation ``insertOne``
to the last operation ``deleteMany``.

If ``ordered`` is set to false, operations may be reordered by
:binary:`~bin.mongod` to increase performance.
Applications should not depend on order of operation execution.

The following code represents an unordered
:method:`~db.collection.bulkWrite()` with six operations:

.. code-block:: javascript

   db.collection.bulkWrite(
      [
         { insertOne : <document> },
         { updateOne : <document> },
         { updateMany : <document> },
         { replaceOne : <document> },
         { deleteOne : <document> },
         { deleteMany : <document> }
      ],
      { ordered : false }
   )

With ``ordered : false``, the results of the operation may vary. For example,
the ``deleteOne`` or ``deleteMany`` may remove more or fewer documents
depending on whether the run before or after the ``insertOne``, ``updateOne``,
``updateMany``, or ``replaceOne`` operations.

.. include:: /includes/fact-bulkwrite-operation-batches.rst

.. include:: /includes/fact-bulk-operation-sharded-cluster.rst

Capped Collections
~~~~~~~~~~~~~~~~~~

:method:`~db.collection.bulkWrite()` write operations have restrictions when
used on a :term:`capped collection`.

``updateOne`` and ``updateMany`` throw a ``WriteError`` if the
``update`` criteria increases the size of the document being modified.

``replaceOne`` throws a ``WriteError`` if the
``replacement`` document has a larger size than the original
document.

``deleteOne`` and ``deleteMany`` throw a ``WriteError`` if used on a
capped collection.

.. |operation| replace:: :method:`db.collection.bulkWrite()`

.. _bulkWrite-error-handling:

Error Handling
~~~~~~~~~~~~~~

:method:`db.collection.bulkWrite()` throws a ``BulkWriteError``
exception on errors. See :ref:`bulkwrite-error-handling-txn`.

Excluding :ref:`write concern <write-concern>` errors, ordered operations
stop after an error, while unordered operations continue to process any
remaining write operations in the queue, unless when run inside a
transaction. See :ref:`bulkwrite-error-handling-txn`.

Write concern errors are displayed in the ``writeConcernErrors`` field, while
all other errors are displayed in the ``writeErrors`` field. If an error is
encountered, the number of successful write operations are displayed instead
of the inserted ``_id`` values. Ordered operations display the single error
encountered while unordered operations display each error in an array.

Schema Validation Errors
++++++++++++++++++++++++

If your collection uses :ref:`schema validation
<schema-validation-overview>` and has ``validationAction`` set to 
``error``, inserting an invalid document or updating a document with
invalid values throws an error. Operations preceding the invalid 
operation in the ``operations`` array are executed and written to the 
collection. The ``ordered`` field determines if the remaining 
operations are executed.

Transactions
~~~~~~~~~~~~

.. include:: /includes/extracts/transactions-supported-operation.rst

.. include:: /includes/extracts/transactions-usage.rst

Inserts and Upserts within Transactions
+++++++++++++++++++++++++++++++++++++++

.. include:: /includes/extracts/4.4-changes-transactions-bulkWrite.rst

Write Concerns and Transactions
+++++++++++++++++++++++++++++++

.. include:: /includes/extracts/transactions-operations-write-concern.rst

.. _bulkwrite-error-handling-txn:

Error Handling inside Transactions
++++++++++++++++++++++++++++++++++

.. include:: /includes/extracts/4.2-changes-bulkWrite-txn-error-handling.rst

Examples
--------

.. _bulkwrite-example-bulk-write-operation:

.. include:: /includes/sample-data-usage.rst

.. _bulkwrite-example-unordered-bulk-write:

Unordered Bulk Write Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To specify an unordered :method:`~db.collection.bulkWrite()`, set
``ordered`` to ``false``.

In an unordered :method:`~db.collection.bulkWrite()` list of operations:

- Operations can run in parallel (not guaranteed). For details. See
  :ref:`bulk-write-operations-ordered-vs-unordered`.
- Operations with errors are not completed.
- All operations without errors are completed.

In the following example:

- :method:`~db.collection.bulkWrite()` runs unordered operations on
  the ``users`` collection.
- The second ``insertOne`` operation, which is commented out, has the same ``_id`` as the first
  ``insertOne``, which causes a duplicate key error.

.. literalinclude:: /code-examples/tested/command-line/mongosh/bulkWrite/insert-error.js
   :language: javascript
   :category: usage example

The second ``insertOne`` operation fails because of the duplicate key
error. In an unordered :method:`~db.collection.bulkWrite()`, MongoDB completes any
operation without an error. 

.. _bulkwrite-write-concern-errors-in-sharded-clusters:

Write Concern Errors in Sharded Clusters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. |cmd| replace:: :method:`db.collection.bulkWrite()`
.. include:: /includes/fact-update-writeConcernError-mongos.rst

.. _bulkwrite-example-bulk-write-with-write-concern:

Bulk Write with Write Concern Example
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following :method:`~db.collection.bulkWrite()` example runs
operations on the ``users`` collection and sets a ``"majority"``
:ref:`write concern <wc-w>` with a 100 millisecond :ref:`timeout
<wc-wtimeout>`:

.. literalinclude:: /code-examples/tested/command-line/mongosh/bulkWrite/majority-write-concern.js
   :language: javascript
   :category: usage example

If the time for the majority of replica set members to acknowledge the
operations exceeds ``wtimeout``, the example returns a write concern
error and a summary of completed operations.