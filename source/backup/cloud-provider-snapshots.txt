.. _backup-cloud-provider:

========================
Cloud Provider Snapshots
========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

|service| Cloud Provider Snapshots provide localized backup storage
using the native snapshot functionality of the cluster's cloud service
provider.

|service| supports cloud provider snapshots for
:ref:`Microsoft Azure <microsoft-azure>`,
:ref:`Amazon Web Services (AWS) <amazon-aws>`, and
:ref:`Google Cloud Provider (GCP) <google-gcp>` backed clusters.

You can enable cloud provider snapshots during the
:doc:`cluster creation </create-new-cluster>` or during the
:doc:`modification of an existing cluster </scale-cluster>`.
From the cluster configuration modal, toggle
``Do you want to enable backup?`` to ``Yes`` and select the
:guilabel:`Cloud Provider Snapshots` card.

.. include:: /includes/extracts/backup-selection-cloud-provider.rst


.. note::

   |service| supports Cloud Provider Snapshots for sharded clusters
   running MongoDB version 3.4+ with the following limitations:

   * |service| does not guarantee :ref:`causal consistency <causal-consistency>`
     of your data.

   * You cannot restore an existing snapshot to a cluster after you
     change that cluster's topology by adding or removing a shard.
     However, you can restore an existing snapshot to another cluster
     with a matching topology.

   * You cannot :manual:`manually migrate chunks </tutorial/migrate-chunks-in-sharded-cluster>`
     in a cluster during a snapshot without the risk of creating an
     inconsistent snapshot.

.. _encrypted-cloud-provider-snapshot:

Cloud Provider Snapshots with Encryption at Rest
------------------------------------------------

|service| encrypts all snapshot volumes, ensuring the security of
cluster data at rest (Encryption at Rest). For projects and clusters
using :ref:`security-kms-encryption`, |service| applies an additional
layer of encryption to your snapshot storage volumes using the 
Key Management Service (KMS) provider configured for the cluster.

.. note::

   Cloud Provider Snapshots with Encryption at Rest is not currently
   available for GCP-backed clusters.

.. tabs::

   tabs:

   - id: aws-kms

     name: "AWS Identity and Access Management (IAM)"

     content: |

       For clusters using :doc:`AWS IAM </security-aws-kms>` as their
       Key Management Service, |service| uses the project's 
       customer master key (CMK) and AWS 
       :abbr:`IAM (Identity and Access Management)` user credentials at 
       the time of the snapshot to automatically encrypt the snapshot 
       data files. This is an additional layer of encryption on the 
       existing encryption applied to all |service| storage and snapshot 
       volumes.

       |service| stores the unique ID of the 
       :abbr:`CMK (customer master key)` and the AWS 
       :abbr:`IAM (Identity and Access Management)` user credentials 
       used to access the :abbr:`CMK (customer master key)`. |service| 
       uses this information when restoring the snapshot. For complete 
       documentation on restoring an encrypted snapshot, 
       see :ref:`restore-encrypted-snapshot`.

       To view the key used to encrypt a snapshot:

       #. From the :guilabel:`Clusters` view of the |service| UI, click 
          on the cluster name.

       #. Click the :guilabel:`Backup` tab, then click 
          :guilabel:`Snapshots`.

       #. Note the :guilabel:`Encryption Key ID` for each snapshot in 
          the cluster. |service| lists the 
          :abbr:`CMK (Customer Master Key)` used to encrypt the 
          snapshot. Unencrypted snapshots display
          :guilabel:`Not enabled`.

       .. include:: /includes/fact-encrypted-backups-master-key-requirements.rst

   - id: azure-kms

     name: "Azure Key Vault"

     content: |

       For clusters using :doc:`Azure Key Vault </security-azure-kms>`
       as their Key Management Service, |service| uses the project's
       Key Identifier, Key Vault Credentials, and Active Directory
       application account credentials at the time of the snapshot to
       automatically encrypt the snapshot data files. This is an
       additional layer of encryption on the existing encryption 
       applied to all |service| storage and snapshot volumes.

       |service| stores the unique ID of the 
       Azure Key Identifier used the encrypt the snapshot. |service|
       also stores the Azure Key Vault
       credentials and the Active Domain application account
       credentials used to access the Key Identifier. 
       |service| uses this information when restoring the snapshot. 
       For complete documentation on restoring an encrypted snapshot, 
       see :ref:`restore-encrypted-snapshot`.

       To view the key used to encrypt a snapshot:

       #. From the :guilabel:`Clusters` view of the |service| UI, click 
          on the cluster name.

       #. Click the :guilabel:`Backup` tab, then click 
          :guilabel:`Snapshots`.

       #. Note the :guilabel:`Encryption Key ID` for each snapshot in 
          the cluster. |service| lists the Key Identifier
          used to encrypt the snapshot. Unencrypted snapshots display
          :guilabel:`Not enabled`.

       .. include:: /includes/fact-encrypted-backups-master-key-requirements.rst

For complete documentation on configuring Encryption at Rest using
your Key Management for an |service| project,
see :doc:`/security-kms-encryption`. You can then either
:ref:`deploy <create-cluster-enable-encryption>` a new cluster
:ref:`enable <scale-cluster-enable-encryption>` an existing cluster
with Encryption at Rest using your Key Management.

Single Region Cluster Backups
-----------------------------

.. tabs::

     tabs:
  
     - id: aws-gcp
       name: AWS / GCP
       content: |

         |service| selects the :term:`primary` member of the cluster
         *at the time you enable snapshots for the cluster*. |service|
         stores the snapshots in the same cloud region as the cluster.
         |service| retains snapshots based on the :ref:`retention policy
         <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-single-region-primary.rst

         |service| continues to use that member and its
         corresponding region for snapshots and snapshot storage, even
         if that member is no longer the primary.

         .. include:: /images/cloud-provider-snapshot-single-region-secondary.rst

         |service| automatically creates a new snapshot storage volume
         if the existing snapshot storage volume becomes invalid.
         |service| creates the new volume in the same region as the
         cluster's current primary. |service| then takes a full-copy
         snapshot to maintain backup availability and continues using
         that member and its corresponding region for further
         incremental snapshots.

         Events that can trigger storage invalidation include:

         - Changing the |service| cluster instance size,
         - Modifying the |service| cluster's storage volume or speed,
         - Changing the |service| cluster's :abbr:`AWS (Amazon Web Services)` region, and
         - Maintenance performed by |service| or :abbr:`AWS (Amazon Web Services)`.

         To manually reset the snapshot target and storage, disable and
         re-enable backups for the cluster. Disabling |service| backups
         removes all snapshots for the cluster.
         For more information on snapshot retention, see
         :ref:`cloud-provider-retention-policy`.

     - id: azure
       name: Azure
       content: |

         |service| always selects the :term:`primary` member of the
         cluster for backup snapshots and stores the 
         snapshots in the same cloud region as the cluster. |service| 
         retains snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-single-region-primary.rst

         If that member steps down
         to a :term:`secondary`, |service| changes the snapshot
         target to the current :term:`primary`.

         .. include:: /images/cloud-provider-snapshot-single-region-moved-primary.rst

Multi-Region Cluster Backups
----------------------------

.. tabs::

     tabs:
  
     - id: aws-gcp
       name: AWS / GCP
       content: |

         |service| selects the :term:`primary` member of the cluster
         *at the time you enable snapshots for the cluster* for backup
         snapshots. |service| stores the snapshots in the same region as
         the primary member. |service| retains snapshots based on the
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-multi-region-primary.rst

         If the member steps down to a :term:`secondary`, |service|
         continues to use that member for snapshots. |service|
         continues storing snapshots in the same region as that member,
         even if the primary is in a different region.

         .. include:: /images/cloud-provider-snapshot-multi-region-secondary.rst

         |service| automatically creates a new snapshot storage volume
         if the existing snapshot storage volume becomes invalid.
         |service| creates the new volume in the same region as the
         cluster's current primary. |service| then takes a full-copy
         snapshot to maintain backup availability and continues using
         that member and its corresponding region for further
         incremental snapshots.

         Events that can trigger storage invalidation include:

         - Changing the |service| cluster instance size,
         - Modifying the |service| cluster's storage volume or speed,
         - Changing the |service| cluster's :abbr:`AWS (Amazon Web Services)` region, and
         - Maintenance performed by |service| or :abbr:`AWS (Amazon Web Services)`.

         To manually reset the snapshot target and storage, disable and
         re-enable backups for the cluster. Disabling |service| backups
         removes all snapshots for the cluster.
         For more information on snapshot retention, see
         :ref:`cloud-provider-retention-policy`.
  
     - id: azure
       name: Azure
       content: |
  
         |service| always selects the :term:`primary` member of the
         cluster for backup snapshots and stores the snapshots
         in the same region as the primary member. |service| retains 
         snapshots based on the 
         :ref:`retention policy <cloud-provider-retention-policy>`.

         .. include:: /images/cloud-provider-snapshot-multi-region-primary.rst

         If that member steps down
         to a :term:`secondary`, |service| changes the snapshot
         target to the current :term:`primary`.

         .. include:: /images/cloud-provider-snapshot-multi-region-moved-primary.rst

         |service| stores subsequent snapshots in the region of the
         new primary member.

.. _sharded-global-cluster-backup:

Global Cluster Backups
----------------------

|service| provides backups for :doc:`Global Clusters </global-clusters>`
using Cloud Provider Snapshots as their backup method. |service| restores
the shards in the source cluster to the corresponding shards in the target
cluster using the same order as specified in the cluster configuration.
For example, ``shard0`` in the source cluster is restored to ``shard0``
in the target cluster.

.. note::

   If you used the API to create your Global Cluster, the zones are defined
   in the ``replicationSpecs`` parameter in the :doc:`Create a Cluster
   </reference/api/clusters-create-one>` and :doc:`Modify a Cluster
   </reference/api/clusters-modify-one>` APIs.


If the cluster configurations of the source and target clusters do not match,
shard data may migrate to a different cloud provider zone than where it
resided in the source cluster. After |service| completes the restore
operation, the MongoDB :term:`balancer` for the target cluster migrates the
data back to the zone where it resided in the source cluster if
your clusters meet the following requirements:

* Both clusters have enabled a |global-write-cluster| on the same collection

* Both clusters use the same :term:`shard key` for the |global-write|-enabled
  collection

.. note::

   If the |global-write|-enabled collection on the target cluster does not
   contain any data, the MongoDB balancer for the cluster automatically distributes
   any data that you later add to the collection among the target cluster's
   shards.

To enable global writes on the target cluster:

1. Click :guilabel:`Collections` beneath the target cluster on the
   :guilabel:`Clusters` page.

#. Click :guilabel:`Enable Global Writes`.

.. _cloud-provider-backup-schedule:
.. _cloud-provider-retention-policy:
.. _cps-backup-policies:

Snapshot Scheduling and Retention Policy
----------------------------------------

Use the Backup Policy Editor to configure a backup policy for Cloud Provider
Snapshots. 

1. From the :guilabel:`Clusters` view, click the cluster name.

#. Click the :guilabel:`Backup` tab.

#. Click :guilabel:`Backup Policy`.

Each backup policy consists of a snapshot time and one or more policy items.
The backup policy time specifies the time of day, in UTC, that |service|
takes snapshots for the backup policy. Snapshots taken for the hourly
policy item may occur multiple times each day, depending on the
frequency interval specified. Each backup policy
item specifies a frequency unit and interval and a retention time.

For example, the default backup policy specifies a snapshot time of  UTC ``18:00``
and the following four policy items:

* Hourly snapshot with an interval of one hour and a retention of two days
* Daily snapshot with a retention of seven days
* Weekly snapshot with an interval of Saturday and a retention of four weeks
* Monthly snapshot with an interval of the last day of the month and a 
  retention of twelve months

For complete documentation on cloud provider
snapshot billing, see :ref:`billing-backup-cloud-provider-snapshots`.

.. _changine-backup-policy-time:

Changing the Backup Policy Time
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To modify the backup policy time:

1. In the :guilabel:`Backup Policy Editor`, select the hour at
   which |service| takes a snapshot each day from :guilabel:`hr`
   beneath :guilabel:`Snapshot Time (UTC)`.
  
2. Select the number of minutes after :guilabel:`hr` at which |service| takes a
   snapshot from :guilabel:`min` beneath :guilabel:`Snapshot Time (UTC)`.

3. Click :guilabel:`Save Changes`.

.. _creating-backup-policy:

Configuring the Backup Policy
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Each row in the :guilabel:`Backup Policy Frequency and Retention` table
represents a backup policy item. Configure the policy items and,
optionally, add new policy items to configure a new backup policy.

.. tip::

   |service| displays an estimate of the total snapshot count associated with
   your changes below the :guilabel:`Backup Policy Frequency and Retention` table.

To specify a backup policy item:

1. Select the frequency unit from :guilabel:`Frequency Unit` for a policy item.

   Alternatively, click :guilabel:`Add Frequency Unit` to add a new policy item
   to the backup policy.

   .. note::

      You cannot specify multiple :guilabel:`Hourly` and :guilabel:`Daily`
      backup policy items.

2. Select the frequency for the frequency unit from :guilabel:`Every`.

3. Specify the retention time for the policy item in :guilabel:`Retention Time`
   and the units for the retention time from the list to the right.

   .. note::

      |service| requires that the value specified for :guilabel:`Retention Time`
      for less frequent policy items be equal to or larger than the value specified
      for more frequent policy items. For example, if the hourly policy item
      specifies a retention of two days or greater, the retention for the weekly
      snapshot must be two weeks or greater.

4. (Optional) To apply the retention changes in the updated backup policy
   to snapshots that |service| took previously, check
   :guilabel:`Apply policy retention changes to existing snapshots`.

   .. note::

      This option affects only snapshots created by the updated policy items
      and whose retention has not been updated individually with the :doc:`/reference/api/cloud-provider-snapshot-schedule-modify-one` API.

5. Click :guilabel:`Save Changes`.

.. note::

   To take a snapshot sooner than the next scheduled snapshot,
   use the :doc:`/reference/api/cloud-provider-snapshot-take-one-ondemand` API.

.. note::

   .. include:: /includes/fact-overlapping-backup-policy-items.rst

.. important::

   If you disable cloud provider snapshots for a cluster or terminate a
   cluster that had snapshots enabled, |service| immediately
   deletes the backup snapshots for that cluster. For clusters not
   using :ref:`security-kms-encryption`
   you can :ref:`download the latest snapshot 
   <restore-cloud-provider-snapshot-download>` to preserve any data
   stored in the cluster.

.. _viewing-snapshots:

Viewing Snapshots
~~~~~~~~~~~~~~~~~

|service| displays existing snapshots on the :guilabel:`Snapshots`
page. To view snapshots that |service| has already taken:

1. From the :guilabel:`Clusters` view, click the cluster name.

#. Click the :guilabel:`Backup` tab.

#. Click :guilabel:`Snapshots`.

By default, |service| displays both on-demand and policy-based snapshots.
To view only policy-based snapshots:

1. Click :guilabel:`Policy` under :guilabel:`View Snapshots by`.

   Alternatively, click :guilabel:`On-demand` to display only snapshots
   taken by clicking :guilabel:`Take Snapshot Now`.

Snapshots taken according to the backup policy display the frequency of
the policy item that generated the snapshot in the :guilabel:`Frequency`
column: ``Monthly``, ``Weekly``, ``Daily``, or ``Hourly``.

.. note::

   .. include:: /includes/fact-overlapping-backup-policy-items.rst

.. _cloud-provider-snapshots-on-demand:
.. _on-demand-snapshots:

On-Demand Snapshots
-------------------

|service| takes on-demand snapshots immediately, unlike scheduled
snapshots which occur at :doc:`regular intervals </reference/api/cloud-provider-snapshot-schedule>`.
If there is already an on-demand snapshot with a status of ``queued`` or
``inProgress``, you must wait until |service| has completed the on-demand
snapshot before taking another. If there is already a scheduled snapshot
with a status of ``queued`` or ``inProgress``, you may queue an on-demand
snapshot. You must have the :authrole:`Organization Owner` or :authrole:`Project Owner`
role to successfully call this endpoint.

To take an on-demand snapshot:

1. From the :guilabel:`Clusters` view, click the :icon:`ellipsis-h` button
   below the cluster name and select :guilabel:`Take Snapshot Now`.

#. In the :guilabel:`On-Demand Snapshot` modal, enter the following:

   a. In the :guilabel:`Retention` box, enter the number of days that
      you want |service| to retain the snapshot.

   b. In the :guilabel:`Description` box, enter a descriptive name
      for the snapshot.

#. Click :guilabel:`Take Snapshot`.

Click the :guilabel:`Backup` tab, then click :guilabel:`Snapshots` for
the cluster to view the on-demand snapshot.

.. note::

   The :guilabel:`Take Snapshot Now` button also appears on the :guilabel:`Snapshots`
   page for the cluster.
