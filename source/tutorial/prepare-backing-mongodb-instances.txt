======================================================
Install the |application| Database and Backup Database
======================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: twocols

Overview
--------

Before you install |onprem| you must install the :ref:`mms-application-database`,
which holds |onprem| operational data. If you will use the |onprem| Backup
feature, you must also install the Backup Database, which stores oplog
data, temporary sync data, and, depending on your configuration, stores
your snapshots.

Both databases run on dedicated MongoDB :term:`replica sets <replica
set>`. If you use multiple Backup Databases, set up separate replica sets
for each database. The replica set for each database is dedicated to that
database only and **must store no other data**.

.. note::

   You cannot use |onprem| to deploy the backing database. You must deploy
   and manage the backing databases manually.

Replica Set Topology
--------------------

Each replica set is usually comprised of three data-bearing members to
provide high availability. If you cannot allocate space for three
data-bearing members, the third member can be an arbiter, but keep in mind
that |onprem| uses ``w:2`` :manual:`write concern
</reference/write-concern>`, which reports a write operation as successful
after acknowledgement from the primary and one secondary. If you use a
replica set with only two data-bearing members, and if you lose one of the
data-bearing members, MongoDB blocks write operations.

For the |onprem| Application Database, you can optionally run one member
of the replica set on the same physical server as |onprem|. For *testing
only*, you may use a standalone MongoDB deployment in place of each
replica set.

.. _requirements-backing-db-replica-sets:

Replica Sets Requirements
-------------------------

The replica sets that host the |application| Database and Backup Database(s) must:

- **Only** store data in support of |onprem| operations and **store no other data**.

- Run MongoDB version 3.0.6 or later if running a 3.0 version of MongoDB.
  Run MongoDB version 2.6.6 or later if running a 2.6 version of MongoDB.

- Use the storage engine appropriate to your workload. In most cases, this
  is MMAPv1. See the :ref:`storage engine considerations
  <storage-engine-considerations-for-backing-dbs>` below.

- Set the MongoDB :setting:`security.javascriptEnabled` option to ``true``, which
  is the default. The |application| uses the :query:`$where` query and
  requires this setting be enabled on the |application| Database.

- Must **not** run the MongoDB ``notablescan`` option.

- Must include user credentials for accessing the backing database. When
  you install |onprem|, you will include the user credentials in the
  :setting:`mongo.mongoUri` setting. You will also specify the
  :parameter:`authentication mechanism <authenticationMechanisms>` if the
  database uses a mechanism other than default MongoDB authentication.

.. _backing-instances-prerequisites:

Server Prerequisites
--------------------

The servers that run the replica sets must meet the following requirements.

- The hardware requirements described in :ref:`mms-application-database-specifications`
  or :ref:`backup-database-specifications`, depending on which database
  the server will host. If a server hosts other |onprem| components in
  addition to the database, you must sum the hardware requirements for
  each component to determine the requirements for the server.

- The system requirements in the :manual:`MongoDB Production Notes
  </administration/production-notes>`. The Production Notes include
  information on ulimits, NUMA, and other configuration options.

- The MongoDB ports requirements described in :doc:`/reference/firewall-configuration`.
  Each server's firewall rules must allow access to the required ports.

- **RHEL servers only**: if the ``/etc/security/limits.d`` directory
  contains the ``90-nproc.conf`` file, remove the file. The file overrides
  ``limits.conf``, decreasing ``ulimit`` settings. Issue the following
  command to remove the file:

  .. code-block:: sh

     sudo rm /etc/security/limits.d/90-nproc.conf

.. _storage-engine-considerations-for-backing-dbs:

Choosing a Storage Engine for the Backing Databases
---------------------------------------------------

MongoDB provides both the MMAPv1 and WiredTiger storage engines. The
|application| and Backup Database schemas have been designed to achieve
maximum performance on MMAPv1. Therefore, while WiredTiger outperforms
MMAPv1 on typical workloads, we recommend MMAPv1 for the unique |onprem|
workload.

The MMAPv1 engine also minimizes storage in the Backup Database's
blockstore, as all the blocks are already compressed and padding is
disabled. There is typically no further storage benefit to be gained by
taking advantage of WiredTiger compression.

In one case, WiredTiger might be preferable. Backups of insert-only
MongoDB workloads that benefit from high levels of block-level
de-duplication in the blockstore may see a compression-based storage
reduction when running the Backup Database on the WiredTiger storage
engine.

The storage engine used by the Backup Database is independent from the
storage engine chosen to store a deployment's snapshots. If the Backup
Database uses the MMAPv1 storage engine, it can store backup snapshots for
WiredTiger backup jobs in its blockstore.

Procedure
---------

To deploy MongoDB replica sets to host the |application| and Backup
Databases:

.. include:: /includes/steps/deploy-backing-dbs.rst
