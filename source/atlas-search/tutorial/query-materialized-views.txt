.. _query-materialized-views:

=================================================
How to Run |fts| Queries Using Materialized Views
=================================================

.. default-domain:: mongodb

.. meta::
   :keywords: $match, $unwind, $group, $set, $merge, app services, create a materialized view index, queries across collections
   :description:  In this tutorial, learn how to use a combination of on-demand materialized views and Atlas App Services scheduled triggers to create an Atlas Search index and query.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

This tutorial describes how to create an index and run queries against 
the  ``sample_supplies.sales`` collection from the :ref:`sample dataset 
<sample-data>` and a new ``sample_supplies.purchaseOrders``.

An on-demand materialized view is a collection that you create and 
update using a ``$merge`` aggregation pipeline stage. You can create an
|fts| index on the materialized view and then run queries on the
materialized view using the ``$search`` aggregation pipeline stage.

This tutorial takes you through the following steps:

1. Create a collection named ``purchaseOrders`` in the 
   ``sample_supplies`` database.

#. Create two scheduled triggers:

   - ``updateMonthlySales``, with a function named ``updateMonthlySales`` that 
     initializes the ``monthlyPhoneTransactions`` materialized view using data 
     from the sample ``sample_supplies.sales`` collection.

   - ``updateMonthlyPurchaseOrders``, with a function named 
     ``updateMonthlyPurchaseOrders`` that updates the ``monthlyPhoneTransactions`` 
     materialized view using data from the ``sample_supplies.purchaseOrders`` 
     collection.

#. Create an |fts| index on the ``monthlyPhoneTransactions`` 
   materialized view.

#. Run a query on the ``monthlyPhoneTransactions`` materialized view.

Before you begin, ensure that your |service| {+cluster+} meets the 
requirements described in the :ref:`fts-tutorials-prereqs`.

.. include:: /includes/atlas-roles/create-search-index.rst

To create the triggers, you must have :authrole:`Project Owner` or higher access 
to the project.

Create the ``purchaseOrders`` Collection
----------------------------------------

.. include:: /includes/steps/cross-collection-add-collection.rst

Create the Scheduled Triggers
-----------------------------

In the following procedures, you create triggers to create a materialized view 
and schedule a function to update the materialized view daily.

Create the ``updateMonthlySales`` Trigger
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Procedure
`````````

.. include:: /includes/steps-cross-collection-index-create-realm-scheduled-trigger.rst


Create the ``updateMonthlyPurchaseOrders`` Trigger
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Procedure
`````````

.. include:: /includes/steps-cross-collection-define-po-function.rst


Create an Atlas Search Index on the Materialized View
-----------------------------------------------------

Create an |fts| index on the ``monthlyPhoneTransactions`` collection.

.. |search-type| replace:: :guilabel:`Atlas Search`
.. |index-name| replace:: ``monthlyPhoneTransactions``
.. |database-name| replace:: ``sample_supplies`` database
.. |collection-name| replace:: ``monthlyPhoneTransactions`` collection

.. include:: /includes/steps-cross-collection-index-create-index.rst

Run a Query on the Materialized View
------------------------------------

Run a query against the newly updated and indexed 
``monthlyPhoneTransactions`` collection.

.. include:: /includes/steps/cross-collection-index-run-query.rst
