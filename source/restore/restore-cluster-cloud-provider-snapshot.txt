.. _restoration-cloud-provider-snapshot:

================================================
Restore a Cluster from a Cloud Provider Snapshot
================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

|service| lets you restore data from a scheduled cloud provider
snapshot. For information on cloud provider snapshot backups, see
:doc:`/backup/cloud-provider-snapshots`.

For instructions on restoring data from a
:doc:`continuous backup snapshot </backup/continuous-backups>`, see
:doc:`/restore-cluster`.

Restore a Cluster
-----------------

.. admonition:: Restoring Snapshots for Clusters using Encryption at Rest
   :class: important

   |service| automatically encrypts
   :ref:`Cloud Provider Snapshots <backup-cloud-provider>` for 
   clusters using :doc:`/security-kms-encryption`, in addition to the
   existing encryption applied to all |service| storage and snapshot
   volumes. For documentation on restoring an encrypted snapshot, see
   :ref:`restore-encrypted-snapshot`

   The following instructions only apply to snapshots for
   clusters not using Encryption at Rest.

#. From the :guilabel:`Clusters` view, click on the cluster name.

#. Click the :guilabel:`Backup` tab.

   If the cluster has no :guilabel:`Backup` tab, then |service| backups
   are disabled for that cluster and no snapshots are available.
   You can enable backups when
   :ref:`scaling the cluster <scale-cluster-backups>`.

#. Select a cluster's snapshot to restore.

   Click :guilabel:`Restore` or :guilabel:`Download`.

#. Follow the prompts to restore your cluster. You may choose to:

   - :ref:`Download your snapshot via HTTPS <restore-cloud-provider-snapshot-download>`.

   - :ref:`Restore your snapshot to an Atlas project <restore-cloud-provider-snapshot-atlas>`.

   - :ref:`Restore your snapshot to a Cloud Manager project <restore-cloud-provider-snapshot-mms>`.

.. _restore-cloud-provider-snapshot-download:

Download your Snapshot via HTTPS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

From the :guilabel:`Snapshots` tab, click :guilabel:`Download` to
retrieve your backup data via HTTPS and restore manually. |service|
generates a one-time use download link that expires within 4 hours.
Once the download is ready, |service| emails you a link to download the
snapshot. |service| also displays the download link in the
:guilabel:`Restore History` tab.

You must add the IP or :abbr:`CIDR (Classless Inter-Domain Routing)`
address of the client to your |service| project
:ref:`whitelist <whitelist>`. The :guilabel:`Restore` prompt displays
your :guilabel:`Existing IP Whitelist`.

If the current project whitelist ranges do not cover the target client
IP or :abbr:`CIDR (Classless Inter-Domain Routing)` address, click
:guilabel:`Add or Modify your IP Addresses` to make changes to your
|service| project whitelist.

|service| compresses the snapshot into a ``.tar.gz`` file. Use your
preferred archive utility to extract the archive and access the
data files. The following example uses the ``tar`` utility to extract
a ``tar`` archive with ``gzip`` compression:

.. code-block:: shell

   tar -xvzf ~/Downloads/mongodb-snapshots/my-cluster-snapshot.tar.gz

Once extracted, you can access the data files by starting a
:binary:`~bin.mongod` instance on the host and pointing it
at the extract directory using the :option:`--dbpath <mongod.--dbpath>`
option. For example:

.. code-block:: shell

   mongod --dbpath ~/Downloads/mongodb-snapshots/my-cluster-snapshot/

.. note::

   You cannot choose to download your backup if there is already an
   active download available. To view the active download, click the
   :guilabel:`Restore History` tab.

.. _restore-cloud-provider-snapshot-atlas:

Restore your Snapshot to an Atlas Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. important::

    The restore process requires **downtime** for the target cluster.

1. Click :guilabel:`Restore` in the :guilabel:`Actions` column
   for the snapshot you want to restore.

#. From the :guilabel:`Restore` dialog, select the
   destination cluster to which you want to restore.

#. Click :guilabel:`Restore`.

|service| can only restore to a :term:`replica set` cluster that does
*not* use :doc:`Encryption at Rest </security-aws-kms>`. The target
cluster must run the same or newer version of MongoDB as the snapshot
MongoDB version.

You can restore to any |service| project for which the authenticated
|service| user has the :authrole:`Project Owner` role.

.. _restore-cloud-provider-snapshot-mms:

Restore your Snapshot to a Cloud Manager Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. important::

    The restore process requires **downtime** for the target cluster.

1. Click :guilabel:`Restore` in the :guilabel:`Actions` column
   for the snapshot you want to restore.

#. From the :guilabel:`Restore` dialog, select the
   destination |mms| project to which you want to restore.

#. Click :guilabel:`Restore`.

|service| can only restore to a :term:`replica set` cluster. The
target cluster must run the same or newer version of MongoDB as the
snapshot MongoDB version.

You can restore to any |mms| project for which the authenticated
|service| user has any of the following roles:

- :cloudmgr:`Organization Owner </reference/user-roles/#Organization-Owner>`
- :cloudmgr:`Project Owner </reference/user-roles/#Project-Owner>`
- :cloudmgr:`Project Backup Admin </reference/user-roles/#Project-Backup-Admin>`

You must add the IP or :abbr:`CIDR (Classless Inter-Domain Routing)`
addresses of the target |mms| project to your |service| project
:ref:`whitelist <whitelist>`. The :guilabel:`Restore` prompt displays
your :guilabel:`Existing IP Whitelist`.

If the current project whitelist ranges do not cover the target |mms|
project IP or :abbr:`CIDR (Classless Inter-Domain Routing)` addresses,
click  :guilabel:`Add or Modify your IP Addresses` to make changes to
your |service| project whitelist.

.. _restore-encrypted-snapshot:

Restore a Snapshot of a Cluster with Encryption at Rest
-------------------------------------------------------

.. important:: 
  
   Snapshots of clusters using 
   :doc:`Encryption at Rest using your Key Management </security-kms-encryption>` 
   can only restore to other clusters that use Encryption at Rest. You 
   cannot restore a snapshot with Encryption at Rest to a |mms| project, 
   nor can you download the snapshot.

#. From the :guilabel:`Clusters` view, click on the cluster name.

#. Click the :guilabel:`Backup` tab.

   If the cluster has no :guilabel:`Backup` tab, then |service| backups
   are disabled for that cluster and no snapshots are available.
   You can enable backups when
   :ref:`scaling the cluster <scale-cluster-backups>`.

#. Click :guilabel:`Restore` in the :guilabel:`Actions` column
   for the snapshot you want to restore.

#. From the :guilabel:`Restore` dialog, select the
   destination |service| :guilabel:`Project` to which you want to
   restore. You can restore to any |service| project for which the
   authenticated |service| user has the :authrole:`Project Owner` role.

#. Select the :guilabel:`Cluster` to restore to. 
   You can only restore to an |service| replica set running
   Encryption at Rest. The target cluster must run the same or
   greater version of MongoDB as the :guilabel:`MongoDB Version`
   of the snapshot.

   If the target project does not have a cluster with
   Encryption at Rest enabled, you can either
   :ref:`deploy <create-cluster-enable-encryption>` a cluster with
   Encryption at Rest, or
   :ref:`enable Encryption at Rest <scale-cluster-enable-encryption>`
   in an existing cluster.

After the restoration procedure, |service| triggers a key rotation
for MongoDB encryption key. |service| then encrypts the new MongoDB 
encryption keys based on the configured Encryption at Rest provider
for the target cluster.

If |service| cannot access the snapshot :guilabel:`Encryption Key ID`, 
|service| cannot restore the snapshot. :guilabel:`Encryption Key ID` 
access validation may fail for any of the following reasons:

|service| cannot access the :guilabel:`Encryption Key ID`
  The source project *or* destination project
  Encryption at Rest provider credentials must provide access
  to read and use the encryption key associated to the
  :guilabel:`Encryption Key ID`.

The :guilabel:`Encryption Key ID` is accessible, but not enabled.
  Enable the encryption key associated to the 
  :guilabel:`Encryption Key ID` in the Encryption at Rest Provider's
  key management interface.

The :guilabel:`Encryption Key ID` references a deleted encryption key.
  |service| cannot restore a snapshot whose 
  encryption key was deleted. 

For complete documentation on configuring Encryption at Rest,
see :doc:`/security-kms-encryption`. You can either
:ref:`deploy <create-cluster-enable-encryption>` a cluster with
Encryption at Rest, or
:ref:`enable Encryption at Rest <scale-cluster-enable-encryption>`
in an existing cluster.

View Status of Snapshot Restorations
------------------------------------

|service| provides a detailed list of completed and in-progress
snapshot restorations, including when |service| took the snapshot and
the snapshot's delivery type. To view this list, from a cluster's
:guilabel:`Backup` tab, click the :guilabel:`Restore History` tab.

The :guilabel:`Status` column of the table displays the results of
completed snapshots, and the progress of snapshots currently
being restored.

- For manually downloaded snapshots, the :guilabel:`Status` column
  displays progress while |service| prepares the download link. Once
  the download is ready, the column displays the link to download the
  snapshot.

- For automated restores, the :guilabel:`Status` column updates as the
  restoration progresses on each node in the cluster. When the
  restoration completes, the column displays the time of
  completion and the cluster to which |service| restored the
  snapshot.
