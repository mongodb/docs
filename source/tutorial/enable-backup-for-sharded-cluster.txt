.. _tutorial-enable-backup-for-sharded-cluster:

=====================================
Activate Backup for a Sharded Cluster
=====================================

.. default-domain:: mongodb

Overview
--------

You can start, restart, stop, and terminate backups for a :term:`sharded cluster`.
As appropriate, you also can specify which instance to use for the initial
sync, exclude namespaces, authenticate, and change the snapshot schedule
and retention.

.. note::
   The sharded-cluster must be MongoDB version 2.4.3 or later.

Considerations
--------------

.. include:: /includes/considerations-backup-daemon-enable.rst

.. _checkpoint:

Checkpoints
+++++++++++

Checkpoints provide additional restore points between snapshots. With
checkpoints enabled, MMS Backup creates restoration points at
configurable intervals of every 15, 30 or 60 minutes between
snapshots.

To create a checkpoint, MMS Backup stops the :term:`balancer`
and inserts a token into the :term:`oplog` of each
:term:`shard` and :term:`config server` in the cluster. These
checkpoint tokens are lightweight and do not have a consequential
impact on performance or disk use.

MMS backup does not require checkpoints: by default, MMS does not
enable checkpoints.

Restoring from a checkpoint requires MMS Backup to apply the oplog of
each shard and config server to the last snapshot captured before the
checkpoint. Restoration from a checkpoint takes longer than
restoration from a snapshot.

.. _snapshot-while-balancer-enabled:

Snapshots when Balancer Cannot be Stopped
+++++++++++++++++++++++++++++++++++++++++

In normal operation, MMS disables the :term:`balancer` before taking a
cluster snapshot. In certain situations, such as a long migration or an
unreachable shard, MMS tries to disable the balancer but cannot. In such
cases, MMS will continue to take cluster snapshots but will flag the
snapshots with a warning that data might be inconsistent. Cluster
snapshots taken while balancing is enabled run the risk of data loss or
orphaned data.

Prerequisites
-------------

Before enabling backup, ensure that the following is true for all replica
sets that you back up:

- MMS Monitoring is actively collecting data from your cluster, including
  from at least one :program:`mongos`.

- All the cluster's :term:`config servers <config server>` are
  running, and the balancing round has completed within the last hour.

- There is an active :term:`primary`.

- If you explicitly select a sync target, ensure that the sync target is
  accessible on the network and keeping up with replication.

Procedure
---------

.. include:: /includes/steps/backup-activate-sharded-cluster.rst

Your Backup Agent will start polling the specified
instance for this sharded cluster.
