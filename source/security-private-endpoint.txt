.. _private-endpoint:

===============================================
Set up a Private Endpoint for Dedicated Cluster
===============================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/serverless-preview-dont-use.rst

MongoDB |service| supports private endpoints on: 

- |aws| using the `{+aws-pl+} <https://aws.amazon.com/privatelink/>`__
  feature,

- |azure| using the `{+az-pl+}
  <https://azure.microsoft.com/en-us/services/private-link/>`__ feature, and

- |gcp| using the `{+gcp-psc+} <https://cloud.google.com/vpc/docs/private-service-connect>`__ 
  feature.

.. note:: 

   You can set up private endpoints for your Online Archive. To learn 
   more, see :ref:`oa-config-private-endpoint`.

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      When you enable this feature, |service| creates its own |vpc| and
      places clusters within a region behind a network load balancer in
      the |service| |vpc|.

      Then you create resources that establish a one-way connection
      from your |vpc| to the network load balancer in the |service|
      |vpc| using a private endpoint.

      .. tabs::

         .. tab:: {+aws-pl+}
            :tabid: aws-pl-diagram

            .. figure:: /images/atlas-aws-privatelink.svg
               :width: 720px
               :alt: Image showing how {+aws-pl+} establishes connections from
                     your application VPC to resources in the |service| VPC.

         .. tab:: {+aws-pl+} with Direct Connect
            :tabid: aws-pl-directconnect-diagram

            .. figure:: /images/atlas-aws-privatelink-directconnect.svg
               :width: 720px
               :alt: Image showing how can use |aws| Direct Connect to establish a transitive connection from your data center to a peered |aws| VPC to resources in the |service| VPC using |aws| Direct Connect.

      Connections to |service| clusters using private endpoints offer
      the following advantages over other network access management
      options:

      - Connections using private endpoints are one-way. |service|
        |vpc|\s can't initiate connections back to your |vpc|\s. This
        ensures your perceived network trust boundary is not extended.

      - Connections to private endpoints within your |vpc| can be made
        transitively from:

        - Another |vpc| peered to the private endpoint-connected |vpc|.
        - An on-premises data center connected with `DirectConnect 
          <https://docs.aws.amazon.com/whitepapers/latest/aws-vpc-connectivity-options/aws-direct-connect.html>`__
          to the private endpoint-connected |vpc|. This enables you to
          connect to |service| directly from your on-premises data 
          center without adding public IP addresses to the |service| 
          :doc:`IP access list </security/ip-access-list>`.

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      When you enable this feature, |service| creates a Private Link
      service and places clusters within a region behind a load
      balancer in the |service| VNet.

      Then you create resources that establish a one-way connection
      from your VNet to the :azure:`Private Link service
      </private-link/private-link-service-overview>` in the |service|
      VNet using a private endpoint. The Private Link service routes
      traffic to the load balancer that fronts the clusters in the
      |service| VNet.

      Connections to |service| clusters using private endpoints offer
      the following advantages over other network access management
      options:

      - Connections using private endpoints are one-way. |service|
        VNets can't initiate connections back to your VNets. This
        ensures your perceived network trust boundary is not extended.

      - Connections to private endpoints within your VNet can be made
        transitively from:

        - Another VNet peered to the private endpoint-connected VNet.
        - An on-premises data center connected with
          `ExpressRoute <https://azure.microsoft.com/en-us/services/expressroute/>`__
          to the private endpoint-connected VNet. This enables you to
          connect to |service| directly from your on-premises data
          center without adding public IP addresses to the |service|
          :doc:`IP access list </security/ip-access-list>`.

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      When you enable this feature, |service| creates a private endpoint
      service using :gcp:`service
      attachments </vpc/docs/private-service-connect#service-attachments>`
      and load balancers.
      
      Next, you create resources that establish a one-way connection from your
      |vpc| to the private endpoint service in |service| using a private
      endpoint. The private endpoint service routes traffic to the load
      balancers for the {+clusters+} in the |service| |vpc|.

      To ensure the availability of resources for both current and future
      {+clusters+}, |service| performs the following actions when you enable
      this feature:

      .. include:: /includes/gcp-psc-connection-workflow.rst

      Connections to |service| clusters using private endpoints offer
      the following advantages over other network access management
      options:

      - Connections to private endpoints are one-way. |service| |vpc|\s can't initiate 
        connections back to your |gcp| |vpc|\s. This ensures your perceived network 
        trust boundary is not extended. 
      - You can connect to private endpoints within your |vpc| transitively from
        an on-premises data center connected with Google Cloud VPN to the
        private endpoint-connected |vpc|. This enables you to connect to |service|
        directly from your on-premises data center without adding public IP
        addresses to the |service| access list.

Considerations
--------------

High Availability
~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      To ensure private endpoint connections to |service| can withstand
      an availability zone outage, you should deploy subnets to
      multiple availability zones in a region.

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      |azure| private endpoints are regional components. You don't need
      to take additional actions to ensure that private endpoint
      connections to |service| can withstand an availability zone
      outage.

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      You don't need to take additional actions to ensure that |gcp| private 
      endpoint connections to |service| can withstand an availability zone
      outage.

.. _private-endpoint-connection-strings:

Port Ranges Used for Private Endpoints
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. _private-endpoint-port-ranges:

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      By default, 
      {+aws-pl+} supports 50 addressable targets, 
      from port 1024 to port 1073.

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      By default, 
      {+az-pl+} supports 150 addressable targets, 
      from port 1024 to port 1173.
   
   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      |service| services are accessed through 
      {+gcp-psc+} endpoints on ports 27015 through 27017.

Private Endpoint-Aware Connection Strings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      .. include:: /includes/aws-pl-connection-strings.rst

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      .. include:: /includes/az-pl-connection-strings.rst

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      .. include:: /includes/gcp-psc-connection-strings.rst

.. seealso::

   :ref:`Connect to Atlas using a Private Endpoint <connect-private-endpoint>`

IP Access Lists and Network Peering Connections with Private Endpoints
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When you enable private endpoints, you can still enable access to your
|service| clusters using other methods, such as adding public IPs to
:doc:`IP access lists </security/ip-access-list>` and
:doc:`network peering </security-vpc-peering>`.

Clients connecting to |service| clusters using other methods use
standard connection strings. Your clients might have to identify when
to use private endpoint-aware connection strings and standard
connection strings.

.. _atlas_regionalized-pl:

Regionalized Private Endpoints for Multi-Region Sharded Clusters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For multi-region and global sharded clusters, you can deploy multiple
private endpoints to a region if you need to connect to |service| using
a private endpoint from networks that can't be peered with one another.

You can deploy any number of private endpoints to regions that you
deployed your cluster to. Each regional private endpoint connects to the
|mongos| instances in that region.

.. include:: /includes/admonitions/warnings/regionalized-pls-change-connection-strings.rst

.. include:: /includes/enable-regionalized-privatelink.rst

To use this feature, you must enable the regionalized private endpoint
setting:

.. include:: /includes/steps/enable-regionalized-private-endpoints.rst

.. _atlas-pl-limitations:

Limitations
-----------

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      - You can use {+aws-pl+} to connect to |service| clusters running
        MongoDB version 3.6 or later.

      - {+aws-pl+} must be active in all regions into which you deploy
        a multi-region cluster. You will receive an error if {+aws-pl+}
        is active in some, but not all, targeted regions. If you have a 
        multi-cloud cluster in |aws| or |azure|, you must provision an 
        endpoint in each provider or region. 

      - You can do only one of the following:

        - Create more than one private endpoint in a single region, or
        - Create no more than one private endpoint per region, if nodes 
          are deployed in more than one region.

          .. important::

             This limitation applies across cloud providers. For
             example, if you create more than one private endpoint in a
             single region in |aws|, you can't create private endpoints
             in more than one region in |azure|.

        See :ref:`atlas_regionalized-pl` for an exception for
        multi-region and global sharded clusters.

      - If this is the first private endpoint that you deploy to a   
        region, you must first resume any paused clusters in your
        project with nodes deployed to that region.

        This limitation doesn't apply for additional private endpoints
        that you deploy to the same region.

      - To connect to |service| clusters using {+aws-pl+} from regions
        in which you haven't deployed a private endpoint connection,
        you must peer |vpc|\s in those regions to |vpc|\s in a region
        in which you have deployed a private endpoint connection.

        To learn about inter-region |vpc| peering, see the `AWS
        documentation
        <https://aws.amazon.com/answers/networking/aws-multiple-region-multi-vpc-connectivity/>`__.

      - You can use {+aws-pl+} in |service| projects with up to 50
        addressable targets **per region**. If you need more than 50
        addressable targets in a region:

        - Contact :ref:`MongoDB Support <request-support>`, or 
        - Use additional projects or regions to connect to addressable
          targets beyond this limit.

        Addressable targets include:

        - Each |mongod| instance in a replica set deployment (sharded 
          clusters excluded).
        - Each |mongos| instance in a sharded cluster deployment.
        - Each |bic| instance across all dedicated clusters in the
          project.

        .. note::

           To request a one-time increase to use {+aws-pl+} with up to
           100 addressable targets per |service| project, contact
           :ref:`MongoDB Support <request-support>`.

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      - You can use {+az-pl+} to connect to |service| clusters that run
        MongoDB version 3.6 or later.

        .. include:: /includes/fact-privatelink-azure-az-limitations.rst

      - {+az-pl+} must be active in all regions into which you deploy a
        multi-region cluster. You will receive an error if {+az-pl+} is
        active in some, but not all, targeted regions. If you have a 
        multi-cloud cluster in |aws| or |azure|, you must provision an 
        endpoint in each provider or region. 

      - You can do only one of the following:

        - Create more than one private endpoints in a single region, or
        - Create no more than one private endpoint per region, if nodes 
          are deployed in more than one region.

          .. important::

             This limitation applies across cloud providers. For
             example, if you create more than one private endpoint in a
             single region in |azure|, you can't create private
             endpoints in more than one region in |aws|.

        See :ref:`atlas_regionalized-pl` for an exception for
        multi-region and global sharded clusters.

      - If this is the first private endpoint that you deploy to a   
        region, you must first resume any paused clusters in your
        project with nodes deployed to that region.

        This limitation doesn't apply for additional private endpoints
        that you deploy to the same region.

      - To connect to |service| clusters using {+az-pl+} from regions
        in which you haven't deployed a private endpoint connection,
        you must peer VNets in those regions to VNets in a region in
        which you have deployed a private endpoint connection.

        To learn about Global VNet peering, see the
        :azure:`Azure documentation </virtual-network/virtual-networks-faq#can-i-create-a-peering-connection-to-a-vnet-in-a-different-region>`.

      - You can use {+az-pl+} in |service| projects with up to 150
        addressable targets **per region**. If you need more than 150
        addressable targets in a region:

        - Contact :ref:`MongoDB Support <request-support>`, or 
        - Use additional projects or regions to connect to addressable
          targets beyond this limit.

        Addressable targets include:

        - Each |mongod| instance in a replica set deployment (sharded 
          clusters excluded).
        - Each |mongos| instance in a sharded cluster deployment.
        - Each |bic| instance across all dedicated clusters in the
          project.

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      - You can use {+gcp-psc+} to connect to |service| clusters that
        run MongoDB version 4.0 or later.

      - {+gcp-psc+} must be active in all regions into which you deploy
        a multi-region cluster. You will receive an error if
        {+gcp-psc+} is active in some, but not all, targeted regions.

      - You can do only one of the following:

        - Create more than one group of private endpoints in a single
          region, or
        - Create one group of private endpoints in multiple regions.

          .. important::

             This limitation applies across cloud providers. For
             example, if you create more than one private endpoint in a
             single region in |gcp|, you can't create private
             endpoints in more than one region in |aws|.

        See :ref:`atlas_regionalized-pl` for an exception for
        multi-region and global sharded clusters.

      - If this is the first private endpoint that you deploy to a   
        region, you must first resume any paused clusters in your
        project with nodes deployed to that region.

        This limitation doesn't apply for additional private endpoints
        that you deploy to the same region.

      - You can use {+gcp-psc+} in |service| projects with up to 50
        nodes **per region**. If you need more than 50 nodes in a
        region:

        - Contact :ref:`MongoDB Support <request-support>`, or 
        - Use additional projects or regions to connect to nodes beyond
          this limit.

        .. note::

           Each private endpoint in |gcp| reserves an IP address within
           your |gcp| |vpc| and forwards traffic from the endpoints' IP
           addresses to the
           :gcp:`service attachments </vpc/docs/private-service-connect#service-attachments>`.
           You must create an equal number of private endpoints to the
           number of service attachments. The number of service
           attachments defaults to 50.

        .. note::

           To request a one-time increase to use {+gcp-psc+} with up to
           250 nodes per |service| project, contact
           :ref:`MongoDB Support <request-support>`.

      - |gcp| {+google-psc+} supports up to 1024 outgoing connections
        per virtual machine. As a result, you can't have more than 1024
        connections from a single |gcp| virtual machine to an |service|
        cluster.

        To learn more, see the |gcp|
        :gcp:`cloud NAT documentation </nat/docs/ports-and-addresses>`.

      - |gcp| {+google-psc+} is region-specific. You cannot use |vpc|
        peering to access private endpoints from a different |vpc|.

        When using {+google-psc+} to connect to multi-region
        {+clusters+}, you can connect only to {+cluster+} nodes that
        are in the same region as the private endpoint. If the endpoint
        and the primary node are in different regions, you must:

        1. Set your application's
           :manual:`read preference </core/read-preference/>`
           to allow connections from a secondary node.

           For example, you can set your application's read preference
           to :manual:`secondaryPreferred </core/read-preference/#mongodb-readmode-secondaryPreferred>`.

        2. Ensure at least one secondary node is in the same region as
           the endpoint. 

Prerequisites
-------------

To enable connections to |service| using private endpoints, you must:

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      1. Have either the :authrole:`Project Owner` or
         :authrole:`Organization Owner` role in |service|.

      #. Have an |aws| user account with an |iam| user policy that
         grants permissions to create, modify, describe, and delete
         endpoints. For more information on controlling the use of
         interface endpoints, see the
         :aws:`AWS Documentation </vpc/latest/userguide/vpc-endpoints.html>`.

      #. **(Recommended)**:
         :aws:`Install the AWS CLI </cli/latest/userguide/cli-chap-install.html>`.

      #. If you have not already done so, create your |vpc| and EC2
         instances in |aws|. See the :aws:`AWS documentation
         </index.html>` for guidance.

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      1. Have either the :authrole:`Project Owner` or
         :authrole:`Organization Owner` role in |service|.

      #. :azure:`Install the Azure CLI <https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>`.

      #. If you have not already done so, create your VNet and Compute
         instances in |azure|. See the :azure:`Azure documentation </>`
         for guidance.

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      1. Have either the :authrole:`Project Owner` or
         :authrole:`Organization Owner` role in |service|.

      #. Have a |gcp| user account with an |iam| user policy and a 
         :gcp:`Compute Network Admin </iam/docs/understanding-roles#compute.networkAdmin>`
         role that grants permissions to create, modify, and delete networking 
         resources. For more information on managing private endpoints
         and connections, see the
         :gcp:`GCP documentation </vpc/docs/overview.html>`.

      #. :gcp:`Install gcloud CLI </sdk/docs/install>`.

      #. If you have not already done so, create your |vpc| and Compute
         instances in |gcp|. See the :gcp:`GCP documentation
         </vpc/docs/using-vpc.html>` for guidance.

      #. Make sure egress firewall rules permit traffic to the internal
         IP address of the {+gcp-psc+} endpoint. 

.. I can't find a page in the azure documentation where specific policy
   requirements are described for private endpoints. Do we need to
   include that information here?

Procedures
----------

.. _atlas-configure-private-endpoint:

Configure an |service| Private Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Enable clients to connect to |service| clusters using private endpoints
with the following procedure:

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      .. include:: /includes/steps/configure-privatelink-aws.rst

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      .. include:: /includes/steps/configure-privatelink-azure.rst

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      .. include:: /includes/steps/configure-privateserviceconnect-gcp.rst

.. _connect-private-endpoint:
.. _atlas-connect-private-endpoint:

Connect to |service| using a Private Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. note::

   For important considerations about private endpoint-aware connection
   strings, see
   :ref:`Private Endpoint-Aware Connection Strings <private-endpoint-connection-strings>`.

Use a private endpoint-aware connection string to connect to an
|service| cluster with the following procedure:

.. include:: /includes/steps/connect-to-database-deployment-privatelink.rst

Remove a Private Endpoint from |service|
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      .. include:: /includes/steps/delete-privatelink-aws.rst

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      .. include:: /includes/steps/delete-privatelink-azure.rst

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      .. include:: /includes/steps/delete-privateserviceconnect-gcp.rst 

.. _pl-troubleshooting:
.. _atlas-troubleshoot-private-endpoint:

Troubleshoot Private Endpoint Connection Issues
-----------------------------------------------

.. tabs::

   .. tab:: {+aws-pl+}
      :tabid: {+aws-pl+}

      .. include:: /includes/steps/troubleshoot-privatelink-aws.rst

   .. tab:: {+az-pl+}
      :tabid: {+az-pl+}

      .. include:: /includes/fact-private-endpoint-status-intro.rst

      :guilabel:`Atlas Endpoint Service Status`

      .. list-table::
         :widths: 30 70
         :header-rows: 1

         * - Status
           - Description

         * - Creating private link
           - |service| is creating the load balancer and VNet
             resources.

         * - Failed
           - A system failure has occurred.

         * - Ready for connection requests
           - |service| created the load balancer and {+az-pl+} Service.
             The {+az-pl+} Service is ready to receive connection
             requests.

         * - Deleting
           - |service| is deleting the {+az-pl+} Service.

      :guilabel:`Endpoint Status`

      .. list-table::
         :widths: 30 70
         :header-rows: 1

         * - Status
           - Description

         * - Not configured
           - |service| created the load balancer and {+az-pl+} Service,
             but you haven't created a private endpoint yet.
             Click :guilabel:`Edit` and complete the wizard to create
             the private endpoint.

         * - Initiating
           - |service| has not yet accepted the connection to your
             private endpoint.

         * - Failed
           - |azure| failed to establish a connection between |service|
             VNet resources and the private endpoint in your VNet.
             Click :guilabel:`Edit`, verify that the information you
             provided is correct, and then create the private endpoint
             again.

         * - Available
           - |service| VNet resources are connected to the private
             endpoint in your VNet. You can connect to |service|
             clusters in this region using {+az-pl+}.

         * - Deleting
           - |service| is removing the private endpoint connection from
             the {+az-pl+} Service.

   .. tab:: {+gcp-psc+}
      :tabid: {+gcp-psc+}

      .. include:: /includes/troubleshoot-privateserviceconnect-gcp.rst
