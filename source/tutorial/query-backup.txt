=======================
Query a Backup Snapshot
=======================

.. default-domain:: mongodb

|mms| provides queryable backups. This functionality allows you to
query specific backup snapshot. You can use the queryable backups to:

- Restore a subset of data within the MongoDB deployment.

- Compare previous versions of data against the current data.

- Identify the best point in time to restore a system by comparing data
  from multiple snapshots.


Considerations
--------------

Read-Only Instance
~~~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/queryable-backup-duration.rst

Query Restrictions on the Queryable Snapshots
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You cannot run:

- :manual:`Map-reduce operations </core/map-reduce>`.

- Queries that requires disk usage, such as 
  :manual:`running aggregation </reference/method/db.collection.aggregate>` 
  with the ``allowDiskUse`` option to perform large sort
  operations.

- Queries on compression-enabled :term:`file system stores <file system store>`.  
  If snapshots are :ref:`compressed <add-filestore>`, the restore cannot 
  query the contents of the snapshot.

Connection Methods
~~~~~~~~~~~~~~~~~~

Connections to these instances are over 
:abbr:`TLS (Transport Layer Security)`/:abbr:`SSL (Secure Sockets Layer)` 
and require a X.509 authentication. |mms| provides:

- An executable that creates a :ref:`tunnel <query-via-tunnel>` which
  handles the connection, including the client 
  :abbr:`TLS (Transport Layer Security)`/:abbr:`SSL (Secure Sockets Layer)` 
  and the X.509 authentication.

  .. only:: onprem

     Requests are routed through the tunnel. The tunnel ensures the
     request is speaking to the correct :program:`mongod` instance.

- X.509 certificates if you want to handle the connection details
  manually, including the 
  :abbr:`TLS (Transport Layer Security)`/:abbr:`SSL (Secure Sockets Layer)` 
  and the X.509 authentication.

  .. only:: onprem

     Requests come in through the web server, which acts as a proxy to
     the :program:`mongod`.

Prerequisites
~~~~~~~~~~~~~~

.. include:: /includes/extracts/queryable-backup-prerequisites.rst

.. _query-via-tunnel:

Query Backup (Use Tunnel to Connect)
------------------------------------

.. note::

   The tunnel handles the security 
   (:abbr:`TLS (Transport Layer Security)`/:abbr:`SSL (Secure Sockets Layer)` 
   and X.509 authentication) for connecting to the instance.

.. include:: /includes/steps/query-backup-tunnel.rst

.. tip::

   Once you have finished querying this snapshot, you can terminate the
   queryable instance:

   #. Go to the :guilabel:`Restore History` and hover over the
      :guilabel:`Status` column for the deployment item.

   #. Click :guilabel:`Cancel`.

.. _query-via-manual-connection:

Query Backup (Handle :abbr:`TLS (Transport Layer Security)` :abbr:`and (Secure Sockets Layer)` Authentication Manually)
-----------------------------------------------------

.. note:: 

  .. include:: /includes/extracts/queryable-backup-certificate-duration.rst 

.. include:: /includes/steps/query-backup-manual.rst

.. tip::

   Once you have finished querying this snapshot, you can terminate the
   queryable instance:

   #. Go to the :guilabel:`Restore History` and hover over the
      :guilabel:`Status` column for the deployment item.

   #. Click :guilabel:`Cancel`.

Next Steps
----------

To restore a database or a collection using the queryable backup
MongoDB instance, see :ref:`restore-from-queryable-backup`.
