.. _restoration-cloud-provider-snapshot:

====================================
Restore Your {+Database-Deployment+}
====================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Restore a {+Cluster+} from a {+Cloud-Backup+}
---------------------------------------------

.. include:: /includes/fact-atlas-free-tier-only-limits.rst

|service| lets you restore data from a scheduled {+Cloud-Backup+}.

.. include:: /includes/admonitions/notes/backup-restore-roles.rst

.. seealso::

   - To learn more about {+Cloud-Backup+}, see
     :doc:`/backup/cloud-backup/overview`.

   - To learn how to restore data from a
     :doc:`{+old-backup+} snapshot </backup/legacy-backup/overview>`,
     see :doc:`/backup/legacy-backup/restore`.

Restore Restrictions
~~~~~~~~~~~~~~~~~~~~

- The target cluster must run the same or the next major release 
  version of MongoDB as the snapshot MongoDB version.

  .. example::

     You can restore a MongoDB 4.2 snapshot to an |service| cluster running MongoDB 4.4.
     If you try to restore a MongoDB 4.2 snapshot to an |service| cluster running MongoDB 5.0,
     you receive the following error:

     .. code-block:: none

        Error: The requested restore could not be started: The source and destination 
        mongoDB versions are incompatible.

- The source and target sharded cluster must have the same number of 
  shards.

- |service| can only restore to a :term:`replica set` or
  :term:`sharded cluster` that uses the same encryption provider as
  the source snapshot cluster.

- |service| can't restore a sharded cluster snapshot to a replica set.

.. _cps-failback-snapshots:

Fallback Snapshots
~~~~~~~~~~~~~~~~~~

If a scheduled snapshot fails for any reason, |service| attempts to
repeat the snapshot process. If necessary, you may use the resulting
fallback snapshot to :ref:`restore the cluster
<restoration-cloud-provider-snapshot>`. This isn't recommended:
fallback snapshots use a different process from regular snapshots. They
may contain inconsistent data.

Fallback snapshots are marked in the UI with a warning icon, and a
warning message appears in the restore modal window if the restore uses
a fallback snapshot.

.. warning::

   Restoring your cluster from a fallback snapshot may result in
   inconsistent data across your cluster, and should be considered an
   option of last resort.

Prerequisites
~~~~~~~~~~~~~

Stop Client Operations during Restoration
`````````````````````````````````````````

.. include:: /includes/fact-stop-ops-during-restore.rst

Procedure
~~~~~~~~~

.. important:: Restoring Snapshots for Clusters using Encryption at Rest

   |service| automatically encrypts
   :ref:`{+Cloud-Backup+}s <backup-cloud-provider>` for
   clusters using :doc:`/security-kms-encryption`, in addition to the
   existing encryption applied to all |service| storage and snapshot
   volumes. For documentation on restoring an encrypted snapshot, see
   :ref:`restore-encrypted-snapshot`

   The following instructions only apply to snapshots for
   clusters not using Encryption at Rest.

.. tabs::

   .. tab:: Snapshot Restore
      :tabid: snapshot-restore

      #. Click :guilabel:`Databases` in the top-left corner of |service|.

      #. From the :guilabel:`{+Database-Deployments+}` view, click on the cluster name.

      #. Click the :guilabel:`Backup` tab.

         If the cluster has no :guilabel:`Backup` tab, then |service| backups
         are disabled for that cluster and no snapshots are available.
         You can enable backups when
         :ref:`scaling the cluster <scale-cluster-backups>`.

      #. Select a cluster's snapshot to restore.

         Click :guilabel:`Restore` or :guilabel:`Download`.

      #. Follow the prompts to restore your cluster. You may choose to:

         - :ref:`Download your snapshot via HTTPS <restore-cloud-provider-snapshot-download>`.

         - :ref:`Restore your snapshot to an Atlas cluster <restore-cloud-provider-snapshot-atlas>`.

   .. tab:: {+PIT-Restore+}
      :tabid: pit-restore

      You can enable {+PIT-Restore+}s when you :ref:`create
      <create-new-cluster>` or :ref:`scale <scale-cluster-backups>` a
      cluster.

      #. Click :guilabel:`Databases` in the top-left corner of |service|.

      #. From the :guilabel:`{+Database-Deployments+}` view, click on the cluster name.

      #. Click the :guilabel:`Backup` tab.

         If the cluster has no :guilabel:`Backup` tab, then |service|
         backups are disabled for that cluster and no snapshots are
         available. You can enable backups when
         :ref:`scaling the cluster <scale-cluster-backups>`.

      #. Click the :guilabel:`Point in Time Restore` button on the far
         right side of the screen.

      #. Select either the :guilabel:`Date & Time` or :guilabel:`Oplog
         Timestamp` tab.

         .. note::

            If you select the :guilabel:`Date & Time` option, you can
            specify the time of restore with one minute of granularity.
            If you select the :guilabel:`Oplog Timestamp` option, you
            can specify the time of restore with one second of
            granularity.

      #. Enter the desired point in time to restore from.

         .. important::

            You can restore a {+cluster+} from any time during its 
            {+pit-restore+} window **except** between when you 
            initiated a restore and when |service| completes a 
            snapshot after the restore.

      #. Click the :guilabel:`Next: Select Cluster` button.

      #. Choose a project and cluster to restore to from the dropdown
         menus.

         .. important::

            |service| might create a host rollback alert due to
            differences in the data between the source and target
            clusters. You can ignore this alert.

      #. Click the :guilabel:`Restore` button.

      After the restore completes, |service| takes a snapshot of
      the restored {+cluster+}. This snapshot has a retention period
      equal to the {+cluster+}'s {+pit-restore+} window.

.. _restore-cloud-provider-snapshot-atlas:

Restore your Snapshot to an Atlas Cluster
`````````````````````````````````````````

.. include:: /includes/fact-restore-cluster-downtime-warning.rst

1. Click :guilabel:`Restore` in the :guilabel:`Actions` column
   for the snapshot you want to restore.

#. From the :guilabel:`Restore` dialog, select the target cluster to
   which you want to restore.

   .. note::

      To optimize performance and reduce the amount of time it takes to
      restore, use these tips:

      - Select a target cluster that isn't a global, multi-region, or
        multi-cloud cluster.
      - Select a target cluster that belongs to the same |service|
        project and the same cloud provider region as the snapshot.
      - Select a cluster tier with the same storage capacity as the
        capacity of the original volume used by the source cluster.
      - If the target cluster runs on |aws| with configured |iops|,
        select the configured |iops| to fall within the valid range.
      - Select a tier that hasn't been configured to use |nvme| storage.
        The tier can support |nvme| storage, but if you enable |nvme|,
        restore performance degrades.

#. Click :guilabel:`Restore`.

#. Restart your application and ensure it uses the new target cluster.

.. _restore-encrypted-snapshot:

Restore a Snapshot of a Cluster with Encryption at Rest
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. important::

   Snapshots of clusters using
   :doc:`Encryption at Rest using your Key Management </security-kms-encryption>`
   can only restore to other clusters that use Encryption at Rest. You
   cannot restore a snapshot with Encryption at Rest to a |mms|
   project.

   If the target project does not have a cluster with Encryption at
   Rest enabled, you can either
   :ref:`deploy <create-cluster-enable-encryption>` a cluster with
   Encryption at Rest, or
   :ref:`enable Encryption at Rest <scale-cluster-enable-encryption>`
   in an existing cluster.

   Clusters which use :ref:`AWS KMS <security-aws-kms>` encrypt their
   |pit| restore :term:`oplog` data with the customer's |cmk|. The
   current |cmk| must be valid for the encrypted oplog data to perform
   a restore from a snapshot.

#. Click :guilabel:`Databases` in the top-left corner of |service|.

#. From the :guilabel:`{+Database-Deployments+}` view, click on the cluster name.

#. Click the :guilabel:`Backup` tab.

   If the cluster has no :guilabel:`Backup` tab, then |service| backups
   are disabled for that cluster and no snapshots are available.
   You can enable backups when
   :ref:`modifying the cluster <scale-cluster-backups>`.

#. Click :guilabel:`Restore` in the :guilabel:`Actions` column
   for the snapshot you want to restore.

#. From the :guilabel:`Restore` dialog, select the target |service|
   :guilabel:`Project` to which you want to restore. You can restore to
   any |service| project for which the authenticated |service| user has
   the :authrole:`Project Owner` role.

#. Select the :guilabel:`Cluster` to restore to. You can only restore
   to an |service| replica set running Encryption at Rest. The target
   cluster must run the same or greater version of MongoDB as the
   :guilabel:`MongoDB Version` of the snapshot.


   After the restoration procedure, |service| triggers a key rotation
   for MongoDB encryption key. |service| then encrypts the new MongoDB
   encryption keys based on the configured Encryption at Rest provider
   for the target cluster.

#. Restart your application and ensure it uses the new target
   cluster.

Troubleshooting Encryption at Rest
``````````````````````````````````

If |service| has an issue with the encryption of either the snapshot
or the target cluster, it displays one of the following errors:

.. list-table::
   :widths: 40 60
   :stub-columns: 1
   :header-rows: 1

   * - Error

     - Result

   * - Cannot restore a non-encrypted snapshot to a cluster with
       Encryption at Rest enabled.

     - The snapshot cannot be restored to |service|.

   * - Target cluster does not have encryption enabled.

     - You can either :ref:`deploy <create-cluster-enable-encryption>`
       a new target cluster with Encryption at Rest, or
       :ref:`enable Encryption at Rest <scale-cluster-enable-encryption>`
       on your desired target cluster.

   * - Encryption provider of target cluster does not match selected
       snapshot's encryption provider.

     - The encryption provider for the snapshot and target cluster
       do not match. You can either:

       1. Create a new snapshot with the same encryption provider.
       #. Change the encryption provider for the target cluster.

   * - Encryption credentials on snapshot are not present.

     - |service| cannot restore a snapshot whose encryption key was
       deleted.

View Status of Snapshot Restorations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

|service| provides a detailed list of completed and in-progress
snapshot restorations, including when |service| took the snapshot and
the snapshot's delivery type. To view this list, from a cluster's
:guilabel:`Backup` tab, click the :guilabel:`Restores & Downloads` tab.

The :guilabel:`Status` column of the table displays the results of
completed snapshots, and the progress of snapshots currently
being restored.

- For manually downloaded snapshots, the :guilabel:`Status` column
  displays progress while |service| prepares the download link. Once
  the download is ready, the column displays the link to download the
  snapshot.

- For automated restores and {+PIT-Restore+} restores, the
  :guilabel:`Status` column updates as the restoration progresses on
  each node in the cluster. When the restoration completes, the column
  displays the time of completion and the cluster to which |service|
  restored the snapshot.


.. _m2-m5-restore-snapshot:

Restore a {+Cluster+} from an M2/M5 Snapshot
--------------------------------------------

|service| lets you restore data from an
:ref:`M2 or M5 {+cluster+} snapshot <m2-m5-snapshots>`. You can restore
``M2`` and ``M5`` snapshots to a {+cluster+} tier ``M2`` or greater.

.. include:: /includes/admonitions/notes/backup-restore-roles.rst

Restore Restrictions
~~~~~~~~~~~~~~~~~~~~

- |service| can restore ``M2`` and ``M5`` snapshots only to a
  :term:`replica set` that does *not* use
  :doc:`Encryption at Rest </security-aws-kms>`.

- The target {+cluster+} must run the same major release version of
  MongoDB as the snapshot MongoDB version. For example, you can
  restore a snapshot using MongoDB 4.0 only to a target {+cluster+} 
  running MongoDB 4.0.

- Starting with MongoDB 5.0, you can restore snapshots of {+clusters+}
  that run only the two most recent major versions of MongoDB to
  ``M2`` and ``M5`` {+clusters+}.

  .. example::

     - You can restore snapshots taken from {+clusters+} that run 
       MongoDB 4.2 to an ``M2`` or ``M5`` {+cluster+} that runs MongoDB
       5.0. 
     - You can't restore snapshots taken from {+clusters+} that run
       MongoDB 4.0 to an ``M2`` or ``M5`` {+cluster+} that runs MongoDB 5.0.

Prerequisites
~~~~~~~~~~~~~

1. .. include:: /includes/fact-stop-ops-during-restore.rst

2. To :ref:`download your snapshot via HTTPS 
   <restore-cloud-provider-snapshot-download>`,
   you must add the |ipaddr| or |cidr| addresses of the client
   downloading the snapshot to your |service|
   :ref:`project access list <access-list>`.

Procedure
~~~~~~~~~

1. Click :guilabel:`Databases` in the top-left corner of the
   {atlas-ui+}.
   
#. From the :guilabel:`{+Database-Deployments+}` view, click the 
   {+cluster_} name.

#. Click the :guilabel:`Backup` tab.

#. Find the desired {+cluster+} snapshot to restore.

#. For the desired {+cluster+}, click :guilabel:`Restore` or
   :guilabel:`Download`.

#. Follow the prompts to restore your {+cluster+}. You may choose to 
   one of the following actions:

   - :ref:`Download your snapshot via HTTPS 
     <restore-cloud-provider-snapshot-download>`.

   - :ref:`Restore your snapshot to an Atlas {+cluster+} 
     <m2-m5-restore-project>`.

.. _m2-m5-restore-project:

Restore your Snapshot to an |service| {+Cluster+}
`````````````````````````````````````````````````

.. include:: /includes/fact-restore-cluster-downtime-warning.rst

You can restore to any |service| {+cluster+} in a project for which you
have the :authrole:`Project Owner` role.

1. In the :guilabel:`Snapshots` tab, locate the snapshot to
   restore in the :guilabel:`All Daily Snapshots` table.

#. In the :guilabel:`Actions` column of the table, click
   :guilabel:`Restore`.

#. From the :guilabel:`Restore` dialog, select the target {+cluster+} to
   restore to.

#. Click :guilabel:`Restore`.

#. Restart your application and ensure it uses the new target 
   {+cluster+}.

.. _serverless-restore-snapshot:

Restore a {+Serverless-Instance+} from a Snapshot
-------------------------------------------------

|service| lets you restore data to a {+serverless-instance+} from a
snapshot.

.. include:: /includes/admonitions/notes/backup-restore-roles.rst

To learn more, see :ref:`serverless-snapshots`.

Restore Restrictions
~~~~~~~~~~~~~~~~~~~~

- If you use :guilabel:`Basic Backup`, you can restore from only the 
  two most recent snapshots of a {+serverless-instance+}.

- If you use :guilabel:`Serverless Continuous Backup`, you can restore
  your data to a selected point in time using only 
  :guilabel:`Date & Time`. 

- You can't restore snapshots from {+shared-clusters+}, 
  {+dedicated-clusters+}, or from |mms| to {+serverless-instances+}.

Prerequisites
~~~~~~~~~~~~~

Stop Client Operations during Restoration
`````````````````````````````````````````

You must ensure that the target {+serverless-instance+} doesn't receive
client requests during restoration. You can restore to a new
{+serverless-instance+} and reconfigure your application to use that 
new {+serverless-instance+} once it is running for maximum uptime.

.. important::

   |service| disables database users on a target {+serverless-instance+}
   during a restore to prevent the target from receiving client
   requests.

Procedure
~~~~~~~~~

.. warning::

   |service| deletes all existing data on the target 
   {+serverless-instance+} prior to the restore. The 
   {+serverless-instance+} is **unavailable** for the duration of
   the restore.

Restore a {+Database-Deployment+} from a {+Serverless-Instance+} Snapshot
`````````````````````````````````````````````````````````````````

Follow these steps to restore a {+database-deployment+} from a 
{+serverless-instance+} snapshot.

.. tabs::

   .. tab:: Snapshot Restore
      :tabid: snapshot-restore

      1. Click :guilabel:`Databases` in the top-left corner of the
         {+atlas-ui+}.

      #. From the :guilabel:`{+Database-Deployments+}` view, click your 
         {+serverless-instance+}.

      #. Click the :guilabel:`Backup` tab.

      #. Select a {+serverless-instance+} snapshot to restore.

      #. Click :guilabel:`Restore`.

      #. Follow the prompts to restore your 
         :ref:`{+serverless-instance+} snapshot
         <restore-cloud-provider-snapshot-serverless>`. 

   .. tab:: {+PIT-Restore+}
      :tabid: pit-restore

      You can enable {+PIT-Restore+}s by selecting
      :guilabel:`Serverless Continuous Backup` when you 
      :ref:`create a {serverless-instance+}
      <create-new-serverless-instance>` or
      :ref:`configure {+serverless-instance+} backups
      <config-serverless-backup>`.

      1. Click :guilabel:`Databases` in the top-left corner of the
         {+atlas-ui+}.

      #. From the :guilabel:`{+Database-Deployments+}` view, click your 
         {+serverless-instance+}.

      #. Click the :guilabel:`Backup` tab.

      #. Click the :guilabel:`Point in Time Restore` button on the
         right side of the screen.

      #. Select the :guilabel:`Date & Time` from which you want to
         restore data. The date and time must be within the last 72
         hours. You can specify the time of restore with one minute
         of granularity.

         .. important::

            You can restore a {+database-deployment+} from any time
            during its {+pit-restore+} window **except** between when
            you initiated a restore and when |service| completes a 
            snapshot after the restore.

      #. Click the :guilabel:`Next: Select Cluster` button.

      #. Choose a project and {+database-deployment+} to restore to
         from the dropdown menu.

         .. important::

            |service| might create a host rollback alert due to
            differences in the data between the source and target
            {+database-deployments+}. You can ignore this alert.

      #. Click the :guilabel:`Restore` button.

.. _restore-cloud-provider-snapshot-serverless:

Restore a {+Serverless-Instance+} from a {+Cluster+} Snapshot
`````````````````````````````````````````````````````````````

1. Click :guilabel:`Restore` in the :guilabel:`Actions` column
   for the snapshot to restore.

#. From the :guilabel:`Restore` dialog, select the target 
   {+serverless-instance+} to restore to.

   .. note::
      For best possible restore performance, select a target 
      {+serverless-instance+} that belongs to one of the following 
      options:

      - The same |service| project as the snapshot.
      - The same cloud provider region as the snapshot.

#. Click :guilabel:`Restore`.

#. Restart your application and ensure it uses the new target 
   {+cluster+}.

View the Status of Snapshot Restorations
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

|service| provides a detailed list of completed and in-progress
snapshot restorations, including when |service| took the snapshot and
the snapshot's delivery type. To view this list, from a
{+serverless-instance+}'s :guilabel:`Backup` tab, click the 
:guilabel:`Restores` tab.

The :guilabel:`Status` column of the table displays the results of
completed snapshots, and the progress of snapshots currently
restoring.

The :guilabel:`Status` column updates as the restoration
progresses on the {+serverless-instance+}. When the restoration 
completes, the column displays the time of completion and the 
{+serverless-instance+} that |service| restored the snapshot to.


Manually Restore One Snapshot
-----------------------------

.. include:: /includes/fact-atlas-api-free-tier-limits.rst

|service| provides a mechanism for downloading cloud provider,
{+old-backup+}, and M2/M5 snapshots as compressed files.

.. note::

   You can't download snapshots for {+serverless-instances+}.

The downloaded files consist of the raw files copied from the ``data`` 
directory. ``mongorestore`` is incompatible with these files. To access 
the data files, use the following procedure to start a 
:binary:`~bin.mongod` instance and point it to the extract directory.

.. _restore-cloud-provider-snapshot-download:

Procedure
~~~~~~~~~

.. tabs::

   .. tab:: {+Cloud-Backup+}s
      :tabid: cloud-p-pit-restore-dl

      To learn more about this backup type, see :ref:`backup-cloud-provider`.

      Considerations
      ``````````````

      When you manually download a cloud backup snapshot, your download 
      might get interrupted for some reason. |service| keeps
      the request alive and allows you to restart it as long as the 
      most recent download failure occurred no more than one hour ago.

      .. include:: /includes/steps/manual-restore-cps.rst

   .. tab:: {+Old-Backup+}
      :tabid: cb-dl

      To learn more about this backup type, see
      :ref:`legacy-backup`.

      .. include:: /includes/steps/manual-restore-cb.rst

   .. tab:: M2/M5 {+Cluster+}
      :tabid: m2-m5-dl

      You can download a snapshot for any M2/M5 {+cluster+} in a project
      for which you have the :authrole:`Project Owner` role.

      To learn more about this backup type, see 
      :ref:`m2-m5-snapshots`.

      .. include:: /includes/steps/manual-restore-mtm.rst

Restore One Cloud Manager Snapshot to |service|
-----------------------------------------------

You can automatically restore a backup for a |mms| deployment to an 
|service| deployment. Before you restore a snapshot from a |mms| 
deployment to an |service| deployment, ensure that the hosts for 
your |service| deployment have sufficient storage space for the 
restored databases, plus additional space for dataset growth. Use 
:manual:`db.stats() </reference/method/db.stats/>`
to find the current database size.

The MongoDB server version must be one of the following:

- The same on both deployments.

- One version higher on the |service| deployment. 

Also, the instance types of the nodes in the |service| 
deployment should have at least as much memory and throughput capacity 
as the nodes in the |mms| deployment.

To learn more, see :cloudmgr:`tutorial/restore-deployment-to-atlas`.
