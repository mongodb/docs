.. _cloud-provider-backup-schedule:
.. _cloud-provider-retention-policy:
.. _cps-backup-policies:

=====================================================
Backup Scheduling, Retention, and On-Demand Snapshots
=====================================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

View Backup Policies
--------------------

.. tabs::

   .. tab:: {+atlas-cli+}
      :tabid: atlascli

      .. include:: /includes/extracts/atlas-backups-schedule-describe.rst

   .. tab:: {+atlas-ui+}
      :tabid: ui

      Use the Backup Policy Editor to configure a backup policy for 
      {+Cloud-Backup+}s.

      1. Click :guilabel:`Databases` in the top-left corner of 
         |service|.
   
      #. From the :guilabel:`{+Database-Deployments+}` view, click the cluster name.

      #. Click the :guilabel:`Backup` tab.

      #. Click :guilabel:`Backup Policy`.

A backup policy has the following sections:

- A time of day, in |utc|, at which to create snapshots.

- A frequency interval and duration of retention.

- If |pit| Restores are enabled, a |pit| window that allows you
  to restore to any point in time in the last X days where X is the window.

.. example::

   The default backup policy specifies a snapshot time of ``18:00``
   |utc| and the following four policy items:

   .. list-table::
      :widths: 15 15 20 30 20
      :header-rows: 1

      * - Policy Type
        - Tier
        - {+PIT-Restore+}
        - Snapshot Taken
        - Snapshot Retained

      * - Hourly
        - |nvme|
        - Enabled
        - Every 12 hours
        - 2 days

      * - Hourly
        - non-|nvme|
        - Enabled
        - Every 6 hours
        - 2 days

      * - Daily
        - All
        - Either
        - Every day
        - 7 days

      * - Weekly
        - All
        - Either
        - Every Saturday
        - 4 weeks

      * - Monthly
        - All
        - Either
        - Last day of the month
        - 12 months

To learn more about {+Cloud-Backup+} billing, see
:ref:`billing-backup-cloud-provider-snapshots`.

.. _changine-backup-policy-time:

Change the Backup Policy Time
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: {+atlas-cli+}
      :tabid: atlascli

      .. include:: /includes/extracts/atlas-backups-schedule-delete-and-update.rst

   .. tab:: {+atlas-ui+}
      :tabid: ui

      To modify the backup policy time:

      1. In the :guilabel:`Backup Policy Editor`, select the hour 
         which |service| takes a snapshot each day from :guilabel:`hr`
         beneath :guilabel:`Snapshot Time (UTC)`.

      2. Select the number of minutes after :guilabel:`hr` at which 
         |service| takes a snapshot from :guilabel:`min` beneath
         :guilabel:`Snapshot Time (UTC)`.

      3. Click :guilabel:`Save Changes`.

.. _creating-backup-policy:

Configure the Backup Policy
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Each row in the :guilabel:`Backup Policy Frequency and Retention` table
represents a backup policy item. Configure the policy items and,
optionally, add new policy items to configure a new backup policy.

.. tip::

   |service| displays the estimated number of snapshots
   associated with your changes below the
   :guilabel:`Backup Policy Frequency and Retention` table.

To specify a backup policy item using the {+atlas-ui+}:

1. Select the frequency unit from :guilabel:`Frequency Unit` for a
   policy item.

   Alternatively, click :guilabel:`Add Frequency Unit` to add a new
   policy item to the backup policy.

   .. note::

      You cannot specify multiple :guilabel:`Hourly` and
      :guilabel:`Daily` backup policy items.

2. Select the frequency for the frequency unit from :guilabel:`Every`.

   .. note::

      If you delete an existing backup frequency unit, the snapshots
      for which the frequency was specified remain intact until they
      expire or you delete them.

3. Specify the retention time for the policy item in
   :guilabel:`Retention Time` and the units for the retention time from
   the list to the right.

   .. note::

      |service| requires that the value specified for
      :guilabel:`Retention Time` for items that are less frequent is
      equal to or larger than the value specified for items that are
      more frequent. For example, if the hourly policy item specifies
      a retention of two days or greater, the retention for the weekly
      snapshot must be two weeks or greater.

      You can't configure a :ref:`restore window <create-pit-policy>` 
      that is longer than the Hourly Snapshot 
      :guilabel:`Retention Time`.

4. (Optional) To apply the retention changes in the updated backup
   policy to snapshots that |service| took previously, check
   :guilabel:`Apply policy retention changes to existing snapshots`.

   .. note::

      This option affects only snapshots created by the updated policy
      items and whose retention has not been updated individually with
      the
      :doc:`/reference/api/cloud-backup/schedule/modify-one-schedule`
      API.

5. Click :guilabel:`Save Changes`.

.. note::

   To take a snapshot sooner than the next scheduled snapshot,
   use the :doc:`/reference/api/cloud-backup/backup/take-one-ondemand-backup` API.

.. note::

   .. include:: /includes/fact-overlapping-backup-policy-items.rst

.. important::

   If you disable {+Cloud-Backup+}s for a cluster or terminate a
   cluster that had snapshots enabled, |service| immediately
   deletes the backup snapshots for that cluster. For clusters not
   using :ref:`security-kms-encryption`
   you can :ref:`download the latest snapshot
   <restore-cloud-provider-snapshot-download>` to preserve any data
   stored in the cluster.

.. _create-pit-policy:

Configure the Restore Window
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can replay the :term:`oplog` to restore a cluster from any point in 
time within a specified restore window.

To specify the restore window duration, select how long you want
|service| to retain the oplog for point-in-time restores from
the :guilabel:`Restore Window` list.

You can't configure a restore window that is longer than the 
:ref:`Hourly Snapshot Retention Time <creating-backup-policy>`.

.. _snapshot-distribution:

Configure |service| to Automatically Copy Snapshots to Other Regions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can configure |service| to automatically create copies of your
snapshots and oplogs and store them in other regions. With snapshots
distributed across regions, you can still restore your {+cluster+} if
the primary region goes down, enhancing your disaster recovery
capabilities to bring them in line with internal or regulatory 
requirements. Additionally, you can perform direct attach restores 
rather than slower streaming restores for {+clusters+} based in the 
same project and region where you store copies. This reduces system 
recovery time.

You can use copied oplogs to perform {+pit-restore+} from secondary
regions in the event the primary region of your {+cluster+} goes down.

.. note::

   :ref:`{+Serverless-instance+} backups <serverless-snapshots>` and
   :ref:`legacy backups <legacy-backup>` don't support this 
   configuration.

   Snapshots taken in AWS and Azure regions are incremental. Snapshots
   taken for GCP are not incremental, resulting in higher data storage 
   and transfer costs.

To configure automatic snapshot distribution in other regions:

1. Navigate to the :guilabel:`Backup Policy` tab. In the 
   :guilabel:`Additional Backup Copies` section, click the arrow button 
   to expand the pane.

#. Toggle :guilabel:`Copy to other regions` on. You will see a table of 
   distribution policies pre-populated with the cluster's current 
   regions.
   
   .. note::

      For a global {+cluster+}, you can enable or disable this setting
      independently for each zone.

#. In the :guilabel:`Copy to other regions` table, click 
   :guilabel:`Choose a region` in the :guilabel:`Region` column of the 
   row under your current region and select the region to distribute 
   snapshots to.

   .. note::

      You can select regions only for the same cloud provider as the 
      primary region. For example, if your {+cluster+} is in the |aws| 
      ``us-east-1`` region, you can distribute snapshots only to other 
      |aws| regions supported by |service|. For global {+clusters+}, 
      each zone may have nodes in multiple cloud providers. When you 
      select regions in which to store copied snapshots, you can select 
      only regions in the same cloud provider as the zone's primary
      region.

#. In the :guilabel:`Snapshots` column, click the arrow to view the 
   available snapshot policies for the cluster. |service| displays
   options based on the backup policies for the cluster.

   For example, if you set the {+cluster+} with a :guilabel:`Daily`
   backup policy of taking daily 5:00 PM snapshots, checking
   :guilabel:`Daily` in the :guilabel:`Snapshots` column enables 
   snapshot distribution of daily 5:00 PM snapshots. You can't set the 
   snapshot distribution policy to a different frequency or timing than 
   its underlying backup policy.

   You can enable or disable any combination of the available policies
   on a region-by-region basis.

   .. example::

      The following table describes the snapshot distribution policy
      for a {+cluster+} with enabled storage nodes in the |aws| regions
      ``us-east-2``, ``us-west-1``, and ``us-west-2``:

      .. list-table::
         :widths: 16 14 14 14 14 14 14
         :header-rows: 1

         * - Region
           - Hourly
           - Daily
           - Weekly
           - Monthly
           - On Demand
           - Point-in-Time

         * - ``us-east-1`` (Original)
           - Every 6 hours
           - Every 2 days
           - Every Sunday
           - Last day of the month
           - Yes
           - Yes

         * - ``us-east-2`` (Copy)
           - Disabled
           - Disabled
           - Enabled
           - Enabled
           - Disabled
           - No

         * - ``us-west-1`` (Copy)
           - Enabled
           - Enabled
           - Enabled
           - Enabled
           - Enabled
           - Yes

         * - ``us-west-2`` (Copy)
           - Enabled
           - Enabled
           - Disabled
           - Disabled
           - Enabled
           - Yes

#. If you enabled {+PIT-Restore+} for the cluster, you can
   enable oplog distribution for each additional region. If you 
   disabled {+PIT-Restore+} for the cluster, you can't enable oplog
   distribution for additional regions.

To delete a policy for snapshot distribution to other regions:

1. In the :guilabel:`Action` column, click :icon:`trash-alt`.
   
2. In the dialog box, select either
   :guilabel:`Keep all snapshots in this region` or
   :guilabel:`Delete all snapshots in this region`, and click
   :guilabel:`Confirm`. If you choose to keep snapshots in
   a disabled region, the snapshots persist until their
   scheduled expiration date.

Alternatively, to disable all snapshot distribution policies
within a single-region {+cluster+} or within a global {+cluster+} zone,
click the :guilabel:`Copy to other regions` toggle. As with deleting
an individual policy, you can choose to keep or delete all copied
snapshots for that {+cluster+} or zone.

.. note::
   
   In the event of a cloud provider service outage in a region 
   configured for automatic snapshot distribution, |service| will 
   attempt restore using snapshots stored in copy regions.

To delete all copies of a snapshot without deleting its distribution
policy, delete the snapshot from its original region using one of the
following methods:

- For non-sharded clusters, delete the snapshot programmatically with 
  :oas-atlas-op:`Remove One Replica Set Cloud Backup </removeOneReplicaSetCloudBackup>`.
- For sharded clusters, delete the snapshot programmatically with
  :oas-atlas-op:`Remove One Sharded Cluster Cloud Backup </removeOneShardedClusterCloudBackup>`.

Or, from the {+atlas-ui+}, perform the following procedure:

1. Click :guilabel:`Database` in the upper left-hand corner and select
   the cluster from which you wish to delete a snapshot.
2. Click the :guilabel:`Backup` tab.
3. Select the snapshot you wish to delete from the list under the 
   :guilabel:`Snapshots` tab and click :icon:`trash-alt`.

Deleting the original snapshot by any of these methods will propagate
the deletion to all copies of that snapshot.

.. _viewing-snapshots:

View Backup Snapshots
~~~~~~~~~~~~~~~~~~~~~

.. tabs::

   .. tab:: {+atlas-cli+}
      :tabid: atlascli

      .. include:: /includes/extracts/atlas-backups-snapshots-list-and-describe.rst

   .. tab:: {+atlas-ui+}
      :tabid: ui

      .. include:: /includes/view-snapshots-cluster-ui.rst

By default, |service| displays both on-demand and policy-based
snapshots. To view only policy-based snapshots:

1. Click :guilabel:`Policy` under :guilabel:`View Snapshots by`.

   Alternatively, click :guilabel:`On-demand` to display only snapshots
   taken by clicking :guilabel:`Take Snapshot Now`.

Snapshots taken according to the backup policy display the frequency of
the policy item that generated the snapshot in the
:guilabel:`Frequency` column: ``Monthly``, ``Weekly``, ``Daily``, or
``Hourly``.

.. note::

   .. include:: /includes/fact-overlapping-backup-policy-items.rst

.. include:: /includes/fact-backup-zone-renaming.rst

.. _cloud-provider-snapshots-on-demand:
.. _on-demand-snapshots:

Take On-Demand Snapshots
~~~~~~~~~~~~~~~~~~~~~~~~

|service| takes on-demand snapshots immediately, unlike scheduled
snapshots which occur at
:doc:`regular intervals 
</reference/api/cloud-backup/schedule/schedules>`.
If there is already an on-demand snapshot with a status of ``queued``
or ``inProgress``, you must wait until |service| has completed the
on-demand snapshot before taking another. If there is already a
scheduled snapshot with a status of ``queued`` or ``inProgress``, you
may queue an on-demand snapshot. You must have the
:authrole:`Organization Owner` or :authrole:`Project Owner` role to
successfully call this endpoint.

.. tabs::

   .. tab:: {+atlas-cli+}
      :tabid: atlascli

      .. include:: /includes/extracts/atlas-backups-snapshots-create.rst

   .. tab:: {+atlas-ui+}
      :tabid: ui

      .. include:: /includes/take-on-demand-snapshot-ui.rst
        