=======================================
Restore a Sharded Cluster from a Backup
=======================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Overview
--------

When you restore a cluster from a backup, |mms| provides you with a
restore files for the selected restore point. For an overview of the
restore process, please see :doc:`/core/restore-overview`.

Prerequisites
-------------

Client Requests During Restoration
++++++++++++++++++++++++++++++++++

.. include:: /includes/considerations-restore-in-isolation.rst

Snapshots when Agent Cannot Stop Balancer
+++++++++++++++++++++++++++++++++++++++++

|mms| displays a warning next to cluster snapshots taken while the
:term:`balancer <balancer>` is enabled. If you restore from such a
snapshot, you run the risk of lost or orphaned data. For more information,
see :ref:`snapshot-while-balancer-enabled`.

Secure Copy (``scp``) Delivery
++++++++++++++++++++++++++++++

If you intend to delivery using ``scp``, you must 
:doc:`generate a key pair </tutorial/generate-key-pair-for-scp-restores>` 
before attempting to deliver the files. Windows machines do not come with 
``scp`` and require additional installation and configuration.

.. important::

   When copying files individually, the ``MaxStartups`` value in
   ``sshd_config`` should be increased to:

   (4 Ã— (number of shards + number of config servers)) + 10

   ``scp`` is performed in parallel and, by default, ``sshd``
   installations use a small number of concurrent connections. Changing
   this setting allows ``scp`` to support sufficient connections to
   complete the restore.

   .. example::

      You are restoring a sharded cluster with 7 shards and 3 config
      servers. This would result in needing a ``MaxStartups`` value of
      ``50``:

      ``MaxStartups  50``

Procedures
----------

To have |mms| automatically restore the backup, perform the 
:ref:`select the snapshot <select-snapshot-sharded-cluster>` procedure.

To instead manually restore the backup, perform all the procedures
below in sequence. You will select the snapshot, distribute the restore
files to the target servers, start and configure each shard's replica
set, and then start and configure the cluster. If you restore to
existing hardware, use different data directories than used previously.

.. _select-snapshot-sharded-cluster:

Select the Snapshot
+++++++++++++++++++

.. include:: /includes/steps/download-snapshot-sharded-cluster.rst

Restore Each Shard's Primary
++++++++++++++++++++++++++++

For *all* shards, restore the primary. You must have a copy of the
snapshot on the server that provides the primary. Use this procedure only
for manual restores.

.. include:: /includes/steps/restore-primary.rst

Restore All Secondaries
+++++++++++++++++++++++

After you have restored the primary for a shard you can restore all
secondaries. You must have a copy of the snapshot on all servers that
provide the secondaries. Use this procedure only for manual restores.

.. include:: /includes/steps/restore-secondary.rst

Restore Each Config Server
++++++++++++++++++++++++++

Perform this procedure separately for each :term:`config server`. Each
config server must have a copy of the tar file with the config server
data. Use this procedure only for manual restores.

.. include:: /includes/steps/restore-config-server.rst

Start the ``mongos``
++++++++++++++++++++

Start the cluster's :program:`mongos` bound to your new config servers.
