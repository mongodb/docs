===============================
Rotate your customer master key
===============================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. include:: /includes/fact-atlas-free-tier-limits.rst

For clusters using |service| :ref:`security_aws_kms`, |service|
automatically rotates the MongoDB master keys every 90 days. However,
|service| does **not** automatically rotate the customer master key
(CMK) used for Encryption at Rest. |service| automatically creates an 
:alert:`alert <AWS encryption key elapsed time since last rotation is above (n) days>`
reminding you to rotate your :abbr:`CMK (customer master key)` 
every 365 days by default when you 
:ref:`enable Encryption at Rest <security_aws_kms>` for a |service| 
project. 

AWS :abbr:`KMS (Key Management Service)` supports 
`automatic CMK rotation <https://docs.aws.amazon.com/kms/latest/developerguide/rotate-keys.html>`_. 
AWS automatic :abbr:`CMK (customer master key)` rotation does not 
require you to update the |service| Encryption at Rest project
settings, including the :abbr:`CMK (customer master key)` ID. 

This procedure documents manually rotating your |service| project
:abbr:`CMK (customer master key)` by creating a new key and
updating the :abbr:`CMK (customer master key)` ID in |service|. 
Manual key rotation supports more granular control of the rotation
period compared to AWS :abbr:`KMS (Key Management Service)`
automatic :abbr:`CMK (customer master key)` rotation.

For complete documentation on MongoDB Encryption at Rest, including
more details on the encryption process, see
:manual:`Encryption at Rest </core/security-encryption-at-rest/>`
in the MongoDB server documentation.

.. admonition:: Cloud Provider Snapshots with Encryption at Rest
   :class: important

   For clusters using :doc:`Encryption at Rest </security-aws-kms>`
   and :ref:`backup-cloud-provider`, |service| uses the project's 
   :abbr:`CMK (customer master key)` and AWS 
   :abbr:`IAM (Identity and Access Management)` user credentials at the 
   time of the snapshot to automatically encrypt the snapshot data 
   files. This is an additional layer of encryption on the existing
   encryption applied to all |service| storage and snapshot volumes.

   |service| does **not** re-encrypt snapshots with the new 
   :abbr:`CMK (customer master key)` after rotation. Do **not** delete
   the old :abbr:`CMK (CUstomer Master Key)` until you check **every** 
   backup-enabled cluster in the project for any snapshots still
   using that :abbr:`CMK (customer master key)`. |service|
   automatically deletes backups in accordance to the 
   :ref:`cloud-provider-retention-policy`. Once |service| deletes
   all snapshots depending on a given :abbr:`CMK (customer master key)`,
   you can delete that :abbr:`CMK (customer master key)` safely.

   For complete documentation on Encryption at Rest with
   Cloud Provider Snapshots, see 
   :ref:`encrypted-cloud-provider-snapshot`.

Procedure
---------

.. include:: /includes/steps/rotate-aws-kms-cmk.rst
