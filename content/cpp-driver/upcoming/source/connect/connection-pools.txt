.. _cpp-connection-pools:

=====================
Use a Connection Pool
=====================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: client, thread safety, multithreading, pooling, code example
   :description: Learn how to use the C++ driver to create connection pools, which allow you to manage multiple client objects and run concurrent operations in your code.

Overview
--------

In this guide, you can learn how to use the {+driver-short+} to create and
configure a **connection pool**. A connection pool is a cache of client
objects that your application can use to manage multiple concurrent MongoDB
operations.

After you instantiate a ``mongocxx::pool``, the pool creates client
objects as needed until it reaches the maximum pool size. Each thread that runs
MongoDB operations checks out a client from the pool, uses it to perform
operations, and returns the client to the pool. The pool 
automatically manages the lifecycle of these clients.

.. important::

   Unlike most MongoDB drivers, the {+driver-short+} does not
   implement the MongoDB :spec:`Connection Monitoring and Pooling (CMAP)
   </connection-monitoring-and-pooling/connection-monitoring-and-pooling.md>`
   specification. In this context, connection pooling refers to the driver's 
   cache of client objects instead of database connections.

Connection Pool and Client Comparison
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Connection pools offer significant performance advantages over
standalone clients. A ``mongocxx::pool`` uses separate background
monitoring threads to continuously monitor the cluster. As a result,
application threads can perform operations without waiting for topology
monitoring to complete. In contrast, a standalone ``mongocxx::client``
periodically stops to check the cluster status, blocking all operations
during the check.

You can use a connection pool even if your application uses only one thread.
The pool's background monitoring provides better performance than a
standalone client's periodic checks.

The following table summarizes the main differences between ``mongocxx::pool`` and
``mongocxx::client``:

.. list-table::
   :widths: 30 30 40
   :header-rows: 1

   * - Feature
     - ``mongocxx::pool``
     - ``mongocxx::client``

   * - Recommended for multi-threaded applications
     - Yes.
     - No.

   * - Background monitoring
     - Yes. Pools use a separate thread for each server.
     - No. Clients perform periodic blocking checks.

   * - Monitoring interval
     - Every 10 seconds per server.
     - Every 60 seconds.

   * - Thread safety
     - Thread-safe, but acquired clients are not thread-safe.
     - Not thread-safe.

   * - Fork safety
     - You must create the pool after forking.
     - You must create the client after forking.

.. tip:: Threading and Forking

   To learn more about how to use clients and client objects across multiple
   threads and when forking processes, see the :ref:`cpp-thread-safety` guide.

Create a Connection Pool
------------------------

To create a connection pool, instantiate a ``mongocxx::pool`` object by passing
your connection URI to its constructor. Each thread that runs MongoDB
operations must acquire a client from the pool by calling the ``acquire()``
member function. When the client goes out of scope, it automatically returns to the pool.

This sample file performs the following actions:

- Creates a connection pool
- Creates three threads that each acquire their own client from the pool
- Performs an insert operation in each thread

.. literalinclude:: /includes/connect/pool.cpp
   :language: cpp
   :copyable:
   :linenos:

Configure Connection Pool Options
---------------------------------

You can configure connection pool behavior by including options in your
connection URI. The following table describes the connection pool options you
can set:

.. list-table::
   :widths: 30 70
   :header-rows: 1

   * - URI Option
     - Description

   * - ``maxPoolSize``
     - | Specifies the maximum number of clients the pool can create. When this
         limit is reached, the ``acquire()`` member function blocks until another thread returns a
         client to the pool.
       | Defaults to ``100``.
       | **Type**: ``int``

   * - ``minPoolSize``
     - | Specifies the minimum number of clients the pool maintains. The pool
         creates this number of clients when initialized and maintains at least this
         number of clients continuously.
       | Defaults to ``0``.
       | **Type**: ``int``

   * - ``waitQueueTimeoutMS``
     - | Specifies the maximum time in milliseconds that the ``acquire()`` function waits for
         a client to become available when the pool has reached the ``maxPoolSize`` value.
         If this timeout expires, the ``acquire()`` function generates an error.
       | Defaults to no timeout.
       | **Type**: ``int``

Example
~~~~~~~

The following example specifies the ``maxPoolSize`` option to
create a connection pool with a maximum size of ``5``
clients:

.. code-block:: cpp

   mongocxx::uri uri{"mongodb://localhost:27017/?maxPoolSize=5"};
   mongocxx::pool pool{uri};

API Documentation
-----------------

To learn more about the types and functions discussed in this guide, see the
following API documentation:

- `mongocxx::pool <{+api+}/classmongocxx_1_1v__noabi_1_1pool.html>`__
- `mongocxx::pool::acquire() <{+api+}/classmongocxx_1_1v__noabi_1_1pool.html#a95dff0c5b7ac7b7401a72bbf8ffbf143>`__
- `mongocxx::uri <{+api+}/classmongocxx_1_1v__noabi_1_1uri.html>`__