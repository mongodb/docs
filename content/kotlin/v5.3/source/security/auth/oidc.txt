.. _kotlin-mongodb-oidc:

===================================
OIDC (Workload Identity Federation)
===================================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: authorize, code example

Overview
--------

The OpenID Connect (OIDC) authentication mechanism allows you to authenticate to
MongoDB by using a third-party identity provider, such as Azure or Google Cloud
Platform (GCP). 

You can use this mechanism only when authenticating to MongoDB Atlas or MongoDB
Enterprise Advanced, and only when authenticating to MongoDB v7.0 or later.

.. tip:: OIDC Authentication

   To learn more about configuring MongoDB Atlas for OIDC authentication, see
   :atlas:`Set up Workforce Identity Federation with OIDC </workforce-oidc/#std-label-oidc-authentication-workforce>`
   in the Atlas documentation.
   
   For more information about using OIDC authentication with MongoDB, see
   :manual:`OpenID Connect Authentication </core/security-oidc/>` and
   :manual:`MongoDB Server Parameters </reference/parameters/#mongodb-parameter-param.oidcIdentityProviders>`
   in the {+mdb-server+} manual.

The following sections describe how to use the MONGODB-OIDC
authentication mechanism to authenticate to various platforms.

Azure IMDS
----------

If your application runs on an Azure VM, or otherwise uses the
`Azure Instance Metadata Service <https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service>`__
(IMDS), you can authenticate to MongoDB by using the {+driver-short+}'s built-in Azure
support.

You can specify Azure IMDS OIDC authentication by specifying your
credentials in the connection string or by using a ``MongoCredential``
instance. Select the :guilabel:`Connection String` or :guilabel:`MongoCredential`
tab to learn how to specify Azure IMDS OIDC authentication.

.. tabs::
   
   .. tab:: Connection String
      :tabid: Connection String

      Replace the ``<percent-encoded audience>`` placeholder in the
      following code with the percent-encoded value of the audience server
      parameter configured on your MongoDB deployment.

      The comma (``,``) character and its encoding (``%2C``) are
      reserved, and using these characters in a value causes the
      driver to interpret commas as delimiters of key-value pairs.
      You must specify values that contain commas in a ``MongoCredential`` instance.

      .. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-azure-connection-string.kt
         :language: kotlin

   .. tab:: MongoCredential
      :tabid: MongoCredential

      Replace the ``<OIDC principal>`` placeholder with the client ID or application ID of the
      Azure managed identity or enterprise application. Replace the ``<audience>``
      placeholder with the value of the
      ``audience`` server parameter configured on your MongoDB deployment.

      .. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-azure-credential.kt
         :language: kotlin

GCP IMDS
--------

If your application runs on a Google Compute Engine VM, or otherwise uses the
`GCP Instance Metadata Service <https://cloud.google.com/compute/docs/metadata/querying-metadata>`__,
you can authenticate to MongoDB by using the {+driver-short+}'s built-in GCP
support.

You can specify GCP IMDS OIDC authentication by specifying your
credentials in a connection string or by using a ``MongoCredential`` instance.

.. tabs::

   .. tab:: Connection String
      :tabid: Connection String

      Replace the ``<percent-encoded audience>`` placeholder in the
      following code with the percent-encoded value of the audience server
      parameter configured on your MongoDB deployment.

      The comma (``,``) character and its encoding (``%2C``) are
      reserved, and using these characters in a value causes the
      driver to interpret commas as delimiters of key-value pairs.
      You must specify values that contain commas in a ``MongoCredential`` instance.

      .. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-gcp-connection-string.kt
         :language: kotlin

   .. tab:: MongoCredential
      :tabid: MongoCredential

      Replace the ``<audience>`` placeholder with the value of the
      ``audience`` server parameter configured on your MongoDB deployment.

      .. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-gcp-credential.kt
         :language: kotlin

.. _kotlin-auth-kubernetes:

Kubernetes
----------

If your application runs on a Kubernetes cluster, you can authenticate
to MongoDB by using the {+driver-short+}'s built-in Kubernetes
support. You can specify Kubernetes OIDC authentication by specifying your
credentials in a connection string or by using a ``MongoCredential``
instance.

.. tabs::

   .. tab:: Connection String
      :tabid: Connection String

      To specify Kubernetes OIDC as the authentication mechanism, set the following 
      options in your connection string:

      - ``authMechanism``: Set to ``MONGODB-OIDC``.
      - ``authMechanismProperties``: Set to ``ENVIRONMENT:k8s``. 

      Replace the ``<percent-encoded audience>`` placeholder in the
      following code with the percent-encoded value of the audience server
      parameter configured on your MongoDB deployment.

      .. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-k8s-connection-string.kt

   .. tab:: MongoCredential
      :tabid: MongoCredential

      Replace the ``hostname`` and ``port`` with the network address and port 
      number of your MongoDB deployment. Also, replace the
      ``<audience>`` placeholder with the value of the ``audience``
      server parameter configured on your MongoDB deployment.
      
      .. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-k8s-credential.kt
         :language: kotlin

Custom Callback
---------------

The {+driver-short+} doesn't offer built-in support for all platforms, including
Azure Functions and Azure Kubernetes Service (AKS). Instead, you
must define a custom callback to use OIDC to authenticate from these platforms.
To do so, use the ``"OIDC_CALLBACK"`` authentication property, as shown in the following
code example:

.. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-callback.kt
   :language: kotlin

The value of the ``"OIDC_CALLBACK"`` property must be a lambda or other implementation
of the ``OidcCallback`` functional interface that accepts an ``OidcCallbackContext``
as a parameter and returns an ``OidcCallbackResult``.

The following example uses an example callback to retrieve an OIDC token from a file
named ``"access-token.dat"`` in the local file system:

.. literalinclude:: /examples/generated/EnterpriseAuthTest.snippet.oidc-callback-file.kt
   :language: kotlin
