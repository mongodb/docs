.. _profile-database:
.. _query-profiler:

=========================
Monitor Query Performance
=========================

.. default-domain:: mongodb

.. meta::
   :keywords: profile

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

*Only available on M10+ {+clusters+} and {+serverless-instances+}*

The Query Profiler diagnoses and monitors performance issues. This
monitoring can expose slow-running queries and their key performance
statistics in the {+atlas-ui+}. You can explore a sample of historical
queries for up to the last 24 hours without additional cost or performance
overhead.

|service| collects and displays statistics from any of your :binary:`mongod <bin.mongod>`
instances. The Query Profiler identifies slow queries based on :ref:`log data <mongodb-logs>` 
from your ``mongod`` instances. Atlas displays this data in the :guilabel:`Profiler` 
section of an instance. 

.. note::

   The Query Profiler differs from the :manual:`Database Profiler 
   </tutorial/manage-the-database-profiler>`. The Query Profiler identifies 
   specific inefficient queries based on entries from your ``mongod`` logs.
   The Database Profiler returns detailed information about commands executed 
   on the ``mongod`` based on the specified :manual:`profiling level 
   </tutorial/manage-the-database-profiler/#profiling-levels>`. Changing the 
   profiling level doesn't impact the slow queries displayed in the Query 
   Profiler.

The :guilabel:`Profiler` displays one aspect, such as
:guilabel:`Operation Execution Time` or 
:guilabel:`Server Execution Time` ({+serverless-instances+}), that could 
reveal slow database operations over a set time frame. It displays this 
data in both a chart and a table that each can filter on aspect and 
time frame.

.. tip::

   You can use :query:`$comment` to add descriptive information
   that will appear in the visual query profiler to the query predicate. 
   This information makes it easier to analyze your profiler data.

|service| manages the threshold for slow operations for each
``mongod`` host based on average operation execution time on 
that host. This threshold can be changed using the 
:method:`db.setProfilingLevel <db.setProfilingLevel>` 
{+mongosh+} command.

.. note::

   Changing the threshold for slow operations using 
   :method:`db.setProfilingLevel <db.setProfilingLevel>` can impact 
   performance and system log settings. Carefully 
   consider any performance and security implications before you use 
   :method:`db.setProfilingLevel <db.setProfilingLevel>` to adjust 
   profiler settings on a production deployment. Profiler settings
   reset to default values following a node restart. 

.. note::

   To opt out of the |service|-managed slow operation threshold and
   use a fixed slow query threshold of 100 milliseconds instead,
   use the {+atlas-admin-api+}. See :oas-atlas-op:`Disable Managed Slow 
   Operation Threshold </disableManagedSlowOperationThreshold>`. 
   For ``M0``, ``M2``, ``M5`` clusters and {+serverless-instances+}, 
   |service| disables the |service|-managed slow query operation 
   threshold by default and you can't enable it.

.. _atlas-considerations-profile-database:

Considerations
--------------

.. important:: Please read the following considerations before you enable profiling.

Security
~~~~~~~~

Profile data may include sensitive information including the content of
database queries. Ensure that exposing this data to |service| is
consistent with your information security practices.

Data Analysis Limitations
~~~~~~~~~~~~~~~~~~~~~~~~~

The Query Profiler displays up to the first of the following limits:

- the most recent 10,000 operations, or
- the most recent 10MB of logs.

Data Display Limitations
~~~~~~~~~~~~~~~~~~~~~~~~

|service| displays no more than 10,000 data points in the
:guilabel:`Profiler` charts.

Log data is processed in batches. Data can be delayed up to five
minutes from realtime.

Log Quantity
````````````

.. include:: /includes/log-rate-limiting.rst

Enable and Disable Profiling
----------------------------

.. important:: Required Privileges

   To enable or disable :guilabel:`Performance Advisor and Profiler` 
   for a project, you must have the :authrole:`Project Owner` role for 
   the project or the :authrole:`Organization Owner` role on its parent 
   organization.

|service| enables Profiling by default.

To disable profiling:

1. Click :guilabel:`Project Settings` in the left navigation.
#. Toggle :guilabel:`Performance Advisor and Profiler` to
   :guilabel:`Off`.

.. _atlas-profiler-interface:

Access the Query Profiler
-------------------------

To access the Query Profiler:

- For a {+cluster+}, click :guilabel:`View Monitoring` for that 
  instance in the project panel then click :guilabel:`Profiler`.

  .. note::

      When you access the Query Profiler at the {+cluster+} level, the 
      Query Profiler displays the data from the log on the 
      :term:`primary` node. You must select each specific 
      :term:`secondary` node to view any long-running queries on those 
      nodes.

- For a {+serverless-instance+}, click the :guilabel:`Monitoring` tab.

.. _atlas-profiler-chart:

Profiling Chart
~~~~~~~~~~~~~~~

Above the chart, select the metric and time period you want to see.

1. Select the metric from the :guilabel:`Display` menu. |service| 
   accepts:

   - Default: :guilabel:`Operation Execution Time` or 
     :guilabel:`Server Execution Time` ({+serverless-instances+})

   - :guilabel:`Keys Examined`
   - :guilabel:`Docs Returned`
   - :guilabel:`Examined:Returned Ratio`
   - :guilabel:`Num Yields`
   - :guilabel:`Response Length`

#. Select the time period from the :guilabel:`View Last` menu.
   |service| accepts:

   - 24 hr (default)
   - 12 hr
   - 6 hr
   - 1 hr
   - 15 min

To view a full query and its execution statistics, click on the point 
representing it on the chart.

.. _atlas-profiler-table:
.. _atlas-profiler-table-set-filter:

Profiling Table
~~~~~~~~~~~~~~~

Above the table, select the namespace, operation type, and metric you
wish to profile:

1. Click :guilabel:`All Namespaces` to change which combination of
   databases and collections to profile.

#. Click :guilabel:`All Operations` to change which operations you want
   to profile.

#. Click :guilabel:`Operation Execution Time` or 
   :guilabel:`Server Execution Time` ({+serverless-instances+}) to 
   change which metric you want to profile. |service| accepts:

   - Default: :guilabel:`Operation Execution Time` or 
     :guilabel:`Server Execution Time` ({+serverless-instances+})

   - :guilabel:`Keys Examined`
   - :guilabel:`Docs Returned`
   - :guilabel:`Examined:Returned Ratio`
   - :guilabel:`Num Yields`
   - :guilabel:`Response Length`
