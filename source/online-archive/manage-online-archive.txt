.. _online-archive-overview:

============
Archive Data
============

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/serverless-preview-dont-use.rst

|service| moves infrequently accessed data from your |service| cluster
to a MongoDB-managed read-only :ref:`Federated Database Instance 
<atlas-data-federation>` on a cloud object storage. Once |service| 
archives the data, you have a unified view of your |service| and 
{+Online-Archive+} data through a read-only {+fdi+}.

|service| archives data based on the criteria you specify in an
archiving rule. The criteria varies based on the type of collection 
you want to archive:  

.. tabs:: 

   .. tab:: Standard Collection
      :tabid: standard

      For standard collections, the criteria can be one of the 
      following:

      - A combination of a date field to archive data and number of 
        days to keep data on the |service| cluster. When the current 
        date exceeds the value of the specified date field, |service| 
        subtracts the number of days from the current time and then 
        archives data after the time.
      - A custom query. |service| runs the query specified in the 
        archiving rule to select the documents to archive.

   .. tab:: Time Series Collection 
      :tabid: timeseries 

      .. include:: /includes/fact-oa-timeseries-preview.rst

      For :manual:`time series </core/timeseries-collections/>` 
      collections, the criteria is a combination of a time field and 
      number of days to keep data on the |service| cluster. When the 
      current time exceeds the value of the specified time field, 
      |service| subtracts the number of days from the current time and 
      then archives data after that many days, hours, and minutes.

Cluster Requirements
--------------------

*{+Online-Archive+}*  in |service| is available only on ``M10`` and
greater clusters that run MongoDB 3.6 or later.

Required Permissions
--------------------

To create or delete an {+Online-Archive+}, you must have one of these
roles:

- :authrole:`Project Data Access Admin` role
- :authrole:`Project Cluster Manager` role
- :authrole:`Project Owner` role

.. _online-archive-job:

How |service| Archives Data
---------------------------

To archive data:

1. |service| runs a query to determine the documents that match the 
   criteria for archiving. |service| refers to this query as a *job*. 
   
   By default, |service| runs the job every five minutes. If the size 
   or number of documents to archive doesn't meet the threshold, 
   |service| expands the job interval by ten minutes, up to a maximum 
   of twelve hours. If the job interval reaches the maximum or if 
   either the size or number of documents to archive reaches the 
   threshold, |service| runs the job again and resets the job interval 
   to five minutes.

   If you specify a time window when you want to run the job, 
   |service| runs the job continuously during that time window. If 
   a running job doesn't complete during the time window, |service| 
   continues to run the job until it completes. If all archiving jobs 
   reach the maximum threshold for either the size or number of 
   documents to archive during three consecutive archive windows, we 
   recommend that you increase the frequency.

   .. note:: 

        .. include:: /includes/fact-oa-scheduled-archiving-preview.rst

   The threshold is 2GB per job.

   .. include:: /includes/fact-online-archive-index-sufficiency-warning.rst

2. For documents that match the archival criteria, |service|:

   a. Writes to up to a maximum of 10,000 partitions per data archiving 
      job.

   b. Writes up to 2GB of document data to partitions on the cloud 
      object storage for each unique combination of query field values 
      except dates, which are grouped during each run to reduce the 
      number of partitions.

   c. Writes each subsequent quantity of document data (up to 2 GB)
      with each query run.

{+Online-Archive+} runs on your |service| cluster and utilizes the same 
underlying resources (e.g. |iops|). The default limit of 2GB per job 
prevents the operation from utilizing too many resources. If your 
cluster is currently satisfying workloads at the edge of its resource 
limits, you could push it past its capacity by activating 
{+Online-Archive+}. Ensure that your |service| cluster has excess 
resources before activating {+Online-Archive+}.

If you activate {+Online-Archive+} for an |aws| cluster, the cloud 
object storage exists in the same region in |aws| as your cluster. If 
you activate {+Online-Archive+} for a |gcp| or |azure| cluster, 
{+Online-Archive+} creates the archive in the |aws| region closest to 
your cluster's primary based on a calculation of distance between the 
cluster and cloud object storage.

.. important::

   |service| encrypts your archived data using `Amazon's server-side encryption S3-managed keys (SSE-S3) <https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingServerSideEncryption.html>`__ for 
   archived data. It can't use any encryption-at-rest encryption 
   keys you might have used on your cluster data. 

When you archive data, |service| first copies the data to the cloud 
object storage and then deletes the data from your |service| cluster. 
:manual:`WiredTiger </core/wiredtiger/>` does not release the storage 
blocks of the deleted data back to the OS for performance reasons. 
However, |service| eventually automatically reuses these storage blocks 
for new data. This helps the |service| cluster to avoid fragmentation. 
To learn more about reclaiming the disk space, see :manual:`How do I 
reclaim disk space in WiredTiger? 
</faq/storage/#how-do-i-reclaim-disk-space-in-wiredtiger>`.

|service| provides a unified endpoint. You can use it to query all
databases and collections on your live cluster and archived data using
the same database and collection name that you use in your |service|
cluster. You can't use the unified endpoint over a 
:doc:`Network Peering Connection </security-vpc-peering>`, but you can 
:ref:`set up a private endpoint <oa-config-private-endpoint>` or use a
standard internet connection over |tls|.

{+adf+} for {+Online-Archive+}
----------------------------------------

When you configure your ``M10`` or greater |service| cluster for
{+Online-Archive+}, |service| creates a read-only :ref:`Federated 
Database Instance <atlas-data-federation>`, one per cluster, for your 
archived data.

Limitations
~~~~~~~~~~~

{+Online-Archive+} can't perform the following activities:

- Write to the {+Online-Archive+}.

- :ref:`Configure <config-adf>` or
  :ref:`administer <adf-cli>` the {+Online-Archive+} {+fdi+} through 
  the:

  - |service| console,
  - {+adf+} :ref:`CLI <adf-cli>`, or
  - {+adf+} API 

- Archive a capped collection.

Viewing the {+Online-Archive+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To view your {+fdi+} for the {+Online-Archive+}:

1. Log in to the |service| console.

2. Click :guilabel:`Data Federation` from the left navigation in your
   :guilabel:`Project` page.

Querying the {+Online-Archive+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To query your {+Online-Archive+} data, use the connection string
through the {+Online-Archive+} or {+fdi+} :guilabel:`Connect` button to 
connect to the {+fdi+}.

You can also query your {+Online-Archive+} data with :abbr:`SQL 
(Structured Query Language)`. To learn more, see 
:ref:`query-with-sql`.

Editing {+Online-Archive+}s
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Once |service| creates the {+Online-Archive+}, you can't change the 
archiving criteria from :guilabel:`Date Match` to :guilabel:`Custom 
Filter`, or vice versa.

Deleting {+Online-Archive+}s
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you delete all the {+Online-Archive+}s, |service| deletes the
{+fdi+}s. After deleting all the {+Online-Archive+}s, if you create
an {+Online-Archive+} with the same settings as a deleted
{+Online-Archive+}, |service| creates a new {+fdi+} for the new
{+Online-Archive+}.

.. _online-archive-pricing:

{+Online-Archive+} Costs
------------------------

{+Online-Archive+} stores infrequently accessed data to lower the data 
storage costs on your |service| cluster. To learn more about 
{+Online-Archive+} costs, see the `pricing page 
<https://www.mongodb.com/pricing>`__.

Manage Your {+Online-Archive+}
------------------------------

You can configure an {+Online-Archive+} for a collection on your
cluster through your |service| console and |api|. Once you create an
{+Online-Archive+}, you can: 

- :ref:`View the list of Online Archives <view-online-archive>`.
- :doc:`Configure the connection method, standard or private endpoint, 
  for your Online Archive </online-archive/connect-to-online-archive>`
- :ref:`Edit an archiving rule <edit-online-archive>`.
- :ref:`Delete your Online Archive <delete-online-archive>`.
- :doc:`Pause archiving </online-archive/pause-resume-online-archive>`.
- :doc:`Restore archived data </online-archive/restore-archived-data>`.

.. toctree::
   :titlesonly:

   /online-archive/configure-online-archive
   /online-archive/config-private-endpoint
   /online-archive/connect-to-online-archive
   /online-archive/query-online-archive
   /online-archive/view-private-endpoints
   /online-archive/pause-resume-online-archive
   /online-archive/config-backup-online-archive
   /online-archive/restore-archived-data 
   /online-archive/download-query-logs
