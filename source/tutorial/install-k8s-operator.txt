:noprevnext:

.. _install-k8s:

=========================
Install the |k8s-op-full|
=========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/styles/corrections.rst

Use the |k8s-op-full| to deploy:

- Ops Manager resources
- MongoDB standalone, replica set, and sharded cluster resources

.. include:: /includes/admonitions/note-k8s-supported-in-om4.rst

To deploy MongoDB resources with the |k8s-op-short|, you need an
|onprem| instance. Deploy this instance to |k8s| using the Operator or
outside |k8s| using
:opsmgr:`traditional installation methods </installation>`. The
Operator uses |onprem| |api| methods to deploy  then manage MongoDB
resources.

.. note::

   This tutorial presumes some knowledge of |k8s|, but does link to
   relevant |k8s| documentation where possible. If you are unfamiliar
   with |k8s|, please review that documentation first.

.. _k8s-prerequisites:

Prerequisites
-------------

To install the MongoDB |k8s-op-short|, you must:

1. Have a |k8s| solution available to use.

   If you need a |k8s| solution, see the |k8s|
   :k8sdocs:`documentation on picking the right solution </setup>`.

#. Have a running |onprem-link|.

   .. important::

      Your |onprem| installation must run an active |ntp| service. If
      the |onprem| host's clock falls out of sync, that host can't
      communicate with the |k8s-op-short|.

      To learn how to check your |ntp| service for your Ops Manager
      host, see the documentation for
      `Ubuntu <https://help.ubuntu.com/lts/serverguide/NTP.html>`__ or
      `RHEL <https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/s1-checking_the_status_of_ntp>`__.


#. Clone the :gh:`MongoDB Enterprise Kubernetes Operator repository </mongodb/mongodb-enterprise-kubernetes>`.

   .. code-block:: sh

      git clone https://github.com/mongodb/mongodb-enterprise-kubernetes.git

   .. note::

      You can use `Helm <https://helm.sh/>`__ to install the
      |k8s-op-short|. To learn how to install Helm, see its
      :gh:`documentation on GitHub </kubernetes/helm>`.

#. Create a |k8s-ns| for your |k8s| deployment. By default, The
   |k8s-op-short| uses the ``mongodb`` namespace. To simplify your
   installation, consider creating a namespace labeled ``mongodb``
   using the following |kubectl| command:

   .. code-block:: sh

      kubectl create namespace mongodb

   If you do not want to use the ``mongodb`` namespace, you can label
   your namespace anything you like:

   .. code-block:: sh

      kubectl create namespace <namespaceName>

#. (**For OpenShift only**): Create a |k8s-secret| that contains 
   credentials authorized to pull images from the 
   ``registry.connect.redhat.com`` repository:

   a. If you have not already, obtain a Red Hat subscription.

   #. Create a `Registry Service Account <https://access.redhat.com/terms-based-registry/>`__.

   #. Click on your Registry Service Account, then click the 
      :guilabel:`Docker Configuration` tab.

   #. Download the ``<account-name>-auth.json`` file and open it in a 
      text editor.

   #. Copy the ``registry.redhat.io`` object, and paste another instance
      of this object into the file. Remember to add a comma after the 
      first object. Rename the second object 
      ``registry.connect.redhat.com``, then save the file:

      .. code-block:: json
         :emphasize-lines: 5-9

         {
           "auths": {
            "registry.redhat.io": {
             "auth": "<encoded-string>"
            },
           "auths": {
            "registry.connect.redhat.com": {
             "auth": "<encoded-string>"
            }            
           }
         }

   #. Create a ``openshift-pull-secret.yaml`` file with the contents of 
      the modified ``<account-name>-auth.json`` file as ``stringData`` 
      named ``.dockerconfigjson``:

      .. code-block:: yaml
         :emphasize-lines: 4-16

         apiVersion: v1
         kind: Secret
         metadata:
           name: openshift-pull-secret
         stringData:
           .dockerconfigjson: |
               {
                 "auths": {
                   "registry.redhat.io": {
                     "auth": "<encoded-string>"
                   },
                   "registry.connect.redhat.com": {
                     "auth": "<encoded-string>"
                   }
                 }
               }
         type: kubernetes.io/dockerconfigjson

      The value you provide in the ``metadata.name`` field contains
      the secret name. Provide this value when asked for the 
      ``<openshift-pull-secret>``.

   #. Create a |k8s-secret| from the ``openshift-pull-secret.yaml`` 
      file:

      .. code-block:: sh

         oc apply -f openshift-pull-secret.yaml -n <namespace>

         

Considerations
--------------

|k8s| Compatibility
~~~~~~~~~~~~~~~~~~~

|k8s-op-full| is compatible with |k8s| v1.13 or later.


Docker Container Details
~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB builds the container images from the latest builds of the
following operating systems:

.. list-table::
   :header-rows: 1
   :widths: 50 50

   * - If you get your |k8s-op-short| from...
     - ...the Container uses


   * - `quay.io <https://quay.io/repository/mongodb/mongodb-enterprise-operator?tag=latest&tab=tags>`__
       or :gh:`GitHub </mongodb/mongodb-enterprise-kubernetes>`
     - `Ubuntu 16.04 <https://www.ubuntu.com/containers>`__

   * - `OpenShift <https://access.redhat.com/containers/?tab=tags#/registry.connect.redhat.com/mongodb/enterprise-operator>`__
     - `Red Hat Enterprise Linux 7 <https://www.redhat.com/en/topics/containers>`__

MongoDB, Inc. updates all packages on these images before releasing
them every three weeks.

Only One Operator per Namespace
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The |k8s-op-full| can only exist in one |k8s-ns|. Your deployment can
have:

- One cluster-wide |k8s-op-short| or
- Multiple Kubernetes Operators in their own namespaces

Do not try to deploy more than one Kubernetes Operator in the same
namespace as another Operator. Multiple Operators cannot coordinate
with one another within the same namespace.

.. _default namespace: https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/#viewing-namespaces

.. _install-k8s-operator:

Install the |k8s-op-full|
-------------------------

.. tabs::

   tabs:
     - id: vank8s
       name: Kubernetes
       content: |

          .. tabs::

                tabs:
                  - id: kubectl
                    name: Online using kubectl
                    content: |

                      .. include:: /includes/install-operator-vanilla-k8s-kubectl.rst

                  - id: helmonline
                    name: Online using Helm
                    content: |

                      .. include:: /includes/install-vanilla-k8s-online-helm.rst

                  - id: helmoffline
                    name: Offline using Helm and Docker
                    content: |

                      .. include:: /includes/install-vanilla-k8s-offline-helm.rst

     - id: openshift
       name: OpenShift
       content: |

          .. tabs::

                tabs:
                  - id: os
                    name: Online using oc
                    content: |
                      
                      .. include:: /includes/install-operator-openshift-oc.rst

                  - id: os-helm-online
                    name: Online using Helm
                    content: |
                      
                      .. include:: /includes/install-os-online-helm.rst

                  - id: os-helm-offline
                    name: Offline using Helm
                    content: |
                      
                      .. include:: /includes/install-os-offline-helm.rst

Next Steps
----------

After installing the |k8s-op-full|, you can:

- :doc:`Create an instance of Ops Manager </tutorial/deploy-om-container>`

- :doc:`Configure the Kubernetes Operator to deploy MongoDB resources </configure-k8s-operator-for-mdb-resources>`
