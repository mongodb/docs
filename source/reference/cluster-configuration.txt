========================
Automation Configuration
========================

.. default-domain:: mongodb

Overview
--------

The Automation Agent uses an automation configuration to determine the
desired state of a MongoDB deployment and to effect changes as needed. If
you modify the deployment through the |mms| web interface, you never need
manipulate this configuration.

If you are using the Automation Agent without |mms|, you can construct and
distribute the configuration file manually.

Fields
------

Optional fields are marked as such.

version
~~~~~~~

.. code-block:: cfg

   "version" : <integer>

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - version
     - integer
     - The version of the configuration file.

agentVersion
~~~~~~~~~~~~

.. code-block:: cfg

   "agentVersion" : {
       "name" : <string>,
       "directoryUrl" : <string>
   }

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - agentVersion
     - document
     - *Optional* The version of the Automation Agent to run. If the
       running version does not match this setting, the Automation Agent
       downloads the specified version, shuts itself down, and starts the
       new version.
   * - \- name
     - string
     - The desired version of the Automation Agent (e.g. "1.4.0").
   * - \- directoryUrl
     - string
     - The URL from which to download Automation Agent.

monitoringVersions
~~~~~~~~~~~~~~~~~~

.. code-block:: cfg

   "monitoringVersions" : [
       {
           "name" : <string>,
           "hostname" : <string>,
           "urls" : {
               <platform1> : {
                   <build1> : <string>,
                   ...,
                   "default" : <string>
               },
               ...
           },
           "baseUrl" : <string>,
           "logPath" : <string>,
           "logRotate" : {
               "sizeThresholdMB" : <number>,
               "timeThresholdHrs" : <integer>,
               "numUncompressed": <integer>,
               "percentOfDiskspace" : <number>
           }
       },
       ...
   ]

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - monitoringVersions
     - array
     - *Optional*. Documents that define version information for each Monitoring Agent.
   * - \- name
     - string
     - The desired version of the Monitoring Agent (e.g. "2.1.4.51-1").
   * - \- hostname
     - string
     - The hostname of the machine that runs the Monitoring Agent. If the
       Monitoring Agent is not running on the machine, |mms| installs the
       agent from the location specified in ``monitoringVersions.urls``.
   * - \- urls
     - document
     - The platform- and build-specific URLs from which to download the
       Monitoring Agent.
   * - \- \- <platform>
     - document
     - This field has a name that identifies an operating system and
       optionally a version. The field contains a document with key-value
       pairs, where each key is either the name of a build or ``default``
       and each value is a URL for downloading the Monitoring Agent. The
       document must include the ``default`` key set to the default
       download URL for the platform.
   * - \- baseUrl
     - string
     - The base URL used for the ``mmsBaseUrl`` setting in the
       :doc:`/reference/monitoring-agent`.
   * - \- logPath
     - string
     - *Optional*. The directory where the agent stores its logs. The
       default is to store logs in ``/dev/null``.
   * - \- logRotate
     - document
     - *Optional*. Enables log rotation for the MongoDB logs for a
       process.
   * - \- \- sizeThresholdMB
     - number
     - The maximum size in MB for an individual log file before rotation.
   * - \- \- timeThresholdHrs
     - integer
     - The maximum time in hours for an individual log file before
       rotation.
   * - \- \- numUncompressed
     - integer
     - *Optional*. The maximum number of total log files to leave
       uncompressed, including the current log file. The default is ``5``.
   * - \- \- percentOfDiskspace
     - number
     - *Optional*. The maximum percentage of total disk space all log
       files should take up before deletion. The default is ``.02``.

backupVersions
~~~~~~~~~~~~~~

.. code-block:: cfg

   "backupVersions" : [
       {
           "name" : <string>,
           "hostname" : <string>,
           "urls" : {
               <platform1> : {
                   <build1> : <string>,
                   ...,
                   "default" : <string>
               },
               ...
           },
           "baseUrl" : <string>,
           "logPath" : <string>,
           "logRotate" : {
               "sizeThresholdMB" : <number>,
               "timeThresholdHrs" : <integer>,
               "numUncompressed": <integer>,
               "percentOfDiskspace" : <number>
           }
       },
       ...
   ],

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - backupVersions
     - array
     - *Optional*. Documents that define version information for each
       Backup Agent.
   * - \- name
     - string
     - The desired version of the Backup Agent (e.g. "1.5.1.83-1").
   * - \- hostname
     - string
     - The hostname of the machine that runs the Backup Agent. If the
       Backup Agent is not running on the machine, |mms| installs the
       agent from the location specified in ``backupVersions.urls``.
   * - \- urls
     - document
     - The platform- and build-specific URLs from which to download the
       Backup Agent.
   * - \- \- <platform>
     - document
     - This field has a name that identifies an operating system and
       optionally a version. The field contains a document with key-value
       pairs, where each key is either the name of a build or ``default``
       and each value is a URL for downloading the Backup Agent. The
       document must include the ``default`` key set to the default
       download URL for the platform.
   * - \- baseUrl
     - string
     - The base URL used for the ``mothership`` and ``https`` settings in
       the :doc:`/reference/backup-agent`. For example, for
       ``"baseUrl"=https://mms-qa.mongodb.com``, the backup configuration
       fields would have these values:
       ``mothership=api-backup-qa.mongodb.com`` and ``https"=true``.
   * - \- logPath
     - string
     - *Optional*. The directory where the agent stores its logs. The
       default is to store logs in ``/dev/null``.
   * - \- logRotate
     - document
     - *Optional*. Enables log rotation for the MongoDB logs for a
       process.
   * - \- \- sizeThresholdMB
     - number
     - The maximum size in MB for an individual log file before rotation.
   * - \- \- timeThresholdHrs
     - integer
     - The maximum time in hours for an individual log file before
       rotation.
   * - \- \- numUncompressed
     - integer
     - *Optional*. The maximum number of total log files to leave
       uncompressed, including the current log file. The default is ``5``.
   * - \- \- percentOfDiskspace
     - number
     - *Optional*. The maximum percentage of total disk space all log
       files should take up before deletion. The default is ``.02``.

processes
~~~~~~~~~

.. code-block:: cfg

   "processes" : [
       {
           "name" : <string>,
           "processType" : <string>,
           "version" : <string>,
           "<args>" : <document>,
           "disabled" : <Boolean>,
           "manualMode" : <Boolean>,
           "hostname" : <string>,
           "cluster": <string>,
           "numCores": <integer>,
           "logRotate" : {
               "sizeThresholdMB" : <number>,
               "timeThresholdHrs" : <integer>,
               "numUncompressed": <integer>,
               "percentOfDiskspace" : <number>
           },
           "authSchemaVersion": <integer>,
           "alias": <string>
       },
       ...
   ]

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - processes
     - array
     - The ``processes`` array contains documents that define the
       :program:`mongos` and :program:`mongod` instances that |mms|
       monitors. Each document defines a different instance.
   * - \- name
     - string
     - A unique name to identify the instance.
   * - \- processType
     - string
     - Either ``mongod`` or ``mongos``.
   * - \- version
     - string
     - The name of the ``mongoDbVersions`` specification used with
       this instance.
   * - \- <args>
     - document
     - This field is named either ``args2_6``, for MongoDB versions 2.6
       and higher (including 3.0 and higher), or ``args2_4``, for versions
       2.4 and earlier. The field contains a MongoDB configuration
       document in the format appropriate to the version. For information
       on format and supported MongoDB options, see :doc:`supported
       configuration options
       </reference/cluster-configuration-process-options>`.
   * - \- disabled
     - Boolean
     - *Optional*. Set to ``true`` to shut down the process.
   * - \- manualMode
     - Boolean
     - *Optional*. Set to ``true`` to operate this process in manual mode.
       The Automation Agent will take no actions on the process.
   * - \- hostname
     - string
     - *Optional*. The name of the host this process should run on. This
       defaults to ``localhost``.
   * - \- cluster
     - string
     - *Optional*. Required for a :program:`mongos`. The name of the
       cluster. This must correspond to the ``sharding.name`` field
       in the ``sharding`` array for the :program:`mongos`.
   * - \- numCores
     - integer
     - *Optional*. The number of cores the process should be bound to. The
       Automation Agent will spread processes out across the cores as
       evenly as possible.
   * - \- logRotate
     - document
     - *Optional*. Enables log rotation for the MongoDB logs for a
       process.
   * - \- \- sizeThresholdMB
     - number
     - The maximum size in MB for an individual log file before rotation.
   * - \- \- timeThresholdHrs
     - integer
     - The maximum time in hours for an individual log file before
       rotation.
   * - \- \- numUncompressed
     - integer
     - *Optional*. The maximum number of total log files to leave
       uncompressed, including the current log file. The default is ``5``.
   * - \- \- percentOfDiskspace
     - number
     - *Optional*. The maximum percentage of total disk space all log
       files should take up before deletion. The default is ``.02``.
   * - \- authSchemaVersion
     - integer
     - *Optional*. The schema version of the user credential documents.
       This should match all other elements of the ``processes`` array
       that belong to the same cluster. The possible values are ``1``,
       ``3``, and ``5``. The default is ``3`` for ``2.6`` clusters and
       ``1`` for ``2.4`` clusters.
   * - \- alias
     - string
     - *Optional*. A hostname alias (often a DNS CNAME) for the server on
       which the process runs. If an alias is specified, the Automation
       Agent prefers the alias over the host specified in
       ``processes.hostname`` when connecting to the server. You can
       also specify this alias in ``replicaSets.host`` and
       ``sharding.configServer``.

replicaSets
~~~~~~~~~~~

.. code-block:: cfg

   "replicaSets" : [
       {
           "_id" : <string>,
           "members" : [
               {
                   "_id" : <integer>,
                   "host" : <string>
               },
               ...
           ]
       },
       ...
   ]

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - replicaSets
     - array
     - *Optional*. Documents that define the configuration of each
       :term:`replica set`. The Automation Agent uses the values in this
       array to create valid :manual:`replica set configuration documents
       </reference/replica-configuration>`. The agent regularly checks
       that replica sets are configured correctly. If a problem occurs,
       the agent reconfigures the replica set according to its
       configuration document. The array can contain the following fields
       from a replica set configuration document: ``_id``; ``version``;
       and ``members``. The ``members.host`` field must specify the host's
       name as listed in ``processes.name``. The Automation Agent expands
       the ``host`` field to create a valid replica set configuration
       document.

sharding
~~~~~~~~

.. code-block:: cfg

   "sharding" : [
       {
           "name" : <string>,
           "configServer" : [ <string>, ... ],
           "collections" : [
               {
                   "_id" : <string>,
                   "key" : [
                       [ shard key ],
                       [ shard key ],
                       ...
                   ]
               },
               ...
           ],
           "shards" : [
               {
                   "_id" : <string>,
                   "rs" : <string>
               },
               ...
           ]
       },
       ...
   ]

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - sharding
     - array
     - *Optional*. Documents that define the configuration of each
       :term:`sharded cluster`. Each document in the array contains the
       specifications for one cluster. The Automation Agent regularly
       checks each cluster's state against the specifications. If the
       specification and cluster don't match, the agent will change the
       configuration of the cluster, which might cause the balancer to
       migrate chunks.
   * - \- name
     - string
     - The name of the cluster. This must correspond with the value in
       ``processes.cluster`` for a :program:`mongos`.
   * - \- configServer
     - array
     - String values that provide the names of each :term:`config server's
       <config server>` hosts. The host names are the same names as are
       used in each host's ``processes.name`` field.
   * - \- collections
     - array
     - Documents that define the sharded :term:`collections <collection>`
       and their :term:`shard keys <shard key>`.
   * - \- \- _id
     - string
     - The :term:`namespace` of the sharded collection. The namespace is
       the combination of the database name and the name of the
       collection. For example, ``testdb.testcoll``.
   * - \- \- key
     - array
     - The collection's :term:`shard keys <shard key>`. This "array of
       arrays" contains a single array if there is a single shard key and
       contains multiple arrays if there is a compound shard key.
   * - \- shards
     - array
     - Documents that define the cluster's :term:`shards <shard>`.
   * - \- \- _id
     - string
     - The name of the shard.
   * - \- \- rs
     - string
     - The name of the shard's replica set, as specified in the
       ``replicaSets._id`` field.

balancer
~~~~~~~~

.. code-block:: cfg

   "balancer": {
       "<clusterName1>": <document>,
       "<clusterName2>": <document>,
       ...
   }

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - balancer
     - document
     - *Optional*. This document contains fields named according to
       clusters, each field containing a document with the desired
       balancer settings for the cluster. The document uses the
       ``stopped`` and ``activeWindow`` fields, as described in the
       procedure to schedule the balancing window :manual:`in this
       tutorial </tutorial/manage-sharded-cluster-balancer>` in the
       MongoDB manual.

auth
~~~~

.. code-block:: cfg

   "auth" : {
       "autoUser": <string>,
       "autoPwd": <string>,
       "key" : <string>,
       "keyfile" : <string>,
       "usersDeleted" : [
           {
               "user" : <string>,
               "dbs" : [ <string>, ... ],
               "allDbs" : <Boolean>
           },
           ...
       ],
       "usersWanted" : [
           {
               "db" : <string>,
               "user" : <string>,
               "roles" : [ <string>, ... ],
               "pwd" : <32-character hex string>,
               "initPwd" : <string>,
               "userSource" : <string>,
               "otherDBRoles" : {
                   <string> : [ <string>, ....],
                   ...
               }
           },
           ...
       ]
   }

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - auth
     - document
     - *Optional*. Defines :manual:`authentication
       </core/authentication>`-related settings.
   * - \- autoUser
     - string
     - The username that that the Automation agent uses when connecting to
       an instance.
   * - \- autoPwd
     - string
     - The password that that the Automation agent uses when connecting to
       an instance.
   * - \- key
     - string
     - The contents of the key file that |mms| uses to authenticate to the
       MongoDB processes.
   * - \- keyfile
     - string
     - The path and name of the key file that |mms| uses to authenticate
       to the MongoDB processes.
   * - \- usersDeleted
     - array
     - *Optional*. Documents that define the authenticated users to be
       deleted from specified databases or from all databases. This array
       must contain two fields: the ``auth.usersDeleted.user`` field
       and then either the ``auth.usersDeleted.dbs`` or the
       ``auth.usersDeleted.allDbs`` field.
   * - \- \- user
     - string
     - The user's name.
   * - \- \- dbs
     - array
     - String values that list the names of the databases from which the
       authenticated user is to be deleted. If you use this field, **do
       not** use the ``auth.usersDeleted.allDbs`` field.
   * - \- \- allDbs
     - Boolean
     - If set to ``true``, the authenticated user is deleted from all
       databases. If you use this field, **do not** use the
       ``auth.usersDeleted.dbs`` field.
   * - \- usersWanted
     - array
     - *Optional*. Contains documents that define authenticated users to
       add to specified databases. Each document must have the
       ``auth.usersWanted.db``, ``auth.usersWanted.user``, and
       ``auth.usersWanted.roles`` fields, and then have exactly one
       of the following fields: ``auth.usersWanted.pwd``,
       ``auth.usersWanted.initPwd``, or
       ``auth.usersWanted.userSource``.
   * - \- \- db
     - string
     - The database to which to add the user.
   * - \- \- user
     - string
     - The name of the user.
   * - \- \- roles
     - array
     - String values that list the :term:`roles <role>` to be assigned the
       user from the user's database, which is specified in ``auth.usersWanted.db``.
   * - \- \- pwd
     - 32-character hex string
     - The :ref:`MONGODB-CR <security-mongodb-cr>` hash of the password
       assigned to the user. If you set this field, **do not** set the
       ``auth.usersWanted.initPwd`` or
       ``auth.usersWanted.userSource`` fields.
   * - \- \- initPwd
     - string
     - An initial cleartext password assigned to the user. If you set this
       field, **do not** set the ``auth.usersWanted.pwd`` or
       ``auth.usersWanted.userSource`` fields.
   * - \- \- userSource
     - string
     - If you use MongoDB version 2.4, you can use this field to specify
       the database that contains the user's credentials. See the
       `Privilege Documents page in the MongoDB 2.4 manual
       <http://docs.mongodb.org/v2.4/reference/privilege-documents/>`_. If
       you set this field, **do not** set the
       ``auth.usersWanted.pwd`` or ``auth.usersWanted.initPwd``
       fields.
   * - \- \- otherDBRoles
     - document
     - *Optional*. If the ``auth.usersWanted.db`` field specifies
       ``admin`` as the user's database, then this document can assign to
       the user roles from other databases as well. The document contains
       key-value pairs where the key is the name of the database and the
       value is an array of string values that list the roles be assigned
       from that database.

ssl
~~~

SSL is available only in `MongoDB Enterprise
<http://www.mongodb.com/products/mongodb-enterprise>`_ or a build of MongoDB
:about:`compiled with SSL support </contributors/tutorial/build-mongodb-from-source>`.

.. code-block:: cfg

   "ssl" : {
       "CAFilePath" : <string>,
   }

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - ssl
     - document
     - *Optional*. Enables SSL for encrypting connections. SSL is
       available only in `MongoDB Enterprise
       <http://www.mongodb.com/products/mongodb-enterprise>`_ or a build
       of MongoDB :about:`compiled with SSL support
       </contributors/tutorial/build-mongodb-from-source>`.
   * - \- CAFilePath
     - string
     - The path to the certificate used to authenticate through SSL.

audit
~~~~~

Auditing is available only in `MongoDB Enterprise
<http://www.mongodb.com/products/mongodb-enterprise>`_.

.. code-block:: cfg

   "audit" : {
       "destination" : <string>,
       "format" : <string>,
       "path" : <string>,
       "filter" : <string>
   }

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - audit
     - document
     - *Optional*. Enables auditing. Auditing is available only in
       `MongoDB Enterprise
       <http://www.mongodb.com/products/mongodb-enterprise>`_. The
       ``audit`` document contains the same fields as the ``auditLog``
       option in the :manual:`MongoDB configuration options
       </reference/configuration-options>` and uses the same syntax for
       the values of each field, with the exception of the ``path`` field,
       which is appended with -*ProcessName*.*lowercase(Format)*.

roles
~~~~~

.. code-block:: cfg

   "roles" : [
       {
           "role" : <string>,
           "db" : <string>,
           "privileges" : [
               {
                   "resource" : { ... },
                   "actions" : [ <string>, ... ]
               },
               ...
           ],
           "roles" : [
               {
                   "role" : <string>,
                   "db" : <string>
               }
           ]

       },
       ...
   ]

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - roles
     - array
     - *Optional*. The ``roles`` array contains documents that
       describe the cluster's user-defined roles. Each document describes
       a different user-defined role. Documents in this array contain the
       same fields as documents in the :manual:` system roles collection
       </reference/system-roles-collection>`, except for the ``_id``
       field, which is not included here.

mongoDbVersions
~~~~~~~~~~~~~~~

The :data:`mongoDbVersions` array defines specification documents for the
MongoDB instances found in the :data:`processes` array. Each MongoDB
instance in the :data:`processes` array must have a specification document
in this array.

.. code-block:: cfg

   "mongoDbVersions" : [
       {
           "name" : <string>,
           "builds" : [
               {
                   "platform" : <string>,
                   "url" : <string>,
                   "gitVersion" : <string>,
                   "bits" : <integer>,
                   "win2008plus" : <Boolean>,
                   "winVCRedistUrl" : <string>,
                   "winVCRedistOptions" : [ <string>, ... ],
                   "winVCRedistDll" : <string>,
                   "winVCRedistVersion" : <string>
               },
               ...
           ],
       },
       ...
   ]

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - mongoDbVersions
     - array
     - The ``mongoDbVersions`` array is required and defines specification
       documents for the MongoDB instances found in the ``processes``
       array. Each MongoDB instance in ``processes`` must have a
       specification document in ``mongoDbVersions``.
   * - \- name
     - string
     - The name of the specification document. The specification document
       is attached to a MongoDB instance through the instance's
       ``processes.version`` field in this configuration file.
   * - \- builds
     - array
     - Documents that define the builds for this MongoDB instance.
   * - \- \- platform
     - string
     - The platform for this MongoDB instance.
   * - \- \- url
     - string
     - The URL from which to download MongoDB for this instance.
   * - \- \- gitVersion
     - string
     - The commit identifier that identifies the state of the code used to
       build the MongoDB process. The MongoDB :manual:`buildInfo
       </reference/command/buildInfo>` command returns the gitVersion
       identifier.
   * - \- \- bits
     - integer
     - The processor's bus width. Specify either ``64`` or ``32``.
   * - \- \- win2008plus
     - Boolean
     - *Optional*. Set to ``true`` if this is a Windows build that
       requires either Windows 7 later or Windows Server 2008 R2 or later.
   * - \- \- winVCRedistUrl
     - string
     - *Optional*. The URL from which the required version of the
       Microsoft Visual C++ redistributable can be downloaded.
   * - \- \- winVCRedistOptions
     - array
     - *Optional*. String values that list the command-line options to be
       specified when running the Microsoft Visual C++ redistributable
       installer. Each command-line option is a separate string in the
       array.
   * - \- \- winVCRedistDll
     - string
     - *Optional*. The name of the Microsoft Visual C++ runtime DLL file
       that the agent will check to determine if a new version of the
       Microsoft Visual C++ redistributable is needed.
   * - \- \- winVCRedistVersion
     - string
     - *Optional*. The minimum version of the Microsoft Visual C++ runtime
       DLL that must be present to skip over the installation of the
       Microsoft Visual C++ redistributable.

options
~~~~~~~

.. code-block:: cfg

   "options" : {
       "downloadBase" : <string>
   }

.. list-table::
   :widths: 30 10 80
   :header-rows: 1

   * - Name
     - Type
     - Description
   * - options
     - document
     - 
   * - \- downloadBase
     - string
     - The path to the directory where automatic version downloads are
       targeted and scripts for starting processes are created.
