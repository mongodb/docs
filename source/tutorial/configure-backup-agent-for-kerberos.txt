=======================================
Configure the Backup Agent for Kerberos
=======================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

:term:`MongoDB Enterprise` provides support for Kerberos. Kerberos is a
network authentication protocol available in MongoDB Enterprise version 
2.4 or later. The :term:`Backup Agent` can authenticate to MongoDB 
instances using Kerberos.

.. include:: /includes/note-manage-agent-auth-with-automation-kerberos.rst

Prerequisites
-------------

Configure KDC to Issue Tickets with Four-Hour Minimum Lifetime
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Kerberos tickets are only valid, or used to authenticate users, for a limited
time. You must configure the Kerberos Key Distribution Center (KDC) to issue
tickets that are valid for at least four hours. The Backup Agent
periodically renews the ticket. The KDC service provides session tickets and
temporary session keys to users and computers.

Add Kerberos as Authentication Mechanism for Deployment
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-access-control-host-settings.rst

Configure Backup Agent Host to Use Kerberos
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/note-needed-kerberos-files-for-agent.rst

Create Kerberos Service Principal for the Backup Agent
------------------------------------------------------

.. include:: /includes/steps/kerberos-create-principal.rst

Create a User and Assign Roles for the Backup Agent SPN
-------------------------------------------------------

.. include:: /includes/fact-kerberos-principal-as-user.rst

From a :program:`mongo` shell connected to your MongoDB deployment, issue the
following commands to create the users:

MongoDB 3.0 or Later
~~~~~~~~~~~~~~~~~~~~

.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<Kerberos Principal>",
        roles: [
           { role: "backup", db: "admin" }
        ]
      }
   )

MongoDB 2.6
~~~~~~~~~~~

.. code-block:: javascript

   use $external
   db.createUser(
      {
        user: "<Kerberos Principal>",
        roles: [ 
           "clusterAdmin",
           "readAnyDatabase",
           "userAdminAnyDatabase",
           { role: "readWrite", db: "admin" },
           { role: "readWrite", db: "local" },
        ]
      }
   )

See :doc:`/reference/required-access-backup-agent` for more information on the
required access.

Edit the Backup Agent Configuration File
----------------------------------------

Edit the Backup Agent configuration file. The following table lists the
default installation paths for some common platforms. Depending on your
deployment, you may need to substitute the default path for the custom
installation path used for your |mms| agent installation.

.. list-table::
   :header-rows: 1
   :widths: 40 60

   * - Platform
     - Path

   * - RHEL, Ubuntu
     - ``/etc/mongodb-mms/backup-agent.config``

   * - Linux Archive, Mac OS X
     - ``<userSelected>/local.config``

   * - Windows
     - ``C:\MMSData\Backup\local.config``

.. include:: /includes/steps/kerberos-agent-config-file.rst
