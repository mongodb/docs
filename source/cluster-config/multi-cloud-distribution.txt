.. _create-cluster-multi-region:

==================================================
Configure High Availability and Workload Isolation
==================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. tip::

   You can create multi-cloud MongoDB deployments in |service| using any
   combination of cloud providers: |aws|, |azure|, and |gcp|.

You can set the nodes in your MongoDB deployment to use different:

- Cloud providers
- Geographic regions
- Workload priorities
- Replication configurations

Using these options allows you to improve the availability and workload
balancing of your cluster.

To configure node-specific options for your cluster, toggle
:guilabel:`Multi-Cloud, Multi-Region & Workload Isolation (M10+ clusters)`
to :guilabel:`On`.

.. figure:: /images/multi-cloud.png
   :figwidth: 720px
   :alt: Multi-Cloud Provider, Multi-Region & Workload Isolation feature

A cluster may be hosted in:

- Multiple regions within a single cloud provider.
- Multiple regions across multiple cloud providers.

As each cloud provider has its own set of regions, multi-cloud
clusters are also multi-region clusters.

Considerations
--------------

- .. include:: /includes/cluster-settings/node-type-topology-warning.rst

- In sharded clusters, |service| distributes the three config server 
  nodes based on the number of electable regions in the cluster. If the
  cluster has:

  - Only one electable region, |service| deploys all three config
    nodes in that region.
  - Two electable regions, |service| deploys two config nodes in the
    highest priority region and one config node in the second highest
    priority region.
  - Three or more electable regions, |service| deploys one config node
    in each of the three highest priority regions.

- Having a large number of regions or having nodes spread across
  long distances may lead to long election times or replication lag.

- .. include:: /includes/facts/cross-region-limits.rst

- |service| provides built-in custom write concerns for multi-region
  clusters. Use these write concerns to ensure your write operations
  propagate to a desired number of regions, thereby ensuring data
  consistency across your regions. To learn more, see
  :ref:`Built-In Custom Write Concerns <built-in-custom-wc>`.

- .. include:: /includes/extracts/fact-no-node-restriction-base.rst

- .. include:: /includes/cluster-settings/multicloud/remove-region-cross-region.rst

- If you plan on creating one or more |vpc| peering connections on
  your first ``M10+`` dedicated paid cluster for the selected region
  or regions, first review the documentation on
  :doc:`VPC Peering Connections </security-vpc-peering>`.

.. _deploy-across-multiple-regions:
.. _deploy-across-multiple-cloud-providers:

Electable Nodes for High Availability
-------------------------------------

.. include:: /includes/cluster-settings/multicloud/electable-nodes-high-avail.rst

Each electable node can:

- Participate in replica set elections.

- Become the :term:`primary` while the majority of nodes in the
  replica set remain available.

.. _config-cloud-providers-regions:
.. _add-electable-node:

Add Electable Nodes
~~~~~~~~~~~~~~~~~~~

You can add electable nodes in one cloud provider and region from the
:guilabel:`Electable nodes for high availability` section.

To add an electable node:

1. Click :guilabel:`Add a provider/region`.
2. Select the cloud provider from the :guilabel:`Provider` dropdown.
3. Select the region from the :guilabel:`Region` dropdown.

   When you change the :guilabel:`Provider` option, the
   :guilabel:`Region` changes to a blank option. If you don't select a
   region, |service| displays an error when you click
   :guilabel:`Create Cluster`.

4. Specify the desired number of :guilabel:`Nodes` for the provider and
   region.

   The total number of electable nodes across all providers and regions
   in the cluster must equal **3**, **5**, or **7**.

|service| considers regions marked with a :icon-fa5:`star` as
recommended. These regions provide higher availability compared to
other regions.

.. seealso::

   - :ref:`AWS Recommended Regions <amazon-aws-availability-zones>`
   - :ref:`GCP Recommended Regions <google-gcp-availability-zones>`
   - :ref:`Azure Recommended Regions <microsoft-azure-availability-zones>`

.. _remove-electable-node:

Remove Electable Nodes
~~~~~~~~~~~~~~~~~~~~~~

To remove a node from a region, click the :icon:`trash-alt` icon to the
right side of that region. You cannot remove a node in the
:guilabel:`Highest Priority` region.

.. seealso::

   :ref:`Multi-Region Cluster Backups <multi-region-cloud-backup>`

Change Electable Nodes to Read-Only Nodes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can change an electable node to a :ref:`read-only node
<deploy-read-only-replicas>` by adding a read-only node and removing an
electable node at the same time. To learn more, see :ref:`<change-workload-purpose>`.

Improve the Availability of a Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To improve the redundancy and availability of a cluster, increase the
number of electable nodes in that region. Every |service| cluster has a
:guilabel:`Highest Priority` region. If your cluster spans multiple
regions, you can select which cloud provider region should be the
:guilabel:`Highest Priority`.

To prevent loss of availability and performance, consider the following
scenarios:

.. list-table::
   :widths: 30 70
   :header-rows: 1
   :stub-columns: 1

   * - Point of Failure
     - How to Prevent this Point of Failure

   * - Cloud Provider
     - Minimum of one node set in all three cloud providers. More than
       one node per region.

   * - Region
     - Minimum of one node set in three or more different regions. More
       than one node per region.

   * - Node
     -
       - Three or more electable nodes in a :guilabel:`Recommended`
         region *or*
       - Three or more electable nodes across two or more regions.

Change the Highest Priority Provider or Region
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you change the :guilabel:`Highest Priority` provider and region in
an active multi-region cluster, |service| selects a new :term:`primary` 
node in the provider and region that you specify (assuming that the number of 
nodes in each provider and region remains the same and nothing else is 
modified).

.. example::

   If you have an active 5-node cluster with the following
   configuration:

   .. list-table::
      :widths: 10 30 30 30
      :header-rows: 1
      :stub-columns: 1

      * - Nodes
        - Provider
        - Region
        - Priority

      * - 3
        - |aws|
        - **us-east-1**
        - Highest

      * - 2
        - |gcp|
        - **us-west3**
        -

   To make the |gcp| **us-west3** nodes the :guilabel:`Highest 
   Priority`, drag its row to the top of your cluster's 
   :guilabel:`Electable nodes` list. After this change, |service| elects a 
   new **PRIMARY** in **us-west3**. |service| doesn't start an initial 
   sync or re-provision hosts when changing this configuration.

.. important::

   Certain circumstances may delay an election of a new
   :term:`primary`.

   .. example::

      A sharded cluster with heavy workloads on its :term:`primary`
      shard may delay the election. This results in not having all
      primary nodes in the same region temporarily.

   To minimize these risks, avoid modifying your primary region during
   periods of heavy workload.

.. _deploy-read-only-replicas:

Read-Only Nodes for Optimal Local Reads
---------------------------------------

Use read-only nodes to optimize local reads in the nodes' respective
service areas.

.. _add-read-only-node:

Add Read-Only Nodes
~~~~~~~~~~~~~~~~~~~

You can add read-only nodes from the
:guilabel:`Read-Only Nodes for Optimal Local Reads` section.

To add a read-only node in one cloud provider and region:

1. Click :guilabel:`Add a provider/region`.
2. Select the cloud provider from the :guilabel:`Provider` dropdown.
3. Select the region from the :guilabel:`Region` dropdown.

   When you change the :guilabel:`Provider` option, the
   :guilabel:`Region` changes to a blank option. If you don't select a
   region, |service| displays an error when you click
   :guilabel:`Create Cluster`.

4. Specify the desired number of :guilabel:`Nodes` for the provider and
   region.

|service| considers regions marked with a :icon-fa5:`star` as
recommended. These regions provide higher availability compared to
other regions.

Read-only nodes don't provide high availability because they don't
participate in :term:`elections <election>`. They can't become the
:term:`primary` for their cluster. Read-only nodes have
distinct :manual:`read preference </core/read-preference>` tags
that allow you to direct queries to desired regions.

.. _remove-read-only-node:

Remove Read-Only Nodes
~~~~~~~~~~~~~~~~~~~~~~ 

To remove all read-only nodes in one cloud provider and region, click
the :icon:`trash-alt` icon to the right of that cloud provider and
region.

.. _change-workload-purpose:

Change Workload Purpose of Nodes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can change a node's workload purpose by adding and removing nodes at the
same time.

.. include:: /includes/fact-changing-node-to-from-read-only.rst

For example, to change a read-only node to an :ref:`electable node <deploy-across-multiple-cloud-providers>`:

1. :ref:`Add an electable node <add-electable-node>`.
2. :ref:`Remove a read-only node <remove-read-only-node>`.
3. Click :guilabel:`Review Changes`.
4. Click :guilabel:`Apply Changes`.

.. _deploy-analytics-nodes:

Analytics Nodes for Workload Isolation
--------------------------------------

.. include:: /includes/cluster-settings/multicloud/create-cluster-analytics-nodes.rst

.. note::

   The :manual:`readPreference </reference/connection-string/#mongodb-urioption-urioption.readPreference>` and 
   :manual:`readPreferenceTags </reference/connection-string/#mongodb-urioption-urioption.readPreferenceTags>` connection
   string options are unavailable for the :manual:`mongo 
   </reference/program/mongo/#mongodb-binary-bin.mongo>` shell. See 
   :manual:`cursor.readPref() 
   </reference/method/cursor.readPref/#mongodb-method-cursor.readPref>` 
   and :manual:`Mongo.setReadPref() 
   </reference/method/Mongo.setReadPref/#mongodb-method-Mongo.setReadPref>` instead.

.. _add-analytics-node:

Add Analytics Nodes
~~~~~~~~~~~~~~~~~~~

You can add analytics nodes from the
:guilabel:`Analytics nodes for workload isolation` section.

To add analytics nodes in one cloud provider and region:

1. Click :guilabel:`Add a provider/region`.
2. Select the cloud provider from the :guilabel:`Provider` dropdown.
3. Select the region from the :guilabel:`Region` dropdown.

   When you change the :guilabel:`Provider` option, the
   :guilabel:`Region` changes to a blank option. If you don't select a
   region, |service| displays an error when you click
   :guilabel:`Create Cluster`.

4. Specify the desired number of :guilabel:`Nodes` for the provider and
   region.

|service| considers regions marked with a :icon-fa5:`star` as
recommended. These regions provide higher availability compared to
other regions.

Analytics nodes don't provide high availability because they don't
participate in :term:`elections <election>`. They can't become the
:term:`primary` for their cluster.

.. _select-analytics-nodes-tier:

Select a {+Cluster+} Tier for Your Analytics Nodes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Your workloads can vary greatly between analytics and operational nodes.
To help manage this issue, for ``M10+`` {+clusters+}, you can 
:ref:`select a {+cluster+} tier <create-cluster-instance>` 
appropriately sized for your analytics workload. You can select a 
{+cluster+} tier for your analytics nodes that's larger or smaller than 
the {+cluster+} tier selected for your electable and read-only nodes 
(operational nodes). This functionality helps to ensure that you get 
the performance required for your transactional and analytical queries 
without over or under provisioning your entire {+cluster+} for your 
analytical workload.

.. include:: /includes/fact-analytics-nodes-autoscaling.rst

After you :ref:`add your analytics nodes <add-analytics-node>`, you can 
:ref:`select a {+cluster+} tier <create-cluster-instance>` 
appropriately sized for your analytics workload.

1. In the :guilabel:`Cluster Tier` section, click the 
   :guilabel:`Analytics Tier` tab.

#. Select the :guilabel:`Cluster Tier`.

Remove Analytics Nodes
~~~~~~~~~~~~~~~~~~~~~~

To remove all analytics nodes in one cloud provider and region, click
the :icon:`trash-alt` icon to the right of that cloud provider and
region.

