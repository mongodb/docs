==========================
Upgrade On Prem MMS Server
==========================

.. default-domain:: mongodb

Prerequisites
-------------

Upgrade |mms| from 1.2 and Earlier
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Due to the `company name change <http://www.mongodb.com/press/10gen-announces-company-name-change-mongodb-inc>`_
the name of the MMS package changed between versions 1.2 and 1.3.
Therefore, to upgrade the |mms| server from *any* version
before 1.3, use the following procedure:

#. *Recommended.* Take a full backup of the MMS database before
   beginning the upgrade procedure.

#. Shut down MMS, using the following command:

   .. code-block:: sh

      /etc/init.d/10gen-mms stop

#. Download the latest package and proceed with the instructions
   for a fresh install. Do not attempt to use your package manager
   to do an upgrade. See
   :doc:`/monitoring/tutorial/install-monitoring-server` for more
   information.

   When complete, |mms| is installed in the ``/opt/mongodb/mms``
   directory.

#. Follow all procedures for a new install include configuring the
   options in ``/opt/mongodb/mms/conf/conf-mms.properties``. If you
   used encrypted authentication credentials you will need to
   regenerate these manually.  *Do not copy the credentials from
   your old properties file. Old credentials will not work.*

#. Start MMS  using the new package name:

   .. code-block:: sh

      sudo /etc/init.d/mongodb-mms start

#. Update any Monitoring Agent. See :ref:`upgrade-mms-agent` for
   more information.

.. END-COMMENT

Upgrade MMS Packages
--------------------

Upgrading an RPM-Based Installation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Please contact MMS to receive the download location of the latest
MMS server release.

#. Shutdown the On-Prem MMS server and take a backup of your existing
   configuration:

   .. code-block:: sh

    sudo /etc/init.d/mongodb-mms stop
    sudo cp -a <install_dir>/conf ~/mms_conf.backup

#. Perform an RPM upgrade:

   .. code-block:: sh

      sudo rpm -Uvh 10gen-mms-<version>.x86_64.rpm

#. Reconcile any changes in configuration files.

   At this point the upgrade is complete. However you may need to reconcile
   changes in your configuration with new configuration options
   available in the latest release.

   During the ``rpm`` operation, if you saw the following output, you
   have changes to reconcile:

   .. code-block:: none

       warning: <install_dir>/conf/conf-mms.properties created as    <install_dir>/conf/conf-mms.properties.rpmnew

   Compare your current configuration to the updated version, with the
   following sequence of operations:

   .. code-block:: sh

      diff -u <install_dir>/conf/conf-mms.properties <install_dir>/conf/conf-mms.properties.rpmnew
      diff -u <install_dir>/conf/mms.conf <install_dir>/conf/mms.conf.rpmnew

   Edit your configuration to resolve any conflicts between the old
   and new versions, being sure to take any new changes from
   ``conf-mms.properties.rpmnew`` as appropriate. Changes to
   ``mms.centralUri``, email addresses, and MongoDB are the most
   common configuration changes.

   Repeat the above reconciliation for ``mms.conf`` if the upgrade
   indicates a conflict.

   .. note::

      The upgrade from beta versions 1.0.1 to 1.0.2 changed several
      paths to make the MMS server completely self contained. In
      1.0.2 all logs, configuration, and working files are in the
      ``/opt/10gen/mms/`` hierarchy. This changes the following paths
      from 1.0.1:

      - New logs path:  <install_dir>/logs/
      - New tmp path:  <install_dir>/tmp/

      Finally, you may also need to re-symlink your startup script:

      .. code-block:: sh

         sudo ln -s /<install_dir>/bin/mongodb-mms /etc/init.d/mongodb-mms

#. Restart the On-Prem MMS server.

   .. code-block:: sh

      sudo /etc/init.d/mongodb-mms start

Upgrading a ``tgz``/``zip`` Installation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To upgrade a tarball installation, backup configuration and/or logs,
and then re-install the On-Prem MMS server.

.. important:: It is crucial that you back up the existing
   configuration because the upgrade process will delete existing
   data.

In more details:

#. Shutdown the MMS server and take a backup of your existing
   configuration and logs.

   .. code-block:: sh

      sudo /etc/init.d/mongodb-mms stop
      sudo cp -a <install_dir>/conf ~/mms_conf.backup
      sudo cp -a <install_dir>/logs ~/mms_logs.backup

#. Remove your existing MMS server installation entirely and extract
   latest release in its place:

   .. code-block:: sh

      cd <install_dir>/../
      sudo rm -rf <install_dir>
      sudo tar -zxf -C . /path/to/10gen-mms-<version>.x86_64.tar.gz

#. Similar to the RPM upgrade path above, compare and reconcile any
   changes in configuration between versions:

   .. code-block:: sh

      diff -u ~/mms_conf.backup/conf-mms.properties <install_dir>/conf/conf-mms.properties
      diff -u ~/mms_conf.backup/mms.conf <install_dir>/conf/mms.conf

#. Edit your configuration to resolve any conflicts between the old
   and new versions, being sure to take any new changes as
   appropriate.

   .. note::

      Changes to ``mms.centralUri``, email addresses, and MongoDB are
      the most common configuration changes.

#. Restart the On-Prem MMS server.

   .. code-block:: sh

      sudo /etc/init.d/mongodb-mms start
