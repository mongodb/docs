=======================================================
Configure MongoDB with Kerberos Authentication on Linux
=======================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol


Overview
--------

MongoDB Enterprise supports authentication using a :doc:`Kerberos
service </core/kerberos>`. Kerberos is an industry standard
authentication protocol for large client/server systems.

Prerequisites
-------------

Setting up and configuring a Kerberos deployment is beyond the scope of
this document. This tutorial assumes you have configured a
:ref:`Kerberos service principal <kerberos-service-principal>` for each
:binary:`~bin.mongod` and :binary:`~bin.mongos` instance in your MongoDB
deployment, and you have a valid :ref:`keytab file <keytab-files>` for
for each :binary:`~bin.mongod` and :binary:`~bin.mongos` instance.

.. include:: /includes/fact-kerberos-FQDN-repica-sets.rst

.. include:: /includes/fact-confirm-enterprise-binaries.rst

Procedure
---------

The following procedure outlines the steps to add a Kerberos user
principal to MongoDB, configure a standalone :binary:`~bin.mongod` instance
for Kerberos support, and connect using the :binary:`~bin.mongo` shell and
authenticate the user principal.

.. include:: /includes/steps/control-access-to-mongodb-with-kerberos-authentication.rst

Additional Considerations
-------------------------

.. _setting-krb5_ktname:

KRB5_KTNAME
~~~~~~~~~~~

If you installed MongoDB Enterprise using one of the official ``.deb``
or ``.rpm`` packages, and you use the included init/upstart scripts to
control the :binary:`~bin.mongod` instance, you can set the ``KRB5_KTNAME``
variable in the default environment settings file instead of setting
the variable each time.

For ``.rpm`` packages, the default environment settings file is
:file:`/etc/sysconfig/mongod`.

For ``.deb`` packages, the file is :file:`/etc/default/mongodb`.

Set the ``KRB5_KTNAME`` value in a line that resembles the following:

.. code-block:: javascript

   KRB5_KTNAME="<path to keytab>"

Configure ``mongos`` for Kerberos
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To start :binary:`~bin.mongos` with Kerberos support, set the environmental
variable ``KRB5_KTNAME`` to the path of its :ref:`keytab file
<keytab-files>` and the :binary:`~bin.mongos` parameter
:parameter:`authenticationMechanisms` to ``GSSAPI`` in the following form:

.. code-block:: sh

   env KRB5_KTNAME=<path to keytab file> \
   mongos \
   --setParameter authenticationMechanisms=GSSAPI \
   <additional mongos options>

.. include:: /includes/extracts/default-bind-ip-security-additional-command-line.rst


For example, the following starts a :binary:`~bin.mongos` instance with
Kerberos support:

.. code-block:: sh

   env KRB5_KTNAME=/opt/mongodb/mongos.keytab \
   mongos \
   --setParameter authenticationMechanisms=GSSAPI \
   --configdb shard0.example.net, shard1.example.net,shard2.example.net \
   --keyFile /opt/mongodb/mongos.keyfile \
   --bind_ip localhost,<hostname(s)|ip address(es)>

The path to your :binary:`~bin.mongos` as well as your :ref:`keytab file
<keytab-files>` may differ. The :ref:`keytab file <keytab-files>` must
be only accessible to the owner of the :binary:`~bin.mongos` process.

Modify or include any additional :binary:`~bin.mongos` options as required
for your configuration. For example, instead of using
:option:`--keyFile <mongos --keyFile>` for internal authentication of sharded cluster
members, you can use :ref:`x.509 member authentication
<x509-internal-authentication>` instead.

Use a Config File
~~~~~~~~~~~~~~~~~

To configure :binary:`~bin.mongod` or :binary:`~bin.mongos` for Kerberos
support using a :doc:`configuration file
</reference/configuration-options>`, specify the
:parameter:`authenticationMechanisms` setting in the configuration file.

If using the :doc:`YAML configuration file format
</reference/configuration-options>`:

.. code-block:: yaml

   setParameter:
      authenticationMechanisms: GSSAPI

.. include:: /includes/extracts/default-bind-ip-security-additional-config-file.rst

For example, if :file:`/opt/mongodb/mongod.conf` contains the following
configuration settings for a standalone :binary:`~bin.mongod`:

.. code-block:: yaml

   security:
      authorization: enabled
   setParameter:
      authenticationMechanisms: GSSAPI
   storage:
      dbPath: /opt/mongodb/data
   net:
      bindIp: localhost,<hostname(s)|ip address(es)>


To start :binary:`~bin.mongod` with Kerberos support, use the following
form:

.. code-block:: sh

   env KRB5_KTNAME=/opt/mongodb/mongod.keytab \
   /opt/mongodb/bin/mongod --config /opt/mongodb/mongod.conf

The path to your :binary:`~bin.mongod`, :ref:`keytab file <keytab-files>`,
and configuration file may differ. The
:ref:`keytab file <keytab-files>` must be only accessible to the owner
of the :binary:`~bin.mongod` process.

Troubleshoot Kerberos Setup for MongoDB
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you encounter problems when starting :binary:`~bin.mongod` or
:binary:`~bin.mongos` with Kerberos authentication, see
:doc:`/tutorial/troubleshoot-kerberos`.

.. _enable-mixed-kerberos-and-cr:

Incorporate Additional Authentication Mechanisms
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Kerberos authentication (:ref:`GSSAPI <security-auth-kerberos>` (Kerberos))
can work alongside:

- MongoDB's SCRAM authentication mechanism:

  - :ref:`SCRAM-SHA-1 <authentication-scram>` 

  - :ref:`SCRAM-SHA-256 <authentication-scram>` (*Added in MongoDB 4.0*)

- MongoDB's authentication mechanism for LDAP:

  - :ref:`PLAIN <security-auth-ldap>` (LDAP SASL)
 
- MongoDB's authentication mechanism for x.509:

  - :ref:`MONGODB-X509 <security-auth-x509>`)

Specify the mechanisms as follows:

.. code-block:: sh

   --setParameter authenticationMechanisms=GSSAPI,SCRAM-SHA-256

Only add the other mechanisms if in use. This parameter setting does
not affect MongoDB's internal authentication of cluster members.
