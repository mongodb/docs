================
Restore Overview
================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

To restore a deployment from a backup, select a point in time from which
you want to restore your database. |mms| provides you with the files
from which you can restore your database.

You can restore a single MongoDB database, a :term:`replica set`, or a
:term:`sharded cluster`. You may select to restore from:

- An existing :term:`snapshot`,
- A specific point in time,
- A specific oplog timestamp, or
- A specific :term:`sharded cluster` :term:`checkpoint`.

If you are not restoring from an existing snapshot, you must download
the MongoDB Backup Restore Utility to your target host. The :abbr:`MBRU
(MongoDB Backup Restore Utility)` requests and applies :term:`oplog`
entries between the latest complete snapshot and the point in time you
chose.

.. note::
   For sharded clusters,
   :ref:`enable checkpoints <enable-cluster-checkpoints>` before
   restoring to a point between snapshots.

You can restore your backup in one of two ways:

- |mms| can
  :ref:`restore the files to another cluster <mms-automated-restore>`
  if you use |mms| automation.
- You can copy restored files
  :ref:`manually to the hosts you choose <mms-manual-restore>`.

.. _mms-automated-restore:

Automated Restore
-----------------

If you choose to have |mms| automation restore your backup, the
:term:`Automation Agent` removes all existing data from the target hosts
and replaces that data with new backup data from your :term:`snapshot`.

Prerequisites
~~~~~~~~~~~~~

To perform automated restores, you must have:

- An :term:`Automation Agent` installed on the source and all target
  hosts.

- A :term:`Monitoring Agent` on the target deployment that can connect
  to all hosts in the target deployment.

- The :ref:`Backup Admin <backup-admin-role>` and
  :ref:`Automation Admin <automation-admin-role>` roles in |mms|.

Restore to Different Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/fact-restore-different-group-requirements.rst

Potential Causes for Automated Restore Failure
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

An automated restore can fail when certain storage settings of the
backup's database and target database do not match:

- :setting:`storage.engine`
- :setting:`storage.directoryPerDB`
- :setting:`storage.mmapv1.nsSize`
- :setting:`storage.mmapv1.smallFiles`
- :setting:`storage.wiredTiger.collectionConfig.blockCompressor`
- :setting:`storage.wiredTiger.engineConfig.directoryForIndexes`

No method exists to check for mismatches before attempting a restore. If
a restore attempt fails, |mms| displays any mismatched settings. If you
still want to restore the backup's database, fix the settings in the
target database that do not match backup's database, then retry the
restoring the backup's database.

Restore Procedures
~~~~~~~~~~~~~~~~~~

To perform an automated restore, see the procedure for the deployment
you want to restore:

- :ref:`Single Database <restore-from-queryable-backup>`
- :ref:`Replica Set <automatic-restore-replica-set>`
- :ref:`Sharded Cluster <automatic-restore-sharded-cluster>`

.. _mms-manual-restore:

Manual Restore
--------------

Prerequisites
~~~~~~~~~~~~~

To perform manual restores, you must have the
:ref:`Backup Admin <backup-admin-role>` role in |mms|.

.. _delivery-methods-file-formats:

Considerations
~~~~~~~~~~~~~~

Restore File Format
+++++++++++++++++++

.. only:: onprem

   |mms| provides each :term:`snapshot` as an uncompressed (``.tar``)
   or compressed (``.tar.gz``) archive containing a complete copy of the
   data directory.

   Choosing compressed :term:`snapshots <snapshot>` results in faster
   delivery, but requires sufficient space on the target host for both
   the compressed snapshot and its extracted database files.

.. only:: cloud

   |mms| provides each :term:`snapshot` as an uncompressed (``.tar``)
   archive containing a complete copy of the data directory.

- For a :term:`replica set`, |mms| provides one :term:`snapshot` that
  you copy to each replica set member.

- For a sharded cluster, |mms| provides one :term:`snapshot` for the
  :term:`config servers <config server>` and one :term:`snapshot` for
  each :term:`shard`.

File Delivery Methods
+++++++++++++++++++++

With a manual restore, |mms| can deliver the
:term:`snapshots <snapshot>` in two ways:

- Provide a link to download the snapshots through
  :abbr:`HTTP (HyperText Transport Protocol)`.

- Transfer the snapshots to a target directory on a target
  host that you choose using :abbr:`SCP (secure copy)`.

  .. note::
     If you use :abbr:`SCP (secure copy)`, you may choose to transfer
     the individual database files instead of the snapshot as an archive
     file.

  .. include:: /includes/note-scp-key-pair-requirement.rst

  .. include:: /includes/note-windows-scp-issue.rst


.. only:: onprem

   Restore Process Flows
   ~~~~~~~~~~~~~~~~~~~~~

   The following pages illustrate the process flows for manual restores
   using the different restore methods:

   .. include:: /includes/toc/dfn-list-backup-restore-flows.rst

   .. include:: /includes/toc/backup-restore-flows.rst

Manual Restore Procedures
~~~~~~~~~~~~~~~~~~~~~~~~~

To perform a manual restore, see the procedure for the deployment
you want to restore:

- :ref:`Single Database <manual-restore-from-backup>`
- :ref:`Replica Set <manual-restore-replica-set>`
- :ref:`Sharded Cluster <manual-restore-sharded-cluster>`

