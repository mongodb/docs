:orphan:

====================================
Required Access for Monitoring Agent
====================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/legacy-agents/fact-monitoring-agent-deprecated.rst

If your MongoDB deployment enforces access control, the |mms| Monitoring
Agent must authenticate to MongoDB as a user with the proper access.

If you use :ref:`Automation <automation>`, |mms| takes care of this for you.
If you do not use Automation, follow the instructions on this page.

To authenticate, create a user with the appropriate roles in MongoDB.
The following tutorials include instructions and examples for creating
the MongoDB user:

- :doc:`/tutorial/configure-monitoring-agent-for-cr`.

- :doc:`/tutorial/configure-monitoring-agent-for-ldap`.

- :doc:`/tutorial/configure-monitoring-agent-for-kerberos`.

MongoDB user roles are separate from |mms| :doc:`user roles
</reference/user-roles>` and are described in the MongoDB manual beginning
with the :manual:`Authorization </core/authorization>` page.

Considerations
--------------

.. include:: /includes/considerations-agent-access-control.rst

.. important::

   The Monitoring Agent user must be defined consistently for all processes
   in your |mms| deployment.

Prerequisites
-------------

.. include:: /includes/prerequisites-create-user-for-agent.rst

.. _access-control-monitoring-agent-2.6:

MongoDB 2.6
-----------

To monitor MongoDB 2.6 instances, including :dbcommand:`dbStats`
[#dbStats]_ and :doc:`database profiling </tutorial/profile-database>`
information [#profiling]__, the monitoring agent must authenticate to
the database as a user with the following access:

.. list-table::
   :header-rows: 1

   * - Required Role
     -
   * - :authrole:`clusterMonitor` role on the ``admin`` database
     -

For *mixed* MongoDB versions that use Monitoring Agents older than version
3.7.0, the specified access is inadequate to monitor deployments since the
user cannot access the ``local`` database needed for mixed deployments.
Monitoring a mixed deployment as a user with the specified access will
produce an authorization error that will appear in the :program:`mongod`
logs. The pre-3.7.0 Monitoring Agent can recover from this error but
causes the extra log entries. You can safely ignore these extra entries.

.. _access-control-2.4:

MongoDB 2.4
-----------

.. _access-control-2.4-no-profiling:

Monitor without Database Profiling
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To monitor MongoDB 2.4 instances, including :dbcommand:`dbStats`
operations, the agent must authenticate as a user with the following
access:

.. list-table::
   :header-rows: 1

   * - Required Roles
     -

   * - :authrole:`clusterAdmin` role on the ``admin`` database
     -

   * - :authrole:`readAnyDatabase` role on the ``admin`` database
     -

However, a user with the specified access *cannot* monitor with
profiling. If this user tries to monitor with profiling, the
:program:`mongod` log file may report the following message at the
default logging level:

.. code-block:: none

   command denied: { profile: -1 }

You can ignore this message if you do not want |mms| to collect profile
data. If you want to collect profile data, configure |mms| monitoring as
specified in :ref:`access-control-2.4-with-profiling`.

.. _access-control-2.4-with-profiling:

Monitor with Database Profiling
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To monitor MongoDB 2.4 databases with database profiling [#profiling]__,
the agent must authenticate as a user with the following access:

.. list-table::
   :header-rows: 1
   :widths: 60 40

   * - Required Roles
     -

   * - :authrole:`clusterAdmin` role on the ``admin`` database
     -

   * - :authrole:`readAnyDatabase` role on the ``admin`` database
     -

   * - :authrole:`dbAdminAnyDatabase` roles in the ``admin`` database
     -

.. [#profiling]
   :doc:`Profiling </tutorial/profile-database>` captures in-progress read and write
   operations, cursor operations, and database command information about the
   database.

.. _access-control-2.4-no-dbStats:

Monitor without ``dbStats``
~~~~~~~~~~~~~~~~~~~~~~~~~~~

To monitor MongoDB 2.4 databases *without* :dbcommand:`dbStats`
[#dbStats]_, the agent must authenticate as a user with the following
access:

.. list-table::
   :header-rows: 1

   * - Required Role
     -

   * - :authrole:`clusterAdmin` role on the ``admin`` database

     -

Authentication Mechanisms
-------------------------

To authenticate, create the user in MongoDB with the appropriate
access. The authentication method that the MongoDB deployment uses
determines how to create the user as well as determine any additional
agent configuration:

.. include:: /includes/ref-configure-access-control-verbose.rst

.. [#dbStats]
   Monitoring without :dbcommand:`dbStats` excludes database
   storage, records, indexes, and other statistics.
