.. _streams-agg-pipeline-function:
.. _atlas-sp-agg-function:

==============================================
``$function`` (Stream Processing)
==============================================

.. default-domain:: mongodb

.. meta::
   :keywords: atlas stream processing, $function aggregation expression
   :description: Learn how to use the $function expression to run custom JavaScript code locally within the pipeline

.. facet::
   :name: genre
   :values: reference

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. _atlas-sp-agg-function-def:

.. note::

  **Currently, this functionality is only available in Atlas Stream Processing 
  Workspaces deployed to AWS cloud.**


Definition
~~~~~~~~~~

The :expression:`$function` expression specifies a
custom JavaScript function that you can define to run JavaScript code on each document in the stream.

.. _atlas-sp-agg-function-syntax:

Syntax
------

The :expression:`$function` operator has the following syntax:

.. code-block:: javascript

   { 
     $function: {
       body: <code>,
       args: <array expression>,
       lang: "js"
     }
   }

.. list-table::
   :header-rows: 1
   :widths: 20 20 80

   * - Field
     - Type
     - Description
     

   * - :ref:`body <function-body>`

     - String or Code

     - .. _function-body:

       The function definition. You can specify the function
       definition as either BSON type Code or String. See also
       :ref:`lang <function-lang>`.

       ``function(arg1, arg2, ...) { ... }``

       or

       ``"function(arg1, arg2, ...) { ... }"``


   * - :ref:`args <function-args>`

     - Array

     - .. _function-args:

       Arguments passed to the function :ref:`body <function-body>`.
       If the :ref:`body <function-body>` function does not take an
       argument, you can specify an empty array ``[ ]``.

       The array elements can be any BSON type, including Code. See
       :ref:`function-example-where-alternative`.

   * - :ref:`lang <function-lang>`

     - String

     - .. _function-lang:

       The language used in the :ref:`body <function-body>`. You
       must specify ``lang: "js"``.


.. _atlas-sp-agg-function-behavior:

Behavior
--------

The :expression:`$function` expression runs the specified function
on each document in the stream. The function can take arguments
from the document or from the :ref:`args <function-args>` array.

The function can return any BSON type, including an array or a
Code type. The returned value is used as the output of the
:expression:`$function` expression.
