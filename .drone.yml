---
kind: pipeline
type: kubernetes
name: production-build

trigger:
  branch:
    - main
    - DOP-5575
  event:
    - push
    - tag

steps:
  # Builds and publishes Docker image for production
  - name: publish-production
    image: plugins/kaniko-ecr
    settings:
      create_repository: true
      registry: 795250896452.dkr.ecr.us-east-1.amazonaws.com
      repo: docs/${DRONE_REPO_NAME}
      tags:
        - git-${DRONE_COMMIT_SHA:0:7}
        - latest
      context: platform/tools/cdnLogParser
      dockerfile: platform/tools/cdnLogParser/Dockerfile
      access_key:
        from_secret: ecr_access_key
      secret_key:
        from_secret: ecr_secret_key

---
depends_on: ['production-build']
kind: pipeline
type: kubernetes
name: production-deploy

trigger:
  branch:
    - main
    - DOP-5575
  event:
    - push
    - tag

steps:
  # Deploys docker image to production
  - name: deploy-production
    image: quay.io/mongodb/drone-helm:v3
    settings:
      chart: mongodb/cronjobs
      chart_version: 1.21.2
      add_repos: [mongodb=https://10gen.github.io/helm-charts]
      namespace: docs
      release: ${DRONE_REPO_NAME}
      values: image.tag=git-${DRONE_COMMIT_SHA:0:7},image.repository=795250896452.dkr.ecr.us-east-1.amazonaws.com/docs/${DRONE_REPO_NAME}
      values_files: ['platform/tools/cdnLogParser/cronjobs.yml']
      api_server: https://api.prod.corp.mongodb.com
      kubernetes_token:
        from_secret: prod_kubernetes_token
