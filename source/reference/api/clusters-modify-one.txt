================
Modify a Cluster
================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/fact-groups-projects-synonyms.rst

.. include:: /includes/fact-atlas-api-free-tier-limits.rst

.. include:: /includes/api-requirements.rst

.. include:: /includes/api-base-url.rst

Syntax
------

.. code-block:: none

   PATCH /api/atlas/v1.0/groups/{GROUP-ID}/clusters/{CLUSTER-NAME}

Request Path Parameters
~~~~~~~~~~~~~~~~~~~~~~~

.. list-table::
   :header-rows: 1
   :widths: 15 10 75

   * - Path Element
     - Required/Optional
     - Description

   * - ``GROUP-ID``

     - Required.

     - The unique identifier for the :ref:`group <group-id>` containing the
       cluster.

   * - ``CLUSTER-NAME``

     - Required

     - The name of the cluster to modify.

Request Body Parameters
~~~~~~~~~~~~~~~~~~~~~~~

.. important::

   If modifying any of the ``providerSettings`` or ``replicationSpec`` values,
   you *must* specify the ``providerSettings.providerName``. For ``M2`` and
   ``M5`` clusters, you must also specify the
   ``providerSettings.backingProviderName``.

   You cannot modify a ``paused`` cluster other than to resume the
   cluster. Nor can you pause a cluster with pending changes.

.. list-table::
   :widths: 20 10 70
   :header-rows: 1

   * - Name
     - Type
     - Description

   * - ``autoScaling``
     - document
     - *Optional*

       Specify whether to enable/disable disk auto-scaling. The
       document contains ``diskGBEnabled`` field:

       - Set to ``true`` to enable disk auto-scaling.
       - Set to ``false`` to disabled disk auto-scaling.

   * - ``mongoDBMajorVersion``
     - string
     - For a cluster running with MongoDB 3.2, specify ``3.4`` to
       direct |service| to upgrade the cluster to MongoDB 3.4.

       For a cluster running with MongoDB 3.4, specify ``3.6`` to direct
       |service| to upgrade the cluster to MongoDB 3.6.

       You cannot modify this field for ``M2`` or ``M5`` shared tier
       clusters.

       .. include:: /includes/extracts/fact-mongodb-version-downgrade-restriction-scale.rst

   * - ``numShards``
     - integer
     - Selects whether the cluster is a :term:`replica set` or a
       :term:`sharded cluster`.

       If this is set to ``1``, the cluster is a replica set. For more
       information on MongoDB replica sets, see :manual:`Replication
       </replication>` in the MongoDB manual.

       If this is set to ``2`` or higher, the cluster is a sharded cluster
       with the number of shards specified. For more information on sharded
       clusters, see :manual:`Sharding </sharding>` in the MongoDB manual.

       For details on how this setting affects costs, see
       :ref:`server-number-costs`.

       The possible values are ``1`` through ``12``.

   * - ``paused``
     - boolean
     - *Optional* A flag to pause or resume the cluster. Possible values are:

       - ``true`` to pause the cluster. You cannot pause a cluster with
         pending changes.

       - ``false`` to resume the cluster. Default.

       .. note::

          Available for M10+ Clusters.

          You cannot pause a cluster with pending changes. If the
          cluster is paused for 7 days, |service| auto-resumes the
          cluster.

   * - ``providerSettings``
     - document
     - The configuration for the provisioned servers on which MongoDB runs.
       The available options are specific to the cloud service provider.

   * - ``providerSettings.providerName``
     - string
     - The cloud service provider on which the servers are provisioned.

       .. include:: /includes/fact-cloud-service-providers.rst
       - ``TENANT`` - A multi-tenant deployment on one of the supported
         cloud service providers. Only valid when
         ``providerSettings.instanceSizeName`` is either ``M2`` or ``M5``
       
       .. include:: /includes/fact-m2-m5-multi-tenant.rst
          
       You must include this value if modifying any of the other
       ``providerSettings``.

   * - ``providerSettings.backingProviderName``
     - string
     - The cloud service provider on which the server for a multi-tenant 
       cluster is provisioned. This setting is only valid when
       ``providerSettings.providerName`` is ``TENANT`` and 
       ``providerSettings.instanceSizeName`` is ``M2`` or ``M5``.
       
       .. include:: /includes/fact-cloud-service-providers.rst
       
       You must include this value if modifying any of the other
       ``providerSettings``.

   * - ``providerSettings.regionName``
     - string
     - The physical location of your MongoDB cluster. The region you choose
       can affect network latency for clients accessing your databases.

       |service| ignores this value if you specify the ``replicationSpec``
       document.

       .. include:: /includes/fact-group-region-association.rst

       The following regions are valid for ``M10+`` clusters (``M20+``
       for Azure):

       .. list-table::
          :header-rows: 1
          :widths: 20 50

          * - Provider
            - Region Names

          * - AWS
            - .. include:: /includes/fact-aws-region-names.rst

          * - GCP
            - .. include:: /includes/fact-gcp-region-names.rst

          * - AZURE
            - .. include:: /includes/fact-azure-region-names.rst

       The following regions are valid for ``M2`` and ``M5`` clusters:

       .. list-table::
          :header-rows: 1
          :widths: 20 50

          * - Provider
            - Region Names

          * - AWS
            - .. include:: /includes/fact-aws-m2-m5-region-names.rst

          * - GCP
            - .. include:: /includes/fact-gcp-m2-m5-region-names.rst

          * - AZURE

            - .. include:: /includes/fact-azure-m2-m5-region-names.rst

       You must include ``providerSettings.providerName`` if modifying this
       value.

   * - ``providerSettings.instanceSizeName``
     - string
     - |service| provides different instance sizes, each with a default
       storage capacity and RAM size. The instance size
       you select is used for all the data-bearing servers in your cluster.
       For definitions of data-bearing servers, see
       :ref:`server-number-costs`.

       |service| supports the following instance sizes:

       .. list-table::
          :header-rows: 1
          :widths: 20 50

          * - Provider
            - Instance Sizes

          * - AWS
            - .. include:: /includes/extracts/fact-cluster-instance-sizes-AWS.rst

          * - GCP
            - .. include:: /includes/extracts/fact-cluster-instance-sizes-GCP.rst

          * - AZURE

            - .. include:: /includes/extracts/fact-cluster-instance-sizes-AZURE.rst

       .. |ast| unicode:: U+002A

       |ast| :abbr:`AWS (Amazon Web Services)`, 
       :abbr:`GCP (Google Cloud Platform)`, 
       and :abbr:`Azure (Microsoft Azure)` only support 
       ``M2`` and ``M5`` in certain regions. 
       For a complete list of the regions that support ``M2`` and ``M5``
       instances, see providerSettings.regionName.

       You must include ``providerSettings.providerName`` if modifying this
       value.
       
       .. include:: /includes/fact-m2-m5-multi-tenant.rst

   * - ``providerSettings.diskIOPS``
     - integer
     - The maximum input/output operations per second (IOPS) the system can
       perform. The available IOPS depend on the instance size: each instance
       size has a specific set of available IOPS values. To view available
       values: open the |service| web interface; select :guilabel:`Build a New
       Cluster`; select your preferred cloud service provider and region; click
       an instance size to view the available values; close the window without
       saving changes.

       You must include ``providerSettings.providerName`` if modifying this
       value.

       Changing this value affects the cost of running the cluster
       as described in the :ref:`billing <storage-speed>` documentation.

   * - ``providerSettings.encryptEBSVolume``
     - Boolean
     - *AWS only*. If enabled, the Amazon EBS encryption feature encrypts the
       server's root volume for both data at rest within the volume and for
       data moving between the volume and the instance.

       You must include ``providerSettings.providerName`` if modifying this
       value.

   * - ``replicationFactor``
     - number
     - The number of :term:`replica set` members. Each member keeps a copy of
       your databases, providing high availability and data redundancy.

       If your cluster is a sharded cluster, each shard is a replica set with
       the specified replication factor.

       For information on how the replication factor affects costs, see
       :ref:`server-number-costs`. For more information on MongoDB replica
       sets, see :manual:`Replication </replication>` in the MongoDB manual.

       The possible values are ``3``, ``5``, or ``7``.

       |service| ignores this value if you specify the ``replicationSpec``
       document.

   * - ``replicationSpec``
     - document
     - *Optional*

       The configuration of each region in a multi-region cluster. Each
       element in this document represents a region where |service| deploys
       your cluster.

       For single-region clusters, you can either specify the
       ``providerSettings.regionName`` and ``replicationFactor``, *or* you can
       use the ``replicationSpec`` document to define a single region.

       If you specify ``replicationSpec``, |service| overrides any values you
       specify to the ``providerSettings.regionName`` or ``replicationFactor``
       field with values derived from ``replicationSpec``.

       .. important::

          You **must** order each element in this document by
          ``replicationSpec.<region>.priority`` descending.

   * - ``replicationSpec.<region>``
     - document
     - *Required if specifying* ``replicationSpec``

       The physical location of the region. Replace ``<region>`` with the name
       of the region.
       
       Each ``<region>`` document describes the region's priority in
       elections and the number and type of MongoDB nodes |service| deploys
       to the region.

       You must specify at least one ``replicationSpec.<region>`` document.

       .. include:: /includes/fact-group-region-association.rst

       .. list-table::
          :header-rows: 1
          :widths: 20 50

          * - Provider
            - Region Names

          * - AWS
            - .. include:: /includes/fact-aws-region-names.rst

          * - GCP
            - .. include:: /includes/fact-gcp-region-names.rst

          * - AZURE
            - .. include:: /includes/fact-azure-region-names.rst
            
       For each ``<region>`` document, you must specify
       the ``electableNodes``, ``priority``, and ``readOnlyNodes`` fields.

   * - ``replicationSpec.<region>.electableNodes``
     - integer
     - *Required*

       The number of electable nodes for |service| to deploy to the region.
       Electable nodes can become the :term:`primary` and can facilitate
       local reads.

       The total number of ``electableNodes`` across all
       ``replicationSpec.<region>`` documents must be ``3``, ``5``, or ``7``.

       Specify ``0`` if you do not want any electable nodes in the
       region.

       You cannot create electable nodes if the
       ``replicationSpec.<region>.priority`` is 0.

   * - ``replicationSpec.<region>.priority``
     - integer
     - *Required*

       The election priority of the region. The highest possible priority is
       ``7``, which identifies the **Preferred Region** of the cluster.
       |service| places the :term:`primary` node in the **Preferred Region**.
       The lowest possible priority is ``0``, which identifies a read only region.

       You can have any number of priority ``0`` read only regions. 
       Priorities ``1`` through ``7`` are exclusive - no more than one
       region per cluster can be assigned a given priority.

   * - ``replicationSpec.<region>.readOnlyNodes``
     - integer
     - *Required*

       The number of read-only nodes for |service| to deploy to the region.
       Read-only nodes can never become the :term:`primary`, but can
       facilitate local-reads.

       Specify ``0`` if you do not want any read-only nodes in the region.

   * - ``diskSizeGB``
     - double
     - The size in gigabytes of the server's root volume. You can add capacity
       by increasing this number, up to a maximum possible value of ``16384``
       (i.e., 16 TB).

       .. important:: |service| calculates storage charges differently
          depending on whether you choose the default value or a custom value.
          For details, see :ref:`storage-capacity`.

   * - ``backupEnabled``
     - Boolean
     - Set to ``true`` to enable |service| 
       :doc:`continuous backups </backup/continuous-backups>` for the
       cluster.

       Set to ``false`` to disable continuous backups for the cluster.
       |service| deletes any stored snapshots. See the continuous
       backup :ref:`retention-policy` for more information.

       You cannot enable continuous backups if you have an 
       existing cluster in the project with 
       :doc:`/backup/cloud-provider-snapshots` enabled.

   * - ``biConnector``
     - document
     - *Optional*

       Specify whether to enable/disable |bic|.

       .. include:: /includes/extracts/cluster-option-bi-cluster-requirements.rst

       The ``biConnector`` document includes the following fields:

       .. list-table::
          :widths: 20 80

          * - ``enabled``
            - | Set to ``true`` to enable |bic|.
              | Set to ``false`` to disable |bic|.
      
          * - ``readPreference``
            - | Set to ``"primary"`` to have |bic| read from the primary.
              | Set to ``"secondary"`` to have |bic| read from a secondary member. *Default*

HTTP Response Elements
~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/list-table-cluster-http-response.rst

Example
-------

Request
~~~~~~~

Single Region Modification Request
++++++++++++++++++++++++++++++++++

.. code-block:: none

   curl -i -u "username:apiKey" --digest -H "Content-Type: application/json" -X PATCH "https://cloud.mongodb.com/api/atlas/v1.0/groups/5356823b3794de37132bb7b/clusters/datastore2" --data '
   {
     "diskSizeGB" : 320,
     "providerSettings" : {
       "providerName" : "AWS",
       "diskIOPS" : 2400,
       "encryptEBSVolume" : false,
       "instanceSizeName" : "M40",
       "regionName" : "EU_WEST_1"
     },
     "replicationFactor" : 3
   }'

Multi Region Modification Request
+++++++++++++++++++++++++++++++++

.. code-block:: none

   curl -i -u "username:apiKey" --digest -H "Content-Type: application/json" -X POST "https://cloud.mongodb.com/api/atlas/v1.0/groups/5356823b3794de37132bb7b/clusters" --data '
   {
     "providerSettings" : {
       "providerName" : "AWS",
       "diskIOPS" : 480,
       "instanceSizeName" : "M10"
     },
     "replicationSpec": {
         "US_EAST_1": {
           "electableNodes": 3,
           "priority": 7,
           "readOnlyNodes" : 0
         },
         "US_EAST_2": {
           "electableNodes": 0,
           "priority" : 6,
           "readOnlyNodes" : 2
         },
         "US_WEST_1": {
           "electableNodes" : 0,
           "priority" : 5,
           "readOnlyNodes": 2
         }
      }
   }'

Response
~~~~~~~~

Single Region Modification Response
+++++++++++++++++++++++++++++++++++

.. code-block:: none

   HTTP/1.1 200 OK

   {
     "name" : "datastore2",
     "backupEnabled" : true,
     "diskSizeGB" : 320,
     "groupId" : "5356823b3794de37132bb7b",
     "id": "59ef6621c0c6e378559875ed",
     "mongoDBVersion" : "3.2.8",
     "mongoURI" : "mongodb://mongo-shard-00-00.mongodb.net:27017,mongo-shard-00-01.mongodb.net:27017,mongo-shard-00-02.mongodb.net:27017",
     "mongoURIUpdated" : "2017-10-23T21:26:17Z",
     "mongoURIWithOptions" : "mongodb://mongo-shard-00-00.mongodb.net:27017,mongo-shard-00-01.mongodb.net:27017,mongo-shard-00-02.mongodb.net:27017/?ssl=true&authSource=admin&replicaSet=mongo-shard-0",
     "numShards" : 1,
     "paused" : false,
     "providerSettings" : {
       "providerName" : "AWS",
       "diskIOPS" : 2400,
       "encryptEBSVolume" : false,
       "instanceSizeName" : "M40",
       "regionName" : "EU_WEST_1"
     },
     "replicationFactor" : 3,
     "stateName" : "UPDATING"
   }

Multi Region Modification Response
++++++++++++++++++++++++++++++++++

.. code-block:: none

   {
      "name" : "datastore2",
      "backupEnabled": false,
      "diskSizeGB": 160.0,
      "groupId": "5356823b3794de37132bb7b",
      "id": "59ef6621c0c6e378559875ed",
      "links": [{
         "href": "https://cloud.mongodb.com/api/atlas/v1.0/groups/5356823b3794de37132bb7b/clusters/DataStore2",
         "rel": "self"
      }],
      "mongoDBMajorVersion": "3.4",
      "mongoDBVersion": "3.4.9",
      "mongoURI" : "mongodb://mongo-shard-00-00.mongodb.net:27017,mongo-shard-00-01.mongodb.net:27017,mongo-shard-00-02.mongodb.net:27017",
      "mongoURIUpdated" : "2017-10-23T21:26:17Z",
      "mongoURIWithOptions" : "mongodb://mongo-shard-00-00.mongodb.net:27017,mongo-shard-00-01.mongodb.net:27017,mongo-shard-00-02.mongodb.net:27017/?ssl=true&authSource=admin&replicaSet=mongo-shard-0",
      "name": "DataStore2",
      "numShards": 1,
      "paused" : false,
      "providerSettings": {
         "providerName": "AWS",
         "diskIOPS": 480,
         "encryptEBSVolume": true,
         "instanceSizeName": "M10"
      },
      "replicationSpec": {
         "US_EAST_1": {
            "electableNodes": 3,
            "priority": 7,
            "readOnlyNodes": 0
         },
         "US_EAST_2": {
            "electableNodes": 2,
            "priority": 6,
            "readOnlyNodes": 0
         },
         "US_WEST_1": {
            "electableNodes": 2,
            "priority": 5,
            "readOnlyNodes": 2
         }
      },
      "stateName": "UPDATING"
   }
