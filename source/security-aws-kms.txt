.. _security-aws-kms:

====================================
Customer Key Management with AWS KMS
====================================

.. default-domain:: mongodb

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

.. include:: /includes/cluster-settings/multi-cloud/incompatible-feature.rst

|service| uses your |aws| customer master key (CMK) in the |aws| Key
Management Service (KMS) to encrypt and decrypt your MongoDB master
keys. These MongoDB master keys are used to encrypt cluster database
files and :ref:`cloud providers snapshots <backup-cloud-provider>`.

.. include:: /includes/fact-atlas-key-rotation.rst

|service| encrypts your data at rest using encrypted storage media.
Using keys you manage with |aws| |kms|, |service| encrypts your data a
second time when it writes it to the MongoDB
:manual:`encrypted storage engine </core/security-encryption-at-rest>`.
You use your |aws| |cmk| to encrypt the MongoDB master encryption keys.
:term:`Oplog <oplog>` data is also encrypted with your |cmk|.

This page covers configuring customer key management using |aws| |kms|
on your |service| project.

You must configure customer key management for the |service| project
before enabling it on clusters in that project.

.. _aws-ksm-prereqs:
.. _security-aws-kms-restrictions:

Prerequisites
-------------

To enable customer-managed keys with |aws| |kms| for a MongoDB
project, you must:

.. include:: /includes/fact-aws-kms-prereqs.rst

Procedures
----------

.. _aws-kms-configure-project:

Enable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must enable customer key management for a project before you can
enable it on a cluster in that project.

.. include:: /includes/steps/enable-encryption-for-project.rst

.. _aws-enable-cluster-encryption-at-rest:

Enable Customer Key Management for an |service| Cluster
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you :ref:`aws-kms-configure-project`, you must enable customer key
management for each |service| cluster that contains data that you want
to encrypt.

.. note::

   You must have the :authrole:`Project Owner <Project Owner>` role to
   enable customer key management for clusters in that project.

For new clusters, toggle the
:doc:`Manage your own encryption keys </cluster-config/encryption/>`
setting to :guilabel:`Yes` when you create the cluster. 

For existing clusters:

.. include:: /includes/steps/cluster-customer-key-management.rst

Disable Customer-Managed Keys for a Project
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You must disable customer key management on each cluster in a project
before you can disable the feature for the project.

Alerts
------

|service| automatically creates an
:alert:`customer master key rotation alert <AWS encryption key elapsed time since last rotation is above 365 days>`
once you configure Encryption at Rest for a project.

To reset this alert, :doc:`/tutorial/security-aws-kms-rotate-key`.

Related Topics
--------------

- To enable Encryption at Rest when deploying an |service| cluster,
  see :ref:`create-cluster-enable-encryption`.

- To enable Encryption at Rest for an existing |service| cluster,
  see :ref:`scale-cluster-enable-encryption`.

- To rotate the currently configured |cmk| or changing the |iam|
  user credentials for a |service| project, see
  :doc:`/tutorial/security-aws-kms-rotate-key`.


.. class:: hidden

   .. toctree::
      :titlesonly:

      /tutorial/security-aws-kms-rotate-key
