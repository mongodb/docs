title: Set up a server and firewall.
stepnum: 1
ref: set-up-server
content: |
  Prepare the server that will run

  - the MMS On Prem components,

  - the Application Database, and

  - the Backup Blockstore Database.

  Use a RHEL 6+ or Amazon Linux Server with at least:

  - 15 GB of memory

  - 50 GB of disk space for the root partition

  For example, you can meet the size requirements by using an AWS EC2
  ``m3.xlarge`` instance and changing the size of the root partition from
  8 GB to 50 GB. When you log into the instance, execute "``df -h``" to
  verify the root partition has 50 GB of space.

  Set up a firewall or EC2 Security Group that:

  - Allows administrators to SSH into the server.

  - Allows MMS users to connect from browsers to ports ``8080`` and ``8081`` through the server's public IP address.

## don't wrap the previous line
---
title: Configure ``ulimits``.
stepnum: 2
ref: ulimits
action:
  - pre: |
      Remove the default ``ulimit`` settings that come with the operating
      system:
    language: sh
    code: |
      sudo rm /etc/security/limits.d/90-nproc.conf
  - pre: |
      Edit the ``/etc/security/limits.conf`` file to configure the
      following settings:
    language: cfg
    code: |
      * soft nofile 64000
      * hard nofile 64000
      * soft nproc 32000
      * hard nproc 32000
---
title: Install MongoDB.
stepnum: 3
ref: install-mongodb
pre: |
  Use the following series of commands to install MongoDB, which you use
  for the MMS Application Database and the MMS Backup Blockstore Database.
action:
  - pre: |
      Set up a repository definition by issuing the following command:
    language: sh
    code: |
      echo "[MongoDB]
      name=MongoDB Repository
      baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64
      gpgcheck=0
      enabled=1" | sudo tee -a /etc/yum.repos.d/mongodb.repo
  - pre: |
      Install MongoDB by issuing the following two commands:
    language: sh
    code: |
      sudo yum install -y mongodb-org mongodb-org-shell
---
title: Download the MMS Application Package.
stepnum: 4
ref: application-package-download
pre: |
  Download the latest version of the MMS Application Package from `the MMS
  downloads page <http://www.mongodb.com/subscription/downloads/mms>`_.
  The MMS Application Package is listed as "Monitoring and Core" on the
  downloads page.
action:
  - pre: |
      Download the On Prem MMS Package by issuing
      the following command. Substitute the MMS version for ``<version>``:
    language: sh
    code: |
      sudo curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.5.0.130`` issue:
    language: sh
    code: |
      curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-1.5.0.130.x86_64.rpm
---
title: Install the MMS Application Package.
stepnum: 5
ref: application-package-install
action:
  - pre: |
      Install the package using the following command, where ``<version>``
      is the MMS version:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.5.0.130`` issue:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-1.5.0.130.x86_64.rpm
---
title: Download the Backup Daemon Package.
stepnum: 6
ref: backup-package-download
  Download the latest version of the Backup Daemon Package from `the MMS
  downloads page <http://www.mongodb.com/subscription/downloads/mms>`_.
action:
  - pre: |
      Alternately, you can download the package by issuing the following
      command, where ``<version>`` is the MMS version:
    language: sh
    code: |
      curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-backup-daemon-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.5.0.130`` issue:
    language: sh
    code: |
      curl -OL https://downloads.mongodb.com/on-prem-mms/rpm/mongodb-mms-backup-daemon-1.5.0.130.x86_64.rpm
---
title: Install the Backup Daemon Package.
stepnum: 7
ref: backup-package-install
action:
  - pre: |
      Install the package using the following command, where ``<version>``
      is the MMS version:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-backup-daemon-<version>.x86_64.rpm
  - pre: |
      For example, for version ``1.5.0.130``, you would issue the following:
    language: sh
    code: |
      sudo rpm --install mongodb-mms-backup-daemon-1.5.0.130.x86_64.rpm
---
title: Set up the two backing databases.
stepnum: 8
ref: backing-databases
pre: |
  Create a data directory for each backing database and set
  ``mongod.mongod`` as each data directory's owner. The :doc:`backing
  databases </tutorial/prepare-backing-mongodb-instances>` are the MMS
  Application Database and MMS Backup Blockstore Database.
action:
  - pre: |
      The following command creates two data directories, one for each
      backing database. You can use different directory names:
    language: sh
    code: |
      sudo mkdir -p /data /data/mmsdb /data/backupdb
  - pre: |
      The following command sets ``mongod.mongod`` as owner of the new
      directories:
    language: sh
    code: |
      sudo chown mongod:mongod /data /data/mmsdb /data/backupdb
---
title: Start the MongoDB instances for the two backing databases.
stepnum: 9
ref: mongod
pre: |
  Start each MongoDB instance using the :program:`mongod` daemon and
  specifying ``mongod`` as the user. Start each instance on its own
  dedicated port number and with the data directory you created in the
  last step.
action:
  pre: |
    The following two commands start separate instances for the MMS
    Application Database and for the Backup Blockstore Database:
  language: sh
  code: |
    sudo -u mongod mongod --port 27017 --dbpath /data/mmsdb --logpath /data/mmsdb/mongodb.log --fork

    sudo -u mongod mongod --port 27018 --dbpath /data/backupdb --logpath /data/backupdb/mongodb.log --fork
---
title: Configure the MMS Application.
stepnum: 10
ref: mms-application-configure
action:
  pre: |
    Edit
    ``/opt/mongodb/mms/conf/conf-mms.properties``. Set values for the
    following properties, substituting your install's values for
    *<public_ip>* and *mms-admin@example.net*:
  language: cfg
  code: |
    mms.centralUrl=http://<public_ip>:8080
    mms.backupCentralUrl=http://<public_ip>:8081

    mms.fromEmailAddr=mms-admin@example.net
    mms.replyToEmailAddr=mms-admin@example.net
    mms.adminFromEmailAddr=mms-admin@example.net
    mms.adminEmailAddr=mms-admin@example.net
    mms.bounceEmailAddr=mms-admin@example.net

    mongo.mongoUri=mongodb://127.0.0.1:27017/
---
title: Start the MMS Application.
stepnum: 11
ref: mms-application-start
action:
  pre: |
    Issue the following command:
  language: sh
  code: |
    sudo service mongodb-mms start
---
title: Open the MMS On Prem home page.
stepnum: 12
ref: on-prem-home
action:
  pre: |
    Enter the following URL in a browser, where ``<public_ip>`` is the
    public IP address of the server:
  language: none
  code: |
    http://<public_ip>:8080
---
title: Configure the MMS Backup Daemon.
stepnum: 13
ref: mms-backup-configure
action:
  pre: |
    Edit
    ``/opt/mongodb/mms-backup-daemon/conf/conf-daemon.properties`` to
    configure the the following settings:
  language: cfg
  code: |
    mongo.mongoUri=mongodb://127.0.0.1:27017/

    mongo.backupdb.mongoUri=mongodb://127.0.0.1:27018/
---
title: Start the MMS Backup Daemon.
stepnum: 14
ref: mms-backup-start
action:
  pre: |
    Issue the following command:
  language: sh
  code: |
    sudo service mongodb-mms-backup-daemon start
...
