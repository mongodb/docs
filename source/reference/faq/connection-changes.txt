=========================
Connection String Options
=========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/styles/corrections.rst

|service| provides multiple connection strings. These strings allow
you to connect to your clusters from both public and private contexts.

Why Does My Cluster Have Multiple Connection Strings?
-----------------------------------------------------

To connect to |service|, point your applications to a |uri| to
communicate with a cluster. |service| creates clusters with more than
one node or host. Each node has its own hostname that resolves to an IP
address. The |uri|, known as a *connection string*, to which |service|
connects might have more than one hostname. Configure |service| to
accept connections to the cluster hosts from whitelisted IP addresses.

|service| secures connections from public IP address through
authentication and |tls|. If you want to connect to private IP
addresses, you can use:

- :doc:`AWS and GCP VPC Peering </security-vpc-peering>`
- :doc:`Azure VNet Peering </security-vpc-peering>`
- :ref:`AWS PrivateLink <private-endpoint-connection-strings>`

These features all manage communication over internal IP addresses
within secure networks.

|service| provides more than one connection string when using secure
networks. Each network offers a string that resolves to different IP
addresses.

All clusters have a
:ref:`standard connection string <connstring-standard>`. This resolves
to the cluster's:

- Public IP addresses for Internet connections and
- |vpc| private IP addresses for |aws| clusters when resolved from a
  peered |vpc|.

Use this string for applications connecting over the Internet or
connecting to peered clusters in |aws|.

Clusters with peered networks have a
:ref:`Private IP for Peering connection string <connstring-private>`.
This string resolves to IP addresses available to:

- Peered networks in |azure| or |gcp|
- |aws| peered clusters with a custom |dns| service.

Use this connection string with applications connecting:

- Within an |azure| or |gcp| peered network
- To |aws| clusters when using |aws| with custom |dns| service.

|aws| clusters with |aws| :ref:`PrivateLink <private-endpoint-connection-strings>`
configured have one or more connection strings. Each string resolves
to the IP address of an Endpoint Interface. Use these connection
strings with applications connecting over PrivateLink.

What Does This Mean for |gcp| or |azure| Clusters in Peering-Only Mode?
-----------------------------------------------------------------------

Before this update, you enabled peering-only mode to connect to
databases on peer networked |azure| or |gcp| clusters. This mode:

- Affected global |dns| resolution and
- Limited any database connections outside the peered network.

Multiple horizons lifts these restrictions and unlocks additional
features. If your project has MongoDB 3.6 or later clusters, you can
use:

- :stitch:`MongoDB Stitch </>`
- :charts:`Charts </>`
- :doc:`Live Migration </import>`

To update your applications to use |service| clusters running MongoDB
3.6 or later:

- Update your application to use
  :ref:`Private IP for Peering connection strings <connstring-private>`
  and
- :ref:`Disable Peering-Only mode <disable-peering-mode>`.

Can My VNet-Peered |azure| Cluster Span Multiple Regions?
---------------------------------------------------------

Yes.

Change your applications to connect using the
:ref:`Private IP for Peering connection string <connstring-private>`.
This change allows your applications to connect from peered networks
using the UI or API.

To expand into more regions, disable Peering-Only mode on existing
|azure| clusters first.

:ref:`Private IP for Peering connection strings <connstring-private>`
work with MongoDB 3.6 or later clusters.

.. _disable-peering-mode:

How Do I Disable Peering-Only mode?
-----------------------------------

To disable Peering-Only mode using the |service| interface:

1. Ensure all clusters in your project use MongoDB 3.6 or later.
2. Update all applications to use
   :ref:`Private IP for Peering connection strings <connstring-private>`.
3. Navigate to your |service| project.
4. Click :guilabel:`Settings` under the :guilabel:`Project` section in
   the left navigation.
5. Toggle :guilabel:`Connect via Peering Only (GCP and Azure)` to
   **Off**.

To disable Peering-Only mode using the |service| |api|:

1. Ensure all clusters in your project use MongoDB 3.6 or later.
2. Update all applications to use
   :ref:`Private IP for Peering connection strings <connstring-private>`.
3. Call the
   :doc:`Set Private IP mode for Project </reference/api/set-private-ip-mode-for-project>` endpoint:

   .. code-block:: sh

      curl --user "{PUBLIC-KEY}:{PRIVATE-KEY}" --digest \
           --header "Accept: application/json" \
           --header "Content-Type: application/json" \
           --include \
           --request PATCH "https://cloud.mongodb.com/api/atlas/v1.0/groups/{GROUP-ID}/privateIpMode?pretty=true" \
           --data '
             {
               "enabled" : false
             }'

   Change ``{GROUP-ID}`` to the :ref:`Project ID of your project <atlas-modify-project-settings>`.

   If successful, the response displays:

   .. code-block:: json
      :emphasize-lines: 2
      :linenos:

      {
        "enabled" : false
      }


How Does This Affect |aws| |vpc| Peering When I Use Custom |dns|?
-----------------------------------------------------------------

Before this change, applications deployed within |aws| using custom
|dns| services and |vpc|\-peered with |service| couldn't connect over
private IP addresses:

- Custom |dns| resolved to public IP addresses.
- |aws| internal |dns| resolved to private IP addresses.

Applications deployed with custom |dns| services in |aws| should use
:ref:`Private IP for Peering connection strings <connstring-private>`.
To show these strings:

1. Toggle the :guilabel:`Using Custom DNS on AWS with VPC Peering` on
   ``On`` from the :guilabel:`Project Settings` menu.
2. View the :guilabel:`connect` modal for your |aws| Cluster.
3. Select the :guilabel:`Private IP for Peering` connection string.

How Do I Identify Which Connection String My Application Uses?
--------------------------------------------------------------

The structure of the connection string's |uri| indicates the string's
type.

.. _connstring-standard:

Standard Connection Strings
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Standard connection strings follow this format:

.. code-block:: sh

   mongodb://clustername-shard-00-00.abc123.mongodb.net:27017
   mongodb+srv://clustername.abc123.mongodb.net

The dot before ``abc123`` *matters*. |uri|\s using this format resolve
to public IP addresses *except* when connecting from inside |aws| with
|vpc|\-peering configured.

.. important::

   This format changes one character from the
   :ref:`Legacy Connection Strings <connstring-legacy>`: a hyphen
   (``-``) after the cluster name becomes a period (``.``).

   .. example::

      This *legacy connection string*:

      .. code-block:: sh

         mongodb+srv://clustername-abc123.mongodb.net

      is written as this *standard connection string*:

      .. code-block:: sh

         mongodb+srv://clustername.abc123.mongodb.net

.. _connstring-private:

Private Connection Strings
~~~~~~~~~~~~~~~~~~~~~~~~~~

Private connection strings follow this format:

.. code-block:: sh

   mongodb://clustername-shard-00-00-pri.abc123.mongodb.net:27017
   mongodb+srv://clustername-pri.abc123.mongodb.net

The ``-pri`` before ``abc123`` *matters*. |uri|\s using this format
resolve to private IP addresses reachable within the peered network.

.. _connstring-privatelink:

|aws| Privatelink Connection Strings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:ref:`AWS PrivateLink <private-endpoint-connection-strings>`
connection strings follow this format:

.. code-block:: sh

   mongodb://pl-us-east-1a.abc123.mongodb.net:1234
   mongodb+srv://pl-us-east-1a.abc123.mongodb.net

|uri|\s using this format can be reachable via the |aws| |vpc| where
someone configured PrivateLink, though access can be transient from
other |vpc|\s peered in turn.

.. _connstring-legacy:

Legacy Connection Strings
~~~~~~~~~~~~~~~~~~~~~~~~~

Before this change, you wrote |service| connection strings as follows:

.. list-table::
   :widths: 30 70
   :stub-columns: 1

   * - |aws|
     -
       .. code-block:: sh
          :copyable: false

          foo-shard-00-00-abc123.mongodb.net
          foo-abc123.mongodb.net

   * - |azure|
     -
       .. code-block:: sh
          :copyable: false

          foo-shard-00-00-abc123.azure.mongodb.net
          foo-abc123.azure.mongodb.net

   * - |gcp|
     -
       .. code-block:: sh
          :copyable: false

          foo-shard-00-00-abc123.gcp.mongodb.net
          foo-abc123.gcp.mongodb.net

If you enabled **Private Only** mode, these hostnames resolve to peered
network IP addresses. If you disabled that mode, hostnames resolve to
public IP addresses.

If your application uses a legacy connection string in **Peering Only**
mode, switch to
:ref:`Private IP for Peering connection strings <connstring-private>`.
