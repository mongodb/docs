==========================================
Perform Maintenance on Replica Set Members
==========================================

.. default-domain:: mongodb

Overview
--------

:term:`Replica sets <replica set>` make it possible to continue to
serve client queries while administrators perform maintenance on each
member of the set.

Use this procedure to implement your own replica set maintenance
operations. These steps minimize the number of elections that must
take place during maintenance, and help ensure uptime as you bring
each member down in turn.

This procedure is the basis for common replica set operations
documented in this manual, such as :doc:`upgrading to the latest
version of MongoDB </tutorial/upgrade-revision>` and :doc:`changing
the size of the oplog</tutorial/change-oplog-size>`.

Procedure
---------

For each member of a replica set, perform the following sequence of
operations. Start with a secondary member of the set and end with
the primary so that the set only has to elect a new primary once.

- Restart the :program:`mongod` instance as a standalone.

- Perform the task on the standalone instance.

- Restart the :program:`mongod` instance as a member of the replica
  set.

.. _stop-a-secondary:

Stop a Secondary
~~~~~~~~~~~~~~~~

In the :program:`mongo` shell, shut down the :program:`mongod`
instance:

.. code-block:: javascript

   db.shutdownServer()

Restart the Secondary as a Standalone on a Different Port
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

At the operating system shell prompt, restart :program:`mongod`
as a standalone instance running on a different port and *without*
the :option:`--replSet <mongod --replSet>` parameter:

.. code-block:: sh

   mongod --port 37017 --dbpath /srv/mongodb

Perform Maintenance Operations on the Secondary
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

While the member is a standalone, perform maintenance.

Restart ``mongod``
~~~~~~~~~~~~~~~~~~

Restart the :program:`mongod` as a secondary member of the replica set
on its usual port. Use the following operation in the :program:`mongo`
shell:

.. code-block:: javascript

   db.shutdownServer()

Use the following command at the Linux shell prompt:

.. code-block:: sh

   mongod --replSet rs0 --dbpath /srv/mongodb

The secondary takes time to :doc:`replicate data from the primary
</core/replica-set-sync>` before becoming eligible to be elected
primary.

Perform Maintenance on the Primary Last
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To perform the maintenance operation on the primary while ensuring
availability, you must force the replica set to first elect a new
primary. In the :program:`mongo` shell, use :method:`rs.stepDown`
to step down the primary:

.. code-block:: javascript

   rs.stepDown()

Once the primary becomes a secondary, the replica set elects a new
primary, as described in :doc:`/core/replica-set-elections`.

Perform the steps of the current procedure to perform
maintenance on the newly-stepped-down secondary, starting with
:ref:`stop-a-secondary`.


