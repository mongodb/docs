.. _security-azure-kms-secretless:

=======================================================================
Manage Customer Keys with |azure| Key Vault (Secretless Authentication)
=======================================================================

.. default-domain:: mongodb

.. facet::
   :name: genre
   :values: tutorial

.. meta::
   :keywords: encryption

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/unavailable-flex-m0-clusters.rst

|service| supports secretless authentication for using |azure| Key 
Vault (|akv|) with Encryption at Rest (EAR). With this model, you don't 
need to provide |service| with long-lived static credentials (Tenant 
ID, Client ID, and Client Secret). Instead, you authorize an 
|service|-managed |azure| Service Principal in your |azure| tenant, 
and |service| authenticates to |akv| using short-lived OAuth 2.0 access 
tokens that |azure| Active Directory (|azure| AD) issues.

This approach:

- Eliminates the need to create, store, and rotate client 
  secrets in |service|.

- Centralizes access control entirely within |azure| using |azure| RBAC 
  or Key Vault access policies.
  
- Preserves existing EAR behavior for your clusters and applications. 
  Only the authentication mechanism changes

Secretless EAR relies on |azure| AD and |azure| Key Vault as the 
security boundary. |service| doesn't store reusable customer-managed 
secrets and instead uses |azure|-issued tokens at runtime. Access is 
enforced using least privilege permissions and you can remove |azure| 
permissions to revoke them immediately.

Atlas uses direct role assignment to an Atlas-managed Service Principal 
for a simpler, secure authentication model.

Prerequisites
-------------

To enable customer-managed keys with |akv| for a MongoDB project, you
must have: 

- .. include:: /includes/fact-kms-prereqs.rst

- The |azure| account, and the encryption key in your |akv|.
    
  To learn how to configure these Azure components, see the
  :azure:`Azure Documentation </index>`. 

  |service| uses these resources when enabling encryption at rest
  for a cluster in the |service| project.

- Permissions in |azure| to:

  - Register an enterprise Service Principal in your tenant.
    This prerequisite requires Microsoft Entra ID permissions to add or 
    manage Enterprise Applications, such as Application Administrator, 
    Cloud Application Administrator, or Global Administrator.

    To learn more, see `Quickstart: Add an enterprise application <https://learn.microsoft.com/en-us/entra/identity/enterprise-apps/add-application-portal>`__.

  - Access to the Key Vault key using one of the following 
    options:

    - :ref:`Azure RBAC <access-azure-rbac>` (at the Key Vault or key 
      scope)
    - :ref:`Key Vault access policies <access-azure-policies>`

- Project Owner access in |service| for the project for which you 
  want to enable Encryption at Rest.

Considerations
--------------

To use a customer-managed key stored in |akv| for EAR, the 
|service|-managed Service Principal must have permission to perform 
cryptographic operations on the specific Key Vault key.

The required key permissions include:

- ``get``
- ``encrypt``
- ``decrypt``

You should scope permissions as narrowly as possible and grant them 
using one of the following options:

- :ref:`Azure RBAC <access-azure-rbac>` (at the Key Vault or key scope)
- :ref:`Key Vault access policies <access-azure-policies>`

To learn more, see `Quickstart: Add an enterprise application <https://learn.microsoft.com/en-us/entra/identity/enterprise-apps/add-application-portal>`__.

Set Up EAR |akv| Secretless Authentication
------------------------------------------

To configure Encryption at Rest (EAR) with secretless authentication, 
you must:

1. Create an |service|-managed |azure| Service Principal.

#. Grant the Service Principal access to your Key Vault key.

#. Configure EAR to use the Service Principal.

Create an |service|-managed |azure| Service Principal
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Create an |azure| Service Principal in your tenant for the 
|service|-owned |azure| application and register it with |service| 
using the Cloud Provider Access API. |service| returns a ``roleId`` 
that you use when you enable EAR.

|service| uses the following |azure| application identity:

.. code-block:: sh

   atlasAzureAppId: 9efedfcc-2eca-4b27-a613-0cad1e114cb7

.. procedure::
   :style: normal

   .. step:: Get your |azure| tenant ID.

      Run the following command to retrieve the tenant ID for the 
      resource in which the Service Principal will exist:

      .. code-block:: sh

         az account show --query tenantId -o tsv

   .. step:: Create or locate the |service| Service Principal.

      If a Service Principal already exists for the |service| 
      application, run the following command to locate it:

      .. code-block:: sh

         az ad sp list --filter "appId eq '9efedfcc-2eca-4b27-a613-0cad1e114cb7'"

      If it doesn't exist, run the following command to create it:

      .. code-block:: sh

         az ad sp create --id 9efedfcc-2eca-4b27-a613-0cad1e114cb7

      From the output, copy the ``id`` field, which is the Service 
      Principal Object ID that |service| requires.

   .. step:: Register the Service Principal with |service|.

      Use the :oas-atlas-op:`Cloud Provider Access API 
      </createCloudProviderAccessRole>`:

      **Endpoint:**

      .. code-block:: sh

         POST /api/atlas/v2/groups/{groupId}/cloudProviderAccess

      **Request body example:**

      .. code-block:: sh

         {
           "providerName": "AZURE",
           "tenantId": "<azure-tenant-id>",
           "servicePrincipalId": "<service-principal-object-id>",
           "atlasAzureAppId": "9efedfcc-2eca-4b27-a613-0cad1e114cb7"
         }

      |service| provisions and manages the Service Principal and 
      returns an ``id`` value, which is the ``roleId`` required when 
      you :ref:`configure EAR <config-ear-secretless>`.

Grant |akv| Permissions
~~~~~~~~~~~~~~~~~~~~~~~

Authorize the |service|-managed Service Principal to perform 
cryptographic operations on the Key Vault key used for EAR.

You can grant access using either Azure RBAC or Key Vault access 
policies.

.. _access-azure-rbac:

Grant Access Using |azure| RBAC
```````````````````````````````

To grant access using |azure| RBAC:

.. procedure::
   :style: normal

   .. step:: Assign the Reader role so |service| can read Key Vault metadata.
      
      Run the following command:

      .. code-block:: sh

         az role assignment create \
           --assignee-object-id "$SERVICE_PRINCIPAL_OBJECT_ID" \
           --assignee-principal-type ServicePrincipal \
           --role "Reader" \
           --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$KEY_VAULT_NAME"

   .. step:: Assign a cryptographic role such as Key Vault Crypto User.

      Run the following command:

      .. code-block:: sh

         az role assignment create \
           --assignee-object-id "$SERVICE_PRINCIPAL_OBJECT_ID" \
           --assignee-principal-type ServicePrincipal \
           --role "Key Vault Crypto User" \
           --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$KEY_VAULT_NAME"

      .. note::

         You can also use a custom role, as long as it grants 
         equivalent key permissions.

.. _access-azure-policies:

Grant Access Using Key Vault Access Policies
````````````````````````````````````````````

If your Key Vault uses access policies, run the following command to 
grant key permissions directly:

.. code-block:: sh

   az keyvault set-policy \
     --subscription "$SUBSCRIPTION_ID" \
     --resource-group "$RESOURCE_GROUP" \
     --name "$KEY_VAULT_NAME" \
     --object-id "$SERVICE_PRINCIPAL_OBJECT_ID" \
     --key-permissions get encrypt decrypt wrapKey unwrapKey

.. _config-ear-secretless:

Configure Encryption at Rest to Use Secretless Authentication
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After you register and authorize the Service Principal in |azure|, 
update your EAR configuration with the ``roleId`` that the 
:oas-atlas-op:`Cloud Provider Access API 
</createCloudProviderAccessRole>` returned.

.. tabs:: 

   .. tab:: Atlas UI 
      :tabid: ui

      .. include:: /includes/steps-configure-azure-encryption-secretless.rst

   .. tab:: Atlas Admin API 
      :tabid: api

      **Endpoint:**

      .. code-block:: sh

         PATCH /api/atlas/v2/groups/{groupId}/encryptionAtRest


      **Request body example:**

      .. code-block:: sh

         {
           "azureKeyVault": {
             "enabled": true,
             "roleId": "<atlas-managed-roleId>",
             "subscriptionID": "<subscription-id>",
             "resourceGroupName": "<resource-group>",
             "keyVaultName": "<key-vault-name>",
             "keyIdentifier": "https://<vault>.vault.azure.net/keys/<key>/<version>",
             "azureEnvironment": "AZURE"
           }
         }

After this update, |service| authenticates to |akv| using short-lived 
|azure| AD tokens instead of static credentials.

Migrate from Static Credentials
-------------------------------

If your project already uses static credentials (``tenantId``, 
``clientId``, ``secret``), you can migrate without cluster downtime.

1. Create an |service|-managed Service Principal.

#. Grant Key Vault permissions.

#. Patch the EAR configuration with the new ``roleId``.

If validation fails, |service| continues using static credentials.

If validation succeeds, |service| removes the stored static 
credentials, and the ``roleId`` becomes the source of truth for 
authentication.

If your cluster uses Private Networking, |service| validates Key Vault 
access asynchronously from the data nodes.

- Validation is not completed immediately when the ``PATCH`` request is 
  accepted.

- Data nodes validate Key Vault access after the configuration is 
  applied.

Before you patch EAR with ``roleId``, ensure all Key Vault permissions 
are correctly configured. Misconfigured access can result in validation 
failures on data nodes, which may eventually disrupt EAR operations and 
lead to cluster shutdown.

Before you patch EAR, verify that your Service Principal has the 
required Key Vault permissions.

Verify Azure RBAC Role Assignments
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Run the following command:

.. code-block:: sh

   az role assignment list \
     --assignee "$SERVICE_PRINCIPAL_OBJECT_ID" \
     --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$KEY_VAULT_NAME"

Confirm the assigned role grants key permissions such as ``get``, 
``encrypt``, and ``decrypt``.

Verify Key Vault Access Policies
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Run the following command:

.. code-block:: sh

   az keyvault show \
     --name "$KEY_VAULT_NAME" \
     --resource-group "$RESOURCE_GROUP" \
     --query "properties.accessPolicies"

Confirm the Service Principal is listed and includes the required key 
permissions.
