=================================
Monitor MongoDB Windows with SNMP
=================================

.. versionadded:: 2.5.3

.. admonition:: Enterprise Feature

   This feature is only available in MongoDB Enterprise.

This document outlines the use and operation of MongoDB's SNMP support,
which is available in .. _`MongoDB Enterprise.`: http://www.mongodb.com/products/mongodb-enterprise

Prerequisites
-------------

The Enterprise packages contain the following files:

- ``MONGO-MIB.txt``:

  The :term:`MIB` file that describes the data (i.e. schema) for MongoDB's
  SNMP output

- ``mongod.conf``:

  The SNMP configuration file for reading the SNMP output of
  MongoDB. The SNMP configures the community names, permissions,
  access controls, etc.

Configure SNMP
--------------

Install MIB
~~~~~~~~~~~

To ensure that ``/usr/share/snmp/mibs`` exists, issue the following command:

.. code-block:: sh

   sudo mkdir -p /usr/share/snmp/mibs

From the MongoDB installation directory, use the following command
to create a symbolic link from the ``MIB`` file to its appropriate
location on the system:

.. code-block:: sh

   sudo ln -s MONGO-MIB.txt /usr/share/snmp/mibs/

Copy the ``mongod.conf`` file into the ``/etc/snmp`` directory
with the following command:

.. code-block:: sh

   sudo cp mongod.conf /etc/snmp/mongod.conf

Start Up
~~~~~~~~

Use the following command to view all SNMP options available in your
MongoDB:

.. code-block:: sh

   mongod --help | grep snmp

The above command returns the following output:

.. code-block:: sh

   Module snmp options:
     --snmp-subagent       run snmp subagent
     --snmp-master         run snmp as master

Start the :program:`mongod` instance with the following command:

.. code-block:: sh

   mongod --snmp-master

To check if :program:`mongod` is running with SNMP support, issue the
following command:

.. code-block:: sh

   ps -ef | grep 'mongod --snmp'

The command should return output that includes the following
line. This indicates that the proper :program:`mongod` instance is running:

.. code-block:: sh

   systemuser 31415 10260  0 Jul13 pts/16   00:00:00 mongod --snmp-master --port 3001 # [...]

Test SNMP
~~~~~~~~~

Check for the snmp agent process listening on port ``1161`` with the
following command:

.. code-block:: sh

   sudo lsof -i :1161

which return the following output:

.. code-block:: sh

   COMMAND  PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
   mongod  9238 sysadmin   10u  IPv4  96469      0t0  UDP localhost:health-polling

Similarly, this command:

.. code-block:: sh

   netstat -anp | grep 1161

should return the following output:

.. code-block:: none

   udp      0      0 127.0.0.1:1161      0.0.0.0:*      9238/<path>/mongod

Run ``snmpwalk`` Locally
~~~~~~~~~~~~~~~~~~~~~~~~

``snmpwalk`` provides tools for retrieving and parsing the SNMP data
according to the :term:`MIB`. If you installed all of the required packages
above, your system will have ``snmpwalk``.

Issue the following command to collect data from :program:`mongod` using
SNMP:

.. code-block:: sh

   snmpwalk -m MONGO-MIB -v 2c -c mongodb 127.0.0.1:1161 1.3.6.1.4.1.37601

You may also choose to specify the path to the MIB file:

.. code-block:: sh

   snmpwalk -m /usr/share/snmp/mibs/MONGO-MIB -v 2c -c mongodb 127.0.0.1:1161 1.3.6.1.4.1.37601

Use this command *only* to ensure that you can retrieve and validate
SNMP data from MongoDB.

Troubleshooting
---------------

Always check the logs for errors if something does not run as expected;
see the log at ``/var/log/mongodb/1.log``. The presence of the following
line indicates that the :program:`mongod` cannot read the
``/etc/snmp/mongod.conf`` file:

.. code-block:: sh

   [SNMPAgent] warning: error starting SNMPAgent as master err:1
