.. _private-endpoint:

=========================
Set up a Private Endpoint
=========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/fact-atlas-free-tier-limits.rst

MongoDB |service| supports private endpoints on |aws| using the 
`{+aws-pl+} <https://aws.amazon.com/privatelink/>`__ feature. When you 
enable this feature, |service| creates its own |vpc| and places clusters 
within a region behind a network load balancer in the |service| |vpc|. 
Then you create resources that establish a one-way connection from your 
|vpc| to the network load balancer in the |service| |vpc| using a 
private endpoint.

Connections to |service| clusters using private endpoints offer the 
following advantages over other network access management options:

- Connections using private endpoints are one-way. |service| |vpc|\s 
  can't initiate connections back to your |vpc|\s. This ensures your 
  network trust boundary is not extended.

- Connections to private endpoints within your |vpc| can be made 
  transitively from:

  - Another |vpc| peered to the private endpoint-connected |vpc|.
  - An on-premises data center connected with 
    :aws:`DirectConnect </whitepapers/latest/aws-vpc-connectivity-options/aws-direct-connect-network-to-amazon.html>` 
    to the private endpoint-connected |vpc|. This enables you to connect 
    to |service| directly from your on-premises data center without 
    whitelisting public IP addresses.   

Considerations
--------------

To ensure {+aws-pl+} connections to |service| can withstand an 
availability zone outage, you should deploy |vpc| subnets to multiple 
availability zones in a region.

When Private Endpoints are enabled, you can still connect to your 
|service| clusters using other methods, such as public 
:doc:`IP whitelisting </security-whitelist>`
and :doc:`VPC peering </security-vpc-peering>`. 

Clients connecting to |service| clusters using {+aws-pl+} use 
:ref:`private endpoint-aware connection strings <connect-private-endpoint>`. 
Clients connecting to |service| clusters using other methods use the 
standard connection strings. Your clients might have to identify when to 
use PrivateLink-aware connection strings and standard connection 
strings.

Limitations
-----------

- You can't use {+aws-pl+} to connect to |service| clusters running 
  MongoDB version 3.4 or earlier.

- {+aws-pl+} must be active in all regions into which you deploy a
  multi-region cluster. You receive an error if {+aws-pl+} is active in 
  some, but not all, targeted regions. 

- If you create private endpoints in more than one region, you can't 
  create more than one private endpoint in each region. If you create 
  more than one private endpoint in a single region, you can't create 
  private endpoints in other regions.

- You can use {+aws-pl+} in |service| projects with up to 30 addressable
  targets **per region**. Use additional projects or regions to connect 
  to addressable targets beyond this limit in the same region. 
  Addressable targets include:

  - Each node in a replica set, excluding nodes that comprise a shard
    in a sharded cluster.
  - Each ``mongos`` instance for sharded clusters.
  - Each |bic| instance across all dedicated clusters in the project.

  .. note::

     To request a one-time increase to use {+aws-pl+} with up to
     50 addressable targets per |service| project, contact 
     :ref:`MongoDB Support <request-support>`.

- When you delete all {+aws-pl+} endpoints for a region in |service|, 
  you must manually 
  :aws:`delete the private endpoint </vpc/latest/userguide/delete-vpc-endpoint.html>`.
  |aws| lists the endpoint as ``rejected``. |service| can't delete this 
  resource because it lacks the required permissions.

Prerequisites
-------------

To enable connections to |service| using private endpoints, you must:

1. Have either the :authrole:`Project Owner` or 
   :authrole:`Organization Owner` role in |service|.

#. Have an |aws| user account with an |iam| user policy that grants 
   permissions to create, modify, describe, and delete endpoints. For 
   more information on controlling the use of VPC endpoints, see the 
   :aws:`AWS Documentation </vpc/latest/userguide/vpc-endpoints.html>`.

#. **(Recommended)**:
   :aws:`Install the AWS CLI </cli/latest/userguide/cli-chap-install.html>`. 

#. If you have not already done so, create your |VPC| and EC2 instances 
   in |aws|. See the :aws:`AWS documentation </index.html>` for guidance.

Procedures
----------

Configure an |service| Private Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Enable clients to connect to |service| clusters using private endpoints 
with the following procedure: 

.. include:: /includes/steps/configure-privatelink.rst

.. _connect-private-endpoint:

Connect to |service| using a Private Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Use a private endpoint-aware connection string to connect to an 
|service| cluster with the following procedure:

.. include:: /includes/steps/connect-to-cluster-privatelink.rst

.. _pl-troubleshooting:

Troubleshoot {+aws-pl+} Connection Issues
----------------------------------------------

.. include:: /includes/steps/troubleshoot-privatelink.rst
