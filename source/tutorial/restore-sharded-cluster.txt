=======================================
Restore a Sharded Cluster from a Backup
=======================================

.. default-domain:: mongodb

Overview
--------

You can restore a :term:`sharded cluster` onto new hardware from the
artifacts captured by |backup|.

You can restore from a snapshot or checkpoint. You must :ref:`enable checkpoints
<enable-cluster-checkpoints>` to use them. When you restore from a
checkpoint, |mms| takes the snapshot previous to the checkpoint and applies
the :manual:`oplog </core/replica-set-oplog/>` to create a custom
snapshot. Checkpoint recovery takes longer than recovery from a stored
snapshot.

|mms| provides restore files as downloadable archives. You receive a
separate ``.tar.gz`` file for each :term:`shard` and one ``.tar.gz`` file
for the :term:`config servers <config server>`.

Sequence
--------

The sequence to restore a snapshot is to:

- select and download the restore files,

- distribute the restore files to their new locations,

- start the :program:`mongod` instances,

- configure each shard's replica set, and

- configure and start the cluster.

Considerations
--------------

Client Requests During Restoration
++++++++++++++++++++++++++++++++++

.. include:: /includes/considerations-restore-in-isolation.rst

Snapshots when Agent Cannot Stop Balancer
+++++++++++++++++++++++++++++++++++++++++

|mms| displays a warning next to cluster snapshots taken while the
:term:`balancer <balancer>` is enabled. If you restore from such a
snapshot, you run the risk of lost or orphaned data. For more information,
see :ref:`snapshot-while-balancer-enabled`.

Procedures
----------

Select and Download the Snapshot Files
++++++++++++++++++++++++++++++++++++++

.. include:: /includes/steps/download-snapshot-sharded-cluster.rst

Restore Each Shard's Primary
++++++++++++++++++++++++++++

For *all* shards, restore the primary. You must have a copy of the
snapshot on the server that provides the primary:

.. include:: /includes/steps/restore-primary.rst

Restore All Secondaries
+++++++++++++++++++++++

After you have restored the primary for a shard you can restore all
secondaries. You must have a copy of the snapshot on all servers that
provide the secondaries:

.. include:: /includes/steps/restore-secondary.rst

Restore Each Config Server
++++++++++++++++++++++++++

Perform this procedure separately for each :term:`config server`. Each
config server must have a copy of the tar file with the config server
data.

.. include:: /includes/steps/restore-config-server.rst

Start the ``mongos``
++++++++++++++++++++

Start the cluster's :program:`mongos` bound to your new config servers.
