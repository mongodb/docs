=============================
db.collection.findAndModify()
=============================

.. default-domain:: mongodb

.. EDITS to db.collection.findAndModify.txt must be carried over
   (possibly w modifications) to the command findAndModify.txt and vice
   versa

Definition
----------

.. method:: db.collection.findAndModify( <document> )

   Atomically
   modifies and returns a single document. By default, the returned
   document does not include the modifications made on the update. To
   return the document with the modifications made on the update, use
   the ``new`` option. The :method:`~db.collection.findAndModify()` method is a shell
   helper around the :dbcommand:`findAndModify` command.

   The :method:`~db.collection.findAndModify()` method has the following
   form:

   .. code-block:: none

      db.collection.findAndModify({
          query: <document>,
          sort: <document>,
          remove: <boolean>,
          update: <document>,
          new: <boolean>,
          fields: <document>,
          upsert: <boolean>
      });

   The :method:`db.collection.findAndModify()` method takes a document
   parameter with the following subdocument fields:

   .. include:: /reference/method/db.collection.findAndModify-param.rst

Return Data
-----------

The :method:`~db.collection.findAndModify()` method returns either:
the pre-modification document or, if ``new: true`` is set, the
modified document.

.. note::

   - If the query finds no document for ``update`` or ``remove``
     operations, :method:`~db.collection.findAndModify()` returns
     ``null``.

   - If the query finds no document for an ``upsert``, operation,
     :method:`~db.collection.findAndModify()` performs an insert. If
     ``new`` is ``false``, **and** the ``sort`` option is **NOT**
     specified, the method returns ``null``.

     .. versionchanged:: 2.2
        Previously returned an empty document ``{}``. See :ref:`the
        2.2 release notes <2.2-findandmodify-returns-null>` for more
        information.

   - If the query finds no document for an ``upsert``,
     :method:`~db.collection.findAndModify()` performs an insert. If
     ``new`` is ``false``, **and** a ``sort`` option, the method
     returns an empty document ``{}``.

Behaviors
---------

.. _upsert-and-unique-index:

Upsert and Unique Index
~~~~~~~~~~~~~~~~~~~~~~~

When :method:`~db.collection.findAndModify()` includes the ``upsert:
true`` option **and** the query field(s) is not uniquely indexed, the
method could insert a document multiple times in certain circumstances.
For instance, if multiple clients each invoke the method with the same
``query`` condition and these methods complete the ``find`` phase
before any of methods perform the ``modify`` phase, these methods could
insert the same document.

In the following example, no document with the name ``Andy`` exists,
and multiple clients issue the following command:

.. code-block:: javascript

   db.people.findAndModify({
       query: { name: "Andy" },
       sort: { rating: 1 },
       update: { $inc: { score: 1 } },
       upsert: true
   })

Then, if these clients' :method:`~db.collection.findAndModify()`
methods finish the ``query`` phase before any command starts the
``modify`` phase, **and** there is no unique index on the ``name``
field, the commands may all perform an upsert. To prevent this
condition, create a :ref:`unique index <index-type-unique>` on the
``name`` field. With the unique index in place, the multiple methods
would observe one of the following behaviors:

- Exactly one :method:`~db.collection.findAndModify()` would
  successfully insert a new document.

- Zero or more :method:`~db.collection.findAndModify()` methods
  would update the newly inserted document.

- Zero or more :method:`~db.collection.findAndModify()` methods
  would fail when they attempted to insert a duplicate. If the
  method fails due to a unique index constraint violation, you can
  retry the method. Absent a delete of the document, the retry
  should not fail.

Sharded Collections
~~~~~~~~~~~~~~~~~~~

When using :dbcommand:`findAndModify` in a :term:`sharded <sharding>`
environment, the ``query`` **must** contain the :term:`shard key` for
all operations against the shard cluster for the *sharded* collections.

:dbcommand:`findAndModify` operations issued against :program:`mongos`
instances for *non-sharded* collections function normally.

Examples
--------

Update and Return
~~~~~~~~~~~~~~~~~

The following method updates and returns an existing document in the
people collection where the document matches the query criteria:

.. code-block:: javascript

   db.people.findAndModify({
       query: { name: "Tom", state: "active", rating: { $gt: 10 } },
       sort: { rating: 1 },
       update: { $inc: { score: 1 } }
   })

This method performs the following actions:

#. The ``query`` finds a document in the ``people`` collection
   where the ``name`` field has the value ``Tom``, the ``state``
   field has the value ``active`` and the ``rating`` field has a
   value :operator:`greater than <$gt>` 10.

#. The ``sort`` orders the results of the query in ascending order.
   If multiple documents meet the ``query`` condition, the method
   will select for modification the first document as ordered by
   this ``sort``.

#. The update :operator:`increments <$inc>` the value of the
   ``score`` field by 1.

#. The method returns the original (i.e. pre-modification) document
   selected for this update:

   .. code-block:: javascript

      {
        "_id" : ObjectId("50f1e2c99beb36a0f45c6453"),
        "name" : "Tom",
        "state" : "active",
        "rating" : 100,
        "score" : 5
      }

   To return the modified document, add the ``new:true`` option to
   the method.

   If no document matched the ``query`` condition, the method
   returns ``null``:

   .. code-block:: javascript

      null

Update and Insert
~~~~~~~~~~~~~~~~~

The following method includes the ``upsert: true`` option to
insert a new document if no document matches the ``query``
condition:

.. code-block:: javascript

   db.people.findAndModify({
       query: { name: "Gus", state: "active", rating: 100 },
       sort: { rating: 1 },
       update: { $inc: { score: 1 } },
       upsert: true
   })

If the method does **not** find a matching document, the method
performs an upsert. Because the method included the ``sort``
option, it returns an empty document ``{ }`` as the original
(pre-modification) document:

.. code-block:: javascript

   { }

If the method did **not** include a ``sort`` option, the method returns
``null``.

.. code-block:: javascript

   null

Update, Insert and Return New Document
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following method includes both the ``upsert: true`` option and
the ``new:true`` option to return the newly inserted document if a
document matching the ``query`` is not found:

.. code-block:: none

   db.people.findAndModify({
       query: { name: "Pascal", state: "active", rating: 25 },
       sort: { rating: 1 },
       update: { $inc: { score: 1 } },
       upsert: true,
       new: true
   })

The method returns the newly inserted document:

.. code-block:: javascript

   {
      "_id" : ObjectId("50f49ad6444c11ac2448a5d6"),
      "name" : "Pascal",
      "rating" : 25,
      "score" : 1,
      "state" : "active"
   }
