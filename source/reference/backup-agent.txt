==========================
Backup Agent Configuration
==========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/extracts/backup-agent-configuration-overview.rst

.. warning::

   Do **not** edit these settings for a Backup Agent that is managed by
   an Automation Agent. If you do, the Automation Agent can overwrite
   any changes you make. If you are not using the Automation Agent, you
   must edit these settings manually.

Location of the Configuration File on Each Operating System
-----------------------------------------------------------

The location of the Backup Agent configuration file depends on your
operating system:

.. list-table::
   :widths: 30 30 40
 
   * - Operating System
 
     - Installation Method
 
     - Config File Path
 
   * - RHEL, CentOS, Amazon Linux and Ubuntu
 
     - package manager
 
     - ``/etc/mongodb-mms/backup-agent.config``
 
   * - OS X or other Linux distributions
 
     - ``tar``
 
     - ``/path/to/install/local.config``
 
   * - Windows
 
     - ``msi``
 
     - ``C:\MMSData\Backup\local.config``

Backup Agent Settings
---------------------

|mms| provides the values for these Backup Agent settings when |mms| is initially configured.

.. important:: 
   You must set the :bsetting:`mmsApiKey` value.

.. _backup-connection-settings:

Connection Settings
~~~~~~~~~~~~~~~~~~~

For the Backup Agent to communicate with the |mms| servers, these
connection settings are **required**:

.. bsetting:: mmsApiKey

   *Type*: string
 
   Specifies the |mms| agent API key of your |mms| group. To retrieve
   this key from |mms|, click :guilabel:`Settings`, then
   :guilabel:`Agents` and then click on the appropriate operating
   system under :guilabel:`Agent Downloads`.

   When the :guilabel:`Backup Agent Installation Instructions` box
   appears, these values can be copied directly from this box using the
   :guilabel:`Copy` buttons.

   This setting is usually set when the Backup Agent is installed and
   *it is required*.
 
   .. code-block:: ini
 
      mmsApiKey=rgdte4w7wwbnds9nceuodx9mcte2zqem

.. bsetting:: mothership

   *Type*: string

   Specifies the URL of the |application|.

.. bsetting:: https

   *Type*: boolean
   
   Specifies whether or not communication with the |mms| web server
   uses Secure HTTP.

.. _backup-logging-settings:

Logging Settings
~~~~~~~~~~~~~~~~

.. bsetting:: logFile

   *Type*: string

   Specifies the absolute path to the log file. If this is not
   specified, the log writes to standard error (``stderr``) on UNIX-
   and Linux-based systems and to the Event Log on Windows systems.

.. bsetting:: maxLogFileSizeBytes

   *Type*: integer

   Specifies the maximum size, in bytes, of a log file before the logs
   are rotated. If unspecified, the Backup Agent does not rotate
   logs based on file size. This is optional.

   .. code-block:: ini

      maxLogFileSizeBytes=536870912

.. bsetting:: maxLogFileDurationHrs

   *Type*: float

   Specifies the number of hours after which the log file is rotated.
   This is optional and only supported on UNIX- and Linux-based
   systems.

   .. note::
      You can manually rotate the Backup Agent logs. Issue a user
      signal 1 kill command for the Backup Agent process:

      .. code-block:: sh

         kill -SIGUSR1 <backupAgentID>

      This rotates the Backup Agent log file.

HTTP Proxy Settings
~~~~~~~~~~~~~~~~~~~

.. bsetting:: httpProxy

   *Type*: string
   
   Specifies the URL of an HTTP proxy server the Backup Agent can use.

   .. code-block:: ini
   
      httpProxy=http://proxy.example.com:8080

.. _backup-mongodb-kerberos-settings:

MongoDB Kerberos Settings
~~~~~~~~~~~~~~~~~~~~~~~~~

Specify these settings if the Backup Agent authenticates to hosts using
Kerberos. See :doc:`/tutorial/configure-backup-agent-for-kerberos` for
more information.

.. bsetting:: krb5Principal

   *Type*: string
   
   Specifies the Kerberos principal the Backup Agent uses.
   
   .. code-block:: ini
   
      krb5Principal=mmsagent/myhost@EXAMPLE.COM

.. bsetting:: krb5Keytab

   *Type*: string
   
    Specifies the *absolute* path to Kerberos principal's keytab file.
   
   .. code-block:: ini
   
      krb5Keytab=/path/to/backup-agent.keytab

.. bsetting:: krb5ConfigLocation

   *Type*: string
   
   Specifies the *absolute* path to an non-system-standard location for
   the Kerberos configuration file.
   
   .. code-block:: ini
   
      krb5ConfigLocation=/path/to/krb_custom.conf

.. bsetting:: gsappiServiceName

   *Type*: string
   
   Specifies the service name with the :bsetting:`gssapiServiceName`
   option.

   *By default, MongoDB uses* ``mongodb`` *as its service name.*

.. include:: /includes/fact-set-krb5ccname.rst

.. _backup-mongodb-ssl-settings:

MongoDB SSL Settings
~~~~~~~~~~~~~~~~~~~~

Specify these settings when the Backup Agent connects to MongoDB
deployments using SSL. See
:doc:`/tutorial/configure-backup-agent-for-ssl` for more information.

.. bsetting:: sslClientCertificate

   *Type*: string
   
   Specifies the path to the private key, client certificate, and
   optional intermediate certificates in ``PEM`` format. The Backup Agent
   uses the client certificate when connecting to a MongoDB deployment
   that uses SSL and requires client certificates (one that runs with
   the :option:`--sslCAFile <mongod --sslCAFile>` option).

.. bsetting:: sslClientCertificatePassword

   *Type*: string
   
   Specifies the password needed to decrypt the private key in the
   ``sslClientCertificate`` file. This setting is needed when the
   client certificate PEM file is encrypted.

.. bsetting:: sslTrustedServerCertificates

   *Type*: string
   
   Specifies the path that contains the trusted CA certificates in
   ``PEM`` format. These certificates verify the server certificate
   returned from any MongoDB deployments running with SSL.
   
   .. code-block:: ini
   
      sslTrustedServerCertificates=/path/to/mongodb-certs.pem

.. bsetting:: sslRequireValidServerCertificates

   *Type*: boolean
   
   Specifies if the Backup Agent should validate SSL certificates
   presented by the MongoDB deployments.

   .. warning::

      Setting this option to ``false`` disables certificate
      verification and makes connections between the Backup Agent and
      MongoDB deployments susceptible to *man-in-the-middle* attacks.
      Setting this option to ``false`` is only recommended for testing
      purposes.

.. _monitoring-server-ssl-settings:
.. _backup-server-ssl-settings:

|mms| Server SSL Settings
~~~~~~~~~~~~~~~~~~~~~~~~~

Specify the settings the Backup Agent uses when communicating with
|mms| using SSL.

.. bsetting:: sslTrustedMMSBackupServerCertificate

   Specifies the path that contains the trusted CA certificates in
   ``PEM`` format. The Backup Agent uses this certificate to verify
   that the agent is communicating with the designated |mms| instance.

   *By default, the Backup Agent uses the trusted root CAs installed
   on the system.* 

   If the Backup Agent cannot find the trusted root CAs,
   configure these settings manually.
   
   .. only:: onprem
   
      If |mms| is using a self-signed SSL certificate, this setting is
      required.

   .. code-block:: ini
   
      sslTrustedMMSBackupServerCertificate=/path/to/mms-certs.pem

.. additional settings are in the following extracts file:

.. include:: /includes/extracts/backup-agent-configuration-ssl.rst
