==================================
Frequently Asked Questions: Backup
==================================

.. contents::
   :backlinks: none
   :local:

Requirements
------------

What version of MongoDB does the Backup Service require?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For deployments using sharded clusters, the MongoDB Backup Service
requires version 2.4.3 or later. 

For deployments using replica sets, the MongoDB Backup Service requires 
version 2.0 or later.

What MongoDB permissions does the Backup agent require on MongoDB 2.4 Instances?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If you are backing up a MongoDB 2.4 instance with authentication
enabled, the Backup agent requires elevated privileges. At a minimum,
the user will need:

- the ``readAnyDatabase`` role, **and**

- the ``clusterAdmin`` role, **and**

- the ability to write to the local database (e.g., via the ``readWrite``
  role), **and**

- the ``userAdminAnyDatabase`` role on the ``admin`` database.

.. seealso:: `User Privilege Roles in MongoDB <http://docs.mongodb.org/manual/reference/user-privileges/>`_.

Are there any limits to the types of deployments the Backup Service supports?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Yes. The Backup Service does not currently support standalone
deployments. Only deployments using replica sets or sharded clusters
can be configured to work with the Backup Service.

Interface
---------

How can I verify that I'm running the latest version of the Backup Agent?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your Backup agent is out of date, it will be highlighted in red on
the :guilabel:`Agents` tab of the "Hosts" page in the MMS interface.

Why is my Backup Agent highlighted in red?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your agent is highlighted in red on the :guilabel:`Agents` tab of
the "Hosts" page, your agent is out of date. For instructions on
updating the agent, see the :doc:`installation instructions
</backup/tutorial/install-and-start-backup-agent>`.

Operations
----------

Where should I run the Backup agent?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Backup agent can run anywhere in your infrastructure that has
access to your ``mongod`` instances. To avoid contention for network
and CPU resources, do not run the Backup agent on the same hosts that
provide your ``mongod`` instances.

The primary resource requirement for the Backup agent is network.

Will the MongoDB Backup Service impact my production databases?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB Backup Service will typically have minimal impact on
production MongoDB deployments. This impact will be similar to that of
adding a new secondary to a replica set.

By default the Backup agent will perform the initial sync, which is
the most resource intensive operation for the Backup Service, against
a secondary member of the replica set to limit the impact of the
Backup Service. You may optionally configure the Backup agent to
perform the initial sync against the primary, although this will
increase the impact of the initial sync operation.

Does the Backup agent modify my database?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The backup agent writes a small token into the oplog of the source
database every hour. These tokens provide a heartbeat for the Backup
service and have no effect on the source deployment. Each token is
less than 100 bytes.

Is my data safe?
~~~~~~~~~~~~~~~~

Yes, 10gen uses enterprise-grade hardware co-located in secure data
centers to store all user data. The Backup Service agent encrypts
transmits all data using SSL. The Backup Service requires two-factor
authentication to provide any data for restores.

Is there a limit to Backup size?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Currently the Backup Service is limited to 500 gigabytes per user
group.

How can 10gen provide point-in-time restores for any point in time?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Although it is faster to provide a restore for the time at which a
snapshot was actually stored, for a replica set, the Backup service
can build a restore to any point in time within a 24-hour period by
replaying the oplog to the desired time.

.. important:: For sharded clusters, the Backup service only restores
   sharded clusters from a :doc:`stored snapshot
   </backup/tutorial/restore-from-snapshot/>`, which reflect *nearly*
   the same moment for each shard. The Backup service will not build a
   custom snapshot for a sharded cluster.

Can I backup my standalone deployment?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

No. The Backup Service does not currently support standalone
deployments. To convert to a replica set, consult MongoDB's `replication
documentation <http://docs.mongodb.org/manual/replication/>`_.

Can I take snapshots more or less often than every 6 hours?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Currently users cannot configure the snapshot schedule.

.. _backup-faq-retention:

Can I set my own snapshot retention policy?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Currently users cannot set custom snapshot retention policies. The
current snapshot retention policy is as follows:

- 6-hour interval snapshots for 2 days,
- Daily snapshots stored for 1 week,
- Weekly snapshots stored for 1 month, and
- Monthly snapshots stored for 1 year.

How many copies of my data does the Backup Service store?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Although we only charge you for only one copy of the data, we store at
least 3 copies of it in at least 2 geographic locations to ensure
redundancy.

How long does it take to create a restore?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Time to restore is typically 2 min per GB of snapshot data, plus
transfer time. In addition, point-in-time restores will take more
time. This will vary depending on a number of factors, including the
volume of data and number of updates made to the database (i.e., oplog
size) between the time of the utilized snapshot and the point in time
chosen.

Does the Backup Service perform any data validation?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB Backup Service conducts basic corruption checks and provides
an alert if any component (e.g., the agent) is down or broken, but
does not perform explicit data validation. The backup service errs on
the side of caution and invalidates the current backup and sends an
alert when it detects corruption.

How do I restore? What do I get when I restore?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can request a restore via MMS, where you can then choose which
snapshot to restore and how you want the Backup service to deliver the
restore. All restores require
2-factor authentication. We will send an authorization code via SMS
code to your administrator, you must enter the authorization code into
the backup interface to begin the restore process.

The backup service delivers restores as ```tar.gz`` archives of
MongoDB data files.

Restore delivery options are:

- **SCP to your Infrastructure**: The Backup service will transmit the
  backup to your infrastructure over a secure channel.  You must
  provide connection information for a host in your deployment.

- **Download**: The Backup service will make your restore data
  available using a custom, one-time-use URL.

What is the SCP public key for the Backup System?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Backup service generates an SSH public key on a per user basis to
use when for delivering backups via SCP. To generate a public key, go
to the "Settings" page and choose "Backup and Restore Public Key,"
then type in a passphrase and click on "Generate a New Public Key".

The public key will generate an SSH key and display it. Add this key
to your authorized hosts file.

See the :ref:`Restore via Secure Copy <scp-ssh>` documentation
for more information about granting access via SSH public key.

Pricing
-------

How does the Backup Service calculate snapshot storage costs?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The snapshot storage cost depends on the *raw storage size*.

Raw storage size is the sum of all allocated extents, which is
typically smaller than file size.

The snapshot storage price is $0.08 per gigabyte per-month.

See :ref:`backup-faq-retention` for more information about snapshot
retention, which affects snapshot storage cost.

How does the Backup Service calculate the cost of inbound network data transfer?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Backup Service calculates the cost of data transfer using the
uncompressed data size at a rate of $2 per gigabytes. This cost only
applies only to oplog transfer, and not to transfer related to initial
sync.

What is the snapshot creation cost?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Creating a snapshot incurs a one-time charge to cover the cost of
building a snapshot. The rate is $0.01 per gigabyte.

What other costs does the Backup Service incur?
-----------------------------------------------

In addition to snapshot storage and creation costs and the network
transfer cost, the Backup Service incurs a minimum cost of $0.10 per
replica set per day.

What is the billing frequency and schedule?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You will receive a monthly bill for the backup service; however, the
service calculates costs every day.

What is the cost of a restoration?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There is no cost to create a restore.
