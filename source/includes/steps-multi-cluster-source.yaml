---
stepnum: 0
level: 4
ref: clone-k8s-repo-multi-cluster
title: "Clone the :github:`MongoDB Enterprise Kubernetes Operator repository </mongodb/mongodb-enterprise-kubernetes>`."
content: |

  .. code-block:: sh

     git clone https://github.com/mongodb/mongodb-enterprise-kubernetes.git

---
stepnum: 0
level: 4
ref: install-helm-charts
title: "Add the :mdb-github:`MongoDB Helm Charts for Kubernetes </helm-charts>` repository to Helm."
content: |

  .. code-block:: sh

     helm repo add mongodb https://mongodb.github.io/helm-charts

---
stepnum: 0
level: 4
ref: run-multi-cluster-tool
title: "Run the ``multi-cluster CLI``."
content: |

  By default, the |k8s-op-short| is scoped to the ``mongodb`` namespace.
  The following command creates one central cluster, three member clusters,
  and a |k8s-ns| labeled ``mongodb`` in each of the clusters.

  a. Change to the directory to which you cloned the |k8s-op-short|
     repository, and then to the directory that contains the
     :ref:`Multi-cluster CLI <multi-cluster-cli-reference-ref>`.
  #. Run the |mc-cli|:

     .. code-block:: sh

        cd tools/multicluster
        go run main.go \
        setup \
          -central-cluster="${MDB_CENTRAL_CLUSTER_FULL_NAME}" \
          -member-clusters="${MDB_CLUSTER_1_FULL_NAME},${MDB_CLUSTER_2_FULL_NAME},${MDB_CLUSTER_3_FULL_NAME}" \
          -member-cluster-namespace="mongodb" \
          -central-cluster-namespace="mongodb"

---
stepnum: 0
level: 4
ref: set-istio-webhook
title: "Set the Istio injection webhook in each member cluster."
content: |
   
   Run the following command on the central cluster, specifying the context
   for each of the member clusters in the deployment. These commands add
   the ``istio-injection=enabled`` label to the ``mongodb`` namespace on
   each member cluster. This label configures Istio's injection webhook
   which enables adding a sidecar to any Pods that you create in this
   namespace. To learn more, see `Automatic sidecar injection <https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection>`__
   in the Istio documentation.

   .. code-block:: sh
      :emphasize-lines: 4

      kubectl label \
        --context=$MDB_CLUSTER_1_FULL_NAME \
        namespace mongodb \
        istio-injection=enabled

   .. code-block:: sh
      :emphasize-lines: 4

      kubectl label \
        --context=$MDB_CLUSTER_2_FULL_NAME \
        namespace mongodb \
        istio-injection=enabled

   .. code-block:: sh
      :emphasize-lines: 4

      kubectl label \
        --context=$MDB_CLUSTER_3_FULL_NAME \
        namespace mongodb \
        istio-injection=enabled

---
stepnum: 0
level: 4
title: "Configure ``kubectl`` to use the central cluster's namespace."
ref: configure-kubectl-mc
content: |

  If you have not done so already, run the following commands to run
  all ``kubectl`` commands on the central cluster in the default
  namespace. In the following steps, you install the |k8s-op-short|
  into this namespace.

  .. code-block:: sh

     kubectl config use-context $MDB_CENTRAL_CLUSTER_FULL_NAME
     kubectl config set-context $(kubectl config current-context) \
       --namespace=mongodb

---
stepnum: 0
level: 4
title: "Install the |k8s-op-full| in the central cluster."
ref: install-kubectl-mc
content: |
     
     Use the :mdb-github:`MongoDB Helm Charts for Kubernetes </helm-charts>`
     for |multi-clusters| to install |k8s-op-short| for managing your
     |multi-cluster|:

     .. code-block:: sh

        helm upgrade \
          --install \
            mongodb-enterprise-operator-multi-cluster \
            mongodb/enterprise-operator \
              --namespace mongodb \
              --set namespace=mongodb \
              --version <mongodb-kubernetes-operator-version> \
              --set operator.name=mongodb-enterprise-operator-multi-cluster \
              --set operator.createOperatorServiceAccount=false \
              --set "multiCluster.clusters={$MDB_CLUSTER_1_FULL_NAME,$MDB_CLUSTER_2_FULL_NAME,$MDB_CLUSTER_3_FULL_NAME}" \
              --set multiCluster.performFailover=false
---
stepnum: 0
title: "Deploy the MongoDB resource."
ref: deploy-mdbresource-mc
content: |

   a. On the central cluster, create a secret so that the |k8s-op-short|
      can create and update objects in your |mms| project.
      To learn more, see :ref:`create-k8s-credentials`.

   #. On the central cluster, create a ConfigMap to link the |k8s-op-short|
      to your |mms| project. To learn more, see :ref:`create-k8s-project`.

   #. On the central cluster, configure the required service accounts
      for each member cluster:

      .. code-block:: sh

         helm template --show-only \
           templates/database-roles.yaml \
           mongodb/enterprise-operator \
           --set namespace=mongodb | \
         kubectl apply -f - \
           --context=$MDB_CLUSTER_1_FULL_NAME \
           --namespace mongodb

      .. code-block:: sh

         helm template --show-only \
           templates/database-roles.yaml \
           mongodb/enterprise-operator \
           --set namespace=mongodb | \
         kubectl apply -f - \
           --context=$MDB_CLUSTER_2_FULL_NAME \
           --namespace mongodb

      .. code-block:: sh

         helm template --show-only \
           templates/database-roles.yaml \
           mongodb/enterprise-operator \
           --set namespace=mongodb | \
         kubectl apply -f - \
           --context=$MDB_CLUSTER_3_FULL_NAME \
           --namespace mongodb

   #. Set :setting:`spec.credentials` and :setting:`spec.opsManager.configMapRef.name`
      and deploy the MongoDB resource.
      In the following code sample, ``duplicateServiceObjects``
      is set to ``true`` to enable
      `DNS proxying <https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/>`__
      in Istio.
      
      .. note::
         To enable the cross-cluster DNS resolution by the Istio
         service mesh, this tutorial creates service objects with a
         single ClusterIP address per each |k8s| Pod.

      .. code-block:: sh

         kubectl apply -f - <<EOF
         apiVersion: mongodb.com/v1
         kind: MongoDBMulti
         metadata:
          name: multi-replica-set
         spec:
          version: 4.4.0-ent
          type: ReplicaSet
          persistent: false
          duplicateServiceObjects: true
          credentials: my-credentials
          opsManager:
            configMapRef:
              name: my-project
          clusterSpecList:
            - clusterName: ${MDB_CLUSTER_1_FULL_NAME}
              members: 3
            - clusterName: ${MDB_CLUSTER_2_FULL_NAME}
              members: 2
            - clusterName: ${MDB_CLUSTER_3_FULL_NAME}
              members: 3
         EOF

---
stepnum: 0
title: "Deploy the MongoDB resource with |tls|."
ref: deploy-mdbresource-mc-tls
content: |

   a. Create a secret so that the |k8s-op-short|
      can create and update objects in your |mms| project.
      To learn more, see :ref:`create-k8s-credentials`.

   #. Create a ConfigMap to link the |k8s-op-short|
      to your |mms| project. To learn more, see :ref:`create-k8s-project`.

   #. Configure the required service accounts
      for each member cluster:

      .. code-block:: sh

         helm template --show-only \
           templates/database-roles.yaml \
           mongodb/enterprise-operator \
           --set namespace=mongodb | \
         kubectl apply -f - \
           --context=$MDB_CLUSTER_1_FULL_NAME \
           --namespace mongodb

      .. code-block:: sh

         helm template --show-only \
           templates/database-roles.yaml \
           mongodb/enterprise-operator \
           --set namespace=mongodb | \
         kubectl apply -f - \
           --context=$MDB_CLUSTER_2_FULL_NAME \
           --namespace mongodb

      .. code-block:: sh

         helm template --show-only \
           templates/database-roles.yaml \
           mongodb/enterprise-operator \
           --set namespace=mongodb | \
         kubectl apply -f - \
           --context=$MDB_CLUSTER_3_FULL_NAME \
           --namespace mongodb

   #. Set :setting:`spec.credentials`, 
      :setting:`spec.opsManagerconfigMapRef.name`, and 
      :ref:`security settings <security-settings>` 
      and deploy the MongoDB resource.
      In the following code sample, ``duplicateServiceObjects``
      is set to ``true`` to enable
      `DNS proxying <https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/>`__
      in Istio.
      
      .. note::
         To enable the cross-cluster DNS resolution by the Istio
         service mesh, this tutorial creates service objects with a
         single ClusterIP address per each |k8s| Pod.

      .. code-block:: sh

         kubectl apply -f - <<EOF
         apiVersion: mongodb.com/v1
         kind: MongoDBMulti
         metadata:
          name: multi-replica-set
         spec:
          version: 4.4.0-ent
          type: ReplicaSet
          persistent: false
          duplicateServiceObjects: true
          credentials: my-credentials
          opsManager:
            configMapRef:
              name: my-project
          security:
            certsSecretPrefix: <prefix>
            tls:
              ca: custom-ca
          clusterSpecList:
            - clusterName: ${MDB_CLUSTER_1_FULL_NAME}
              members: 3
            - clusterName: ${MDB_CLUSTER_2_FULL_NAME}
              members: 2
            - clusterName: ${MDB_CLUSTER_3_FULL_NAME}
              members: 3
         EOF

   The |k8s-op-short| copies the ConfigMap with the |certauth| that you
   created in step 2 to each member cluster, generates a
   concatenated |pem| secret, and distributes it to the member clusters.

---
stepnum: 0
level: 4
title: "Verify that the MDB resources are running."
ref: verify-mdb-resources-mc
content: |

  a. For member clusters, run the following commands to verify that
     the MongoDB Pods are in the running state:

     .. code-block:: sh

        kubectl get pods \
         --context=$MDB_CLUSTER_1_FULL_NAME \
         --namespace mongodb

     .. code-block:: sh

        kubectl get pods \
         --context=$MDB_CLUSTER_2_FULL_NAME \
         --namespace mongodb

     .. code-block:: sh

        kubectl get pods \
         --context=$MDB_CLUSTER_3_FULL_NAME \
         --namespace mongodb

  #.  In the central cluster, run the following commands to verify that
      the ``MongoDBMulti`` custom resource is in the running state:

      .. code-block:: sh

         kubectl --context=$MDB_CENTRAL_CLUSTER_FULL_NAME \
           --namespace mongodb \
           get mdbm multi-replica-set -o yaml -w

---
stepnum: 0
title: "Create the secret for the TLS certificate of your ``MongoDBMulti`` custom resource."
level: 4
ref: create-k8s-mc-tls-secret
content: |

  Run the ``kubectl`` command to create a new secret that stores the
  MongoDB multi-cluster resource's certificate:

  .. code-block:: sh

     kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
       --namespace=<metadata.namespace> \
       create secret tls <prefix>-<metadata.name>-cert \
       --cert=<resource-tls-cert> \
       --key=<resource-tls-key>

  .. note::

     .. include:: /includes/fact-req-secret-prefix.rst

  .. include:: /includes/fact-example-secret-prefix-cluster-file.rst

  .. include:: /includes/facts/fact-if-use-vault.rst

  .. include:: /includes/facts/fact-learn-more-secret-storage.rst

---
stepnum: 0
title: "Create the secret for your agent's X.509 certificate of your ``MongoDBMulti`` custom resource."
level: 4
ref: create-mc-agent-secret-x509
content: |

  Run the ``kubectl`` command to create a new secret that stores the agent's X.509 certificate:

  .. code-block:: sh

     kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
       --namespace=<metadata.namespace> \
     create secret tls <prefix>-<metadata.name>-agent-certs \
       --cert=<agent-tls-cert> \
       --key=<agent-tls-key>

---
stepnum: 0
title: "Create the secret for the member cluster's internal X.509 certificate."
level: 4
ref: create-mc-secret-x509-internal
content: |

  Run the ``kubectl`` command to create a new secret that stores the internal
  cluster member's X.509 certificate. The member clusters are defined in
  your ``MongoDBMulti`` custom resource.

  .. code-block:: sh

     kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
       --namespace=<metadata.namespace> \
     create secret tls <prefix>-<metadata.name>-clusterfile \
       --cert=<resource-clusterfile-tls-cert> \
       --key=<resource-clusterfile-tls-key>

---
stepnum: 0
ref: create-k8s-mc-tls-configmap
title: "Create the ConfigMap to link your CA with your ``MongoDBMulti`` custom resource."
level: 4
content: |
   Run the ``kubectl`` command to link your |certauth| to your ``MongoDBMulti`` custom resource:

   .. code-block:: sh

      kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
        --namespace=<metadata.namespace> \
        create configmap custom-ca -from-file=ca-pem

---
stepnum: 0
title: "Renew the |k8s-secret| for a ``MongoDBMulti`` resource."
ref: renew-mc-rs-tls-secret
level: 4
content: |

  Run this ``kubectl`` command to renew an existing |k8s-secret| that
  stores the ``MongoDBMulti`` resource's certificates:

  .. code-block:: sh

     kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
     --namespace=<metadata.namespace> \
     create secret tls <prefix>-<metadata.name>-cert \
     --cert=<resource-tls-cert> \
     --key=<resource-tls-key> \
     --dry-run=client \
     -o yaml |
     kubectl apply -f -

---
stepnum: 0
ref: renew-mc-secret-x509-agent
title: "Renew the secret for your agent's X.509 certificates."
level: 4
content: |
   Run the ``kubectl`` command to renew an existing secret that stores
   the ``MongoDBMulti`` resource's agent certificates:


   .. code-block:: sh

      kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
        --namespace=<metadata.namespace> \
      create secret tls <prefix>-<metadata.name>-agent-certs \
        --cert=<agent-tls-cert> \
        --key=<agent-tls-key> \
        --dry-run=client \
        -o yaml | kubectl apply -f -

---
stepnum: 0
ref: renew-secret-internal-x509
title: "Renew the secret for internal members's X.509 certificates of the MongoDBMulti resource."
level: 4
content: |
   Run the ``kubectl`` command to renew an existing secret that stores
   X.509 certificates for internal members of the ``MongoDBMulti`` resource:

   .. code-block:: sh

      kubectl --context $MDB_CENTRAL_CLUSTER_FULL_NAME \
        --namespace=<metadata.namespace> \
      create secret tls <prefix>-<metadata.name>-clusterfile \
        --cert=<resource-clusterfile-tls-cert> \
         --key=<resource-clusterfile-tls-key> \
         --dry-run=client \
         -o yaml | kubectl apply -f -

...
