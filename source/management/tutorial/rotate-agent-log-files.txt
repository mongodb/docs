======================
Rotate Agent Log Files
======================

.. default-domain:: mms

.. contents::
   :backlinks: none
   :local:

Overview
--------

During normal operation, the monitoring agent and backup agent report a live
account of all activity and operations to a log file. When a log file reaches a
user-specified limit, the file must be replaced or rotated.

In most cases, :program:`logrotate` software automatically copies, renames,
compresses, and removes older archived log files.

For systems where a program cannot be told to close its log file, the
:program:`copytruncate` command is available to adapt the log rotation process.

Log Rotation With :program:`logrotate`
--------------------------------------

:program:`logrotate` is installed on most Linux systems in the :file:`/etc`
folder. Check the ``logrotate.conf`` configuration file exists in this
folder or install the :program:`logrotate` package.

The behavior of the :program:`logrotate` command is set in the
``logrotate.conf`` configuration file.

The ``logrotate.conf`` configuration file is called with the
:program:`logrotate` command:

.. code-block:: javascript

   logrotate /etc/logrotate.conf

This command should be run as a cron job to ensure log files are rotated
regularly and, in most cases, run by the root user. :program:`logrotate` often
is called from a script in the `/etc/cron.daily` directory.

The ``logrotate.conf`` file includes a set of commands in a structured format,
for example:

.. code-block:: javascript

   #sample configuration file
   compress
      
   <backup agent log file location> {
       rotate 5
       weekly
   }

   <monitoring agent log file location> {
       rotate 5
       weekly
   }

In this example, the configuration commands include:

- **compress** sets a global option to compress files after each file is rotated.

- **<backup agent log file location>** or **<monitoring agent log file
  location>** sets commands specific to the backup agent or monitoring agent
  log file. The names and locations of backup and monitoring agent log files
  are set when the agents are installed.

  - **rotate 5** sets how many times a log file is rotated before archived logs
    are removed. In this case, the most recent five archived log files are kept
    and the sixth oldest archived log file will always be deleted as part of
    the log rotation process.
  
  - **weekly** sets log rotation to happen on a weekly basis.
  
Log Rotation With :program:`copytruncate`
-------------------------------------------

The :program:`copytruncate` command is used when a program cannot be told to
close its log file. This command copies the contents of the current log file to
a new archive file then deletes the contents of the current log file. New log
activity is added to the now empty current log file.

To rotate log files with :program:`copytruncate`, add the *copytruncate*
setting to the appropriate block in the ``logrotate.conf`` file:

.. code-block:: javascript

   #sample configuration file
   compress
      
   <backup agent log file location> {
       rotate 5
       copytruncate
       weekly
   }

   <monitoring agent log file location> {
       rotate 5
       weekly
   }


When :program:`copytruncate` is used, the :program:`create` command option
has no effect because the old log file stays in place.

There is a very small time window between copy the log file and emptying it.
Some logging data may be lost with this method.

.. seealso:: 
   
   - `logrotate Man Page <http://linuxcommand.org/man_pages/logrotate8.html>`_.

   - `Install the MMS Monitoring Agent
     <https://mms.mongodb.com/help/monitoring/tutorial/set-up-mms/>`_.
     
   - `Install and Start the MMS Backup Agent
     <https://mms.mongodb.com/help/backup/tutorial/install-and-start-backup-agent/>`_.

