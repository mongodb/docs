=================================================
Downgrade |newversion| Standalone to |oldversion|
=================================================

.. include:: /includes/4.2-upgrade-replacements.rst

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/in-dev.rst

Before you attempt any downgrade, familiarize yourself with the content
of this document.

Downgrade Path
--------------

.. include:: /includes/downgrade-path.rst

.. |downgrading| replace:: downgrading

Create Backup
-------------

*Optional but Recommended.*  Create a backup of your database.

Access Control
--------------

If your deployment has access control enabled, your downgrade user
privileges must include privileges to list and manage indexes across
databases. A user with :authrole:`root` role has the required privileges.
      
Prerequisites
-------------

To downgrade from 4.2 to 4.0, you must remove incompatible features
that are persisted and/or update incompatible configuration settings.
These include:

.. |target| replace:: :binary:`~bin.mongod` instance

.. _4.2-downgrade-feature-compatibility-standalone:

1. Downgrade Feature Compatibility Version (fCV)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To downgrade the ``featureCompatibilityVersion`` of your sharded
cluster:

#. Connect a :binary:`~bin.mongo` shell to the |target|.

#. .. include:: /includes/4.2-downgrade-fcv.rst

2. Remove FCV 4.2 Persisted Features
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following steps are necessary only if fCV has ever been set to
``"4.2"``.

Remove all persisted 4.2 features that are :ref:`incompatible with 4.0
<4.2-compatibility-enabled>`. These include:

.. _4.2-downgrade-index-key-standalone:

2a. Index Key Size
``````````````````

.. container::

   .. include:: /includes/extracts/4.2-downgrade-fcv-index-key.rst

.. _4.2-downgrade-index-name-standalone:

2b. Index Name Length
`````````````````````

.. container::

   .. include:: /includes/extracts/4.2-downgrade-fcv-index-name.rst

2c. Unique Index Version
````````````````````````

.. container::

   .. include:: /includes/extracts/4.2-downgrade-fcv-unique-index.rst

   .. tip::

      Perform this operation after you have resolved any :ref:`index
      key size <4.2-downgrade-index-key-standalone>` and :ref:`index
      name length <4.2-downgrade-index-name-standalone>` issues first.

   Script
      .. include:: /includes/extracts/4.2-downgrade-fcv-unique-index-script.rst


3. Update ``tls``-Prefixed Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. container::

   .. include:: /includes/extracts/4.2-changes-options-tls-ssl-downgrade.rst

4. Prepare Downgrade from ``zstd`` Compression
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. _downgrade-standalone-prereq-zstd:

``zstd`` Data Compression
`````````````````````````

.. container::

   The :term:`zstd` compression library is available starting in
   version 4.2.

   If your standalone has any data using :term:`zstd` compression:

   .. tip::

      Perform this step after all the other prerequisite steps have
      been performed.

   #. Stop all writes to your instance.

   #. Create a :binary:`~bin.mongodump` of your database before
      starting the downgrade; :binary:`~bin.mongodump` outputs
      uncompressed data.

      .. code-block:: sh

         mongodump --host <myhost> --port <port> --out mystandalone.uncompressed.fcv4.0

      Include any other options, such as :option:`--username <mongodump
      --username>`, :option:`--password <mongodump --password>`, and
      :option:`--authenticationDatabase <mongodump
      --authenticationDatabase>` if your standalone enforces access
      control.

   #. Create a new empty :option:`data directory <mongod --dbpath>` for
      the :binary:`~bin.mongod` instance. This directory will be used
      in the downgrade procedure below.

      .. important::

         Ensure that the user account running :binary:`~bin.mongod` has
         read and write permissions for the new directory.

   #. If you use a :doc:`configuration file
      </reference/configuration-options>`, update the file to prepare for
      the downgrade procedure:

      a. Delete
         :setting:`storage.wiredTiger.collectionConfig.blockCompressor`
         to use the default compressor (``snappy``) or
         set to another 4.0 supported compressor.

      #. Update :setting:`storage.dbPath` to the new
         data directory.

      | If you use command-line options instead, you will have to update
        the options in the procedure below.

.. _downgrade-standalone-prereq-zstd-journal:

``zstd`` Journal Compression
````````````````````````````

.. container::

   The :term:`zstd` compression library is available for journal data
   compression starting in version 4.2.

   If the :binary:`~bin.mongod` instance uses :term:`zstd` library for
   its journal compressor:

   .. include:: /includes/extracts/4.2-changes-zstd-journal-compression-config-only.rst

   .. note::

      If you encounter an unclean shutdown for a :binary:`~bin.mongod`
      during the downgrade procedure such that you need to use the
      journal files to recover, recover the
      instance using the 4.2 :binary:`~bin.mongod` and then retry the
      downgrade of the instance.

.. _downgrade-standalone-prereq-zstd-network:

``zstd`` Network Compression
````````````````````````````

.. container::

   .. include:: /includes/extracts/4.2-changes-zstd-network-compression.rst

.. |binary| replace:: the :binary:`~bin.mongod` instance


Procedure
---------

.. warning::

   Before proceeding with the downgrade procedure, ensure that the
   prerequisites have been completed.

.. include:: /includes/steps/4.2-downgrade-mongod.rst
