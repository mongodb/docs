.. _backup-continuous:

==================
Continuous Backups
==================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. include:: /includes/admonitions/deprecated-continuous-backup.rst

|service| continuous backups take incremental backups of data in your
cluster, ensuring your backups are typically just a few seconds behind
the operational system. |service| continuous backups allow you to
:doc:`restore </restore-cluster>` from stored snapshots or from a
selected point in time within the last 24 hours. You can also
:doc:`query a continuous backup snapshot </query-backup>`.

For sharded clusters, the backup service temporarily stops the balancer
via the :binary:`mongos <bin.mongos>` in order to insert a marker token
into all shards and config servers in the cluster. |service| takes a
snapshot when the marker tokens appear in the backup data.

.. include:: /includes/fact-continuous-backup-collection-limit.rst

Enable Backup
-------------

You can enable continuous backups when you:

- :doc:`create a cluster </tutorial/create-new-cluster>` or
- :doc:`modify an existing cluster </scale-cluster>`.

If you switch to continuous backups from cloud provider snapshots,
|service| immediately terminates existing backups on your behalf. If
you need to retain any of your cloud provider snapshots, download
them before switching backup methods.

.. seealso::

   To learn how to download a cloud provider snapshot, see the
   :doc:`Restore a Cluster from a Cloud Provider Snapshot </restore/restore-cluster-cloud-provider-snapshot>` page.

From the cluster configuration modal, toggle ``Do you want to enable
backup?`` to ``Yes``. For clusters deployed to
:ref:`Azure <microsoft-azure>`, select the :guilabel:`Continuous`
card.

Enable Point-In-Time Restore for Sharded Clusters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. important::

   This section applies only to sharded clusters running MongoDB with
   |fcv| of 4.0 or earlier. If your sharded clusters run |fcv| 4.2 or
   later, skip this section.

Sharded clusters running MongoDB with |fcv| of 4.0 or earlier require
enabling cluster checkpoints to support point-in-time restoration from
a continuous backup snapshot. Without cluster checkpoints, |service|
can only restore from a snapshot and not from a point-in-time between
snapshots. After enabling continuous backups on the cluster, do the
following to enable cluster checkpoints:

.. include:: /includes/steps/backup-cb-set-snapshot-interval.rst

.. note::

   The :manual:`sharded cluster balancer </core/sharding-balancer-administration>`
   must pause whenever a cluster checkpoint is created.

.. _continuous-snapshot-storage-location:

Snapshot Storage Location
-------------------------

Each project has *one* backup data center location dictated by the
*first* backup-enabled cluster created in that project.

For single-region |service| clusters created after June 21st, 2017,
|service| stores backup data for an |service| cluster in a data center
specific to the cluster's geographic region.

For multi-region |service| clusters, |service| stores backup data for
the cluster in a data center specific to the geographical location of
the cluster's Preferred Region.

.. important::

   All additional backup-enabled clusters created in the project use
   the backup data center selected during deployment of the project's
   *first* backup-enabled cluster regardless of the geographical
   location of the cluster region or regions.

   To change the data center location of a cluster, you must disable
   backups for *all* clusters in the project. You can then enable
   backups for a cluster whose geographic region corresponds to the
   data center location of your choice.

.. list-table::
   :widths: 50 50
   :header-rows: 1

   * - Cluster Location
     - Backup Service Location

   * - USA
     - USA

   * - Germany
     - Germany

   * - United Kingdom
     - United Kingdom

   * - Australia
     - Australia

   * - All other cluster locations
     - Ireland

|service| retains these snapshots based on the
:ref:`retention policy <retention-policy>`.

.. _modify-backup-schedule:

.. _retention-policy:

Snapshot Schedule
-----------------

|service| has the following snapshot schedule, which determines the
frequency and the retention of the snapshots:

.. note::

   If you disable backup for a cluster or terminate a cluster,
   |service| immediately deletes the backup snapshots for the cluster.

.. list-table::
   :widths: 30 30 40
   :header-rows: 1

   * - Snapshot Schedule
     - Default Retention Policy
     - Maximum Retention Setting

   * - Base snapshot every <x> hours
     - 2 days
     - | 5 days
       | (30 days if snapshot taken every 24 hours)
   * - Daily snapshot
     - 7 days
     - 360 days
   * - Weekly snapshot
     - 4 weeks
     - 52 weeks
   * - Monthly snapshot
     - 13 months
     - 84 months

By default, |service| takes base snapshots every 6 hours.

To change a deployment's snapshot schedule, including the retention
policy, go to :guilabel:`Backup`. For the cluster whose snapshot
schedule you wish to modify, click the ellipsis and select
:guilabel:`Edit Snapshot Schedule` menu option.

.. seealso:: To modify the schedule using the API, see
   :doc:`/reference/api/snapshot-schedule`.

.. class:: hidden

   .. toctree::
      :titlesonly:

      /restore-cluster
      /query-backup
      /restore-queryable-backup
