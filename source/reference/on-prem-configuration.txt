=========================
On Prem MMS Configuration
=========================

.. default-domain:: mongodb

.. TODO combine with conf-mms.properties file

Overview
--------

This document outlines the configuration for the On Prem MMS
application.

Required Configuration
----------------------

Application URLs
~~~~~~~~~~~~~~~~

Configure MMS properties, by editing the
``/opt/mongodb/mms/conf/conf-mms.properties`` file. Edit the following
properties according to the needs of your deployment, as in the
following example:

.. code-block:: ini

   mms.centralUrl=http://mms.example.com:8080
   mms.backupCentralUrl=http://mms.example.com:8081

You must set both properties must, even if you are only using MMS
Monitoring and not MMS Backup.

Email
~~~~~

.. note::

   By default, On Prem MMS uses a local SMTP server listening on port ``25``.

Define these properties:

.. code-block:: ini

   mms.centralUrl=http://mms.example.com:8080

   mms.fromEmailAddr=MMS Alerts <mms-alerts@example.com>
   mms.replyToEmailAddr=mms-no-reply@example.com
   mms.adminFromEmailAddr=MMS Admin <mms-admin@example.com>
   mms.adminEmailAddr=mms-admin@example.com
   mms.bounceEmailAddr=bounce@example.com

These properties are blank initially, and you **must** define them
before the |monitoring| instance will start.

MongoDB
~~~~~~~

Define these properties:

.. code-block:: ini

   mongo.mongoUri=<SetToValidUri>
   mongo.replicaSet=<ValidRSIfUsed>

.. _on-prem-authentication-configuration:

Optional: MongoDB Authentication Configuration
----------------------------------------------

For MongoDB nodes running with user authentication, simply
add the username and password credentials to the ``mongoUri``, and
specify the database as admin. For example:

.. code-block:: ini

   mongo.mongoUri=mongodb://<mongouser>:<mongopw>@<127.0.0.1>:<40000>/admin?maxPoolSize=<25>
   mongo.replicaSet=mmsreplset

.. important:: You must modify *every* ``mongoUri`` connection string
   in the ``conf-mms.properties`` file.

The``<mongouser>`` *must* have the following roles:
:authrole:`readWriteAnyDatabase`, :authrole:`clusterAdmin`, and
:authrole:`dbAdminAnyDatabase`.

This does require that you store credentials in plain
text; however, following standard practice you may reduce the
permissions of the configuration file:

.. code-block:: sh

   sudo chmod 600 <install_dir>/conf/conf-mms.properties

If you do not want to store credentials in plain text, |monitoring|
provides a tool to encrypt the MongoDB credentials. To encrypt
authentication credentials:

1. Navigate to the |monitoring| server installation directory.

   .. navigate is a weird verb here.

#. Issue the following command to create an encrypted credential pair,
   replacing ``<username>`` with your username:

   .. code-block:: sh

      bin/credentialstool --username <username> --password

   This will prompt you to enter the password and will output the
   encrypted credential pair.

#. Copy the encrypted credential pair into the ``MongoURI`` connection
   strings of the ``conf/conf-mms.properties`` file where needed, and
   add the ``encryptedCredentials = true`` configuration option to
   indicate to MMS that the credentials are set as encrypted tokens.

   The added line(s) should resemble the following:

   .. code-block:: sh

      mongo.encryptedCredentials=true

.. it seems like this item is more closely related to the discussion
   of this issue earlier...

.. important:: You must modify *every* ``mongoURI`` connection string
   in the ``conf-mms.properties`` file.

Replication Configuration
-------------------------

The backing MongoDB store uses a connection string URI defined in the
``<install_dir>/conf/conf-mms.properties`` directory.

Edit ``conf-mms.properties`` to define the replication hosts. For example:

.. part of the above line needs to be in dobule backquotes.

.. code-block:: ini

   mongo.mongoUri=mongodb://<host1:40000>,<host2:40000>,<host3:40000>/?maxPoolSize=100
   mongo.replicaSet=mmsreplset

.. angle brackets around hosts.

See :manual:`Connection String URI Format </reference/connection-string/>`
for more information.
