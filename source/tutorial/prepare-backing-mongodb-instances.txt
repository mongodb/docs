===================================
Deploy Backing MongoDB Replica Sets
===================================

.. default-domain:: mongodb

Overview
--------

|onprem| uses two dedicated :term:`replica sets <replica set>` to store operational
data: one replica set to store the :ref:`mms-application-database` and another
to store the :ref:`mms-backup-blockstore-database`. If you use multiple application
or blockstore databases, set up separate replica sets for each database.

.. include:: /includes/note-cannot-manage-backing-dbs.rst

The backing MongoDB replica sets are dedicated to operational data and
**must store no other data**.

Replica Sets Requirements
-------------------------

Each replica set that hosts an application or blockstore database:

- Stores data in support of |onprem| operations only **and stores no other data**.

- Must run on a server that meets the :ref:`server prerequisites below
  <backing-instances-prerequisites>`.

- Must run MongoDB 2.6.0 or later.

- Must have the MongoDB ``security.javascriptEnabled`` set to ``true``, which
  is the default. The |application| uses the :query:`$where` query and
  requires this setting be enabled on the |application| database.

- Must **not** run the MongoDB ``notablescan`` option.

.. _backing-instances-prerequisites:

Server Prerequisites
--------------------

The servers that run the replica sets must meet the following requirements.

- The hardware requirements described in
  :ref:`mms-application-database-specifications` or
  :ref:`mms-blockstore-database-specifications`, depending on which
  database the server will host. If a server hosts other |onprem|
  components in addition to the database, you must sum the hardware
  requirements for each component to determine the requirements for the
  server.

- The system requirements in the :manual:`MongoDB Production Notes
  </administration/production-notes>`. The Production Notes include
  important information on :manual:`ulimits </reference/ulimit>`,
  :manual:`NUMA </administration/production-notes#production-numa>`,
  :manual:`Transparent Huge Pages (THP)
  </reference/transparent-huge-pages>`, and other configuration options.

- The MongoDB ports requirements described in
  :doc:`/reference/firewall-configuration`. Each server's firewall rules
  must allow access to the required ports.

- **RHEL servers only**: if the ``/etc/security/limits.d`` directory
  contains the ``90-nproc.conf`` file, remove the file. The file overrides
  ``limits.conf``, decreasing ``ulimit`` settings. Issue the following
  command to remove the file:

  .. code-block:: sh

     sudo rm /etc/security/limits.d/90-nproc.conf

Procedures
----------

Install MongoDB on Each Server
++++++++++++++++++++++++++++++

.. warning::

   Failure to configure servers according to the :manual:`MongoDB
   Production Notes </administration/production-notes>` can lead to
   production failure.

Use servers that meet the above :ref:`prerequisites
<backing-instances-prerequisites>`. 

The following procedure assumes that you
are installing MongoDB on a server running Red Hat Enterprise Linux (RHEL).
If you are installing MongoDB on another Linux operating system,
or you prefer to use ``cURL`` rather than ``yum``,
refer to the :manual:`installation guides </administration/install-on-linux/>`
in the MongoDB manual.

.. include:: /includes/steps/install-mongodb-for-backing-dbs.rst

Deploy a Backing Replica Set
++++++++++++++++++++++++++++

This procedure deploys a three-member replica set dedicated to store
either the |application| database or Backup Blockstore database. Deploy
the replica set to three servers that meet the :ref:`requirements
<backing-instances-prerequisites>` for the database.

Repeat this procedure for each backing replica set that your installation
requires.

.. include:: /includes/steps/deploy-backing-replica-set.rst
