.. _meko-upgrade-om-version:

=================================================
Upgrade Ops Manager and Backing Database Versions
=================================================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2 
   :class: singlecol

Update the major and minor versions of your |onprem| and :term:`backing databases` in the :ref:`k8s-om-specification` that |k8s-op-short| uses to manage your deployment.

Prerequisites
-------------

.. warning::

   To maintain existing settings and availability, back up the following in your current |onprem| instance: 
   
   - ``conf-mms.properties`` and ``gen.key`` files to a 
     secure location. The ``conf-mms.properties`` stores settings
     for the |onprem| instance. The :ref:`gen.key <gen-key>` 
     provides details to encrypt and decrypt |onprem|\s
     backing databases and user credentials. |onprem| might delete 
     these files as part of the upgrade process.
   - :ref:`Application database <appdb-om-arch>`. If the upgrade fails, you need a
     current backup to restore your |onprem| instance. Use ``mongodump`` to back up
     your application database.

1. Upgrade |onprem| by following the considerations, prerequisites, and procedure in :ref:`upgrade-om`.

2. Reference :ref:`compatible-mdb-versions` to ensure your :term:`backing databases` use a MongoDB version that is compatible with the new |onprem| version.

3. If you need to upgrade your backing databases to a compatible MongoDB version, see :ref:`meko-upgrade-mdb-version`.

Procedure
---------

1. In your :ref:`k8s-om-specification`, set the following:
   
   - Set :opsmgrkube:`spec.version` to the new |onprem| version. 
   - If you upgraded your :ref:`application database <appdb-om-arch>`, set :opsmgrkube:`spec.applicationDatabase.version` to the compatible MongoDB version. Consider setting :setting:`spec.featureCompatibilityVersion` to give yourself the option to downgrade if necessary.

   For example, the following resource updates |onprem| from 4.0 to 5.0 and the application database to MongoDB ``4.2.11-ent``. 

   .. literalinclude:: /reference/k8s/example-ops-manager.yaml
      :language: yaml
      :linenos:

2. Reapply the configuration to |k8s|:

   .. code-block:: none

      kubectl apply -f <om-resource-specification>.yaml

   |k8s| automatically reconfigures your deployment with the new specifications. You can see these changes reflected in your |mms| or :cloudmgr:`Cloud Manager </>` application.
