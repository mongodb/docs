==========================
Encrypted Backup Snapshots
==========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Starting in 3.4, |onprem| supports encryption for any backup job that
was stored in a :term:`head database` running `MongoDB Enterprise
<https://www.mongodb.com/products/mongodb-enterprise-advanced>`_ 3.4
or later with the 
:manual:`WiredTiger </core/security-encryption-at-rest/#encrypted-storage-engine>` 
storage engine.

With encrypted backup, you encrypt the :term:`head databases <head
database>` using a master key that is generated and maintained by a
:abbr:`KMIP (Key Management Interoperability Protocol)`-compliant key
management appliance (i.e.
:abbr:`KMIP (Key Management Interoperability Protocol)` server).
As the :term:`Backup Daemon` creates snapshots from the head databases,
resulting snapshots from the encrypted head databases are themselves
encrypted.

To restore from an encrypted backup, you need the same master key used
to encrypt the backup and either the same certificate as is on the
:term:`Backup Daemon` server or a new certificate provisioned with that
key from the :abbr:`KMIP (Key Management Interoperability Protocol)` 
server.

Prerequisites
-------------

- :term:`Head databases <head database>` use `MongoDB Enterprise
  <https://www.mongodb.com/products/mongodb-enterprise-advanced>`_ 3.4
  or later with the WiredTiger :term:`storage engine`.

- :abbr:`KMIP (Key Management Interoperability Protocol)`-compliant key
  management appliance (i.e. :abbr:`KMIP (Key Management
  Interoperability Protocol)` server) to generate and store encryption
  keys.

- A valid :abbr:`KMIP (Key Management Interoperability Protocol)`
  client certificate and :abbr:`KMIP (Key Management Interoperability
  Protocol)` server :abbr:`CA (Certificate Authority)` files. These
  files are used to authenticate |onprem| to the :abbr:`KMIP (Key
  Management Interoperability Protocol)` server. The client certificate
  on the Backup Daemon server must have access to all keys in the
  :abbr:`KMIP (Key Management Interoperability Protocol)` server.

.. important::

   - You must maintain all keys, even rotated keys, in the :abbr:`KMIP
     (Key Management Interoperability Protocol)` server.

.. _setup-kmip-server-conf:

Set up KMIP Server Configuration for |onprem|
---------------------------------------------

.. include:: /includes/steps/set-kmip-values.rst

.. _configure-group-kmip:

Configure Your Group to Use KMIP
--------------------------------

.. note::

   All deployments in the group will use the same :abbr:`KMIP (Key
   Management Interoperability Protocol)` client certificate file to
   authenticate.

.. include:: /includes/steps/set-group-kmip-values.rst

Encrypt Your Backup Job
-----------------------

.. important::
   
   For existing backups in a group, enabling encryption requires an
   initial backup sync to recreate the backups' head databases.

.. include:: /includes/steps/enable-backup.rst
