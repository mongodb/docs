:orphan:

====================================
Compatibility Changes in MongoDB 2.8
====================================

.. default-domain:: mongodb

MongoDB 2.8 is currently in development. While 2.8 release candidates
are currently available, these versions of MongoDB are for **testing
only and not for production use**.

Storage Engine
--------------

Configuration File Options
~~~~~~~~~~~~~~~~~~~~~~~~~~

With the introduction of additional storage engines in 2.8, some
:doc:`configuration file options </reference/configuration-options>`
have changed:

.. list-table::
   :header-rows: 1

   * - Previous Setting
     - New Setting

   * - ``storage.journal.commitIntervalMs``
     -  :setting:`storage.mmapv1.journal.commitIntervalMs`

   * - ``storage.journal.debugFlags``
     - :setting:`storage.mmapv1.journal.debugFlags`

   * - ``storage.nsSize``
     - :setting:`storage.mmapv1.nsSize`

   * - ``storage.preallocDataFiles``
     - :setting:`storage.mmapv1.preallocDataFiles`

   * - ``storage.quota.enforced``
     - :setting:`storage.mmapv1.quota.enforced`

   * - ``storage.quota.maxFilesPerDB``
     - :setting:`storage.mmapv1.quota.maxFilesPerDB`

   * - ``storage.smallFiles``
     - :setting:`storage.mmapv1.smallFiles`

   * - ``storage.syncPeriodSecs``
     - :setting:`storage.mmapv1.syncPeriodSecs`

2.8 :program:`mongod` instances are backward compatible with existing
configuration files, but will issue warnings when if you attempt to
use the old settings.

Data Files Must Correspond to Configured Storage Engine
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The files in the :setting:`~storage.dbPath` directory must correspond
to the configured storage engine (i.e. ``--storageEngine``).
:program:`mongod` will not start if :setting:`~storage.dbPath` contains
data files created by a storage engine other than the one specified by
``--storageEngine``.

Support for ``touch`` Command
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If a storage engine does not support the :dbcommand:`touch`, then the
:dbcommand:`touch` command will return an error:

- The WiredTiger storage engine *does not* support the
  :dbcommand:`touch`.

- The MMAPv1 storage engine supports :dbcommand:`touch`.

Dynamic Record Allocation
~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB 2.8 no longer supports dynamic record allocation and deprecates
``paddingFactor``. For more information, see :ref:`2.8-mmapv1-padding`.

Semantic Changes
----------------

Date and Timestamp Comparison Order
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:ref:`Timestamps <document-bson-type-timestamp>` and :ref:`Date
<document-bson-type-type>` typed values are no longer interchangeably
comparable for the purpose of sorting. If your application relies on
the comparison order of Date and Timestamp objects from MongoDB,
correct your application before upgrading.

Replication Changes
-------------------

Change of ``w: majority`` Semantics
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A write concern with a :ref:`w: majority <wc-w>` value is satisfied
when a majority of the *voting* members replicates a write
operation. In previous versions, *majority* referred a majority of all
voting and non-voting members of the set.

Version Compatibility
~~~~~~~~~~~~~~~~~~~~~

:program:`mongod` instances before 2.6.6 cannot perform an initial sync
against 2.8 replica set members. Do not add :program:`mongod 2.6.6
members to a replica set that has 2.8 members.

.. _2.8-oplog-format-change:

Replica Set Oplog Format Change
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. TODO: link this section to the upgrade instructions.

MongoDB 2.8 is not compatible with oplog entries generated by versions
of MongoDB before 2.2.1. If you upgrade from one of these versions,
you must wait for new oplog entries to overwrite *all* old oplog
entries generated by one of these versions before upgrading to 2.8.0
or earlier.

Secondaries may abort if they replay an oplog from 2.4 or prior with an
index build operation that would normally fail on a 2.6 or later
primary.

.. _2.8-compatibility-repl-set-config:

Replica Set Configuration Validation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB now provides more strict validation of :doc:`replica set
configuration objects </reference/replica-configuration>`. Of
particular note are the following alterations:

- Arbiters may only have ``1`` vote. Previously arbiters could have
  ``0`` votes, which is no longer supported. You must fix on the
  primary and restart the :program:`mongod`.

- Members can **only** have
  :data:`~local.system.replset.members[n].votes` value of ``0`` or
  ``1``. Will fail to load. Must fix this setting on the primary and
  restart the :program:`mongod` instance`.

- :doc:`/reference/replica-configuration` must specify the same
  ``_id`` name as that specified by ``--replSet`` or
  :setting:`replication.replSetName`.

- Unrecognized configuration fields produce an invalid config and an
  error. Previously, ignored these fields. For example, tokutek adds a
  ``protocolVersion`` field, which will now result in error.

- Disallows ``getLastErrorDefaults: 0`` in a config.

.. _recover-from-invalid-config:

Recover a Replica Set from an Invalid Configuration
```````````````````````````````````````````````````

In MongoDB version 2.8, :program:`mongod` will fail to start if it has
an invalid replica set configuration stored in the
:data:`local.system.replset` collection. Due to MongoDB 2.8's strict
validation of replica set configuration objects, a configuration that
was valid in MongoDB 2.6 may not be valid in MongoDB 2.8.

If your replica set configuration was valid in a previous version of
MongoDB and fails to start in MongoDB 2.8, :doc:`downgrade to MongoDB
2.6 </release-notes/2.8-downgrade>`, and reconfigure your replica set to
fulfill the new requirements. Then, you can re-upgrade to MongoDB 2.8.

Remove ``local.slaves`` Collection
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB 2.8 removes the ``local.slaves`` collection that tracked the
slaves' replication progress. To track slave's replication progress,
refer to the :data:`serverStatus.repl` section of
:dbcommand:`serverStatus`.

Replica Set State Change
~~~~~~~~~~~~~~~~~~~~~~~~

The ``FATAL`` replica set state does not exist as of 2.8.0.

HTTP Interface
~~~~~~~~~~~~~~

The HTTP Interface (i.e. :setting:`net.http.enabled`) no longer
reports replication data.

MongoDB Tools Changes
---------------------

.. _tools-remove-dbpath-support:

Require a Running MongoDB Instance
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The 2.8 versions of MongoDB tools, :program:`mongodump`,
:program:`mongorestore`, :program:`mongoexport`,
:program:`mongoimport`, :program:`mongofiles`, and
:program:`mongooplog`, must connect to running MongoDB instances and
*cannot* modify MongoDB data files (i.e. with ``--dbpath``) as in
previous versions.

Removed Options
~~~~~~~~~~~~~~~

- Removed ``--dbpath`` and ``--filter`` options for
  :program:`mongorestore`, :program:`mongoimport`,
  :program:`mongoexport`, and :program:`bsondump`.

- Removed ``--locks`` option for :program:`mongotop`.

.. seealso:: :ref:`2.8-tools-enhancements`

Sharded Cluster Setting
-----------------------

Remove ``releaseConnectionsAfterResponse`` Parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB now always releases connections after response.
``releaseConnectionsAfterResponse`` parameter is no longer available.

Security Changes
----------------

.. _legacy-auth-model-removed:

MongoDB 2.4 User Model Removed
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

After deprecating the 2.4 user model in 2.6, MongoDB 2.8 completely removes
support for the 2.4 user model. MongoDB will exit with an error
message there is user data with the 2.4 schema.
If your deployment still uses the 2.4 user model, see
:doc:`/release-notes/2.6-upgrade-authorization` to upgrade to the 2.6
user model before upgrading to 2.8.

.. _2.8-compatibility-localhost:

Localhost Exception Changed
~~~~~~~~~~~~~~~~~~~~~~~~~~~

In 2.8, the localhost exception changed so that these connections *only*
have access to create the first user on the ``admin``
database. In previous versions, connections that gained access using
the localhost exception had unrestricted access to the MongoDB
instance.

See :ref:`localhost-exception` for more information.

``db.addUser()`` Removed
~~~~~~~~~~~~~~~~~~~~~~~~

2.8 removes the legacy ``db.addUser()`` method. Use
:method:`db.createUser()` and :method:`db.updateUser()` instead.

SSL Configuration Option Changes
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB 2.8 introduced new :setting:`net.ssl.allowConnectionsWithoutCertificates`
configuration file setting and ``--sslAllowConnectionsWithoutCertificates``
command line option for :program:`mongod` and :program:`mongos`. These
options replace previous :setting:`net.ssl.weakCertificateValidation` and
``--sslWeakCertificateValidation`` options, which became
aliases. Update your configuration to ensure future compatibility.

.. _2.8-compatibility-certificate-validation:

SSL Certificates Validation
~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default, MongoDB instances will *only* start if its certificate
(i.e. :setting:`net.ssl.PemKeyFile`) is valid. You can disable this
behavior with the :setting:`net.ssl.allowInvalidCertificates` setting
or the ``--sslAllowInvalidCertificates`` command line option.

.. _2.8-compatibility-certificate-hostname-validation:

SSL Certificate Hostname Validation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default, MongoDB validates the hostnames of hosts attempting to connect
using certificates against the hostnames listed in those certificates. In
certain deployment situations this behavior may be undesirable. It is now
possible to disable such hostname validation without disabling validation of
the rest of the certificate information with the
:setting:`net.ssl.allowInvalidHostnames` setting or the
``--sslAllowInvalidHostnames`` command line option.

SSLv3 Ciphers Disabled
~~~~~~~~~~~~~~~~~~~~~~

In light of `vulnerabilities in legacy SSL ciphers
<https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3566>`_,
these ciphers have been explicitly disabled in MongoDB. No
configuration changes are necessary.

``mongo`` Shell Version Compatibility
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Versions of the :program:`mongo` shell before 2.8 are *not*
compatible with 2.8 deployments of MongoDB that enforce access
control. If you have a 2.8 MongoDB deployment that requires
access control, you must use 2.8 versions of the :program:`mongo`
shell.

Indexes
-------

Remove ``dropDups`` Option
~~~~~~~~~~~~~~~~~~~~~~~~~~

``dropDups`` option is no longer available for
:method:`~db.collection.ensureIndex()` and :dbcommand:`createIndexes`.

Changes to Restart Behavior during Background Indexing
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For 2.8 :program:`mongod` instances, if a background index build is in
progress when the :program:`mongod` process terminates, when the
instance restarts the index build will restart as foreground index
build. If the index build encounters any errors, such as a duplicate
key error, the :program:`mongod` will exit with an error.

To start the :program:`mongod` after a failed index build, use the
:setting:`storage.indexBuildRetry` or :option:`--noIndexBuildRetry
<mongod --noIndexBuildRetry>` to skip the index build on start up.

.. _2.8-geo-near-compatibility:

``2d`` Indexes and Geospatial Near Queries
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For :query:`$near` queries that use a :doc:`2d </core/2d>` index:

- MongoDB no longer uses a default limit of 100 documents.

- Specifying a :method:`~cursor.batchSize()` is no longer analogous to
  specifying a :method:`~cursor.limit()`.

For :query:`$nearSphere` queries that use a :doc:`2d </core/2d>` index,
MongoDB no longer uses a default limit of 100 documents.

``mongo`` Shell Version Compatibility
-------------------------------------

WiredTiger and Previous Versions
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For 2.8 MongoDB deployments using the WiredTiger storage engine, the
following operations return no output when issued in previous versions
of the :program:`mongo` shell:

- :method:`db.getCollectionNames()`
- :method:`db.collection.getIndexes()`
- ``show collections``
- ``show tables``

Use the 2.8 :program:`mongo` shell when connecting to 2.8
:program:`mongod` instances that use WiredTiger.

General Compatibility Changes
-----------------------------

Deprecate Access to ``system.indexes`` and ``system.namespaces``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB 2.8 deprecates *direct* access to ``system.indexes`` and
``system.namespaces`` collections. Use the :dbcommand:`createIndexes`
and :dbcommand:`listIndexes` commands instead.

Collection Name Validation
~~~~~~~~~~~~~~~~~~~~~~~~~~

MongoDB 2.8 more consistently enforces the :limit:`collection naming
restrictions <Restriction on Collection Names>`. Ensure your application
does not create or depend on invalid collection names.

Platform Support
~~~~~~~~~~~~~~~~

No longer provides commercial support for MongoDB on Linux32 and Win32
platforms; however, will continue to build the MongoDB distributions
for the platforms.

Removed/Deprecated Commands
~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following commands are no longer available in MongoDB 2.8:

- ``closeAllDatabases``

- ``getoptime``

- ``text``

The following command is deprecated in MongoDB 2.8:

- :dbcommand:`diagLogging`

Driver Compatibility Changes
----------------------------

Each officially supported driver has a release designed for full
compatibility with MongoDB 2.8. Upgrading to one of these drivers
is strongly recommended as part of the upgrade process.

A driver upgrade is **necessary** in certain scenarios due to
changes in functionality:

- Use of the ``SCRAM-SHA-1`` authentication method
- Use of functionality that calls ``listIndexes`` or
  ``listCollections``

The minimum fully compatible driver versions are:

.. list-table::
   :header-rows: 1

   * - Driver Lanugage
     - Minimum Fully Compatible Version

   * - :ecosystem:`C </drivers/c>`
     - `1.1.0 <https://github.com/mongodb/mongo-c-driver/releases>`_

   * - `C++ <https://github.com/mongodb/mongo-cxx-driver>`_
     - `1.0.0 <https://github.com/mongodb/mongo-cxx-driver/releases>`_

   * - :ecosystem:`C# </drivers/csharp>`
     - `1.10 <https://github.com/mongodb/mongo-csharp-driver/releases>`_

   * - :ecosystem:`Java </drivers/java>`
     - `2.13 <https://github.com/mongodb/mongo-java-driver/releases>`_

   * - :ecosystem:`Node.js </drivers/node-js>`
     - `1.4.18 <https://github.com/mongodb/node-mongodb-native/releases>`_

   * - :ecosystem:`Perl </drivers/perl>`
     - `Pending <http://search.cpan.org/dist/MongoDB/>`_

   * - :ecosystem:`PHP </drivers/php>`
     - `1.5 <http://pecl.php.net/package/mongo>`_

   * - :ecosystem:`Python </drivers/python>`
     - `2.8 <https://pypi.python.org/pypi/pymongo/>`_

   * - :ecosystem:`Motor </drivers/python>`
     - `0.4 <https://pypi.python.org/pypi/motor/>`_

   * - :ecosystem:`Ruby </drivers/ruby>`
     - `1.12 <https://rubygems.org/gems/mongo>`_

   * - :ecosystem:`Scala </drivers/scala>`
     - `2.8 <https://github.com/mongodb/casbah/releases>`_
