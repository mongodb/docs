.. _manage-online-archive:

======================
Manage Online Archives 
======================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. include:: /includes/serverless-preview-dont-use.rst

After you :ref:`configure <config-online-archive>` an online archive, 
you can do the following: 

- :ref:`View <view-online-archive>` your online archive
- :ref:`Edit <edit-online-archive>` your online archive 
- :ref:`Query <query-online-archive>` your online archive 
- :ref:`Delete <delete-online-archive>` your online archive

.. _view-online-archive:

View Online Archives
--------------------

.. include:: /includes/serverless-preview-dont-use.rst

You can view the list of online archives for a {+cluster+} through the 
{+atlas-cli+}, {+atlas-ui+}, and |api|. 

.. _view-online-archive-atlas-cli:

Retrieve an Online Archive Using the {+atlas-cli+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/atlas-clusters-onlineArchives-list.rst

.. _view-online-archive-api:

Retrieve an Online Archive Using the API 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To retrieve an online archive through the |api|, send a ``GET`` request 
to the :ref:`onlineArchives <api-online-archive>` endpoint with the 
unique ID of the online archive to retrieve. To learn more about the
|api| syntax and options, see :ref:`api-online-archive-get-one`.

.. _view-online-archives-get-api:

Retrieve All Online Archives for a {+Cluster+} Using the API 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To retrieve all the online archives configured for a {+cluster+} using 
the |api|, send a ``GET`` request to the :ref:`onlineArchives 
<api-online-archive>` endpoint for the {+cluster+}. To learn more about 
the syntax and options, see :ref:`api-online-archive-get-all-for-clstr`.

.. _view-online-archive-ui:

View Online Archives in the UI
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To view the list of Online Archives:

.. include:: /includes/steps/view-online-archive.rst

The page displays the online archives for the {+cluster+}. For each 
online archive, you can see the following information: 

.. list-table:: 
   :header-rows: 1
   :widths: 30 70 

   * - Column Name 
     - Description

   * - :guilabel:`Archive Field` 
     - The date field based on which documents are archived. 

   * - :guilabel:`Archive Last Updated` 
     - The date when the archive was last modified.

   * - :guilabel:`Archival Age Limit` 
     - The number of days used to qualify documents for archiving.

   * - :guilabel:`Deletion Age Limit`
     - The number of days after which to delete the data in the archive.

   * - :guilabel:`Partition Fields` 
     - The other commonly used query fields used for partitioning data 
       on the cloud object storage.

   * - :guilabel:`Status`
     - The status of the :guilabel:`Online Archive`. Value can be one 
       of the following: 

       .. include:: /includes/fact-online-archive-statuses.rst

   * - :guilabel:`Actions` 
     - Operations that you can perform on the :guilabel:`Online 
       Archive`.

.. _edit-online-archive:

Edit an Archiving Rule
----------------------

.. include:: /includes/serverless-preview-dont-use.rst

You can modify the number of days to keep data on the |service| 
{+cluster+} (the :guilabel:`Age Limit`) or the custom |json| query used 
to select documents for archiving from the {+atlas-ui+} and |api|. You 
can't change the archiving criteria from :guilabel:`Date Match` to 
:guilabel:`Custom Filter`, or vice versa.

.. _edit-online-archive-atlas-cli:

Edit an Archiving Rule Through the {+atlas-cli+}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/atlas-clusters-onlineArchives-update.rst

.. _edit-online-archive-api:

Edit an Archiving Rule Through the API 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To edit an online archive through the |api|, send a ``PATCH`` request 
to the :ref:`onlineArchives <api-online-archive>` endpoint with the 
unique ID of the online archive to update. To learn more about the 
|api| syntax and options, see :ref:`api-online-archive-update-one`.

.. _edit-online-archive-ui:

Edit an Archiving Rule Through the UI 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To edit an online archive, in your {+atlas-ui+}: 

.. include:: /includes/steps/edit-online-archive-rule.rst 

.. _edit-online-archive-partitions:

Edit the Partition on the Cloud Object Store
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can't modify the partition fields or structure from the 
{+atlas-ui+} or |api|. However, you can manually migrate the data from 
the cloud object storage using |mongodump|, :ref:`delete 
<delete-online-archive>` the online archive, use |mongorestore| to 
restore the data on the |service| {+cluster+}, and then create a new online 
archive for the collection with the desired partition fields and 
structure.

.. _query-online-archive:

Query Online Archive
--------------------

You can run queries against your archived data. 

Connection String 
~~~~~~~~~~~~~~~~~

To run queries, you must first connect to your {+Online-Archive+}. Your 
:ref:`cluster connection string <gswa-connect>` allows you to only 
query data in your |service| cluster. To query your {+Online-Archive+}, 
you must use one of the following: 

- :ref:`connect-online-archive-cluster-atlas-ui` - this read-only 
  connection string allows you to read data directly from the live 
  cluster. This impacts available resources for |iops|, and from your 
  {+Online-Archive+}.
- :ref:`connect-online-archive-atlas-ui` - this read-only 
  connection string allows you to read data from the {+Online-Archive+} 
  only and doesn't affect cluster resources.

Performance Considerations 
~~~~~~~~~~~~~~~~~~~~~~~~~~

In general, your queries against archived data are much slower than 
your queries against data on the |service| cluster. When you query data 
in your cluster and {+Online-Archive+} through the federated connection 
string:

- Blocking queries, such as sorts that consume and process all input 
  documents to the sort operation before returning results, have  
  performance characteristics associated with the slowest storage, the 
  archive, being queried. The sort operations require all data from the 
  sources being queried before returning the results.
- Streaming queries, such as finds, have performance characteristics 
  associated with the highest performing storage, the |service| 
  cluster, being queried. |service| returns the results as soon as they 
  are available, which means returning results from the archive takes 
  longer than returning results from the |service| cluster.

Query Price 
~~~~~~~~~~~

For your federated and archive-only queries, you incur costs for the 
following items.

Data Scan 
`````````

During data scan, |service| processes data from both the cluster and 
the archive. |service| runs as much of the query on the cluster as it 
can to minimize the amount of data it needs to scan. For example, for a 
``match`` query that specifies a specific value, |service| only 
retrieves documents with the specified value from the cluster. 
|service| then combines the retrieved documents with the archived data 
and returns.

For blocking queries that need to access all data stored in the 
underlying cluster, |service| retrieves all data. For example, for a 
``sort`` (with no ``match``), |service| retrieves all data from the 
cluster and archive to be sorted.

Data Access 
```````````

MongoDB charges a fee for each partition that you query in the archive. 
If your query requires querying specific partitions, MongoDB downloads 
the partitions and each downloaded partition corresponds to a single 
access.

Data Seek 
`````````

To find partitions based on the query and query fields, |service| runs 
operations on the archive. Each such operation that |service| runs 
finds up to 1000 partitions. |service| runs the minimum number of 
required operations to find the partitions required to satisfy the 
query. For example, if your query requires 100 partitions that are 
covered in your query fields, |service| runs only one operation to 
satisfy the query.

Data Transfer 
`````````````

Data that is transferred to the federated infrastructure incurs data 
transfer costs.

.. _delete-online-archive: 

Delete an Online Archive
------------------------

.. include:: /includes/serverless-preview-dont-use.rst

You can delete an online archive through the {+atlas-ui+} and |api|. 
When you remove an online archive, you also delete data on the cloud 
object storage for the online archive. After you delete this data, you 
can't restore it.

If you drop a :manual:`database </reference/command/dropDatabase/>`
or :manual:`collection </reference/command/drop/>` configured for 
online archive, the data from the collection, if archived, continues to 
be available on the cloud object storage. You incur costs for storage 
on the cloud object storage. Alternatively, if you :doc:`delete the 
{+cluster+} </reference/api/clusters-delete-one>`, |service| deletes 
all the online archives configured for the {+cluster+}. This also 
deletes any archived data from the cloud object storage.

If you delete all the online archives, you also delete the {+fdi+} 
and you create a new {+fdi+} when you create an online archive 
again.

After you delete an online archive, its state moves to ``Deleted``. 
You can create another online archive for the same database, 
collection, and fields as the deleted online archive if there is no 
other online archive for the same database, collection, and fields in 
the ``Active`` state.

.. _delete-online-archive-atlas-cli:

Delete an Online Archive Through the {+atlas-cli+} 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: /includes/extracts/atlas-clusters-onlineArchives-delete.rst

.. _delete-online-archive-ui: 

Delete an Online Archive from the UI 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To delete an online archive, in your {+atlas-ui+}: 

.. include:: /includes/steps/delete-online-archive.rst

.. _delete-online-archive-api: 

Delete an Online Archive Through the API 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To delete an online archive through the |api|, send a ``DELETE`` 
request to the :ref:`onlineArchives <api-online-archive>` endpoint with 
the unique ID of the online archive to delete. To learn more about the 
|api| syntax and options, see :ref:`api-online-archive-delete-one`.
