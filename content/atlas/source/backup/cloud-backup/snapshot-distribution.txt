.. _snapshot-distribution:

====================================
Copy Snapshots to Additional Regions
====================================

.. meta::
   :description: Configure Atlas to automatically copy snapshots to other regions for enhanced disaster recovery and optimized restore speeds.

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

.. composable-tutorial::
   :options: interface
   :defaults: atlas-ui 

   By default, {+service+} {+Cloud-Backup+} stores snapshots in the same
   cloud provider region as the cluster's current primary node. You can
   configure {+service+} to store copies of your snapshots in additional
   regions by defining a **snapshot copy policy** for your cluster.
   
   A snapshot copy policy includes one or more policy items. Each item
   defines the following for a specified cloud provider region:

   - Frequency for copying snapshots to that region
   - Retention time for snapshots copied at that frequency
   - Whether to copy oplogs to support :ref:`point-in-time restore
     <restore-from-continuous>` in that region

   Snapshot copy policies can improve resiliency and restore speeds for
   your cluster. If your primary region goes down and your original
   snapshot becomes unavailable, {+service+} can use copied snapshots in
   other regions to restore your cluster. Additionally, if you copy
   snapshots to every region in a multi-region cluster, {+service+} can
   perform faster direct attach restores instead of slower streaming
   restores to restore your cluster after a regional outage.

   If you enabled :ref:`{+PIT-Restore+} <pit-restore>` for your cluster,
   you can also configure your snapshot copy policy to copy oplogs to
   your snapshot copy regions. {+service+} can perform a |pit| restore
   using a copied oplog in the event of a regional outage in your cloud
   provider.

   Required Access
   ---------------

   To modify or delete backup policies, you must have
   :authrole:`Project Backup Manager` or :authrole:`Project Owner` 
   access to the project. Users with :authrole:`Organization Owner` 
   access must add themselves as a ``Project Backup Manager`` or
   ``Project Owner`` to the project before they can modify or delete 
   backup policies.

   Considerations
   --------------

   -  If you have a :ref:`{+bcp+} <backup-compliance-policy>` enabled
      with the :guilabel:`Keep all snapshots when removing additional
      snapshot regions` option set to :guilabel:`On` and you modify or
      delete a snapshot policy item, any existing snapshots are retained
      until their scheduled expiration date.

   - If you :ref:`change your cluster's primary region
     <scale-cluster-region>` to a secondary region that you currently
     have configured for snapshot copy distribution, {+service+}
     automatically updates your backup policy to distribute snapshots
     copies from your new primary region to the original primary region
     (now a secondary region) and other secondary regions configured for
     snapshot distribution.

   - If you enable a :ref:`peering connection <vpc-peering>` and
     restrict certain regions for |gcp|, you can copy snapshots to only
     those regions.
     
   - Oplog copy distribution is enabled at the copy region level. If you
     set :guilabel:`Point-in-Time Restore` to :guilabel:`On` for a
     snapshot copy policy item, {+service+} copies oplogs to that copy
     region and enables :ref:`point-in-time restores
     <restore-from-continuous>` for all snapshot copy policies in that 
     copy region.

   Enable Snapshot Copy Distribution
   ---------------------------------

   .. selected-content:: 
      :selections: atlas-ui

      .. include:: /includes/backup/steps-enable-snapshot-copy-distribution-ui.rst

   .. selected-content:: 
      :selections: atlas-admin-api

      .. include:: /includes/backup/steps-enable-snapshot-copy-distribution-api.rst

   Update Snapshot Copy Policy
   ---------------------------

   .. selected-content:: 
      :selections: atlas-ui

      .. include:: /includes/backup/steps-update-snapshot-copies-policy-ui.rst


   .. selected-content:: 
      :selections: atlas-admin-api

      .. include:: /includes/backup/steps-update-snapshot-copies-policy-api.rst

   Disable Snapshot Copy Distribution
   ----------------------------------

   .. selected-content:: 
      :selections: atlas-ui

      .. include:: /includes/backup/steps-disable-snapshot-copy-distribution-ui.rst

   .. selected-content:: 
      :selections: atlas-admin-api

      .. include:: /includes/backup/steps-disable-snapshot-copy-distribution-api.rst

   .. _example-snapshot-copy-policy:

   Example Snapshot Copy Policy
   ----------------------------

   .. include:: /includes/backup/example-copy-snapshot-policy.rst

  

