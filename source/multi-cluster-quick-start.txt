.. _multi-cluster-quick-start-ref:

=========================
Multi-Cluster Quick Start
=========================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. important::
   Use the beta release of the |multi-clusters| only in development
   environments.

Overview
--------

Using |multi-clusters|, you can deploy |k8s-op-full| to manage
MongoDB deployments that span more than one |k8s| cluster.

This tutorial demonstrates how you can use the |k8s-op-short| to deploy
a MongoDB replica set across three |k8s| member clusters, using |gke|
and |istio| service mesh.

The beta release of the |multi-clusters| offers you different layers of
availability, depending on the needs of your enterprise application. You
can use this tutorial to deploy:

- **Single Region, Multi AZ**. One or more |k8s| clusters where each
  cluster has nodes deployed in different zones in the same region.
  Such deployments protect MongoDB instances backing your enterprise
  applications against failures and offer increased availability,
  disaster recovery, and data distribution within one cloud region.

- **Multi Region**. One or more |k8s| clusters where you:

  - Deploy each cluster in a different region, and
  - Within each region, deploy cluster nodes in different availability
    zones.

  Such deployments allow you to add MongoDB instances in global clusters
  that span multiple geographic regions for increased availability and
  global distribution of data.

|istio| manages the discovery of MongoDB nodes deployed in different
|k8s| member clusters. Each |multi-cluster| that uses |istio| comprises
one |k8s| central cluster and one or more member clusters.

- Central cluster contains:

  - |k8s-op-full|
  - |onprem|, if you deploy it with the |k8s-op-short|
  - |k8s-op-short| ``MongoDBMulti`` CustomResource spec for the MongoDB
    replica set.

- Member |k8s| clusters host the MongoDB replica sets.

You can host your application on any of the member clusters inside the
Istio service mesh, either on |k8s| clusters outside of the ones that you
deploy with the |k8s-op-short|, or on the member clusters that you deploy
as part of this tutorial.

To learn more, see the :ref:`multi-cluster-diagram`.

Services and Tools
------------------

This tutorial relies on the following services, tools, and their
documentation:

- |k8s| clusters. This tutorial uses |gke| to provision multiple
  |k8s| clusters. Each |k8s| member cluster hosts a MongoDB replica set
  deployment and represents a data center that serves your application.

- |istio| service mesh. This tutorial uses |istio| to facilitate
  `DNS resolution <https://istio.io/latest/docs/ops/configuration/traffic-management/dns-proxy/>`__
  for MongoDB replica sets deployed in different |k8s| clusters.

- :github:`MongoDB Enterprise Kubernetes Operator repository
  </mongodb/mongodb-enterprise-kubernetes>` with configuration
  files that the |k8s-op-short| needs to deploy a |k8s| cluster.

- Documentation from Istio to `Install Multicluster <https://istio.io/latest/docs/setup/install/multicluster/>`__.

- :github:`install_istio_separate_network script </mongodb/mongodb-enterprise-kubernetes/blob/master/tools/multicluster/install_istio_separate_network.sh>`
  that is based on Istio documentation and provides an example
  installation that uses the `multi-primary mode on different networks
  <https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/>`__.

- :github:`multi-cluster kubeconfig creator </mongodb/mongodb-enterprise-kubernetes/blob/master/tools/multicluster/main.go>`
  tool that performs the following actions:

  - Creates a single ``mongodb`` namespace in the central cluster and
    each member cluster.
  - Creates Service Accounts, Roles, and RoleBindings in the central
    cluster and each member cluster.
  - Puts Service Account token secrets from each member cluster into a
    single ``kubeconfig`` file and saves the file in the central cluster.
    This enables authorized access from the |k8s-op-short| installed in
    the central cluster to the member clusters.

.. _multi-cluster-prereqs:

Prerequisites
-------------

This tutorial requires that you:

1. Set the environment variables with cluster names and the
   `available GKE zones <https://cloud.google.com/compute/docs/regions-zones#available>`__
   where you deploy the cluster, as in this example:

   .. code-block:: sh

      export MDB_GKE_PROJECT={GKE project name}

      export MDB_CENTRAL_CLUSTER="mdb-central"
      export MDB_CENTRAL_CLUSTER_ZONE="us-west1-a"

      export MDB_CLUSTER_1="mdb-1"
      export MDB_CLUSTER_1_ZONE="us-west1-b"

      export MDB_CLUSTER_2="mdb-2"
      export MDB_CLUSTER_2_ZONE="us-east1-b"

      export MDB_CLUSTER_3="mdb-3"
      export MDB_CLUSTER_3_ZONE="us-central1-a"

      export MDB_CENTRAL_CLUSTER_FULL_NAME="gke_${MDB_GKE_PROJECT}_${MDB_CENTRAL_CLUSTER_ZONE}_${MDB_CENTRAL_CLUSTER}"

      export MDB_CLUSTER_1_FULL_NAME="gke_${MDB_GKE_PROJECT}_${MDB_CLUSTER_1_ZONE}_${MDB_CLUSTER_1}"
      export MDB_CLUSTER_2_FULL_NAME="gke_${MDB_GKE_PROJECT}_${MDB_CLUSTER_2_ZONE}_${MDB_CLUSTER_2}"
      export MDB_CLUSTER_3_FULL_NAME="gke_${MDB_GKE_PROJECT}_${MDB_CLUSTER_3_ZONE}_${MDB_CLUSTER_3}"

#. Set up |gke| clusters:

   a. Set up your Google Cloud account and the ``gcloud`` tool, using the
      `Google Kubernetes Engine Quickstart <https://cloud.google.com/kubernetes-engine/docs/quickstart>`__.

   #. Create one central cluster and one or more member clusters, specifying
      the zones, the number of nodes, and the instance types, as in these
      examples:

      .. code-block:: sh

         gcloud container clusters create $MDB_CENTRAL_CLUSTER \
           --zone=$MDB_CENTRAL_CLUSTER_ZONE \
           --num-nodes=5 \
           --machine-type "e2-standard-2"

      .. code-block:: sh

         gcloud container clusters create $MDB_CLUSTER_1 \
           --zone=$MDB_CLUSTER_1_ZONE \
           --num-nodes=5 \
           --machine-type "e2-standard-2"

      .. code-block:: sh

         gcloud container clusters create $MDB_CLUSTER_2 \
           --zone=$MDB_CLUSTER_2_ZONE \
           --num-nodes=5 \
           --machine-type "e2-standard-2"

      .. code-block:: sh

         gcloud container clusters create $MDB_CLUSTER_3 \
           --zone=$MDB_CLUSTER_3_ZONE \
           --num-nodes=5 \
           --machine-type "e2-standard-2"

#. Obtain user authentication credentials for the central and member
   clusters and save the credentials. You will later use these
   authentication credentials for running ``kubectl`` commands on
   these |k8s| clusters. Run the following commands:

   .. code-block:: sh

      gcloud container clusters get-credentials $MDB_CENTRAL_CLUSTER \
        --zone=$MDB_CENTRAL_CLUSTER_ZONE

      gcloud container clusters get-credentials $MDB_CLUSTER_1 \
        --zone=$MDB_CLUSTER_1_ZONE

      gcloud container clusters get-credentials $MDB_CLUSTER_2 \
        --zone=$MDB_CLUSTER_2_ZONE

      gcloud container clusters get-credentials $MDB_CLUSTER_3 \
        --zone=$MDB_CLUSTER_3_ZONE

#. Install |istio| in a
   `multi-primary mode on different networks <https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/>`__,
   using the
   :github:`install_istio_separate_network script </mongodb/mongodb-enterprise-kubernetes/blob/master/tools/multicluster/install_istio_separate_network.sh>`.
   To learn more, see the `Install Multicluster <https://istio.io/latest/docs/setup/install/multicluster/>`__
   documentation from Istio.

#. `Install Go <https://golang.org/dl/>`__ v1.16 or later.

#. `Install Helm <https://helm.sh/docs/intro/install/>`__.

Procedure
---------

.. include:: /includes/steps/multi-cluster-beta-quick-start.rst

Troubleshooting Mutli-Cluster Deployments
-----------------------------------------

To troubleshoot your multi-cluster deployments, use the procedures in this
section.

Recovering from Cluster Failure
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This procedure uses the same cluster names as in the :ref:`Prerequisites <multi-cluster-prereqs>`.
If the cluster ``MDB_CLUSTER_1`` that holds MongoDB nodes goes down, and
if you provision a new cluster named ``MDB_CLUSTER_4`` instead of
``MDB_CLUSTER_1`` to hold the new MongoDB nodes, run the
:github:`multi-cluster kubeconfig creator </mongodb/mongodb-enterprise-kubernetes/blob/master/tools/multicluster/main.go>`
tool with the updated list of member clusters, and then edit the ``MongoDBMulti``
CustomResource spec on the central cluster.

To reconfigure the multi-cluster deployment after a cluster failure,
replace the failed cluster with the newly provisioned cluster as follows:

1. Run the :github:`multi-cluster kubeconfig creator </mongodb/mongodb-enterprise-kubernetes/blob/master/tools/multicluster/main.go>`
   tool with the new cluster ``MDB_CLUSTER_4`` specified in the
   ``-member-clusters`` flag. This enables the |k8s-op-short| to 
   communicate with the new cluster to schedule MongoDB nodes on it. In
   the following example, ``-member-clusters`` contains ``${MDB_CLUSTER_4_FULL_NAME}``.

   .. code-block:: sh

      go run tools/multicluster/main.go \
        -central-cluster="${MDB_CENTRAL_CLUSTER_FULL_NAME}" \
        -member-clusters="${MDB_CLUSTER_4_FULL_NAME},${MDB_CLUSTER_2_FULL_NAME},${MDB_CLUSTER_3_FULL_NAME}" \
        -member-cluster-namespace="mongodb" \
        -central-cluster-namespace="mongodb"

2. On the central cluster, locate and edit the ``MongoDBMulti``
   CustomResource spec to add the new cluster name to the
   ``clusterSpecList`` and remove the failed cluster from this list.
   The resulting list of cluster names should be similar to the following:

   .. code-block:: sh

      clusterSpecList:
         clusterSpecs:
          - clusterName: ${MDB_CLUSTER_4_FULL_NAME}
            members: 3
          - clusterName: ${MDB_CLUSTER_2_FULL_NAME}
            members: 2
          - clusterName: ${MDB_CLUSTER_3_FULL_NAME}
            members: 3

3. Restart the |k8s-op-short| Pod. After the restart, the |k8s-op-short|
   should reconcile the MongoDB deployment on the newly created
   ``MDB_CLUSTER_4`` cluster that has been created as a replacement for
   the ``MDB_CLUSTER_1`` failure. To learn more about resource
   reconciliation, see :ref:`multi-cluster-diagram`.
