.. _golang-web-app:

============================================================
Tutorial: Build a Web Application with the {+driver-short+} and Gin
============================================================

.. facet::
   :name: genre
   :values: tutorial

.. meta::
   :description: Learn how to build a web application using the MongoDB Go Driver and the Gin web framework, including setting up routes and handling requests.
   :keywords: tutorial, restful api, web application, code example, web framework

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

Overview
--------

This tutorial shows you how to build a web application by using the {+driver-long+}
and the `Gin web framework <https://github.com/gin-gonic/gin>`__. 

Gin is a fast, lightweight web framework for Go. Its minimalist and modular
design makes it ideal for building web servers, APIs, and microservices.

In this tutorial, you can learn how to create a web application with the
following endpoints that connect to a MongoDB database:

- An endpoint to retrieve all movies from a collection
- An endpoint to retrieve a single movie by ID  
- An endpoint to run aggregation operations on the ``movies`` collection

Sample Data
~~~~~~~~~~~

The tutorial uses the ``movies`` collection in the ``sample_mflix``
database from the :atlas:`Atlas sample datasets </sample-data>`. To learn how to
create a free MongoDB Atlas cluster and load the sample datasets, see the
`Get Started with Atlas <https://www.mongodb.com/docs/get-started>`__ guide.

Prerequisites
~~~~~~~~~~~~~

Before you begin this tutorial, ensure that you have the following:

- `Go <https://go.dev/dl/>`__ installed on your development machine
- A MongoDB deployment. You can use a free MongoDB Atlas cluster for this
  tutorial. For more information, see the `Get Started with Atlas <https://www.mongodb.com/docs/get-started>`__ guide.
- A tool for testing your API, such as `curl <https://curl.se/>`__ or
  `Postman <https://www.postman.com/>`__.

Set Up Your Project
-------------------

.. procedure::
   :style: connected

   .. step:: Create and initialize your project

      Create a new directory for your project and navigate into it:

      .. code-block:: bash

        mkdir mflix
        cd mflix

      Initialize a new Go module to manage your project dependencies:

      .. code-block:: bash

        go mod init mflix

   .. step:: Add the Gin framework and the {+driver-long+} as dependencies

      Install the required dependencies for your project:

      .. code-block:: bash

        go get github.com/gin-gonic/gin
        go get go.mongodb.org/mongo-driver/v2/mongo

Create the Application Structure
--------------------------------

.. procedure::
   :style: connected

   .. step:: Create the main application file

      Create a ``main.go`` file in your project directory and add the following
      code to set up a basic Gin application:

      .. literalinclude:: /includes/web-application/web-app-starter.go
         :language: go
         :dedent:

   .. step:: Run the application

      Run the following code to test that your basic application is working:

      .. code-block:: bash

        go run main.go

      Navigate to ``http://localhost:8080`` in your web browser to see a JSON
      response with the message "Hello World".

Connect to MongoDB
------------------

Update your ``main.go`` file to connect to MongoDB. Replace the
existing code with the following code to connect to your MongoDB deployment:

.. literalinclude:: /includes/web-application/web-app-connect.go
   :language: go
   :dedent:

Replace the ``<connection-string>`` placeholder with your actual MongoDB connection
string. To learn more about how to obtain your connection string, see the
:atlas:`Connect to a Cluster </connect-to-database-deployment>` guide.

Implement the API Endpoints
---------------------------

Now, you can add three endpoints to interact with the movie data. Update your
``main.go`` file to include the necessary imports and endpoint implementations.

.. procedure::
   :style: connected

   .. step:: Update imports

      Add the required imports at the top of your file:

      .. literalinclude:: /includes/web-application/web-app-endpoints.go
         :language: go
         :dedent:
         :start-after: start-imports
         :end-before: end-imports

   .. step:: Add route handlers

      Add the following route handlers after your ``connectToMongoDB`` function:

      .. literalinclude:: /includes/web-application/web-app-endpoints.go
         :language: go
         :dedent:
         :start-after: start-endpoints
         :end-before: end-endpoints

   .. step:: Register routes

      Update your ``main`` function to register the new routes:

      .. literalinclude:: /includes/web-application/web-app-endpoints.go
         :language: go
         :dedent:
         :start-after: start-endpoints-main
         :end-before: end-endpoints-main

Test Your Application
---------------------

You can test the endpoints you created to ensure they work as expected.

Test Get All Movies
~~~~~~~~~~~~~~~~~~~

Restart your server and navigate to ``http://localhost:8080/movies`` in your
web browser. You should see a JSON response containing an array of movies
from the sample dataset.

Test Get Movie by ID
~~~~~~~~~~~~~~~~~~~~

To test the single movie endpoint, copy an ``_id`` value from the movies
response and navigate to ``http://localhost:8080/movies/{id}``. 

For example, if you navigate to
``http://localhost:8080/movies/573a1390f29313caabcd42e8``, the response in the
browser is similar to the following:

.. code-block:: json

   {
      "_id": "573a1390f29313caabcd42e8",
      "awards": {
         "wins": 1,
         "nominations": 0,
         "text": "1 win."
      },
      "cast": [
         "A.C. Abadie",
         "Gilbert M. 'Broncho Billy' Anderson",
         "George Barnes",
         "Justus D. Barnes"
      ],
      "countries": [
         "USA"
      ],
      "directors": [
         "Edwin S. Porter"
      ],
      "fullplot": "Among the earliest existing films in American cinema - notable as the first film that presented a narrative story to tell - it depicts a group of cowboy outlaws who hold up a train and rob the passengers. They are then pursued by a Sheriff's posse. Several scenes have color included - all hand tinted.",
      "genres": [
         "Short",
         "Western"
      ],"
      ....
   }

Test Aggregation Endpoint
~~~~~~~~~~~~~~~~~~~~~~~~~~

To test the aggregation endpoint, you need to make a POST request. You can
use a tool like curl or Postman to send a request with an aggregation pipeline
in the request body.

The following example aggregation counts comedy movies by year:

.. code-block:: json

   [
       {"$match": {"genres": "Comedy"}},
       {"$group": {
           "_id": "$year", 
           "count": {"$sum": 1}
       }},
       {"$sort": {"count": -1}}
   ]

Run the following code in your terminal to test this endpoint with curl:

.. io-code-block::
   :copyable: true

   .. input::
      :language: none

      curl -X POST http://localhost:8080/movies/aggregations \
           -H "Content-Type: application/json" \
           -d '[
               {"$match": {"genres": "Comedy"}},
               {"$group": {"_id": "$year", "count": {"$sum": 1}}},
               {"$sort": {"count": -1}}
           ]'
           
   .. output::
      :language: none
      :visible: false

       [
          {
              "_id": 2014,
              "count": 287
          },
          {
              "_id": 2013,
              "count": 286
          },
          {
              "_id": 2009,
              "count": 268
          },
          {
              "_id": 2011,
              "count": 263
          },
          {
              "_id": 2006,
              "count": 260
          },
          ...
        ]

.. warning::

   The aggregation endpoint in this tutorial allows users to run any
   aggregation pipeline. In a production environment, you should limit
   the types of operations and validate input to prevent potential security
   issues or performance problems.

Complete Code
-------------

The following file shows the complete code for your web application:

.. literalinclude:: /includes/web-application/web-app-complete.go
   :language: go
   :dedent:

Summary
-------

You now have a basic application that demonstrates the following:

- Sets up a Go project with the Gin web framework and the {+driver-short+}.
- Connects to a MongoDB database by using the {+driver-short+}.
- Implements REST API endpoints that perform MongoDB operations to find
  documents, find a single document, and run aggregation pipelines.
- Handles common scenarios such as converting string IDs to ObjectIDs.
- Implements proper error handling for database operations.

Next Steps
----------

To further develop your application, consider the following next steps:

- Add input validation and request limiting for the aggregation endpoint
- Implement :ref:`authentication <golang-enterprise-authentication-mechanisms>` and authorization
- Add :ref:`indexes <golang-indexes>` to improve query performance

Additional Resources
--------------------

To learn more about the concepts from this tutorial, see the following resources:

- :ref:`go-get-started`
- :ref:`golang-retrieve`
- :ref:`golang-aggregation`
- `Gin Web Framework <https://github.com/gin-gonic/gin>`__
